<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIRA 2.5 | Sistema Integral de Requerimientos de Artes</title>
<link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600;800&display=swap" rel="stylesheet">
<style>
:root {
--celeste: #8ecae6;
--turquesa: #219ebc; --azul-deep: #023047;
--amarillo: #ffb703; --naranja: #fb8500; --rojo: #e63946;
--verde: #2d6a4f; --gris: #edf2f4;
}
* { font-family: 'Georama', sans-serif;
box-sizing: border-box; font-weight: 500; }
body { background: #f4f7fa; margin: 0; padding-bottom: 50px; color: var(--azul-deep); }
header { background: var(--azul-deep);
padding: 8px 25px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; min-height: 60px;
flex-wrap: wrap;
gap: 10px;
}
.brand-container { display: flex; flex-direction: column; align-items: flex-start; flex: 1; min-width: 150px; }
.header-title { margin: 0; font-size: 1.3rem; font-weight: 800; color: white;
line-height: 1; }
.acronimo { font-size: 0.55rem; font-weight: 400; letter-spacing: 0.5px; margin-top: 2px; opacity: 0.9; text-transform: uppercase; color: white; max-width: 250px;
}
.nav-tabs { display: flex; justify-content: center; gap: 10px; flex: 1; min-width: 200px; flex-wrap: wrap; justify-content: flex-start; }
.tab-btn { padding: 6px 16px; border-radius: 20px; border: none;
cursor: pointer; font-weight: 800; text-transform: uppercase; font-size: 0.75rem; background: rgba(255,255,255,0.1); color: white; transition: 0.3s; display: flex; align-items: center; gap: 6px;
}
.tab-btn.active { background: var(--amarillo); color: var(--azul-deep); }
.admin-access { flex: 1; display: flex; justify-content: flex-end; gap: 10px; min-width: 200px; flex-wrap: wrap; justify-content: center; }
.btn-login { background: var(--amarillo);
border: none; padding: 6px 14px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.75rem; box-shadow: 0 3px 0 #c79100; transition: 0.2s;
}
.btn-login:active { transform: translateY(2px); box-shadow: 0 1px 0 #c79100; }
.btn-logout { background: var(--rojo); color: white; border: none; padding: 6px 14px;
border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.75rem; }
.row-new { background-color: #e3f2fd !important; border-left: 5px solid var(--turquesa) !important;
}
.row-obituario { background-color: #ffebee !important; border-left: 5px solid var(--rojo) !important; }
.badge-new { background: var(--turquesa); color: white; padding: 2px 8px;
border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; animation: blink 2s infinite; }
.badge-prioridad { background: white; color: var(--rojo);
padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; border: 1px solid var(--rojo);
}
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1;
} }
.stats-grid { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.stat-card { flex: 1; min-width: 100px;
padding: 8px; border-radius: 12px; text-align: center; color: white; font-weight: 800; }
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep);
}
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }

/* ‚úÖ ESTILOS PARA CONTADORES DE DISE√ëADORES */
.stat-bermina { background: var(--naranja); color: white; }
.stat-jorsy { background: var(--azul-deep); color: white; }
.stat-maria { background: var(--verde); color: white; }
.stat-xamir { background: var(--amarillo); color: var(--azul-deep); }

.stat-label { font-size: 0.6rem; text-transform: uppercase; display: block; opacity: 0.8;
}
.stat-val { font-size: 1.1rem; }
.container { max-width: 1200px; margin: 15px auto; padding: 25px; background: white; border-radius: 25px;
box-shadow: 0 15px 40px rgba(0,0,0,0.06); }
.aviso-48h { background: #fff3e0; border: 2.5px solid var(--naranja); color: var(--naranja); padding: 15px; border-radius: 15px;
text-align: center; font-weight: 800; margin-bottom: 25px; font-size: 1.1rem; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1;
} 50% { opacity: 0.7; } 100% { opacity: 1; } }
.section-title { display: block; font-weight: 800; font-size: 0.85rem;
color: var(--turquesa); margin: 20px 0 12px; border-left: 4px solid var(--turquesa); padding-left: 10px; text-transform: uppercase; }
.category-row { display: grid;
grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }
.card-btn { background: #fff; border: 2px solid var(--gris); border-radius: 12px; padding: 6px 4px;
cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 800; font-size: 0.75rem; min-height: 45px; line-height: 1.1;
color: var(--azul-deep); }
.card-btn.selected { background: var(--amarillo); border-color: var(--naranja); transform: scale(0.98); }
.field-error { border: 2px solid var(--rojo) !important;
animation: border-blink 0.8s infinite alternate !important; background: #fff5f5 !important; }
@keyframes border-blink { from { border-color: var(--rojo);
box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); } to { border-color: transparent; box-shadow: none; } }
.btn-time { padding: 8px;
border-radius: 12px; border: 2px solid var(--gris); cursor: pointer; font-weight: 800; font-size: 0.85rem; background: #f8f9fa; color: var(--azul-deep); flex: 1; transition: 0.3s;
}
.btn-time.active { background: var(--azul-deep); color: white; border-color: var(--azul-deep); }
/* ‚úÖ Estilo mejorado para bot√≥n Obituario */
#btn-obituario {
padding: 6px 12px !important;
font-size: 0.75rem !important;
min-width: auto !important;
width: auto !important;
height: auto !important;
border-radius: 8px !important;
}
#btn-obituario.obit-active {
background: var(--azul-deep) !important;
color: white !important;
border-color: var(--azul-deep) !important;
}
.modern-input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--gris); font-size: 0.95rem;
outline: none; transition: 0.3s; background: #fdfdfd; font-weight: 500; }
.modern-input:focus { border-color: var(--turquesa); background: white; }
.pass-container { position: relative; width: 100%;
}
.eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem; opacity: 0.6; z-index: 10;
}
.photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
.upload-box { height: 90px; border: 2.5px dashed var(--celeste);
border-radius: 15px; position: relative; overflow: hidden; background: #f0f9ff; }
.upload-label { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;
cursor: pointer; font-size: 0.7rem; font-weight: 800; color: var(--turquesa); text-align: center; }
.preview { position: absolute; top: 0; left: 0; width: 100%;
height: 100%; object-fit: cover; display: none; }
.remove-btn { position: absolute; top: 5px; right: 5px; background: var(--rojo); color: white; border: none;
border-radius: 50%; width: 25px; height: 25px; font-weight: 800; cursor: pointer; display: none; z-index: 10; }
.btn-send { background: var(--azul-deep); color: white;
width: 100%; padding: 14px; border-radius: 18px; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 30px;
box-shadow: 0 6px 15px rgba(2, 48, 71, 0.3); transition: 0.3s; }
.btn-send:hover { transform: translateY(-2px); background: #054a6d; }
.modal-overlay { position: fixed;
top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.85); backdrop-filter: blur(8px); display: none; align-items: center;
justify-content: center; z-index: 20000; padding: 20px; }
.modal-content { background: white; padding: 40px 30px; border-radius: 30px; max-width: 450px; width: 100%;
text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative; }
/* MODAL CONFIRMACI√ìN */
#confirmModal .modal-content { max-width: 600px; padding: 30px;
}
#previewContent { text-align: left; max-height: 400px; overflow-y: auto; margin-bottom: 20px; }
#previewContent p { margin: 8px 0; line-height: 1.4;
}
/* MODAL MANTENIMIENTO */
#maintOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--azul-deep); z-index: 10000;
display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
.modal-btn { background: var(--turquesa); color: white; border: none;
padding: 12px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 25px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
.modal-btn:hover { background: var(--azul-deep);
}
.modal-btn-alt { background: var(--gris); color: var(--azul-deep); margin-top: 10px; }
/* ‚úÖ NUEVA CLASE PARA BOTONES IGUALES EN MODAL DE CONFIRMACI√ìN */
.modal-btn-confirm {
flex: 1;
min-width: 140px;
padding: 12px;
font-size: 1rem;
font-weight: 800;
border-radius: 12px;
border: none;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
text-align: center;
}
.modal-btn-confirm.corregir {
background: var(--gris);
color: var(--azul-deep);
}
.modal-btn-confirm.enviar {
background: var(--turquesa);
color: white;
}
.modal-btn-confirm:disabled {
background: #e9ecef;
color: #495057;
cursor: not-allowed;
}
.table-container { width: 100%; overflow-x: auto; margin-top: 5px; }
table { width: 100%; border-collapse: collapse; min-width: 900px;
}
th { background: #f8f9fa; padding: 8px 10px; text-align: left; font-size: 0.65rem; text-transform: uppercase; font-weight: 800; color: var(--turquesa);
border-bottom: 2px solid var(--gris); }
td { padding: 6px 10px; border-bottom: 1px solid var(--gris); font-size: 0.82rem; line-height: 1.2; color: #1a1a1a;
font-weight: 500; }
.status-pill { padding: 3px 10px; border-radius: 15px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; transition: 0.3s;
}
.txt-bold { font-weight: 800; color: var(--azul-deep); }
.txt-small { font-size: 0.72rem; color: #4b4b4b; display: block; margin-bottom: 1px; font-weight: 500;
}
.status-pendiente { background: var(--celeste); color: var(--azul-deep); }
.status-procesando { background: var(--amarillo); color: var(--azul-deep); }
.status-finalizada { background: var(--verde); color: white;
}

/* ‚úÖ C√çRCULO DE DISE√ëADOR EN TABLA */
.designer-circle {
display: inline-block;
width: 10px;
height: 10px;
border-radius: 50%;
margin-right: 5px;
vertical-align: middle;
}

.admin-actions { display: flex; gap: 4px; justify-content: flex-end; flex-wrap: wrap; }
.btn-act { border: none; border-radius: 5px; padding: 4px 6px;
cursor: pointer; font-size: 9px; color: white; font-weight: 800; transition: 0.2s; }
.btn-act:hover { transform: scale(1.1); }
.bg-pend { background: var(--celeste); color: var(--azul-deep);
}
.bg-proc { background: var(--amarillo); color: var(--azul-deep); }
.bg-fin { background: var(--verde); }
.btn-trash { background: none; border: none; cursor: pointer; font-size: 1.1rem;
margin-left: 8px; filter: grayscale(1); transition: 0.3s; }
.btn-trash:hover { filter: grayscale(0); transform: rotate(10deg);
}
/* Nuevos Estilos Botones Admin */

/* ‚úÖ BOT√ìN ADJUNTAR CORREGIDO: Icono + texto compacto */
.btn-arte { 
background: #4a90e2; 
color: white; 
border: none; 
border-radius: 5px; 
padding: 3px 6px; 
font-size: 9px;
font-weight: 800; 
cursor: pointer; 
white-space: nowrap;
min-width: auto;
width: auto;
}

.btn-ver { background: #f39c12; color: white; border: none; border-radius: 5px; padding: 4px 6px; font-size: 9px;
font-weight: 800; cursor: pointer; text-decoration: none; }
.btn-tg { background: #0088cc; color: white; border: none; border-radius: 5px; padding: 4px 6px;
font-size: 9px; font-weight: 800; cursor: pointer; }
.hidden { display: none !important; }
.page { display: none; }
.page.active { display: block;
}
#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.95); display: none;
flex-direction: column; align-items: center; justify-content: center; z-index: 30000; color: white; text-align: center; padding: 20px; }
.spinner { width: 60px; height: 60px;
border: 6px solid rgba(255,255,255,0.1); border-top: 6px solid var(--amarillo); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 25px;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
/* ‚úÖ Estilo para campos deshabilitados en modo obituario */
.obit-disabled {
background-color: #e9ecef !important;
color: #6c757d !important;
cursor: not-allowed !important;
}
.obit-upload-box {
background: #e9ecef !important;
border-color: #ced4da !important;
cursor: not-allowed !important;
}
.obit-upload-label {
color: #6c757d !important;
cursor: not-allowed !important;
}
/* ‚úÖ ESTILOS PARA BOT√ìN DE REPORTE MENSUAL - SOLO HABILITADO 1¬∞ DE MES */
#reportBtn {
position: relative;
overflow: hidden;
}
#reportBtn:disabled {
opacity: 0.65;
cursor: not-allowed !important;
transform: none !important;
box-shadow: 0 3px 0 #1a3d2d !important;
}
#reportBtn:not(:disabled):hover {
transform: translateY(-2px);
box-shadow: 0 5px 0 #1a3d2d;
}
#reportBtn:not(:disabled):active {
transform: translateY(1px);
box-shadow: 0 2px 0 #1a3d2d;
}
#reportBtnText {
display: block;
transition: opacity 0.3s;
}
#reportBtnDays {
font-size: 0.65rem;
display: block;
opacity: 0.9;
margin-top: 2px;
font-weight: 600;
transition: opacity 0.3s;
}
.report-info-banner {
background: linear-gradient(135deg, #2d6a4f 0%, #1e4a35 100%);
color: white;
padding: 12px;
border-radius: 8px;
margin-top: 10px;
font-size: 0.85rem;
text-align: center;
font-weight: 600;
box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}
.report-info-banner span {
display: block;
font-size: 1.1rem;
font-weight: 800;
margin-top: 3px;
}

/* ‚úÖ MEJORAS RESPONSIVE PARA M√ìVIL */
@media (max-width: 768px) {
  /* Header reorganizado para m√≥vil */
  header {
    flex-direction: column;
    align-items: center;
    padding: 12px 15px;
    min-height: auto;
    gap: 8px;
  }
  
  .brand-container {
    width: 100%;
    align-items: center;
    margin-bottom: 0;
  }
  
  .header-title {
    font-size: 1.6rem;
    text-align: center;
  }
  
  .acronimo {
    font-size: 0.65rem;
    text-align: center;
    max-width: 100%;
  }
  
  .nav-tabs {
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
    margin: 8px 0 0 0;
  }
  
  .tab-btn {
    padding: 5px 12px;
    font-size: 0.7rem;
    min-width: 100px;
  }
  
  .admin-access {
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 5px;
  }
  
  .btn-login, .btn-logout {
    padding: 5px 12px;
    font-size: 0.7rem;
    min-width: 100px;
  }
  
  /* Contenedores de stats en columnas */
  .stats-grid {
    flex-direction: column;
    gap: 8px;
  }
  
  .stat-card {
    min-width: 100%;
    padding: 10px;
  }
  
  /* Tabla m√°s compacta */
  th, td {
    padding: 4px 6px;
    font-size: 0.75rem;
  }
  
  .status-pill {
    padding: 2px 8px;
    font-size: 0.55rem;
  }
  
  .txt-small {
    font-size: 0.65rem;
  }
  
  .admin-actions {
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }
  
  .btn-act, .btn-arte, .btn-ver, .btn-tg, .btn-trash {
    width: 100%;
    justify-content: center;
    font-size: 0.75rem;
    padding: 3px;
  }
  
  /* Formulario m√°s compacto */
  .section-title {
    font-size: 0.8rem;
    margin: 15px 0 10px;
  }
  
  .modern-input {
    padding: 10px;
    font-size: 0.85rem;
  }
  
  .card-btn {
    min-height: 40px;
    font-size: 0.7rem;
    padding: 4px 2px;
  }
  
  .btn-send {
    padding: 12px;
    font-size: 1rem;
  }
  
  /* Modales m√°s compactos */
  .modal-content {
    padding: 25px 20px;
    margin: 10px;
  }
  
  .modal-btn {
    padding: 10px;
    font-size: 0.95rem;
  }
}
</style>
</head>
<body>
<div id="maintOverlay">
<span style="font-size: 80px;">üõ†Ô∏è</span>
<h1 style="font-weight: 800; font-size: 2.5rem; margin: 20px 0;">SISTEMA EN MANTENIMIENTO</h1>
<p style="font-size: 1.2rem; max-width: 500px; opacity: 0.9;">Estamos trabajando para mejorar tu experiencia.
Disculpen las molestias ocasionadas.</p>
<button class="btn-login" style="margin-top: 30px; padding: 12px 25px; font-size: 1rem;"
onclick="showLogin()">üîì ACCESO ADMINISTRADOR</button>
</div>
<div id="loadingOverlay">
<div class="spinner"></div>
<div class="loading-text" id="loadMainTxt">Procesando...</div>
<div class="loading-subtext" id="loadSubTxt"></div>
</div>
<div class="modal-overlay" id="modalAlert">
<div class="modal-content">
<span id="modalIcon" style="font-size: 60px; display: block; margin-bottom: 10px;">‚ö†Ô∏è</span>
<div id="modalTitle" style="font-weight: 800; font-size: 1.4rem; color: var(--azul-deep);">Atenci√≥n</div>
<div id="modalMsg" style="margin-top: 15px; color: #555; font-size: 1rem; line-height: 1.4; font-weight: 500;"></div>
<div id="loginArea" class="hidden" style="margin-top:20px; text-align: left;">
<label class="txt-small">Usuario del Sistema:</label>
<input type="text" id="adminUser" class="modern-input" style="margin-bottom:15px;"
placeholder="Ingrese usuario">
<label class="txt-small">Clave de Seguridad:</label>
<div class="pass-container">
<input type="password" id="adminPass" class="modern-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
<span class="eye-icon" onclick="togglePass()">üëÅÔ∏è</span>
</div>
</div>
<div id="uploadArea" class="hidden" style="margin-top:20px;">
<input type="file" id="arteFile" class="modern-input" accept=".jpg,.jpeg,.png,.pdf,.zip" style="font-size: 0.8rem;">
<p style="font-size: 0.7rem; color: #666; margin-top: 5px;">M√°ximo 5MB (Formatos: JPG, PNG, PDF, ZIP)</p>
<input type="hidden" id="currentReqId">
</div>
<button id="mainModalBtn" class="modal-btn">ENTENDIDO</button>
<button id="closeModalBtn" class="modal-btn modal-btn-alt hidden" onclick="closeModal()">CERRAR</button>
</div>
</div>
<div class="modal-overlay" id="confirmModal">
<div class="modal-content">
<h2 style="font-weight: 800; color: var(--azul-deep); margin-top: 0;">üîç Revisa tu Solicitud</h2>
<div id="previewContent"></div>
<div style="display: flex;
gap: 12px; justify-content: center; width: 100%; max-width: 500px; margin: 0 auto;
margin-top: 20px;">
<button id="btnCorregir" class="modal-btn-confirm corregir">‚úèÔ∏è Corregir</button>
<button id="btnEnviarConfirmado" class="modal-btn-confirm enviar" disabled>üöÄ Enviar Solicitud (<span id="countdown">10</span>)</button>
</div>
</div>
</div>

<!-- ‚úÖ MODAL PARA SELECCIONAR DISE√ëADOR -->
<div class="modal-overlay" id="designerModal" style="display:none;">
<div class="modal-content" style="max-width: 420px; padding: 30px;">
<span style="font-size: 48px; display: block; margin-bottom: 15px;">üé®</span>
<div style="font-weight: 800; font-size: 1.5rem; color: var(--azul-deep); margin-bottom: 15px; text-align: center;">
Seleccionar Dise√±ador
</div>
<p style="margin: 15px 0; color: #555; font-size: 0.95rem; text-align: center;">
¬øQui√©n realiz√≥ el arte final para esta solicitud?
</p>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0;">
<button class="modal-btn" style="background: var(--naranja); color: white; padding: 14px; font-weight: 800;" 
onclick="selectDesigner('Bermina')">üë©‚Äçüé® Bermina</button>
<button class="modal-btn" style="background: var(--azul-deep); color: white; padding: 14px; font-weight: 800;" 
onclick="selectDesigner('Jorsy')">üë®‚Äçüé® Jorsy</button>
<button class="modal-btn" style="background: var(--verde); color: white; padding: 14px; font-weight: 800;" 
onclick="selectDesigner('Mar√≠a F.')">üë©‚Äçüé® Mar√≠a F.</button>
<button class="modal-btn" style="background: var(--amarillo); color: var(--azul-deep); padding: 14px; font-weight: 800;" 
onclick="selectDesigner('Xamir')">üë®‚Äçüé® Xamir</button>
</div>
</div>
</div>

<header>
<div class="brand-container">
<h1 class="header-title">SIRA 2.5</h1>
<span class="acronimo">Sistema Integral de Requerimientos de Artes</span>
</div>
<div class="nav-tabs">
<button id="tab-form" class="tab-btn active" onclick="showPage('form-page', this)">üìù FORMULARIO</button>
<button id="tab-list" class="tab-btn" onclick="showPage('list-page', this)">üìã SOLICITUDES</button>
</div>
<div class="admin-access">
<button id="maintBtn" class="btn-login hidden" style="background: var(--rojo);
box-shadow: 0 3px 0 #9b1c24; color: white;" onclick="toggleMaintMode()">‚öôÔ∏è Mantenimiento</button>
<!-- ‚úÖ BOT√ìN DE REPORTE MENSUAL - SOLO HABILITADO 1¬∞ DE MES -->
<button id="reportBtn" class="btn-login hidden" style="background: linear-gradient(to right, #2d6a4f 0%, #1e4a35 0%); box-shadow: 0 3px 0 #1e4a35; color: white;" onclick="generateMonthlyReport()">
<span id="reportBtnText">üìä Generar Reporte Mensual</span>
<span id="reportBtnDays"></span>
</button>
<button id="authBtn" class="btn-login" onclick="showLogin()">üîê Administrador</button>
</div>
</header>
<div class="container page active" id="form-page">
<div class="aviso-48h">‚ö†Ô∏è IMPORTANTE: LAS SOLICITUDES DEBEN REALIZARSE CON 48 HORAS DE ANTICIPACI√ìN</div>
<form id="sigrafForm" novalidate>
<label class="section-title">üè• 1. REGI√ìN *</label>
<div class="category-row" id="region-grid"></div>
<div id="unidad-section" class="hidden">
<label class="section-title">üè• 1.5. UNIDAD M√âDICA *</label>
<div class="category-row" id="unidad-grid"></div>
</div>
<label class="section-title">üìÇ 2. TIPO DE JORNADA *</label>
<div class="category-row" id="cat-grid">
<div class="card-btn" onclick="selectCat(this, 'escuela')">Ipasme va a la Escuela</div>
<div class="card-btn" onclick="selectCat(this, 'integral')">Jornada de Atenci√≥n M√©dica Integral</div>
<div class="card-btn" onclick="selectCat(this, 'conjunta')">Jornada Conjunta</div>
<div class="card-btn" onclick="selectCat(this, 'vacuna')">Plan Masivo de Vacunaci√≥n</div>
<div class="card-btn" onclick="selectCat(this, 'quirurgica')">Captaci√≥n Quir√∫rgica</div>
<div class="card-btn" onclick="selectCat(this, 'pediatrica')">Captaci√≥n Quir√∫rgica Pedi√°trica</div>
<div class="card-btn" onclick="selectCat(this, 'oftalmo')">Captaci√≥n Quir√∫rgica Oftalmol√≥gica</div>
<div class="card-btn" onclick="selectCat(this, 'otros')">Otros</div>
</div>
<div id="sec-3" class="hidden">
<label class="section-title" id="label-3">ü©∫ 3. DETALLE *</label>
<div id="cont-3" style="display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;"></div>
</div>
<div id="sec-4" class="hidden">
<label class="section-title">‚ú® 4. SERVICIOS ADICIONALES (OPCIONAL)</label>
<div id="cont-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 6px;"></div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="section-title">üìÖ 5. FECHA DE ACTIVIDAD *</label><input type="date" id="fecha" class="modern-input"></div>
<div><label class="section-title">‚è∞ 6. HORA DE INICIO *</label><div class="hora-container" id="hora-box" style="display: flex;
gap: 10px; align-items: center;"><input type="text" id="hora" class="modern-input" style="width:100px; text-align:center" placeholder="08:00"><button type="button" class="btn-time" id="btn-am" onclick="setAMPM('a. m.')">a. m.</button><button type="button" class="btn-time" id="btn-pm" onclick="setAMPM('p. m.')">p. m.</button></div></div>
</div>
<label class="section-title">üìç 7. UBICACI√ìN *</label>
<div style="background: #fff8e1;
border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600;
line-height: 1.4;">
‚ö†Ô∏è Complete al menos el nombre de la instituci√≥n. La direcci√≥n exacta es opcional pero recomendada.
</div>
<div style="display: grid;
grid-template-columns: 1fr 1fr; gap: 20px;">
<div>
<label class="txt-small">üè´ Instituci√≥n *</label>
<input type="text" id="institucion" class="modern-input" placeholder="Escuela, Liceo, Jard√≠n de ni√±os, etc.">
</div>
<div>
<label class="txt-small">üß≠ Direcci√≥n exacta</label>
<input type="text" id="direccion-exacta" class="modern-input" placeholder="Municipio, Parroquia, Ciudad, etc.">
</div>
</div>
<label class="section-title">üì±‚úâÔ∏è 8. DATOS DE CONTACTO</label>
<div style="display: grid;
grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="txt-small">N√∫mero de Tel√©fono</label><input type="tel" id="tlf" class="modern-input" placeholder="04xx 1234567"></div>
<div><label class="txt-small">Correo Electr√≥nico *</label><input type="email" id="mail" class="modern-input" placeholder="Para env√≠o de arte final"></div>
</div>
<label class="section-title">‚úèÔ∏è 9. OBSERVACIONES / DETALLES DE DISE√ëO</label><textarea id="observaciones" class="modern-input" rows="3" placeholder="Indique medidas, colores institucionales o entes participantes adicionales..."></textarea>
<label class="section-title">üì∏ 10. SOPORTES FOTOGR√ÅFICOS (M√ÅX 3)</label>
<div style="background: #fff8e1;
border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600;
line-height: 1.4;">
‚ö†Ô∏è Si el registro fotogr√°fico enviado no cumple con las condiciones de calidad para la solicitud, ser√° sustituido por material de archivo.
</div>
<div class="photo-grid">
<div class="upload-box"><label for="f1" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f1" class="hidden" accept="image/*" onchange="handleFile(this, 'p1', 'b1')"><img id="p1" class="preview"><button type="button" id="b1" class="remove-btn" onclick="clearFile('f1', 'p1', 'b1')">√ó</button></div>
<div class="upload-box"><label for="f2" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f2" class="hidden" accept="image/*" onchange="handleFile(this, 'p2', 'b2')"><img id="p2" class="preview"><button type="button" id="b2" class="remove-btn" onclick="clearFile('f2', 'p2', 'b2')">√ó</button></div>
<div class="upload-box"><label for="f3" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f3" class="hidden" accept="image/*" onchange="handleFile(this, 'p3', 'b3')"><img id="p3" class="preview"><button type="button" id="b3" class="remove-btn" onclick="clearFile('f3', 'p3', 'b3')">√ó</button></div>
</div>
<button type="submit" id="submitBtn" class="btn-send">üöÄ ENVIAR SOLICITUD A COMUNICACIONES</button>
</form>
</div>
<div class="container page" id="list-page">
<!-- ‚úÖ DOS FILAS DE CONTADORES -->
<div class="stats-grid" id="stats-panel">
<div class="stat-card st-total"><span class="stat-label">Total</span><span id="count-total" class="stat-val">0</span></div>
<div class="stat-card st-pend"><span class="stat-label">Pendiente</span><span id="count-pend" class="stat-val">0</span></div>
<div class="stat-card st-proc"><span class="stat-label">En Proceso</span><span id="count-proc" class="stat-val">0</span></div>
<div class="stat-card st-fin"><span class="stat-label">Finalizada</span><span id="count-fin" class="stat-val">0</span></div>
</div>
<div class="stats-grid" id="designers-stats" style="display:none; margin-top:8px;">
<div class="stat-card stat-bermina" id="stat-bermina"><span class="stat-label">Bermina</span><span id="count-bermina" class="stat-val">0</span></div>
<div class="stat-card stat-jorsy" id="stat-jorsy"><span class="stat-label">Jorsy</span><span id="count-jorsy" class="stat-val">0</span></div>
<div class="stat-card stat-maria" id="stat-maria"><span class="stat-label">Mar√≠a F.</span><span id="count-maria" class="stat-val">0</span></div>
<div class="stat-card stat-xamir" id="stat-xamir"><span class="stat-label">Xamir</span><span id="count-xamir" class="stat-val">0</span></div>
</div>

<div class="table-container">
<table>
<thead>
<tr>
<th id="col-fecha-registro">FECHA REGISTRO</th>
<th id="col-fecha-actividad">FECHA ACTIVIDAD</th>
<th id="col-id-solicitud" class="hidden">ID SOLICITUD</th>
<th>UNIDAD SOLICITANTE</th>
<th>TIPO DE JORNADA</th>
<th style="text-align:center">SOPORTES</th>
<th>ESTATUS</th>
<th id="th-admin" class="hidden" style="text-align:right">ACCIONES ADMIN</th>
</tr>
</thead>
<tbody id="solicitudes-body"></tbody>
</table>
</div>
</div>
<script>
// === LISTADO DE UNIDADES IPASME POR REGI√ìN (CORREGIDO Y ORDENADO) ===
const UNIDADES_IPASME_RAW = {
"Capital": [
"Don Sim√≥n Rodr√≠guez",
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende"
],
"Regi√≥n Central": [
"Maracay", "La Victoria", "Valencia", "Puerto Cabello",
"Club Villas Ipasmar", "Guatire", "Ocumare del Tuy", "Caucagua",
"Carrizal", "La Guaira"
],
"Regi√≥n Occidental": [
"Cabimas", "Maracaibo", "Machiques", "San Carlos del Zulia",
"El Moj√°n", "Barquisimeto", "El Tocuyo", "Carora",
"San Felipe", "Nirgua", "Punto Fijo", "Coro",
"Buchivacoa", "Puerto Cumarebo"
],
"Regi√≥n Los Andes": [
"El Vig√≠a", "M√©rida", "Tovar",
"Hotel Valle Grande", "La Grita", "Rubio",
"San Crist√≥bal", "San Juan de Col√≥n", "Ure√±a",
"Bocon√≥", "Trujillo", "Valera"
],
"Regi√≥n Oriental": [
"Anaco", "Barcelona", "Cantaura", "El Tigre",
"Isidora Agnes, Ciudad Bol√≠var", "Guasipati",
"Profa. Mirelva Mart√≠nez, San F√©lix", "Upata", "Matur√≠n",
"Punta de Mata", "Cuman√°", "Cumanacoa", "Car√∫pano",
"G√ºiria", "Tucupita", "Casacoima", "La Asunci√≥n",
"Puerto Ayacucho"
],
"Regi√≥n Los Llanos": [
"Altagracia de Orituco", "Calabozo", "San Juan de los Morros",
"Valle de la Pascua", "Zaraza", "San Carlos de Cojedes",
"Tinaquillo", "San Fernando de Apure", "Guasdualito",
"Barinas", "Santa B√°rbara de Barinas", "Acarigua", "Guanare"
]
};
const ORDEN_REGIONES = [
"Capital",
"Regi√≥n Central",
"Regi√≥n Occidental",
"Regi√≥n Los Andes",
"Regi√≥n Oriental",
"Regi√≥n Los Llanos"
];
function getNombreRegionLimpio(regionKey) {
if (regionKey === "Capital") return "Capital";
return regionKey.replace("Regi√≥n ", "");
}
const UNIDADES_IPASME = {};
ORDEN_REGIONES.forEach(region => {
const unidadesOriginales = UNIDADES_IPASME_RAW[region] || [];
UNIDADES_IPASME[region] = [...unidadesOriginales].sort((a, b) =>
a.trim().localeCompare(b.trim(), 'es', { sensitivity: 'base' })
);
});
let isAdmin = false;
let selectedAMPM = "";
let catType = "";
let catName = "";
let localData = [];
let isMaintActive = false;
let selectedRegionKey = "";
let selectedUnidad = "";
let modoObituario = false;

// ‚úÖ NUEVA VARIABLE GLOBAL CON COLORES DE DISE√ëADORES
const designerColors = {
"Bermina": "#fb8500",
"Jorsy": "#023047",
"Mar√≠a F.": "#2d6a4f",
"Xamir": "#ffb703"
};

// ‚úÖ NUEVA VARIABLE GLOBAL PARA ID DE SOLICITUD EN MODAL DE DISE√ëADOR
let requestIdForDesigner = null;

// ‚úÖ NUEVA FUNCI√ìN: SELECCIONAR DISE√ëADOR Y GUARDAR
async function selectDesigner(designer) {
if (!requestIdForDesigner) return;

document.getElementById('loadMainTxt').innerText = "Guardando dise√±ador...";
document.getElementById('loadingOverlay').style.display = 'flex';

try {
const params = new URLSearchParams();
params.append("action", "updateStatus");
params.append("id", requestIdForDesigner);
params.append("status", "FINALIZADA");
params.append("disenador", designer);

const response = await fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: params.toString()
});

const data = await response.json();

if (data.success) {
const item = localData.find(x => x.id == requestIdForDesigner);
if (item) {
item.Estatus = "FINALIZADA";
item.Disenador = designer;
}

document.getElementById('designerModal').style.display = 'none';
requestIdForDesigner = null;
renderLocalTable();
openModal("‚úÖ √âxito", `Solicitud asignada a ${designer}`, "üé®");
} else {
throw new Error(data.error);
}
} catch (e) {
openModal("‚ùå Error", "Error al guardar: " + e.message, "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}

// ‚úÖ MODIFICAR FUNCI√ìN modStatus PARA DETECTAR FINALIZADA
async function modStatus(id, st) {
const pill = document.getElementById('pill-' + id);
const oldClass = pill.className;
const oldText = pill.innerText;
const newStatusClass = st.toLowerCase().replace(/\s+/g, '');

pill.className = `status-pill status-${newStatusClass}`; 
pill.innerText = st;

try {
// ‚úÖ SI ES FINALIZADA, MOSTRAR MODAL DE DISE√ëADOR
if (st === "FINALIZADA") {
requestIdForDesigner = id;
document.getElementById('designerModal').style.display = 'flex';
return;
}

await fetch(SCRIPT_URL, { 
method: 'POST', 
mode: 'no-cors', 
headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
body: `action=updateStatus&id=${id}&status=${encodeURIComponent(st)}`
});

const item = localData.find(x => x.id == id); 
if(item) item.Estatus = st; 
renderLocalTable();
} catch (e) { 
pill.className = oldClass;
pill.innerText = oldText; 
openModal("‚ùå Error", "Error de conexi√≥n.", "üí•"); 
}
}

// ‚úÖ MODIFICAR FUNCI√ìN renderLocalTable PARA MOSTRAR C√çRCULOS Y CONTADORES
function renderLocalTable() {
const body = document.getElementById('solicitudes-body');
body.innerHTML = "";

let counts = { 
total: 0, 
pend: 0, 
proc: 0, 
fin: 0,
bermina: 0,
jorsy: 0,
maria: 0,
xamir: 0
};

// ‚úÖ CORREGIDO: Eliminar l√≠mite de 50 solicitudes - mostrar TODAS
const sortedData = [...localData].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));

sortedData.forEach((s, idx) => {
counts.total++;
const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');

if(statusLimpio === 'pendiente') counts.pend++;
if(statusLimpio === 'procesando') counts.proc++;
if(statusLimpio === 'finalizada') {
counts.fin++;

// ‚úÖ CONTAR POR DISE√ëADOR
if (s.Disenador) {
if (s.Disenador === "Bermina") counts.bermina++;
else if (s.Disenador === "Jorsy") counts.jorsy++;
else if (s.Disenador === "Mar√≠a F.") counts.maria++;
else if (s.Disenador === "Xamir") counts.xamir++;
}
}

// ‚úÖ CAMBIO: TODAS las pendientes son NEW (sin l√≠mite de 5)
const esNueva = (statusReal === "PENDIENTE");
const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";

let badge = '';
let rowClass = '';
if (esNueva) {
if (jornadaLimpia === "Obituario") {
badge = '<span class="badge-prioridad">PRIORIZAR</span>';
rowClass = "row-obituario";
} else {
badge = '<span class="badge-new">NEW</span>'; // ‚úÖ Texto cambiado a "NEW"
rowClass = "row-new";
}
}

// ‚úÖ C√çRCULO DE DISE√ëADOR
let designerCircle = '';
if (s.Disenador && statusLimpio === 'finalizada') {
const color = designerColors[s.Disenador] || '#6c757d';
designerCircle = `<span class="designer-circle" style="background-color: ${color};" title="${s.Disenador}"></span>`;
}

let icon = (s.Soportes && s.Soportes.includes("S√ç")) ? `üì∑ (${s.Soportes.match(/\d+/) || 1})` : "üôà";
const tr = document.createElement('tr');
if(rowClass) tr.className = rowClass;

tr.innerHTML = `
${isAdmin ? '' : `<td><span class="txt-small">${s.Timestamp}</span></td>`}
${isAdmin ? '' : `<td><span class="txt-bold">${s.Fecha}</span><br><span class="txt-small">${s.Hora || ''}</span></td>`}
${isAdmin ?
`<td><span class="txt-bold">${s.id}</span></td>` : ''}
<td class="txt-bold">${unidadLimpia} ${badge}</td>
<td>${jornadaLimpia}</td>
<td align="center">${icon}</td>
<td>
${designerCircle}
<span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
</td>
${isAdmin ?
`<td align="right">
<div class="admin-actions">
<button class="btn-act bg-pend" onclick="modStatus('${s.id}','PENDIENTE')">P</button>
<button class="btn-act bg-proc" onclick="modStatus('${s.id}','PROCESANDO')">PR</button>
<button class="btn-act bg-fin" onclick="modStatus('${s.id}','FINALIZADA')">F</button>
<!-- ‚úÖ BOT√ìN CORREGIDO: Icono + texto compacto -->
<button class="btn-arte" onclick="openArteModal('${s.id}')">üé® Adj</button>
${s.ArteFinal ?
`<a href="${s.ArteFinal}" target="_blank" class="btn-ver">üëÅÔ∏è VER</a>` : ''}
${s.ArteFinal ? `<button class="btn-tg" onclick="sendTelegramArte('${s.id}')">‚úàÔ∏è TG</button>` : ''}
<button class="btn-trash" onclick="deleteReq('${s.id}')">üóëÔ∏è</button>
</div>
</td>` : ''}`;
body.appendChild(tr);
});

document.getElementById('count-total').innerText = counts.total;
document.getElementById('count-pend').innerText = counts.pend;
document.getElementById('count-proc').innerText = counts.proc;
document.getElementById('count-fin').innerText = counts.fin;

// ‚úÖ ACTUALIZAR CONTADORES DE DISE√ëADORES (SOLO ADMIN) - NUEVA L√ìGICA PARA DOS FILAS
if (isAdmin) {
document.getElementById('designers-stats').style.display = 'flex';
document.getElementById('count-bermina').innerText = counts.bermina;
document.getElementById('count-jorsy').innerText = counts.jorsy;
document.getElementById('count-maria').innerText = counts.maria;
document.getElementById('count-xamir').innerText = counts.xamir;
} else {
document.getElementById('designers-stats').style.display = 'none';
}

document.getElementById('col-fecha-actividad').style.display = isAdmin ? 'none' : '';
document.getElementById('col-id-solicitud').classList.toggle('hidden', !isAdmin);
}

const DATA = {
especialidades: ["Alergolog√≠a", "Cardiolog√≠a", "Cirug√≠a general", "Dermatolog√≠a", "Fisiatr√≠a", "Foniatr√≠a", "Gastroenterolog√≠a", "Geriatr√≠a", "Gerontolog√≠a", "Ginecolog√≠a y obstetricia", "Infectolog√≠a", "Medicina familiar", "Medicina general", "Medicina interna", "Nefrolog√≠a", "Neumolog√≠a", "Neurolog√≠a", "Nutrici√≥n", "Odontolog√≠a", "Oftalmolog√≠a", "Oncolog√≠a", "Optometr√≠a", "Pediatr√≠a", "Psicolog√≠a", "Psiquiatr√≠a", "Reumatolog√≠a", "Traumatolog√≠a", "Urolog√≠a"],
servicios: ["Actividades recreativas", "Afiliaci√≥n", "Agudeza visual", "Aplicaci√≥n de fl√∫or", "Asesor√≠a legal", "Bienestar social", "Captaci√≥n odontol√≥gica", "Captaci√≥n quir√∫rgica general", "Captaci√≥n quir√∫rgica oftalmol√≥gica", "Citolog√≠a", "Control de glicemia", "Control de talla y peso", "Desparasitaci√≥n", "Despistaje de glicemia capilar", "Despistaje HTA", "Ecograf√≠a", "Electrocardiograma", "Farmacia", "Fisioterapia", "Fonoaudiolog√≠a", "Ingenier√≠a biom√©dica", "Inmunizaci√≥n", "Laboratorio", "Liberaci√≥n de hipoteca", "Masoterapia", "Podolog√≠a", "Quiropraxia", "Reposos m√©dicos", "Sesi√≥n educativa", "Servicios sociales", "Terapia de lenguaje (Logopedia)", "Terapia del dolor", "Terapia ocupacional", "Tipiaje"],
vacunas: ["Fiebre amarilla", "Pentavalente", "Polio IPV", "Polio oral", "Toxoide (tet√°nico/dift√©rico)", "Trivalente viral (SRP)"],
quirurgica: ["Bocio hiperfuncionante", "Colectom√≠a", "Enfermedad hemorroidal", "Esterilizaci√≥n", "Fibromatosis", "Fimosis", "Hernia abdominal", "Hernia epig√°strica", "Hernia escrotal", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Histerectom√≠a", "Lipomas", "Litiasis vesicular (Colecistectom√≠as)", "Lunares", "Miomatosis uterina", "Nevus", "N√≥dulos mamarios simples", "Paridad satisfecha", "Prolapso", "Quiste (TU)", "Quiste de epid√≠dimo", "Quiste seb√°ceo", "Quiste tirogloso", "Quistes seb√°ceos", "Tumores ov√°ricos", "Varicocele", "Vasectom√≠a", "Verrugas"],
pediatrica: ["Criptorquidias", "Fimosis", "Hernia epig√°strica", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Quiste tirogloso", "Varicocele"],
oftalmo: ["Cataratas", "Cirug√≠a pl√°stica ocular", "Dacriocistorrinostom√≠a", "Desprendimiento de retina", "Glaucoma", "Melanoma uveal", "Pterigi√≥n", "Ptosis palpebral", "Queratoplast√≠a", "Retinoblastoma", "Tumores oculares"]
};
// ‚úÖ FUNCIONES PARA REPORTE MENSUAL - SOLO HABILITADO 1¬∞ DE MES
function generateMonthlyReport() {
// Verificar que sea el primer d√≠a del mes
const today = new Date();
if (today.getDate() !== 1) {
openModal("‚è≥ No disponible", "El reporte mensual solo est√° disponible el primer d√≠a de cada mes.", "üìä");
return;
}
// ‚úÖ CONFIRMACI√ìN NATIVA DEL NAVEGADOR (SEGURA Y BLOQUEANTE)
if (!confirm("‚ö†Ô∏è ¬øCONFIRMA que desea generar el reporte mensual del mes anterior?\n" +
"‚úÖ Se enviar√° por correo y Telegram\n" +
"‚úÖ Luego se eliminar√°n SOLO las solicitudes finalizadas con fecha de registro del mes anterior\n" +
"‚ÑπÔ∏è Las solicitudes creadas HOY (1¬∞ de mes) NO ser√°n eliminadas\n" +
"‚ö†Ô∏è Esta acci√≥n es IRREVERSIBLE para las del mes anterior")) {
return;
}
document.getElementById('loadMainTxt').innerText = "Generando reporte mensual...";
document.getElementById('loadingOverlay').style.display = 'flex';
// Obtener credenciales almacenadas del admin
const adminUser = PROPS.getProperty("ADMIN_USER");
const adminPass = PROPS.getProperty("ADMIN_PASS");
// ‚úÖ CORREGIDO: Primero generar el reporte, LUEGO eliminar las finalizadas
fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=generateMonthlyReport&username=${encodeURIComponent(adminUser)}&password=${encodeURIComponent(adminPass)}`
})
.then(response => response.json())
.then(data => {
if (data.success) {
// ‚úÖ Mensaje con modal personalizado: especifica que solo se eliminan del mes anterior
openModal("‚úÖ Reporte Generado",
"El reporte mensual ha sido generado y enviado correctamente.\n" +
"‚ÑπÔ∏è Ahora se proceder√° a eliminar SOLO las solicitudes finalizadas con fecha de registro del mes anterior (" +
new Date(new Date().getFullYear(), new Date().getMonth()-1, 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' }) +
") para optimizar el sistema.\n" +
"‚úÖ Las solicitudes creadas hoy (1¬∞) permanecer√°n intactas.",
"üìä");
setTimeout(() => {
document.getElementById('loadMainTxt').innerText = "Eliminando solicitudes finalizadas del mes anterior...";
return fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=deleteFinalizadas&username=${encodeURIComponent(adminUser)}&password=${encodeURIComponent(adminPass)}`
});
}, 2000);
} else {
throw new Error(data.error || "Error al generar el reporte");
}
})
.then(response => {
if (response) {
return response.json();
}
})
.then(data => {
if (data && data.success) {
// ‚úÖ Mensaje final con modal personalizado: incluye el per√≠odo eliminado
openModal("‚úÖ Limpieza Completada",
`¬°Reporte mensual generado y ${data.count || 0} solicitudes finalizadas del mes anterior (${data.periodo}) eliminadas correctamente!\n` +
"‚úÖ Las solicitudes creadas hoy (1¬∞) permanecen en el sistema.",
"üìä");
updateTable();
} else if (data) {
throw new Error(data.error || "Error al limpiar solicitudes");
}
})
.catch(err => {
openModal("‚ùå Error", "Error: " + err.message, "üí•");
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}
// ‚úÖ FUNCI√ìN PARA ACTUALIZAR EL ESTADO DEL BOT√ìN DE REPORTE
function updateReportButtonStatus() {
const today = new Date();
const currentDay = today.getDate();
const totalDaysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
const btn = document.getElementById('reportBtn');
const text = document.getElementById('reportBtnText');
const daysText = document.getElementById('reportBtnDays');
if (!btn || !isAdmin) return;
// Calcular d√≠as restantes para el pr√≥ximo 1¬∞
let daysRemaining;
if (currentDay === 1) {
daysRemaining = 0;
} else {
daysRemaining = totalDaysInMonth - currentDay + 1;
}
// Actualizar texto
if (currentDay === 1) {
daysText.innerHTML = '<div class="report-info-banner">Hoy es el d√≠a para generar el reporte del mes anterior</div>';
btn.disabled = false;
btn.style.cursor = 'pointer';
text.style.opacity = '1';
btn.style.background = 'linear-gradient(to right, #2d6a4f 100%, #1e4a35 100%)';
} else {
daysText.textContent = `Disponible en ${daysRemaining} d√≠a${daysRemaining !== 1 ? 's' : ''}`;
btn.disabled = true;
btn.style.cursor = 'not-allowed';
text.style.opacity = '0.7';
// Calcular progreso para el pr√≥ximo ciclo
const progress = ((totalDaysInMonth - daysRemaining) / totalDaysInMonth) * 100;
btn.style.background = `linear-gradient(to right, #2d6a4f ${progress}%, #1e4a35 ${progress}%)`;
}
}
function checkFirstDayOfMonth() {
const today = new Date();
if (isAdmin) {
document.getElementById('reportBtn').classList.remove('hidden');
updateReportButtonStatus();
// Actualizar cada minuto para mantener el estado actualizado
setInterval(updateReportButtonStatus, 60000);
}
}
// ‚úÖ CORRECCI√ìN CR√çTICA: Manejo de fotos con atributo data-has-image
function handleFile(input, imgId, btnId) {
if (modoObituario) {
input.value = "";
return;
}
const file = input.files[0];
if (file) {
const reader = new FileReader();
reader.onload = (e) => {
const img = document.getElementById(imgId);
img.src = e.target.result; // "image/jpeg;base64,..."
img.style.display = 'block';
document.getElementById(btnId).style.display = 'block';
// ‚úÖ MARCADOR DE IMAGEN V√ÅLIDA
img.setAttribute('data-has-image', 'true');
};
reader.readAsDataURL(file);
}
}
function clearFile(inputId, imgId, btnId) {
if (modoObituario) return;
document.getElementById(inputId).value = "";
const img = document.getElementById(imgId);
img.src = "";
img.style.display = 'none';
img.removeAttribute('data-has-image'); // ‚úÖ Eliminar marca de imagen v√°lida
document.getElementById(btnId).style.display = 'none';
}
// ‚úÖ FIN FUNCIONES REPORTE MENSUAL
// ‚úÖ FUNCI√ìN PARA ELIMINAR field-error AUTOM√ÅTICAMENTE
function setupFieldErrorRemoval() {
['fecha', 'hora', 'institucion', 'direccion-exacta', 'tlf', 'mail', 'observaciones'].forEach(id => {
const el = document.getElementById(id);
if (el) {
el.addEventListener('input', () => el.classList.remove('field-error'));
el.addEventListener('focus', () => el.classList.remove('field-error'));
}
});
document.querySelectorAll('#region-grid .card-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.getElementById('region-grid').classList.remove('field-error');
});
});
const unidadGrid = document.getElementById('unidad-grid');
const observer = new MutationObserver(() => {
unidadGrid.querySelectorAll('.card-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.getElementById('unidad-grid').classList.remove('field-error');
});
});
});
observer.observe(unidadGrid, { childList: true });
document.querySelectorAll('#cat-grid .card-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.getElementById('cat-grid').classList.remove('field-error');
});
});
const cont3 = document.getElementById('cont-3');
const observer3 = new MutationObserver(() => {
cont3.querySelectorAll('.card-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.getElementById('sec-3').classList.remove('field-error');
});
});
const descOtro = document.getElementById('desc-otro');
if (descOtro) {
descOtro.addEventListener('input', () => document.getElementById('sec-3').classList.remove('field-error'));
descOtro.addEventListener('focus', () => document.getElementById('sec-3').classList.remove('field-error'));
}
});
observer3.observe(cont3, { childList: true, subtree: true });
document.getElementById('btn-am').addEventListener('click', () => document.getElementById('hora-box').classList.remove('field-error'));
document.getElementById('btn-pm').addEventListener('click', () => document.getElementById('hora-box').classList.remove('field-error'));
}
document.addEventListener('DOMContentLoaded', () => {
const regionGrid = document.getElementById('region-grid');
ORDEN_REGIONES.forEach(regionKey => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = getNombreRegionLimpio(regionKey);
btn.onclick = () => selectRegion(regionKey);
regionGrid.appendChild(btn);
});
updateTable();
setupFieldErrorRemoval();
});
function selectRegion(regionKey) {
document.querySelectorAll('#region-grid .card-btn').forEach(b => b.classList.remove('selected'));
const index = ORDEN_REGIONES.indexOf(regionKey);
if (index !== -1) {
document.querySelector(`#region-grid .card-btn:nth-child(${index + 1})`).classList.add('selected');
}
selectedRegionKey = regionKey;
selectedUnidad = "";
const unidadGrid = document.getElementById('unidad-grid');
unidadGrid.innerHTML = "";
const unidades = UNIDADES_IPASME[regionKey] || [];
unidades.forEach(unidad => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = unidad.trim();
btn.onclick = () => selectUnidad(unidad.trim());
unidadGrid.appendChild(btn);
});
document.getElementById('unidad-section').classList.remove('hidden');
}
function selectUnidad(unidad) {
selectedUnidad = unidad.trim();
document.querySelectorAll('#unidad-grid .card-btn').forEach(b => b.classList.remove('selected'));
const clickedBtn = Array.from(document.querySelectorAll('#unidad-grid .card-btn'))
.find(b => b.innerText.trim() === selectedUnidad);
if (clickedBtn) clickedBtn.classList.add('selected');
}
// ‚úÖ FUNCI√ìN TOGGLE MODO OBITUARIO ACTUALIZADA
function toggleObituario() {
modoObituario = !modoObituario;
const btn = document.getElementById('btn-obituario');
const fechaInput = document.getElementById('fecha');
const horaInput = document.getElementById('hora');
const institucion = document.getElementById('institucion');
const direccionExacta = document.getElementById('direccion-exacta');
const observaciones = document.getElementById('observaciones');
const descOtro = document.getElementById('desc-otro');
// ‚úÖ Referencia al textarea
const uploadBoxes = document.querySelectorAll('.upload-box');
const labels = document.querySelectorAll('.upload-label');
if (modoObituario) {
btn.classList.add('obit-active');
btn.innerText = "OBITUARIO";
const hoy = new Date();
const yyyy = hoy.getFullYear();
const mm = String(hoy.getMonth() + 1).padStart(2, '0');
const dd = String(hoy.getDate()).padStart(2, '0');
fechaInput.value = `${yyyy}-${mm}-${dd}`;
fechaInput.disabled = true;
horaInput.disabled = true;
institucion.disabled = true;
direccionExacta.disabled = true;
observaciones.disabled = true;
horaInput.classList.add('obit-disabled');
institucion.classList.add('obit-disabled');
direccionExacta.classList.add('obit-disabled');
observaciones.classList.add('obit-disabled');
uploadBoxes.forEach(box => box.classList.add('obit-upload-box'));
labels.forEach(label => label.classList.add('obit-upload-label'));
horaInput.value = '';
institucion.value = '';
direccionExacta.value = '';
observaciones.value = '';
// ‚úÖ Placeholder corregido: sin "familiar"
if (descOtro) {
descOtro.placeholder = "Indique por favor nombre del fallecido, parentesco en caso de ser familiar de un trabajador del Ipasme y servicio o jurisdicci√≥n a la que pertenece el familiar o el fallecido.";
}
Array.from(document.querySelectorAll('.preview')).forEach(img => {
img.src = '';
img.style.display = 'none';
img.removeAttribute('data-has-image'); // ‚úÖ Limpiar marca de imagen
});
Array.from(document.querySelectorAll('.remove-btn')).forEach(btn => btn.style.display = 'none');
} else {
btn.classList.remove('obit-active');
btn.innerText = "OBITUARIO";
fechaInput.disabled = false;
horaInput.disabled = false;
institucion.disabled = false;
direccionExacta.disabled = false;
observaciones.disabled = false;
horaInput.classList.remove('obit-disabled');
institucion.classList.remove('obit-disabled');
direccionExacta.classList.remove('obit-disabled');
observaciones.classList.remove('obit-disabled');
uploadBoxes.forEach(box => box.classList.remove('obit-upload-box'));
labels.forEach(label => label.classList.remove('obit-upload-label'));
// ‚úÖ Restaurar placeholder original
if (descOtro) {
descOtro.placeholder = "Detalle aqu√≠ su solicitud especial...";
}
}
}
// === FUNCIONES DE SEGURIDAD Y LIMPIEZA ===
function clearCredentials() {
document.getElementById('adminUser').value = '';
document.getElementById('adminPass').value = '';
}
function togglePass() {
const input = document.getElementById('adminPass');
input.type = input.type === 'password' ? 'text' : 'password';
}
function openModal(t, m, icon = "‚ö†Ô∏è") {
clearCredentials();
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.add('hidden');
document.getElementById('modalIcon').innerText = icon;
document.getElementById('modalTitle').innerText = t;
document.getElementById('modalMsg').innerText = m;
const btn = document.getElementById('mainModalBtn');
btn.innerText = "ENTENDIDO";
btn.onclick = closeModal;
document.getElementById('modalAlert').style.display = 'flex';
}
function closeModal() {
clearCredentials();
document.getElementById('modalAlert').style.display = 'none';
}
function showLogin() {
clearCredentials();
document.getElementById('modalIcon').innerText = "üîê";
document.getElementById('modalTitle').innerText = "Acceso Restringido";
document.getElementById('modalMsg').innerText = "Inicie sesi√≥n para modo administraci√≥n.";
document.getElementById('loginArea').classList.remove('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden');
const btn = document.getElementById('mainModalBtn');
btn.innerText = "VALIDAR CREDENCIALES";
btn.onclick = validateLogin;
document.getElementById('modalAlert').style.display = 'flex';
const userField = document.getElementById('adminUser');
const passField = document.getElementById('adminPass');
const handleEnter = (e) => {
if (e.key === 'Enter') {
validateLogin();
}
};
userField.removeEventListener('keydown', handleEnter);
passField.removeEventListener('keydown', handleEnter);
userField.addEventListener('keydown', handleEnter);
passField.addEventListener('keydown', handleEnter);
}
async function validateLogin() {
const u = document.getElementById('adminUser').value.trim();
const p = document.getElementById('adminPass').value.trim();
if (!u || !p) {
openModal("‚ùå Error", "Complete ambos campos.", "üîê");
return;
}
document.getElementById('loadMainTxt').innerText = "Verificando credenciales...";
document.getElementById('loadingOverlay').style.display = 'flex';
try {
const params = new URLSearchParams();
params.append("action", "loginAdmin");
params.append("username", u);
params.append("password", p);
const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
const data = await res.json();
if (data.success && data.data?.isAdmin) {
isAdmin = true;
document.getElementById('authBtn').className = "btn-logout";
document.getElementById('authBtn').innerText = "Cerrar Gesti√≥n";
document.getElementById('authBtn').onclick = logout;
document.getElementById('th-admin').classList.remove('hidden');
document.getElementById('maintBtn').classList.remove('hidden');
document.getElementById('col-fecha-registro').style.display = 'none';
// ‚úÖ Verificar y mostrar bot√≥n de reporte - SOLO 1¬∞ DE MES
checkFirstDayOfMonth();
clearCredentials();
closeModal();
updateTable();
} else {
openModal("‚ùå Error", "Usuario o Contrase√±a incorrectos.", "üîê");
clearCredentials();
}
} catch (err) {
openModal("‚ùå Error", "Error de conexi√≥n al validar.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}
function logout() {
isAdmin = false;
document.getElementById('authBtn').className = "btn-login";
document.getElementById('authBtn').innerText = "üîê Administrador";
document.getElementById('authBtn').onclick = showLogin;
document.getElementById('th-admin').classList.add('hidden');
document.getElementById('maintBtn').classList.add('hidden');
document.getElementById('reportBtn').classList.add('hidden');
document.getElementById('col-fecha-registro').style.display = '';
if(isMaintActive) document.getElementById('maintOverlay').style.display = 'flex';
renderLocalTable();
clearCredentials();
}
// === FIN FUNCIONES DE SEGURIDAD ===
// === FUNCIONES ADMIN ===
function openArteModal(id) {
document.getElementById('currentReqId').value = id;
document.getElementById('arteFile').value = '';
document.getElementById('modalIcon').innerText = "üé®";
document.getElementById('modalTitle').innerText = "Adjuntar Arte Final";
document.getElementById('modalMsg').innerText = "Seleccione el archivo para la solicitud " + id;
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.remove('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden');
const btn = document.getElementById('mainModalBtn');
btn.innerText = "SUBIR A DRIVE";
btn.onclick = uploadArte;
document.getElementById('modalAlert').style.display = 'flex';
}
async function uploadArte() {
const fileInput = document.getElementById('arteFile');
const id = document.getElementById('currentReqId').value;
if (fileInput.files.length === 0) {
openModal("üìé Advertencia", "Por favor seleccione un archivo.", "üìÅ");
return;
}
const file = fileInput.files[0];
if (file.size > 5 * 1024 * 1024) {
openModal("üìè Tama√±o Excedido", "El archivo excede los 5MB permitidos.", "‚ö†Ô∏è");
return;
}
document.getElementById('loadMainTxt').innerText = "Subiendo Arte...";
document.getElementById('loadingOverlay').style.display = 'flex';
const reader = new FileReader();
reader.onload = async function(e) {
const base64 = e.target.result.split(',')[1];
const params = new URLSearchParams();
params.append("action", "uploadArte");
params.append("id", id);
params.append("filename", file.name);
params.append("file", base64);
params.append("mime", file.type);
try {
const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
const data = await res.json();
if (data.success) {
closeModal();
openModal("‚úÖ √âxito", "¬°Arte subido con √©xito!", "üé®");
updateTable();
document.getElementById('arteFile').value = '';
} else {
openModal("‚ùå Error", "Error: " + data.error, "üí•");
}
} catch (err) {
openModal("‚ùå Error", "Error de conexi√≥n al subir.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
};
reader.readAsDataURL(file);
}
async function sendTelegramArte(id) {
const req = localData.find(x => x.id == id);
if(!confirm("¬øEnviar el arte de " + id + " a Telegram?")) return;
document.getElementById('loadMainTxt').innerText = "Enviando a Telegram...";
document.getElementById('loadingOverlay').style.display = 'flex';
try {
const params = new URLSearchParams();
params.append("action", "sendTelegramArte");
params.append("id", id);
const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
const data = await res.json();
if(data.success) {
openModal("‚úàÔ∏è Telegram", "¬°Enviado a Telegram en alta calidad!", "üì≤");
setTimeout(() => closeModal(), 2000);
} else {
openModal("‚ùå Error", "Error: " + data.error, "üí•");
}
} catch (e) {
openModal("‚ùå Error", "Error de conexi√≥n.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}
async function toggleMaintMode() {
if (!isAdmin) return;
const nuevoEstado = !isMaintActive;
document.getElementById('loadingOverlay').style.display = 'flex';
try {
await fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=setMaintenance&status=${nuevoEstado}`
});
isMaintActive = nuevoEstado;
openModal(
"‚öôÔ∏è Modo Mantenimiento",
"Modo mantenimiento " + (nuevoEstado ? "ACTIVADO" : "DESACTIVADO") + ".",
"üõ†Ô∏è"
);
setTimeout(() => location.reload(), 1500);
} catch (e) {
openModal("‚ùå Error", "Error al cambiar estado del mantenimiento.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}
// === üî• ELIMINACI√ìN CON MODALES PERSONALIZADOS ===
let currentDeleteId = null;
function deleteReq(id) {
currentDeleteId = id;
showDeleteConfirm(1);
}
function showDeleteConfirm(step) {
const id = currentDeleteId;
if (step === 1) {
openCustomModal(
"üóëÔ∏è Confirmar Eliminaci√≥n",
`¬øEst√° seguro de eliminar la solicitud <b>${id}</b>?`,
() => showDeleteConfirm(2),
() => closeModal()
);
} else if (step === 2) {
openCustomModal(
"‚ö†Ô∏è ¬°Advertencia Final!",
`¬°Esta acci√≥n es <b>irreversible</b>!<br>¬øEliminar permanentemente la solicitud <b>${id}</b> de la base de datos?`,
() => executeDelete(),
() => closeModal()
);
}
}
function openCustomModal(title, message, onConfirm, onCancel) {
document.getElementById('modalIcon').innerText = "‚ùì";
document.getElementById('modalTitle').innerText = title;
document.getElementById('modalMsg').innerHTML = message;
const mainBtn = document.getElementById('mainModalBtn');
const altBtn = document.getElementById('closeModalBtn');
mainBtn.innerText = "S√ç, ACEPTAR";
mainBtn.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
altBtn.classList.remove('hidden');
altBtn.innerText = "CANCELAR";
altBtn.onclick = () => { closeModal(); if (onCancel) onCancel(); };
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('modalAlert').style.display = 'flex';
}
async function executeDelete() {
const id = currentDeleteId;
localData = localData.filter(x => x.id != id);
renderLocalTable();
try {
const params = new URLSearchParams();
params.append("action", "delete");
params.append("id", id);
await fetch(SCRIPT_URL, { method: 'POST', body: params });
openModal("‚úÖ √âxito", "Solicitud y arte eliminados correctamente.", "üóëÔ∏è");
} catch (e) {
openModal("‚ùå Error", "Error al eliminar. Revise la conexi√≥n.", "üí•");
updateTable();
}
}
// === FIN ELIMINACI√ìN ===
// === FIN FUNCIONES ADMIN ===
// === FUNCIONES GENERALES ===
function setAMPM(val) {
if (modoObituario) return;
selectedAMPM = val;
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
document.getElementById(val === 'a. m.' ? 'btn-am' : 'btn-pm').classList.add('active');
document.getElementById('hora-box').classList.remove('field-error');
}
// ‚úÖ MODIFICACI√ìN EN selectCat: reiniciar modoObituario si cambia de categor√≠a Y AGREGAR SOPORTE PARA PEDI√ÅTRICA
function selectCat(btn, tipo) {
if (modoObituario && tipo !== 'otros') {
modoObituario = false;
const obitBtn = document.getElementById('btn-obituario');
if (obitBtn) {
obitBtn.classList.remove('obit-active');
obitBtn.innerText = "OBITUARIO";
document.getElementById('fecha').disabled = false;
document.getElementById('hora').disabled = false;
document.getElementById('institucion').disabled = false;
document.getElementById('direccion-exacta').disabled = false;
document.getElementById('observaciones').disabled = false;
document.getElementById('hora').classList.remove('obit-disabled');
document.getElementById('institucion').classList.remove('obit-disabled');
document.getElementById('direccion-exacta').classList.remove('obit-disabled');
document.getElementById('observaciones').classList.remove('obit-disabled');
document.querySelectorAll('.upload-box').forEach(box => box.classList.remove('obit-upload-box'));
document.querySelectorAll('.upload-label').forEach(label => label.classList.remove('obit-upload-label'));
// ‚úÖ Limpiar marcas de im√°genes
Array.from(document.querySelectorAll('.preview')).forEach(img => {
img.removeAttribute('data-has-image');
});
}
}
document.querySelectorAll('#cat-grid .card-btn').forEach(b => b.classList.remove('selected'));
btn.classList.add('selected');
catName = btn.innerText;
catType = tipo;
document.getElementById('cat-grid').classList.remove('field-error');
const s3 = document.getElementById('sec-3');
const s4 = document.getElementById('sec-4');
const c3 = document.getElementById('cont-3');
const c4 = document.getElementById('cont-4');
s3.classList.remove('hidden');
s4.classList.add('hidden');
c3.innerHTML = "";
c4.innerHTML = "";
if (['escuela', 'integral', 'conjunta'].includes(tipo)) {
document.getElementById('label-3').innerText = "ü©∫ 3. ESPECIALIDADES M√âDICAS *";
renderList(c3, DATA.especialidades);
s4.classList.remove('hidden');
renderList(c4, DATA.servicios);
} else if (tipo === 'vacuna') {
document.getElementById('label-3').innerText = "üíâ 3. LISTA DE VACUNAS *";
renderList(c3, DATA.vacunas);
} else if (tipo === 'quirurgica') {
document.getElementById('label-3').innerText = "üî™ 3. PATOLOG√çAS QUIR√öRGICAS *";
renderList(c3, DATA.quirurgica);
} else if (tipo === 'pediatrica') {
document.getElementById('label-3').innerText = "üë∂ 3. PATOLOG√çAS PEDI√ÅTRICAS *";
renderList(c3, DATA.pediatrica);
} else if (tipo === 'oftalmo') {
document.getElementById('label-3').innerText = "üëÅÔ∏è 3. PATOLOG√çAS OFTALMOL√ìGICAS *";
renderList(c3, DATA.oftalmo);
} else {
document.getElementById('label-3').innerText = "‚ú® 3. DESCRIPCI√ìN DEL REQUERIMIENTO *";
c3.innerHTML = '<textarea id="desc-otro" class="modern-input" rows="3" style="grid-column: 1 / -1;" placeholder="Detalle aqu√≠ su solicitud especial..."></textarea>';
c3.innerHTML += `
<div style="display: flex; align-items: center; gap: 12px; margin-top: 12px; flex-wrap: wrap; grid-column: 1 / -1;">
<button type="button" id="btn-obituario" class="btn-time" style="background: #f8f9fa; border-color: var(--gris); color: var(--azul-deep); width: 120px; padding: 8px;"
onclick="toggleObituario()">
OBITUARIO
</button>
<div style="flex: 1; min-width: 200px; background: #fff8e1; border: 1px solid #ffe082; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; color: #5d4600; font-weight: 600; line-height: 1.3;">
‚ö†Ô∏è Activar este modo elimina el requerimiento de 48 horas.
√öselo con moderaci√≥n.
</div>
</div>`;
}
}
function renderList(cont, list) { 
list.forEach(i => { 
const d = document.createElement('div'); 
d.className = 'card-btn'; 
d.innerText = i; 
d.onclick = () => { 
d.classList.toggle('selected'); 
document.getElementById('sec-3').classList.remove('field-error'); 
}; 
cont.appendChild(d); 
});
}
function showPage(id, btn) { 
document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
document.getElementById(id).classList.add('active'); 
window.scrollTo({top: 0, behavior: 'smooth'}); 
if(btn) btn.classList.add('active'); 
else document.getElementById('tab-' + id.split('-')[0]).classList.add('active'); 
if(id === 'list-page') updateTable(); 
}
async function updateTable() {
try {
const res = await fetch(`${SCRIPT_URL}?action=read`);
const response = await res.json();
isMaintActive = (response.maintenance === "true" || response.maintenance === true);
if(isMaintActive && !isAdmin) { 
document.getElementById('maintOverlay').style.display = 'flex'; 
}
else { 
document.getElementById('maintOverlay').style.display = 'none'; 
}
if (response.success && Array.isArray(response.data)) {
localData = response.data;
renderLocalTable();
}
} catch (e) { 
console.error("Error cargando tabla:", e); 
}
}
// ‚úÖ VALIDACI√ìN EN ORDEN CORRECTO
function validateForm() {
const fieldsInOrder = [];
fieldsInOrder.push({
id: 'region-grid',
isValid: () => !!selectedRegionKey,
label: 'Regi√≥n'
});
fieldsInOrder.push({
id: 'unidad-grid',
isValid: () => !!selectedUnidad,
label: 'Unidad M√©dica'
});
fieldsInOrder.push({
id: 'cat-grid',
isValid: () => !!catName,
label: 'Tipo de Jornada'
});
fieldsInOrder.push({
id: 'sec-3',
isValid: () => {
if (catType === 'otros') {
return document.getElementById('desc-otro')?.value.trim() !== '';
} else {
return document.querySelectorAll('#cont-3 .card-btn.selected').length > 0;
}
},
label: 'Detalle'
});
fieldsInOrder.push({
id: 'fecha',
isValid: () => {
const val = document.getElementById('fecha').value;
return !!val;
},
label: 'Fecha de Actividad'
});
if (!modoObituario) {
fieldsInOrder.push({
id: 'hora',
isValid: () => {
const val = document.getElementById('hora').value.trim();
return !!val;
},
label: 'Hora de Inicio'
});
fieldsInOrder.push({
id: 'hora-box',
isValid: () => !!selectedAMPM,
label: 'Formato AM/PM'
});
fieldsInOrder.push({
id: 'institucion',
isValid: () => {
const val = document.getElementById('institucion').value.trim();
return !!val;
},
label: 'Instituci√≥n'
});
}
fieldsInOrder.push({
id: 'mail',
isValid: () => {
const val = document.getElementById('mail').value.trim();
return val && val.includes('@');
},
label: 'Correo Electr√≥nico'
});
for (const field of fieldsInOrder) {
const el = document.getElementById(field.id);
if (!field.isValid()) {
el?.classList.add('field-error');
el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
openModal("‚ùå Campo Faltante", `Falta completar: ${field.label}`, "‚ö†Ô∏è");
return false;
}
}
if (!modoObituario) {
const fechaInput = document.getElementById('fecha').value;
const fechaSeleccionada = new Date(fechaInput + 'T00:00:00');
const ahora = new Date();
// ‚úÖ CAMBIO INTERNO: 48 ‚Üí 24 horas
if ((fechaSeleccionada - ahora) / (1000 * 60 * 60) < 24) {
document.getElementById('fecha').classList.add('field-error');
openModal("‚è≥ Restricci√≥n de Tiempo", "Las solicitudes deben realizarse con al menos 48 horas de anticipaci√≥n.", "‚è∞");
return false;
}
}
return true;
}
function showConfirmationModal() {
if (!validateForm()) return;
const preview = document.getElementById('previewContent');
let html = `
<p><b>üìç Regi√≥n:</b> ${getNombreRegionLimpio(selectedRegionKey)}</p>
<p><b>üè• Unidad M√©dica:</b> ${selectedUnidad}</p>
`;
if (modoObituario) {
html += `<p><b>üìã Tipo de Solicitud:</b> Obituario</p>`;
} else {
html += `<p><b>üìÇ Tipo de Jornada:</b> ${catName}</p>`;
}
if (catType === 'otros' && !modoObituario) {
html += `<p><b>‚ú® Descripci√≥n:</b> ${document.getElementById('desc-otro').value.trim()}</p>`;
} else if (!modoObituario) {
const selectedOps = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el => el.innerText).join(', ');
html += `<p><b>ü©∫ Detalle:</b> ${selectedOps || 'Ninguno'}</p>`;
}
const servicios = Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el => el.innerText).join(', ');
if (servicios) html += `<p><b>‚ú® Servicios Adicionales:</b> ${servicios}</p>`;
const [year, month, day] = document.getElementById('fecha').value.split('-');
const fechaFormateada = `${day}/${month}/${year}`;
html += `<p><b>üìÖ Fecha de Actividad:</b> ${fechaFormateada}</p>`;
if (!modoObituario) {
html += `<p><b>‚è∞ Hora de Inicio:</b> ${document.getElementById('hora').value} ${selectedAMPM}</p>`;
const institucion = document.getElementById('institucion').value.trim();
const direccion = document.getElementById('direccion-exacta').value.trim();
html += `<p><b>üß≠ Ubicaci√≥n:</b> ${[institucion, direccion].filter(x => x).join(', ')}</p>`;
html += `<p><b>üì± Tel√©fono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>`;
html += `<p><b>‚úâÔ∏è Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>`;
const obs = document.getElementById('observaciones').value.trim();
if (obs) html += `<p><b>‚úèÔ∏è Observaciones:</b> ${obs}</p>`;
// ‚úÖ CORREGIDO: Contar fotos usando el atributo data-has-image
const fotos = [1,2,3].filter(i => {
const img = document.getElementById(`p${i}`);
return img.getAttribute('data-has-image') === 'true';
});
html += `<p><b>üì∏ Soportes Fotogr√°ficos:</b> ${fotos.length > 0 ? `${fotos.length} foto(s) adjunta(s)` : 'Ninguno'}</p>`;
} else {
html += `<p><b>üì± Tel√©fono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>`;
html += `<p><b>‚úâÔ∏è Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>`;
html += `<p><b>‚ÑπÔ∏è Modo Obituario activado ‚Äì Campos opcionales omitidos.</b></p>`;
}
preview.innerHTML = html;
document.getElementById('confirmModal').style.display = 'flex';
let timeLeft = 10;
document.getElementById('countdown').innerText = timeLeft;
const btnEnviar = document.getElementById('btnEnviarConfirmado');
btnEnviar.disabled = true;
btnEnviar.classList.remove('enviar');
btnEnviar.classList.add('corregir');
const btnCorregir = document.getElementById('btnCorregir');
btnCorregir.onmouseenter = () => {
btnCorregir.style.background = "#d1d5db";
btnCorregir.style.color = "#212529";
};
btnCorregir.onmouseleave = () => {
btnCorregir.style.background = "var(--gris)";
btnCorregir.style.color = "var(--azul-deep)";
};
const timer = setInterval(() => {
timeLeft--;
document.getElementById('countdown').innerText = timeLeft;
const progress = ((10 - timeLeft) / 10) * 100;
btnEnviar.style.background = `linear-gradient(to right, var(--turquesa) ${progress}%, #e9ecef ${progress}%)`;
btnEnviar.style.color = timeLeft <= 3 ? "white" : "#495057";
if (timeLeft <= 0) {
clearInterval(timer);
btnEnviar.disabled = false;
btnEnviar.classList.remove('corregir');
btnEnviar.classList.add('enviar');
btnEnviar.style.background = "var(--turquesa)";
btnEnviar.style.color = "white";
btnEnviar.style.cursor = "pointer";
btnEnviar.innerText = "üöÄ Enviar Solicitud";
btnEnviar.onmouseenter = () => {
btnEnviar.style.background = "var(--azul-deep)";
btnEnviar.style.transform = "scale(1.02)";
};
btnEnviar.onmouseleave = () => {
btnEnviar.style.background = "var(--turquesa)";
btnEnviar.style.transform = "scale(1)";
};
}
}, 1000);
window.confirmTimer = timer;
}
document.getElementById('btnCorregir').onclick = () => {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
};
function proceedToSend() {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
realSubmitForm();
}
document.getElementById('btnEnviarConfirmado').onclick = proceedToSend;
// === ENV√çO REAL ===
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw4oGU8GLqut_CQTWIdkArjakKsuRAZLVF9xI4YhO-pYV0XYvMp-BXoE4arULToavgaw/exec";
document.getElementById('sigrafForm').onsubmit = function(e) {
e.preventDefault();
showConfirmationModal();
};
function realSubmitForm() {
const params = new URLSearchParams();
const EXCEPCIONES_SIN_UMI = [
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende",
"Club Villas Ipasmar",
"Hotel Valle Grande"
];
// ‚úÖ CORRECCI√ìN: se elimina la capitalizaci√≥n autom√°tica
let unidadFinal = selectedUnidad.trim();
if (!EXCEPCIONES_SIN_UMI.includes(unidadFinal)) {
unidadFinal = "U.M.I. " + unidadFinal;
}
params.append("Unidad", unidadFinal);
// ‚úÖ Aqu√≠ se env√≠a "Obituario" si est√° activo
params.append("Jornada", modoObituario ? "Obituario" : catName);
let ops = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el=>el.innerText).join(", ");
if(catType === 'otros') ops = document.getElementById('desc-otro').value;
params.append("Opciones", ops);
params.append("Servicios", Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el=>el.innerText).join(", "));
if (!modoObituario) {
const institucion = document.getElementById('institucion').value.trim();
const direccionExacta = document.getElementById('direccion-exacta').value.trim();
const direccionCompleta = [institucion, direccionExacta].filter(part => part).join(", ");
params.append("Direccion", direccionCompleta);
params.append("Hora", document.getElementById('hora').value + " " + selectedAMPM);
params.append("Observaciones", document.getElementById('observaciones').value);
// ‚úÖ CORREGIDO: Adjuntar fotos usando el atributo data-has-image
for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
if(img.getAttribute('data-has-image') === 'true') {
const base64Data = img.src.split(',')[1];
if (base64Data) {
params.append("foto"+i, base64Data);
}
}
}
} else {
params.append("Direccion", "");
params.append("Hora", "");
params.append("Observaciones", "");
}
params.append("Fecha", document.getElementById('fecha').value);
params.append("Telefono", document.getElementById('tlf').value);
params.append("Correo", document.getElementById('mail').value);
document.getElementById('loadMainTxt').innerText = "Enviando Solicitud...";
document.getElementById('loadingOverlay').style.display = 'flex';
fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: params.toString()
})
.then(response => response.json())
.then(result => {
if (result.success) {
document.getElementById('sigrafForm').reset();
for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
img.src = '';
img.style.display = 'none';
img.removeAttribute('data-has-image'); // ‚úÖ Limpiar marca
document.getElementById('b'+i).style.display = 'none';
}
document.querySelectorAll('.card-btn').forEach(btn => btn.classList.remove('selected'));
document.getElementById('sec-3').classList.add('hidden');
document.getElementById('sec-4').classList.add('hidden');
selectedAMPM = "";
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
selectedRegionKey = "";
selectedUnidad = "";
modoObituario = false;
document.getElementById('fecha').disabled = false;
document.getElementById('hora').disabled = false;
document.getElementById('institucion').disabled = false;
document.getElementById('direccion-exacta').disabled = false;
document.getElementById('observaciones').disabled = false;
document.getElementById('hora').classList.remove('obit-disabled');
document.getElementById('institucion').classList.remove('obit-disabled');
document.getElementById('direccion-exacta').classList.remove('obit-disabled');
document.getElementById('observaciones').classList.remove('obit-disabled');
document.querySelectorAll('.upload-box').forEach(box => box.classList.remove('obit-upload-box'));
document.querySelectorAll('.upload-label').forEach(label => label.classList.remove('obit-upload-label'));
document.getElementById('region-grid').querySelectorAll('.card-btn').forEach(b => b.classList.remove('selected'));
document.getElementById('unidad-grid').innerHTML = "";
document.getElementById('unidad-section').classList.add('hidden');
openModal("‚úÖ ¬°√âxito!", "Su solicitud ha sido enviada correctamente.", "üöÄ");
setTimeout(() => {
closeModal();
showPage('list-page', document.getElementById('tab-list'));
}, 2000);
} else {
throw new Error(result.error);
}
})
.catch(e => {
openModal("‚úÖ Solicitud Procesada", "El sistema ha registrado su env√≠o.", "üìã");
setTimeout(() => {
closeModal();
showPage('list-page', document.getElementById('tab-list'));
}, 2000);
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}
</script>
</body>
</html>
