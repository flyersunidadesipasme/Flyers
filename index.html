<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!-- ✨ SONIDO DE NOTIFICACIÓN (CDN Externo) -->
<audio id="notificationSound" preload="auto">
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mp3">
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.wav" type="audio/wav">
</audio>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIRA 3.0 Reborn | Sistema Integral de Requerimientos de Artes</title>
<link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600;800&display=swap" rel="stylesheet">
<!-- ✅ Chart.js para gráficos de estadísticas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  /* Colores de la paleta Ocean */
  --color-bondi: #0799b6;
  --color-san-marino: #4a6eb0;
  --color-eden: #114c5f;
  --color-sinbad: #9cd2d3;
  --color-janna: #f2e6cf;

  /* Mapeo Modo Claro */
  --bg-body: var(--color-janna);
  --bg-surface: #ffffff;
  --text-primary: var(--color-eden);
  --text-secondary: var(--color-san-marino);
  --border-color: rgba(17, 76, 95, 0.1);
  --btn-bg: var(--color-bondi);
  --btn-text: #ffffff;
  --header-bg: var(--color-eden);
  --tab-active-gradient: linear-gradient(135deg, var(--color-bondi) 0%, var(--color-san-marino) 100%);

  /* Variables compatibles para código existente */
  --celeste: var(--color-sinbad);
  --turquesa: var(--color-bondi);
  --azul-deep: var(--color-eden);
  --amarillo: #ffb703;
  --naranja: #fb8500;
  --rojo: #e63946;
  --verde: #2d6a4f;
  --gris: #edf2f4;
  --panel-width: 380px;
}

/* Mapeo Modo Oscuro */
[data-theme="dark"] {
  --bg-body: var(--color-eden);
  --bg-surface: #165a6e; /* Variante de Eden más clara para dar profundidad */
  --text-primary: var(--color-janna);
  --text-secondary: var(--color-sinbad);
  --border-color: rgba(242, 230, 207, 0.1);
  --btn-bg: var(--color-sinbad); /* En oscuro, el color claro resalta más */
  --btn-text: var(--color-eden);
  --header-bg: #0d3a49; /* Eden oscuro para header */
  --tab-active-gradient: linear-gradient(135deg, var(--color-sinbad) 0%, var(--color-janna) 100%);
}
* { font-family: 'Georama', sans-serif;
box-sizing: border-box; font-weight: 500; }
body { background: var(--bg-body); margin: 0; padding-bottom: 50px; color: var(--text-primary); transition: all 0.3s ease; }
header { background: var(--header-bg);
padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; min-height: 55px;
flex-wrap: wrap;
gap: 10px;
}
.brand-container { display: flex; flex-direction: column; align-items: flex-start; flex: 1; min-width: 150px; }
.header-title { margin: 0; font-size: 1.2rem; font-weight: 800; color: white;
line-height: 1; }
.acronimo { font-size: 0.5rem; font-weight: 400; letter-spacing: 0.5px; margin-top: 2px; opacity: 0.9; text-transform: uppercase; color: white; max-width: 250px;
}
/* ✅ ESTILO SWITCH MEJORADO SIN CONTENEDOR */
.nav-tabs { 
  display: flex; 
  justify-content: center; 
  gap: 8px; 
  flex: 1; 
  min-width: 160px; 
  max-width: 220px;
  padding: 4px;
  position: relative;
}

.tab-btn { 
  padding: 8px 16px; 
  border-radius: 20px; 
  border: none;
  cursor: pointer; 
  font-weight: 700; 
  text-transform: uppercase; 
  font-size: 0.65rem; 
  background: rgba(255,255,255,0.1); 
  color: rgba(255,255,255,0.7); 
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  display: flex; 
  align-items: center; 
  gap: 4px;
  position: relative;
  z-index: 2;
  letter-spacing: 0.3px;
  flex: 1;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.tab-btn:hover {
  background: rgba(255,255,255,0.2);
  color: rgba(255,255,255,0.9);
  transform: translateY(-1px);
}

.tab-btn.active { 
  background: linear-gradient(135deg, var(--amarillo) 0%, var(--naranja) 100%);
  color: var(--azul-deep);
  font-weight: 800;
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 4px 15px rgba(251, 133, 0, 0.4);
}

.admin-access { flex: 1; display: flex; flex-direction: row; align-items: center; gap: 8px; min-width: 280px; flex-wrap: wrap; justify-content: flex-end; }
/* ✅ ESTILO PARA MENSAJE DE BIENVENIDA - MÁS LLAMATIVO */
.welcome-message {
font-size: 0.9rem;
font-weight: 800;
color: white;
background: linear-gradient(135deg, var(--amarillo) 0%, var(--naranja) 100%);
padding: 6px 14px;
border-radius: 20px;
display: none;
box-shadow: 0 3px 12px rgba(251, 133, 0, 0.3);
border: 2px solid rgba(255, 255, 255, 0.2);
text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
letter-spacing: 0.3px;
position: relative;
z-index: 1;
margin-left: 8px;
}
.welcome-message.show {
display: block;
animation: fadeInDown 0.6s ease-out;
}
@keyframes fadeInDown {
from {
opacity: 0;
transform: translateY(-20px) scale(0.95);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}
/* ✅ ESTILO PARA CONTENEDOR DE BOTONES EN HORIZONTAL */
.admin-buttons {
display: flex;
gap: 8px;
justify-content: flex-end;
flex-wrap: nowrap;
align-items: center;
}
.btn-login { background: var(--amarillo);
border: none; padding: 6px 12px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.7rem; box-shadow: 0 3px 0 #c79100; transition: 0.2s;
min-width: 100px;
}
.btn-login:active { transform: translateY(2px); box-shadow: 0 1px 0 #c79100; }
.btn-logout { background: var(--rojo); color: white; border: none; padding: 6px 12px;
border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.7rem; min-width: 100px;
}
.row-new { background-color: #e3f2fd !important; border-left: 5px solid var(--turquesa) !important;
}
.row-obituario { background-color: #ffebee !important; border-left: 5px solid var(--rojo) !important; }
.badge-new { background: var(--turquesa); color: white; padding: 2px 8px;
border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; animation: blink 2s infinite; }
.badge-prioridad { background: white; color: var(--rojo);
padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; border: 1px solid var(--rojo);
}
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1;
} }
.stats-grid { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.stat-card { flex: 1; min-width: 100px;
padding: 8px; border-radius: 12px; text-align: center; color: white; font-weight: 800; }
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep);
}
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }
/* ✅ ESTILOS PARA CONTADORES DE DISEÑADORES */
.stat-bermina { background: var(--naranja); color: white; }
.stat-jorsy { background: var(--azul-deep); color: white; }
.stat-maria { background: var(--verde); color: white; }
.stat-xamir { background: var(--amarillo); color: var(--azul-deep); }
.stat-label { font-size: 0.6rem; text-transform: uppercase; display: block; opacity: 0.8;
}
.stat-val { font-size: 1.1rem; }
.container { max-width: 1200px; margin: 15px auto; padding: 25px; background: white; border-radius: 25px;
box-shadow: 0 15px 40px rgba(0,0,0,0.06); }
.aviso-48h { background: #fff3e0; border: 2.5px solid var(--naranja); color: var(--naranja); padding: 15px; border-radius: 15px;
text-align: center; font-weight: 800; margin-bottom: 25px; font-size: 1.1rem; }
.section-title { display: block; font-weight: 800; font-size: 0.85rem;
color: var(--turquesa); margin: 20px 0 12px; border-left: 4px solid var(--turquesa); padding-left: 10px; text-transform: uppercase; }
.category-row { display: grid;
grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }
.card-btn { background: #fff; border: 2px solid var(--gris); border-radius: 12px; padding: 6px 4px;
cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 800; font-size: 0.75rem; min-height: 45px; line-height: 1.1;
color: var(--azul-deep); }
.card-btn.selected { background: var(--amarillo); border-color: var(--naranja); transform: scale(0.98); }
.field-error { border: 2px solid var(--rojo) !important;
animation: border-blink 0.8s infinite alternate !important; background: #fff5f5 !important; }
@keyframes border-blink { from { border-color: var(--rojo);
box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); } to { border-color: transparent; box-shadow: none; } }
.btn-time { padding: 8px;
border-radius: 12px; border: 2px solid var(--gris); cursor: pointer; font-weight: 800; font-size: 0.85rem; background: #f8f9fa; color: var(--azul-deep); flex: 1; transition: 0.3s;
}
.btn-time.active { background: var(--azul-deep); color: white; border-color: var(--azul-deep); }
/* ✅ Estilo mejorado para botón Obituario */
#btn-obituario {
padding: 6px 12px !important;
font-size: 0.75rem !important;
min-width: auto !important;
width: auto !important;
height: auto !important;
border-radius: 8px !important;
}
#btn-obituario.obit-active {
background: var(--azul-deep) !important;
color: white !important;
border-color: var(--azul-deep) !important;
}
.modern-input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--gris); font-size: 0.95rem;
outline: none; transition: 0.3s; background: #fdfdfd; font-weight: 500; }
.modern-input:focus { border-color: var(--turquesa); background: white; }
.pass-container { position: relative; width: 100%;
}
.eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem; opacity: 0.6; z-index: 10;
}
.photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
.upload-box { height: 90px; border: 2.5px dashed var(--celeste);
border-radius: 15px; position: relative; overflow: hidden; background: #f0f9ff; }
.upload-label { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;
cursor: pointer; font-size: 0.7rem; font-weight: 800; color: var(--turquesa); text-align: center; }
.preview { position: absolute; top: 0; left: 0; width: 100%;
height: 100%; object-fit: cover; display: none; }
.remove-btn { position: absolute; top: 5px; right: 5px; background: var(--rojo); color: white; border: none;
border-radius: 50%; width: 25px; height: 25px; font-weight: 800; cursor: pointer; display: none; z-index: 10; }
.btn-send { background: var(--azul-deep); color: white;
width: 100%; padding: 14px; border-radius: 18px; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 30px;
box-shadow: 0 6px 15px rgba(2, 48, 71, 0.3); transition: 0.3s; }
.btn-send:hover { transform: translateY(-2px); background: #054a6d; }
.modal-overlay { position: fixed;
top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.85); backdrop-filter: blur(8px); display: none; align-items: center;
justify-content: center; z-index: 20000; padding: 20px; }
.modal-content { background: white; padding: 40px 30px; border-radius: 30px; max-width: 450px; width: 100%;
text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative; }
/* MODAL CONFIRMACIÓN */
#confirmModal .modal-content { max-width: 600px; padding: 30px;
}
#previewContent { text-align: left; max-height: 400px; overflow-y: auto; margin-bottom: 20px; }
#previewContent p { margin: 8px 0; line-height: 1.4;
}
/* MODAL MANTENIMIENTO */
#maintOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--azul-deep); z-index: 10000;
display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
.modal-btn { background: var(--turquesa); color: white; border: none;
padding: 12px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 25px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
.modal-btn:hover { background: var(--azul-deep);
}
.modal-btn-alt { background: var(--gris); color: var(--azul-deep); margin-top: 10px; }
/* ✅ ESTILOS PARA MODAL DE BIENVENIDA */
.welcome-modal {
    background: var(--bg-surface);
    border-radius: 20px;
    padding: 0;
    overflow: hidden;
    position: relative;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    max-width: 500px;
    width: 90%;
}

.welcome-header {
    background: var(--header-bg);
    padding: 24px;
    text-align: center;
    position: relative;
}

.modal-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.modal-close-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1);
}

.sira-logo {
    position: relative;
    z-index: 1;
}

.sira-letters {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-bottom: 8px;
}

.letter {
    font-size: 36px;
    font-weight: 900;
    color: white;
    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    animation: bounceIn 0.8s ease-out forwards;
    opacity: 0;
}

.letter.s { animation-delay: 0.1s; }
.letter.i { animation-delay: 0.2s; }
.letter.r { animation-delay: 0.3s; }
.letter.a { animation-delay: 0.4s; }

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3) translateY(-50px);
    }
    50% {
        opacity: 1;
        transform: scale(1.1) translateY(0);
    }
    70% {
        transform: scale(0.9) translateY(-10px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.version-badge {
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 10px;
    font-weight: 600;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    animation: slideIn 1s ease-out 0.6s forwards;
    opacity: 0;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.welcome-body {
    padding: 24px;
}

.welcome-title {
    text-align: center;
    margin-bottom: 20px;
}

.animated-title {
    font-size: 24px;
    font-weight: 800;
    color: var(--text-primary);
    margin: 0 0 6px 0;
}

.subtitle {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
}

.datetime-display {
    background: var(--bg-surface);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    margin: 20px 0;
    display: flex;
    justify-content: space-around;
    gap: 12px;
}

.datetime-item {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    padding: 12px;
    background: var(--bg-surface);
    border-radius: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.datetime-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(7, 153, 182, 0.15);
    background: linear-gradient(135deg, var(--bg-surface), rgba(7, 153, 182, 0.05));
}

.datetime-item i {
    color: var(--color-bondi);
    font-size: 20px;
    width: 24px;
    text-align: center;
}

.datetime-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.datetime-label {
    font-size: 10px;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.datetime-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}

.welcome-slogan {
    background: var(--tab-active-gradient);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.welcome-slogan::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.slogan-text {
    position: relative;
    z-index: 1;
}

.slogan-main {
    display: block;
    font-size: 18px;
    font-weight: 800;
    color: white;
    margin-bottom: 6px;
}

.slogan-sub {
    display: block;
    font-size: 13px;
    color: rgba(255,255,255,0.9);
    font-weight: 500;
}

.welcome-message {
    text-align: center;
    margin: 20px 0;
}

.welcome-message p {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.6;
    margin: 0;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    padding: 20px 24px 24px;
    border-top: 1px solid var(--border-color);
}

.welcome-btn {
    background: var(--btn-bg);
    color: var(--btn-text);
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
    flex: 1;
    min-width: 140px;
    justify-content: center;
    text-align: center;
}

.welcome-btn:hover {
    background: var(--color-san-marino);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(7, 153, 182, 0.3);
}

.admin-btn {
    background: transparent;
    color: var(--text-secondary);
    border: 2px solid var(--border-color);
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 140px;
    justify-content: center;
    text-align: center;
}

.admin-btn:hover {
    background: var(--bg-surface);
    border-color: var(--color-bondi);
    color: var(--color-bondi);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(7, 153, 182, 0.2);
}

/* Welcome modal specific button overrides */
.welcome-modal .modal-btn-confirm {
    flex: 1;
    min-width: 140px;
    padding: 12px;
    font-size: 1rem;
    font-weight: 800;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.welcome-modal .modal-btn-confirm.welcome-btn {
    background: var(--btn-bg);
    color: var(--btn-text);
}

.welcome-modal .modal-btn-confirm.welcome-btn:hover {
    background: var(--color-san-marino);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(7, 153, 182, 0.3);
}

.welcome-modal .modal-btn-confirm.admin-btn {
    background: transparent;
    color: var(--text-secondary);
    border: 2px solid var(--border-color);
}

.welcome-modal .modal-btn-confirm.admin-btn:hover {
    background: var(--bg-surface);
    border-color: var(--color-bondi);
min-width: 140px;
padding: 12px;
font-size: 1rem;
font-weight: 800;
border-radius: 12px;
border: none;
cursor: pointer;
transition: all 0.3s ease;
}

.modal-btn-confirm {
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 8px;
    flex: 1;
    min-width: 140px;
    font-size: 0.95rem;
}

.modal-btn-confirm.corregir {
    background: var(--gris);
    color: var(--azul-deep);
}

.modal-btn-confirm.enviar {
    background: var(--turquesa);
    color: white;
}

.modal-btn-confirm:disabled {
    background: #e9ecef;
    color: #495057;
    cursor: not-allowed;
}

/* ✅ TABLA: DISEÑO LIMPIO Y ESPACIADO */
.table-container {
    width: 100%;
    overflow-x: auto;
    margin-top: 10px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
margin-top: 10px;
border-radius: 12px;
box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
table {
width: 100%;
border-collapse: separate; /* ✅ MEJOR QUE COLLAPSE PARA BORDES REDONDEADOS */
border-spacing: 0;
min-width: 1000px; /* ✅ MÁS ANCHO PARA EVITAR AMONTONAMIENTO */
background: white;
}
th {
background: #f1f5f9;
padding: 12px 15px; /* ✅ MÁS ESPACIO VERTICAL */
text-align: left;
font-size: 0.7rem;
text-transform: uppercase;
font-weight: 800;
color: var(--turquesa);
border-bottom: 2px solid var(--celeste);
white-space: nowrap; /* ✅ EVITA QUE LOS TÍTULOS SE ROMPAN */
}
td {
padding: 8px 15px; /* ✅ FILAS MÁS COMPACTAS PARA MEJOR VISIBILIDAD */
border-bottom: 1px solid #edf2f4;
font-size: 0.85rem;
line-height: 1.3;
color: #334155;
font-weight: 500;
vertical-align: middle;
}
td.admin-actions-cell {
    vertical-align: middle;
    padding: 8px 15px; /* Mismo padding reducido que las otras celdas */
    text-align: right;
    border-bottom: 1px solid #edf2f4; /* Asegura el borde */
}

.admin-actions-content {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
    align-items: center;
    white-space: nowrap;
    font-size: 0.75rem;
    color: #fb8500;
    font-weight: 700;
}

.admin-actions-content span:first-child {
    display: inline-block;
    line-height: 1;
    font-size: 1.3rem;
    vertical-align: middle;
}

.admin-actions-content span:last-child {
    display: inline-block;
    line-height: 1.2;
    vertical-align: middle;
}

/* ✅ PÍLDORA DE DISEÑADOR EN TABLA (ARRIBA DEL ESTATUS) */
.designer-pill {
    display: block;
    height: 4px;
    border-radius: 2px;
    margin-bottom: 4px;
    width: fit-content;
    min-width: 60px;
    padding: 0 10px;
    box-sizing: border-box;
}

/* ✅ STATUS PILL */
.status-pill {
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 0.6rem;
    font-weight: 800;
    text-transform: uppercase;
    transition: 0.3s;
    display: inline-block;
    vertical-align: middle;
}
.status-pendiente { background: var(--celeste); color: var(--azul-deep); }
.status-procesando { background: var(--amarillo); color: var(--azul-deep); }
.status-finalizada { background: var(--verde); color: white; }

/* ✅ UTILIDADES DE TEXTO */
.txt-bold { font-weight: 800; color: var(--azul-deep); }
.txt-small { font-size: 0.72rem; color: #4b4b4b; display: block; margin-bottom: 1px; font-weight: 500; }

.btn-act { border: none; border-radius: 5px; padding: 4px 6px;
cursor: pointer; font-size: 9px; color: white; font-weight: 800; transition: 0.2s; }
.btn-act:hover { transform: scale(1.1); }
.bg-pend { background: var(--celeste); color: var(--azul-deep);
}
.bg-proc { background: var(--amarillo); color: var(--azul-deep); }
.bg-fin { background: var(--verde); }
.btn-trash { background: none; border: none; cursor: pointer; font-size: 1.1rem;
margin-left: 8px; filter: grayscale(1); transition: 0.3s; }
.btn-trash:hover { filter: grayscale(0); transform: rotate(10deg);
}
/* Nuevos Estilos Botones Admin */
/* ✅ BOTÓN ADJUNTAR CORREGIDO: Icono + texto compacto */
.btn-arte {
background: #4a90e2;
color: white;
border: none;
border-radius: 5px;
padding: 3px 6px;
font-size: 9px;
font-weight: 800;
cursor: pointer;
white-space: nowrap;
min-width: auto;
width: auto;
}
.btn-ver { background: #f39c12; color: white; border: none; border-radius: 5px; padding: 4px 6px; font-size: 9px;
font-weight: 800; cursor: pointer; text-decoration: none; }
.btn-tg { background: #0088cc; color: white; border: none; border-radius: 5px; padding: 4px 6px;
font-size: 9px; font-weight: 800; cursor: pointer; }
.hidden { display: none !important; }
.page { display: none; }
.page.active { display: block;
}
#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.95); display: none;
flex-direction: column; align-items: center; justify-content: center; z-index: 30000; color: white; text-align: center; padding: 20px; }
.spinner { width: 60px; height: 60px;
border: 6px solid rgba(255,255,255,0.1); border-top: 6px solid var(--amarillo); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 25px;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
/* ✅ Estilo para campos deshabilitados en modo obituario */
.obit-disabled {
background-color: #e9ecef !important;
color: #6c757d !important;
cursor: not-allowed !important;
}
.obit-upload-box {
background: #e9ecef !important;
border-color: #ced4da !important;
cursor: not-allowed !important;
}
.obit-upload-label {
color: #6c757d !important;
cursor: not-allowed !important;
}
/* ✅ ESTILOS PARA BOTÓN DE REPORTE MENSUAL - SOLO HABILITADO 1° DE MES */
#reportBtn {
position: relative;
overflow: hidden;
display: flex;
align-items: center;
gap: 6px;
white-space: nowrap;
}
#reportBtn:disabled {
opacity: 0.65;
cursor: not-allowed !important;
transform: none !important;
box-shadow: 0 3px 0 #1a3d2d !important;
}
#reportBtn:not(:disabled):hover {
transform: translateY(-2px);
box-shadow: 0 5px 0 #1a3d2d;
}
#reportBtn:not(:disabled):active {
transform: translateY(1px);
box-shadow: 0 2px 0 #1a3d2d;
}
#reportBtnText {
display: inline;
transition: opacity 0.3s;
}
.report-days-badge {
font-size: 0.6rem;
background: rgba(255,255,255,0.2);
padding: 2px 6px;
border-radius: 10px;
font-weight: 600;
display: none;
}
.report-days-badge.show {
display: inline-block;
}
/* ✅ MEJORAS RESPONSIVE PARA MÓVIL */
@media (max-width: 768px) {
/* Header reorganizado para móvil */
header {
flex-direction: column;
align-items: center;
padding: 10px 15px;
min-height: auto;
gap: 8px;
}
.brand-container {
width: 100%;
align-items: center;
margin-bottom: 0;
}
.header-title {
font-size: 1.4rem;
text-align: center;
}
.acronimo {
font-size: 0.6rem;
text-align: center;
max-width: 100%;
}
.nav-tabs {
width: 100%;
justify-content: center;
flex-wrap: wrap;
gap: 6px;
margin: 8px 0 0 0;
}
.tab-btn {
padding: 5px 12px;
font-size: 0.7rem;
min-width: 100px;
}
.admin-access {
width: 100%;
align-items: center;
justify-content: center;
flex-wrap: wrap;
gap: 6px;
margin-top: 5px;
}
.welcome-message {
font-size: 0.85rem;
padding: 5px 10px;
}
.admin-buttons {
justify-content: center;
width: 100%;
flex-wrap: wrap;
}
.btn-login, .btn-logout {
padding: 5px 8px;
font-size: 0.6rem;
min-width: auto;
}
/* Contenedores de stats en columnas */
.stats-grid {
flex-direction: column;
gap: 8px;
}
.stat-card {
min-width: 100%;
padding: 10px;
}
/* Tabla más compacta */
th, td {
padding: 4px 6px;
font-size: 0.75rem;
}
.status-pill {
padding: 2px 8px;
font-size: 0.55rem;
}
.txt-small {
font-size: 0.65rem;
}
.admin-actions {
flex-direction: column;
align-items: flex-end;
gap: 4px;
}
.btn-act, .btn-arte, .btn-ver, .btn-tg, .btn-trash {
width: 100%;
justify-content: center;
font-size: 0.75rem;
padding: 3px;
}
/* Formulario más compacto */
.section-title {
font-size: 0.8rem;
margin: 15px 0 10px;
}
.modern-input {
padding: 10px;
font-size: 0.85rem;
}
.card-btn {
min-height: 40px;
font-size: 0.7rem;
padding: 4px 2px;
}
.btn-send {
padding: 12px;
font-size: 1rem;
}
/* Modales más compactos */
.modal-content {
padding: 25px 20px;
margin: 10px;
position: relative;
overflow: hidden;
background: white;
border-radius: 30px;
max-width: 450px;
width: 100%;
text-align: center;
box-shadow: 0 25px 50px rgba(0,0,0,0.3);
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, transparent, rgba(7, 153, 182, 0.8), transparent);
    animation: modalShimmer 3s ease-in-out infinite;
    z-index: 10;
    border-radius: 30px 30px 0 0;
}

@keyframes modalShimmer {
    0% { left: -100%; }
    50% { left: 100%; }
    100% { left: -100%; }
}
.modal-btn {
padding: 10px;
font-size: 0.95rem;
}
}
/* ✅ ESTILOS PARA BUSCADOR DE ID - DISEÑADOR */
#designer-search-container {
transition: all 0.3s ease;
margin: 15px 0;
padding: 12px;
background: #fff3e0;
border-radius: 12px;
border: 2px solid #ffb703;
}
#designer-search-container.hidden {
display: none;
}
#searchIdInput {
transition: all 0.3s ease;
}
#searchIdInput:focus {
border-color: #fb8500;
box-shadow: 0 0 0 3px rgba(251, 133, 0, 0.2);
}
/* ✅ EFECTOS DE RESALTADO Y BLOQUEO */
.row-highlighted {
background-color: #fff3e0 !important;
border-left: 5px solid #fb8500 !important;
animation: highlightPulse 0.8s ease;
}
.row-locked {
opacity: 0.3 !important;
pointer-events: none !important;
transition: opacity 0.4s ease, transform 0.4s ease;
}
.row-locked:hover {
cursor: not-allowed !important;
}
/* ✅ BOTONES DESHABILITADOS EN FILAS BLOQUEADAS */
.row-locked .btn-arte,
.row-locked .btn-ver,
.row-locked .btn-tg {
opacity: 0.4 !important;
cursor: not-allowed !important;
pointer-events: none !important;
}
/* ✅ ANIMACIÓN DE RESALTADO */
@keyframes highlightPulse {
0%, 100% {
box-shadow: 0 0 0 0 rgba(251, 133, 0, 0.4);
}
50% {
box-shadow: 0 0 0 10px rgba(251, 133, 0, 0);
}
}
/* ✅ ESTILO PARA INDICADOR DE BÚSQUEDA ACTIVA */
.search-active-indicator {
position: absolute;
top: -8px;
right: -8px;
background: #fb8500;
color: white;
width: 20px;
height: 20px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.7rem;
font-weight: 800;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
/* ✅ MENSAJE DE NO COINCIDENCIAS */
.no-results-message {
text-align: center;
padding: 20px;
color: #6c757d;
font-weight: 600;
font-size: 0.9rem;
background: #f8f9fa;
border-radius: 8px;
margin-top: 10px;
display: none;
}
.no-results-message.show {
display: block;
animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(-10px); }
to { opacity: 1; transform: translateY(0); }
}
/* ✅ BOTÓN DE LIMPIAR BÚSQUEDA */
.clear-search-btn {
background: #e9ecef;
border: none;
border-radius: 6px;
padding: 6px 12px;
font-weight: 600;
font-size: 0.8rem;
cursor: pointer;
transition: all 0.3s ease;
margin-left: 8px;
}
.clear-search-btn:hover {
background: #dee2e6;
transform: scale(1.05);
}
.clear-search-btn:active {
transform: scale(0.95);
}
/* ✅ ESTILO PARA CONTENEDOR DE BOTÓN DE LIMPIEZA */
.search-controls {
display: flex;
align-items: center;
gap: 8px;
margin-top: 8px;
}
/* ✅ INDICADOR DE FILTRO ACTIVO */
.filter-badge {
display: inline-block;
background: linear-gradient(135deg, #fb8500 0%, #ffb703 100%);
color: white;
padding: 4px 12px;
border-radius: 20px;
font-size: 0.75rem;
font-weight: 800;
margin-left: 10px;
animation: badgePulse 2s infinite;
}
@keyframes badgePulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

/* ✨ ANIMACIÓN DE PULSOS PARA BOTÓN DE ENVÍO */
.btn-send-pulse {
  animation: pulse 1.5s infinite;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 150, 255, 0.3) !important;
}

@keyframes pulse {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 150, 255, 0.4); }
  70% { transform: scale(1.05); box-shadow: 0 0 0 12px rgba(0, 150, 255, 0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 150, 255, 0); }
}

@keyframes iconPulse {
    0%, 100% {
        transform: scale(1) rotate(0deg);
    }
    50% {
        transform: scale(1.1) rotate(5deg);
    }
}

/* ✨ ESTILO PARA TEXTO EN DOS LÍNEAS */
.btn-text {
  display: flex;
  flex-direction: column;
  text-align: center;
  line-height: 1.2;
  margin: 0;
  padding: 0;
}

.btn-text span {
  display: block;
  margin: 0;
  padding: 0;
}

/* ✅ ESTILOS PARA CONTADORES COMBINADOS (ADMIN - TEXTO COMPLETO) */
.combined-stats {
  display: flex;
  justify-content: flex-start;
  gap: 6px;
  margin-bottom: 10px;
  flex-wrap: wrap;
  align-items: center;
}
.stat-mini {
  min-width: 95px; /* Ancho suficiente para texto completo */
  padding: 6px 10px;
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 0.78rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
}
.stat-mini:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}
.stat-mini .stat-label {
  font-size: 0.68rem;
  font-weight: 700;
  margin-bottom: 3px;
  text-transform: none;
  letter-spacing: -0.3px;
  line-height: 1.2;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-align: center;
}
.stat-mini .stat-val {
  font-size: 1.05rem;
  font-weight: 800;
  line-height: 1;
}
/* ✅ Mantener colores existentes */
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep); }
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }
.stat-bermina { background: var(--naranja); color: white; }
.stat-jorsy { background: var(--azul-deep); color: white; }
.stat-maria { background: var(--verde); color: white; }
.stat-xamir { background: var(--amarillo); color: var(--azul-deep); }

/* ✅ Responsive: Ajustar en pantallas pequeñas */
@media (max-width: 1024px) {
  .stat-mini { min-width: 85px; padding: 5px 8px; }
  .stat-mini .stat-label { font-size: 0.62rem; }
  .stat-mini .stat-val { font-size: 0.95rem; }
}
@media (max-width: 768px) {
  .combined-stats { gap: 4px; }
  .stat-mini { min-width: 75px; padding: 4px 6px; font-size: 0.72rem; }
  .stat-mini .stat-label { font-size: 0.58rem; line-height: 1.1; }
  .stat-mini .stat-val { font-size: 0.9rem; }
}

/* ✅ PANEL LATERAL DERECHO - VERSIÓN CORREGIDA Y RESPONSIVA */
.side-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: var(--panel-width); /* 380px desktop */
    height: 100%;              /* ✅ Cambiado de 100vh a 100% */
    max-height: 100dvh;        /* ✅ dvh = dynamic viewport height (móvil moderno) */
    background: var(--bg-surface);
    box-shadow: -8px 0 40px rgba(0,0,0,0.2);
    z-index: 1000;
    transform: translateX(100%); /* ✅ SIEMPRE desde la derecha, incluso en móvil */
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    border-left: 5px solid var(--turquesa);
    /* ✅ Prevenir scroll del body cuando panel está abierto */
    overscroll-behavior: contain;
}

.side-panel.active {
    transform: translateX(0); /* ✅ SIEMPRE translateX, nunca translateY */
}

/* ✅ HEADER DEL PANEL - Compacto en móvil */
.side-panel-header {
    background: var(--azul-deep);
    color: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 4px solid var(--amarillo);
    position: relative;
    flex-shrink: 0; /* ✅ No encoger */
}

.side-panel-title {
    font-weight: 800;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.side-panel-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}

/* ✅ CONTENIDO CON SCROLL MEJORADO */
.side-panel-content {
    flex: 1;
    overflow-y: auto;           /* ✅ Scroll vertical */
    overflow-x: hidden;         /* ✅ Prevenir scroll horizontal */
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    /* ✅ Scroll suave en iOS */
    -webkit-overflow-scrolling: touch;
    /* ✅ Prevenir que el contenido se "pegue" en los bordes */
    overscroll-behavior-y: contain;
}

/* Sección de solicitud seleccionada */
.selected-request-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 16px;
    padding: 18px;
    border: 2px solid var(--celeste);
    position: relative;
}

.selected-request-header {
    font-weight: 800;
    color: var(--azul-deep);
    font-size: 0.8rem;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.selected-request-id {
    font-size: 1.2rem;
    font-weight: 800;
    color: var(--turquesa);
    word-break: break-all;
    line-height: 1.3;
}

.selected-request-info {
    font-size: 0.8rem;
    color: #495057;
    margin-top: 10px;
    line-height: 1.5;
}

.no-selection {
    text-align: center;
    color: #adb5bd;
    padding: 25px 15px;
}

.no-selection-icon {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.6;
}

/* Vista previa de archivo - IMAGEN COMPLETA A ESCALA */
.file-preview-section {
    background: #f8f9fa;
    border-radius: 16px;
    padding: 18px;
    border: 2px dashed var(--celeste);
}

.file-preview-header {
    font-weight: 800;
    color: var(--azul-deep);
    font-size: 0.8rem;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
}

.file-preview-container {
    width: 100%;
    height: 200px;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--gris);
    position: relative;
}

.file-preview-image-full {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    cursor: pointer;
    transition: transform 0.3s;
}

.file-preview-image-full:hover {
    transform: scale(1.05);
}

.file-preview-placeholder {
    text-align: center;
    color: #adb5bd;
    font-size: 0.85rem;
    padding: 20px;
}

.file-preview-placeholder-icon {
    font-size: 2.5rem;
    margin-bottom: 8px;
    opacity: 0.5;
}

.file-preview-info {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 10px;
    text-align: center;
}

/* Botones del panel */
.panel-section-title {
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--turquesa);
    letter-spacing: 0.8px;
    margin-bottom: 10px;
    padding-left: 5px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.panel-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.panel-btn {
    width: 100%;
    padding: 12px 15px;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    text-align: left;
    position: relative;
}

.panel-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none !important;
}

.panel-btn:not(:disabled):hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.panel-btn-primary { background: var(--turquesa); color: white; }
.panel-btn-success { background: var(--verde); color: white; }
.panel-btn-warning { background: var(--amarillo); color: var(--azul-deep); }
.panel-btn-danger { background: var(--rojo); color: white; }
.panel-btn-info { background: var(--celeste); color: var(--azul-deep); }
.panel-btn-secondary { background: #e9ecef; color: var(--azul-deep); }

/* ✅ CORRECCIÓN: Colores correctos para botones de estatus en panel */
.panel-btn-pendiente { 
    background: var(--celeste); 
    color: var(--azul-deep); 
}
.panel-btn-procesando { 
    background: var(--amarillo); 
    color: var(--azul-deep); 
}
.panel-btn-finalizada { 
    background: var(--verde); 
    color: white; 
}

.btn-status-indicator {
    position: absolute;
    right: 12px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.4);
}

.btn-status-indicator.active {
    background: white;
    box-shadow: 0 0 8px rgba(255,255,255,0.6);
}

#indPend.active { background: var(--celeste) !important; box-shadow: 0 0 8px var(--celeste) !important; }
#indProc.active { background: var(--amarillo) !important; box-shadow: 0 0 8px var(--amarillo) !important; }
#indFin.active { background: var(--verde) !important; box-shadow: 0 0 8px var(--verde) !important; }

/* Asignación de diseñador */
.designer-assign-section {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border-radius: 16px;
    padding: 18px;
    border: 2px solid var(--naranja);
}

.designer-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 12px;
}

.designer-btn {
    padding: 12px 8px;
    border: 2px solid transparent;
    border-radius: 10px;
    font-weight: 700;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    background: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.designer-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.designer-btn.selected {
    border-color: var(--naranja);
    background: var(--amarillo);
    box-shadow: 0 0 0 3px rgba(251, 133, 0, 0.25), 0 4px 12px rgba(251, 133, 0, 0.3);
    transform: scale(1.02);
}

.designer-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

/* Footer del panel */
.panel-footer {
    padding: 20px;
    background: #f8f9fa;
    border-top: 3px solid var(--gris);
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-shrink: 0; /* ✅ No encoger, siempre visible */
}

/* Footer compacto */
.panel-footer.compact {
    padding: 15px;
}

.panel-footer-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}

.panel-btn.compact-btn {
    padding: 8px 10px;
    font-size: 0.75rem;
    min-height: 36px;
}

.panel-btn.compact-btn .btn-text {
    font-size: 0.7rem;
}

.panel-footer-divider {
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--celeste), transparent);
    margin: 5px 0;
}

/* Indicador visual de fila seleccionada en tabla */
.row-selected-panel {
    background-color: #fff8e1 !important;
    border-left: 5px solid var(--naranja) !important;
    box-shadow: inset 0 0 20px rgba(251, 133, 0, 0.1);
    position: relative;
}

.row-selected-panel::before {
    content: '▶';
    position: absolute;
    left: -3px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--naranja);
    font-size: 0.8rem;
}

/* Overlay para cerrar panel al hacer click fuera */
.panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    height: 100dvh; /* ✅ dvh para móvil */
    background: rgba(0,0,0,0.5); /* ✅ Más oscuro para mejor contraste */
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    backdrop-filter: blur(3px); /* ✅ Efecto de desenfoque */
    -webkit-backdrop-filter: blur(3px); /* ✅ Soporte Safari */
    /* ✅ Prevenir interacción con elementos debajo */
    touch-action: none;
}

.panel-overlay.active {
    opacity: 1;
    visibility: visible;
}

/* ============================================================
   ✅ MEDIA QUERIES CORREGIDAS PARA MÓVIL
   ============================================================ */

@media (max-width: 768px) {
    .side-panel {
        width: 100%;              /* ✅ Ancho completo en móvil */
        max-width: 100%;          /* ✅ Forzar ancho máximo */
        border-left: none;        /* ✅ Quitar borde lateral */
        border-top: 5px solid var(--turquesa); /* ✅ Borde superior indicador */
        /* ✅ MANTENER transform: translateX(100%) - NO cambiar a Y */
        top: auto;                /* ✅ Permitir posicionamiento desde abajo */
        bottom: 0;                /* ✅ Anclar abajo */
        height: 85%;              /* ✅ 85% de altura, no 100% */
        max-height: 85dvh;        /* ✅ dvh para móvil */
        border-radius: 20px 20px 0 0; /* ✅ Bordes redondeados arriba */
        box-shadow: 0 -8px 40px rgba(0,0,0,0.3); /* ✅ Sombra desde arriba */
    }
    
    /* ✅ La animación sigue siendo translateX pero desde abajo */
    .side-panel.active {
        transform: translateX(0);
    }
    
    /* ✅ Header más compacto */
    .side-panel-header {
        padding: 12px 16px;
        border-radius: 20px 20px 0 0; /* ✅ Heredar redondeo */
    }
    
    .side-panel-title {
        font-size: 1rem; /* ✅ Más pequeño */
    }
    
    /* ✅ Contenido más compacto */
    .side-panel-content {
        padding: 16px;
        gap: 12px; /* ✅ Menos espacio entre elementos */
    }
    
    /* ✅ Secciones más compactas */
    .selected-request-section,
    .file-preview-section,
    .designer-assign-section {
        padding: 14px;
        border-radius: 12px;
    }
    
    .file-preview-container {
        height: 150px; /* ✅ Más bajo en móvil */
    }
    
    /* ✅ Botones más grandes para touch (mínimo 44px) */
    .panel-btn {
        padding: 14px 16px; /* ✅ Área táctil mínima 44px */
        font-size: 0.9rem;
        min-height: 44px;
    }
    
    .designer-btn {
        padding: 14px 8px; /* ✅ Más alto para touch */
        min-height: 60px;
    }
    
    /* ✅ Grid de diseñadores 2x2 más espaciado */
    .designer-grid {
        gap: 12px;
    }
    
    /* ✅ Footer más compacto */
    .panel-footer {
        padding: 12px 16px;
        gap: 8px;
    }
    
    .panel-footer-row {
        gap: 10px;
    }
    
    .panel-btn.compact-btn {
        padding: 12px 10px;
        font-size: 0.8rem;
    }
}

/* ✅ PEQUEÑOS DISPOSITIVOS (menos de 380px) */
@media (max-width: 380px) {
    .side-panel {
        height: 90%; /* ✅ Más alto en pantallas muy pequeñas */
        max-height: 90dvh;
    }
    
    .side-panel-content {
        padding: 12px;
        gap: 10px;
    }
    
    /* ✅ Textos más pequeños */
    .selected-request-id {
        font-size: 1rem;
    }
    
    .selected-request-info {
        font-size: 0.75rem;
    }
    
    /* ✅ Botones de diseñador en columna si es necesario */
    .designer-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    
    .designer-btn {
        font-size: 0.75rem;
        padding: 10px 6px;
    }
    
    .designer-avatar {
        width: 32px;
        height: 32px;
        font-size: 1.1rem;
    }
}

/* Animación de entrada para secciones del panel */
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
from { opacity: 0; transform: translateX(20px); }
to { opacity: 1; transform: translateX(0); }
}

.side-panel-content > * {
animation: slideInRight 0.4s ease forwards;
}

.side-panel-content > *:nth-child(1) { animation-delay: 0.05s; }
.side-panel-content > *:nth-child(2) { animation-delay: 0.1s; }
.side-panel-content > *:nth-child(3) { animation-delay: 0.15s; }
.side-panel-content > *:nth-child(4) { animation-delay: 0.2s; }
.side-panel-content > *:nth-child(5) { animation-delay: 0.25s; }
.side-panel-content > *:nth-child(6) { animation-delay: 0.3s; }
}

/* Botón de reporte en panel - igual al del header */
.panel-btn.report-btn {
position: relative;
overflow: hidden;
background: linear-gradient(to right, #2d6a4f 0%, #1e4a35 0%);
box-shadow: 0 3px 0 #1e4a35;
width: 100%;
}

.panel-btn.report-btn:disabled {
opacity: 0.65;
cursor: not-allowed !important;
transform: none !important;
box-shadow: 0 3px 0 #1a3d2d !important;
}

.panel-btn.report-btn:not(:disabled):hover {
transform: translateY(-2px);
box-shadow: 0 5px 0 #1e4a35;
}

.panel-btn.report-btn:not(:disabled):active {
transform: translateY(1px);
box-shadow: 0 2px 0 #1e4a35;
}

/* Responsive ajustes */
@media (max-width: 768px) {
.panel-footer-row {
flex-direction: row;
}
.panel-btn.compact-btn {
font-size: 0.7rem;
padding: 6px 8px;
}
}

/* ✅ ESTILOS PARA PÁGINA DE ESTADÍSTICAS */
/* Estilos para gauges y medidores de cuota */
.quota-gauge-card {
background: white;
border-radius: 16px;
padding: 20px;
box-shadow: 0 4px 20px rgba(0,0,0,0.08);
border: 2px solid var(--gris);
transition: all 0.3s ease;
}

.quota-gauge-card:hover {
transform: translateY(-2px);
box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.quota-gauge-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.quota-gauge-title {
display: flex;
align-items: center;
gap: 10px;
font-weight: 800;
font-size: 1.1rem;
color: var(--azul-deep);
}

.quota-gauge-icon {
font-size: 1.5rem;
}

.quota-gauge-status {
padding: 6px 12px;
border-radius: 20px;
font-size: 0.75rem;
font-weight: 700;
text-transform: uppercase;
}

.quota-gauge-status.status-good {
background: #d4edda;
color: #155724;
}

.quota-gauge-status.status-warning {
background: #fff3cd;
color: #856404;
}

.quota-gauge-status.status-danger {
background: #f8d7da;
color: #721c24;
}

.quota-gauge-chart-container {
position: relative;
height: 200px;
display: flex;
align-items: center;
justify-content: center;
margin-bottom: 20px;
}

.quota-gauge-center-text {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
text-align: center;
}

.quota-gauge-percentage {
font-size: 2.5rem;
font-weight: 800;
color: var(--azul-deep);
line-height: 1;
}

.quota-gauge-label {
font-size: 0.9rem;
color: #666;
margin-top: 5px;
}

.quota-gauge-details {
display: flex;
justify-content: space-around;
gap: 20px;
}

.quota-detail-item {
text-align: center;
flex: 1;
}

.quota-detail-value {
font-size: 1.5rem;
font-weight: 800;
color: var(--turquesa);
line-height: 1;
}

.quota-detail-label {
font-size: 0.8rem;
color: #666;
margin-top: 5px;
}

/* Estilos para timeline y gráficos */
.quota-timeline-container {
background: white;
border-radius: 16px;
padding: 20px;
box-shadow: 0 4px 20px rgba(0,0,0,0.08);
border: 2px solid var(--gris);
transition: all 0.3s ease;
}

.quota-timeline-container:hover {
transform: translateY(-2px);
box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.quota-timeline-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.quota-timeline-title {
display: flex;
align-items: center;
gap: 10px;
font-weight: 800;
font-size: 1.1rem;
color: var(--azul-deep);
}

.quota-chart-container {
position: relative;
background: #f8f9fa;
border-radius: 12px;
padding: 15px;
border: 1px solid #e9ecef;
}

/* Estilos para botones de tiempo y actualización */
.quota-refresh-btn {
background: var(--turquesa);
color: white;
border: none;
padding: 8px 16px;
border-radius: 12px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 6px;
}

.quota-refresh-btn:hover {
background: var(--azul-deep);
transform: translateY(-1px);
}

.quota-refresh-btn:active {
transform: translateY(0);
}

/* Estilos para Tarjetas de Diseñadores (Formato Didáctico) */
.designer-performance-cards-container {
display: flex;
flex-direction: column;
gap: 10px;
width: 100%;
}

.designer-card {
background: white;
border-radius: 12px;
padding: 15px;
border: 2px solid #f1f5f9;
display: flex;
align-items: center;
gap: 12px;
transition: all 0.3s ease;
box-shadow: 0 2px 8px rgba(0,0,0,0.05);
justify-content: space-between; /* Distribuye el espacio entre los elementos */
}

.designer-card:hover {
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
border-color: var(--turquesa);
}

.designer-avatar {
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-weight: 800;
color: white;
font-size: 1.1rem;
flex-shrink: 0;
box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.designer-info {
flex: 1;
display: flex;
flex-direction: row; /* Cambiado a fila para distribuir horizontalmente */
align-items: center; /* Centrar verticalmente los elementos */
justify-content: space-between; /* Distribuir nombre y stats */
gap: 10px; /* Espacio entre nombre y stats */
}

.designer-name {
font-weight: 700;
color: var(--azul-deep);
font-size: 0.95rem;
white-space: nowrap; /* Evitar que el nombre se rompa en varias líneas */
overflow: hidden;
text-overflow: ellipsis; /* Añadir puntos suspensivos si el nombre es muy largo */
flex: 1; /* Permitir que el nombre ocupe el espacio disponible */
min-width: 0; /* Forzar el truncamiento si no hay espacio */
}

.designer-stats {
display: flex;
flex-direction: row; /* Asegurar que las estadísticas estén en fila */
align-items: center;
gap: 8px; /* Reducir el espacio entre el número y 'FINALIZADAS' */
}

.designer-stat-value {
font-weight: 800;
font-size: 1.1rem;
color: var(--turquesa);
white-space: nowrap;
}

.designer-stat-label {
font-size: 0.7rem;
color: #64748b;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
white-space: nowrap;
}

.designer-percentage {
background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
border-radius: 8px;
padding: 6px 12px;
font-weight: 800;
font-size: 0.9rem;
color: var(--azul-deep);
min-width: 60px;
text-align: center;
border: 1px solid #e2e8f0;
margin-left: 15px; /* Mantener el margen a la izquierda para separarlo */
flex-shrink: 0; /* Evitar que el porcentaje se encoja */
}

/* Estilos para contenedores de estadísticas detalladas */
.stats-detailed-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-top: 20px;
}

.stats-detail-card {
background: #f8f9fa;
border-radius: 12px;
padding: 15px;
border: 1px solid #e9ecef;
}

.stats-detail-title {
font-weight: 800;
font-size: 1rem;
margin-bottom: 15px;
display: flex;
align-items: center;
gap: 8px;
}

.stats-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 8px 0;
border-bottom: 1px solid #e9ecef;
}

.stats-item:last-child {
border-bottom: none;
}

.stats-item-label {
font-weight: 600;
color: #495057;
}

.stats-item-value {
font-weight: 800;
color: var(--azul-deep);
}

/* Responsive para estadísticas */
@media (max-width: 768px) {
.quota-gauge-card,
.quota-timeline-container {
padding: 15px;
margin-bottom: 15px;
}

.quota-gauge-chart-container {
height: 150px;
}

.quota-gauge-percentage {
font-size: 2rem;
}

.quota-gauge-details {
flex-direction: column;
gap: 15px;
}

.quota-detail-item {
text-align: center;
}

.stats-detailed-grid {
grid-template-columns: 1fr;
gap: 15px;
}
}
/* ✅ ESTILOS PARA PESTAÑA DE ESTADÍSTICAS */
.nav-tabs.tab-estadisticas::before {
transform: translateX(200%);
}

#stats-page .stat-card {
min-width: 120px;
}

#stats-page .quota-gauge-card {
margin-bottom: 20px;
}

#stats-page .quota-timeline-container {
margin-bottom: 20px;
}

/* Responsive para estadísticas */
@media (max-width: 768px) {
#stats-page .stats-grid {
flex-direction: column;
}
#stats-page .stat-card {
min-width: 100%;
}
}
/* ✅ NUEVO ESTILO PARA ESTADÍSTICAS DETALLADAS (TIPO DASHBOARD) */
.stats-dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-dashboard-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    border: 1px solid #edf2f4;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.stat-dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: var(--turquesa);
}

/* Barra de color superior */
.stat-dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
}

.stat-card-unidades::before { background: var(--turquesa); }
.stat-card-jornadas::before { background: var(--naranja); }
.stat-card-especialidades::before { background: var(--verde); }
.stat-card-servicios::before { background: var(--rojo); }

.stat-card-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    opacity: 0.8;
}

.stat-card-title {
    font-size: 0.85rem;
    color: #64748b;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 15px;
    letter-spacing: 0.5px;
}

.stat-card-list {
    width: 100%;
    list-style: none;
    padding: 0;
    margin: 0;
}

.stat-card-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.9rem;
}

.stat-card-item:last-child {
    border-bottom: none;
}

.stat-card-label {
    color: #334155;
    font-weight: 500;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 70%;
}

.stat-card-value {
    font-weight: 800;
    color: var(--azul-deep);
    background: #f1f5f9;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 0.85rem;
}

/* Colores específicos para valores */
.stat-card-unidades .stat-card-value { color: var(--turquesa); background: #e0f7fa; }
.stat-card-jornadas .stat-card-value { color: var(--naranja); background: #fff3e0; }
.stat-card-especialidades .stat-card-value { color: var(--verde); background: #e8f5e9; }
.stat-card-servicios .stat-card-value { color: var(--rojo); background: #ffebee; }

/* ✅ OCULTAR TABLA ANTIGUA DE DISEÑADORES */
#designerTableContainer {
    display: none !important;
}

/* ✅ CORRECCIÓN TABLA DE DISEÑADORES */
.designer-performance-table {
  width: 100%;
  table-layout: fixed; /* ✅ EVITA QUE LA TABLA SE SALGA DEL CONTENEDOR */
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 0.85rem;
  border-spacing: 0;
}
.designer-performance-table th, 
.designer-performance-table td {
  padding: 12px 10px;
  text-align: center;
  overflow: hidden; /* ✅ RECORTA TEXTO LARGO */
  white-space: nowrap; /* ✅ EVITA SALTOS DE LÍNEA */
  text-overflow: ellipsis; /* ✅ PONE ... SI EL TEXTO ES LARGO */
  vertical-align: middle;
  border-bottom: 1px solid #edf2f4;
}
/* Columna de nombre más ancha y alineada a la izquierda */
.designer-performance-table th:nth-child(1),
.designer-performance-table td:nth-child(1) {
  width: 45%;
  text-align: left;
  padding-left: 15px;
}
/* Columnas de números centradas con ancho fijo */
.designer-performance-table th:nth-child(2),
.designer-performance-table td:nth-child(2) {
  width: 25%;
  text-align: center;
}
.designer-performance-table th:nth-child(3),
.designer-performance-table td:nth-child(3) {
  width: 30%;
  text-align: center;
}
/* Quitar borde de la última fila */
.designer-performance-table tr:last-child td {
  border-bottom: none;
}

/* ✅ CORRECCIÓN RESPONSIVE PARA WELCOME MODAL */
@media (max-width: 768px) {
    .welcome-modal {
        width: 95% !important;
        margin: 10px !important;
        max-width: none !important;
    }
    
    .welcome-header {
        padding: 20px !important;
        text-align: center !important;
    }
    
    .sira-letters {
        justify-content: center !important;
        gap: 4px !important;
    }
    
    .letter {
        font-size: 30px !important;
    }
    
    .welcome-body {
        padding: 20px !important;
        text-align: center !important;
    }
    
    .welcome-title {
        text-align: center !important;
        margin-bottom: 20px !important;
    }
    
    .animated-title {
        font-size: 20px !important;
        line-height: 1.3 !important;
        text-align: center !important;
        padding: 0 10px !important;
    }
    
    .datetime-display {
        flex-direction: column !important;
        gap: 8px !important;
        align-items: center !important;
    }
    
    .datetime-item {
        width: 100% !important;
        justify-content: center !important;
        text-align: center !important;
    }
    
    .welcome-slogan {
        text-align: center !important;
        padding: 16px !important;
    }
    
    .welcome-btn {
        font-size: 13px !important;
        padding: 10px !important;
        min-width: 120px !important;
        justify-content: center !important;
        text-align: center !important;
    }
    
    .welcome-btn span {
        display: inline !important;
    }
}

@media (max-width: 480px) {
    .welcome-modal {
        width: 98% !important;
        margin: 5px !important;
        max-width: none !important;
    }
    
    .welcome-header {
        padding: 16px !important;
        text-align: center !important;
    }
    
    .sira-letters {
        justify-content: center !important;
        gap: 2px !important;
    }
    
    .letter {
        font-size: 24px !important;
    }
    
    .welcome-body {
        padding: 16px !important;
        text-align: center !important;
    }
    
    .welcome-title {
        text-align: center !important;
        margin-bottom: 16px !important;
    }
    
    .animated-title {
        font-size: 16px !important;
        line-height: 1.4 !important;
        text-align: center !important;
        padding: 0 5px !important;
        word-wrap: break-word !important;
    }
    
    .subtitle {
        text-align: center !important;
        font-size: 12px !important;
    }
    
    .datetime-display {
        flex-direction: column !important;
        gap: 6px !important;
        align-items: center !important;
    }
    
    .datetime-item {
        width: 100% !important;
        justify-content: center !important;
        text-align: center !important;
        padding: 8px !important;
    }
    
    .datetime-value {
        font-size: 14px !important;
    }
    
    .welcome-slogan {
        text-align: center !important;
        padding: 12px !important;
        margin: 16px 0 !important;
    }
    
    .slogan-main {
        font-size: 14px !important;
        line-height: 1.3 !important;
        text-align: center !important;
    }
    
    .slogan-sub {
        font-size: 11px !important;
        text-align: center !important;
    }
    
    .welcome-btn {
        font-size: 12px !important;
        padding: 8px !important;
        min-width: 100px !important;
        gap: 4px !important;
        justify-content: center !important;
        text-align: center !important;
    }
    
    .welcome-btn i {
        font-size: 14px !important;
    }
    
    .welcome-btn span {
        display: inline !important;
    }
}

/* ✅ ESTILOS PARA BOTÓN OBITUARIO */
.obituario-btn {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
    color: white !important;
    border-color: #0f3460 !important;
    position: relative;
    overflow: hidden;
}

.obituario-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    animation: none;
}

.obituario-btn.selected::before {
    animation: shimmer 3s infinite;
}

.obituario-btn.selected {
    background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%) !important;
    box-shadow: 0 0 20px rgba(15, 52, 96, 0.5) !important;
    border-color: #e94560 !important;
    transform: scale(0.98);
}

@keyframes shimmer {
    0% { left: -100%; }
    50% { left: 100%; }
    100% { left: -100%; }
}

/* Estilo para filas de obituario en la tabla */
.row-obituario {
    background-color: #000000 !important;
    color: white !important;
    border-left: 5px solid #ffffff !important;
}

.row-obituario td {
    color: white !important;
    font-weight: 500 !important;
}

.row-obituario *,
.row-obituario td *,
.row-obituario span,
.row-obituario div,
.row-obituario a,
.row-obituario button,
.row-obituario .status-badge,
.row-obituario .priority-badge {
    color: white !important;
}

.row-obituario a:hover {
    color: #cccccc !important;
}

.row-obituario .badge-prioridad {
    background: white !important;
    color: black !important;
    border: 1px solid white !important;
}

.row-obituario .status-badge {
    color: white !important;
}

.badge-prioridad {
    background: white;
    color: black;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 800;
    margin-left: 8px;
    display: inline-block;
    border: 1px solid white;
    animation: blink 2s infinite;
}

</style>
</head>
<body>
<div id="maintOverlay">
<span style="font-size: 80px;">🛠️</span>
<h1 style="font-weight: 800; font-size: 2.5rem; margin: 20px 0;">SISTEMA EN MANTENIMIENTO</h1>
<p style="font-size: 1.2rem; max-width: 500px; opacity: 0.9;">Estamos trabajando para mejorar tu experiencia.
Disculpen las molestias ocasionadas.</p>
<button class="btn-login" style="margin-top: 30px; padding: 12px 25px; font-size: 1rem;"
onclick="showLogin()">🔓 ACCESO ADMINISTRADOR</button>
</div>
<div id="loadingOverlay">
<div class="spinner"></div>
<div class="loading-text" id="loadMainTxt">Procesando...</div>
<div class="loading-subtext" id="loadSubTxt"></div>
</div>

<!-- ✅ OVERLAY PARA CERRAR PANEL AL HACER CLICK FUERA -->
<div id="panelOverlay" class="panel-overlay" onclick="closeSidePanel()"></div>

<!-- ✅ PANEL LATERAL DERECHO -->
<div id="sidePanel" class="side-panel">
<div class="side-panel-header">
<div class="side-panel-title">
<span id="panelRoleIcon">⚙️</span>
<span id="panelRoleText">Panel de Control</span>
</div>
<button class="side-panel-close" onclick="closeSidePanel()" title="Cerrar panel">×</button>
</div>

<div class="side-panel-content">
<!-- Selección de Solicitud -->
<div class="selected-request-section">
<div class="selected-request-header">📋 Solicitud Seleccionada</div>
<div id="selectedRequestContent">
<div class="no-selection">
<div class="no-selection-icon">📭</div>
<div>Selecciona una solicitud<br>de la tabla para activar<br>las acciones</div>
</div>
</div>
</div>

<!-- Vista Previa de Archivo - IMAGEN COMPLETA A ESCALA -->
<div class="file-preview-section">
<div class="file-preview-header">🎨 Archivo Adjunto</div>
<div class="file-preview-container" id="filePreviewContainer">
<div class="file-preview-placeholder">
<div class="file-preview-placeholder-icon">📎</div>
<div>No hay archivo adjunto</div>
</div>
</div>
<div class="file-preview-info" id="filePreviewInfo"></div>
</div>

<!-- Acciones de Estado -->
<div class="panel-actions" id="statusActions">
<div class="panel-section-title">🔄 Cambiar Estado</div>
<button class="panel-btn panel-btn-pendiente" id="btnStatusPend" onclick="changeStatus('PENDIENTE')" disabled>
⏳ Pendiente
<span class="btn-status-indicator" id="indPend"></span>
</button>
<button class="panel-btn panel-btn-procesando" id="btnStatusProc" onclick="changeStatus('PROCESANDO')" disabled>
⚙️ Procesando
<span class="btn-status-indicator" id="indProc"></span>
</button>
<button class="panel-btn panel-btn-finalizada" id="btnStatusFin" onclick="changeStatus('FINALIZADA')" disabled>
✅ Finalizada
<span class="btn-status-indicator" id="indFin"></span>
</button>
</div>

<!-- Asignación de Diseñador (Solo Admin) -->
<div class="designer-assign-section hidden" id="designerAssignSection">
<div class="panel-section-title">👨‍🎨 Asignar Diseñador</div>
<!-- ✅ ACTUALIZAR designer-grid EN EL PANEL LATERAL -->
<div class="designer-grid" id="designerGrid">
<button class="designer-btn" onclick="assignDesigner('Bermina')" disabled>
<span class="designer-avatar" style="background: #fb8500;">👩</span>
<span>Bermina</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Jorsy')" disabled>
<span class="designer-avatar" style="background: #023047; color: white;">👨</span>
<span>Jorsy</span>
</button>
<button class="designer-btn" onclick="assignDesigner('María F.')" disabled>
<span class="designer-avatar" style="background: #2d6a4f;">👩</span>
<span>María F.</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Xamir')" disabled>
<span class="designer-avatar" style="background: #ffb703;">👨</span>
<span>Xamir</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Fulan@')" disabled>
<span class="designer-avatar" style="background: #9d0208; color: white;">👤</span>
<span>Fulan@</span>
</button>
</div>
</div>

<!-- Acciones de Archivo -->
<div class="panel-actions" id="fileActions">
<div class="panel-section-title">📁 Acciones de Archivo</div>
<button class="panel-btn panel-btn-info" id="btnAdjuntar" onclick="panelAdjuntarArte()" disabled>
📤 Adjuntar Arte
</button>
<button class="panel-btn panel-btn-secondary" id="btnVerArte" onclick="panelVerArte()" disabled>
👁️ Ver Arte
</button>
<button class="panel-btn panel-btn-primary" id="btnEnviarTG" onclick="panelEnviarTelegram()" disabled>
✈️ Enviar a Telegram
</button>
</div>

<!-- Acciones Especiales (Solo Admin) -->
<div class="panel-actions hidden" id="adminActions">
<div class="panel-section-title">⚠️ Acciones Especiales</div>
<button class="panel-btn panel-btn-danger" id="btnEliminar" onclick="panelEliminar()" disabled>
🗑️ Eliminar Solicitud
</button>
</div>
</div>

<!-- Footer con botones siempre visibles -->
<div class="panel-footer compact">
<div class="panel-footer-divider"></div>
<div class="panel-section-title" style="font-size: 0.65rem; margin-bottom: 8px;">🔐 Sistema</div>
<div class="panel-footer-row">
<button class="panel-btn panel-btn-secondary compact-btn" id="btnMaint" onclick="toggleMaintMode()">
🛠️ Mantenimiento
</button>
<button class="panel-btn panel-btn-danger compact-btn" onclick="logout()">
🚪 Cerrar Sesión
</button>
</div>
<button class="panel-btn panel-btn-success compact-btn report-btn" id="btnReportPanel" onclick="generateMonthlyReport()" disabled>
<span id="reportBtnTextPanel">📊 Reporte</span>
<span id="reportBtnDaysPanel" class="report-days-badge"></span>
</button>
</div>
</div>

<div class="modal-overlay" id="modalAlert">
<div class="modal-content">
<span id="modalIcon" style="font-size: 60px; display: block; margin-bottom: 10px;">⚠️</span>
<div id="modalTitle" style="font-weight: 800; font-size: 1.4rem; color: var(--azul-deep);">Atención</div>
<div id="modalMsg" style="margin-top: 15px; color: #555; font-size: 1rem; line-height: 1.4; font-weight: 500;"></div>
<div id="loginArea" class="hidden" style="margin-top:20px; text-align: left;">
<label class="txt-small">Usuario del Sistema:</label>
<input type="text" id="adminUser" class="modern-input" style="margin-bottom:15px;"
placeholder="Ingrese usuario">
<label class="txt-small">Clave de Seguridad:</label>
<div class="pass-container">
<input type="password" id="adminPass" class="modern-input" placeholder="••••••••">
<span class="eye-icon" onclick="togglePass()">👁️</span>
</div>
</div>
<!-- ✅ BARRA DE PROGRESO PARA LOGIN -->
<div id="loginProgressBar" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 2px solid var(--celeste);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span id="loginProgressText" style="font-weight: 700; color: var(--azul-deep); font-size: 0.9rem;">Verificando credenciales...</span>
        <span id="loginProgressPercent" style="font-weight: 800; color: var(--turquesa); font-size: 1rem;">0%</span>
    </div>
    <div style="background: #e9ecef; border-radius: 20px; height: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
        <div id="loginProgressBarInner" style="background: linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%); height: 100%; width: 0%; transition: width 0.4s ease; border-radius: 20px; box-shadow: 0 2px 8px rgba(33, 158, 188, 0.3);"></div>
    </div>
    <div id="loginProgressStatus" style="margin-top: 8px; font-size: 0.8rem; color: #6c757d; text-align: center; font-weight: 500;">Conectando con el servidor...</div>
</div>
<div id="uploadArea" class="hidden" style="margin-top:20px;">
<input type="file" id="arteFile" class="modern-input" accept=".jpg,.jpeg,.png,.pdf,.zip" style="font-size: 0.8rem;">
<p style="font-size: 0.7rem; color: #666; margin-top: 5px;">Máximo 5MB (Formatos: JPG, PNG, PDF, ZIP)</p>
<input type="hidden" id="currentReqId">
</div>
<button id="mainModalBtn" class="modal-btn">ENTENDIDO</button>
<button id="closeModalBtn" class="modal-btn modal-btn-alt hidden" onclick="closeModal()">CERRAR</button>
</div>
</div>
<div class="modal-overlay" id="confirmModal">
<div class="modal-content">
<h2 style="font-weight: 800; color: var(--azul-deep); margin-top: 0;">🔍 Revisa tu Solicitud</h2>
<div id="previewContent"></div>
<div style="display: flex; gap: 12px; justify-content: center; width: 100%; max-width: 500px; margin: 0 auto; margin-top: 20px;">
<button id="btnCorregir" class="modal-btn-confirm corregir">✏️ Corregir</button>
<button id="btnEnviarConfirmado" class="modal-btn-confirm enviar" disabled>🚀 Enviar Solicitud (<span id="countdown">10</span>)</button>
</div>
</div>
</div>
<!-- ✅ MODAL PARA SELECCIONAR DISEÑADOR - ELIMINADO (AHORA EN PANEL) -->
<!-- ✅ MODAL PARA MENSAJE DE ID NO ENCONTRADO -->
<div class="modal-overlay" id="idNotFoundModal" style="display: none;">
<div class="modal-content" style="max-width: 450px; padding: 25px;">
<span style="font-size: 50px; display: block; margin-bottom: 15px; color: #fb8500;">🔍</span>
<h2 style="font-weight: 800; color: var(--azul-deep); margin: 0 0 15px 0;">ID no encontrado</h2>
<p style="font-size: 1rem; line-height: 1.5; color: #495057; margin-bottom: 20px;">
No se encontró ninguna solicitud con el ID: <strong id="notFoundId"></strong>
</p>
<p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 25px;">
Verifica que el ID sea correcto o limpia la búsqueda para ver todas las solicitudes
</p>
<div style="display: flex; justify-content: center; gap: 15px;">
<button class="modal-btn" style="background: var(--gris); color: var(--azul-deep);" onclick="closeIdNotFoundModal()">CERRAR</button>
<button class="modal-btn" style="background: #fb8500; color: white;" onclick="clearSearch()">LIMPIAR BÚSQUEDA</button>
</div>
</div>
</div>
<body>
<!-- Welcome Modal -->
<div class="modal-overlay" id="welcomeModal">
    <div class="modal-content welcome-modal">
        <div class="welcome-header">
            <div class="sira-logo">
                <div class="sira-letters">
                    <span class="letter s">S</span>
                    <span class="letter i">I</span>
                    <span class="letter r">R</span>
                    <span class="letter a">A</span>
                </div>
                <div class="version-badge">3.0 REBORN</div>
            </div>
            <button class="modal-close-btn" id="btnCloseWelcome">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="welcome-body">
            <div class="welcome-title">
                <h2 class="animated-title">¡Bienvenidos al Sistema Interactivo de Requerimientos para Artes!</h2>
            </div>
            
            <div class="datetime-display">
                <div class="datetime-item">
                    <i class="fas fa-calendar-day"></i>
                    <div class="datetime-info">
                        <span class="datetime-label">Fecha</span>
                        <span id="welcomeDate" class="datetime-value"></span>
                    </div>
                </div>
                <div class="datetime-item">
                    <i class="fas fa-clock"></i>
                    <div class="datetime-info">
                        <span class="datetime-label">Hora</span>
                        <span id="welcomeTime" class="datetime-value"></span>
                    </div>
                </div>
            </div>
            
            <div class="welcome-slogan">
                <div class="slogan-text">
                    <span class="slogan-main">Solicita, Visualiza e Impacta</span>
                    <span class="slogan-sub">El poder de la creatividad a tu alcance</span>
                </div>
            </div>
            
            <div class="welcome-message">
                <p>Estamos listos para ayudarte con tu solicitud. Nuestro sistema ha sido optimizado para ofrecerte la mejor experiencia.</p>
            </div>
        </div>
        
        <div class="modal-actions">
            <button id="btnWelcomeStart" class="modal-btn-confirm enviar welcome-btn">
                <i class="fas fa-rocket"></i>
                <span>Comenzar Solicitud</span>
            </button>
            <button id="btnAdminLogin" class="modal-btn-confirm admin-btn">
                <i class="fas fa-user-shield"></i>
                <span>Administrador</span>
            </button>
        </div>
    </div>
</div>

<header>
<div class="brand-container">
<h1 class="header-title">SIRA 3.0 Reborn</h1>
<span class="acronimo">Sistema Integral de Requerimientos de Artes</span>
</div>
<div class="nav-tabs">
<button id="tab-form" class="tab-btn active" onclick="showPage('form-page', this)">📝 FORMULARIO</button>
<button id="tab-list" class="tab-btn" onclick="showPage('list-page', this)">📋 SOLICITUDES</button>
<button id="tab-stats" class="tab-btn hidden" onclick="showPage('stats-page', this)">📊 ESTADÍSTICAS</button>
</div>
<div class="admin-access">
<!-- ✅ MENSAJE DE BIENVENIDA - MÁS LLAMATIVO -->
<div id="welcomeMessage" class="welcome-message">¡Hola, <span id="userNameDisplay"></span>!</div>
<!-- Solo botón de login/logout -->
<button id="authBtn" class="btn-login" onclick="showLogin()">🔐 Administrador</button>
</div>
</header>
<div class="container page active" id="form-page">
<div class="aviso-48h">⚠️ IMPORTANTE: LAS SOLICITUDES DEBEN REALIZARSE CON 48 HORAS DE ANTICIPACIÓN</div>
<form id="sigrafForm" novalidate>
<!-- ... -->
<label class="section-title">🏥 1. REGIÓN *</label>
<div class="category-row" id="region-grid"></div>
<div id="unidad-section" class="hidden">
<label class="section-title">🏥 1.5. UNIDAD MÉDICA *</label>
<div class="category-row" id="unidad-grid"></div>
</div>
<label class="section-title">📂 2. TIPO DE SOLICITUD *</label>
<div class="category-row" id="cat-grid">
<div class="card-btn" onclick="selectCat(this, 'escuela')">Ipasme va a la Escuela</div>
<div class="card-btn" onclick="selectCat(this, 'integral')">Jornada de Atención Médica Integral</div>
<div class="card-btn" onclick="selectCat(this, 'conjunta')">Jornada Conjunta</div>
<div class="card-btn" onclick="selectCat(this, 'vacuna')">Plan Masivo de Vacunación</div>
<div class="card-btn" onclick="selectCat(this, 'quirurgica')">Captación Quirúrgica</div>
<div class="card-btn" onclick="selectCat(this, 'pediatrica')">Captación Quirúrgica Pediátrica</div>
<div class="card-btn" onclick="selectCat(this, 'oftalmo')">Captación Quirúrgica Oftalmológica</div>
<!-- ✅ NUEVO: Botón Obituario independiente -->
<div class="card-btn obituario-btn" onclick="selectCat(this, 'obituario')" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; border-color: #0f3460;">
    <span style="font-size: 1.2rem;">🕊️</span> Obituario
</div>
<div class="card-btn" onclick="selectCat(this, 'otros')">Otros</div>
</div>
<div id="sec-3" class="hidden">
<label class="section-title" id="label-3">🩺 3. DETALLE *</label>
<div id="cont-3" style="display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;"></div>
</div>
<div id="sec-4" class="hidden">
<label class="section-title">✨ 4. SERVICIOS ADICIONALES (OPCIONAL)</label>
<div id="cont-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 6px;"></div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="section-title">📅 5. FECHA DE ACTIVIDAD *</label><input type="date" id="fecha" class="modern-input"></div>
<div><label class="section-title">⏰ 6. HORA DE INICIO *</label><div class="hora-container" id="hora-box" style="display: flex;
gap: 10px; align-items: center;"><input type="text" id="hora" class="modern-input" style="width:100px; text-align:center" placeholder="08:00"><button type="button" class="btn-time" id="btn-am" onclick="setAMPM('a. m.')">a. m.</button><button type="button" class="btn-time" id="btn-pm" onclick="setAMPM('p. m.')">p. m.</button></div></div>
</div>
<label class="section-title">📍 7. UBICACIÓN *</label>
<div style="background: #fff8e1;
border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600;
line-height: 1.4;">
⚠️ Complete al menos el nombre de la institución. La dirección exacta es opcional pero recomendada.
</div>
<div style="display: grid;
grid-template-columns: 1fr 1fr; gap: 20px;">
<div>
<label class="txt-small">🏫 Institución *</label>
<input type="text" id="institucion" class="modern-input" placeholder="Escuela, Liceo, Jardín de niños, etc.">
</div>
<div>
<label class="txt-small">🧭 Dirección exacta</label>
<input type="text" id="direccion-exacta" class="modern-input" placeholder="Municipio, Parroquia, Ciudad, etc.">
</div>
</div>
<label class="section-title">📱✉️ 8. DATOS DE CONTACTO</label>
<div style="display: grid;
grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="txt-small">Número de Teléfono</label><input type="tel" id="tlf" class="modern-input" placeholder="04xx 1234567"></div>
<div><label class="txt-small">Correo Electrónico *</label><input type="email" id="mail" class="modern-input" placeholder="Para envío de arte final"></div>
</div>
<label class="section-title">✏️ 9. OBSERVACIONES / DETALLES DE DISEÑO</label><textarea id="observaciones" class="modern-input" rows="3" placeholder="Indique medidas, colores institucionales o entes participantes adicionales..."></textarea>
<label class="section-title">📸 10. SOPORTES FOTOGRÁFICOS (MÁX 3)</label>
<div style="background: #fff8e1;
border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600;
line-height: 1.4;">
⚠️ Si el registro fotográfico enviado no cumple con las condiciones de calidad para la solicitud, será sustituido por material de archivo.
</div>
<div class="photo-grid">
<div class="upload-box"><label for="f1" class="upload-label">✚ SUBIR FOTO</label><input type="file" id="f1" class="hidden" accept="image/*" onchange="handleFile(this, 'p1', 'b1')"><img id="p1" class="preview"><button type="button" id="b1" class="remove-btn" onclick="clearFile('f1', 'p1', 'b1')">×</button></div>
<div class="upload-box"><label for="f2" class="upload-label">✚ SUBIR FOTO</label><input type="file" id="f2" class="hidden" accept="image/*" onchange="handleFile(this, 'p2', 'b2')"><img id="p2" class="preview"><button type="button" id="b2" class="remove-btn" onclick="clearFile('f2', 'p2', 'b2')">×</button></div>
<div class="upload-box"><label for="f3" class="upload-label">✚ SUBIR FOTO</label><input type="file" id="f3" class="hidden" accept="image/*" onchange="handleFile(this, 'p3', 'b3')"><img id="p3" class="preview"><button type="button" id="b3" class="remove-btn" onclick="clearFile('f3', 'p3', 'b3')">×</button></div>
</div>
<button type="submit" id="submitBtn" class="btn-send">🚀 ENVIAR SOLICITUD A COMUNICACIONES</button>
</form>
</div>
<div class="container page" id="list-page">
<!-- ✅ CONTADORES COMBINADOS PARA ADMIN (ELIMINAR CONTADORES DE DISEÑADORES) -->
<div class="combined-stats" id="combined-stats" style="display:none; margin-bottom: 10px; gap: 6px;">
<!-- Contadores generales SOLAMENTE -->
<div class="stat-card stat-mini st-total">
<span class="stat-label">Total</span>
<span id="count-total-admin" class="stat-val">0</span>
</div>
<div class="stat-card stat-mini st-pend">
<span class="stat-label">Pendiente</span>
<span id="count-pend-admin" class="stat-val">0</span>
</div>
<div class="stat-card stat-mini st-proc">
<span class="stat-label">En Proceso</span>
<span id="count-proc-admin" class="stat-val">0</span>
</div>
<div class="stat-card stat-mini st-fin">
<span class="stat-label">Finalizada</span>
<span id="count-fin-admin" class="stat-val">0</span>
</div>
</div>

<!-- ✅ CONTADORES PARA USUARIOS REGULARES (SIN CAMBIOS) -->
<div class="stats-grid" id="stats-panel">
<div class="stat-card st-total"><span class="stat-label">Total</span><span id="count-total" class="stat-val">0</span></div>
<div class="stat-card st-pend"><span class="stat-label">Pendiente</span><span id="count-pend" class="stat-val">0</span></div>
<div class="stat-card st-proc"><span class="stat-label">En Proceso</span><span id="count-proc" class="stat-val">0</span></div>
<div class="stat-card st-fin"><span class="stat-label">Finalizada</span><span id="count-fin" class="stat-val">0</span></div>
</div>
<!-- ✅ BUSCADOR DE ID PARA DISEÑADOR -->
<div id="designer-search-container" class="hidden">
<div style="display: flex; align-items: center; gap: 10px;">
<span style="font-size: 1.2rem; color: #fb8500;">🔍</span>
<input 
type="text" 
id="searchIdInput" 
class="modern-input" 
placeholder="Buscar por ID de solicitud..."
style="background: white; border-color: #ffb703; font-weight: 600;"
>
</div>
<p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #5d4600; font-weight: 500;">
⚠️ Solo las solicitudes coincidentes estarán habilitadas para adjuntar archivos
</p>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>ID SOLICITUD</th>
<th>FECHA EVENTO</th>
<th>UNIDAD SOLICITANTE</th>
<th>TIPO SOLICITUD</th>
<th style="text-align:center">SOPORTES</th>
<th>ESTATUS</th>
<th id="th-admin" class="hidden" style="text-align:right">ACCIONES ADMIN</th>
<th id="th-designer" class="hidden" style="text-align:right">ACCIONES DISEÑADOR</th>
</tr>
</thead>
<tbody id="solicitudes-body"></tbody>
</table>
<!-- ✅ CONTROLES DE PAGINACIÓN -->
<div id="paginationControls" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 0 0 12px 12px; margin-top: -1px;">
  <div style="font-size: 0.85rem; color: #6c757d;">
    Mostrando <strong id="paginationStart">1</strong>-<strong id="paginationEnd">50</strong> de <strong id="paginationTotal">0</strong> registros
  </div>
  <div style="display: flex; gap: 8px;">
    <button onclick="changePage('first')" id="btnFirstPage" class="btn-act bg-pend" style="padding: 6px 12px;" disabled>⏮️ Primero</button>
    <button onclick="changePage('prev')" id="btnPrevPage" class="btn-act bg-pend" style="padding: 6px 12px;" disabled>◀️ Anterior</button>
    <span id="currentPageIndicator" style="padding: 6px 12px; background: var(--turquesa); color: white; border-radius: 6px; font-weight: 700; font-size: 0.85rem;">1 / 1</span>
    <button onclick="changePage('next')" id="btnNextPage" class="btn-act bg-proc" style="padding: 6px 12px;" disabled>Siguiente ▶️</button>
    <button onclick="changePage('last')" id="btnLastPage" class="btn-act bg-proc" style="padding: 6px 12px;" disabled>Último ⏭️</button>
  </div>
</div>
</div>
</div>

<!-- ✅ PÁGINA DE ESTADÍSTICAS (REESTRUCTURADA) -->
<div class="container page" id="stats-page">
    
    <!-- 1. CONTADORES GLOBALES FIJOS (ARRIBA DEL TODO) -->
    <div class="stats-grid" style="margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; border-radius: 20px; background: white;">
        <div class="stat-card st-total">
            <span class="stat-label">Total Solicitudes</span>
            <span id="stats-count-total" class="stat-val" style="font-size: 2rem;">0</span>
        </div>
        <div class="stat-card st-pend">
            <span class="stat-label">Pendientes</span>
            <span id="stats-count-pend" class="stat-val" style="font-size: 2rem;">0</span>
        </div>
        <div class="stat-card st-proc">
            <span class="stat-label">En Proceso</span>
            <span id="stats-count-proc" class="stat-val" style="font-size: 2rem;">0</span>
        </div>
        <div class="stat-card st-fin">
            <span class="stat-label">Finalizadas</span>
            <span id="stats-count-fin" class="stat-val" style="font-size: 2rem;">0</span>
        </div>
    </div>

    <!-- Selector de Período -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
        <div style="font-weight: 800; color: var(--azul-deep); margin-right: 10px;">📅 Período:</div>
        <button class="btn-time" onclick="loadStats('day')" id="btnStatsDay">Día</button>
        <button class="btn-time" onclick="loadStats('week')" id="btnStatsWeek">Semana</button>
        <button class="btn-time active" onclick="loadStats('month')" id="btnStatsMonth">Mes</button>
        <button class="quota-refresh-btn" onclick="refreshAllStats()" id="btnRefreshStats" style="margin-left: auto;">
            <span>🔄</span> Actualizar
        </button>
    </div>

    <!-- ✅ MEDIDORES DE VELOCIDAD (NUEVO) -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <!-- Velocidad de Internet -->
        <div class="quota-gauge-card">
            <div class="quota-gauge-header">
                <div class="quota-gauge-title">
                    <span>🌐</span>
                    <span>Velocidad de Internet</span>
                </div>
                <div class="quota-gauge-status status-good" data-stat="internet-status">EXCELENTE</div>
            </div>
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 3rem; font-weight: 800; color: var(--azul-deep);" 
                     data-stat="internet-speed-value">0</div>
                <div style="color: #666; font-size: 1rem;">Mbps</div>
            </div>
            <div class="quota-gauge-details">
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="internet-speed-avg">0</div>
                    <div class="quota-detail-label">Promedio</div>
                </div>
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="internet-speed-max">0</div>
                    <div class="quota-detail-label">Máximo</div>
                </div>
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="internet-speed-last">--:--</div>
                    <div class="quota-detail-label">Última Medición</div>
                </div>
            </div>
        </div>
        
        <!-- Velocidad de Subida (Chunks) -->
        <div class="quota-gauge-card">
            <div class="quota-gauge-header">
                <div class="quota-gauge-title">
                    <span>📤</span>
                    <span>Velocidad de Subida (Chunks)</span>
                </div>
                <div class="quota-gauge-status status-good" data-stat="upload-status">EXCELENTE</div>
            </div>
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 3rem; font-weight: 800; color: var(--azul-deep);" 
                     data-stat="upload-speed-value">0</div>
                <div style="color: #666; font-size: 1rem;">Mbps</div>
            </div>
            <div class="quota-gauge-details">
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="upload-speed-avg">0</div>
                    <div class="quota-detail-label">Promedio</div>
                </div>
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="upload-speed-tier">--</div>
                    <div class="quota-detail-label">Nivel</div>
                </div>
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="upload-speed-last">--:--</div>
                    <div class="quota-detail-label">Última Medición</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Principales (Fila 1) -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <!-- Solicitudes por Día -->
        <div class="quota-timeline-container">
            <div class="quota-timeline-header">
                <div class="quota-timeline-title"><span>📈</span> Solicitudes Recibidas</div>
            </div>
            <div class="quota-chart-container" style="height: 250px;">
                <canvas id="requestsChart"></canvas>
            </div>
        </div>
        <!-- Finalizadas vs Recibidas -->
        <div class="quota-timeline-container">
            <div class="quota-timeline-header">
                <div class="quota-timeline-title"><span>✅</span> Solicitudes Finalizadas</div>
            </div>
            <div class="quota-chart-container" style="height: 250px;">
                <canvas id="finalizedChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Rendimiento de Diseñadores (Gráfico Circular) -->
    <div class="quota-timeline-container" style="margin-bottom: 20px;">
        <div class="quota-timeline-header">
            <div class="quota-timeline-title"><span>🎨</span> Rendimiento de Diseñadores</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
            <div class="quota-chart-container" style="height: 300px;">
                <canvas id="designerPerformanceChart"></canvas>
            </div>
            <!-- Tarjetas de Diseñadores (Formato Didáctico) -->
            <div class="designer-performance-cards-container" id="designerPerformanceCards"></div>
        </div>
    </div>

    <!-- 2. ESTADÍSTICAS DETALLADAS (NUEVO DISEÑO DE TARJETAS) -->
    <div class="quota-timeline-container">
        <div class="quota-timeline-header">
            <div class="quota-timeline-title"><span>📋</span> Estadísticas Detalladas</div>
        </div>
        
        <!-- Grid de Tarjetas Estilo Dashboard -->
        <div class="stats-dashboard-grid">
            
            <!-- Tarjeta 1: Top Unidades -->
            <div class="stat-dashboard-card stat-card-unidades">
                <div class="stat-card-icon">🏥</div>
                <div class="stat-card-title">Top Unidades</div>
                <ul class="stat-card-list" id="topUnidadesStats">
                    <!-- Se llena con JS -->
                    <li class="stat-card-item"><span class="stat-card-label">Cargando...</span></li>
                </ul>
            </div>

            <!-- Tarjeta 2: Top Jornadas -->
            <div class="stat-dashboard-card stat-card-jornadas">
                <div class="stat-card-icon">📂</div>
                <div class="stat-card-title">Top Jornadas</div>
                <ul class="stat-card-list" id="topJornadasStats">
                    <!-- Se llena con JS -->
                    <li class="stat-card-item"><span class="stat-card-label">Cargando...</span></li>
                </ul>
            </div>

            <!-- Tarjeta 3: Top Especialidades -->
            <div class="stat-dashboard-card stat-card-especialidades">
                <div class="stat-card-icon">🩺</div>
                <div class="stat-card-title">Top Especialidades</div>
                <ul class="stat-card-list" id="topEspecialidadesStats">
                    <!-- Se llena con JS -->
                    <li class="stat-card-item"><span class="stat-card-label">Cargando...</span></li>
                </ul>
            </div>

            <!-- Tarjeta 4: Top Servicios -->
            <div class="stat-dashboard-card stat-card-servicios">
                <div class="stat-card-icon">🔧</div>
                <div class="stat-card-title">Top Servicios</div>
                <ul class="stat-card-list" id="topServiciosStats">
                    <!-- Se llena con JS -->
                    <li class="stat-card-item"><span class="stat-card-label">Cargando...</span></li>
                </ul>
            </div>

        </div>
    </div>

    <!-- 3. ELIMINADO: Solicitudes Finalizadas por Diseñador (Ya no existe en el HTML) -->

</div>

<script>
// === CONFIGURACIÓN DE SCRIPT URL ===
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw4oGU8GLqut_CQTWIdkArjakKsuRAZLVF9xI4YhO-pYV0XYvMp-BXoE4arULToavgaw/exec";

// === DEVICE DETECTION AND WELCOME MODAL FUNCTIONS ===

// Device detection
function detectDevice() {
    const userAgent = navigator.userAgent;
    const width = window.innerWidth;
    
    if (/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {
        if (width < 768) {
            return 'Teléfono';
        } else {
            return 'Tablet';
        }
    } else if (/iPad|Tablet/i.test(userAgent) || (width >= 768 && width <= 1024)) {
        return 'Tablet';
    } else {
        return 'PC';
    }
}

// IP detection (using a free API)
async function detectIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip || 'No disponible';
    } catch (error) {
        console.log('Error detecting IP:', error);
        return 'No disponible';
    }
}

// Check if first visit of the day for this IP
function isFirstVisitToday(ip) {
    const today = new Date().toDateString();
    const lastVisit = localStorage.getItem(`lastVisit_${ip}`);
    return lastVisit !== today;
}

// Mark today's visit for this IP
function markTodayVisit(ip) {
    const today = new Date().toDateString();
    localStorage.setItem(`lastVisit_${ip}`, today);
}

// Show welcome modal
async function showWelcomeModal() {
    const ip = await detectIP();
    const device = detectDevice();
    const now = new Date();
    
    // Format date
    const today = now.toLocaleDateString('es-VE', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // Format time
    const time = now.toLocaleTimeString('es-VE', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    // Update welcome content
    document.getElementById('welcomeDate').textContent = today;
    document.getElementById('welcomeTime').textContent = time;
    
    // Store IP and device data for database (hidden from user)
    console.log('Visit data stored:', { ip, device, timestamp: now.toISOString() });
    
    // Show modal
    document.getElementById('welcomeModal').style.display = 'flex';
    
    // Play welcome sound
    if (typeof playModalSound === 'function') {
        playModalSound();
    }
    
    // Start live clock update
    startWelcomeClock();
}

// Live clock for welcome modal
function startWelcomeClock() {
    const updateClock = () => {
        const now = new Date();
        const time = now.toLocaleTimeString('es-VE', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const timeElement = document.getElementById('welcomeTime');
        if (timeElement && document.getElementById('welcomeModal').style.display === 'flex') {
            timeElement.textContent = time;
        } else {
            clearInterval(window.welcomeClockInterval);
        }
    };
    
    // Clear existing interval
    if (window.welcomeClockInterval) {
        clearInterval(window.welcomeClockInterval);
    }
    
    // Update immediately and then every second
    updateClock();
    window.welcomeClockInterval = setInterval(updateClock, 1000);
}

// Force show welcome modal (for testing)
async function forceShowWelcomeModal() {
    await showWelcomeModal();
}

// Initialize welcome modal
function initializeWelcomeModal() {
    // Close button
    const closeBtn = document.getElementById('btnCloseWelcome');
    if (closeBtn) {
        closeBtn.onclick = () => {
            closeWelcomeModal();
        };
    }
    
    // Start button
    const startBtn = document.getElementById('btnWelcomeStart');
    if (startBtn) {
        startBtn.onclick = () => {
            closeWelcomeModal();
            // Optionally focus on the first form field
            const firstInput = document.querySelector('#region-grid .card-btn');
            if (firstInput) {
                firstInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };
    }
    
    // Admin login button
    const adminBtn = document.getElementById('btnAdminLogin');
    if (adminBtn) {
        adminBtn.onclick = () => {
            closeWelcomeModal();
            // Trigger the existing admin login functionality
            const authBtn = document.getElementById('authBtn');
            if (authBtn) {
                authBtn.click();
            } else {
                // Fallback: show login modal directly
                showLogin();
            }
        };
    }
    
    // Click outside to close
    const welcomeModal = document.getElementById('welcomeModal');
    if (welcomeModal) {
        welcomeModal.onclick = (e) => {
            if (e.target === welcomeModal) {
                closeWelcomeModal();
            }
        };
    }
    
    // ESC key to close
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && welcomeModal && welcomeModal.style.display === 'flex') {
            closeWelcomeModal();
        }
    });
}

// Close welcome modal
function closeWelcomeModal() {
    // Clear clock interval
    if (window.welcomeClockInterval) {
        clearInterval(window.welcomeClockInterval);
    }
    
    // Hide modal
    document.getElementById('welcomeModal').style.display = 'none';
}

// === AGREGAR ESTO ===
const BATCH_QUEUE = {
  requests: [],
  timeout: null,
  delay: 100 // ms para agrupar requests
};

async function batchRequest(action, params) {
  return new Promise((resolve, reject) => {
    BATCH_QUEUE.requests.push({ action, params, resolve, reject });
    
    if (BATCH_QUEUE.timeout) {
      clearTimeout(BATCH_QUEUE.timeout);
    }
    
    BATCH_QUEUE.timeout = setTimeout(async () => {
      const batch = BATCH_QUEUE.requests.splice(0);
      BATCH_QUEUE.requests = [];
      
      try {
        // ✅ PROCESAR EN PARALELO (máximo 3 simultáneos)
        const results = await Promise.allSettled(
          batch.map(async (req) => {
            const params = new URLSearchParams();
            params.append("action", req.action);
            Object.keys(req.params).forEach(key => {
              params.append(key, req.params[key]);
            });
            
            const res = await fetch(SCRIPT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: params.toString()
            });
            return await res.json();
          })
        );
        
        // ✅ RESOLVER CADA PROMESA INDIVIDUAL
        results.forEach((result, index) => {
          if (result.status === 'fulfilled') {
            batch[index].resolve(result.value);
          } else {
            batch[index].reject(result.reason);
          }
        });
      } catch (e) {
        batch.forEach(req => req.reject(e));
      }
    }, BATCH_QUEUE.delay);
  });
}

// ✅ VARIABLES GLOBALES DEL PANEL
let selectedRequestId = null;
let selectedRequestData = null;
let isPanelOpen = false;

// ✅ POLLING PARA SINCRONIZACIÓN EN TIEMPO REAL
let panelSyncInterval = null;

// ✅ VARIABLES PARA SISTEMA DE CHUNKS MEJORADO
let chunkUpload = {
    // Estado
    isActive: false,
    isPaused: false,
    isCancelled: false,
    
    // Archivo y chunks
    currentFile: null,
    fileSize: 0,
    fileName: '',
    mimeType: '',
    chunks: [],
    totalChunks: 0,
    uploadedChunks: 0,
    currentChunkIndex: 0,
    
    // Configuración dinámica
    currentChunkSize: 512 * 1024,  // Tamaño inicial (se ajusta dinámicamente)
    maxConcurrent: 1,
    connectionTier: 'unknown',
    
    // Medición de velocidad en tiempo real
    startTime: null,
    lastUpdateTime: null,
    totalBytesUploaded: 0,
    
    // Historial de velocidades para promedio móvil
    speedHistory: [],
    currentSpeed: 0,        // Velocidad instantánea (KB/s)
    averageSpeed: 0,        // Velocidad promedio (KB/s)
    smoothedSpeed: 0,       // Velocidad suavizada (KB/s)
    
    // Progreso granular (bytes reales, no chunks)
    bytesUploadedCurrentChunk: 0,
    totalBytesCommitted: 0,  // Bytes confirmados como subidos
    
    // Reintentos
    retryCount: 0,
    maxRetries: 3,
    chunkRetries: {},  // Track de reintentos por chunk
    
    // Temporizadores
    progressTimer: null,
    speedUpdateTimer: null,
    
    // Token de cancelación
    abortController: null,
    
    // Variables legacy para compatibilidad
    pauseRequested: false,
    resumeToken: null,
    currentChunkStartTime: null,
    currentChunkEndTime: null,
    uploadSpeeds: [],
    avgUploadSpeed: 0,
    currentUploadSpeed: 0,
    connectionSpeed: 'unknown',
    chunkSize: 512 * 1024,
    currentChunk: 0
};

// ✅ VARIABLES PARA MEDIDORES DE VELOCIDAD
let speedMonitoring = {
    internetSpeed: {
        current: 0,
        average: 0,
        maximum: 0,
        history: [],
        lastMeasurement: null
    },
    uploadSpeed: {  // ✅ CAMBIADO: Ahora mide velocidad de subida real para chunks
        current: 0,
        average: 0,
        minimum: 9999,
        history: [],
        lastMeasurement: null,
        tier: 'unknown',  // ULTRA_FAST, FAST, MEDIUM, SLOW, VERY_SLOW
        chunkSize: 512 * 1024  // Tamaño de chunk recomendado
    },
    intervalId: null,
    measurementInterval: 5 * 60 * 1000 // 5 minutos
};

// ✅ CONFIGURACIÓN AVANZADA DE CHUNKS CON ADAPTACIÓN DINÁMICA
const CHUNK_CONFIG = {
    // Umbrales de velocidad en KB/s (medidos empíricamente)
    THRESHOLDS: {
        ULTRA_FAST: 2048,    // > 2 MB/s - Subida completa
        FAST: 512,           // 512 KB/s - 1 MB - 2 MB chunks
        MEDIUM: 128,         // 128-512 KB/s - 512 KB chunks
        SLOW: 32,            // 32-128 KB/s - 256 KB chunks
        VERY_SLOW: 0         // < 32 KB/s - 128 KB chunks
    },
    
    // Tamaños de chunks según velocidad
    SIZES: {
        ULTRA_FAST: Infinity, // No usar chunks
        FAST: 2 * 1024 * 1024,      // 2 MB
        MEDIUM: 512 * 1024,         // 512 KB
        SLOW: 256 * 1024,           // 256 KB
        VERY_SLOW: 128 * 1024       // 128 KB
    },
    
    // Configuraciones de concurrencia
    CONCURRENT: {
        ULTRA_FAST: 1,  // Secuencial (conexión rápida no necesita paralelismo)
        FAST: 2,        // 2 conexiones paralelas
        MEDIUM: 1,      // 1 conexión (estable)
        SLOW: 1,        // 1 conexión (evitar saturación)
        VERY_SLOW: 1    // 1 conexión (máxima estabilidad)
    },
    
    // Intervalos de actualización de UI (ms)
    UPDATE_INTERVAL: 100,  // Actualizar cada 100ms para fluidez
    
    // Muestras para promedio móvil
    SPEED_SAMPLES: 5,  // Usar últimas 5 mediciones para promedio
    
    // Configuración legacy para compatibilidad
    fast: { size: 1024 * 1024, concurrent: 3 },    // 1MB (no se usa - conexiones rápidas suben completo)
    medium: { size: 512 * 1024, concurrent: 2 },   //512KB para conexiones medias
    'slow-medium': { size: 256 * 1024, concurrent: 1 }, // 256KB para conexiones lentas-medias
    slow: { size: 256 * 1024, concurrent: 1 }      // 256KB para conexiones lentas
};

// ============================================================
// FUNCIÓN CORREGIDA: DETECCIÓN REAL DE VELOCIDAD
// ============================================================
async function detectConnectionSpeed() {
    console.log("🔍 Iniciando detección de velocidad de conexión...");
    
    // ✅ ARCHIVOS DE PRUEBA MÁS GRANDES (10MB y 50MB)
    const testSizes = [
        { size: 10 * 1024 * 1024, name: "10MB" },   // 10 MB
        { size: 50 * 1024 * 1024, name: "50MB" }    // 50 MB para conexiones >100Mbps
    ];
    
    const speeds = [];
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw4oGU8GLqut_CQTWIdkArjakKsuRAZLVF9xI4YhO-pYV0XYvMp-BXoE4arULToavgaw/exec";
    
    for (let test of testSizes) {
        try {
            // Crear blob de datos aleatorios del tamaño especificado
            const testData = new Uint8Array(test.size);
            const chunk = 65536; // 64KB chunks para mejor performance
            
            for (let i = 0; i < test.size; i += chunk) {
                const end = Math.min(i + chunk, test.size);
                for (let j = i; j < end; j++) {
                    testData[j] = Math.floor(Math.random() * 256);
                }
            }
            
            const blob = new Blob([testData]);
            const formData = new FormData();
            formData.append('speedTest', blob);
            formData.append('action', 'speedTest');
            formData.append('timestamp', Date.now().toString());
            formData.append('size', test.size.toString());
            
            const startTime = performance.now();
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos max
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData,
                signal: controller.signal,
                cache: 'no-store'
            });
            
            clearTimeout(timeoutId);
            
            const endTime = performance.now();
            const duration = (endTime - startTime) / 1000; // segundos
            
            // ✅ CÁLCULO CORREGIDO: bits por segundo, no bytes
            const bitsUploaded = test.size * 8;
            const speedBps = bitsUploaded / duration;
            const speedMbps = speedBps / (1024 * 1024); // Convertir a Mbps
            
            // Solo usar mediciones válidas (>0.1s para evitar precisión insuficiente)
            if (duration > 0.1) {
                speeds.push(speedMbps);
                console.log(`📊 Prueba ${test.name}: ${speedMbps.toFixed(2)} Mbps (${duration.toFixed(2)}s)`);
            }
            
        } catch (e) {
            console.warn(`⚠️ Prueba ${test.name} fallida: ${e.message}`);
        }
    }
    
    // Calcular velocidad final
    let finalSpeed = 0;
    if (speeds.length > 0) {
        // Usar la mediana para evitar outliers
        speeds.sort((a, b) => a - b);
        finalSpeed = speeds[Math.floor(speeds.length / 2)];
    } else {
        // Fallback: estimar basado en Network Information API
        finalSpeed = estimateSpeedFromNetworkAPI();
    }
    
    // Determinar tier y configuración
    const config = getSpeedConfig(finalSpeed);
    
    console.log(`🌐 Velocidad detectada: ${finalSpeed.toFixed(2)} Mbps`);
    console.log(`🏷️ Tier: ${config.tier} | Chunk: ${config.chunkSize === Infinity ? 'Completo' : (config.chunkSize/1024/1024).toFixed(1) + 'MB'}`);
    
    return {
        speed: finalSpeed,
        tier: config.tier,
        chunkSize: config.chunkSize,
        concurrent: config.concurrent,
        shouldUseChunks: config.chunkSize !== Infinity
    };
}

// ============================================================
// FUNCIÓN AUXILIAR: Estimación desde Network API
// ============================================================
function estimateSpeedFromNetworkAPI() {
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    
    if (connection) {
        // downlink está en Mbps según la especificación
        if (connection.downlink) {
            console.log(`📡 Network API estima: ${connection.downlink} Mbps`);
            return connection.downlink;
        }
        
        // Fallback por effectiveType
        const estimates = {
            '4g': 50,    // 4G típico: 5-100 Mbps
            '3g': 3,     // 3G típico: 0.5-5 Mbps
            '2g': 0.1    // 2G típico: <0.1 Mbps
        };
        
        if (estimates[connection.effectiveType]) {
            return estimates[connection.effectiveType];
        }
    }
    
    return 10; // Default conservador: 10 Mbps
}

// ============================================================
// FUNCIÓN AUXILIAR: Configuración basada en velocidad
// ============================================================
function getSpeedConfig(speedMbps) {
    // ✅ UMBRALES REALISTAS para 2024-2025
    if (speedMbps >= 100) {
        return {
            tier: 'ULTRA_FAST',
            chunkSize: Infinity,        // No usar chunks
            concurrent: 1,
            description: 'Fibra óptica / 5G'
        };
    } else if (speedMbps >= 20) {
        return {
            tier: 'FAST',
            chunkSize: 10 * 1024 * 1024,  // 10 MB chunks
            concurrent: 2,
            description: 'Cable / 4G+'
        };
    } else if (speedMbps >= 5) {
        return {
            tier: 'MEDIUM',
            chunkSize: 5 * 1024 * 1024,   // 5 MB chunks
            concurrent: 1,
            description: 'ADSL / 4G'
        };
    } else if (speedMbps >= 1) {
        return {
            tier: 'SLOW',
            chunkSize: 2 * 1024 * 1024,   // 2 MB chunks
            concurrent: 1,
            description: '3G / Conexión débil'
        };
    } else {
        return {
            tier: 'VERY_SLOW',
            chunkSize: 512 * 1024,        // 512 KB chunks
            concurrent: 1,
            description: '2G / Muy lenta'
        };
    }
}

// ✅ REINICIAR ESTADO DE CHUNKS
function resetChunkUploadState() {
    chunkUpload.isActive = false;
    chunkUpload.currentFile = null;
    chunkUpload.chunks = [];
    chunkUpload.currentChunk = 0;
    chunkUpload.totalChunks = 0;
    chunkUpload.uploadedChunks = 0;
    chunkUpload.pauseRequested = false;
    chunkUpload.startTime = null;
    chunkUpload.retryCount = 0;
    chunkUpload.resumeToken = null;
    
    // ✅ RESET VARIABLES DE VELOCIDAD
    chunkUpload.currentChunkStartTime = null;
    chunkUpload.currentChunkEndTime = null;
    chunkUpload.uploadSpeeds = [];
    chunkUpload.avgUploadSpeed = 0;
    chunkUpload.currentUploadSpeed = 0;
    
    // ✅ LIMPIAR DISPLAY DE VELOCIDAD
    const speedElement = document.getElementById('progressUploadSpeed');
    if (speedElement) {
        speedElement.innerText = '📤 Velocidad: Calculando...';
    }
    
    // ✅ Limpiar timer si existe
    if (window.confirmTimer) {
        clearInterval(window.confirmTimer);
        window.confirmTimer = null;
    }
    
    console.log("🔄 Estado de chunks reiniciado");
}

// ============================================================
// FUNCIÓN 2: DIVISIÓN INTELIGENTE DE ARCHIVO EN CHUNKS
// ============================================================

function splitFileIntoChunks(file) {
    const chunks = [];
    const fileSize = file.size;
    
    // Si la conexión es ultra-rápida y el archivo es menor a 6MB, no usar chunks
    if (chunkUpload.connectionTier === 'ULTRA_FAST' && fileSize <= 6 * 1024 * 1024) {
        console.log("🚀 Conexión ultra-rápida detectada, subiendo archivo completo");
        return [{
            index: 0,
            blob: file,
            size: fileSize,
            total: 1,
            fileId: file.name + '_' + Date.now(),
            startByte: 0,
            endByte: fileSize
        }];
    }
    
    // Para archivos muy pequeños (< 256KB), subir completo siempre
    if (fileSize <= 256 * 1024) {
        chunkUpload.currentChunkSize = fileSize;
        return [{
            index: 0,
            blob: file,
            size: fileSize,
            total: 1,
            fileId: file.name + '_' + Date.now(),
            startByte: 0,
            endByte: fileSize
        }];
    }
    
    // Ajustar tamaño de chunk si el archivo es muy grande
    let chunkSize = chunkUpload.currentChunkSize;
    const maxChunks = 50; // Evitar demasiados chunks
    
    if (fileSize / chunkSize > maxChunks) {
        chunkSize = Math.ceil(fileSize / maxChunks);
        // Redondear a múltiplo de 64KB para eficiencia
        chunkSize = Math.ceil(chunkSize / (64 * 1024)) * (64 * 1024);
        chunkUpload.currentChunkSize = chunkSize;
    }
    
    const totalChunks = Math.ceil(fileSize / chunkSize);
    const fileId = file.name + '_' + Date.now();
    
    for (let i = 0; i < totalChunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(start + chunkSize, fileSize);
        
        chunks.push({
            index: i,
            blob: file.slice(start, end),
            size: end - start,
            total: totalChunks,
            fileId: fileId,
            startByte: start,
            endByte: end
        });
    }
    
    console.log(`📦 Archivo dividido en ${totalChunks} chunks de ~${(chunkSize/1024).toFixed(0)}KB cada uno`);
    return chunks;
}

// ============================================================
// FUNCIÓN 3: ACTUALIZACIÓN DE VELOCIDAD EN TIEMPO REAL
// ============================================================

function updateSpeedMetrics(bytesUploaded, isComplete = false) {
    const now = performance.now();
    
    if (!chunkUpload.lastUpdateTime) {
        chunkUpload.lastUpdateTime = now;
        return;
    }
    
    const timeDelta = (now - chunkUpload.lastUpdateTime) / 1000; // segundos
    
    if (timeDelta > 0) {
        // Velocidad instantánea (KB/s)
        const instantSpeed = (bytesUploaded / 1024) / timeDelta;
        
        // Actualizar historial (promedio móvil)
        chunkUpload.speedHistory.push(instantSpeed);
        if (chunkUpload.speedHistory.length > CHUNK_CONFIG.SPEED_SAMPLES) {
            chunkUpload.speedHistory.shift();
        }
        
        // Calcular promedio
        chunkUpload.averageSpeed = chunkUpload.speedHistory.reduce((a, b) => a + b, 0) 
                                   / chunkUpload.speedHistory.length;
        
        // Suavizado exponencial para evitar fluctuaciones bruscas
        const alpha = 0.3; // Factor de suavizado
        chunkUpload.smoothedSpeed = (alpha * instantSpeed) + 
                                    ((1 - alpha) * (chunkUpload.smoothedSpeed || instantSpeed));
        
        chunkUpload.currentSpeed = instantSpeed;
        chunkUpload.lastUpdateTime = now;
        
        // Actualizar UI
        updateSpeedDisplay();
    }
}

function updateSpeedDisplay() {
    const speedElement = document.getElementById('progressUploadSpeed');
    const etaElement = document.getElementById('progressETA');
    
    if (!speedElement) return;
    
    // Formatear velocidad
    let speedText, unit;
    const speed = chunkUpload.smoothedSpeed || chunkUpload.averageSpeed || 0;
    
    if (speed >= 1024) {
        speedText = (speed / 1024).toFixed(2);
        unit = 'MB/s';
    } else {
        speedText = speed.toFixed(1);
        unit = 'KB/s';
    }
    
    // Calcular Mbps (megabits por segundo)
    const mbps = (speed * 8 / 1024).toFixed(1);
    
    // Determinar emoji según velocidad
    let emoji = '🐌';
    if (speed >= 1024) emoji = '🚀';
    else if (speed >= 512) emoji = '⚡';
    else if (speed >= 128) emoji = '📶';
    else if (speed >= 32) emoji = '🐢';
    
    speedElement.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
            <span style="font-size: 1.2rem;">${emoji}</span>
            <div>
                <div style="font-weight: 800; color: var(--turquesa); font-size: 1.1rem;">
                    ${speedText} ${unit}
                </div>
                <div style="font-size: 0.75rem; color: #666;">
                    ${mbps} Mbps | ${chunkUpload.connectionTier.replace('_', ' ')}
                </div>
            </div>
        </div>
    `;
    
    // Calcular ETA
    if (etaElement && speed > 0) {
        const remainingBytes = chunkUpload.fileSize - chunkUpload.totalBytesCommitted;
        const remainingKB = remainingBytes / 1024;
        const etaSeconds = Math.ceil(remainingKB / speed);
        
        let etaText;
        if (etaSeconds < 60) {
            etaText = `${etaSeconds}s`;
        } else if (etaSeconds < 3600) {
            etaText = `${Math.floor(etaSeconds / 60)}m ${etaSeconds % 60}s`;
        } else {
            etaText = `${Math.floor(etaSeconds / 3600)}h ${Math.floor((etaSeconds % 3600) / 60)}m`;
        }
        
        etaElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 6px; justify-content: center; margin-top: 8px;">
                <span>⏱️</span>
                <span style="font-weight: 600;">Tiempo restante: ~${etaText}</span>
                <span style="font-size: 0.75rem; color: #888;">
                    (${((chunkUpload.totalBytesCommitted / chunkUpload.fileSize) * 100).toFixed(1)}%)
                </span>
            </div>
        `;
    }
}

// ============================================================
// FUNCIÓN 4: SUBIR CHUNK INDIVIDUAL CON MEDICIÓN REAL
// ============================================================

async function uploadSingleChunkWithProgress(id, filename, mimeType, chunk) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const base64 = e.target.result.split(',')[1];
                const chunkSizeKB = chunk.size / 1024;
                
                // Preparar datos
                const params = new URLSearchParams();
                params.append("action", "uploadChunk");
                params.append("id", id);
                params.append("filename", filename);
                params.append("mime", mimeType);
                params.append("chunkIndex", chunk.index);
                params.append("chunkData", base64);
                params.append("totalChunks", chunk.total);
                params.append("fileId", chunk.fileId);
                params.append("uploadedBy", userCredentials.displayName);
                params.append("startByte", chunk.startByte);
                params.append("endByte", chunk.endByte);
                
                // Crear XMLHttpRequest para tracking de progreso real
                const xhr = new XMLHttpRequest();
                const startTime = performance.now();
                
                // Configurar tracking de progreso
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        // Bytes reales subidos de este chunk
                        const bytesUploaded = event.loaded;
                        chunkUpload.bytesUploadedCurrentChunk = bytesUploaded;
                        
                        // Actualizar métricas en tiempo real
                        const totalUploaded = chunkUpload.totalBytesCommitted + bytesUploaded;
                        updateSpeedMetrics(bytesUploaded);
                        
                        // Actualizar progreso granular
                        updateGranularProgress(totalUploaded);
                    }
                };
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const endTime = performance.now();
                        const duration = (endTime - startTime) / 1000;
                        const actualSpeed = chunkSizeKB / duration;
                        
                        console.log(`✅ Chunk ${chunk.index + 1}/${chunk.total} completado en ${duration.toFixed(2)}s (${actualSpeed.toFixed(2)} KB/s)`);
                        
                        // Confirmar bytes subidos
                        chunkUpload.totalBytesCommitted += chunk.size;
                        chunkUpload.bytesUploadedCurrentChunk = 0;
                        
                        // Actualizar velocidad final del chunk
                        updateSpeedMetrics(chunk.size, true);
                        
                        resolve(xhr.response);
                    } else {
                        reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                    }
                };
                
                xhr.onerror = () => reject(new Error("Error de red"));
                xhr.ontimeout = () => reject(new Error("Timeout"));
                
                // Enviar
                xhr.open('POST', SCRIPT_URL, true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.send(params.toString());
                
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo chunk"));
        reader.readAsDataURL(chunk.blob);
    });
}

// ============================================================
// FUNCIÓN 5: ACTUALIZACIÓN DE PROGRESO GRANULAR
// ============================================================

function updateGranularProgress(bytesUploaded) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
    
    if (!progressBar || !progressPercent) return;
    
    const percentage = Math.min(100, (bytesUploaded / chunkUpload.fileSize) * 100);
    
    progressBar.style.width = percentage + '%';
    progressPercent.innerText = percentage.toFixed(1) + '%';
    
    // Actualizar texto de estado
    if (progressStatus) {
        const chunkInfo = chunkUpload.totalChunks > 1 
            ? ` (Chunk ${chunkUpload.currentChunkIndex + 1}/${chunkUpload.totalChunks})`
            : '';
        progressStatus.innerText = `📤 Subiendo${chunkInfo}...`;
    }
}


const UNIDADES_IPASME_RAW = {
"Capital": [
"Don Simón Rodríguez",
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende"
],
"Región Central": [
"Maracay", "La Victoria", "Valencia", "Puerto Cabello",
"Club Villas Ipasmar", "Guatire", "Ocumare del Tuy", "Caucagua",
"Carrizal", "La Guaira"
],
"Región Occidental": [
"Cabimas", "Maracaibo", "Machiques", "San Carlos del Zulia",
"El Moján", "Barquisimeto", "El Tocuyo", "Carora",
"San Felipe", "Nirgua", "Punto Fijo", "Coro",
"Buchivacoa", "Puerto Cumarebo"
],
"Región Los Andes": [
"El Vigía", "Mérida", "Tovar",
"Hotel Valle Grande", "La Grita", "Rubio",
"San Cristóbal", "San Juan de Colón", "Ureña",
"Boconó", "Trujillo", "Valera"
],
"Región Oriental": [
"Anaco", "Barcelona", "Cantaura", "El Tigre",
"Isidora Agnes, Ciudad Bolívar", "Guasipati",
"Profa. Mirelva Martínez, San Félix", "Upata", "Maturín",
"Punta de Mata", "Cumaná", "Cumanacoa", "Carúpano",
"Güiria", "Tucupita", "Casacoima", "La Asunción",
"Puerto Ayacucho"
],
"Región Los Llanos": [
"Altagracia de Orituco", "Calabozo", "San Juan de los Morros",
"Valle de la Pascua", "Zaraza", "San Carlos de Cojedes",
"Tinaquillo", "San Fernando de Apure", "Guasdualito",
"Barinas", "Santa Bárbara de Barinas", "Acarigua", "Guanare"
]
};

const ORDEN_REGIONES = [
"Capital",
"Región Central",
"Región Occidental",
"Región Los Andes",
"Región Oriental",
"Región Los Llanos"
];

function getNombreRegionLimpio(regionKey) {
if (regionKey === "Capital") return "Capital";
return regionKey.replace("Región ", "");
}

const UNIDADES_IPASME = {};
ORDEN_REGIONES.forEach(region => {
const unidadesOriginales = UNIDADES_IPASME_RAW[region] || [];
UNIDADES_IPASME[region] = [...unidadesOriginales].sort((a, b) =>
a.trim().localeCompare(b.trim(), 'es', { sensitivity: 'base' })
);
});

// ✅ VARIABLES GLOBALES PARA ROLES
let isLoggingIn = false;
let isAdmin = false;
let isDesigner = false;
let selectedAMPM = "";
let catType = "";
let catName = "";
let localData = [];
let isMaintActive = false;
let selectedRegionKey = "";
let selectedUnidad = "";
let modoObituario = false;

// ✅ ACTUALIZAR DATA_CACHE PARA INCLUIR NUEVAS ESTADÍSTICAS
const DATA_CACHE = {
    data: null,
    timestamp: 0,
    serverTimestamp: 0, // ✅ Timestamp del servidor para invalidación
    ttl: 60000, // CAMBIADO: de 5000 a 60000 (60 segundos)
    isLoading: false,
    pendingPromise: null,
    stats: null,
    statsPeriod: 'month'
};

// === AGREGAR ESTO ===
const PAGINATION = {
  currentPage: 1,
  limit: 40,
  totalPages: 1,
  totalRecords: 0,
  isLoading: false
};


let DATA_INDEX = {
    byId: new Map(),
    byStatus: new Map(),
    byDesigner: new Map()
};

// ✅ ACTUALIZAR TABLA CON INVALIDACIÓN DE CACHÉ CORRECTA
async function updateTable(forceRefresh = false) {
  const now = Date.now();
  
  // ✅ CORRECCIÓN: Guardar y comparar serverTimestamp correctamente
  const serverCacheTimestamp = parseInt(DATA_CACHE.serverTimestamp || "0");
  
  if (serverCacheTimestamp > DATA_CACHE.timestamp) {
    forceRefresh = true;
    console.log("🔄 Caché del servidor actualizada, refrescando datos...");
  }
  
  if (!forceRefresh && DATA_CACHE.data && (now - DATA_CACHE.timestamp) < DATA_CACHE.ttl) {
    localData = DATA_CACHE.data;
    if(DATA_CACHE.stats) updateCounters(DATA_CACHE.stats);
    renderLocalTable();
    updatePaginationControls();
    return;
  }
  
  if (DATA_CACHE.isLoading) {
    await DATA_CACHE.pendingPromise;
    return;
  }
  
  DATA_CACHE.isLoading = true;
  DATA_CACHE.pendingPromise = fetchTableData();
  
  try {
    const result = await DATA_CACHE.pendingPromise;
    DATA_CACHE.data = result.rows;
    DATA_CACHE.stats = result.stats;
    DATA_CACHE.serverTimestamp = result.cacheTimestamp || now; // ✅ GUARDAR CORRECTAMENTE
    DATA_CACHE.timestamp = now;
    localData = result.rows;
    buildDataIndexes();
    
    // ✅ ACTUALIZAR selectedRequestData si hay una solicitud seleccionada
    if (selectedRequestId) {
      selectedRequestData = localData.find(x => x.id == selectedRequestId);
      // Si el panel está abierto, actualizar su contenido
      if (isPanelOpen && selectedRequestData) {
        updatePanelContent();
      }
    }
    
    if (result.stats) {
      updateCounters(result.stats);
    }
    renderLocalTable();
    updatePaginationControls();
  } catch (e) {
    console.error("Error cargando tabla:", e);
  } finally {
    DATA_CACHE.isLoading = false;
    DATA_CACHE.pendingPromise = null;
  }
}


// ✅ FUNCIÓN PARA MANTENER EL ÍNDICE DE DATOS ACTUALIZADO
function maintainDataIndex() {
    // Limpiar índices existentes
    DATA_INDEX.byId.clear();
    DATA_INDEX.byStatus.clear();
    DATA_INDEX.byDesigner.clear();
    
    console.log('🔄 Reconstruyendo índices con', localData.length, 'registros');
    
    // Reconstruir índices con los datos actuales
    localData.forEach((item, index) => {
        // Índice por ID (para búsqueda rápida)
        if (item.id) {
            const idKey = String(item.id).toUpperCase().trim();
            DATA_INDEX.byId.set(idKey, {
                item: item,
                index: index
            });
        } else {
            console.warn('⚠️ Item sin ID:', item);
        }
        
        // Índice por estado
        const status = item.Estatus ? item.Estatus.toUpperCase().trim() : '';
        if (status) {
            if (!DATA_INDEX.byStatus.has(status)) {
                DATA_INDEX.byStatus.set(status, []);
            }
            DATA_INDEX.byStatus.get(status).push({ item, index });
        }
        
        // Índice por diseñador
        const designer = item.Disenador ? item.Disenador.trim() : '';
        if (designer) {
            if (!DATA_INDEX.byDesigner.has(designer)) {
                DATA_INDEX.byDesigner.set(designer, []);
            }
            DATA_INDEX.byDesigner.get(designer).push({ item, index });
        }
    });
    
    console.log('✅ Índice reconstruido:', {
        totalEntries: DATA_INDEX.byId.size,
        primerosIDs: Array.from(DATA_INDEX.byId.keys()).slice(0, 5)
    });
}

// ✅ FUNCIÓN PARA CONSTRUIR ÍNDICES DE DATOS
function buildDataIndexes() {
    maintainDataIndex();
}


// ACTUALIZAR VARIABLE GLOBAL DE DISEÑADORES (5 DISEÑADORES)
const designerColors = {
"Bermina": "#fb8500",
"Jorsy": "#2908f1",
"María F.": "#4caf50",
"Xamir": "#572364",
"Fulan@": "#9d0208"  // NUEVO 5TO DISEÑADOR
};

// NUEVA VARIABLE GLOBAL PARA ID DE SOLICITUD EN MODAL DE DISEÑADOR
// VARIABLE ELIMINADA - Ya no se usa modal de diseñador, se usa el panel lateral
// let requestIdForDesigner = null; // ELIMINADO

// ✅ VARIABLES GLOBALES PARA BÚSQUEDA
let currentSearchId = "";
let isSearchActive = false;

// ✅ NUEVA VARIABLE PARA ALMACENAR CREDENCIALES DEL USUARIO ACTUAL
let userCredentials = {
username: "",
password: "",
displayName: "",
role: "", // "admin" o "diseñador"
designerName: "" // Solo para diseñadores
};

const DATA = {
especialidades: ["Alergología", "Cardiología", "Cirugía general", "Dermatología", "Fisiatría", "Foniatría", "Gastroenterología", "Geriatría", "Ginecología y obstetricia", "Infectología", "Medicina familiar", "Medicina general", "Medicina interna", "Nefrología", "Neumología", "Neurología", "Nutrición", "Odontología", "Oftalmología", "Oncología", "Optometría", "Pediatría", "Psicología", "Psiquiatría", "Reumatología", "Traumatología", "Urología"],
servicios: ["Actividades recreativas", "Afiliación", "Agudeza visual", "Aplicación de flúor", "Asesoría legal", "Bienestar social", "Captación odontológica", "Captación quirúrgica general", "Captación quirúrgica oftalmológica", "Charlas odontológicas", "Citología", "Control de glicemia", "Control de talla y peso", "Desparasitación", "Despistaje de glicemia capilar", "Despistaje HTA", "Ecografía", "Electrocardiograma", "Espirometría", "Farmacia", "Fisioterapia", "Fonoaudiología", "Gerontología", "Ingeniería biomédica", "Inmunización", "Laboratorio", "Liberación de hipoteca", "Masoterapia", "Podología", "Quiropraxia", "Reposos médicos", "Sesión educativa", "Servicios sociales", "Terapia de lenguaje (Logopedia)", "Terapia del dolor", "Terapia ocupacional", "Tipiaje", "Trabajo social"],
vacunas: ["Fiebre amarilla", "Pentavalente", "Polio IPV", "Polio oral", "Toxoide (tetánico/diftérico)", "Trivalente viral (SRP)"],
quirurgica: ["Bocio hiperfuncionante", "Colectomía", "Enfermedad hemorroidal", "Esterilización", "Fibromatosis", "Fimosis", "Hernia abdominal", "Hernia epigástrica", "Hernia escrotal", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Histerectomía", "Lipomas", "Litiasis vesicular (Colecistectomías)", "Lunares", "Miomatosis uterina", "Nevus", "Nódulos mamarios simples", "Paridad satisfecha", "Prolapso", "Quiste (TU)", "Quiste de epidídimo", "Quiste sebáceo", "Quiste tirogloso", "Quistes sebáceos", "Tumores ováricos", "Varicocele", "Vasectomía", "Verrugas"],
pediatrica: ["Criptorquidias", "Fimosis", "Hernia epigástrica", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Quiste tirogloso", "Varicocele"],
oftalmo: ["Cataratas", "Cirugía plástica ocular", "Dacriocistorrinostomía", "Desprendimiento de retina", "Glaucoma", "Melanoma uveal", "Pterigión", "Ptosis palpebral", "Queratoplastía", "Retinoblastoma", "Tumores oculares"]
};

// ✅ FUNCIÓN ÚNICA DE BÚSQUEDA POR ID (CON BÚSQUEDA PARCIAL)
function buscarPorID() {
  const searchInput = document.getElementById('searchIdInput');
  const searchTerm = searchInput.value.trim().toUpperCase();
  currentSearchId = searchTerm;
  isSearchActive = searchTerm.length > 0;
  
  const searchContainer = document.getElementById('designer-search-container');
  if (isAdmin || isDesigner) {
    searchContainer.classList.remove('hidden');
  }
  
  if (!isSearchActive) {
    resetSearchHighlight();
    // CORRECCIÓN: Usar renderLocalTable para mostrar todos los datos y restaurar contadores
    renderLocalTable();
    // OCULTAR MODAL DE ID NO ENCONTRADO
    document.getElementById('idNotFoundModal').style.display = 'none';
    return;
  }
  
  // ✅ ASEGURAR QUE EL ÍNDICE ESTÉ ACTUALIZADO
  if (DATA_INDEX.byId.size === 0) {
    console.log('🔄 Índice vacío, reconstruyendo...');
    buildDataIndexes();
  }
  
  // ✅ DEPURACIÓN: Verificar qué hay en el índice
  console.log('🔍 Buscando:', searchTerm);
  console.log('📊 Total en índice:', DATA_INDEX.byId.size);
  console.log('📋 IDs disponibles:', Array.from(DATA_INDEX.byId.keys()).slice(0, 10));
  
  // BÚSQUEDA PARCIAL (busca coincidencias en cualquier parte del ID)
  const matchedEntries = [];
  
  // Iterar sobre el índice para encontrar coincidencias parciales
  for (const [id, entry] of DATA_INDEX.byId) {
    if (id.includes(searchTerm)) {
      matchedEntries.push(entry);
      console.log('✅ Coincidencia encontrada:', id);
    }
  }
  
  console.log('🎯 Resultados encontrados:', matchedEntries.length);
  
  if (matchedEntries.length > 0) {
    const body = document.getElementById('solicitudes-body');
    body.innerHTML = '';
    
    // Renderizar cada resultado encontrado
    matchedEntries.forEach(entry => {
      const tr = createRowElement(entry.item, entry.index);
      tr.classList.add('row-highlighted');
      body.appendChild(tr);
    });
    
    // Hacer scroll al primer resultado
    if (matchedEntries.length > 0) {
      const firstRow = body.querySelector('tr');
      if (firstRow) {
        firstRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }
    
    // OCULTAR MODAL DE ID NO ENCONTRADO SI HAY RESULTADOS
    document.getElementById('idNotFoundModal').style.display = 'none';
    
  } else {
    // MOSTRAR MENSAJE DE NO RESULTADOS Y RENDERIZAR TABLA VACÍA
    document.getElementById('notFoundId').innerText = currentSearchId;
    document.getElementById('idNotFoundModal').style.display = 'flex';
    
    // RENDERIZAR TABLA VACÍA PARA MOSTRAR QUE NO HAY RESULTADOS
    const body = document.getElementById('solicitudes-body');
    body.innerHTML = `
      <tr>
        <td colspan="8" class="no-results-message show">
          No se encontraron resultados para "${searchTerm}"
        </td>
      </tr>
    `;
  }
}

// APLICAR RESALTADO Y BLOQUEO
function applySearchHighlight(searchTerm) {
    const rows = document.querySelectorAll('#solicitudes-body tr');
    let foundMatch = false;
    let matchedRow = null;
    rows.forEach(row => {
        // ✅ BUSCAR EN LA PRIMERA COLUMNA (ID) QUE AHORA CONTIENE EL BADGE
        const idCell = row.querySelector('td:first-child');
        const rowId = idCell ? idCell.textContent.trim().toUpperCase() : "";
        
        // ✅ EXTRAER SOLO EL ID (eliminar texto del badge)
        const idOnly = rowId.replace(/NEW|PRIORIZAR/g, '').trim();
        
        // ✅ VERIFICAR COINCIDENCIA
        const isMatch = idOnly.includes(searchTerm);
        if (isMatch) {
            row.classList.add('row-highlighted');
            row.classList.remove('row-locked');
            foundMatch = true;
            matchedRow = row;
            enableRowButtons(row);
        } else {
            row.classList.add('row-locked');
            row.classList.remove('row-highlighted');
            disableRowButtons(row);
        }
    });
    
    // ✅ SCROLL AUTOMÁTICO A LA FILA ENCONTRADA
    if (matchedRow) {
        matchedRow.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
        });
    }
    
    // ✅ MOSTRAR MENSAJE SI NO HAY COINCIDENCIAS
    if (!foundMatch) {
        document.getElementById('notFoundId').innerText = currentSearchId;
        document.getElementById('idNotFoundModal').style.display = 'flex';
    }
}

// ✅ HABILITAR BOTONES EN FILA
function enableRowButtons(row) {
const buttons = row.querySelectorAll('.btn-arte, .btn-ver, .btn-tg');
buttons.forEach(btn => {
btn.disabled = false;
btn.style.opacity = "1";
btn.style.pointerEvents = "auto";
btn.style.cursor = "pointer";
});
}

// ✅ DESHABILITAR BOTONES EN FILA
function disableRowButtons(row) {
const buttons = row.querySelectorAll('.btn-arte, .btn-ver, .btn-tg');
buttons.forEach(btn => {
btn.disabled = true;
btn.style.opacity = "0.4";
btn.style.pointerEvents = "none";
btn.style.cursor = "not-allowed";
});
}

// ✅ RESTABLECER TABLA A ESTADO ORIGINAL
function resetSearchHighlight() {
const rows = document.querySelectorAll('#solicitudes-body tr');

rows.forEach(row => {
row.classList.remove('row-highlighted', 'row-locked');
enableRowButtons(row);
});

// ✅ OCULTAR MENSAJE DE NO RESULTADOS
document.getElementById('idNotFoundModal').style.display = 'none';
}

// ✅ Cerrar modal de ID no encontrado
function closeIdNotFoundModal() {
document.getElementById('idNotFoundModal').style.display = 'none';
document.getElementById('searchIdInput').focus();
}

// ✅ LIMPIAR BÚSQUEDA
function clearSearch() {
document.getElementById('searchIdInput').value = "";
buscarPorID();

// ✅ FOCO DE NUEVO EN EL INPUT
setTimeout(() => {
document.getElementById('searchIdInput').focus();
}, 100);
}

// ✅ MANEJADOR DE EVENTOS PARA TECLADO
function handleSearchKeydown(e) {
if (e.key === 'Escape') {
clearSearch();
}

// ✅ PREVENIR ENVÍO DEL FORMULARIO AL PRESIONAR ENTER
if (e.key === 'Enter') {
e.preventDefault();
buscarPorID();
}
}

// ✅ INICIALIZAR EVENTOS DEL BUSCADOR
function initSearchEvents() {
const searchInput = document.getElementById('searchIdInput');

if (searchInput) {
// ✅ BÚSQUEDA EN TIEMPO REAL (con debounce)
let searchTimeout;
searchInput.addEventListener('input', (e) => {
clearTimeout(searchTimeout);
searchTimeout = setTimeout(() => {
buscarPorID();
}, 300); // Esperar 300ms después de dejar de escribir
});

// ✅ MANEJAR TECLAS ESPECIALES
searchInput.addEventListener('keydown', handleSearchKeydown);
}
}

// ✅ ACTUALIZAR VISIBILIDAD DEL BUSCADOR SEGÚN ROL
function updateSearchVisibility() {
    const searchContainer = document.getElementById('designer-search-container');
    // ✅ MOSTRAR BUSCADOR PARA ADMIN Y DISEÑADOR
    if (isAdmin || isDesigner) {
        searchContainer.classList.remove('hidden');
        // ✅ INICIALIZAR EVENTOS SI ES LA PRIMERA VEZ
        if (!window.searchEventsInitialized) {
            initSearchEvents();
            window.searchEventsInitialized = true;
        }
    } else {
        searchContainer.classList.add('hidden');
        resetSearchHighlight();
        // ✅ OCULTAR MODAL DE ID NO ENCONTRADO
        document.getElementById('idNotFoundModal').style.display = 'none';
    }
}

// ✅ MODIFICAR FUNCIÓN modStatus PARA DETECTAR FINALIZADA Y USAR PANEL
async function modStatus(id, st) {
    const pill = document.getElementById('pill-' + id);
    const oldClass = pill.className;
    const oldText = pill.innerText;
    const newStatusClass = st.toLowerCase().replace(/\s+/g, '');
    pill.className = `status-pill status-${newStatusClass}`;
    pill.innerText = st;
    
    try {
        // ✅ SI ES FINALIZADA Y NO HAY DISEÑADOR ASIGNADO, MOSTRAR ALERTA EN PANEL
        if (st === "FINALIZADA") {
            const item = localData.find(x => x.id == id);
            if (!item?.Disenador) {
                // Abrir panel y mostrar mensaje
                selectRequest(id);
                openModal("⚠️ Atención", "Debes asignar un diseñador antes de finalizar la solicitud. Usa el panel lateral.", "👨‍🎨");
                // Revertir cambio visual
                pill.className = oldClass;
                pill.innerText = oldText;
                return;
            }
        }
        
        const params = new URLSearchParams();
        params.append("action", "updateStatus");
        params.append("id", id);
        params.append("status", st);
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        // ✅ VERIFICAR SI LA RESPUESTA ES JSON VÁLIDO
        const text = await response.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            console.error("Respuesta no válida del servidor:", text);
            throw new Error("Respuesta inválida del servidor");
        }
        
        if (data.success) {
            const item = localData.find(x => x.id == id);
            if(item) item.Estatus = st;
            renderLocalTable();
    updatePaginationControls();
        } else {
            throw new Error(data.error || "Error al actualizar estatus");
        }
    } catch (e) {
        pill.className = oldClass;
        pill.innerText = oldText;
        console.error("Error completo:", e);
        openModal("", "Error de conexión: " + e.message, "");
    }
}



// ACTUALIZAR CONTADORES (YA NO CALCULA, SOLO PINTA)
function updateCounters(stats) {
    if (!stats) return;

    // Contadores básicos
    document.getElementById('count-total').innerText = stats.total || 0;
    document.getElementById('count-pend').innerText = stats.pend || 0;
    document.getElementById('count-proc').innerText = stats.proc || 0;
    document.getElementById('count-fin').innerText = stats.fin || 0;

    // Contadores Admin
    document.getElementById('count-total-admin').innerText = stats.total || 0;
    document.getElementById('count-pend-admin').innerText = stats.pend || 0;
    document.getElementById('count-proc-admin').innerText = stats.proc || 0;
    document.getElementById('count-fin-admin').innerText = stats.fin || 0;
    document.getElementById('count-bermina-admin').innerText = stats.bermina || 0;
    document.getElementById('count-jorsy-admin').innerText = stats.jorsy || 0;
    document.getElementById('count-maria-admin').innerText = stats.maria || 0;
    document.getElementById('count-xamir-admin').innerText = stats.xamir || 0;

    // Visibilidad según rol
    if (isAdmin) {
        document.getElementById('stats-panel').style.display = 'none';
        document.getElementById('combined-stats').style.display = 'flex';
    } else {
        document.getElementById('stats-panel').style.display = 'flex';
        document.getElementById('combined-stats').style.display = 'none';
    }
    
    // Actualizar Headers
    updateSearchVisibility();
    if (isSearchActive && currentSearchId) applySearchHighlight(currentSearchId);
    if (isPanelOpen && selectedRequestId) updatePanelContent();
    
    // ✅ MOSTRAR/OCULTAR COLUMNAS SEGÚN ROL
    document.getElementById('th-admin').classList.toggle('hidden', !isAdmin);
    document.getElementById('th-designer').classList.toggle('hidden', !isDesigner);
}


// ✅ FUNCIÓN PARA ACTUALIZAR CONTROLES DE PAGINACIÓN - CORREGIDA
function updatePaginationControls() {
  // ✅ CORRECCIÓN: Calcular totalPages basado en totalRecords real
  const totalRecords = PAGINATION.totalRecords || localData.length;
  const totalPages = Math.ceil(totalRecords / PAGINATION.limit) || 1;
  
  // Actualizar objeto global
  PAGINATION.totalRecords = totalRecords;
  PAGINATION.totalPages = totalPages;
  
  // Asegurar que currentPage sea válida
  if (PAGINATION.currentPage < 1) PAGINATION.currentPage = 1;
  if (PAGINATION.currentPage > totalPages) PAGINATION.currentPage = totalPages;
  
  const start = (PAGINATION.currentPage - 1) * PAGINATION.limit + 1;
  const end = Math.min(PAGINATION.currentPage * PAGINATION.limit, totalRecords);
  
  document.getElementById('paginationStart').innerText = totalRecords > 0 ? start : 0;
  document.getElementById('paginationEnd').innerText = end;
  document.getElementById('paginationTotal').innerText = totalRecords;
  document.getElementById('currentPageIndicator').innerText = `${PAGINATION.currentPage} / ${totalPages}`;
  
  // Habilitar/Deshabilitar botones
  const btnFirst = document.getElementById('btnFirstPage');
  const btnPrev = document.getElementById('btnPrevPage');
  const btnNext = document.getElementById('btnNextPage');
  const btnLast = document.getElementById('btnLastPage');
  
  if (btnFirst) btnFirst.disabled = PAGINATION.currentPage === 1;
  if (btnPrev) btnPrev.disabled = PAGINATION.currentPage === 1;
  if (btnNext) btnNext.disabled = PAGINATION.currentPage >= totalPages;
  if (btnLast) btnLast.disabled = PAGINATION.currentPage >= totalPages;
  
  console.log(`📊 Paginación: Página ${PAGINATION.currentPage}/${totalPages} | Total: ${totalRecords} registros | Mostrando ${start}-${end}`);
}

// ✅ CACHE LOCAL PARA PAGINACIÓN INSTANTÁNEA
const PAGE_CACHE = {
  data: new Map(), // page -> {rows, stats, timestamp}
  maxPages: 10, // Mantener hasta 10 páginas en caché
  ttl: 5 * 60 * 1000, // 5 minutos
  
  // Guardar página en caché
  setPage(page, data) {
    this.data.set(page, {
      ...data,
      timestamp: Date.now()
    });
    
    // Limpiar páginas antiguas si excede el límite
    if (this.data.size > this.maxPages) {
      const oldestPage = Array.from(this.data.keys())[0];
      this.data.delete(oldestPage);
    }
  },
  
  // Obtener página desde caché
  getPage(page) {
    const cached = this.data.get(page);
    if (!cached) return null;
    
    // Verificar si no ha expirado
    if (Date.now() - cached.timestamp > this.ttl) {
      this.data.delete(page);
      return null;
    }
    
    return cached;
  },
  
  // Limpiar toda la caché
  clear() {
    this.data.clear();
  },
  
  // Verificar si una página está en caché
  hasPage(page) {
    return this.getPage(page) !== null;
  }
};

// ✅ FUNCIÓN changePage - VERSIÓN INSTANTÁNEA
async function changePage(action) {
  if (PAGINATION.isLoading) return;
  
  let newPage = PAGINATION.currentPage;
  const totalPages = PAGINATION.totalPages || 1;
  
  switch(action) {
    case 'first': newPage = 1; break;
    case 'prev': newPage = Math.max(1, PAGINATION.currentPage - 1); break;
    case 'next': newPage = Math.min(totalPages, PAGINATION.currentPage + 1); break;
    case 'last': newPage = totalPages; break;
  }
  
  console.log(`🔄 Cambiando página: ${PAGINATION.currentPage} -> ${newPage} (total: ${totalPages})`);
  
  if (newPage === PAGINATION.currentPage) return;
  
  // ✅ CAMBIO INSTANTÁNEO: Verificar si tenemos la página en caché
  const cachedPage = PAGE_CACHE.getPage(newPage);
  
  if (cachedPage) {
    // ✅ PÁGINA EN CACHÉ - CAMBIO INSTANTÁNEO
    console.log(`⚡ Página ${newPage} encontrada en caché - cambio instantáneo`);
    
    // Actualizar página actual
    PAGINATION.currentPage = newPage;
    
    // Actualizar datos locales inmediatamente
    localData = cachedPage.rows;
    
    // Renderizar inmediatamente sin loading
    renderLocalTable();
    updatePaginationControls();
    
    // Pre-cargar páginas adyacentes en background
    preloadAdjacentPages(newPage);
    
    return; // Salir early - no necesitamos consultar al servidor
  }
  
  // ✅ PÁGINA NO EN CACHÉ - Cargar con loading mínimo
  console.log(`📡 Página ${newPage} no está en caché - cargando desde servidor`);
  
  PAGINATION.isLoading = true;
  PAGINATION.currentPage = newPage;
  
  // Mostrar indicador sutil (no spinner completo)
  const body = document.getElementById('solicitudes-body');
  const originalContent = body.innerHTML;
  
  // Indicator minimalista
  body.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--turquesa);font-weight:600;font-size:0.9rem;">⚡ Cargando página ' + newPage + '...</td></tr>';
  
  try {
    // Forzar refresh para obtener la nueva página del servidor
    DATA_CACHE.data = null;
    DATA_CACHE.timestamp = 0;
    
    await updateTable(true);
    
    // Guardar en caché para futuros usos
    if (localData.length > 0) {
      PAGE_CACHE.setPage(newPage, {
        rows: [...localData],
        stats: DATA_CACHE.stats
      });
    }
    
    // Pre-cargar páginas adyacentes
    preloadAdjacentPages(newPage);
    
  } catch (e) {
    console.error("Error cambiando página:", e);
    openModal("❌ Error", "No se pudo cargar la página: " + e.message, "💥");
    
    // Revertir página y restaurar contenido
    PAGINATION.currentPage = newPage - (action === 'next' || action === 'last' ? 1 : -1);
    body.innerHTML = originalContent;
  } finally {
    PAGINATION.isLoading = false;
  }
}

// ✅ PRE-CARGA DE PÁGINAS ADYACENTES EN BACKGROUND
async function preloadAdjacentPages(currentPage) {
  const totalPages = PAGINATION.totalPages || 1;
  const pagesToPreload = [];
  
  // Pre-cargar página siguiente y anterior si no están en caché
  if (currentPage < totalPages && !PAGE_CACHE.hasPage(currentPage + 1)) {
    pagesToPreload.push(currentPage + 1);
  }
  
  if (currentPage > 1 && !PAGE_CACHE.hasPage(currentPage - 1)) {
    pagesToPreload.push(currentPage - 1);
  }
  
  // También pre-cargar primera y última si son diferentes
  if (!PAGE_CACHE.hasPage(1) && currentPage !== 1) {
    pagesToPreload.push(1);
  }
  
  if (!PAGE_CACHE.hasPage(totalPages) && currentPage !== totalPages) {
    pagesToPreload.push(totalPages);
  }
  
  // Limitar a 2 pre-cargas simultáneas para no sobrecargar
  const limitedPages = pagesToPreload.slice(0, 2);
  
  if (limitedPages.length > 0) {
    console.log(`🚀 Pre-cargando páginas: [${limitedPages.join(', ')}]`);
    
    // Ejecutar pre-cargas en paralelo sin bloquear UI
    limitedPages.forEach(async (page) => {
      try {
        await preloadPage(page);
      } catch (e) {
        console.warn(`⚠️ Error pre-cargando página ${page}:`, e);
      }
    });
  }
}

// ✅ FUNCIÓN PARA PRE-CARGAR UNA PÁGINA ESPECÍFICA
async function preloadPage(pageNum) {
  if (PAGE_CACHE.hasPage(pageNum)) return; // Ya está en caché
  
  try {
    const params = new URLSearchParams();
    params.append("action", "read");
    params.append("page", pageNum.toString());
    params.append("limit", PAGINATION.limit.toString());
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });
    
    const responseText = await res.text();
    const response = JSON.parse(responseText);
    
    if (response.success && response.data) {
      const data = response.data;
      
      // Guardar en caché
      PAGE_CACHE.setPage(pageNum, {
        rows: data.rows || [],
        stats: data.stats || null
      });
      
      console.log(`✅ Página ${pageNum} pre-cargada exitosamente`);
    }
  } catch (e) {
    console.warn(`⚠️ Error pre-cargando página ${pageNum}:`, e);
  }
}

function createRowElement(s, idx) {
    const tr = document.createElement('tr');
    
    const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
    const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
    const esNueva = (statusReal === "PENDIENTE");
    const esObituario = (s.Jornada || "").toLowerCase().includes("obituario");
    const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
    const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";
    
    if (esNueva) {
        tr.className = esObituario ? "row-obituario" : "row-new";
    }
    if (selectedRequestId === s.id) {
        tr.classList.add('row-selected-panel');
    }
    
    let badge = '';
    if (esNueva) {
        badge = esObituario 
            ? '<span class="badge-prioridad">PRIORIZAR</span>'
            : '<span class="badge-new">NEW</span>';
    }
    
    let designerPill = '';
    if (s.Disenador) {
        const color = designerColors[s.Disenador] || '#6c757d';
        designerPill = `<div class="designer-pill" style="background-color: ${color};" title="Diseñador: ${s.Disenador}"></div>`;
    }
    
    const icon = (s.Soportes && s.Soportes.includes("SÍ")) 
        ? ` (${s.Soportes.match(/\d+/) || 1})` 
        : "";
    
    const fechaEventoFormat = extraerFecha(s.Fecha);
    const horaEvento = s.Hora && s.Hora.trim() !== '' ? s.Hora : 'Sin hora';
    const isRegularUser = !isAdmin && !isDesigner;
    
    if (isRegularUser) {
        const fechaSolicitudFormat = extraerFecha(s.Timestamp);
        const horaSolicitudFormat = extraerHora(s.Timestamp);
        
        tr.innerHTML = `
            <td>
                <span class="txt-bold">${fechaSolicitudFormat}</span><br>
                <span class="txt-small">${horaSolicitudFormat}</span>
            </td>
            <td>
                <span class="txt-bold">${fechaEventoFormat}</span><br>
                <span class="txt-small">${horaEvento}</span>
            </td>
            <td class="txt-bold">${unidadLimpia} ${badge}</td>
            <td>${jornadaLimpia}</td>
            <td align="center">${icon}</td>
            <td>
                ${designerPill}
                <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
            </td>
        `;
    } else {
        // ADMIN O DISEÑADOR: Lógica de Iconos Condicional Robusta
        // Verificamos que ArteFinal exista y no esté vacío
        const hasArt = (s.ArteFinal && s.ArteFinal.trim() !== "" && s.ArteFinal !== "null");
        
        let actionIcon, actionText;

        if (hasArt) {
            // HAY ARCHIVO: Clip Verde
            actionIcon = '<span style="color: var(--verde); font-size: 1.3rem;">📎</span>';
            actionText = '<span style="color: var(--verde);">Archivo Adjunto</span>';
        } else {
            // NO HAY ARCHIVO: Mano Naranja
            actionIcon = '<span style="color: #fb8500; font-size: 1.3rem;">👆</span>';
            actionText = '<span>Click para seleccionar</span>';
        }

        tr.innerHTML = `
        <td>
            <span class="txt-bold">${s.id}</span>
            ${badge}
        </td>
        <td>
            <span class="txt-bold">${fechaEventoFormat}</span><br>
            <span class="txt-small">${horaEvento}</span>
        </td>
        <td class="txt-bold">${unidadLimpia}</td>
        <td>${jornadaLimpia}</td>
        <td align="center">${icon}</td>
        <td>
            ${designerPill}
            <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
        </td>
        <!-- COLUMNA DE ACCIONES CON ICONO CONDICIONAL Y TEXTO ALINEADO -->
        <td align="right" class="admin-actions-cell">
            <div class="admin-actions-content">
                ${actionIcon}
                ${actionText}
            </div>
        </td>
        `;
        
        // AGREGAR VERIFICACIÓN: Solo permitir selección si es admin o diseñador
        if (!isRegularUser) {
            tr.style.cursor = 'pointer';
            tr.addEventListener('click', function(e) {
                // VERIFICACIÓN ADICIONAL: No seleccionar si ya no es admin/diseñador
                if (!isAdmin && !isDesigner) return;
                // No seleccionar si se hizo click en un botón o enlace
                if (e.target.closest('button') || e.target.closest('a')) return;
                selectRequest(s.id);
            });
        }
    }
    
    return tr;
}

// ✅ FUNCIÓN UNIFICADA PARA MANEJO DE FECHAS - VERSIÓN ROBUSTA
function formatearFecha(valor, formato = 'datetime') {
  if (!valor || valor.toString().trim() === "") return "";
  
  var fechaObj;
  
  try {
    if (valor instanceof Date) {
      fechaObj = valor;
    } else if (typeof valor === 'string') {
      var texto = valor.trim().replace(/-/g, '/');
      var partes = texto.split(' ');
      var fechaPart = partes[0];
      
      // Formato dd/MM/yyyy
      if (fechaPart.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
        var dmy = fechaPart.split('/');
        var dia = parseInt(dmy[0], 10);
        var mes = parseInt(dmy[1], 10) - 1;
        var anio = parseInt(dmy[2], 10);
        
        var hora = 0, min = 0;
        if (partes[1]) {
          var tiempo = partes[1].split(':');
          hora = parseInt(tiempo[0], 10) || 0;
          min = parseInt(tiempo[1], 10) || 0;
        }
        
        fechaObj = new Date(anio, mes, dia, hora, min);
      }
      // Formato yyyy/MM/dd
      else if (fechaPart.match(/^\d{4}\/\d{1,2}\/\d{1,2}/)) {
        var iso = fechaPart.split('/');
        fechaObj = new Date(parseInt(iso[0]), parseInt(iso[1]) - 1, parseInt(iso[2]));
      }
      // Formato MM/dd/yyyy (US)
      else if (fechaPart.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}/)) {
        var us = fechaPart.split('/');
        var anio = us[2].length === 2 ? 2000 + parseInt(us[2]) : parseInt(us[2]);
        fechaObj = new Date(anio, parseInt(us[0]) - 1, parseInt(us[1]));
      }
      else {
        // Intentar parseo nativo como último recurso
        fechaObj = new Date(texto);
      }
    } else {
      return valor; // Devolver tal cual si no se puede parsear
    }
    
    if (!fechaObj || isNaN(fechaObj.getTime())) {
      console.warn("⚠️ Fecha inválida:", valor);
      return valor; // Devolver valor original en lugar de vacío
    }
    
    // Formatear según tipo
    var dd = String(fechaObj.getDate()).padStart(2, '0');
    var mm = String(fechaObj.getMonth() + 1).padStart(2, '0');
    var yyyy = fechaObj.getFullYear();
    
    if (formato === 'date') {
      return dd + '/' + mm + '/' + yyyy;
    } else if (formato === 'datetime') {
      var hh = String(fechaObj.getHours()).padStart(2, '0');
      var min = String(fechaObj.getMinutes()).padStart(2, '0');
      return dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + min;
    }
    
    return dd + '/' + mm + '/' + yyyy;
    
  } catch (e) {
    console.error("❌ Error formateando fecha:", valor, e);
    return valor || ""; // Devolver valor original o vacío
  }
}

function extraerFecha(dateTime) {
  if (!dateTime) return "";
  return dateTime.split(' ')[0] || "";
}

function extraerHora(dateTime) {
  if (!dateTime) return "";
  var partes = dateTime.trim().split(' ');
  if (partes.length < 2) return "Sin hora";
  var horaCompleta = partes.slice(1).join(' ');
  
  // Convertir a formato 12 horas con a. m./p. m.
  var horaPartes = horaCompleta.split(':');
  if (horaPartes.length >= 2) {
    var horas = parseInt(horaPartes[0]);
    var minutos = horaPartes[1];
    var ampm = horas >= 12 ? 'p. m.' : 'a. m.';
    horas = horas % 12;
    horas = horas ? horas : 12; // El 0 se convierte en 12
    return horas + ':' + minutos + ' ' + ampm;
  }
  
  return horaCompleta;
}

// ✅ FUNCIÓN renderLocalTable - CORREGIDA
function renderLocalTable() {
  const body = document.getElementById('solicitudes-body');
  body.innerHTML = "";
  
  // ✅ CORRECCIÓN: Usar PAGINATION.totalRecords que viene del servidor
  const totalRecords = PAGINATION.totalRecords || localData.length;
  const totalPages = Math.ceil(totalRecords / PAGINATION.limit) || 1;
  
  console.log(`📄 Renderizando: ${localData.length} registros en memoria de ${totalRecords} totales`);
  
  // Validar página actual
  if (PAGINATION.currentPage > totalPages) {
    PAGINATION.currentPage = totalPages;
  }
  if (PAGINATION.currentPage < 1) {
    PAGINATION.currentPage = 1;
  }
  
  // Calcular índices para mostrar
  const startIndex = (PAGINATION.currentPage - 1) * PAGINATION.limit;
  const endIndex = Math.min(startIndex + PAGINATION.limit, totalRecords);
  
  console.log(`📄 Página ${PAGINATION.currentPage}/${totalPages} - Registros ${startIndex + 1} a ${endIndex} de ${totalRecords}`);
  
  // ✅ IMPORTANTE: localData ya contiene solo los registros de la página actual del servidor
  // No hacer slice aquí porque el servidor ya paginó los datos
  const dataToRender = localData;
  
  const isRegularUser = !isAdmin && !isDesigner;
  
  dataToRender.forEach((s, idx) => {
    const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
    const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
    const esNueva = (statusReal === "PENDIENTE");
    const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
    const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";
    
    let badge = '';
    let rowClass = '';
    if (esNueva) {
      if (jornadaLimpia === "Obituario") {
        badge = '<span class="badge-prioridad">PRIORIZAR</span>';
        rowClass = "row-obituario";
      } else {
        badge = '<span class="badge-new">NEW</span>';
        rowClass = "row-new";
      }
    }
    
    let designerPill = '';
    if (s.Disenador) {
      const color = designerColors[s.Disenador] || '#6c757d';
      designerPill = `<div class="designer-pill" style="background-color: ${color};" title="Diseñador: ${s.Disenador}"></div>`;
    }
    
    let icon = '';
    if (s.Soportes && s.Soportes.includes("SÍ")) {
      const count = s.Soportes.match(/\d+/) || 1;
      icon = `<span style="color: var(--verde); font-size: 1.2rem;" title="${count} soporte(s) adjunto(s)">📷 <span style="font-size: 0.8rem; font-weight: 600;">${count}</span></span>`;
    } else {
      icon = `<span style="color: var(--rojo); font-size: 1.2rem;" title="Sin soportes">❌</span>`;
    }
    
    const fechaSolicitudFormat = extraerFecha(s.Timestamp);
    const horaSolicitudFormat = extraerHora(s.Timestamp);
    const fechaEventoFormat = extraerFecha(s.Fecha);
    const horaEvento = s.Hora && s.Hora.trim() !== '' ? s.Hora : 'Sin hora';
    
    const tr = document.createElement('tr');
    if(rowClass) tr.className = rowClass;
    
    if (selectedRequestId === s.id) {
      tr.classList.add('row-selected-panel');
    }
    
    if (isRegularUser) {
      tr.innerHTML = `
        <td>
          <span class="txt-bold">${fechaSolicitudFormat}</span><br>
          <span class="txt-small">${horaSolicitudFormat}</span>
        </td>
        <td>
          <span class="txt-bold">${fechaEventoFormat}</span><br>
          <span class="txt-small">${horaEvento}</span>
        </td>
        <td class="txt-bold">${unidadLimpia} ${badge}</td>
        <td>${jornadaLimpia}</td>
        <td align="center">${icon}</td>
        <td>
          ${designerPill}
          <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
        </td>
        <td></td>
      `;
    } else {
      const hasArt = (s.ArteFinal && s.ArteFinal.trim() !== "" && s.ArteFinal !== "null");
      let actionIcon, actionText;
      if (hasArt) {
        actionIcon = '<span style="color: var(--verde); font-size: 1.3rem;">📎</span>';
        actionText = '<span style="color: var(--verde);">Archivo Adjunto</span>';
      } else {
        actionIcon = '<span style="color: #fb8500; font-size: 1.3rem;">👆</span>';
        actionText = '<span>Click para seleccionar</span>';
      }
      
      tr.innerHTML = `
        <td>
          <span class="txt-bold">${s.id}</span>
          ${badge}
        </td>
        <td>
          <span class="txt-bold">${fechaEventoFormat}</span><br>
          <span class="txt-small">${horaEvento}</span>
        </td>
        <td class="txt-bold">${unidadLimpia}</td>
        <td>${jornadaLimpia}</td>
        <td align="center">${icon}</td>
        <td>
          ${designerPill}
          <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
        </td>
        <td align="right" class="admin-actions-cell">
          <div class="admin-actions-content">
            ${actionIcon}
            ${actionText}
          </div>
        </td>
      `;
      
      if (!isRegularUser) {
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', function(e) {
          if (!isAdmin && !isDesigner) return;
          if (e.target.closest('button') || e.target.closest('a')) return;
          selectRequest(s.id);
        });
      }
    }
    body.appendChild(tr);
  });
  
  // Actualizar headers según rol
  const thActions = isAdmin ? document.getElementById('th-admin') : document.getElementById('th-designer');
  const thId = document.querySelector('thead th:nth-child(1)');
  const thFechaEvento = document.querySelector('thead th:nth-child(2)');
  const thUnidad = document.querySelector('thead th:nth-child(3)');
  const thJornada = document.querySelector('thead th:nth-child(4)');
  
  if (isRegularUser) {
    if(thId) thId.innerHTML = '📅 FECHA SOLICITUD';
    if(thFechaEvento) thFechaEvento.innerHTML = '🗓️ FECHA EVENTO';
    if(thUnidad) thUnidad.innerHTML = '🏥 UNIDAD';
    if(thJornada) thJornada.innerHTML = '📋 TIPO SOLICITUD';
    document.getElementById('th-admin').classList.add('hidden');
    document.getElementById('th-designer').classList.add('hidden');
  } else {
    if(thId) thId.innerHTML = 'ID SOLICITUD';
    if(thFechaEvento) thFechaEvento.innerHTML = '🗓️ FECHA EVENTO';
    if(thUnidad) thUnidad.innerHTML = 'UNIDAD SOLICITANTE';
    if(thJornada) thJornada.innerHTML = 'TIPO SOLICITUD';
    
    if (isAdmin) {
      if(thActions) thActions.innerHTML = 'ACCIONES ADMIN';
      thActions.classList.remove('hidden');
      document.getElementById('th-designer').classList.add('hidden');
    } else if (isDesigner) {
      if(thActions) thActions.innerHTML = 'ACCIONES DISEÑO';
      thActions.classList.remove('hidden');
      document.getElementById('th-admin').classList.add('hidden');
    }
  }
  
  updateSearchVisibility();
  
  if (isSearchActive && currentSearchId) {
    applySearchHighlight(currentSearchId);
  }
  
  if (isPanelOpen && selectedRequestId) {
    updatePanelContent();
  }
  
  // ✅ ACTUALIZAR CONTROLES DE PAGINACIÓN AL FINAL
  updatePaginationControls();
}

// ✅ ABRIR PANEL CON DETECCIÓN DE DISPOSITIVO
function openSidePanel() {
    // Verificar permisos
    if (!isAdmin && !isDesigner) {
        console.log("⛔ Intento de abrir panel sin permisos");
        return;
    }
    
    const panel = document.getElementById('sidePanel');
    const overlay = document.getElementById('panelOverlay');
    
    if (!panel || !overlay) {
        console.error("❌ Elementos del panel no encontrados");
        return;
    }
    
    // ✅ Prevenir scroll del body cuando panel está abierto
    document.body.style.overflow = 'hidden';
    document.body.style.touchAction = 'none'; // ✅ Prevenir scroll táctil
    
    panel.classList.add('active');
    overlay.classList.add('active');
    isPanelOpen = true;
    
    // Actualizar contenido
    updatePanelContent();
    
    // ✅ INICIAR SINCRONIZACIÓN AUTOMÁTICA
    iniciarSincronizacionPanel();
    
    // ✅ AGREGAR EVENTO DE TECLA ESC PARA CERRAR
    document.addEventListener('keydown', handlePanelEscape);
    
    console.log("✅ Panel abierto");
}

// ✅ CERRAR PANEL MEJORADO
function closeSidePanel() {
    const panel = document.getElementById('sidePanel');
    const overlay = document.getElementById('panelOverlay');
    
    if (!panel || !overlay) return;
    
    panel.classList.remove('active');
    overlay.classList.remove('active');
    isPanelOpen = false;
    
    // ✅ RESTAURAR SCROLL DEL BODY
    document.body.style.overflow = '';
    document.body.style.touchAction = '';
    
    // ✅ DETENER SINCRONIZACIÓN
    if (panelSyncInterval) {
        clearInterval(panelSyncInterval);
        panelSyncInterval = null;
    }
    
    // ✅ REMOVER EVENTO DE TECLA ESC
    document.removeEventListener('keydown', handlePanelEscape);
    
    // Deseleccionar fila visualmente
    document.querySelectorAll('.row-selected-panel').forEach(row => {
        row.classList.remove('row-selected-panel');
    });
    
    console.log("✅ Panel cerrado");
}

// ✅ MANEJAR TECLA ESCAPE
function handlePanelEscape(e) {
    if (e.key === 'Escape' && isPanelOpen) {
        closeSidePanel();
    }
}

function selectRequest(id) {
    // Verificar permisos
    if (!isAdmin && !isDesigner) {
        console.log("⛔ Intento de selección sin permisos");
        return;
    }
    
    // Si ya está seleccionada, no hacer nada
    if (selectedRequestId === id && isPanelOpen) return;
    
    // En móvil, verificar que el click no fue un scroll
    if (window.innerWidth <= 768) {
        // Pequeño delay para distinguir click de scroll
        setTimeout(() => {
            completeSelectRequest(id);
        }, 50);
    } else {
        completeSelectRequest(id);
    }
}

function completeSelectRequest(id) {
    // Actualizar selección
    selectedRequestId = id;
    selectedRequestData = localData.find(x => x.id == id);
    
    // Abrir panel automáticamente
    openSidePanel();
    
    // Actualizar tabla para mostrar selección visual
    renderLocalTable();
    updatePaginationControls();
}

function updatePanelContent() {
    const container = document.getElementById('selectedRequestContent');
    const hasSelection = selectedRequestId && selectedRequestData;
    if (!hasSelection) {
        container.innerHTML = `
        <div class="no-selection">
            <div class="no-selection-icon">📭</div>
            <div>Selecciona una solicitud<br>de la tabla para activar<br>las acciones</div>
        </div>
        `;
        disableAllPanelButtons();
        updateFilePreview(null);
        return;
    }

    // Mostrar info de solicitud
    const esObituario = (selectedRequestData.Jornada || "").toLowerCase().includes("obituario");
    const badge = esObituario ? '<span class="badge-prioridad">PRIORIZAR</span>' :
        (selectedRequestData.Estatus === 'PENDIENTE' ? '<span class="badge-new">NEW</span>' : '');
    container.innerHTML = `
    <div class="selected-request-id">${selectedRequestId} ${badge}</div>
    <div class="selected-request-info">
        <strong>${selectedRequestData.Unidad}</strong><br>
        ${selectedRequestData.Jornada}<br>
        📅 ${selectedRequestData.Fecha} ${selectedRequestData.Hora ? '| ' + selectedRequestData.Hora : ''}
    </div>
    `;

    // Actualizar indicadores de estado (luces)
    const currentStatus = (selectedRequestData.Estatus || "").toUpperCase();
    document.getElementById('indPend').classList.toggle('active', currentStatus === 'PENDIENTE');
    document.getElementById('indProc').classList.toggle('active', currentStatus === 'PROCESANDO');
    document.getElementById('indFin').classList.toggle('active', currentStatus === 'FINALIZADA');

    // ✅ CORRECCIÓN: Habilitar botones según permisos (Esto activa los botones de estado)
    enablePanelButtons();

    // Referencias a elementos sensibles
    const designerSection = document.getElementById('designerAssignSection');
    const adminActionsSection = document.getElementById('adminActions');
    const statusActionsSection = document.getElementById('statusActions');
    const btnMaint = document.getElementById('btnMaint');
    const btnReportPanel = document.getElementById('btnReportPanel');

    // ✅ LÓGICA DE VISIBILIDAD POR ROL
    if (isAdmin) {
        // ADMIN: Acceso total (Estatus, Diseñadores, Mantenimiento, Reporte)
        designerSection.classList.remove('hidden');
        adminActionsSection.classList.remove('hidden');
        statusActionsSection.classList.remove('hidden');
        
        if(btnMaint) btnMaint.style.display = 'flex';
        if(btnReportPanel) btnReportPanel.style.display = 'flex';

        // Habilitar botones de asignación y eliminación
        document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = false);
        document.getElementById('btnEliminar').disabled = false;

        // Marcar diseñador seleccionado visualmente
        if (selectedRequestData?.Disenador) {
            document.querySelectorAll('.designer-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.includes(selectedRequestData.Disenador));
            });
        } else {
            document.querySelectorAll('.designer-btn').forEach(btn => btn.classList.remove('selected'));
        }

    } else if (isDesigner) {
        // DISEÑADOR: Solo Archivo. OCULTAR Estatus, Mantenimiento y Reporte.
        designerSection.classList.add('hidden');
        adminActionsSection.classList.add('hidden');
        statusActionsSection.classList.add('hidden'); // Ocultar botones de estado
        
        if(btnMaint) btnMaint.style.display = 'none'; // Ocultar Mantenimiento
        if(btnReportPanel) btnReportPanel.style.display = 'none'; // Ocultar Reporte
        
        document.getElementById('btnEliminar').disabled = true;

    } else {
        // USUARIO REGULAR: Sin acceso a panel de gestión
        designerSection.classList.add('hidden');
        adminActionsSection.classList.add('hidden');
        statusActionsSection.classList.add('hidden');
        
        if(btnMaint) btnMaint.style.display = 'none';
        if(btnReportPanel) btnReportPanel.style.display = 'none';
        
        document.getElementById('btnEliminar').disabled = true;
    }

    // Actualizar vista previa de archivo
    updateFilePreview(selectedRequestData.ArteFinal);

    // ✅ HABILITAR ACCIONES DE ARCHIVO (Común para Admin y Diseñador)
    // (Nota: enablePanelButtons ya habilita estos botones, pero esto asegura el estado de Telegram/Ver)
    const hasArt = !!selectedRequestData?.ArteFinal;
    document.getElementById('btnAdjuntar').disabled = !(isAdmin || isDesigner);
    document.getElementById('btnVerArte').disabled = !hasArt;
    document.getElementById('btnEnviarTG').disabled = !hasArt;
}

function updateFilePreview(arteUrl) {
    const container = document.getElementById('filePreviewContainer');
    const info = document.getElementById('filePreviewInfo');
    
    if (!arteUrl) {
        container.innerHTML = `
        <div class="file-preview-placeholder">
        <div class="file-preview-placeholder-icon">📎</div>
        <div>No hay archivo adjunto</div>
        </div>
        `;
        info.innerHTML = '';
        document.getElementById('btnVerArte').disabled = true;
        document.getElementById('btnEnviarTG').disabled = true;
        return;
    }
    
    // Extraer ID de archivo de Google Drive
    const fileIdMatch = arteUrl.match(/\/file\/d\/([-\w]{25,})/) || arteUrl.match(/[-\w]{25,}/);
    if (!fileIdMatch) {
        container.innerHTML = `
        <div class="file-preview-placeholder">
        <div class="file-preview-placeholder-icon">❓</div>
        <div>No se puede previsualizar</div>
        </div>
        `;
        return;
    }
    
    const fileId = fileIdMatch[1];
    // Usar thumbnail de Google Drive - IMAGEN COMPLETA A ESCALA REDUCIDA
    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
    
    container.innerHTML = `
    <img src="" class="file-preview-image-full" onclick="window.open('${arteUrl}', '_blank')" title="Click para ver en tamaño completo">
    `;
    
    // ✅ LAZY LOADING CON INTERSECTION OBSERVER
    const img = container.querySelector('img');
    if (img) {
        img.loading = 'lazy';
        img.setAttribute('data-src', thumbnailUrl);
        
        // ✅ CARGAR SÓLO CUANDO SEA VISIBLE
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.getAttribute('data-src');
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: '50px' });
        
        observer.observe(img);
    }
    
    info.innerHTML = '💾 Archivo adjunto disponible';
    
    document.getElementById('btnVerArte').disabled = false;
    document.getElementById('btnEnviarTG').disabled = false;
}

function disableAllPanelButtons() {
    const buttons = document.querySelectorAll('.panel-btn:not(#btnMaint):not(#btnReport)');
    buttons.forEach(btn => btn.disabled = true);
    document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = true);
}

function enablePanelButtons() {
    // Botones de estado (Admin y Diseñador pueden cambiar estado)
    document.getElementById('btnStatusPend').disabled = false;
    document.getElementById('btnStatusProc').disabled = false;
    document.getElementById('btnStatusFin').disabled = false;
    
    // Botones de archivo
    document.getElementById('btnAdjuntar').disabled = false;
    document.getElementById('btnVerArte').disabled = !selectedRequestData?.ArteFinal;
    document.getElementById('btnEnviarTG').disabled = !selectedRequestData?.ArteFinal;
    
    // Botones especiales de Admin
    if (isAdmin) {
        document.getElementById('btnEliminar').disabled = false;
        document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = false);
    }
}

// ✅ ACCIONES DEL PANEL
async function changeStatus(newStatus) {
    if (!selectedRequestId) return;
    
    // Si es finalizada y no hay diseñador asignado (solo admin), mostrar alerta
    if (newStatus === 'FINALIZADA' && isAdmin && !selectedRequestData?.Disenador) {
        openModal("⚠️ Atención", "Debes asignar un diseñador antes de finalizar la solicitud.", "👨‍🎨");
        return;
    }
    
    document.getElementById('loadMainTxt').innerText = "Actualizando estado...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        // === REEMPLAZAR EL FETCH POR ===
        const result = await batchRequest('updateStatus', {
            id: selectedRequestId,
            status: newStatus,
            username: userCredentials.username,
            password: userCredentials.password
        });
        
        const data = result;
        
        if (data.success) {
            // Actualizar datos locales
            const item = localData.find(x => x.id == selectedRequestId);
            if (item) {
                item.Estatus = newStatus;
                selectedRequestData = item;
            }
            
            // Actualizar panel y tabla
            updatePanelContent();
            renderLocalTable();
            updatePaginationControls();
            
            showToast(`🔄 Estado cambiado a ${newStatus}`, "success", 2000);
        } else {
            throw new Error(data.error || "Error al actualizar estado");
        }
    } catch (e) {
        console.error("Error completo:", e);
        openModal("❌ Error", e.message, "💥");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

async function assignDesigner(designerName) {
    if (!isAdmin || !selectedRequestId) return;
    
    document.getElementById('loadMainTxt').innerText = "Asignando diseñador...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const params = new URLSearchParams();
        params.append("action", "assignDesigner");
        params.append("id", selectedRequestId);
        params.append("disenador", designerName);
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        // ✅ VERIFICAR SI LA RESPUESTA ES JSON VÁLIDO
        const text = await response.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            console.error("Respuesta no válida del servidor:", text);
            throw new Error("Respuesta inválida del servidor");
        }
        
        if (data.success) {
            // Actualizar datos locales
            const item = localData.find(x => x.id == selectedRequestId);
            if (item) {
                item.Disenador = designerName;
                selectedRequestData = item;
            }
            
            // Actualizar UI
            document.querySelectorAll('.designer-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.includes(designerName)) {
                    btn.classList.add('selected');
                }
            });
            
            // ✅ ACTUALIZAR CONTENIDO DEL PANEL PARA REFLEJAR CAMBIOS
            updatePanelContent();
            renderLocalTable();
            updatePaginationControls();
            showToast(`👨‍🎨 ${designerName} asignado`, "success", 2000);
        } else {
            throw new Error(data.error || "Error al asignar diseñador");
        }
    } catch (e) {
        console.error("Error completo:", e);
        openModal("❌ Error", e.message, "💥");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function panelAdjuntarArte() {
    if (!selectedRequestId) return;
    openArteModal(selectedRequestId);
}

function panelVerArte() {
    if (!selectedRequestData?.ArteFinal) return;
    window.open(selectedRequestData.ArteFinal, '_blank');
}

async function panelEnviarTelegram() {
    if (!selectedRequestId || !selectedRequestData?.ArteFinal) return;
    
    if(!confirm("¿Enviar el arte de " + selectedRequestId + " a Telegram?")) return;
    
    document.getElementById('loadMainTxt').innerText = "Enviando a Telegram...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const params = new URLSearchParams();
        params.append("action", "sendTelegramArte");
        params.append("id", selectedRequestId);
        
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const data = await res.json();
        
        if(data.success) {
            openModal("✈️ Telegram", "¡Enviado a Telegram en alta calidad!", "📲");
        } else {
            throw new Error(data.error);
        }
    } catch (e) {
        openModal("❌ Error", e.message, "💥");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function panelEliminar() {
    if (!isAdmin || !selectedRequestId) return;
    deleteReq(selectedRequestId);
}

// ✅ POLLING PARA SINCRONIZACIÓN EN TIEMPO REAL
function iniciarSincronizacionPanel() {
    if (panelSyncInterval) clearInterval(panelSyncInterval);
    
    // Actualizar panel cada 30 segundos si está abierto
    panelSyncInterval = setInterval(() => {
        if (isPanelOpen && selectedRequestId) {
            actualizarDatosPanel();
        }
    }, 30000); // 30 segundos
}

async function actualizarDatosPanel() {
    if (!selectedRequestId) return;
    
    try {
        const params = new URLSearchParams();
        params.append("action", "getRequestData");
        params.append("id", selectedRequestId);
        
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        const data = await res.json();
        
        if (data.success && data.data) {
            // Actualizar datos locales
            const index = localData.findIndex(x => x.id == selectedRequestId);
            if (index !== -1) {
                localData[index] = data.data;
                selectedRequestData = data.data;
                updatePanelContent();
            }
        }
    } catch (e) {
        console.error("Error sincronizando panel:", e);
    }
}

// ✅ FUNCIONES PARA REPORTE MENSUAL - SOLO ADMIN
function generateMonthlyReport() {
if (!isAdmin) {
openModal("❌ Acceso Denegado", "Solo los administradores pueden generar reportes.", "🔐");
return;
}

// Verificar que sea el primer día del mes
const today = new Date();
if (today.getDate() !== 1) {
openModal("⏳ No disponible", "El reporte mensual solo está disponible el primer día de cada mes.", "📊");
return;
}

// ✅ CONFIRMACIÓN NATIVA DEL NAVEGADOR (SEGURA Y BLOQUEANTE)
if (!confirm("⚠️ ¿CONFIRMA que desea generar el reporte mensual del mes anterior?\n" +
"✅ Se enviará por correo y Telegram\n" +
"✅ Luego se eliminarán SOLO las solicitudes finalizadas con fecha de registro del mes anterior\n" +
"ℹ️ Las solicitudes creadas HOY (1° de mes) NO serán eliminadas\n" +
"⚠️ Esta acción es IRREVERSIBLE para las del mes anterior")) {
return;
}

document.getElementById('loadMainTxt').innerText = "Generando reporte mensual...";
document.getElementById('loadingOverlay').style.display = 'flex';

// Funcion auxiliar para esperar
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// Primero generar el reporte, LUEGO eliminar las finalizadas
fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=generateMonthlyReport&username=${encodeURIComponent(userCredentials.username)}&password=${encodeURIComponent(userCredentials.password)}`
})
.then(response => response.json())
.then(async data => {
if (data.success) {
openModal("✅ Reporte Generado",
"El reporte mensual ha sido generado y enviado correctamente.\n" +
"Ahora se procederá a eliminar las solicitudes finalizadas del mes anterior.",
"📊");
await delay(2000);
document.getElementById('loadMainTxt').innerText = "Eliminando solicitudes finalizadas del mes anterior...";
const deleteResponse = await fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=deleteFinalizadas&username=${encodeURIComponent(userCredentials.username)}&password=${encodeURIComponent(userCredentials.password)}`
});
const deleteData = await deleteResponse.json();
if (deleteData.success) {
openModal("✅ Limpieza Completada",
`Reporte generado y ${deleteData.count || 0} solicitudes finalizadas eliminadas correctamente.`,
"📊");
updateTable();
} else {
throw new Error(deleteData.error || "Error al limpiar solicitudes");
}
} else {
throw new Error(data.error || "Error al generar el reporte");
}
})
.catch(err => {
openModal("❌ Error", "Error: " + err.message, "💥");
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}

// ✅ FUNCIÓN PARA ACTUALIZAR EL ESTADO DEL BOTÓN DE REPORTE (HEADER Y PANEL)
function updateReportButtonStatus() {
const today = new Date();
const currentDay = today.getDate();
const totalDaysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
const btnHeader = document.getElementById('reportBtn');
const btnPanel = document.getElementById('btnReportPanel');
const textHeader = document.getElementById('reportBtnText');
const textPanel = document.getElementById('reportBtnTextPanel');
const daysHeader = document.getElementById('reportBtnDays');
const daysPanel = document.getElementById('reportBtnDaysPanel');

// Calcular días restantes
let daysRemaining;
let isAvailable = currentDay === 1;

if (currentDay === 1) {
daysRemaining = 0;
} else {
daysRemaining = totalDaysInMonth - currentDay + 1;
}

// Función auxiliar para actualizar un botón
function updateBtn(btn, text, daysBadge, isPanel) {
if (!btn) return;

if (isAvailable) {
daysBadge.textContent = 'Hoy';
daysBadge.classList.add('show');
btn.disabled = false;
btn.style.cursor = 'pointer';
text.style.opacity = '1';
btn.style.background = 'linear-gradient(to right, #2d6a4f 100%, #1e4a35 100%)';
} else {
daysBadge.textContent = `${daysRemaining}d`;
daysBadge.classList.add('show');
btn.disabled = true;
btn.style.cursor = 'not-allowed';
text.style.opacity = '0.7';

// Calcular progreso
const progress = ((totalDaysInMonth - daysRemaining) / totalDaysInMonth) * 100;
btn.style.background = `linear-gradient(to right, #2d6a4f ${progress}%, #1e4a35 ${progress}%)`;
}
}

// Actualizar ambos botones (si existen)
updateBtn(btnHeader, textHeader, daysHeader, false);
updateBtn(btnPanel, textPanel, daysPanel, true);
}

function checkFirstDayOfMonth() {
if (isAdmin) {
// Mostrar/ocultar botón de header (legacy, ahora siempre oculto en header)
const reportBtnHeader = document.getElementById('reportBtn');
const reportBtnPanel = document.getElementById('btnReportPanel');
const maintBtn = document.getElementById('maintBtn');

// Ocultar botones del header
if (reportBtnHeader) reportBtnHeader.classList.add('hidden');
if (maintBtn) maintBtn.classList.add('hidden');

// Mostrar botón en panel
if (reportBtnPanel) reportBtnPanel.classList.remove('hidden');

updateReportButtonStatus();

// Actualizar cada minuto
if (window.reportInterval) clearInterval(window.reportInterval);
window.reportInterval = setInterval(updateReportButtonStatus, 60000);
}
}

// ✅ CORRECCIÓN CRÍTICA: Manejo de fotos con atributo data-has-image
function handleFile(input, imgId, btnId) {
  if (modoObituario) {
    input.value = "";
    return;
  }
  const file = input.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.getElementById(imgId);
      img.src = e.target.result; // "image/jpeg;base64,..."
      img.style.display = 'block';
      document.getElementById(btnId).style.display = 'block';
      // ✅ MARCADOR DE IMAGEN VÁLIDA
      img.setAttribute('data-has-image', 'true');
    };
    reader.readAsDataURL(file);
  }
}

function clearFile(inputId, imgId, btnId) {
  if (modoObituario) return;
  document.getElementById(inputId).value = "";
  const img = document.getElementById(imgId);
  img.src = "";
  img.style.display = 'none';
  img.removeAttribute('data-has-image'); // ✅ Eliminar marca de imagen válida
  document.getElementById(btnId).style.display = 'none';
}

// ✅ FUNCIÓN PARA ELIMINAR field-error AUTOMÁTICAMENTE
function setupFieldErrorRemoval() {
  ['fecha', 'hora', 'institucion', 'direccion-exacta', 'tlf', 'mail', 'observaciones'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => el.classList.remove('field-error'));
      el.addEventListener('focus', () => el.classList.remove('field-error'));
    }
  });

  document.querySelectorAll('#region-grid .card-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('region-grid').classList.remove('field-error');
    });
  });

  const unidadGrid = document.getElementById('unidad-grid');
  const observer = new MutationObserver(() => {
    unidadGrid.querySelectorAll('.card-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('unidad-grid').classList.remove('field-error');
      });
    });
  });
  observer.observe(unidadGrid, { childList: true });

  document.querySelectorAll('#cat-grid .card-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('cat-grid').classList.remove('field-error');
    });
  });

  const cont3 = document.getElementById('cont-3');
  const observer3 = new MutationObserver(() => {
    cont3.querySelectorAll('.card-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('sec-3').classList.remove('field-error');
      });
    });

    const descOtro = document.getElementById('desc-otro');
    if (descOtro) {
      descOtro.addEventListener('input', () => document.getElementById('sec-3').classList.remove('field-error'));
      descOtro.addEventListener('focus', () => document.getElementById('sec-3').classList.remove('field-error'));
    }
  });
  observer3.observe(cont3, { childList: true, subtree: true });

  document.getElementById('btn-am').addEventListener('click', () => document.getElementById('hora-box').classList.remove('field-error'));
  document.getElementById('btn-pm').addEventListener('click', () => document.getElementById('hora-box').classList.remove('field-error'));
}

document.addEventListener('DOMContentLoaded', () => {
const regionGrid = document.getElementById('region-grid');
ORDEN_REGIONES.forEach(regionKey => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = getNombreRegionLimpio(regionKey);
btn.onclick = () => selectRegion(regionKey);
regionGrid.appendChild(btn);
});
updateTable();
setupFieldErrorRemoval();

// ✅ INICIALIZAR MODAL DE BIENVENIDA
initializeWelcomeModal();

// ✅ VERIFICAR PRIMERA VISITA DEL DÍA Y MOSTRAR MODAL
(async () => {
    try {
        const ip = await detectIP();
        if (isFirstVisitToday(ip)) {
            await showWelcomeModal();
            markTodayVisit(ip);
        }
    } catch (error) {
        console.log('Error checking first visit:', error);
    }
})();

// ✅ PRECARGA INTELIGENTE EN BACKGROUND
setTimeout(() => {
    if (!DATA_CACHE.data && !DATA_CACHE.isLoading) {
        console.log("🚀 Iniciando precarga inteligente en background...");
        updateTable();
    }
}, 2000);

// ✅ INICIAR SINCRONIZACIÓN AUTOMÁTICA AL CARGAR
iniciarSincronizacionPanel();

// ✅ INICIALIZAR CONTROLES DE PAGINACIÓN
updatePaginationControls();

// ✅ INICIALIZAR EVENTOS TOUCH DEL PANEL
function initPanelTouchEvents() {
    const sidePanel = document.getElementById('sidePanel');
    if (!sidePanel) return;
    
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    
    // Eventos touch para móvil
    sidePanel.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            startX = e.touches[0].clientX;
            isDragging = true;
            sidePanel.style.transition = 'none';
        }
    }, { passive: true });
    
    sidePanel.addEventListener('touchmove', (e) => {
        if (!isDragging || e.touches.length !== 1) return;
        
        currentX = e.touches[0].clientX;
        const deltaX = currentX - startX;
        
        // Permitir arrastre solo hacia la derecha (para cerrar)
        if (deltaX > 0) {
            sidePanel.style.transform = `translateX(${deltaX}px)`;
        }
    }, { passive: true });
    
    sidePanel.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        
        isDragging = false;
        const deltaX = currentX - startX;
        sidePanel.style.transition = 'transform 0.3s ease';
        
        // Si el arrastre fue significativo, cerrar el panel
        if (deltaX > 100) {
            closeSidePanel();
        } else {
            // Volver a la posición original
            sidePanel.style.transform = '';
        }
    }, { passive: true });
    
    // Prevenir zoom accidental en el panel
    sidePanel.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    }, { passive: false });
}

initPanelTouchEvents();
});

function selectRegion(regionKey) {
document.querySelectorAll('#region-grid .card-btn').forEach(b => b.classList.remove('selected'));
const index = ORDEN_REGIONES.indexOf(regionKey);
if (index !== -1) {
document.querySelector(`#region-grid .card-btn:nth-child(${index + 1})`).classList.add('selected');
}
selectedRegionKey = regionKey;
selectedUnidad = "";
const unidadGrid = document.getElementById('unidad-grid');
unidadGrid.innerHTML = "";
const unidades = UNIDADES_IPASME[regionKey] || [];
unidades.forEach(unidad => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = unidad.trim();
btn.onclick = () => selectUnidad(unidad.trim());
unidadGrid.appendChild(btn);
});
document.getElementById('unidad-section').classList.remove('hidden');
}

function selectUnidad(unidad) {
selectedUnidad = unidad.trim();
document.querySelectorAll('#unidad-grid .card-btn').forEach(b => b.classList.remove('selected'));
const clickedBtn = Array.from(document.querySelectorAll('#unidad-grid .card-btn'))
.find(b => b.innerText.trim() === selectedUnidad);
if (clickedBtn) clickedBtn.classList.add('selected');
}

// FUNCIÓN TOGGLE MODO OBITUARIO ACTUALIZADA
function toggleObituario() {
    // Esta función ahora es un toggle manual (por si se necesita en el futuro)
    // Pero el flujo principal es automático al seleccionar la categoría
    
    modoObituario = !modoObituario;
    
    if (modoObituario) {
        applyObituarioStyles();
    } else {
        removeObituarioStyles();
    }
    
    // Actualizar visual del botón si existe (legacy)
    const btn = document.getElementById('btn-obituario');
    if (btn) {
        if (modoObituario) {
            btn.classList.add('obit-active');
            btn.innerText = "OBITUARIO ACTIVO";
        } else {
            btn.classList.remove('obit-active');
            btn.innerText = "OBITUARIO";
        }
    }
}

// === FUNCIONES DE SEGURIDAD Y LIMPIEZA ===
function clearCredentials() {
document.getElementById('adminUser').value = '';
document.getElementById('adminPass').value = '';
}

function togglePass() {
const input = document.getElementById('adminPass');
input.type = input.type === 'password' ? 'text' : 'password';
}

// ============================================================
// SISTEMA DE TOASTS (Notificaciones no bloqueantes)
// ============================================================

/**
 * Muestra un toast notification
 * @param {string} message - Mensaje a mostrar
 * @param {string} type - 'success' | 'error' | 'warning' | 'info'
 * @param {number} duration - Duración en ms (default: 3000)
 * @param {function} onClose - Callback al cerrar (opcional)
 */
function showToast(message, type = 'info', duration = 3000, onClose = null) {
    const colors = {
        success: { bg: '#2d6a4f', icon: '✅', border: '#40916c' },
        error:   { bg: '#e63946', icon: '❌', border: '#c62828' },
        warning: { bg: '#fb8500', icon: '⚠️', border: '#e85d04' },
        info:    { bg: '#219ebc', icon: 'ℹ️', border: '#023047' }
    };
    
    const style = colors[type] || colors.info;
    
    // Crear elemento toast
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
        <div class="toast-icon">${style.icon}</div>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
    `;
    
    // Aplicar estilos inline (o usar CSS classes)
    Object.assign(toast.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        background: style.bg,
        color: 'white',
        padding: '15px 20px',
        borderRadius: '12px',
        boxShadow: '0 4px 20px rgba(0,0,0,0.3)',
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        minWidth: '280px',
        maxWidth: '400px',
        zIndex: '99999',
        fontFamily: "'Georama', sans-serif",
        fontWeight: '600',
        fontSize: '0.95rem',
        borderLeft: `4px solid ${style.border}`,
        animation: 'toastSlideIn 0.3s ease-out',
        cursor: 'default'
    });
    
    // Estilo del icono
    const iconEl = toast.querySelector('.toast-icon');
    Object.assign(iconEl.style, {
        fontSize: '1.4rem',
        flexShrink: '0'
    });
    
    // Estilo del mensaje
    const msgEl = toast.querySelector('.toast-message');
    Object.assign(msgEl.style, {
        flex: '1',
        lineHeight: '1.4'
    });
    
    // Estilo del botón cerrar
    const closeEl = toast.querySelector('.toast-close');
    Object.assign(closeEl.style, {
        background: 'rgba(255,255,255,0.2)',
        border: 'none',
        color: 'white',
        width: '28px',
        height: '28px',
        borderRadius: '50%',
        cursor: 'pointer',
        fontSize: '1.2rem',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        flexShrink: '0',
        transition: 'all 0.2s'
    });
    
    closeEl.onmouseenter = () => {
        closeEl.style.background = 'rgba(255,255,255,0.4)';
        closeEl.style.transform = 'scale(1.1)';
    };
    closeEl.onmouseleave = () => {
        closeEl.style.background = 'rgba(255,255,255,0.2)';
        closeEl.style.transform = 'scale(1)';
    };
    
    // Agregar al DOM
    document.body.appendChild(toast);
    
    // Auto-cerrar con animación
    const timeout = setTimeout(() => {
        closeToast(toast, onClose);
    }, duration);
    
    // Permitir cerrar manualmente sin ejecutar callback
    closeEl.onclick = () => {
        clearTimeout(timeout);
        closeToast(toast, null); // No ejecutar callback al cerrar manual
    };
    
    // Pausar al hover
    toast.onmouseenter = () => clearTimeout(timeout);
    toast.onmouseleave = () => {
        setTimeout(() => closeToast(toast, onClose), 1000);
    };
}

function closeToast(toast, callback) {
    toast.style.animation = 'toastSlideOut 0.3s ease-in forwards';
    setTimeout(() => {
        toast.remove();
        if (callback && typeof callback === 'function') {
            callback();
        }
    }, 300);
}

// Agregar animaciones CSS al head
const toastStyles = document.createElement('style');
toastStyles.textContent = `
    @keyframes toastSlideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes toastSlideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    .toast-notification:hover {
        transform: scale(1.02) !important;
    }
`;
document.head.appendChild(toastStyles);

function openModal(t, m, icon = "⚠️") {
clearCredentials();
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden'); // SIEMPRE MOSTRAR BOTÓN X
document.getElementById('modalIcon').innerText = icon;
document.getElementById('modalTitle').innerText = t;
document.getElementById('modalMsg').innerText = m;
const btn = document.getElementById('mainModalBtn');
btn.innerText = "ENTENDIDO";
btn.onclick = closeModal;
document.getElementById('modalAlert').style.display = 'flex';
}

// CERRAR MODAL - CORREGIDA
function closeModal() {
    const modal = document.getElementById('modalAlert');
    if (!modal) return;
    
    // Reiniciar todos los elementos del modal
    clearCredentials();
    
    // Limpiar áreas específicas
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    if (loginArea) loginArea.classList.add('hidden');
    if (uploadArea) uploadArea.classList.add('hidden');
    
    // Restaurar botones a estado por defecto
    const mainBtn = document.getElementById('mainModalBtn');
    const closeBtn = document.getElementById('closeModalBtn');
    
    if (mainBtn) {
        mainBtn.classList.remove('hidden');
        mainBtn.innerText = "ENTENDIDO";
        mainBtn.onclick = closeModal;
        mainBtn.style.display = 'block';
    }
    
    if (closeBtn) {
        closeBtn.classList.remove('hidden');
        closeBtn.onclick = () => {
            resetChunkUploadState();
            closeModal();
        };
    }
    
    // Limpiar input de archivo
    const arteFile = document.getElementById('arteFile');
    if (arteFile) arteFile.value = '';
    
    // Limpiar ID actual
    const currentReqId = document.getElementById('currentReqId');
    if (currentReqId) currentReqId.value = '';
    
    // Ocultar modal
    modal.style.display = 'none';
    
    // Forzar reinicio de progreso si existe
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
    const progressInfo = document.getElementById('progressInfo');
    const progressSpeed = document.getElementById('progressSpeed');
    const progressETA = document.getElementById('progressETA');
    const btnPauseResume = document.getElementById('btnPauseResume');
    const btnCancelUpload = document.getElementById('btnCancelUpload');
    
    if (progressBar) progressBar.style.width = '0%';
    if (progressPercent) progressPercent.innerText = '0%';
    if (progressStatus) progressStatus.innerText = '';
    if (progressInfo) progressInfo.innerText = '';
    if (progressSpeed) progressSpeed.innerText = '';
    if (progressETA) progressETA.innerText = '';
    
    // Restaurar botón de pausa/reanudar
    if (btnPauseResume) {
        btnPauseResume.innerHTML = '⏸️ Pausar';
        btnPauseResume.style.display = 'none';
    }
    
    // Restaurar botón de cancelar
    if (btnCancelUpload) {
        btnCancelUpload.style.display = 'none';
    }
    
    // ✅ OCULTAR BARRA DE PROGRESO DEL LOGIN
    const loginProgressBar = document.getElementById('loginProgressBar');
    if (loginProgressBar) {
        loginProgressBar.style.display = 'none';
        // Restaurar estilos por defecto
        const progressBarInner = document.getElementById('loginProgressBarInner');
        const progressText = document.getElementById('loginProgressText');
        const progressStatus = document.getElementById('loginProgressStatus');
        if (progressBarInner) {
            progressBarInner.style.width = '0%';
            progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
        }
        if (progressText) {
            progressText.innerText = 'Verificando credenciales...';
            progressText.style.color = '';
        }
        if (progressStatus) {
            progressStatus.innerText = 'Conectando con el servidor...';
            progressStatus.style.color = '';
        }
    }
    
    // Limpiar animación del icono del modal
    const modalIcon = document.getElementById('modalIcon');
    if (modalIcon) {
        modalIcon.style.animation = '';
    }
    
    // Reiniciar estado de chunks
    resetChunkUploadState();
}

function showLogin() {
clearCredentials();
document.getElementById('modalIcon').innerText = "🔐";
document.getElementById('modalTitle').innerText = "Bienvenido a SIRA 3.0 Reborn";
document.getElementById('modalMsg').innerText = "Ingrese sus credenciales para acceder al sistema.";
document.getElementById('loginArea').classList.remove('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden');
const btn = document.getElementById('mainModalBtn');
btn.innerText = "VALIDAR CREDENCIALES";
btn.onclick = validateLogin;
document.getElementById('modalAlert').style.display = 'flex';

// Agregar animación del candado
const modalIcon = document.getElementById('modalIcon');
modalIcon.style.animation = 'iconPulse 1s ease-in-out infinite';

const userField = document.getElementById('adminUser');
const passField = document.getElementById('adminPass');
const handleEnter = (e) => {
if (e.key === 'Enter') {
validateLogin();
}
};
userField.addEventListener('keydown', handleEnter);
passField.addEventListener('keydown', handleEnter);
}

// LOGIN CORREGIDO (NO FALLA SI LA TABLA TARDA)
async function validateLogin() {
    if (isLoggingIn) return;
    isLoggingIn = true;
    
    // ✅ OCULTAR CONTRASEÑA AUTOMÁTICAMENTE ANTES DE VALIDAR
    const passField = document.getElementById('adminPass');
    if (passField.type === 'text') {
        passField.type = 'password';
    }
    
    const u = document.getElementById('adminUser').value.trim();
    const p = document.getElementById('adminPass').value.trim();
    const btn = document.getElementById('mainModalBtn');
    const originalBtnText = btn.innerText;
    
    btn.disabled = true;
    btn.innerText = "Verificando...";
    
    if (!u || !p) {
        openModal("❌ Error", "Complete ambos campos.", "🔐");
        isLoggingIn = false;
        btn.disabled = false;
        btn.innerText = originalBtnText;
        return;
    }
    
    // ✅ MOSTRAR BARRA DE PROGRESO EN EL MODAL (en lugar de loadingOverlay)
    const progressBar = document.getElementById('loginProgressBar');
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');

    progressBar.style.display = 'block';
    progressBarInner.style.width = '0%';
    progressPercent.innerText = '0%';
    progressText.innerText = 'Verificando credenciales...';
    progressStatus.innerText = 'Conectando con el servidor...';

    // ✅ SIMULAR PROGRESO ANIMADO
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBarInner.style.width = progress + '%';
            progressPercent.innerText = Math.round(progress) + '%';
            
            // Cambiar texto según el progreso
            if (progress < 30) {
                progressStatus.innerText = 'Conectando con el servidor...';
            } else if (progress < 60) {
                progressStatus.innerText = 'Validando credenciales...';
            } else if (progress < 85) {
                progressStatus.innerText = 'Obteniendo permisos de acceso...';
            } else {
                progressStatus.innerText = 'Finalizando...';
            }
        }
    }, 300);
    
    try {
        const params = new URLSearchParams();
        params.append("action", "loginAdmin");
        params.append("username", u);
        params.append("password", p);
        
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        
        const text = await res.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            throw new Error("Respuesta inválida del servidor");
        }
        
        if (data.success && data.data) {
            // ✅ LOGIN EXITOSO - Completar barra al 100%
            clearInterval(progressInterval);
            progressBarInner.style.width = '100%';
            progressPercent.innerText = '100%';
            progressText.innerText = '¡Acceso concedido!';
            progressStatus.innerText = 'Redirigiendo...';
            progressStatus.style.color = 'var(--verde)';
            
            // ✅ LOGIN EXITOSO
            userCredentials = {
                username: u,
                password: p,
                displayName: data.data.displayName || u,
                role: data.data.role || "admin",
                designerName: data.data.designerName || ""
            };
            isAdmin = data.data.isAdmin || false;
            isDesigner = data.data.isDesigner || false;
            
            // Esperar un momento para mostrar el 100% antes de cerrar
            setTimeout(() => {
                // Actualizar UI
                document.getElementById('userNameDisplay').innerText = userCredentials.displayName + (isDesigner ? " (Diseñador)" : "");
                document.getElementById('welcomeMessage').classList.add('show');
                document.getElementById('authBtn').className = "btn-logout";
                document.getElementById('authBtn').innerText = "Cerrar Sesión";
                document.getElementById('authBtn').onclick = logout;
                
                // ✅ MOSTRAR TAB DE ESTADÍSTICAS PARA ADMIN Y DISEÑADOR
                if (isAdmin || isDesigner) {
                    document.getElementById('tab-stats').classList.remove('hidden');
                }
                
                clearCredentials();
                
                // Ocultar barra de progreso y cerrar modal
                progressBar.style.display = 'none';
                closeModal();
                
                // Cargar datos en segundo plano
                DATA_CACHE.data = null;
                updateTable(true).catch(err => {
                    console.warn("Login exitoso, pero fallo carga de datos:", err);
                });
            }, 800);
            
        } else {
            throw new Error("Credenciales incorrectas");
        }
    } catch (err) {
        console.error("Error login:", err);
        
        // ✅ DETENER ANIMACIÓN Y MOSTRAR ERROR EN LA BARRA
        clearInterval(progressInterval);
        progressBarInner.style.width = '100%';
        progressBarInner.style.background = 'linear-gradient(90deg, #e63946 0%, #c62828 100%)';
        progressText.innerText = 'Error de autenticación';
        progressText.style.color = 'var(--rojo)';
        progressPercent.innerText = '✕';
        progressStatus.innerText = err.message || "Error de conexión";
        progressStatus.style.color = 'var(--rojo)';
        
        clearCredentials();
        
        // Mantener visible el error por un momento, luego ocultar
        setTimeout(() => {
            progressText.style.color = '';
            progressStatus.style.color = '';
            
            openModal("❌ Error", err.message || "Error de conexión al validar.", "💥");
        }, 1500);
    } finally {
        isLoggingIn = false;
        btn.disabled = false;
        btn.innerText = originalBtnText;
    }
}

// ✅ FUNCIÓN DE LOGOUT CORREGIDA Y UNIFICADA
function logout() {
    // 1. Detener sincronización automática del panel
    if (panelSyncInterval) {
        clearInterval(panelSyncInterval);
        panelSyncInterval = null;
    }
    
    // 2. Limpiar estado de autenticación
    isAdmin = false;
    isDesigner = false;
    userCredentials = { 
        username: "", 
        password: "", 
        displayName: "", 
        role: "", 
        designerName: "" 
    };
    
    // 3. Cerrar panel si está abierto
    if (isPanelOpen) {
        closeSidePanel();
    }
    
    // 4. Limpiar selección visual
    selectedRequestId = null;
    selectedRequestData = null;
    document.querySelectorAll('.row-selected-panel').forEach(row => {
        row.classList.remove('row-selected-panel');
    });
    
    // 5. Limpiar búsqueda
    currentSearchId = "";
    isSearchActive = false;
    resetSearchHighlight();
    const searchInput = document.getElementById('searchIdInput');
    if (searchInput) searchInput.value = "";
    document.getElementById('idNotFoundModal').style.display = 'none';
    
    // 6. Actualizar UI de contadores (vista de usuario normal)
    document.getElementById('stats-panel').style.display = 'flex';
    document.getElementById('combined-stats').style.display = 'none';
    
    // Resetear contadores de diseñadores
    const countBermina = document.getElementById('count-bermina-admin');
    const countJorsy = document.getElementById('count-jorsy-admin');
    const countMaria = document.getElementById('count-maria-admin');
    const countXamir = document.getElementById('count-xamir-admin');
    
    if (countBermina) countBermina.innerText = '0';
    if (countJorsy) countJorsy.innerText = '0';
    if (countMaria) countMaria.innerText = '0';
    if (countXamir) countXamir.innerText = '0';
    
    // 7. Actualizar UI de header
    document.getElementById('userNameDisplay').innerText = "";
    document.getElementById('welcomeMessage').classList.remove('show');
    document.getElementById('authBtn').className = "btn-login";
    document.getElementById('authBtn').innerText = "🔐 Administrador";
    document.getElementById('authBtn').onclick = showLogin;
    
    // 8. Ocultar tab de estadísticas
    document.getElementById('tab-stats').classList.add('hidden');
    
    // 9. Detener monitoreo de velocidad
    stopSpeedMonitoring();
    
    // 10. Limpiar credenciales del modal
    clearCredentials();
    
    // 11. Limpiar gráficos de estadísticas
    if (typeof statsCharts !== 'undefined') {
        if (statsCharts.requests) statsCharts.requests.destroy();
        if (statsCharts.finalized) statsCharts.finalized.destroy();
        if (statsCharts.designerPerformance) statsCharts.designerPerformance.destroy();
    }
    
    // 12. Mantener caché local para navegación rápida
    console.log("🔄 Logout completado - manteniendo caché local");
    
    // 13. Re-renderizar tabla con datos existentes
    renderLocalTable();
    updatePaginationControls();
    
    // 14. Mostrar confirmación
    showToast("🚪 Sesión cerrada", "info", 2000);
}

// === FUNCIONES ADMIN ===
// ABRIR MODAL DE ARTE - CORREGIDA
function openArteModal(id) {
    // Reiniciar estado antes de abrir
    resetChunkUploadState();
    
    const currentReqId = document.getElementById('currentReqId');
    const arteFile = document.getElementById('arteFile');
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    const closeBtn = document.getElementById('closeModalBtn');
    const mainBtn = document.getElementById('mainModalBtn');
    
    // Validar elementos existen
    if (!currentReqId || !arteFile || !modalIcon || !modalTitle || !modalMsg) {
        console.error("❌ Elementos del modal no encontrados");
        return;
    }
    
    // Limpiar y configurar
    currentReqId.value = id;
    arteFile.value = '';
    
    modalIcon.innerText = "🎨";
    modalTitle.innerText = "Adjuntar Arte Final";
    modalMsg.innerText = "Seleccione el archivo para la solicitud " + id;
    
    loginArea.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    
    closeBtn.classList.remove('hidden');
    
    // Configurar botón principal
    mainBtn.classList.remove('hidden');
    mainBtn.innerText = "SUBIR A DRIVE";
    mainBtn.onclick = uploadArte;
    mainBtn.style.display = 'block';
    
    // Mostrar modal
    document.getElementById('modalAlert').style.display = 'flex';
    
    // Forzar foco en el input de archivo
    setTimeout(() => {
        arteFile.focus();
    }, 100);
}

// ❌ FUNCIÓN DE REANUDACIÓN ELIMINADA - SIEMPRE INICIAR DESDE CERO

// SUBIR ARTE CON SISTEMA DE CHUNKS (SIN REANUDACIÓN)
async function uploadArte() {
    // ✅ REINICIAR ESTADO SIEMPRE (SIN VERIFICAR REANUDACIÓN)
    resetChunkUploadState();
    
    const fileInput = document.getElementById('arteFile');
    const id = document.getElementById('currentReqId')?.value;
    
    if (!fileInput || !id) {
        openModal("❌ Error", "Datos del formulario incompletos.", "⚠️");
        return;
    }
    
    if (fileInput.files.length === 0) {
        openModal("📎 Advertencia", "Por favor seleccione un archivo.", "📁");
        return;
    }
    
    const file = fileInput.files[0];
    const fileSizeMB = file.size / (1024 * 1024);
    
    // Validar tamaño máximo
    if (file.size > 6 * 1024 * 1024) {
        openModal("📏 Tamaño Excedido", "El archivo excede los 6MB permitidos.", "⚠️");
        return;
    }
    
    // ✅ MOSTRAR MODAL DE PROGRESO
    showUploadProgressModal(id, file.name, fileSizeMB);
    
    try {
        // Detectar velocidad de conexión
        document.getElementById('progressStatus').innerText = '📡 Detectando velocidad de conexión...';
        await detectConnectionSpeed();
        
        // ✅ NUEVA LÓGICA: SIN REANUDACIÓN, SIEMPRE DESDE CERO
        if (file.size <= 1024 * 1024) {
            // Archivos ≤1MB: siempre subir completo (sin chunks)
            document.getElementById('progressStatus').innerText = '🚀 Subiendo archivo completo...';
            await uploadFileNormal(file, id);
            return;
        }
        
        if (chunkUpload.connectionSpeed === 'fast' || chunkUpload.connectionSpeed === 'ultra-fast') {
            // Conexión rápida: subir completo incluso si >1MB
            document.getElementById('progressStatus').innerText = '🚀 Subiendo archivo completo (conexión rápida)...';
            await uploadFileNormal(file, id);
            return;
        }
        
        // ✅ ARCHIVOS GRANDES CON CONEXIÓN LENTA: CHUNKS SIN REANUDACIÓN
        document.getElementById('progressStatus').innerText = `📦 Fragmentando en chunks...`;
        
        // Dividir en chunks
        const chunks = splitFileIntoChunks(file);
        chunkUpload.chunks = chunks;
        chunkUpload.totalChunks = chunks.length;
        chunkUpload.currentChunk = 0;
        chunkUpload.uploadedChunks = 0; // ✅ SIEMPRE DESDE 0
        chunkUpload.startTime = Date.now();
        chunkUpload.isActive = true;
        
        document.getElementById('progressInfo').innerText =
            `Archivo: ${file.name} (${fileSizeMB.toFixed(2)}MB) - SUBIDA COMPLETA`;
        document.getElementById('progressSpeed').innerText =
            `Conexión: ${chunkUpload.connectionSpeed} | Chunk: ${(chunkUpload.chunkSize / 1024).toFixed(0)}KB`;
        
        // Subir chunks secuencialmente
        await uploadChunksSequential(id, file.name, file.type);
        
    } catch (error) {
        console.error('Error en uploadArte:', error);
        document.getElementById('loadingOverlay').style.display = 'none';
        
        // ✅ EN CASO DE ERROR, CANCELAR Y LIMPIAR TODO
        await cancelUpload();
        
        openModal("❌ Error", "Error al subir: " + error.message + "\n\nTodos los recursos temporales han sido eliminados.", "💥");
    }
}

// SUBIR ARCHIVO NORMAL (menor a 2MB)
async function uploadFileNormal(file, id) {
    const reader = new FileReader();
    
    return new Promise((resolve, reject) => {
        reader.onload = async function(e) {
            const base64 = e.target.result.split(',')[1];
            
            try {
                const params = new URLSearchParams();
                params.append("action", "uploadArte");
                params.append("id", id);
                params.append("filename", file.name);
                params.append("file", base64);
                params.append("mime", file.type);
                params.append("uploadedBy", userCredentials.displayName);
                params.append("isChunked", "false");
                
                const res = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: params 
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressPercent').innerText = '100%';
                    setTimeout(() => {
                        closeModal();
                        showToast("🎨 Arte subido correctamente", "success", 2500, () => {
                            updateTable();
                        });
                        resolve();
                    }, 500);
                } else {
                    reject(new Error(data.error));
                }
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo archivo"));
        reader.readAsDataURL(file);
    });
}

async function sendTelegramArte(id) {
    const req = localData.find(x => x.id == id);

    if(!confirm("¿Enviar el arte de " + id + " a Telegram?")) return;

    document.getElementById('loadMainTxt').innerText = "Enviando a Telegram...";
    document.getElementById('loadingOverlay').style.display = 'flex';

    try {
        const params = new URLSearchParams();
        params.append("action", "sendTelegramArte");
        params.append("id", id);

        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const data = await res.json();

        if(data.success) {
            showToast("📲 Enviado a Telegram", "success", 2500);
        } else {
            openModal("❌ Error", "Error: " + data.error, "💥");
        }
    } catch (e) {
        openModal("❌ Error", "Error de conexión.", "💥");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

async function toggleMaintMode() {
    if (!isAdmin) return;

    const nuevoEstado = !isMaintActive;
    document.getElementById('loadingOverlay').style.display = 'flex';

    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=setMaintenance&status=${nuevoEstado}`
        });

        isMaintActive = nuevoEstado;
        showToast(`🛠️ Mantenimiento ${nuevoEstado ? "ON" : "OFF"}`, "warning", 1500, () => {
            location.reload();
        });
    } catch (e) {
        openModal("❌ Error", "Error al cambiar estado del mantenimiento.", "💥");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

// === ELIMINACIÓN CON MODALES PERSONALIZADOS ===
let currentDeleteId = null;
let isDeleting = false;

function deleteReq(id) {
    if (!isAdmin) {
        openModal("❌ Acceso Denegado", "Solo los administradores pueden eliminar solicitudes.", "🔐");
        return;
    }

    currentDeleteId = id;
    showDeleteConfirm(1);
currentDeleteId = id;
showDeleteConfirm(1);
}

function showDeleteConfirm(step) {
const id = currentDeleteId;
if (step === 1) {
openCustomModal(
"🗑️ Confirmar Eliminación",
`¿Está seguro de eliminar la solicitud <b>${id}</b>?`,
() => showDeleteConfirm(2),
() => closeModal()
);
} else if (step === 2) {
// ✅ SEGUNDO MODAL CON BARRA DE PROGRESO (estilo login)
showDeleteProgressModal(id);
}
}

function openCustomModal(title, message, onConfirm, onCancel) {
document.getElementById('modalIcon').innerText = "❓";
document.getElementById('modalTitle').innerText = title;
document.getElementById('modalMsg').innerHTML = message;
const mainBtn = document.getElementById('mainModalBtn');
const altBtn = document.getElementById('closeModalBtn');

mainBtn.innerText = "SÍ, ACEPTAR";
mainBtn.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
altBtn.classList.remove('hidden'); // Asegurar que sea visible
altBtn.innerText = "CANCELAR";
altBtn.onclick = () => { closeModal(); if (onCancel) onCancel(); };

document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('modalAlert').style.display = 'flex';
}

// ✅ NUEVO: Modal de progreso de eliminación (similar al login)
function showDeleteProgressModal(id) {
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    const closeBtn = document.getElementById('closeModalBtn');
    const mainBtn = document.getElementById('mainModalBtn');

    // Configurar contenido del modal
    modalIcon.innerText = "🗑️";
    modalTitle.innerText = "Eliminando Solicitud";
    modalMsg.innerHTML = `Eliminando permanentemente la solicitud <b>${id}</b>...<br><span style="color: #e63946; font-weight: 600;">⚠️ Esta acción es irreversible</span>`;
    
    // Ocultar áreas no necesarias
    loginArea.classList.add('hidden');
    uploadArea.classList.add('hidden');
    
    // Configurar botón principal (deshabilitado durante eliminación)
    mainBtn.innerText = "ELIMINANDO...";
    mainBtn.disabled = true;
    mainBtn.classList.remove('hidden');
    mainBtn.style.display = 'block';
    
    // Configurar botón de cerrar (oculto durante eliminación)
    closeBtn.classList.add('hidden');
    
    // ✅ MOSTRAR BARRA DE PROGRESO (mismo estilo que login)
    const progressBar = document.getElementById('loginProgressBar');
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');

    progressBar.style.display = 'block';
    progressBarInner.style.width = '0%';
    progressPercent.innerText = '0%';
    progressText.innerText = 'Iniciando eliminación...';
    progressStatus.innerText = 'Conectando con el servidor...';
    
    // Restaurar colores por si acaso
    progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
    progressText.style.color = '';
    progressStatus.style.color = '';

    // Mostrar modal
    document.getElementById('modalAlert').style.display = 'flex';
    
    // ✅ INICIAR ANIMACIÓN DE PROGRESO
    // Pequeño retraso para asegurar que el DOM esté listo
    setTimeout(() => {
        startDeleteProgressAnimation(id);
    }, 100);
}

// ✅ ANIMACIÓN DE PROGRESO PARA ELIMINACIÓN
function startDeleteProgressAnimation(id) {
    let progress = 0;
    let phase = 'connecting'; // connecting, deleting, finalizing
    
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');
    
    // Validar que los elementos existan
    if (!progressBarInner || !progressPercent || !progressText || !progressStatus) {
        console.error("❌ Elementos de la barra de progreso no encontrados");
        completeDeleteAnimation(false, id, "Error en la interfaz de progreso");
        return;
    }
    
    // Fases de la eliminación con tiempos diferentes
    const phases = {
        connecting: { target: 25, speed: 15, text: 'Conectando con el servidor...', status: 'Estableciendo conexión segura' },
        deleting: { target: 75, speed: 8, text: 'Eliminando solicitud...', status: 'Removiendo datos de la base de datos' },
        finalizing: { target: 90, speed: 5, text: 'Finalizando...', status: 'Limpiando archivos adjuntos' },
        complete: { target: 100, speed: 20, text: '¡Completado!', status: 'Solicitud eliminada permanentemente' }
    };
    
    const animateProgress = () => {
        // ✅ CORRECCIÓN: La condición debe ser isDeleting (no !isDeleting)
        if (isDeleting && progress < 100) {
            const currentPhase = phases[phase];
            
            // Avanzar progreso
            if (progress < currentPhase.target) {
                progress += Math.random() * currentPhase.speed;
                if (progress > currentPhase.target) progress = currentPhase.target;
            }
            
            // Actualizar UI
            progressBarInner.style.width = progress + '%';
            progressPercent.innerText = Math.round(progress) + '%';
            progressText.innerText = currentPhase.text;
            progressStatus.innerText = currentPhase.status;
            
            // Cambiar de fase
            if (progress >= currentPhase.target && phase !== 'complete') {
                switch(phase) {
                    case 'connecting': 
                        phase = 'deleting'; 
                        // Iniciar la eliminación real cuando llegamos a 25%
                        executeRealDelete(id);
                        break;
                    case 'deleting': phase = 'finalizing'; break;
                    case 'finalizing': phase = 'complete'; break;
                }
            }
            
            if (progress < 100) {
                requestAnimationFrame(animateProgress);
            }
        }
    };
    
    isDeleting = true;
    requestAnimationFrame(animateProgress);
}

// ✅ EJECUCIÓN REAL DE ELIMINACIÓN (llamada al servidor)
async function executeRealDelete(id) {
    try {
        const params = new URLSearchParams();
        params.append("action", "delete");
        params.append("id", id);
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: params 
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Completar animación hasta 100%
            completeDeleteAnimation(true, id);
        } else {
            throw new Error(data.error || "Error al eliminar la solicitud");
        }
    } catch (e) {
        completeDeleteAnimation(false, id, e.message);
    }
}

// ✅ COMPLETAR ANIMACIÓN DE ELIMINACIÓN
function completeDeleteAnimation(success, id, errorMessage = '') {
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');
    const mainBtn = document.getElementById('mainModalBtn');
    const closeBtn = document.getElementById('closeModalBtn');
    
    // Validar que los elementos existan
    if (!progressBarInner || !progressPercent || !progressText || !progressStatus || !mainBtn || !closeBtn) {
        console.error("❌ Elementos del modal no encontrados en completeDeleteAnimation");
        // Forzar cierre del modal y limpieza
        setTimeout(() => {
            closeModal();
            resetDeleteState();
        }, 1000);
        return;
    }
    
    // Completar barra al 100%
    progressBarInner.style.width = '100%';
    progressPercent.innerText = '100%';
    
    if (success) {
        // ✅ ÉXITO - Verde
        progressBarInner.style.background = 'linear-gradient(90deg, #2d6a4f 0%, #40916c 50%, #52b788 100%)';
        progressText.innerText = '¡Eliminación exitosa!';
        progressText.style.color = 'var(--verde)';
        progressStatus.innerText = 'La solicitud ha sido eliminada permanentemente';
        progressStatus.style.color = 'var(--verde)';
        
        // Actualizar datos locales
        localData = localData.filter(x => x.id != id);
        
        // Si la eliminada es la seleccionada, cerrar panel
        if (selectedRequestId === id) {
            closeSidePanel();
            selectedRequestId = null;
            selectedRequestData = null;
        }
        
        renderLocalTable();
        updatePaginationControls();
        
        // Cambiar botón a "Aceptar"
        setTimeout(() => {
            mainBtn.innerText = "ENTENDIDO";
            mainBtn.disabled = false;
            mainBtn.onclick = () => {
                closeModal();
                // Limpiar estado
                setTimeout(() => {
                    const progressBar = document.getElementById('loginProgressBar');
                    if (progressBar) progressBar.style.display = 'none';
                    resetDeleteState();
                }, 300);
            };
            
            // Mostrar botón de cerrar también
            closeBtn.classList.remove('hidden');
            closeBtn.innerText = "CERRAR";
            closeBtn.onclick = () => {
                closeModal();
                setTimeout(() => {
                    const progressBar = document.getElementById('loginProgressBar');
                    if (progressBar) progressBar.style.display = 'none';
                    resetDeleteState();
                }, 300);
            };
        }, 800);
        
    } else {
        // ❌ ERROR - Rojo
        progressBarInner.style.background = 'linear-gradient(90deg, #e63946 0%, #c62828 100%)';
        progressText.innerText = 'Error al eliminar';
        progressText.style.color = 'var(--rojo)';
        progressStatus.innerText = errorMessage || 'No se pudo completar la eliminación';
        progressStatus.style.color = 'var(--rojo)';
        
        // Cambiar botón a reintentar
        setTimeout(() => {
            mainBtn.innerText = "REINTENTAR";
            mainBtn.disabled = false;
            mainBtn.onclick = () => {
                resetDeleteState();
                showDeleteProgressModal(id);
            };
            
            closeBtn.classList.remove('hidden');
            closeBtn.innerText = "CANCELAR";
            closeBtn.onclick = () => {
                closeModal();
                setTimeout(() => {
                    const progressBar = document.getElementById('loginProgressBar');
                    if (progressBar) progressBar.style.display = 'none';
                    resetDeleteState();
                }, 300);
            };
        }, 800);
    }
    
    isDeleting = false;
}

// ✅ REINICIAR ESTADO DE ELIMINACIÓN
function resetDeleteState() {
    isDeleting = false;
    currentDeleteId = null;
    
    // Restaurar estilos de la barra
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');
    
    if (progressBarInner) {
        progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
    }
    if (progressText) progressText.style.color = '';
    if (progressStatus) progressStatus.style.color = '';
}

// ✅ FUNCIÓN executeDelete ORIGINAL (ya no se usa directamente, se reemplaza por executeRealDelete)
// Mantener por compatibilidad pero marcar como obsoleta
async function executeDelete() {
    console.warn("executeDelete está obsoleto, usar showDeleteProgressModal");
    // Redirigir al nuevo flujo si se llama directamente
    if (currentDeleteId) {
        showDeleteProgressModal(currentDeleteId);
    }
}

// === FIN ELIMINACIÓN ===

// === FIN FUNCIONES ADMIN ===

// === FUNCIONES GENERALES ===
function setAMPM(val) {
if (modoObituario) return;
selectedAMPM = val;
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
document.getElementById(val === 'a. m.' ? 'btn-am' : 'btn-pm').classList.add('active');
document.getElementById('hora-box').classList.remove('field-error');
}

function selectCat(btn, tipo) {
    // ✅ NUEVO: Si es obituario, activar modo obituario automáticamente
    if (tipo === 'obituario') {
        modoObituario = true;
        // Aplicar estilos visuales de obituario inmediatamente
        applyObituarioStyles();
    } else if (modoObituario && tipo !== 'obituario') {
        // Si cambia de categoría y estaba en obituario, desactivar
        modoObituario = false;
        removeObituarioStyles();
    }

    // Limpiar selección anterior
    document.querySelectorAll('#cat-grid .card-btn').forEach(b => b.classList.remove('selected'));

    // Seleccionar el botón actual
    btn.classList.add('selected');

    // Actualizar variables globales
    catName = btn.innerText;
    catType = tipo;

    // Limpiar errores de campo
    document.getElementById('cat-grid').classList.remove('field-error');

    // Obtener elementos necesarios
    const s3 = document.getElementById('sec-3');
    const s4 = document.getElementById('sec-4');
    const c3 = document.getElementById('cont-3');
    const c4 = document.getElementById('cont-4');

    // Mostrar sección 3
    s3.classList.remove('hidden');

    // Ocultar sección 4 por defecto
    s4.classList.add('hidden');

    // Limpiar contenido de secciones 3 y 4
    c3.innerHTML = "";
    c4.innerHTML = "";

    // Renderizar contenido según tipo de categoría
    if (['escuela', 'integral', 'conjunta'].includes(tipo)) {
        document.getElementById('label-3').innerText = "🩺 3. ESPECIALIDADES MÉDICAS *";
        renderList(c3, DATA.especialidades);
        s4.classList.remove('hidden');
        renderList(c4, DATA.servicios);
    } else if (tipo === 'vacuna') {
        document.getElementById('label-3').innerText = "💉 3. LISTA DE VACUNAS *";
        renderList(c3, DATA.vacunas);
    } else if (tipo === 'quirurgica') {
        document.getElementById('label-3').innerText = "🔪 3. PATOLOGÍAS QUIRÚRGICAS *";
        renderList(c3, DATA.quirurgica);
    } else if (tipo === 'pediatrica') {
        document.getElementById('label-3').innerText = " 3. PATOLOGÍAS PEDIÁTRICAS *";
        renderList(c3, DATA.pediatrica);
    } else if (tipo === 'oftalmo') {
        document.getElementById('label-3').innerText = " 3. PATOLOGÍAS OFTALMOLÓGICAS *";
        renderList(c3, DATA.oftalmo);
    } else if (tipo === 'obituario') {
        document.getElementById('label-3').innerText = " 3. INFORMACIÓN DEL FALLECIDO *";
        c3.innerHTML = `
        <textarea id="desc-obituario" class="modern-input" rows="4" style="grid-column: 1 / -1;" 
        placeholder="Indique por favor:&#10;- Nombre del fallecido&#10;- Parentesco (en caso de ser familiar de un trabajador del Ipasme)&#10;- Servicio o jurisdicción a la que pertenece el familiar o el fallecido&#10;- Fecha del deceso&#10;- Cualquier información adicional relevante"></textarea>
        
        <div style="grid-column: 1 / -1; background: #fff3e0; border: 2px solid #fb8500; border-radius: 12px; padding: 15px; margin-top: 10px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <span style="font-size: 1.5rem;">⚠️</span>
                <span style="font-weight: 800; color: #5d4600; font-size: 0.95rem;">SOLICITUD PRIORITARIA</span>
            </div>
            <p style="margin: 0; font-size: 0.85rem; color: #5d4600; line-height: 1.4;">
                Esta solicitud se procesa de manera inmediata. La fecha está fijada al día actual y no requiere las 48 horas de anticipación habituales.
            </p>
        </div>
        `;
        
        // Los servicios adicionales (sec-4) permanecen ocultos para obituario
        s4.classList.add('hidden');
        c4.innerHTML = "";
        
        // Aplicar estilos de obituario automáticamente
        applyObituarioStyles();
    } else {
        document.getElementById('label-3').innerText = " 3. DESCRIPCIÓN DEL REQUERIMIENTO *";
        c3.innerHTML = '<textarea id="desc-otro" class="modern-input" rows="3" style="grid-column: 1 / -1;" placeholder="Detalle aquí su solicitud especial..."></textarea>';
        // El botón Obituario ya no está aquí - ahora es una categoría independiente
    }
}

// ✅ NUEVA FUNCIÓN: Aplicar estilos de modo Obituario
function applyObituarioStyles() {
    const fechaInput = document.getElementById('fecha');
    const horaInput = document.getElementById('hora');
    const institucion = document.getElementById('institucion');
    const direccionExacta = document.getElementById('direccion-exacta');
    const observaciones = document.getElementById('observaciones');
    
    // Fijar fecha a hoy
    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const dd = String(hoy.getDate()).padStart(2, '0');
    fechaInput.value = `${yyyy}-${mm}-${dd}`;
    
    // Deshabilitar campos
    fechaInput.disabled = true;
    horaInput.disabled = true;
    institucion.disabled = true;
    direccionExacta.disabled = true;
    observaciones.disabled = true;
    
    // Aplicar clases de estilo
    horaInput.classList.add('obit-disabled');
    institucion.classList.add('obit-disabled');
    direccionExacta.classList.add('obit-disabled');
    observaciones.classList.add('obit-disabled');
    
    // Limpiar valores
    horaInput.value = '';
    institucion.value = '';
    direccionExacta.value = '';
    observaciones.value = '';
    
    // Deshabilitar uploads
    document.querySelectorAll('.upload-box').forEach(box => box.classList.add('obit-upload-box'));
    document.querySelectorAll('.upload-label').forEach(label => label.classList.add('obit-upload-label'));
    
    // Limpiar fotos
    Array.from(document.querySelectorAll('.preview')).forEach(img => {
        img.src = '';
        img.style.display = 'none';
        img.removeAttribute('data-has-image');
    });
    Array.from(document.querySelectorAll('.remove-btn')).forEach(btn => btn.style.display = 'none');
    
    console.log("🕊️ Modo Obituario activado - Fecha fijada a:", fechaInput.value);
}

// ✅ NUEVA FUNCIÓN: Remover estilos de modo Obituario
function removeObituarioStyles() {
    const fechaInput = document.getElementById('fecha');
    const horaInput = document.getElementById('hora');
    const institucion = document.getElementById('institucion');
    const direccionExacta = document.getElementById('direccion-exacta');
    const observaciones = document.getElementById('observaciones');
    
    // Rehabilitar campos
    fechaInput.disabled = false;
    horaInput.disabled = false;
    institucion.disabled = false;
    direccionExacta.disabled = false;
    observaciones.disabled = false;
    
    // Quitar clases de estilo
    horaInput.classList.remove('obit-disabled');
    institucion.classList.remove('obit-disabled');
    direccionExacta.classList.remove('obit-disabled');
    observaciones.classList.remove('obit-disabled');
    
    // Rehabilitar uploads
    document.querySelectorAll('.upload-box').forEach(box => box.classList.remove('obit-upload-box'));
    document.querySelectorAll('.upload-label').forEach(label => label.classList.remove('obit-upload-label'));
    
    console.log("🕊️ Modo Obituario desactivado");
}

function renderList(cont, list) {
    list.forEach(i => {
        const d = document.createElement('div');
        d.className = 'card-btn';
        d.innerText = i;
        cont.appendChild(d);
    });
}

// ✅ FUNCIÓN showPage - NO MODIFICADA
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top: 0, behavior: 'smooth'});
  if(btn) btn.classList.add('active');
  else document.getElementById('tab-' + id.split('-')[0]).classList.add('active');
  if(id === 'list-page') updateTable();
}

// ✅ FUNCIÓN updateTable - CORREGIDA CON CACHE DE PÁGINAS
async function updateTable(forceRefresh = false) {
  const now = Date.now();
  
  // ✅ CORRECCIÓN: Verificar si el cache tiene los datos correctos
  const serverCacheTimestamp = parseInt(DATA_CACHE.serverTimestamp || "0");
  
  if (!forceRefresh && DATA_CACHE.data && (now - DATA_CACHE.timestamp) < DATA_CACHE.ttl) {
    // Verificar si el cache tiene el totalRecords correcto
    if (DATA_CACHE.totalRecords && DATA_CACHE.totalRecords > localData.length) {
      console.log("💾 Usando caché local con totalRecords:", DATA_CACHE.totalRecords);
      localData = DATA_CACHE.data;
      PAGINATION.totalRecords = DATA_CACHE.totalRecords;
      
      // ✅ Guardar página actual en caché de páginas
      PAGE_CACHE.setPage(PAGINATION.currentPage, {
        rows: [...localData],
        stats: DATA_CACHE.stats
      });
      
      if(DATA_CACHE.stats) updateCounters(DATA_CACHE.stats);
      renderLocalTable();
      
      // Pre-cargar páginas adyacentes
      preloadAdjacentPages(PAGINATION.currentPage);
      
      return;
    }
  }
  
  if (DATA_CACHE.isLoading) {
    await DATA_CACHE.pendingPromise;
    return;
  }
  
  DATA_CACHE.isLoading = true;
  DATA_CACHE.pendingPromise = fetchTableData();
  
  try {
    const result = await DATA_CACHE.pendingPromise;
    
    // ✅ GUARDAR totalRecords EN EL CACHE
    DATA_CACHE.data = result.rows;
    DATA_CACHE.stats = result.stats;
    DATA_CACHE.serverTimestamp = result.cacheTimestamp || now;
    DATA_CACHE.timestamp = now;
    DATA_CACHE.totalRecords = result.totalRecords; // ✅ GUARDAR TOTAL REAL
    
    localData = result.rows;
    PAGINATION.totalRecords = result.totalRecords; // ✅ ACTUALIZAR GLOBAL
    
    // ✅ Guardar página actual en caché de páginas
    PAGE_CACHE.setPage(PAGINATION.currentPage, {
      rows: [...result.rows],
      stats: result.stats
    });
    
    if (result.stats) {
      updateCounters(result.stats);
    }
    
    renderLocalTable();
    
    // Pre-cargar páginas adyacentes
    preloadAdjacentPages(PAGINATION.currentPage);
    
  } catch (e) {
    console.error("Error cargando tabla:", e);
    openModal("❌ Error", "No se pudieron cargar los datos: " + e.message, "⚠️");
  } finally {
    DATA_CACHE.isLoading = false;
    DATA_CACHE.pendingPromise = null;
  }
}

// ✅ FUNCIÓN DE CARGA DE DATOS - CORREGIDA PARA PAGINACIÓN
async function fetchTableData() {
  try {
    const params = new URLSearchParams();
    params.append("action", "read");
    params.append("page", PAGINATION.currentPage.toString());
    params.append("limit", PAGINATION.limit.toString());
    
    console.log("📤 Solicitando página", PAGINATION.currentPage, "con límite", PAGINATION.limit);
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });
    
    const responseText = await res.text();
    console.log("📄 Respuesta cruda (primeros 500 chars):", responseText.substring(0, 500));
    
    let response;
    try {
      response = JSON.parse(responseText);
    } catch (e) {
      console.error("❌ No es JSON válido:", responseText);
      throw new Error("El servidor no respondió con datos válidos");
    }
    
    console.log("✅ Respuesta parseada:", response);
    
    if (!response.success) {
      throw new Error(response.error || "Error del servidor");
    }
    
    const data = response.data || response;
    
    // ✅ CORRECCIÓN CRÍTICA: Extraer totalRecords de la paginación del servidor
    let totalRecords = 0;
    if (data.pagination && data.pagination.totalRecords) {
      totalRecords = parseInt(data.pagination.totalRecords);
      console.log("📊 Total records desde servidor:", totalRecords);
    } else if (data.totalRecords) {
      totalRecords = parseInt(data.totalRecords);
      console.log("📊 Total records desde data.totalRecords:", totalRecords);
    } else {
      // Fallback: si no hay paginación, usar la longitud de los datos
      totalRecords = (data.rows || []).length;
      console.log("⚠️ No hay paginación, usando length:", totalRecords);
    }
    
    // ✅ ACTUALIZAR PAGINACIÓN GLOBAL
    PAGINATION.totalRecords = totalRecords;
    PAGINATION.totalPages = Math.ceil(totalRecords / PAGINATION.limit) || 1;
    
    console.log(`📊 Paginación calculada: ${PAGINATION.totalPages} páginas de ${PAGINATION.limit} registros cada una`);
    
    return {
      rows: data.rows || [],
      stats: data.stats || null,
      cacheTimestamp: data.cacheTimestamp || Date.now(),
      totalRecords: totalRecords
    };
    
  } catch (error) {
    console.error("❌ Error en fetchTableData:", error);
    throw error;
  }
}

function buildDataIndexes() {
    DATA_INDEX.byId.clear();
    DATA_INDEX.byStatus.clear();
    DATA_INDEX.byDesigner.clear();
    
    localData.forEach((item, idx) => {
        DATA_INDEX.byId.set(item.id, { item, index: idx });
        
        const status = (item.Estatus || "").toUpperCase().trim();
        if (!DATA_INDEX.byStatus.has(status)) {
            DATA_INDEX.byStatus.set(status, []);
        }
        DATA_INDEX.byStatus.get(status).push(item);
        
        if (item.Disenador) {
            if (!DATA_INDEX.byDesigner.has(item.Disenador)) {
                DATA_INDEX.byDesigner.set(item.Disenador, []);
            }
            DATA_INDEX.byDesigner.get(item.Disenador).push(item);
        }
    });
    
    console.log(` Índices construidos: ${DATA_INDEX.byId.size} registros`);
}

// VALIDACIÓN EN ORDEN CORRECTO
function validateForm() {
const fieldsInOrder = [];

fieldsInOrder.push({
id: 'region-grid',
isValid: () => !!selectedRegionKey,
label: 'Región'
});

fieldsInOrder.push({
id: 'unidad-grid',
isValid: () => !!selectedUnidad,
label: 'Unidad Médica'
});

fieldsInOrder.push({
id: 'cat-grid',
isValid: () => !!catName,
label: 'Tipo de Solicitud'
});

fieldsInOrder.push({
id: 'sec-3',
isValid: () => {
if (catType === 'otros') {
return document.getElementById('desc-otro')?.value.trim() !== '';
} else if (catType === 'obituario') {
return document.getElementById('desc-obituario')?.value.trim() !== '';
} else {
return document.querySelectorAll('#cont-3 .card-btn.selected').length > 0;
}
},
label: 'Detalle'
});

fieldsInOrder.push({
id: 'fecha',
isValid: () => {
const val = document.getElementById('fecha').value;
return !!val;
},
label: 'Fecha de Actividad'
});

if (!modoObituario) {
fieldsInOrder.push({
id: 'hora',
isValid: () => {
const val = document.getElementById('hora').value.trim();
return !!val;
},
label: 'Hora de Inicio'
});

fieldsInOrder.push({
id: 'hora-box',
isValid: () => !!selectedAMPM,
label: 'Formato AM/PM'
});

fieldsInOrder.push({
id: 'institucion',
isValid: () => {
const val = document.getElementById('institucion').value.trim();
return !!val;
},
label: 'Institución'
});
}

fieldsInOrder.push({
id: 'mail',
isValid: () => {
const val = document.getElementById('mail').value.trim();
return val && val.includes('@');
},
label: 'Correo Electrónico'
});

for (const field of fieldsInOrder) {
const el = document.getElementById(field.id);
if (!field.isValid()) {
el?.classList.add('field-error');
el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
showToast(`❌ Campo faltante: ${field.label}`, "error", 5000);

setTimeout(() => {
const focusable = el?.querySelector('input, textarea, select') || 
(el?.tagName === 'INPUT' || el?.tagName === 'TEXTAREA' ? el : null);
if (focusable && typeof focusable.focus === 'function') {
focusable.focus();
}
}, 600);
return false;
}
}

if (!modoObituario) {
const fechaInput = document.getElementById('fecha').value;
const fechaSeleccionada = new Date(fechaInput + 'T00:00:00');
const ahora = new Date();

// VALIDACIÓN INTERNA: 24 HORAS (texto mantiene 48 para usuario)
if ((fechaSeleccionada - ahora) / (1000 * 60 * 60) < 24) {
document.getElementById('fecha').classList.add('field-error');
document.getElementById('fecha').scrollIntoView({ behavior: 'smooth', block: 'center' });
showToast("⏳ Las solicitudes deben realizarse con al menos 48 horas de anticipación", "warning", 6000);

setTimeout(() => document.getElementById('fecha').focus(), 600);
return false;
}
}

return true;
}

function showConfirmationModal() {
if (!validateForm()) return;

const preview = document.getElementById('previewContent');
let html = `
<p><b>📍 Región:</b> ${getNombreRegionLimpio(selectedRegionKey)}</p>
<p><b>🏥 Unidad Médica:</b> ${selectedUnidad}</p>
`;

if (modoObituario) {
html += `<p><b>📋 Tipo de Solicitud:</b> Obituario</p>`;
} else {
html += `<p><b>📂 Tipo de Solicitud:</b> ${catName}</p>`;
}

if (catType === 'otros' && !modoObituario) {
html += `<p><b>✨ Descripción:</b> ${document.getElementById('desc-otro').value.trim()}</p>`;
} else if (!modoObituario) {
const selectedOps = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el => el.innerText).join(', ');
html += `<p><b>🩺 Detalle:</b> ${selectedOps || 'Ninguno'}</p>`;
}

const servicios = Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el => el.innerText).join(', ');
if (servicios) html += `<p><b>✨ Servicios Adicionales:</b> ${servicios}</p>`;

const [year, month, day] = document.getElementById('fecha').value.split('-');
const fechaFormateada = `${day}/${month}/${year}`;
html += `<p><b>📅 Fecha de Actividad:</b> ${fechaFormateada}</p>`;

if (!modoObituario) {
html += `<p><b>⏰ Hora de Inicio:</b> ${document.getElementById('hora').value} ${selectedAMPM}</p>`;
const institucion = document.getElementById('institucion').value.trim();
const direccion = document.getElementById('direccion-exacta').value.trim();
html += `<p><b>🧭 Ubicación:</b> ${[institucion, direccion].filter(x => x).join(', ')}</p>`;
html += `<p><b>📱 Teléfono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>`;
html += `<p><b>✉️ Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>`;

const obs = document.getElementById('observaciones').value.trim();
if (obs) html += `<p><b>✏️ Observaciones:</b> ${obs}</p>`;

// CORREGIDO: Contar fotos usando el atributo data-has-image
const fotos = [1,2,3].filter(i => {
const img = document.getElementById(`p${i}`);
return img.getAttribute('data-has-image') === 'true';
});
html += `<p><b>📸 Soportes Fotográficos:</b> ${fotos.length > 0 ? `${fotos.length} foto(s) adjunta(s)` : 'Ninguno'}</p>`;
} else {
html += `<p><b>📱 Teléfono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>`;
html += `<p><b>✉️ Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>`;
html += `<p><b>ℹ️ Modo Obituario activado – Campos opcionales omitidos.</b></p>`;
}

preview.innerHTML = html;
document.getElementById('confirmModal').style.display = 'flex';

let timeLeft = 10;
document.getElementById('countdown').innerText = timeLeft;
const btnEnviar = document.getElementById('btnEnviarConfirmado');
btnEnviar.disabled = true;
btnEnviar.classList.remove('enviar');
btnEnviar.classList.add('corregir');

const btnCorregir = document.getElementById('btnCorregir');
btnCorregir.onmouseenter = () => {
btnCorregir.style.background = "#d1d5db";
btnCorregir.style.color = "#212529";
};
btnCorregir.onmouseleave = () => {
btnCorregir.style.background = "var(--gris)";
btnCorregir.style.color = "var(--azul-deep)";
};

const timer = setInterval(() => {
timeLeft--;
document.getElementById('countdown').innerText = timeLeft;
const progress = ((10 - timeLeft) / 10) * 100;
btnEnviar.style.background = `linear-gradient(to right, var(--turquesa) ${progress}%, #e9ecef ${progress}%)`;
btnEnviar.style.color = timeLeft <= 3 ? "white" : "#495057";

if (timeLeft <= 0) {
clearInterval(timer);
btnEnviar.disabled = false;
btnEnviar.classList.remove('corregir');
btnEnviar.classList.add('enviar');
btnEnviar.style.background = "var(--turquesa)";
btnEnviar.style.color = "white";
btnEnviar.style.cursor = "pointer";

// ✨ APLICAR TEXTO EN DOS LÍNEAS
btnEnviar.innerHTML = `<div class="btn-text"><span>Haz clic para enviar</span><span>la solicitud</span></div>`;

// ✨ APLICAR ANIMACIÓN DE PULSOS
btnEnviar.classList.add('btn-send-pulse');

// ✨ REPRODUCIR SONIDO
const sound = document.getElementById('notificationSound');
if (sound) {
sound.currentTime = 0;
sound.play().catch(e => console.log("Sonido no reproducido:", e));
}

// ✨ EFECTOS HOVER MÁS SUAVES
btnEnviar.onmouseenter = () => {
btnEnviar.style.transform = "scale(1.03)";
btnEnviar.style.boxShadow = "0 6px 20px rgba(2, 48, 71, 0.4)";
};
btnEnviar.onmouseleave = () => {
btnEnviar.style.transform = "scale(1)";
btnEnviar.style.boxShadow = "0 4px 15px rgba(0, 150, 255, 0.3)";
};
}
}, 1000);

window.confirmTimer = timer;
}

document.getElementById('btnCorregir').onclick = () => {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
};

function proceedToSend() {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
realSubmitForm();
}

document.getElementById('btnEnviarConfirmado').onclick = proceedToSend;

// === ENVÍO REAL ===
document.getElementById('sigrafForm').onsubmit = function(e) {
e.preventDefault();
showConfirmationModal();
};

function realSubmitForm() {
const params = new URLSearchParams();

const EXCEPCIONES_SIN_UMI = [
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende",
"Club Villas Ipasmar",
"Hotel Valle Grande"
];

// CORRECCIÓN: se elimina la capitalización automática
let unidadFinal = selectedUnidad.trim();
if (!EXCEPCIONES_SIN_UMI.includes(unidadFinal)) {
unidadFinal = "U.M.I. " + unidadFinal;
}

params.append("Unidad", unidadFinal);

// ✅ Manejo explícito del tipo de solicitud
if (catType === 'obituario') {
    params.append("Jornada", "Obituario");
} else {
    params.append("Jornada", catName);
}

let ops = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el=>el.innerText).join(", ");
if(catType === 'otros') ops = document.getElementById('desc-otro').value;
else if(catType === 'obituario') {
    const descObituario = document.getElementById('desc-obituario');
    ops = descObituario ? descObituario.value : '';
}
params.append("Opciones", ops);

params.append("Servicios", Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el=>el.innerText).join(", "));

if (!modoObituario) {
const institucion = document.getElementById('institucion').value.trim();
const direccionExacta = document.getElementById('direccion-exacta').value.trim();
const direccionCompleta = [institucion, direccionExacta].filter(part => part).join(", ");
params.append("Direccion", direccionCompleta);
params.append("Hora", document.getElementById('hora').value + " " + selectedAMPM);
params.append("Observaciones", document.getElementById('observaciones').value);

// CORREGIDO: Adjuntar fotos usando el atributo data-has-image
for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
if(img.getAttribute('data-has-image') === 'true') {
const base64Data = img.src.split(',')[1];
if (base64Data) {
params.append("foto"+i, base64Data);
}
}
}
} else {
params.append("Direccion", "");
params.append("Hora", "");
params.append("Observaciones", "");
}

params.append("Fecha", document.getElementById('fecha').value);
params.append("Telefono", document.getElementById('tlf').value);
params.append("Correo", document.getElementById('mail').value);

// ✅ AGREGAR DISPOSITIVO
params.append("Dispositivo", detectDevice());

document.getElementById('loadMainTxt').innerText = "Enviando Solicitud...";
document.getElementById('loadingOverlay').style.display = 'flex';

fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: params.toString()
})
.then(response => response.json())
.then(result => {
if (result.success) {
document.getElementById('sigrafForm').reset();

for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
img.src = '';
img.style.display = 'none';
img.removeAttribute('data-has-image'); // Limpiar marca
document.getElementById('b'+i).style.display = 'none';
}

document.querySelectorAll('.card-btn').forEach(btn => btn.classList.remove('selected'));
document.getElementById('sec-3').classList.add('hidden');
document.getElementById('sec-4').classList.add('hidden');
selectedAMPM = "";
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
selectedRegionKey = "";
selectedUnidad = "";
modoObituario = false;

document.getElementById('fecha').disabled = false;
document.getElementById('hora').disabled = false;
document.getElementById('institucion').disabled = false;
document.getElementById('direccion-exacta').disabled = false;
document.getElementById('observaciones').disabled = false;
document.getElementById('hora').classList.remove('obit-disabled');
document.getElementById('institucion').classList.remove('obit-disabled');
document.getElementById('direccion-exacta').classList.remove('obit-disabled');
document.getElementById('observaciones').classList.remove('obit-disabled');
document.querySelectorAll('.upload-box').forEach(box => box.classList.remove('obit-upload-box'));
document.querySelectorAll('.upload-label').forEach(label => label.classList.remove('obit-upload-label'));

document.querySelectorAll('#region-grid .card-btn').forEach(b => b.classList.remove('selected'));
document.getElementById('unidad-grid').innerHTML = "";
document.getElementById('unidad-section').classList.add('hidden');

showToast("✅ Solicitud enviada correctamente", "success", 3000, () => {
            // ✅ OPTIMIZACIÓN: Invalidar solo si estamos en la primera página
            if (PAGINATION.currentPage === 1) {
                invalidatePageCache();
                updateTable(true); // forceRefresh = true para obtener datos frescos
            } else {
                // Si no estamos en la primera página, solo invalidar caché
                invalidatePageCache();
            }
            showPage('list-page', document.getElementById('tab-list'));
        });
} else {
throw new Error(result.error);
}
})
.catch(e => {
openModal("✅ Solicitud Procesada", "El sistema ha registrado su envío.", "📋");
setTimeout(() => {
closeModal();
// ✅ OPTIMIZACIÓN: Invalidar caché y actualizar de forma inteligente
invalidatePageCache();
if (PAGINATION.currentPage === 1) {
    updateTable(true); // Forzar recarga si estamos en primera página
} else {
    updateTable(); // Usar caché si estamos en otra página
}
showPage('list-page', document.getElementById('tab-list'));
}, 2000);
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}
// === FUNCIONES PARA SISTEMA DE CHUNKS ===

// SUBIR CHUNKS SECUENCIALMENTE CON REINTENTOS
async function uploadChunksSequential(id, filename, mimeType) {
    const totalChunks = chunkUpload.totalChunks;
    const startFromChunk = chunkUpload.uploadedChunks; // Empezar desde el último chunk subido
    
    for (let i = startFromChunk; i < totalChunks; i++) {
        chunkUpload.currentChunkIndex = i; // Actualizar índice actual para UI
        
        if (chunkUpload.pauseRequested) {
            await waitForResume();
            if (!chunkUpload.isActive) return;
        }
        
        let chunkSuccess = false;
        let retryCount = 0;
        
        while (!chunkSuccess && retryCount < chunkUpload.maxRetries) {
            try {
                // ✅ REGISTRAR TIEMPO DE INICIO DEL CHUNK
                chunkUpload.currentChunkStartTime = Date.now();
                
                // Cuando se reanuda, el array chunks solo contiene los pendientes
                // El índice real del chunk es i, pero en el array es i - startFromChunk
                const chunkArrayIndex = i - startFromChunk;
                await uploadSingleChunk(id, filename, mimeType, chunkArrayIndex, i);
                
                // ✅ REGISTRAR TIEMPO DE FIN Y CALCULAR VELOCIDAD
                chunkUpload.currentChunkEndTime = Date.now();
                const chunkDuration = (chunkUpload.currentChunkEndTime - chunkUpload.currentChunkStartTime) / 1000; // segundos
                const chunkSizeKB = chunkUpload.chunks[chunkArrayIndex].size / 1024; // KB
                const currentSpeed = chunkSizeKB / chunkDuration; // KB/s
                
                // Guardar velocidad actual
                chunkUpload.currentUploadSpeed = currentSpeed;
                chunkUpload.uploadSpeeds.push(currentSpeed);
                
                // Calcular promedio
                const totalSpeed = chunkUpload.uploadSpeeds.reduce((sum, speed) => sum + speed, 0);
                chunkUpload.avgUploadSpeed = totalSpeed / chunkUpload.uploadSpeeds.length;
                
                // ✅ ACTUALIZAR VELOCIDAD EN EL MODAL
                updateUploadSpeedDisplay();
                
                chunkSuccess = true;
                chunkUpload.uploadedChunks++;
                
                // Actualizar progreso
                const progress = Math.min(100, (chunkUpload.uploadedChunks / totalChunks) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressPercent').innerText = Math.round(progress) + '%';
                
                // Calcular tiempo restante
                if (chunkUpload.uploadedChunks > 1) {
                    const elapsed = (Date.now() - chunkUpload.startTime) / 1000;
                    const avgTimePerChunk = elapsed / chunkUpload.uploadedChunks;
                    const remainingChunks = totalChunks - chunkUpload.uploadedChunks;
                    const etaSeconds = Math.round(avgTimePerChunk * remainingChunks);
                    
                    document.getElementById('progressETA').innerText = 
                        `Tiempo restante: ~${etaSeconds}s`;
                }
                
                // Pequeña pausa entre chunks para no saturar
                if (i < totalChunks - 1) {
                    await new Promise(resolve => setTimeout(resolve, 
                        chunkUpload.connectionSpeed === 'slow' ? 500 : 200));
                }
                
            } catch (error) {
                retryCount++;
                console.warn(`⚠️ Chunk ${i + 1}/${totalChunks} fallido (intento ${retryCount}/${chunkUpload.maxRetries})`);
                
                if (retryCount >= chunkUpload.maxRetries) {
                    throw new Error(`Chunk ${i + 1} fallido después de ${retryCount} intentos: ${error.message}`);
                }
                
                // Esperar antes de reintentar (exponencial)
                const waitTime = Math.min(5000, 1000 * Math.pow(2, retryCount));
                document.getElementById('progressStatus').innerText = 
                    `⏸️ Reintentando chunk ${i + 1}... (${retryCount}/${chunkUpload.maxRetries})`;
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
        }
    }
    
    // Todos los chunks subidos, finalizar
    await finalizeChunkedUpload(id, filename, mimeType);
}

// SUBIR UN SOLO CHUNK
async function uploadSingleChunk(id, filename, mimeType, chunkArrayIndex, realChunkIndex) {
    const chunk = chunkUpload.chunks[chunkArrayIndex];
    const reader = new FileReader();
    
    return new Promise((resolve, reject) => {
        reader.onload = async function(e) {
            try {
                const base64 = e.target.result.split(',')[1];
                
                const params = new URLSearchParams();
                params.append("action", "uploadChunk");
                params.append("id", id);
                params.append("filename", filename);
                params.append("mime", mimeType);
                params.append("chunkIndex", chunk.index);
                params.append("chunkData", base64);
                params.append("totalChunks", chunk.total);
                params.append("fileId", chunk.fileId);
                params.append("uploadedBy", userCredentials.displayName);
                
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('progressStatus').innerText = 
                        `📤 Subiendo chunk ${realChunkIndex + 1}/${chunk.total}...`;
                    resolve();
                } else {
                    reject(new Error(data.error || 'Error desconocido'));
                }
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo chunk"));
        reader.readAsDataURL(chunk.blob);
    });
}

// FINALIZAR SUBIDA POR CHUNKS
async function finalizeChunkedUpload(id, filename, mimeType) {
    document.getElementById('progressStatus').innerText = '✅ Finalizando subida...';
    
    const params = new URLSearchParams();
    params.append("action", "finalizeChunkedUpload");
    params.append("id", id);
    params.append("filename", filename);
    params.append("mime", mimeType);
    params.append("totalChunks", chunkUpload.totalChunks);
    params.append("fileId", chunkUpload.chunks[0].fileId);
    params.append("uploadedBy", userCredentials.displayName);
    
    const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
    });
    
    const data = await res.json();
    
    if (data.success) {
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressPercent').innerText = '100%';
        document.getElementById('progressStatus').innerText = '✅ ¡Completado!';
        
        setTimeout(() => {
            closeModal();
            showToast("🎨 Arte subido correctamente", "success", 2500, () => {
                // ✅ Invalidar caché ya que los datos cambiaron
                invalidatePageCache();
                updateTable();
            });
            document.getElementById('arteFile').value = '';
        }, 1000);
    } else {
        throw new Error(data.error || 'Error al finalizar');
    }
}

// MOSTRAR MODAL DE PROGRESO - CORREGIDA
function showUploadProgressModal(id, filename, fileSizeMB) {
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    const closeBtn = document.getElementById('closeModalBtn');
    const mainBtn = document.getElementById('mainModalBtn');
    
    if (!modalIcon || !modalTitle || !modalMsg) return;
    
    modalIcon.innerText = "";
    modalTitle.innerText = "Subiendo Archivo";
    modalMsg.innerHTML = `
    <div style="text-align: left; margin-top: 15px;">
        <div id="progressInfo" style="font-size: 0.9rem; margin-bottom: 8px; color: #555;">Archivo: ${filename} (${fileSizeMB.toFixed(2)}MB)</div>
        <div id="progressSpeed" style="font-size: 0.85rem; margin-bottom: 15px; color: #666; font-weight: 500;">Conexión: ${chunkUpload.connectionSpeed === 'slow-medium' ? 'slow' : chunkUpload.connectionSpeed} | Chunk: ${(chunkUpload.chunkSize / 1024).toFixed(0)}KB</div>
        <div id="progressUploadSpeed" style="font-size: 0.85rem; margin-bottom: 15px; color: var(--azul-deep); font-weight: 600;">
          📤 Velocidad: Calculando...
        </div>
        <div style="background: #f0f9ff; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span id="progressStatus" style="font-weight: 600; color: var(--azul-deep);">Preparando...</span>
                <span id="progressPercent" style="font-weight: 800; color: var(--turquesa);">0%</span>
            </div>
            <div style="background: #e9ecef; border-radius: 20px; height: 12px; overflow: hidden;">
                <div id="progressBar" style="background: linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 100%); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 20px;"></div>
            </div>
        </div>
        <div id="progressETA" style="font-size: 0.85rem; text-align: center; color: #666; margin-top: 8px;"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="btnPauseResume" class="modal-btn" style="background: #6c757d; flex: 1; padding: 8px;" onclick="togglePauseResume()">
                Pausar
            </button>
            <button id="btnCancelUpload" class="modal-btn" style="background: var(--rojo); flex: 1; padding: 8px;" onclick="cancelUpload()">
                Cancelar
            </button>
        </div>
    </div>
    `;
    
    loginArea.classList.add('hidden');
    uploadArea.classList.add('hidden');
    
    closeBtn.classList.remove('hidden');
    closeBtn.onclick = () => {
        resetChunkUploadState();
        closeModal();
    };
    
    if (mainBtn) mainBtn.classList.add('hidden');
    
    document.getElementById('modalAlert').style.display = 'flex';
}

// ✅ FUNCIÓN PARA INVALIDAR CACHÉ CUANDO SE ACTUALIZAN DATOS
function invalidatePageCache() {
  console.log("🗑️ Invalidando caché de páginas - datos actualizados");
  PAGE_CACHE.clear();
  
  // También invalidar caché principal para forzar recarga
  DATA_CACHE.data = null;
  DATA_CACHE.timestamp = 0;
}

// ✅ ACTUALIZAR DISPLAY DE VELOCIDAD DE SUBIDA
function updateUploadSpeedDisplay() {
  const speedElement = document.getElementById('progressUploadSpeed');
  if (!speedElement) return;
  
  const currentSpeed = chunkUpload.currentUploadSpeed;
  const avgSpeed = chunkUpload.avgUploadSpeed;
  
  if (currentSpeed > 0) {
    // Formatear velocidad: KB/s o MB/s según corresponda
    let speedText = '';
    let avgText = '';
    
    if (currentSpeed >= 1024) {
      // Mostrar en MB/s
      speedText = (currentSpeed / 1024).toFixed(2) + ' MB/s';
      avgText = (avgSpeed / 1024).toFixed(2) + ' MB/s';
    } else {
      // Mostrar en KB/s
      speedText = currentSpeed.toFixed(1) + ' KB/s';
      avgText = avgSpeed.toFixed(1) + ' KB/s';
    }
    
    // Calcular Mbps (1 byte = 8 bits)
    const currentMbps = (currentSpeed * 8 / 1024).toFixed(1);
    const avgMbps = (avgSpeed * 8 / 1024).toFixed(1);
    
    speedElement.innerHTML = `📤 Velocidad: <span style="color: var(--turquesa); font-weight: 800;">${currentMbps} Mbps</span> (${speedText})<br>
    <span style="font-size: 0.75rem; color: #666;">Promedio: ${avgMbps} Mbps (${avgText})</span>`;
  } else {
    speedElement.innerText = '📤 Velocidad: Calculando...';
  }
}

// PAUSAR/REANUDAR SUBIDA
function togglePauseResume() {
    chunkUpload.pauseRequested = !chunkUpload.pauseRequested;
    chunkUpload.pauseRequested = !chunkUpload.pauseRequested;
    const btn = document.getElementById('btnPauseResume');
    
    if (chunkUpload.pauseRequested) {
        btn.innerHTML = '▶️ Reanudar';
        document.getElementById('progressStatus').innerText = '⏸️ PAUSADO';
    } else {
        btn.innerHTML = '⏸️ Pausar';
        document.getElementById('progressStatus').innerText = '▶️ Reanudando...';
    }
}

// ESPERAR A QUE SE REANUDE
function waitForResume() {
    return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
            if (!chunkUpload.pauseRequested || !chunkUpload.isActive) {
                clearInterval(checkInterval);
                resolve();
            }
        }, 100);
    });
}

// CANCELAR SUBIDA - CORREGIDA
function cancelUpload() {
    const id = document.getElementById('currentReqId')?.value;
    
    // Llamar al backend para limpiar recursos
    if (id && chunkUpload.isActive) {
        fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=cancelChunkedUpload&id=${encodeURIComponent(id)}` 
        })
        .then(response => response.json())
        .catch(err => {
            console.warn("⚠️ Error limpiando recursos: " + err.message);
        });
    }
    
    // Reiniciar estado de chunks
    resetChunkUploadState();
    
    // Cerrar modal
    closeModal();
    openModal("⚠️ Cancelado", "La subida ha sido cancelada y los recursos limpiados.", "ℹ️");
    
    // Reiniciar input de archivo
    setTimeout(() => {
        const fileInput = document.getElementById('arteFile');
        if (fileInput) fileInput.value = '';
    }, 300);
}

// ✅ FUNCIÓN PARA CAMBIAR PÁGINAS CON INDICADOR DESLIZANTE
function showPage(pageId, tabBtn) {
    // Ocultar todas las páginas
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Mostrar la página seleccionada
    document.getElementById(pageId).classList.add('active');
    
    // Quitar clase active de todos los tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Agregar clase active al tab seleccionado
    tabBtn.classList.add('active');
    
    // ✅ ACTUALIZAR INDICADOR DESLIZANTE
    const navTabs = document.querySelector('.nav-tabs');
    if (navTabs) {
        // Remover clases existentes
        navTabs.classList.remove('tab-formulario', 'tab-solicitudes', 'tab-estadisticas');
        
        // Agregar clase según el tab activo
        if (pageId === 'form-page') {
            navTabs.classList.add('tab-formulario');
        } else if (pageId === 'list-page') {
            navTabs.classList.add('tab-solicitudes');
        } else if (pageId === 'stats-page') {
            navTabs.classList.add('tab-estadisticas');
        }
    }
    
    if (pageId === 'list-page') updateTable();
    if (pageId === 'stats-page') loadStats(currentStatsPeriod);
}

// ✅ FUNCIONES PARA PÁGINA DE ESTADÍSTICAS

// Función para refrescar todas las estadísticas
async function refreshAllStats() {
    const btn = document.getElementById('btnRefreshStats');
    const originalContent = btn.innerHTML;
    
    // Mostrar animación de carga
    btn.innerHTML = '<span>⏳</span> Actualizando...';
    btn.disabled = true;
    
    try {
        await loadStats(currentStatsPeriod);
        
        // Mostrar éxito brevemente
        btn.innerHTML = '<span>✅</span> Actualizado';
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }, 1500);
        
    } catch (error) {
        btn.innerHTML = '<span>❌</span> Error';
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }, 1500);
    }
}

// Función para obtener datos del backend
async function fetchStatsData(period) {
    const params = new URLSearchParams();
    params.append('action', 'getStats');
    params.append('period', period);
    
    const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
    });
    
    if (!response.ok) {
        throw new Error('Error al obtener estadísticas');
    }
    
    const data = await response.json();
    if (!data.success) {
        throw new Error(data.error || 'Error desconocido');
    }
    
    return data.data;
}

// Actualizar contadores universales
function updateStatsCounters(data) {
    document.getElementById('stats-count-total').textContent = data.total || 0;
    document.getElementById('stats-count-pend').textContent = data.pendiente || 0;
    document.getElementById('stats-count-proc').textContent = data.procesando || 0;
    document.getElementById('stats-count-fin').textContent = data.finalizada || 0;
}

// ============================================================
// FUNCIÓN CORREGIDA - REEMPLAZAR LA EXISTENTE
// ============================================================
async function measureInternetSpeed() {
    console.log("✅ NUEVA FUNCIÓN EJECUTÁNDOSE - v2.0");
    console.log("🔍 Midiendo velocidad real de internet...");
    
    // ✅ USAR NETWORK INFORMATION API PRIMERO (más preciso para conexiones rápidas)
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    
    if (connection && connection.downlink) {
        // downlink viene en Mbps directamente según la especificación W3C
        const apiSpeed = connection.downlink;
        console.log(`📡 Network API reporta: ${apiSpeed} Mbps`);
        
        // Validar que sea razonable (no 0.1 ni valores absurdos)
        if (apiSpeed > 1) {
            updateInternetSpeedDisplay(apiSpeed, apiSpeed, apiSpeed);
            return apiSpeed;
        }
    }
    
    // ✅ FALLBACK: Prueba de descarga real con archivo grande
    try {
        // Usar un archivo de prueba de 25MB (Cloudflare o similar)
        const testUrl = 'https://speed.cloudflare.com/__down?bytes=25000000'; // 25MB
        const startTime = performance.now();
        
        const response = await fetch(testUrl, {
            method: 'GET',
            cache: 'no-store',
            mode: 'no-cors' // Evitar CORS issues
        });
        
        // Leer el stream completo para medir tiempo real
        const reader = response.body.getReader();
        let receivedLength = 0;
        
        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            receivedLength += value.length;
        }
        
        const endTime = performance.now();
        const duration = (endTime - startTime) / 1000; // segundos
        
        // ✅ CÁLCULO CORREGIDO: Mbps = (bytes * 8) / (segundos * 1,000,000)
        const bitsDownloaded = receivedLength * 8;
        const speedMbps = bitsDownloaded / (duration * 1000000);
        
        console.log(`📥 Descarga real: ${speedMbps.toFixed(2)} Mbps (${receivedLength} bytes en ${duration.toFixed(2)}s)`);
        
        updateInternetSpeedDisplay(speedMbps, speedMbps, speedMbps);
        return speedMbps;
        
    } catch (e) {
        console.warn("⚠️ Prueba de descarga falló, usando estimación:", e);
        
        // ✅ ÚLTIMO RECURSO: Estimación basada en tipo de conexión
        const fallbackSpeed = estimateFromConnectionType();
        updateInternetSpeedDisplay(fallbackSpeed, fallbackSpeed, fallbackSpeed);
        return fallbackSpeed;
    }
}

// ============================================================
// FUNCIÓN AUXILIAR: Estimación desde tipo de conexión
// ============================================================
function estimateFromConnectionType() {
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    
    if (!connection) return 50; // Default: 50 Mbps
    
    const estimates = {
        '4g': 100,      // 4G típico: 10-100 Mbps
        '3g': 5,        // 3G típico: 1-10 Mbps  
        '2g': 0.5,      // 2G típico: <1 Mbps
        'slow-2g': 0.1  // 2G lento
    };
    
    // Si tenemos downlink y es válido, usarlo
    if (connection.downlink && connection.downlink > 1) {
        return connection.downlink;
    }
    
    // Si no, usar effectiveType
    if (estimates[connection.effectiveType]) {
        return estimates[connection.effectiveType];
    }
    
    // Default basado en saveData
    if (connection.saveData) {
        return 10; // Modo ahorro = conexión lenta
    }
    
    return 50; // Default conservador pero realista
}

// ============================================================
// FUNCIÓN AUXILIAR: Actualizar display de velocidad
// ============================================================
function updateInternetSpeedDisplay(current, avg, max) {
    // Actualizar elementos de la UI
    const valueEl = document.querySelector('[data-stat="internet-speed-value"]');
    const avgEl = document.querySelector('[data-stat="internet-speed-avg"]');
    const maxEl = document.querySelector('[data-stat="internet-speed-max"]');
    const lastEl = document.querySelector('[data-stat="internet-speed-last"]');
    const badge = document.querySelector('[data-stat="internet-status"]');
    
    if (valueEl) valueEl.textContent = current.toFixed(1);
    if (avgEl) avgEl.textContent = avg.toFixed(1);
    if (maxEl) maxEl.textContent = max.toFixed(1);
    
    if (lastEl) {
        const now = new Date();
        lastEl.textContent = now.toLocaleTimeString('es-VE', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
    }
    
    // Actualizar badge de estado
    if (badge) {
        badge.className = 'quota-gauge-status';
        if (current >= 100) {
            badge.textContent = 'EXCELENTE';
            badge.classList.add('status-good');
        } else if (current >= 20) {
            badge.textContent = 'BUENA';
            badge.classList.add('status-good');
        } else if (current >= 5) {
            badge.textContent = 'REGULAR';
            badge.classList.add('status-warning');
        } else {
            badge.textContent = 'LENTA';
            badge.classList.add('status-danger');
        }
    }
    
    // Guardar en variable global para uso del sistema
    speedMonitoring.internetSpeed.current = current;
    speedMonitoring.internetSpeed.average = avg;
    speedMonitoring.internetSpeed.maximum = max;
    speedMonitoring.internetSpeed.lastMeasurement = new Date();
}

// ✅ MEDICIÓN REALISTA DE VELOCIDAD DE SUBIDA (CHUNKS)
async function measureUploadSpeed() {
  const testSize = 128 * 1024; // 128 KB (tamaño similar a chunk pequeño)
  
  try {
    // Crear datos aleatorios (igual que chunks reales)
    const testData = new Uint8Array(testSize);
    for (let i = 0; i < testSize; i++) {
      testData[i] = Math.floor(Math.random() * 256);
    }
    
    const blob = new Blob([testData]);
    const formData = new FormData();
    formData.append('chunkTest', blob);
    formData.append('action', 'chunkSpeedTest');
    formData.append('chunkIndex', '0');
    formData.append('totalChunks', '1');
    formData.append('fileId', 'speedtest_' + Date.now());
    formData.append('filename', 'speedtest.bin');
    formData.append('mime', 'application/octet-stream');
    formData.append('uploadedBy', userCredentials.displayName || 'System');
    formData.append('timestamp', Date.now().toString());
    
    // Medir tiempo REAL de subida
    const startTime = performance.now();
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData,
      cache: 'no-store'
    });
    
    const endTime = performance.now();
    const duration = (endTime - startTime) / 1000; // segundos
    
    // Calcular velocidad REAL (igual que uploadSingleChunkWithProgress)
    const speedKbps = (testSize / 1024) / duration; // KB/s
    const speedMbps = (speedKbps * 8) / 1024; // Mbps
    
    // Determinar tier (igual que detectConnectionSpeed)
    let tier = 'VERY_SLOW';
    if (speedKbps >= 2048) tier = 'ULTRA_FAST';
    else if (speedKbps >= 512) tier = 'FAST';
    else if (speedKbps >= 128) tier = 'MEDIUM';
    else if (speedKbps >= 32) tier = 'SLOW';
    
    // Actualizar historial
    speedMonitoring.uploadSpeed.history.push(speedMbps);
    if (speedMonitoring.uploadSpeed.history.length > 10) {
      speedMonitoring.uploadSpeed.history.shift();
    }
    
    // Actualizar estadísticas
    const history = speedMonitoring.uploadSpeed.history;
    speedMonitoring.uploadSpeed.current = speedMbps;
    speedMonitoring.uploadSpeed.average = 
      history.reduce((a, b) => a + b, 0) / history.length;
    speedMonitoring.uploadSpeed.minimum = Math.min(
      speedMonitoring.uploadSpeed.minimum, 
      speedMbps
    );
    speedMonitoring.uploadSpeed.lastMeasurement = new Date();
    speedMonitoring.uploadSpeed.tier = tier;
    
    // Actualizar UI
    updateUploadSpeedDisplay();
    
    console.log(`📤 Velocidad de Subida: ${speedMbps.toFixed(2)} Mbps (${speedKbps.toFixed(0)} KB/s) - Tier: ${tier}`);
    return speedMbps;
    
  } catch (e) {
    console.error("❌ Error midiendo subida:", e);
    return 0;
  }
}


// ✅ ACTUALIZAR DISPLAY DE VELOCIDAD DE SUBIDA
function updateUploadSpeedDisplay() {
  const data = speedMonitoring.uploadSpeed;
  
  // Actualizar valores
  const valueEl = document.querySelector('[data-stat="upload-speed-value"]');
  const avgEl = document.querySelector('[data-stat="upload-speed-avg"]');
  const tierEl = document.querySelector('[data-stat="upload-speed-tier"]');
  const lastEl = document.querySelector('[data-stat="upload-speed-last"]');
  const badge = document.querySelector('[data-stat="upload-status"]');
  
  if (valueEl) valueEl.textContent = data.current.toFixed(1);
  if (avgEl) avgEl.textContent = data.average.toFixed(1);
  
  if (tierEl) {
    const tierLabels = {
      'ULTRA_FAST': '🚀 Ultra',
      'FAST': '⚡ Rápida',
      'MEDIUM': '📶 Media',
      'SLOW': '🐢 Lenta',
      'VERY_SLOW': '🐌 Muy Lenta'
    };
    tierEl.textContent = tierLabels[data.tier] || '--';
  }
  
  if (lastEl && data.lastMeasurement) {
    const time = data.lastMeasurement.toLocaleTimeString('es-VE', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: true
    });
    lastEl.textContent = time;
  }
  
  // Actualizar badge
  if (badge) {
    badge.className = 'quota-gauge-status';
    if (data.current >= 5) {
      badge.textContent = 'EXCELENTE';
      badge.classList.add('status-good');
    } else if (data.current >= 2) {
      badge.textContent = 'BUENA';
      badge.classList.add('status-good');
    } else if (data.current >= 0.5) {
      badge.textContent = 'REGULAR';
      badge.classList.add('status-warning');
    } else {
      badge.textContent = 'LENTA';
      badge.classList.add('status-danger');
    }
  }
}

// ✅ DIBUJAR GAUGE DE VELOCIDAD DE INTERNET
function updateInternetSpeedGauge(speed) {
    const canvas = document.getElementById('internetSpeedGauge');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width = 200;
    const height = canvas.height = 200;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20;
    
    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);
    
    // Dibujar arco de fondo
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.75, Math.PI * 2.25);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 20;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Calcular ángulo (0-100 Mbps)
    const maxSpeed = 100;
    const speedPercent = Math.min(speed / maxSpeed, 1);
    const endAngle = Math.PI * 0.75 + (Math.PI * 1.5 * speedPercent);
    
    // Determinar color
    let color = '#28a745';
    if (speed < 10) color = '#dc3545';
    else if (speed < 30) color = '#ffc107';
    else if (speed < 60) color = '#17a2b8';
    
    // Dibujar arco de velocidad
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.75, endAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 20;
    ctx.stroke();
}

// ✅ DIBUJAR GAUGE DE VELOCIDAD DE SUBIDA
function updateUploadSpeedGauge(speed) {
    const canvas = document.getElementById('uploadSpeedGauge');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width = 200;
    const height = canvas.height = 200;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20;
    
    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);
    
    // Dibujar arco de fondo
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.75, Math.PI * 2.25);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 20;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Calcular ángulo (0-10 Mbps escala)
    const maxSpeed = 10; // Mbps
    const speedPercent = Math.min(speed / maxSpeed, 1);
    const endAngle = Math.PI * 0.75 + (Math.PI * 1.5 * speedPercent);
    
    // Determinar color según velocidad
    let color = '#28a745'; // verde
    if (speed < 0.5) color = '#dc3545'; // rojo
    else if (speed < 1) color = '#ffc107'; // amarillo
    else if (speed < 3) color = '#17a2b8'; // azul
    else if (speed < 5) color = '#20c997'; // turquesa
    else color = '#28a745'; // verde
    
    // Dibujar arco de velocidad
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.75, endAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 20;
    ctx.stroke();
}

// ✅ INICIAR MONITOREO
function startSpeedMonitoring() {
    // Medición inicial
    measureInternetSpeed();
    measureUploadSpeed();  // ✅ CAMBIADO: Ahora mide velocidad de subida
    
    // Programar mediciones cada 5 minutos
    if (speedMonitoring.intervalId) {
        clearInterval(speedMonitoring.intervalId);
    }
    
    speedMonitoring.intervalId = setInterval(() => {
        measureInternetSpeed();
        measureUploadSpeed();  // ✅ CAMBIADO
    }, speedMonitoring.measurementInterval);
    
    console.log("📊 Monitoreo de velocidad iniciado (cada 5 minutos)");
}

// ✅ DETENER MONITOREO
function stopSpeedMonitoring() {
    if (speedMonitoring.intervalId) {
        clearInterval(speedMonitoring.intervalId);
        speedMonitoring.intervalId = null;
    }
}

// Inicializar gráfico de velocidad de conexión
function initializeConnectionSpeedChart() {
    const ctx = document.getElementById('connectionSpeedChart').getContext('2d');
    
    // Crear gráfico de gauge simple
    statsCharts.connectionSpeed = {
        ctx: ctx,
        width: ctx.canvas.width = 200,
        height: ctx.canvas.height = 200
    };
    
    drawConnectionSpeedGauge(0);
}

// Dibujar gauge de velocidad de conexión
function drawConnectionSpeedGauge(speed) {
    const chart = statsCharts.connectionSpeed;
    if (!chart) return;
    
    const { ctx, width, height } = chart;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20;
    
    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);
    
    // Dibujar arco de fondo
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.7, Math.PI * 2.3);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 20;
    ctx.stroke();
    
    // Calcular ángulo basado en velocidad (0-100 Mbps)
    const maxSpeed = 100;
    const speedPercent = Math.min(speed / maxSpeed, 1);
    const endAngle = Math.PI * 0.7 + (Math.PI * 1.6 * speedPercent);
    
    // Determinar color basado en velocidad
    let color = '#28a745'; // verde
    if (speed < 10) color = '#dc3545'; // rojo
    else if (speed < 30) color = '#ffc107'; // amarillo
    else if (speed < 60) color = '#17a2b8'; // azul
    
    // Dibujar arco de velocidad
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.7, endAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 20;
    ctx.lineCap = 'round';
    ctx.stroke();
}

// Actualizar gauge de velocidad de conexión
function updateConnectionSpeedGauge(data) {
    const speed = data.current || 0;
    const avg = data.average || 0;
    const max = data.maximum || 0;
    
    // Actualizar valores
    document.getElementById('connSpeedValue').textContent = speed.toFixed(1);
    document.getElementById('connSpeedAvg').textContent = avg.toFixed(1);
    document.getElementById('connSpeedMax').textContent = max.toFixed(1);
    
    // Actualizar estado
    const statusElement = document.getElementById('connStatus');
    statusElement.classList.remove('status-good', 'status-warning', 'status-danger');
    
    if (speed >= 50) {
        statusElement.textContent = 'Excelente';
        statusElement.classList.add('status-good');
    } else if (speed >= 20) {
        statusElement.textContent = 'Buena';
        statusElement.classList.add('status-good');
    } else if (speed >= 10) {
        statusElement.textContent = 'Regular';
        statusElement.classList.add('status-warning');
    } else {
        statusElement.textContent = 'Lenta';
        statusElement.classList.add('status-danger');
    }
    
    // Dibujar gauge
    drawConnectionSpeedGauge(speed);
}

// Actualizar gráfico de solicitudes recibidas
function updateRequestsChart(data) {
    const ctx = document.getElementById('requestsChart').getContext('2d');
    
    // Destruir gráfico anterior si existe
    if (statsCharts.requests) {
        statsCharts.requests.destroy();
    }
    
    // Preparar datos
    const labels = data.map(item => item.date);
    const values = data.map(item => item.count);
    
    // Crear nuevo gráfico
    statsCharts.requests = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Solicitudes Recibidas',
                data: values,
                borderColor: '#219ebc',
                backgroundColor: 'rgba(33, 158, 188, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Actualizar gráfico de solicitudes finalizadas
function updateFinalizedChart(data) {
    const ctx = document.getElementById('finalizedChart').getContext('2d');
    
    // Destruir gráfico anterior si existe
    if (statsCharts.finalized) {
        statsCharts.finalized.destroy();
    }
    
    // Preparar datos
    const labels = data.map(item => item.date);
    const values = data.map(item => item.count);
    
    // Crear nuevo gráfico
    statsCharts.finalized = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Solicitudes Finalizadas',
                data: values,
                backgroundColor: '#2d6a4f',
                borderColor: '#2d6a4f',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Actualizar rendimiento de diseñadores
function updateDesignerPerformance(data) {
    const ctx = document.getElementById('designerPerformanceChart').getContext('2d');
    
    // Destruir gráfico anterior si existe
    if (statsCharts.designerPerformance) {
        statsCharts.designerPerformance.destroy();
    }
    
    // Preparar datos
    const designers = Object.keys(data);
    const values = designers.map(designer => data[designer].finalized || 0);
    const colors = ['#fb8500', '#023047', '#2d6a4f', '#ffb703']; // Bermina, Jorsy, María, Xamir
    
    // Crear nuevo gráfico
    statsCharts.designerPerformance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: designers,
            datasets: [{
                data: values,
                backgroundColor: colors.slice(0, designers.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Actualizar tabla
    updateDesignerTable(data);
}

// Actualizar tabla de diseñadores
function updateDesignerTable(data) {
    const tbody = document.getElementById('designerPerformanceTable');
    tbody.innerHTML = '';
    
    const total = Object.values(data).reduce((sum, designer) => sum + (designer.finalized || 0), 0);
    
    Object.entries(data).forEach(([designer, stats]) => {
        const finalized = stats.finalized || 0;
        const percentage = total > 0 ? ((finalized / total) * 100).toFixed(1) : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="padding: 10px; font-weight: 600;">${designer}</td>
            <td style="padding: 10px; text-align: center;">${finalized}</td>
            <td style="padding: 10px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <div style="background: #f1f5f9; border-radius: 10px; padding: 4px 8px; font-weight: 700; min-width: 50px; text-align: center;">
                        ${percentage}%
                    </div>
                    <div style="background: #e9ecef; border-radius: 10px; height: 8px; width: 60px; overflow: hidden;">
                        <div style="background: var(--turquesa); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Actualizar estadísticas detalladas
function updateDetailedStats(topUnidades, topJornadas) {
    // Top Unidades
    const unidadesContainer = document.getElementById('topUnidadesStats');
    unidadesContainer.innerHTML = '';
    
    topUnidades.forEach((unidad, index) => {
        const item = document.createElement('div');
        item.className = 'stats-item';
        item.innerHTML = `
            <span class="stats-item-label">${index + 1}. ${unidad.unidad}</span>
            <span class="stats-item-value">${unidad.count}</span>
        `;
        unidadesContainer.appendChild(item);
    });
    
    // Top Jornadas
    const jornadasContainer = document.getElementById('topJornadasStats');
    jornadasContainer.innerHTML = '';
    
    topJornadas.forEach((jornada, index) => {
        const item = document.createElement('div');
        item.className = 'stats-item';
        item.innerHTML = `
            <span class="stats-item-label">${index + 1}. ${jornada.jornada}</span>
            <span class="stats-item-value">${jornada.count}</span>
        `;
        jornadasContainer.appendChild(item);
    });
}

// Mostrar loading en estadísticas
function showLoadingStats() {
    // Actualizar contadores con loading
    ['total', 'pend', 'proc', 'fin'].forEach(type => {
        const element = document.getElementById(`stats-count-${type}`);
        if (element) element.textContent = '...';
    });
    
    // Mostrar loading en gráficos
    const charts = ['requestsChart', 'finalizedChart', 'designerPerformanceChart'];
    charts.forEach(chartId => {
        const canvas = document.getElementById(chartId);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '14px Georama';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.fillText('Cargando...', canvas.width / 2, canvas.height / 2);
        }
    });
}

// Mostrar error en estadísticas
function showErrorStats() {
    // Actualizar contadores con error
    ['total', 'pend', 'proc', 'fin'].forEach(type => {
        const element = document.getElementById(`stats-count-${type}`);
        if (element) element.textContent = 'Error';
    });
    
    // Mostrar error en gráficos
    const charts = ['requestsChart', 'finalizedChart', 'designerPerformanceChart'];
    charts.forEach(chartId => {
        const canvas = document.getElementById(chartId);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '14px Georama';
            ctx.fillStyle = '#dc3545';
            ctx.textAlign = 'center';
            ctx.fillText('Error al cargar datos', canvas.width / 2, canvas.height / 2);
        }
    });
}

// ✅ FUNCIÓN AUXILIAR: Mostrar gráfico vacío
function showEmptyChart(canvasId, message) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '14px Arial';
    ctx.fillStyle = '#666';
    ctx.textAlign = 'center';
    ctx.fillText(message, canvas.width/2, canvas.height/2);
}
// ✅ VARIABLES GLOBALES PARA ESTADÍSTICAS
let statsCharts = {
connectionSpeed: null,
requests: null,
finalized: null,
designerPerformance: null
};
let currentStatsPeriod = 'month';
let connectionSpeedHistory = [];

// ✅ FUNCIÓN PARA MOSTRAR/OCULTAR PESTAÑA ESTADÍSTICAS
function updateStatsTabVisibility() {
const statsTab = document.getElementById('tab-stats');
if (isAdmin || isDesigner) {
statsTab.classList.remove('hidden');
} else {
statsTab.classList.add('hidden');
}
}

// ✅ CARGAR ESTADÍSTICAS - VERSIÓN FINAL
async function loadStats(period) {
  currentStatsPeriod = period;
  
  // Actualizar botones activos
  document.getElementById('btnStatsDay').classList.toggle('active', period === 'day');
  document.getElementById('btnStatsWeek').classList.toggle('active', period === 'week');
  document.getElementById('btnStatsMonth').classList.toggle('active', period === 'month');
  
  const btnRefresh = document.getElementById('btnRefreshStats');
  if(btnRefresh) btnRefresh.innerHTML = '<span>⏳</span> Cargando...';
  
  try {
    if (!userCredentials.username || !userCredentials.password) {
      throw new Error("Sesión no válida. Por favor inicie sesión nuevamente.");
    }
    
    const params = new URLSearchParams();
    params.append('action', 'getAdvancedStats');
    params.append('period', period);
    params.append('username', userCredentials.username);
    params.append('password', userCredentials.password);
    
    console.log("📤 Solicitando estadísticas para período:", period);
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });
    
    const text = await response.text();
    console.log("📥 Respuesta recibida:", text.substring(0, 500));
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("JSON inválido:", text);
      throw new Error("Respuesta del servidor no válida: " + e.message);
    }
    
    if (!data.success) {
      throw new Error(data.error || "Error desconocido del servidor");
    }
    
    // ✅ INICIAR MONITOREO DE VELOCIDAD AL CARGAR ESTADÍSTICAS
    if (isAdmin || isDesigner) {
        startSpeedMonitoring();
    }
    
    const stats = data.data || {};
    
    // ✅ CARGAR GRÁFICOS - SOLO GRÁFICOS
    console.log("✅ Cargando gráficos para período:", period);
    
    // ❌ COMENTAR O ELIMINAR ESTAS LÍNEAS PARA QUE LOS CONTADORES SEAN FIJOS:
    /*
    document.getElementById('stats-count-total').innerText = stats.total || 0;
    document.getElementById('stats-count-pend').innerText = stats.pendiente || 0;
    document.getElementById('stats-count-proc').innerText = stats.procesando || 0;
    document.getElementById('stats-count-fin').innerText = stats.finalizada || 0;
    */
    
    // ✅ ACTUALIZAR GRÁFICO DE SOLICITUDES POR DÍA
    if (stats.porDia && stats.porDia.length > 0) {
      console.log("📊 Datos porDia:", stats.porDia);
      updateRequestsChart(stats.porDia);
    } else {
      console.warn("⚠️ No hay datos porDia");
      showEmptyChart('requestsChart', 'No hay datos para este período');
    }
    
    // ✅ ACTUALIZAR ESTADÍSTICAS DETALLADAS (CON ESPECIALIDADES Y SERVICIOS)
    updateDetailedStats(stats);
    
    // ✅ CARGAR DATOS ADICIONALES EN PARALELO
    await Promise.all([
      loadHistoryData(period),
      loadDesignerData(period)
    ]);
    
  } catch (e) {
    console.error("❌ Error en loadStats:", e);
    openModal("❌ Error", "No se pudieron cargar las estadísticas: " + e.message, "💥");
    
    // Mostrar zeros en contadores
    document.getElementById('stats-count-total').innerText = '0';
    document.getElementById('stats-count-pend').innerText = '0';
    document.getElementById('stats-count-proc').innerText = '0';
    document.getElementById('stats-count-fin').innerText = '0';
  } finally {
    if(btnRefresh) btnRefresh.innerHTML = '<span>🔄</span> Actualizar';
  }
}

// ✅ CARGAR HISTORIAL (CORREGIDO)
async function loadHistoryData(period) {
    try {
        const params = new URLSearchParams();
        params.append('action', 'getRequestsHistory');
        params.append('period', period);
        params.append('username', userCredentials.username);
        params.append('password', userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        const responseData = await response.json();
        
        // ✅ CORRECCIÓN: Extraer el array de data.data
        if (responseData.success && Array.isArray(responseData.data)) {
            updateFinalizedChart(responseData.data);
        } else {
            console.warn("⚠️ Historial vacío o formato incorrecto");
        }
    } catch (e) {
        console.error("Error cargando historial:", e);
    }
}

// ✅ CARGAR DESEMPEÑO DISEÑADORES (CORREGIDO)
async function loadDesignerData(period) {
    try {
        const params = new URLSearchParams();
        params.append('action', 'getDesignerPerformance');
        params.append('period', period);
        params.append('username', userCredentials.username);
        params.append('password', userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        const responseData = await response.json();
        
        // ✅ CORRECCIÓN: Extraer el array de data.data
        if (responseData.success && Array.isArray(responseData.data)) {
            updateDesignerPerformanceChart(responseData.data);
            updateDesignerPerformanceTable(responseData.data);
        } else {
            console.warn("⚠️ Datos de diseñadores vacíos");
        }
    } catch (e) {
        console.error("Error cargando diseñadores:", e);
    }
}

// ✅ ACTUALIZAR GRÁFICO DE SOLICITUDES (ADAPTADO AL BACKEND)
function updateRequestsChart(data) {
    const ctx = document.getElementById('requestsChart');
    if (!ctx) return;
    
    if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn("No hay datos de solicitudes para mostrar");
        showEmptyChart('requestsChart', 'No hay datos disponibles');
        return;
    }
    
    // ✅ MAPEO CORRECTO DE PROPIEDADES (Backend: fecha/cantidad -> Frontend: date/count)
    const labels = data.map(d => {
        if (d.fecha) {
            const parts = d.fecha.split('-');
            return `${parts[2]}/${parts[1]}`; // Formato DD/MM
        }
        return '';
    });
    
    const values = data.map(d => d.cantidad || 0);
    
    if (statsCharts.requests) {
        statsCharts.requests.destroy();
    }
    
    statsCharts.requests = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Solicitudes Recibidas',
                data: values,
                borderColor: '#219ebc',
                backgroundColor: 'rgba(33, 158, 188, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// ✅ ACTUALIZAR GRÁFICO DE FINALIZADAS
function updateFinalizedChart(data) {
    const ctx = document.getElementById('finalizedChart');
    if (!ctx) return;

    if (!data || data.length === 0) {
        console.warn("No hay datos de historial para mostrar");
        return;
    }

    const labels = data.map(d => d.dia || '');
    const recibidas = data.map(d => d.recibidas || 0);
    const finalizadas = data.map(d => d.finalizadas || 0);

    if (statsCharts.finalized) {
        statsCharts.finalized.destroy();
    }

    statsCharts.finalized = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Recibidas',
                    data: recibidas,
                    backgroundColor: '#8ecae6'
                },
                {
                    label: 'Finalizadas',
                    data: finalizadas,
                    backgroundColor: '#2d6a4f'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// ✅ ACTUALIZAR GRÁFICO DE DESEMPEÑO DE DISEÑADORES
function updateDesignerPerformanceChart(data) {
    const ctx = document.getElementById('designerPerformanceChart');
    if (!ctx) return;

    const labels = data.map(d => d.nombre);
    const values = data.map(d => d.finalizadas);
    const colors = data.map(d => d.color);

    if (statsCharts.designerPerformance) {
        statsCharts.designerPerformance.destroy();
    }

    statsCharts.designerPerformance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// ✅ ACTUALIZAR TARJETAS DE DESEMPEÑO DE DISEÑADORES (FORMATO DIDÁCTICO)
function updateDesignerPerformanceTable(data) {
const container = document.getElementById('designerPerformanceCards');
if (!container) return;

// Calcular el total correcto incluyendo todos los diseñadores
const totalFinalizadas = data.reduce((sum, d) => sum + (d.finalizadas || 0), 0);

container.innerHTML = data.map(d => {
    const finalized = d.finalizadas || 0;
    // Calcular porcentaje basado en el total de todos los diseñadores
    const percentage = totalFinalizadas > 0 ? ((finalized / totalFinalizadas) * 100).toFixed(1) : 0;
    
    // Determinar inicial del diseñador
    const getInitial = (name) => {
        if (name === 'Bermina') return '👩';
        if (name === 'Jorsy') return '👨';
        if (name === 'María F.') return '👩';
        if (name === 'Xamir') return '👨';
        if (name === 'Fulan@') return '👤';
        return '👤';
    };
    
    return `
<div class="designer-card">
    <div class="designer-avatar" style="background: ${d.color};">
        ${getInitial(d.nombre)}
    </div>
    <div class="designer-info">
        <div class="designer-name">${d.nombre}</div>
        <div class="designer-stats">
            <div class="designer-stat">
                <div class="designer-stat-value">${finalized}</div>
                <div class="designer-stat-label">Finalizadas</div>
            </div>
            <div class="designer-percentage">${percentage}%</div>
        </div>
    </div>
</div>
`;
}).join('');
}

// ✅ ACTUALIZAR ESTADÍSTICAS DETALLADAS (FORMATO TARJETAS)
function updateDetailedStats(stats) {
    // --- 1. TOP UNIDADES ---
    const topUnidades = Object.entries(stats.porUnidad || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5
    
    const unidadesContainer = document.getElementById('topUnidadesStats');
    if (unidadesContainer) {
        unidadesContainer.innerHTML = topUnidades.length > 0 
            ? topUnidades.map(([name, count]) => `
                <li class="stat-card-item">
                    <span class="stat-card-label" title="${name}">${name}</span>
                    <span class="stat-card-value">${count}</span>
                </li>
            `).join('')
            : '<li class="stat-card-item"><span class="stat-card-label">Sin datos</span></li>';
    }

    // --- 2. TOP JORNADAS ---
    const topJornadas = Object.entries(stats.porJornada || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5

    const jornadasContainer = document.getElementById('topJornadasStats');
    if (jornadasContainer) {
        jornadasContainer.innerHTML = topJornadas.length > 0
            ? topJornadas.map(([name, count]) => `
                <li class="stat-card-item">
                    <span class="stat-card-label" title="${name}">${name}</span>
                    <span class="stat-card-value">${count}</span>
                </li>
            `).join('')
            : '<li class="stat-card-item"><span class="stat-card-label">Sin datos</span></li>';
    }

    // --- 3. TOP ESPECIALIDADES ---
    const topEspecialidades = Object.entries(stats.porEspecialidad || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5

    const especialidadesContainer = document.getElementById('topEspecialidadesStats');
    if (especialidadesContainer) {
        especialidadesContainer.innerHTML = topEspecialidades.length > 0
            ? topEspecialidades.map(([name, count]) => `
                <li class="stat-card-item">
                    <span class="stat-card-label" title="${name}">${name}</span>
                    <span class="stat-card-value">${count}</span>
                </li>
            `).join('')
            : '<li class="stat-card-item"><span class="stat-card-label">Sin datos</span></li>';
    }

    // --- 4. TOP SERVICIOS ---
    const topServicios = Object.entries(stats.porServicio || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5

    const serviciosContainer = document.getElementById('topServiciosStats');
    if (serviciosContainer) {
        serviciosContainer.innerHTML = topServicios.length > 0
            ? topServicios.map(([name, count]) => `
                <li class="stat-card-item">
                    <span class="stat-card-label" title="${name}">${name}</span>
                    <span class="stat-card-value">${count}</span>
                </li>
            `).join('')
            : '<li class="stat-card-item"><span class="stat-card-label">Sin datos</span></li>';
    }
}

// ✅ ACTUALIZAR VISIBILIDAD DE BÚSQUEDA Y ESTADÍSTICAS
function updateSearchVisibility() {
const searchContainer = document.getElementById('designer-search-container');
if (isAdmin || isDesigner) {
searchContainer.classList.remove('hidden');
if (!window.searchEventsInitialized) {
initSearchEvents();
window.searchEventsInitialized = true;
}
} else {
searchContainer.classList.add('hidden');
resetSearchHighlight();
document.getElementById('idNotFoundModal').style.display = 'none';
}
updateStatsTabVisibility();  // ✅ AGREGAR
}

// ✅ REFRESCAR TODAS LAS ESTADÍSTICAS
function refreshAllStats() {
loadStats(currentStatsPeriod);
}

// ✅ ACTUALIZAR CONTADORES GLOBALES (FIJOS)
function updateCounters(stats) {
  if (!stats) return;
  
  // 1. CONTADORES DE LA PESTAÑA SOLICITUDES (ARRIBA DE LA TABLA)
  document.getElementById('count-total').innerText = stats.total || 0;
  document.getElementById('count-pend').innerText = stats.pend || 0;
  document.getElementById('count-proc').innerText = stats.proc || 0;
  document.getElementById('count-fin').innerText = stats.fin || 0;
  
  // Contadores Admin (si existen)
  const countTotalAdmin = document.getElementById('count-total-admin');
  if(countTotalAdmin) countTotalAdmin.innerText = stats.total || 0;
  const countPendAdmin = document.getElementById('count-pend-admin');
  if(countPendAdmin) countPendAdmin.innerText = stats.pend || 0;
  const countProcAdmin = document.getElementById('count-proc-admin');
  if(countProcAdmin) countProcAdmin.innerText = stats.proc || 0;
  const countFinAdmin = document.getElementById('count-fin-admin');
  if(countFinAdmin) countFinAdmin.innerText = stats.fin || 0;

  // 2. CONTADORES DE LA PESTAÑA ESTADÍSTICAS (ARRIBA DE LOS GRÁFICOS)
  // Estos AHORA serán fijos (Totales BD) y no cambiarán al filtrar Día/Semana/Mes
  document.getElementById('stats-count-total').innerText = stats.total || 0;
  document.getElementById('stats-count-pend').innerText = stats.pendiente || stats.pend || 0;
  document.getElementById('stats-count-proc').innerText = stats.procesando || stats.proc || 0;
  document.getElementById('stats-count-fin').innerText = stats.finalizada || stats.fin || 0;

  // Visibilidad según rol
  if (isAdmin) {
    document.getElementById('stats-panel').style.display = 'none';
    document.getElementById('combined-stats').style.display = 'flex';
  } else {
    document.getElementById('stats-panel').style.display = 'flex';
    document.getElementById('combined-stats').style.display = 'none';
  }
  
  updateSearchVisibility();
  if (isSearchActive && currentSearchId) applySearchHighlight(currentSearchId);
  if (isPanelOpen && selectedRequestId) updatePanelContent();
  
  document.getElementById('th-admin').classList.toggle('hidden', !isAdmin);
  document.getElementById('th-designer').classList.toggle('hidden', !isDesigner);
}

</script>
</body>
</html>
