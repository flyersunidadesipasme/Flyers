<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIRA | Sistema Integral de Requerimientos de Artes</title>
<link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600;800&display=swap" rel="stylesheet">
<style>
:root {
--celeste: #8ecae6; --turquesa: #219ebc; --azul-deep: #023047;
--amarillo: #ffb703; --naranja: #fb8500; --rojo: #e63946;
--verde: #2d6a4f; --gris: #edf2f4;
}
* { font-family: 'Georama', sans-serif; box-sizing: border-box; font-weight: 500; }
body { background: #f4f7fa; margin: 0; padding-bottom: 50px; color: var(--azul-deep); }
header { background: var(--azul-deep); padding: 8px 25px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; min-height: 60px; }
.brand-container { display: flex; flex-direction: column; align-items: flex-start; flex: 1; }
.header-title { margin: 0; font-size: 1.3rem; font-weight: 800; color: white; line-height: 1; }
.acronimo { font-size: 0.55rem; font-weight: 400; letter-spacing: 0.5px; margin-top: 2px; opacity: 0.9; text-transform: uppercase; color: white; max-width: 250px; }
.nav-tabs { display: flex; justify-content: center; gap: 10px; flex: 1; }
.tab-btn { padding: 6px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: 800; text-transform: uppercase; font-size: 0.75rem; background: rgba(255,255,255,0.1); color: white; transition: 0.3s; display: flex; align-items: center; gap: 6px; }
.tab-btn.active { background: var(--amarillo); color: var(--azul-deep); }
.admin-access { flex: 1; display: flex; justify-content: flex-end; gap: 10px; }
.btn-login { background: var(--amarillo); border: none; padding: 6px 14px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.75rem; box-shadow: 0 3px 0 #c79100; transition: 0.2s; }
.btn-login:active { transform: translateY(2px); box-shadow: 0 1px 0 #c79100; }
.btn-logout { background: var(--rojo); color: white; border: none; padding: 6px 14px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.75rem; }
.row-new { background-color: #e3f2fd !important; border-left: 5px solid var(--turquesa) !important; }
.badge-new { background: var(--turquesa); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; animation: blink 2s infinite; }
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
.stats-grid { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.stat-card { flex: 1; min-width: 100px; padding: 8px; border-radius: 12px; text-align: center; color: white; font-weight: 800; }
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep); }
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }
.stat-label { font-size: 0.6rem; text-transform: uppercase; display: block; opacity: 0.8; }
.stat-val { font-size: 1.1rem; }
.container { max-width: 1200px; margin: 15px auto; padding: 25px; background: white; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.06); }
.aviso-48h { background: #fff3e0; border: 2.5px solid var(--naranja); color: var(--naranja); padding: 15px; border-radius: 15px; text-align: center; font-weight: 800; margin-bottom: 25px; font-size: 1.1rem; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
.section-title { display: block; font-weight: 800; font-size: 0.85rem; color: var(--turquesa); margin: 20px 0 12px; border-left: 4px solid var(--turquesa); padding-left: 10px; text-transform: uppercase; }
.category-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }
.card-btn { background: #fff; border: 2px solid var(--gris); border-radius: 12px; padding: 6px 4px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 800; font-size: 0.75rem; min-height: 45px; line-height: 1.1; color: var(--azul-deep); }
.card-btn.selected { background: var(--amarillo); border-color: var(--naranja); transform: scale(0.98); }
.field-error { border: 2px solid var(--rojo) !important; animation: border-blink 0.8s infinite alternate !important; background: #fff5f5 !important; }
@keyframes border-blink { from { border-color: var(--rojo); box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); } to { border-color: transparent; box-shadow: none; } }
.btn-time { padding: 8px; border-radius: 12px; border: 2px solid var(--gris); cursor: pointer; font-weight: 800; font-size: 0.85rem; background: #f8f9fa; color: var(--azul-deep); flex: 1; transition: 0.3s; }
.btn-time.active { background: var(--azul-deep); color: white; border-color: var(--azul-deep); }
.modern-input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--gris); font-size: 0.95rem; outline: none; transition: 0.3s; background: #fdfdfd; font-weight: 500; }
.modern-input:focus { border-color: var(--turquesa); background: white; }
.pass-container { position: relative; width: 100%; }
.eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem; opacity: 0.6; z-index: 10; }
.photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
.upload-box { height: 90px; border: 2.5px dashed var(--celeste); border-radius: 15px; position: relative; overflow: hidden; background: #f0f9ff; }
.upload-label { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; cursor: pointer; font-size: 0.7rem; font-weight: 800; color: var(--turquesa); text-align: center; }
.preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; }
.remove-btn { position: absolute; top: 5px; right: 5px; background: var(--rojo); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-weight: 800; cursor: pointer; display: none; z-index: 10; }
.btn-send { background: var(--azul-deep); color: white; width: 100%; padding: 14px; border-radius: 18px; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 30px; box-shadow: 0 6px 15px rgba(2, 48, 71, 0.3); transition: 0.3s; }
.btn-send:hover { transform: translateY(-2px); background: #054a6d; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.85); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 20000; padding: 20px; }
.modal-content { background: white; padding: 40px 30px; border-radius: 30px; max-width: 450px; width: 100%; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative; }
/* MODAL CONFIRMACI√ìN */
#confirmModal .modal-content { max-width: 600px; padding: 30px; }
#previewContent { text-align: left; max-height: 400px; overflow-y: auto; margin-bottom: 20px; }
#previewContent p { margin: 8px 0; line-height: 1.4; }
/* MODAL MANTENIMIENTO */
#maintOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--azul-deep); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
.modal-btn { background: var(--turquesa); color: white; border: none; padding: 12px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 25px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
.modal-btn:hover { background: var(--azul-deep); }
.modal-btn-alt { background: var(--gris); color: var(--azul-deep); margin-top: 10px; }

/* ‚úÖ NUEVA CLASE PARA BOTONES IGUALES EN MODAL DE CONFIRMACI√ìN */
.modal-btn-confirm {
  flex: 1;
  min-width: 140px;
  padding: 12px;
  font-size: 1rem;
  font-weight: 800;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.modal-btn-confirm.corregir {
  background: var(--gris);
  color: var(--azul-deep);
}
.modal-btn-confirm.enviar {
  background: var(--turquesa);
  color: white;
}
.modal-btn-confirm:disabled {
  background: #e9ecef;
  color: #495057;
  cursor: not-allowed;
}

.table-container { width: 100%; overflow-x: auto; margin-top: 5px; }
table { width: 100%; border-collapse: collapse; min-width: 900px; }
th { background: #f8f9fa; padding: 8px 10px; text-align: left; font-size: 0.65rem; text-transform: uppercase; font-weight: 800; color: var(--turquesa); border-bottom: 2px solid var(--gris); }
td { padding: 6px 10px; border-bottom: 1px solid var(--gris); font-size: 0.82rem; line-height: 1.2; color: #1a1a1a; font-weight: 500; }
.status-pill { padding: 3px 10px; border-radius: 15px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; transition: 0.3s; }
.txt-bold { font-weight: 800; color: var(--azul-deep); }
.txt-small { font-size: 0.72rem; color: #4b4b4b; display: block; margin-bottom: 1px; font-weight: 500; }
.status-pendiente { background: var(--celeste); color: var(--azul-deep); }
.status-procesando { background: var(--amarillo); color: var(--azul-deep); }
.status-finalizada { background: var(--verde); color: white; }
.admin-actions { display: flex; gap: 4px; justify-content: flex-end; flex-wrap: wrap; }
.btn-act { border: none; border-radius: 5px; padding: 4px 6px; cursor: pointer; font-size: 9px; color: white; font-weight: 800; transition: 0.2s; }
.btn-act:hover { transform: scale(1.1); }
.bg-pend { background: var(--celeste); color: var(--azul-deep); }
.bg-proc { background: var(--amarillo); color: var(--azul-deep); }
.bg-fin { background: var(--verde); }
.btn-trash { background: none; border: none; cursor: pointer; font-size: 1.1rem; margin-left: 8px; filter: grayscale(1); transition: 0.3s; }
.btn-trash:hover { filter: grayscale(0); transform: rotate(10deg); }
/* Nuevos Estilos Botones Admin */
.btn-arte { background: #4a90e2; color: white; border: none; border-radius: 5px; padding: 4px 6px; font-size: 9px; font-weight: 800; cursor: pointer; }
.btn-ver { background: #f39c12; color: white; border: none; border-radius: 5px; padding: 4px 6px; font-size: 9px; font-weight: 800; cursor: pointer; text-decoration: none; }
.btn-tg { background: #0088cc; color: white; border: none; border-radius: 5px; padding: 4px 6px; font-size: 9px; font-weight: 800; cursor: pointer; }
.hidden { display: none !important; }
.page { display: none; }
.page.active { display: block; }
#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 30000; color: white; text-align: center; padding: 20px; }
.spinner { width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.1); border-top: 6px solid var(--amarillo); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 25px; }
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="maintOverlay">
<span style="font-size: 80px;">üõ†Ô∏è</span>
<h1 style="font-weight: 800; font-size: 2.5rem; margin: 20px 0;">SISTEMA EN MANTENIMIENTO</h1>
<p style="font-size: 1.2rem; max-width: 500px; opacity: 0.9;">Estamos trabajando para mejorar tu experiencia. Disculpen las molestias ocasionadas.</p>
<button class="btn-login" style="margin-top: 30px; padding: 12px 25px; font-size: 1rem;" onclick="showLogin()">üîì ACCESO ADMINISTRADOR</button>
</div>
<div id="loadingOverlay">
<div class="spinner"></div>
<div class="loading-text" id="loadMainTxt">Procesando...</div>
<div class="loading-subtext" id="loadSubTxt"></div>
</div>
<div class="modal-overlay" id="modalAlert">
<div class="modal-content">
<span id="modalIcon" style="font-size: 60px; display: block; margin-bottom: 10px;">‚ö†Ô∏è</span>
<div id="modalTitle" style="font-weight: 800; font-size: 1.4rem; color: var(--azul-deep);">Atenci√≥n</div>
<div id="modalMsg" style="margin-top: 15px; color: #555; font-size: 1rem; line-height: 1.4; font-weight: 500;"></div>
<div id="loginArea" class="hidden" style="margin-top:20px; text-align: left;">
<label class="txt-small">Usuario del Sistema:</label>
<input type="text" id="adminUser" class="modern-input" style="margin-bottom:15px;" placeholder="Ingrese usuario">
<label class="txt-small">Clave de Seguridad:</label>
<div class="pass-container">
<input type="password" id="adminPass" class="modern-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
<span class="eye-icon" onclick="togglePass()">üëÅÔ∏è</span>
</div>
</div>
<div id="uploadArea" class="hidden" style="margin-top:20px;">
<input type="file" id="arteFile" class="modern-input" accept=".jpg,.jpeg,.png,.pdf,.zip" style="font-size: 0.8rem;">
<p style="font-size: 0.7rem; color: #666; margin-top: 5px;">M√°ximo 5MB (Formatos: JPG, PNG, PDF, ZIP)</p>
<input type="hidden" id="currentReqId">
</div>
<button id="mainModalBtn" class="modal-btn">ENTENDIDO</button>
<button id="closeModalBtn" class="modal-btn modal-btn-alt hidden" onclick="closeModal()">CERRAR</button>
</div>
</div>
<!-- Modal de Confirmaci√≥n -->
<div class="modal-overlay" id="confirmModal">
<div class="modal-content">
<h2 style="font-weight: 800; color: var(--azul-deep); margin-top: 0;">üîç Revisa tu Solicitud</h2>
<div id="previewContent"></div>
<div style="display: flex; gap: 12px; justify-content: center; width: 100%; max-width: 500px; margin: 0 auto; margin-top: 20px;">
  <button id="btnCorregir" class="modal-btn-confirm corregir">‚úèÔ∏è Corregir</button>
  <button id="btnEnviarConfirmado" class="modal-btn-confirm enviar" disabled>üöÄ Enviar Solicitud (<span id="countdown">10</span>)</button>
</div>
</div>
</div>
<header>
<div class="brand-container">
<h1 class="header-title">SIRA</h1>
<span class="acronimo">Sistema Integral de Requerimientos de Artes</span>
</div>
<div class="nav-tabs">
<button id="tab-form" class="tab-btn active" onclick="showPage('form-page', this)">üìù FORMULARIO</button>
<button id="tab-list" class="tab-btn" onclick="showPage('list-page', this)">üìã SOLICITUDES</button>
</div>
<div class="admin-access">
<button id="maintBtn" class="btn-login hidden" style="background: var(--rojo); box-shadow: 0 3px 0 #9b1c24; color: white;" onclick="toggleMaintMode()">‚öôÔ∏è Mantenimiento</button>
<button id="authBtn" class="btn-login" onclick="showLogin()">üîê Administrador</button>
</div>
</header>
<div class="container page active" id="form-page">
<div class="aviso-48h">‚ö†Ô∏è IMPORTANTE: LAS SOLICITUDES DEBEN REALIZARSE CON 48 HORAS DE ANTICIPACI√ìN</div>
<form id="sigrafForm" novalidate>
<label class="section-title">üè• 1. REGI√ìN *</label>
<div class="category-row" id="region-grid"></div>
<div id="unidad-section" class="hidden">
<label class="section-title">üè• 1.5. UNIDAD M√âDICA *</label>
<div class="category-row" id="unidad-grid"></div>
</div>
<label class="section-title">üìÇ 2. TIPO DE JORNADA *</label>
<div class="category-row" id="cat-grid">
<div class="card-btn" onclick="selectCat(this, 'escuela')">Ipasme va a la Escuela</div>
<div class="card-btn" onclick="selectCat(this, 'integral')">Jornada de Atenci√≥n M√©dica Integral</div>
<div class="card-btn" onclick="selectCat(this, 'conjunta')">Jornada Conjunta</div>
<div class="card-btn" onclick="selectCat(this, 'vacuna')">Plan Masivo de Vacunaci√≥n</div>
<div class="card-btn" onclick="selectCat(this, 'quirurgica')">Captaci√≥n Quir√∫rgica</div>
<div class="card-btn" onclick="selectCat(this, 'oftalmo')">Captaci√≥n Quir√∫rgica Oftalmol√≥gica</div>
<div class="card-btn" onclick="selectCat(this, 'otros')">Otros</div>
</div>
<div id="sec-3" class="hidden">
<label class="section-title" id="label-3">ü©∫ 3. DETALLE *</label>
<div id="cont-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;"></div>
</div>
<div id="sec-4" class="hidden">
<label class="section-title">‚ú® 4. SERVICIOS ADICIONALES (OPCIONAL)</label>
<div id="cont-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;"></div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="section-title">üìÖ 5. FECHA DE ACTIVIDAD *</label><input type="date" id="fecha" class="modern-input"></div>
<div><label class="section-title">‚è∞ 6. HORA DE INICIO *</label><div class="hora-container" id="hora-box" style="display: flex; gap: 10px; align-items: center;"><input type="text" id="hora" class="modern-input" style="width:100px; text-align:center" placeholder="08:00"><button type="button" class="btn-time" id="btn-am" onclick="setAMPM('a. m.')">a. m.</button><button type="button" class="btn-time" id="btn-pm" onclick="setAMPM('p. m.')">p. m.</button></div></div>
</div>
<label class="section-title">üìç 7. UBICACI√ìN *</label>
<div style="background: #fff8e1; border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600; line-height: 1.4;">
‚ö†Ô∏è Complete al menos el nombre de la instituci√≥n. La direcci√≥n exacta es opcional pero recomendada.
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div>
<label class="txt-small">üè´ Instituci√≥n *</label>
<input type="text" id="institucion" class="modern-input" placeholder="Escuela, Liceo, Jard√≠n de ni√±os, etc.">
</div>
<div>
<label class="txt-small">üß≠ Direcci√≥n exacta</label>
<input type="text" id="direccion-exacta" class="modern-input" placeholder="Municipio, Parroquia, Ciudad, etc.">
</div>
</div>
<label class="section-title">üì±‚úâÔ∏è 8. DATOS DE CONTACTO *</label>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="txt-small">N√∫mero de Tel√©fono</label><input type="tel" id="tlf" class="modern-input" placeholder="04xx 1234567"></div>
<div><label class="txt-small">Correo Electr√≥nico</label><input type="email" id="mail" class="modern-input" placeholder="Para env√≠o de arte final *"></div>
</div>
<label class="section-title">‚úèÔ∏è 9. OBSERVACIONES / DETALLES DE DISE√ëO</label><textarea id="observaciones" class="modern-input" rows="3" placeholder="Indique medidas, colores institucionales o entes participantes adicionales..."></textarea>
<label class="section-title">üì∏ 10. SOPORTES FOTOGR√ÅFICOS (M√ÅX 3)</label>
<div style="background: #fff8e1; border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600; line-height: 1.4;">
‚ö†Ô∏è Si el registro fotogr√°fico enviado no cumple con las condiciones de calidad para la solicitud, ser√° sustituido por material de archivo.
</div>
<div class="photo-grid">
<div class="upload-box"><label for="f1" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f1" class="hidden" accept="image/*" onchange="handleFile(this, 'p1', 'b1')"><img id="p1" class="preview"><button type="button" id="b1" class="remove-btn" onclick="clearFile('f1', 'p1', 'b1')">√ó</button></div>
<div class="upload-box"><label for="f2" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f2" class="hidden" accept="image/*" onchange="handleFile(this, 'p2', 'b2')"><img id="p2" class="preview"><button type="button" id="b2" class="remove-btn" onclick="clearFile('f2', 'p2', 'b2')">√ó</button></div>
<div class="upload-box"><label for="f3" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f3" class="hidden" accept="image/*" onchange="handleFile(this, 'p3', 'b3')"><img id="p3" class="preview"><button type="button" id="b3" class="remove-btn" onclick="clearFile('f3', 'p3', 'b3')">√ó</button></div>
</div>
<button type="submit" id="submitBtn" class="btn-send">üöÄ ENVIAR SOLICITUD A COMUNICACIONES</button>
</form>
</div>
<div class="container page" id="list-page">
<div class="stats-grid" id="stats-panel">
<div class="stat-card st-total"><span class="stat-label">Total</span><span id="count-total" class="stat-val">0</span></div>
<div class="stat-card st-pend"><span class="stat-label">Pendiente</span><span id="count-pend" class="stat-val">0</span></div>
<div class="stat-card st-proc"><span class="stat-label">En Proceso</span><span id="count-proc" class="stat-val">0</span></div>
<div class="stat-card st-fin"><span class="stat-label">Finalizada</span><span id="count-fin" class="stat-val">0</span></div>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th id="col-fecha-registro">FECHA REGISTRO</th>
<th id="col-fecha-actividad">FECHA ACTIVIDAD</th>
<th id="col-id-solicitud" class="hidden">ID SOLICITUD</th>
<th>UNIDAD SOLICITANTE</th>
<th>TIPO DE JORNADA</th>
<th style="text-align:center">SOPORTES</th>
<th>ESTATUS</th>
<th id="th-admin" class="hidden" style="text-align:right">ACCIONES ADMIN</th>
</tr>
</thead>
<tbody id="solicitudes-body"></tbody>
</table>
</div>
</div>
<script>
// === LISTADO DE UNIDADES IPASME POR REGI√ìN (CORREGIDO Y ORDENADO) ===
const UNIDADES_IPASME_RAW = {
"Capital": [
"Don Sim√≥n Rodr√≠guez",
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende"
],
"Regi√≥n Central": [
"Maracay", "La Victoria", "Valencia", "Puerto Cabello",
"Club Villas Ipasmar", "Guatire", "Ocumare del Tuy", "Caucagua",
"Carrizal", "La Guaira"
],
"Regi√≥n Occidental": [
"Cabimas", "Maracaibo", "Machiques", "San Carlos del Zulia",
"El Moj√°n", "Barquisimeto", "El Tocuyo", "Carora",
"San Felipe", "Nirgua", "Punto Fijo", "Coro",
"Buchivacoa", "Puerto Cumarebo"
],
"Regi√≥n Los Andes": [
"El Vig√≠a", "M√©rida", "Tovar",
"Hotel Valle Grande", "La Grita", "Rubio",
"San Crist√≥bal", "San Juan de Col√≥n", "Ure√±a",
"Bocon√≥", "Trujillo", "Valera"
],
"Regi√≥n Oriental": [
"Anaco", "Barcelona", "Cantaura", "El Tigre",
"Isidora Agnes, Ciudad Bol√≠var", "Guasipati",
"Profa. Mirelva Mart√≠nez, San F√©lix", "Upata", "Matur√≠n",
"Punta de Mata", "Cuman√°", "Cumanacoa", "Car√∫pano",
"G√ºiria", "Tucupita", "Casacoima", "La Asunci√≥n",
"Puerto Ayacucho"
],
"Regi√≥n Los Llanos": [
"Altagracia de Orituco", "Calabozo", "San Juan de los Morros",
"Valle de la Pascua", "Zaraza", "San Carlos de Cojedes",
"Tinaquillo", "San Fernando de Apure", "Guasdualito",
"Barinas", "Santa B√°rbara de Barinas", "Acarigua", "Guanare"
]
};
const ORDEN_REGIONES = [
"Capital",
"Regi√≥n Central",
"Regi√≥n Occidental",
"Regi√≥n Los Andes",
"Regi√≥n Oriental",
"Regi√≥n Los Llanos"
];
function getNombreRegionLimpio(regionKey) {
if (regionKey === "Capital") return "Capital";
return regionKey.replace("Regi√≥n ", "");
}
const UNIDADES_IPASME = {};
ORDEN_REGIONES.forEach(region => {
const unidadesOriginales = UNIDADES_IPASME_RAW[region] || [];
UNIDADES_IPASME[region] = [...unidadesOriginales].sort((a, b) =>
a.trim().localeCompare(b.trim(), 'es', { sensitivity: 'base' })
);
});
let isAdmin = false;
let selectedAMPM = "";
let catType = "";
let catName = "";
let localData = [];
let isMaintActive = false;
let selectedRegionKey = "";
let selectedUnidad = "";
const DATA = {
especialidades: ["Alergolog√≠a", "Cardiolog√≠a", "Cirug√≠a general", "Dermatolog√≠a", "Fisiatr√≠a", "Foniatr√≠a", "Gastroenterolog√≠a", "Geriatr√≠a", "Gerontolog√≠a", "Ginecolog√≠a y obstetricia", "Infectolog√≠a", "Medicina familiar", "Medicina general", "Medicina interna", "Nefrolog√≠a", "Neumolog√≠a", "Neurolog√≠a", "Nutrici√≥n", "Odontolog√≠a", "Oftalmolog√≠a", "Oncolog√≠a", "Optometr√≠a", "Pediatr√≠a", "Psicolog√≠a", "Psiquiatr√≠a", "Reumatolog√≠a", "Traumatolog√≠a", "Urolog√≠a"],
servicios: ["Actividades recreativas", "Afiliaci√≥n", "Agudeza visual", "Aplicaci√≥n de fl√∫or", "Asesor√≠a legal", "Bienestar social", "Captaci√≥n odontol√≥gica", "Captaci√≥n quir√∫rgica general", "Captaci√≥n quir√∫rgica oftalmol√≥gica", "Citolog√≠a", "Control de glicemia", "Control de talla y peso", "Desparasitaci√≥n", "Despistaje de glicemia capilar", "Despistaje HTA", "Ecograf√≠a", "Electrocardiograma", "Farmacia", "Fisioterapia", "Fonoaudiolog√≠a", "Ingenier√≠a biom√©dica", "Inmunizaci√≥n", "Laboratorio", "Liberaci√≥n de hipoteca", "Masoterapia", "Podolog√≠a", "Quiropraxia", "Reposos m√©dicos", "Sesi√≥n educativa", "Servicios sociales", "Terapia de lenguaje (Logopedia)", "Terapia del dolor", "Terapia ocupacional", "Tipiaje"],
vacunas: ["Fiebre amarilla", "Pentavalente", "Polio IPV", "Polio oral", "Toxoide (tet√°nico/dift√©rico)", "Trivalente viral (SRP)"],
quirurgica: ["Bocio hiperfuncionante", "Colectom√≠a", "Enfermedad hemorroidal", "Esterilizaci√≥n", "Fibromatosis", "Fimosis", "Hernia abdominal", "Hernia epig√°strica", "Hernia escrotal", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Histerectom√≠a", "Lipomas", "Litiasis vesicular (Colecistectom√≠as)", "Lunares", "Miomatosis uterina", "Nevus", "N√≥dulos mamarios simples", "Paridad satisfecha", "Prolapso", "Quiste (TU)", "Quiste de epid√≠dimo", "Quiste seb√°ceo", "Quiste tirogloso", "Quistes seb√°ceos", "Tumores ov√°ricos", "Varicocele", "Vasectom√≠a", "Verrugas"],
oftalmo: ["Cataratas", "Cirug√≠a pl√°stica ocular", "Dacriocistorrinostom√≠a", "Desprendimiento de retina", "Glaucoma", "Melanoma uveal", "Pterigi√≥n", "Ptosis palpebral", "Queratoplast√≠a", "Retinoblastoma", "Tumores oculares"]
};
document.addEventListener('DOMContentLoaded', () => {
const regionGrid = document.getElementById('region-grid');
ORDEN_REGIONES.forEach(regionKey => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = getNombreRegionLimpio(regionKey);
btn.onclick = () => selectRegion(regionKey);
regionGrid.appendChild(btn);
});
updateTable();
});
function selectRegion(regionKey) {
document.querySelectorAll('#region-grid .card-btn').forEach(b => b.classList.remove('selected'));
const index = ORDEN_REGIONES.indexOf(regionKey);
if (index !== -1) {
document.querySelector(`#region-grid .card-btn:nth-child(${index + 1})`).classList.add('selected');
}
selectedRegionKey = regionKey;
selectedUnidad = "";
const unidadGrid = document.getElementById('unidad-grid');
unidadGrid.innerHTML = "";
const unidades = UNIDADES_IPASME[regionKey] || [];
unidades.forEach(unidad => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = unidad.trim();
btn.onclick = () => selectUnidad(unidad.trim());
unidadGrid.appendChild(btn);
});
document.getElementById('unidad-section').classList.remove('hidden');
}
function selectUnidad(unidad) {
selectedUnidad = unidad.trim();
document.querySelectorAll('#unidad-grid .card-btn').forEach(b => b.classList.remove('selected'));
const clickedBtn = Array.from(document.querySelectorAll('#unidad-grid .card-btn'))
.find(b => b.innerText.trim() === selectedUnidad);
if (clickedBtn) clickedBtn.classList.add('selected');
}
// === FUNCIONES DE SEGURIDAD Y LIMPIEZA ===
function clearCredentials() {
document.getElementById('adminUser').value = '';
document.getElementById('adminPass').value = '';
}
function togglePass() {
const input = document.getElementById('adminPass');
input.type = input.type === 'password' ? 'text' : 'password';
}
function openModal(t, m, icon = "‚ö†Ô∏è") {
clearCredentials();
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.add('hidden');
document.getElementById('modalIcon').innerText = icon;
document.getElementById('modalTitle').innerText = t;
document.getElementById('modalMsg').innerText = m;
const btn = document.getElementById('mainModalBtn');
btn.innerText = "ENTENDIDO";
btn.onclick = closeModal;
document.getElementById('modalAlert').style.display = 'flex';
}
function closeModal() {
clearCredentials();
document.getElementById('modalAlert').style.display = 'none';
}
function showLogin() {
clearCredentials();
document.getElementById('modalIcon').innerText = "üîê";
document.getElementById('modalTitle').innerText = "Acceso Restringido";
document.getElementById('modalMsg').innerText = "Inicie sesi√≥n para modo administraci√≥n.";
document.getElementById('loginArea').classList.remove('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden');
const btn = document.getElementById('mainModalBtn');
btn.innerText = "VALIDAR CREDENCIALES";
btn.onclick = validateLogin;
document.getElementById('modalAlert').style.display = 'flex';
// ‚ûï Permitir Enter para enviar credenciales
const userField = document.getElementById('adminUser');
const passField = document.getElementById('adminPass');
const handleEnter = (e) => {
if (e.key === 'Enter') {
validateLogin();
}
};
userField.removeEventListener('keydown', handleEnter);
passField.removeEventListener('keydown', handleEnter);
userField.addEventListener('keydown', handleEnter);
passField.addEventListener('keydown', handleEnter);
}
async function validateLogin() {
const u = document.getElementById('adminUser').value.trim();
const p = document.getElementById('adminPass').value.trim();
if (!u || !p) {
openModal("‚ùå Error", "Complete ambos campos.", "üîê");
return;
}
document.getElementById('loadMainTxt').innerText = "Verificando credenciales...";
document.getElementById('loadingOverlay').style.display = 'flex';
try {
const params = new URLSearchParams();
params.append("action", "loginAdmin");
params.append("username", u);
params.append("password", p);
const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
const data = await res.json();
if (data.success && data.data?.isAdmin) {
isAdmin = true;
document.getElementById('authBtn').className = "btn-logout";
document.getElementById('authBtn').innerText = "Cerrar Gesti√≥n";
document.getElementById('authBtn').onclick = logout;
document.getElementById('th-admin').classList.remove('hidden');
document.getElementById('maintBtn').classList.remove('hidden');
document.getElementById('col-fecha-registro').style.display = 'none';
clearCredentials();
closeModal();
updateTable();
} else {
openModal("‚ùå Error", "Usuario o Contrase√±a incorrectos.", "üîê");
clearCredentials();
}
} catch (err) {
openModal("‚ùå Error", "Error de conexi√≥n al validar.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}
function logout() {
isAdmin = false;
document.getElementById('authBtn').className = "btn-login";
document.getElementById('authBtn').innerText = "üîê Administrador";
document.getElementById('authBtn').onclick = showLogin;
document.getElementById('th-admin').classList.add('hidden');
document.getElementById('maintBtn').classList.add('hidden');
document.getElementById('col-fecha-registro').style.display = '';
if(isMaintActive) document.getElementById('maintOverlay').style.display = 'flex';
renderLocalTable();
clearCredentials();
}
// === FIN FUNCIONES DE SEGURIDAD ===
// === FUNCIONES ADMIN ===
function openArteModal(id) {
document.getElementById('currentReqId').value = id;
document.getElementById('arteFile').value = '';
document.getElementById('modalIcon').innerText = "üé®";
document.getElementById('modalTitle').innerText = "Adjuntar Arte Final";
document.getElementById('modalMsg').innerText = "Seleccione el archivo para la solicitud " + id;
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.remove('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden');
const btn = document.getElementById('mainModalBtn');
btn.innerText = "SUBIR A DRIVE";
btn.onclick = uploadArte;
document.getElementById('modalAlert').style.display = 'flex';
}
async function uploadArte() {
const fileInput = document.getElementById('arteFile');
const id = document.getElementById('currentReqId').value;
if (fileInput.files.length === 0) {
openModal("üìé Advertencia", "Por favor seleccione un archivo.", "üìÅ");
return;
}
const file = fileInput.files[0];
if (file.size > 5 * 1024 * 1024) {
openModal("üìè Tama√±o Excedido", "El archivo excede los 5MB permitidos.", "‚ö†Ô∏è");
return;
}
document.getElementById('loadMainTxt').innerText = "Subiendo Arte...";
document.getElementById('loadingOverlay').style.display = 'flex';
const reader = new FileReader();
reader.onload = async function(e) {
const base64 = e.target.result.split(',')[1];
const params = new URLSearchParams();
params.append("action", "uploadArte");
params.append("id", id);
params.append("filename", file.name);
params.append("file", base64);
params.append("mime", file.type);
try {
const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
const data = await res.json();
if (data.success) {
closeModal();
openModal("‚úÖ √âxito", "¬°Arte subido con √©xito!", "üé®");
updateTable();
document.getElementById('arteFile').value = '';
} else {
openModal("‚ùå Error", "Error: " + data.error, "üí•");
}
} catch (err) {
openModal("‚ùå Error", "Error de conexi√≥n al subir.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
};
reader.readAsDataURL(file);
}
async function sendTelegramArte(id) {
const req = localData.find(x => x.id == id);
if(!confirm("¬øEnviar el arte de " + id + " a Telegram?")) return;
document.getElementById('loadMainTxt').innerText = "Enviando a Telegram...";
document.getElementById('loadingOverlay').style.display = 'flex';
try {
const params = new URLSearchParams();
params.append("action", "sendTelegramArte");
params.append("id", id);
const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
const data = await res.json();
if(data.success) {
openModal("‚úàÔ∏è Telegram", "¬°Enviado a Telegram en alta calidad!", "üì≤");
setTimeout(() => closeModal(), 2000);
} else {
openModal("‚ùå Error", "Error: " + data.error, "üí•");
}
} catch (e) {
openModal("‚ùå Error", "Error de conexi√≥n.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}
async function toggleMaintMode() {
if (!isAdmin) return;
const nuevoEstado = !isMaintActive;
document.getElementById('loadingOverlay').style.display = 'flex';
try {
await fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=setMaintenance&status=${nuevoEstado}`
});
isMaintActive = nuevoEstado;
openModal(
"‚öôÔ∏è Modo Mantenimiento",
"Modo mantenimiento " + (nuevoEstado ? "ACTIVADO" : "DESACTIVADO") + ".",
"üõ†Ô∏è"
);
setTimeout(() => location.reload(), 1500);
} catch (e) {
openModal("‚ùå Error", "Error al cambiar estado del mantenimiento.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}
// === üî• ELIMINACI√ìN CON MODALES PERSONALIZADOS ===
let currentDeleteId = null;
function deleteReq(id) {
currentDeleteId = id;
showDeleteConfirm(1);
}
function showDeleteConfirm(step) {
const id = currentDeleteId;
if (step === 1) {
openCustomModal(
"üóëÔ∏è Confirmar Eliminaci√≥n",
`¬øEst√° seguro de eliminar la solicitud <b>${id}</b>?`,
() => showDeleteConfirm(2),
() => closeModal()
);
} else if (step === 2) {
openCustomModal(
"‚ö†Ô∏è ¬°Advertencia Final!",
`¬°Esta acci√≥n es <b>irreversible</b>!<br>¬øEliminar permanentemente la solicitud <b>${id}</b> de la base de datos?`,
() => executeDelete(),
() => closeModal()
);
}
}
function openCustomModal(title, message, onConfirm, onCancel) {
document.getElementById('modalIcon').innerText = "‚ùì";
document.getElementById('modalTitle').innerText = title;
document.getElementById('modalMsg').innerHTML = message;
const mainBtn = document.getElementById('mainModalBtn');
const altBtn = document.getElementById('closeModalBtn');
mainBtn.innerText = "S√ç, ACEPTAR";
mainBtn.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
altBtn.classList.remove('hidden');
altBtn.innerText = "CANCELAR";
altBtn.onclick = () => { closeModal(); if (onCancel) onCancel(); };
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('modalAlert').style.display = 'flex';
}
async function executeDelete() {
const id = currentDeleteId;
localData = localData.filter(x => x.id != id);
renderLocalTable();
try {
const params = new URLSearchParams();
params.append("action", "delete");
params.append("id", id);
await fetch(SCRIPT_URL, { method: 'POST', body: params });
openModal("‚úÖ √âxito", "Solicitud y arte eliminados correctamente.", "üóëÔ∏è");
} catch (e) {
openModal("‚ùå Error", "Error al eliminar. Revise la conexi√≥n.", "üí•");
updateTable();
}
}
// === FIN ELIMINACI√ìN ===
// === FIN FUNCIONES ADMIN ===
// === FUNCIONES GENERALES ===
function handleFile(input, imgId, btnId) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { const img = document.getElementById(imgId); img.src = e.target.result; img.style.display = 'block'; document.getElementById(btnId).style.display = 'block'; }; reader.readAsDataURL(file); } }
function clearFile(inputId, imgId, btnId) { document.getElementById(inputId).value = ""; const img = document.getElementById(imgId); img.src = ""; img.style.display = 'none'; document.getElementById(btnId).style.display = 'none'; }
function setAMPM(val) { selectedAMPM = val; document.getElementById('btn-am').classList.remove('active'); document.getElementById('btn-pm').classList.remove('active'); document.getElementById(val === 'a. m.' ? 'btn-am' : 'btn-pm').classList.add('active'); document.getElementById('hora-box').classList.remove('field-error'); }
function selectCat(btn, tipo) { document.querySelectorAll('#cat-grid .card-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); catName = btn.innerText; catType = tipo; document.getElementById('cat-grid').classList.remove('field-error'); const s3 = document.getElementById('sec-3'); const s4 = document.getElementById('sec-4'); const c3 = document.getElementById('cont-3'); const c4 = document.getElementById('cont-4'); s3.classList.remove('hidden'); s4.classList.add('hidden'); c3.innerHTML = ""; c4.innerHTML = ""; if (['escuela', 'integral', 'conjunta'].includes(tipo)) { document.getElementById('label-3').innerText = "ü©∫ 3. ESPECIALIDADES M√âDICAS *"; renderList(c3, DATA.especialidades); s4.classList.remove('hidden'); renderList(c4, DATA.servicios); } else if (tipo === 'vacuna') { document.getElementById('label-3').innerText = "üíâ 3. LISTA DE VACUNAS *"; renderList(c3, DATA.vacunas); } else if (tipo === 'quirurgica') { document.getElementById('label-3').innerText = "üî™ 3. PATOLOG√çAS QUIR√öRGICAS *"; renderList(c3, DATA.quirurgica); } else if (tipo === 'oftalmo') { document.getElementById('label-3').innerText = "üëÅÔ∏è 3. PATOLOG√çAS OFTALMOL√ìGICAS *"; renderList(c3, DATA.oftalmo); } else { document.getElementById('label-3').innerText = "‚ú® 3. DESCRIPCI√ìN DEL REQUERIMIENTO *"; c3.innerHTML = '<textarea id="desc-otro" class="modern-input" rows="3" style="grid-column: 1 / -1;" placeholder="Detalle aqu√≠ su solicitud especial..."></textarea>'; } }
function renderList(cont, list) { list.forEach(i => { const d = document.createElement('div'); d.className = 'card-btn'; d.innerText = i; d.onclick = () => { d.classList.toggle('selected'); document.getElementById('sec-3').classList.remove('field-error'); }; cont.appendChild(d); }); }
function showPage(id, btn) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo({top: 0, behavior: 'smooth'}); if(btn) btn.classList.add('active'); else document.getElementById('tab-' + id.split('-')[0]).classList.add('active'); if(id === 'list-page') updateTable(); }
async function updateTable() {
try {
const res = await fetch(`${SCRIPT_URL}?action=read`);
const response = await res.json();
isMaintActive = (response.maintenance === "true" || response.maintenance === true);
if(isMaintActive && !isAdmin) { document.getElementById('maintOverlay').style.display = 'flex'; }
else { document.getElementById('maintOverlay').style.display = 'none'; }
if (response.success && Array.isArray(response.data)) {
localData = response.data;
renderLocalTable();
}
} catch (e) { console.error("Error cargando tabla:", e); }
}
function renderLocalTable() {
const body = document.getElementById('solicitudes-body');
body.innerHTML = "";
let counts = { total:0, pend:0, proc:0, fin:0 };
const sortedData = [...localData].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
sortedData.forEach((s, idx) => {
counts.total++;
const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
if(statusLimpio === 'pendiente') counts.pend++;
if(statusLimpio === 'procesando') counts.proc++;
if(statusLimpio === 'finalizada') counts.fin++;
const esNueva = (idx < 5 && statusReal === "PENDIENTE");
const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";
const badge = esNueva ? '<span class="badge-new">NUEVA ‚ú®</span>' : '';
let icon = (s.Soportes && s.Soportes.includes("S√ç")) ? `üì∑ (${s.Soportes.match(/\d+/) || 1})` : "üôà";
const tr = document.createElement('tr');
if(esNueva) tr.className = "row-new";
tr.innerHTML = `
${isAdmin ? '' : `<td><span class="txt-small">${s.Timestamp}</span></td>`}
${isAdmin ? '' : `<td><span class="txt-bold">${s.Fecha}</span><br><span class="txt-small">${s.Hora || ''}</span></td>`}
${isAdmin ? `<td><span class="txt-bold">${s.id}</span></td>` : ''}
<td class="txt-bold">${unidadLimpia} ${badge}</td>
<td>${jornadaLimpia}</td>
<td align="center">${icon}</td>
<td><span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span></td>
${isAdmin ? `<td align="right">
<div class="admin-actions">
<button class="btn-act bg-pend" onclick="modStatus('${s.id}','PENDIENTE')">P</button>
<button class="btn-act bg-proc" onclick="modStatus('${s.id}','PROCESANDO')">PR</button>
<button class="btn-act bg-fin" onclick="modStatus('${s.id}','FINALIZADA')">F</button>
<button class="btn-arte" onclick="openArteModal('${s.id}')">üé® ADJUNTAR</button>
${s.ArteFinal ? `<a href="${s.ArteFinal}" target="_blank" class="btn-ver">üëÅÔ∏è VER</a>` : ''}
${s.ArteFinal ? `<button class="btn-tg" onclick="sendTelegramArte('${s.id}')">‚úàÔ∏è TG</button>` : ''}
<button class="btn-trash" onclick="deleteReq('${s.id}')">üóëÔ∏è</button>
</div>
</td>` : ''}`;
body.appendChild(tr);
});
document.getElementById('count-total').innerText = counts.total;
document.getElementById('count-pend').innerText = counts.pend;
document.getElementById('count-proc').innerText = counts.proc;
document.getElementById('count-fin').innerText = counts.fin;
// ‚úÖ Actualizar visibilidad de columnas del encabezado
document.getElementById('col-fecha-actividad').style.display = isAdmin ? 'none' : '';
document.getElementById('col-id-solicitud').classList.toggle('hidden', !isAdmin);
}
async function modStatus(id, st) {
const pill = document.getElementById('pill-' + id);
const oldClass = pill.className;
const oldText = pill.innerText;
const newStatusClass = st.toLowerCase().replace(/\s+/g, '');
pill.className = `status-pill status-${newStatusClass}`; pill.innerText = st;
try {
await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `action=updateStatus&id=${id}&status=${encodeURIComponent(st)}` });
const item = localData.find(x => x.id == id); if(item) item.Estatus = st; renderLocalTable();
} catch (e) { pill.className = oldClass; pill.innerText = oldText; openModal("‚ùå Error", "Error de conexi√≥n.", "üí•"); }
}
// === VALIDACI√ìN Y CONFIRMACI√ìN ===
function validateForm() {
const fields = [
{ id: 'region-grid', val: selectedRegionKey, label: 'Regi√≥n' },
{ id: 'unidad-grid', val: selectedUnidad, label: 'Unidad M√©dica' },
{ id: 'cat-grid', val: catName, label: 'Tipo de Jornada' },
{ id: 'sec-3', isList: true, label: 'Detalle' },
{ id: 'fecha', val: document.getElementById('fecha').value, label: 'Fecha de Actividad' },
{ id: 'hora', val: document.getElementById('hora').value.trim(), label: 'Hora de Inicio' },
{ id: 'hora-box', val: selectedAMPM, label: 'Formato AM/PM' },
{ id: 'institucion', val: document.getElementById('institucion').value.trim(), required: true, label: 'Instituci√≥n' },
{ id: 'mail', val: document.getElementById('mail').value.trim(), label: 'Correo Electr√≥nico' }
];
for (let field of fields) {
let isInvalid = false;
const el = document.getElementById(field.id);
if (field.isList) {
if (catType === 'otros') {
if (document.getElementById('desc-otro').value.trim() === "") isInvalid = true;
} else {
if (document.querySelectorAll('#cont-3 .card-btn.selected').length === 0) isInvalid = true;
}
} else if (field.required !== false) {
if (!field.val || (field.id === 'mail' && !field.val.includes('@'))) isInvalid = true;
}
if (isInvalid) {
el?.classList.add('field-error');
el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
openModal("‚ùå Campo Faltante", `Falta completar: ${field.label}`, "‚ö†Ô∏è");
return false;
}
}
const fechaSeleccionada = new Date(document.getElementById('fecha').value + 'T00:00:00');
const ahora = new Date();
if ((fechaSeleccionada - ahora) / (1000 * 60 * 60) < 48) {
openModal("‚è≥ Restricci√≥n de Tiempo", "Las solicitudes deben realizarse con al menos 48 horas de anticipaci√≥n.", "‚è∞");
document.getElementById('fecha').classList.add('field-error');
return false;
}
return true;
}
function showConfirmationModal() {
if (!validateForm()) return;
const preview = document.getElementById('previewContent');
let html = `
<p><b>üìç Regi√≥n:</b> ${getNombreRegionLimpio(selectedRegionKey)}</p>
<p><b>üè• Unidad M√©dica:</b> ${selectedUnidad}</p>
<p><b>üìÇ Tipo de Jornada:</b> ${catName}</p>
`;
if (catType === 'otros') {
html += `<p><b>‚ú® Descripci√≥n:</b> ${document.getElementById('desc-otro').value.trim()}</p>`;
} else {
const selectedOps = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el => el.innerText).join(', ');
html += `<p><b>ü©∫ Detalle:</b> ${selectedOps || 'Ninguno'}</p>`;
}
const servicios = Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el => el.innerText).join(', ');
if (servicios) html += `<p><b>‚ú® Servicios Adicionales:</b> ${servicios}</p>`;
// ‚úÖ Formatear fecha a DD/MM/YYYY
const fechaInput = document.getElementById('fecha').value;
const [year, month, day] = fechaInput.split('-');
const fechaFormateada = `${day}/${month}/${year}`;
html += `
<p><b>üìÖ Fecha de Actividad:</b> ${fechaFormateada}</p>
<p><b>‚è∞ Hora de Inicio:</b> ${document.getElementById('hora').value} ${selectedAMPM}</p>
`;
const institucion = document.getElementById('institucion').value.trim();
const direccion = document.getElementById('direccion-exacta').value.trim();
html += `<p><b>üß≠ Ubicaci√≥n:</b> ${[institucion, direccion].filter(x => x).join(', ')}</p>`;
html += `
<p><b>üì± Tel√©fono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>
<p><b>‚úâÔ∏è Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>
`;
const obs = document.getElementById('observaciones').value.trim();
if (obs) html += `<p><b>‚úèÔ∏è Observaciones:</b> ${obs}</p>`;
const fotos = [1,2,3].filter(i => document.getElementById(`p${i}`).src.startsWith('image'));
html += `<p><b>üì∏ Soportes Fotogr√°ficos:</b> ${fotos.length > 0 ? `${fotos.length} foto(s) adjunta(s)` : 'Ninguno'}</p>`;
preview.innerHTML = html;
document.getElementById('confirmModal').style.display = 'flex';
// ‚úÖ 10 segundos + animaci√≥n progresiva + hover efectivo
let timeLeft = 10;
document.getElementById('countdown').innerText = timeLeft;
const btnEnviar = document.getElementById('btnEnviarConfirmado');
btnEnviar.disabled = true;
btnEnviar.classList.remove('enviar');
btnEnviar.classList.add('corregir');
// A√±adir hover efectivo al bot√≥n "Corregir"
const btnCorregir = document.getElementById('btnCorregir');
btnCorregir.onmouseenter = () => {
btnCorregir.style.background = "#d1d5db";
btnCorregir.style.color = "#212529";
};
btnCorregir.onmouseleave = () => {
btnCorregir.style.background = "var(--gris)";
btnCorregir.style.color = "var(--azul-deep)";
};
const timer = setInterval(() => {
timeLeft--;
document.getElementById('countdown').innerText = timeLeft;
// Animaci√≥n: barra de progreso visual
const progress = ((10 - timeLeft) / 10) * 100;
btnEnviar.style.background = `linear-gradient(to right, var(--turquesa) ${progress}%, #e9ecef ${progress}%)`;
btnEnviar.style.color = timeLeft <= 3 ? "white" : "#495057";
if (timeLeft <= 0) {
clearInterval(timer);
btnEnviar.disabled = false;
btnEnviar.classList.remove('corregir');
btnEnviar.classList.add('enviar');
btnEnviar.style.background = "var(--turquesa)";
btnEnviar.style.color = "white";
btnEnviar.style.cursor = "pointer";
btnEnviar.innerText = "üöÄ Enviar Solicitud";
// A√±adir hover al bot√≥n activo
btnEnviar.onmouseenter = () => {
btnEnviar.style.background = "var(--azul-deep)";
btnEnviar.style.transform = "scale(1.02)";
};
btnEnviar.onmouseleave = () => {
btnEnviar.style.background = "var(--turquesa)";
btnEnviar.style.transform = "scale(1)";
};
}
}, 1000);
window.confirmTimer = timer;
}
document.getElementById('btnCorregir').onclick = () => {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
};
function proceedToSend() {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
realSubmitForm();
}
document.getElementById('btnEnviarConfirmado').onclick = proceedToSend;
// === ENV√çO REAL ===
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw4oGU8GLqut_CQTWIdkArjakKsuRAZLVF9xI4YhO-pYV0XYvMp-BXoE4arULToavgaw/exec";
document.getElementById('sigrafForm').onsubmit = function(e) {
e.preventDefault();
showConfirmationModal();
};
function realSubmitForm() {
const params = new URLSearchParams();
const EXCEPCIONES_SIN_UMI = [
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende",
"Club Villas Ipasmar",
"Hotel Valle Grande"
];
let unidadFinal = selectedUnidad;
if (!EXCEPCIONES_SIN_UMI.includes(selectedUnidad.trim())) {
unidadFinal = selectedUnidad.trim().replace(/\b\w/g, l => l.toUpperCase());
unidadFinal = "U.M.I. " + unidadFinal;
}
params.append("Unidad", unidadFinal);
params.append("Jornada", catName);
let ops = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el=>el.innerText).join(", ");
if(catType === 'otros') ops = document.getElementById('desc-otro').value;
params.append("Opciones", ops);
params.append("Servicios", Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el=>el.innerText).join(", "));
const institucion = document.getElementById('institucion').value.trim();
const direccionExacta = document.getElementById('direccion-exacta').value.trim();
const direccionCompleta = [institucion, direccionExacta].filter(part => part).join(", ");
params.append("Direccion", direccionCompleta);
params.append("Fecha", document.getElementById('fecha').value);
params.append("Hora", document.getElementById('hora').value + " " + selectedAMPM);
params.append("Telefono", document.getElementById('tlf').value);
params.append("Correo", document.getElementById('mail').value);
params.append("Observaciones", document.getElementById('observaciones').value);
for(let i=1; i<=3; i++){
const img = document.getElementById('p'+i);
if(img.src && img.src.startsWith("image")) {
const base64Data = img.src.split(',')[1];
params.append("foto"+i, base64Data);
}
}
document.getElementById('loadMainTxt').innerText = "Enviando Solicitud...";
document.getElementById('loadingOverlay').style.display = 'flex';
fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: params.toString()
})
.then(response => response.json())
.then(result => {
if (result.success) {
// ‚úÖ REINICIAR FORMULARIO
document.getElementById('sigrafForm').reset();
for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
img.src = '';
img.style.display = 'none';
document.getElementById('b'+i).style.display = 'none';
}
document.querySelectorAll('.card-btn').forEach(btn => btn.classList.remove('selected'));
document.getElementById('sec-3').classList.add('hidden');
document.getElementById('sec-4').classList.add('hidden');
selectedAMPM = "";
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
selectedRegionKey = "";
selectedUnidad = "";
document.getElementById('region-grid').querySelectorAll('.card-btn').forEach(b => b.classList.remove('selected'));
document.getElementById('unidad-grid').innerHTML = "";
document.getElementById('unidad-section').classList.add('hidden');
openModal("‚úÖ ¬°√âxito!", "Su solicitud ha sido enviada correctamente.", "üöÄ");
setTimeout(() => {
closeModal();
showPage('list-page', document.getElementById('tab-list'));
}, 2000);
} else {
throw new Error(result.error);
}
})
.catch(e => {
openModal("‚úÖ Solicitud Procesada", "El sistema ha registrado su env√≠o.", "üìã");
setTimeout(() => {
closeModal();
showPage('list-page', document.getElementById('tab-list'));
}, 2000);
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}
</script>
</body>
</html>
