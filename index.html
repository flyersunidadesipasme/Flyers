<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGRAF-IPASME | Gesti√≥n de Artes</title>
<link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600;800&display=swap" rel="stylesheet">
<style>
:root {
--celeste: #8ecae6; --turquesa: #219ebc; --azul-deep: #023047;
--amarillo: #ffb703; --naranja: #fb8500; --rojo: #e63946;
--verde: #2d6a4f; --gris: #edf2f4; --morado: #6a0dad;
}
* { font-family: 'Georama', sans-serif; box-sizing: border-box; font-weight: 500; }
body { background: #f4f7fa; margin: 0; padding-bottom: 50px; color: var(--azul-deep); }

header { background: var(--azul-deep); padding: 8px 25px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; min-height: 60px; }
.brand-container { display: flex; flex-direction: column; align-items: flex-start; flex: 1; }
.header-title { margin: 0; font-size: 1.3rem; font-weight: 800; color: white; line-height: 1; }
.acronimo { font-size: 0.55rem; font-weight: 400; letter-spacing: 0.5px; margin-top: 2px; opacity: 0.9; text-transform: uppercase; color: white; max-width: 250px; }
.nav-tabs { display: flex; justify-content: center; gap: 10px; flex: 1; }

.tab-btn { padding: 6px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: 800; text-transform: uppercase; font-size: 0.75rem; background: rgba(255,255,255,0.1); color: white; transition: 0.3s; display: flex; align-items: center; gap: 6px; }
.tab-btn.active { background: var(--amarillo); color: var(--azul-deep); }
.admin-access { flex: 1; display: flex; justify-content: flex-end; gap: 10px; }
.btn-login { background: var(--amarillo); border: none; padding: 6px 14px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.75rem; box-shadow: 0 3px 0 #c79100; transition: 0.2s; }
.btn-login:active { transform: translateY(2px); box-shadow: 0 1px 0 #c79100; }
.btn-logout { background: var(--rojo); color: white; border: none; padding: 6px 14px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.75rem; }

.row-new { background-color: #e3f2fd !important; border-left: 5px solid var(--turquesa) !important; }
.badge-new { background: var(--turquesa); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; animation: blink 2s infinite; }
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

.stats-grid { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.stat-card { flex: 1; min-width: 100px; padding: 8px; border-radius: 12px; text-align: center; color: white; font-weight: 800; }
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep); }
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }
.st-baja { background: var(--morado); }
.stat-label { font-size: 0.6rem; text-transform: uppercase; display: block; opacity: 0.8; }
.stat-val { font-size: 1.1rem; }
.container { max-width: 1200px; margin: 15px auto; padding: 25px; background: white; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.06); }
.aviso-48h { background: #fff3e0; border: 2.5px solid var(--naranja); color: var(--naranja); padding: 15px; border-radius: 15px; text-align: center; font-weight: 800; margin-bottom: 25px; font-size: 1.1rem; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
.section-title { display: block; font-weight: 800; font-size: 0.85rem; color: var(--turquesa); margin: 20px 0 12px; border-left: 4px solid var(--turquesa); padding-left: 10px; text-transform: uppercase; }
.category-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }

.card-btn { background: #fff; border: 2px solid var(--gris); border-radius: 12px; padding: 6px 4px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 800; font-size: 0.75rem; min-height: 45px; line-height: 1.1; color: var(--azul-deep); }
.card-btn.selected { background: var(--amarillo); border-color: var(--naranja); transform: scale(0.98); }

.field-error { border: 2px solid var(--rojo) !important; animation: border-blink 0.8s infinite alternate !important; background: #fff5f5 !important; }
@keyframes border-blink { from { border-color: var(--rojo); box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); } to { border-color: transparent; box-shadow: none; } }

.btn-time { padding: 8px; border-radius: 12px; border: 2px solid var(--gris); cursor: pointer; font-weight: 800; font-size: 0.85rem; background: #f8f9fa; color: var(--azul-deep); flex: 1; transition: 0.3s; }
.btn-time.active { background: var(--azul-deep); color: white; border-color: var(--azul-deep); }
.modern-input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--gris); font-size: 0.95rem; outline: none; transition: 0.3s; background: #fdfdfd; font-weight: 500; }
.modern-input:focus { border-color: var(--turquesa); background: white; }

.pass-container { position: relative; width: 100%; }
.eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem; opacity: 0.6; z-index: 10; }

.photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
.upload-box { height: 90px; border: 2.5px dashed var(--celeste); border-radius: 15px; position: relative; overflow: hidden; background: #f0f9ff; }
.upload-label { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; cursor: pointer; font-size: 0.7rem; font-weight: 800; color: var(--turquesa); text-align: center; }
.preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; }
.remove-btn { position: absolute; top: 5px; right: 5px; background: var(--rojo); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-weight: 800; cursor: pointer; display: none; z-index: 10; }

.btn-send { background: var(--azul-deep); color: white; width: 100%; padding: 14px; border-radius: 18px; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 30px; box-shadow: 0 6px 15px rgba(2, 48, 71, 0.3); transition: 0.3s; }
.btn-send:hover { transform: translateY(-2px); background: #054a6d; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.85); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 20000; padding: 20px; }
.modal-content { background: white; padding: 40px 30px; border-radius: 30px; max-width: 450px; width: 100%; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative; }

/* MODAL MANTENIMIENTO */
#maintOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--azul-deep); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }

.modal-btn { background: var(--turquesa); color: white; border: none; padding: 12px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 25px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
.modal-btn:hover { background: var(--azul-deep); }
.modal-btn-alt { background: var(--gris); color: var(--azul-deep); margin-top: 10px; }

.table-container { width: 100%; overflow-x: auto; margin-top: 5px; }
table { width: 100%; border-collapse: collapse; min-width: 900px; }
th { background: #f8f9fa; padding: 8px 10px; text-align: left; font-size: 0.65rem; text-transform: uppercase; font-weight: 800; color: var(--turquesa); border-bottom: 2px solid var(--gris); }
td { padding: 6px 10px; border-bottom: 1px solid var(--gris); font-size: 0.82rem; line-height: 1.2; color: #1a1a1a; font-weight: 500; }
.status-pill { padding: 3px 10px; border-radius: 15px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; transition: 0.3s; }
.txt-bold { font-weight: 800; color: var(--azul-deep); }
.txt-small { font-size: 0.72rem; color: #4b4b4b; display: block; margin-bottom: 1px; font-weight: 500; }

.status-pendiente { background: var(--celeste); color: var(--azul-deep); }
.status-procesando { background: var(--amarillo); color: var(--azul-deep); }
.status-finalizada { background: var(--verde); color: white; }
.status-bajaprioridad { background: var(--morado); color: white; }
.admin-actions { display: flex; gap: 4px; justify-content: flex-end; }
.btn-act { border: none; border-radius: 5px; padding: 4px 6px; cursor: pointer; font-size: 9px; color: white; font-weight: 800; transition: 0.2s; }
.btn-act:hover { transform: scale(1.1); }
.bg-pend { background: var(--celeste); color: var(--azul-deep); }
.bg-proc { background: var(--amarillo); color: var(--azul-deep); }
.bg-fin { background: var(--verde); }
.bg-baja { background: var(--morado); }
.btn-trash { background: none; border: none; cursor: pointer; font-size: 1.1rem; margin-left: 8px; filter: grayscale(1); transition: 0.3s; }
.btn-trash:hover { filter: grayscale(0); transform: rotate(10deg); }

.hidden { display: none !important; }
.page { display: none; }
.page.active { display: block; }

#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 30000; color: white; text-align: center; padding: 20px; }
.spinner { width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.1); border-top: 6px solid var(--amarillo); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 25px; }
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="maintOverlay">
    <span style="font-size: 80px;">üõ†Ô∏è</span>
    <h1 style="font-weight: 800; font-size: 2.5rem; margin: 20px 0;">SISTEMA EN MANTENIMIENTO</h1>
    <p style="font-size: 1.2rem; max-width: 500px; opacity: 0.9;">Estamos trabajando para mejorar tu experiencia. Disculpen las molestias ocasionadas.</p>
    <button class="btn-login" style="margin-top: 30px; padding: 12px 25px; font-size: 1rem;" onclick="showLogin()">üîì ACCESO ADMINISTRADOR</button>
</div>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadMainTxt">Procesando...</div>
  <div class="loading-subtext" id="loadSubTxt"></div>
</div>

<div class="modal-overlay" id="modalAlert">
  <div class="modal-content">
    <span id="modalIcon" style="font-size: 60px; display: block; margin-bottom: 10px;">‚ö†Ô∏è</span>
    <div id="modalTitle" style="font-weight: 800; font-size: 1.4rem; color: var(--azul-deep);">Atenci√≥n</div>
    <div id="modalMsg" style="margin-top: 15px; color: #555; font-size: 1rem; line-height: 1.4; font-weight: 500;"></div>
    
    <div id="loginArea" class="hidden" style="margin-top:20px; text-align: left;">
        <label class="txt-small">Usuario del Sistema:</label>
        <input type="text" id="adminUser" class="modern-input" style="margin-bottom:15px;" placeholder="Ingrese usuario">
        <label class="txt-small">Clave de Seguridad:</label>
        <div class="pass-container">
            <input type="password" id="adminPass" class="modern-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <span class="eye-icon" onclick="togglePass()">üëÅÔ∏è</span>
        </div>
    </div>
    
    <button id="mainModalBtn" class="modal-btn">ENTENDIDO</button>
    <button id="closeModalBtn" class="modal-btn modal-btn-alt hidden" onclick="closeModal()">CERRAR</button>
  </div>
</div>

<header>
  <div class="brand-container">
      <h1 class="header-title">SIGRAF-IPASME</h1>
      <span class="acronimo">Sistema Integral de Gesti√≥n para Requerimientos de Artes Finalizadas</span>
  </div>
  <div class="nav-tabs">
    <button id="tab-form" class="tab-btn active" onclick="showPage('form-page', this)">üìù FORMULARIO</button>
    <button id="tab-list" class="tab-btn" onclick="showPage('list-page', this)">üìã SOLICITUDES</button>
  </div>
  <div class="admin-access">
      <button id="maintBtn" class="btn-login hidden" style="background: var(--rojo); box-shadow: 0 3px 0 #9b1c24; color: white;" onclick="toggleMaintMode()">‚öôÔ∏è Mantenimiento</button>
      <button id="authBtn" class="btn-login" onclick="showLogin()">üîê Administrador</button>
  </div>
</header>

<div class="container page active" id="form-page">
  <div class="aviso-48h">‚ö†Ô∏è IMPORTANTE: LAS SOLICITUDES DEBEN REALIZARSE CON 48 HORAS DE ANTICIPACI√ìN</div>
  <form id="sigrafForm" novalidate>
    <label class="section-title">üè• 1. UNIDAD SOLICITANTE *</label>
    <input type="text" id="unidad" class="modern-input" value="U.M.I. ">
    <label class="section-title">üìÇ 2. TIPO DE JORNADA *</label>
    <div class="category-row" id="cat-grid">
      <div class="card-btn" onclick="selectCat(this, 'escuela')">Ipasme va a la Escuela</div>
      <div class="card-btn" onclick="selectCat(this, 'integral')">Jornada de Atenci√≥n M√©dica Integral</div>
      <div class="card-btn" onclick="selectCat(this, 'conjunta')">Jornada Conjunta</div>
      <div class="card-btn" onclick="selectCat(this, 'vacuna')">Plan Masivo de Vacunaci√≥n</div>
      <div class="card-btn" onclick="selectCat(this, 'quirurgica')">Captaci√≥n Quir√∫rgica</div>
      <div class="card-btn" onclick="selectCat(this, 'oftalmo')">Captaci√≥n Quir√∫rgica Oftalmol√≥gica</div>
      <div class="card-btn" onclick="selectCat(this, 'otros')">Otros</div>
    </div>

    <div id="sec-3" class="hidden">
      <label class="section-title" id="label-3">ü©∫ 3. DETALLE *</label>
      <div id="cont-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;"></div>
    </div>
    <div id="sec-4" class="hidden">
      <label class="section-title">‚ú® 4. SERVICIOS ADICIONALES (OPCIONAL)</label>
      <div id="cont-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;"></div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div><label class="section-title">üìÖ 5. FECHA DE ACTIVIDAD *</label><input type="date" id="fecha" class="modern-input"></div>
      <div><label class="section-title">‚è∞ 6. HORA DE INICIO *</label><div class="hora-container" id="hora-box" style="display: flex; gap: 10px; align-items: center;"><input type="text" id="hora" class="modern-input" style="width:100px; text-align:center" placeholder="08:00"><button type="button" class="btn-time" id="btn-am" onclick="setAMPM('a. m.')">a. m.</button><button type="button" class="btn-time" id="btn-pm" onclick="setAMPM('p. m.')">p. m.</button></div></div>
    </div>
    <label class="section-title">üìç 7. DIRECCI√ìN EXACTA *</label>
    <div style="background: #fff8e1; border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600; line-height: 1.4;">
      ‚ö†Ô∏è direcci√≥n: se debe colocar el nombre de la instituci√≥n correctamente, municipio y parroquia. En caso de no tener todos los datos solo ponga el nombre de la instituci√≥n. Los datos err√≥neos llevar√°n la solicitud a baja prioridad.
    </div>
    <textarea id="direccion" class="modern-input" rows="3" placeholder="Ej: Escuela Bolivariana 'Miguel Otero Silva', Municipio Libertador, Parroquia El Valle, Caracas."></textarea>
    <label class="section-title">üì±‚úâÔ∏è 8. DATOS DE CONTACTO *</label>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div><label class="txt-small">N√∫mero de Tel√©fono</label><input type="tel" id="tlf" class="modern-input" placeholder="04xx 1234567"></div>
      <div><label class="txt-small">Correo Electr√≥nico</label><input type="email" id="mail" class="modern-input" placeholder="Para env√≠o de arte final *"></div>
    </div>
    <label class="section-title">‚úèÔ∏è 9. OBSERVACIONES / DETALLES DE DISE√ëO</label><textarea id="observaciones" class="modern-input" rows="3" placeholder="Indique medidas, colores institucionales o entes participantes adicionales..."></textarea>
    
    <label class="section-title">üì∏ 10. SOPORTES FOTOGR√ÅFICOS (M√ÅX 3)</label>
    <div style="background: #fff8e1; border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600; line-height: 1.4;">
      ‚ö†Ô∏è Si el registro fotogr√°fico enviado no cumple con las condiciones de calidad para la solicitud, ser√° sustituido por material de archivo.
    </div>
    
    <div class="photo-grid">
      <div class="upload-box"><label for="f1" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f1" class="hidden" accept="image/*" onchange="handleFile(this, 'p1', 'b1')"><img id="p1" class="preview"><button type="button" id="b1" class="remove-btn" onclick="clearFile('f1', 'p1', 'b1')">√ó</button></div>
      <div class="upload-box"><label for="f2" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f2" class="hidden" accept="image/*" onchange="handleFile(this, 'p2', 'b2')"><img id="p2" class="preview"><button type="button" id="b2" class="remove-btn" onclick="clearFile('f2', 'p2', 'b2')">√ó</button></div>
      <div class="upload-box"><label for="f3" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f3" class="hidden" accept="image/*" onchange="handleFile(this, 'p3', 'b3')"><img id="p3" class="preview"><button type="button" id="b3" class="remove-btn" onclick="clearFile('f3', 'p3', 'b3')">√ó</button></div>
    </div>
    <button type="submit" id="submitBtn" class="btn-send">üöÄ ENVIAR SOLICITUD A COMUNICACIONES</button>
  </form>
</div>

<div class="container page" id="list-page">
    <div class="stats-grid" id="stats-panel">
        <div class="stat-card st-total"><span class="stat-label">Total</span><span id="count-total" class="stat-val">0</span></div>
        <div class="stat-card st-pend"><span class="stat-label">Pendiente</span><span id="count-pend" class="stat-val">0</span></div>
        <div class="stat-card st-proc"><span class="stat-label">En Proceso</span><span id="count-proc" class="stat-val">0</span></div>
        <div class="stat-card st-fin"><span class="stat-label">Finalizada</span><span id="count-fin" class="stat-val">0</span></div>
        <div class="stat-card st-baja"><span class="stat-label">Prioridad B.</span><span id="count-baja" class="stat-val">0</span></div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr><th>FECHA REGISTRO</th><th>FECHA ACTIVIDAD</th><th>UNIDAD SOLICITANTE</th><th>TIPO DE JORNADA</th><th style="text-align:center">SOPORTES</th><th>ESTATUS</th><th id="th-admin" class="hidden" style="text-align:right">ACCIONES ADMIN</th></tr>
            </thead>
            <tbody id="solicitudes-body"></tbody>
        </table>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzLsIXUlpux-6y-lv1YB5biW1xAidlMcyusS9SSPYyjf6qloEXRSetPK3JPX3w-1NBzyw/exec";
let isAdmin = false; let selectedAMPM = ""; let catType = "";
let catName = ""; let localData = []; let isMaintActive = false;

const DATA = {
especialidades: ["Alergolog√≠a", "Cardiolog√≠a", "Cirug√≠a general", "Dermatolog√≠a", "Ecograf√≠a", "Fisiatr√≠a", "Gastroenterolog√≠a", "Geriatr√≠a", "Gerontolog√≠a", "Ginecolog√≠a y obstetricia", "Infectolog√≠a", "Medicina familiar", "Medicina general", "Medicina interna", "Nefrolog√≠a", "Neumolog√≠a", "Neurolog√≠a", "Nutrici√≥n", "Odontolog√≠a", "Oftalmolog√≠a", "Oncolog√≠a", "Optometr√≠a", "Pediatr√≠a", "Psicolog√≠a", "Psiquiatr√≠a", "Reumatolog√≠a", "Traumatolog√≠a", "Urolog√≠a"],
servicios: ["Actividades recreativas", "Afiliaci√≥n", "Agudeza visual", "Aplicaci√≥n de fl√∫or", "Asesor√≠a legal", "Bienestar social", "Captaci√≥n de odontolog√≠a", "Captaci√≥n quir√∫rgica general", "Captaci√≥n quir√∫rgica oftalmol√≥gica", "Citolog√≠a", "Control de glicemia", "Control de talla y peso", "Desparasitaci√≥n", "Despistaje de glicemia capilar", "Despistaje HTA", "Ecograf√≠a", "Electrocardiograma", "Farmacia", "Fisioterapia", "Fonoaudiolog√≠a", "Ingenier√≠a biom√©dica", "Inmunizaci√≥n", "Laboratorio", "Liberaci√≥n de hipoteca", "Masoterapia", "Podolog√≠a", "Quiropraxia", "Reposos m√©dicos", "Sesi√≥n educativa", "Servicios sociales", "Terapia de lenguaje (Logopedia)", "Terapia del dolor", "Terapia ocupacional", "Tipiaje"],
vacunas: ["Fiebre amarilla", "Pentavalente", "Polio IPV", "Polio oral", "Toxoide (tet√°nico/dift√©rico)", "Trivalente viral (SRP)"],
quirurgica: ["Bocio hiperfuncionante", "Colectom√≠a", "Esterilizaci√≥n", "Fibromatosis", "Fimosis", "Hernia abdominal", "Hernia epig√°strica", "Hernia escrotal", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Histerectom√≠a", "Lipomas", "Litiasis vesicular (Colecistectom√≠as)", "Lunares", "Miomatosis uterina", "Nevus", "Paridad satisfecha", "Prolapso", "Quiste (TU)", "Quiste de epid√≠dimo", "Quiste seb√°ceo", "Quiste tirogloso", "Quistes seb√°ceos", "Tumores ov√°ricos", "Varicocele", "Vasectom√≠a", "Verrugas"],
oftalmo: ["Cataratas", "Cirug√≠a pl√°stica ocular", "Dacriocistorrinostom√≠a", "Desprendimiento de retina", "Glaucoma", "Melanoma uveal", "Pterigi√≥n", "Ptosis palpebral", "Queratoplast√≠a", "Retinoblastoma", "Tumores oculares"]
};

document.addEventListener('DOMContentLoaded', () => { updateTable(); });

function openModal(t, m, icon = "‚ö†Ô∏è") { 
    document.getElementById('loginArea').classList.add('hidden'); 
    document.getElementById('closeModalBtn').classList.add('hidden'); 
    document.getElementById('modalIcon').innerText = icon;
    document.getElementById('modalTitle').innerText = t; 
    document.getElementById('modalMsg').innerText = m; 
    const btn = document.getElementById('mainModalBtn'); 
    btn.innerText = "ENTENDIDO"; 
    btn.onclick = closeModal; 
    document.getElementById('modalAlert').style.display = 'flex';
}

function togglePass() {
    const input = document.getElementById('adminPass');
    input.type = input.type === 'password' ? 'text' : 'password';
}

function showLogin() { 
    document.getElementById('modalIcon').innerText = "üîê"; 
    document.getElementById('modalTitle').innerText = "Acceso Restringido"; 
    document.getElementById('modalMsg').innerText = "Inicie sesi√≥n para modo administraci√≥n."; 
    document.getElementById('loginArea').classList.remove('hidden'); 
    document.getElementById('closeModalBtn').classList.remove('hidden');
    const btn = document.getElementById('mainModalBtn'); 
    btn.innerText = "VALIDAR CREDENCIALES"; 
    btn.onclick = validateLogin; 
    document.getElementById('modalAlert').style.display = 'flex';
}

function validateLogin() { 
    const u = document.getElementById('adminUser').value; 
    const p = document.getElementById('adminPass').value;
    if(u === "MD-comunicaciones" && p === "Ipasme.2026.comu") { 
        isAdmin = true; 
        document.getElementById('authBtn').className = "btn-logout"; 
        document.getElementById('authBtn').innerText = "Cerrar Gesti√≥n";
        document.getElementById('authBtn').onclick = logout; 
        document.getElementById('th-admin').classList.remove('hidden'); 
        document.getElementById('maintBtn').classList.remove('hidden');
        document.getElementById('maintOverlay').style.display = 'none'; // Quitar overlay si estaba
        closeModal(); 
        updateTable(); 
    } else { 
        alert("Usuario o Contrase√±a incorrectos."); 
    } 
}

function logout() { 
    isAdmin = false;
    document.getElementById('authBtn').className = "btn-login"; 
    document.getElementById('authBtn').innerText = "üîê Administrador"; 
    document.getElementById('authBtn').onclick = showLogin; 
    document.getElementById('th-admin').classList.add('hidden'); 
    document.getElementById('maintBtn').classList.add('hidden');
    if(isMaintActive) document.getElementById('maintOverlay').style.display = 'flex';
    renderLocalTable(); 
}

async function toggleMaintMode() {
    if(!isAdmin) return;
    const nuevoEstado = !isMaintActive;
    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
        await fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
            body: `action=setMaintenance&status=${nuevoEstado}` 
        });
        isMaintActive = nuevoEstado;
        alert("Modo mantenimiento " + (nuevoEstado ? "ACTIVADO" : "DESACTIVADO"));
        location.reload();
    } catch (e) { alert("Error al cambiar estado."); }
    finally { document.getElementById('loadingOverlay').style.display = 'none'; }
}

function closeModal() { document.getElementById('modalAlert').style.display = 'none'; }
function handleFile(input, imgId, btnId) { const file = input.files[0]; if (file) { const reader = new FileReader();
reader.onload = (e) => { const img = document.getElementById(imgId); img.src = e.target.result; img.style.display = 'block'; document.getElementById(btnId).style.display = 'block'; }; reader.readAsDataURL(file);
} }
function clearFile(inputId, imgId, btnId) { document.getElementById(inputId).value = ""; const img = document.getElementById(imgId); img.src = ""; img.style.display = 'none';
document.getElementById(btnId).style.display = 'none'; }
function setAMPM(val) { selectedAMPM = val; document.getElementById('btn-am').classList.remove('active'); document.getElementById('btn-pm').classList.remove('active'); document.getElementById(val === 'a. m.' ? 'btn-am' : 'btn-pm').classList.add('active'); document.getElementById('hora-box').classList.remove('field-error');
}
function selectCat(btn, tipo) { document.querySelectorAll('#cat-grid .card-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); catName = btn.innerText; catType = tipo; document.getElementById('cat-grid').classList.remove('field-error'); const s3 = document.getElementById('sec-3');
const s4 = document.getElementById('sec-4'); const c3 = document.getElementById('cont-3'); const c4 = document.getElementById('cont-4'); s3.classList.remove('hidden'); s4.classList.add('hidden'); c3.innerHTML = ""; c4.innerHTML = "";
if (['escuela', 'integral', 'conjunta'].includes(tipo)) { document.getElementById('label-3').innerText = "ü©∫ 3. ESPECIALIDADES M√âDICAS *"; renderList(c3, DATA.especialidades); s4.classList.remove('hidden'); renderList(c4, DATA.servicios);
} else if (tipo === 'vacuna') { document.getElementById('label-3').innerText = "üíâ 3. LISTA DE VACUNAS *"; renderList(c3, DATA.vacunas);
} else if (tipo === 'quirurgica') { document.getElementById('label-3').innerText = "üî™ 3. PATOLOG√çAS QUIR√öRGICAS *"; renderList(c3, DATA.quirurgica);
} else if (tipo === 'oftalmo') { document.getElementById('label-3').innerText = "üëÅÔ∏è 3. PATOLOG√çAS OFTALMOL√ìGICAS *"; renderList(c3, DATA.oftalmo);
} else { document.getElementById('label-3').innerText = "‚ú® 3. DESCRIPCI√ìN DEL REQUERIMIENTO *";
c3.innerHTML = '<textarea id="desc-otro" class="modern-input" rows="3" style="grid-column: 1 / -1;" placeholder="Detalle aqu√≠ su solicitud especial..."></textarea>';
} }
function renderList(cont, list) { list.forEach(i => { const d = document.createElement('div'); d.className = 'card-btn'; d.innerText = i; d.onclick = () => { d.classList.toggle('selected'); document.getElementById('sec-3').classList.remove('field-error'); }; cont.appendChild(d); });
}

function showPage(id, btn) { 
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
    window.scrollTo({top: 0, behavior: 'smooth'});
if(btn) btn.classList.add('active'); 
    else document.getElementById('tab-' + id.split('-')[0]).classList.add('active'); 
    if(id === 'list-page') updateTable();
}

async function updateTable() {
    try {
        const res = await fetch(`${SCRIPT_URL}?action=read`);
        const response = await res.json();
        
        // Manejo Mantenimiento
        isMaintActive = (response.maintenance === "true" || response.maintenance === true);
        if(isMaintActive && !isAdmin) {
            document.getElementById('maintOverlay').style.display = 'flex';
        } else {
            document.getElementById('maintOverlay').style.display = 'none';
        }

        if (response.success && Array.isArray(response.data)) { 
            localData = response.data;
            renderLocalTable(); 
        }
    } catch (e) { 
        console.error("Error cargando tabla:", e);
    }
}

function renderLocalTable() {
    const body = document.getElementById('solicitudes-body');
    body.innerHTML = "";
    let counts = { total:0, pend:0, proc:0, fin:0, baja:0 };
    const sortedData = [...localData].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
    sortedData.forEach((s, idx) => {
        counts.total++;
        const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
        const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
        if(statusLimpio === 'pendiente') counts.pend++;
        if(statusLimpio === 'procesando') counts.proc++;
        if(statusLimpio === 'finalizada') counts.fin++;
        if(statusLimpio === 'bajaprioridad') counts.baja++;

        const esNueva = (idx < 5 && statusReal === "PENDIENTE");
        const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
        const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";
        const badge = esNueva ? '<span class="badge-new">NUEVA ‚ú®</span>' : '';
        let icon = (s.Soportes && s.Soportes.includes("S√ç")) ? `üì∑ (${s.Soportes.match(/\d+/) || 1})` : "üôà";

        const tr = document.createElement('tr');
        if(esNueva) tr.className = "row-new";
        tr.innerHTML = `
            <td><span class="txt-small">${s.Timestamp}</span></td>
            <td><span class="txt-bold">${s.Fecha}</span><br><span class="txt-small">${s.Hora || ''}</span></td>
            <td class="txt-bold">${unidadLimpia} ${badge}</td>
            <td>${jornadaLimpia}</td>
            <td align="center">${icon}</td>
            <td><span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span></td>
            ${isAdmin ? `<td align="right">
                <div class="admin-actions">
                    <button class="btn-act bg-pend" onclick="modStatus('${s.id}','PENDIENTE')">P</button>
                    <button class="btn-act bg-proc" onclick="modStatus('${s.id}','PROCESANDO')">PR</button>
                    <button class="btn-act bg-fin" onclick="modStatus('${s.id}','FINALIZADA')">F</button>
                    <button class="btn-act bg-baja" onclick="modStatus('${s.id}','BAJA PRIORIDAD')">B</button>
                    <button class="btn-trash" onclick="deleteReq('${s.id}')">üóëÔ∏è</button>
                </div>
            </td>` : ''}`;
        body.appendChild(tr);
    });
    
    document.getElementById('count-total').innerText = counts.total;
    document.getElementById('count-pend').innerText = counts.pend;
    document.getElementById('count-proc').innerText = counts.proc;
    document.getElementById('count-fin').innerText = counts.fin;
    document.getElementById('count-baja').innerText = counts.baja;
}

async function modStatus(id, st) {
    const pill = document.getElementById('pill-' + id);
    const oldClass = pill.className;
    const oldText = pill.innerText;
    const newStatusClass = st.toLowerCase().replace(/\s+/g, '');
    pill.className = `status-pill status-${newStatusClass}`; pill.innerText = st;
    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `action=updateStatus&id=${id}&status=${encodeURIComponent(st)}` });
        const item = localData.find(x => x.id == id); if(item) item.Estatus = st; renderLocalTable();
    } catch (e) { pill.className = oldClass;
    pill.innerText = oldText; alert("Error de conexi√≥n."); }
}

async function deleteReq(id) {
    if(!confirm("¬øEliminar registro permanentemente?")) return;
    localData = localData.filter(x => x.id != id); renderLocalTable();
    try { await fetch(SCRIPT_URL, { method:'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `action=delete&id=${id}` });
    } catch (e) { alert("Error al eliminar."); updateTable(); }
}

document.getElementById('sigrafForm').onsubmit = async (e) => {
    e.preventDefault();
    document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
    
    const fields = [
        { id: 'unidad', label: 'Unidad Solicitante', val: document.getElementById('unidad').value.trim() },
        { id: 'cat-grid', label: 'Tipo de Jornada', val: catName },
        { id: 'sec-3', label: 'Detalle de Especialidades/Patolog√≠as', isList: true },
        { id: 'fecha', label: 'Fecha de Actividad', val: document.getElementById('fecha').value },
        { id: 'hora', label: 'Hora de Inicio', val: document.getElementById('hora').value.trim() },
        { id: 'hora-box', label: 'Formato de Hora (AM/PM)', val: selectedAMPM },
        { id: 'direccion', label: 'Direcci√≥n Exacta', val: document.getElementById('direccion').value.trim() },
        { id: 'mail', label: 'Correo Electr√≥nico', val: document.getElementById('mail').value.trim() }
    ];
    for (let field of fields) {
        let isInvalid = false;
        const el = document.getElementById(field.id);
        
        if (field.isList) {
            if (catType === 'otros') {
                if (document.getElementById('desc-otro').value.trim() === "") isInvalid = true;
            } else {
                if (document.querySelectorAll('#cont-3 .card-btn.selected').length === 0) isInvalid = true;
            }
        } else {
            if (!field.val || (field.id === 'unidad' && field.val === "U.M.I.") || (field.id === 'mail' && !field.val.includes('@'))) {
                isInvalid = true;
            }
        }

        if (isInvalid) {
            el.classList.add('field-error');
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            openModal("‚ùå Campo Faltante", `Falta completar el campo: ${field.label}`);
            return;
        }
    }

    const fechaSeleccionada = new Date(document.getElementById('fecha').value + 'T00:00:00');
    const ahora = new Date();
    if ((fechaSeleccionada - ahora) / (1000 * 60 * 60) < 48) {
        openModal("‚è≥ Restricci√≥n de Tiempo", "Lo sentimos, las solicitudes deben realizarse con al menos 48 horas de anticipaci√≥n.");
        document.getElementById('fecha').classList.add('field-error');
        return;
    }

    const params = new URLSearchParams();
    params.append("Unidad", document.getElementById('unidad').value); params.append("Jornada", catName);
    let ops = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el=>el.innerText).join(", ");
    if(catType === 'otros') ops = document.getElementById('desc-otro').value;
    params.append("Opciones", ops); params.append("Servicios", Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el=>el.innerText).join(", "));
    params.append("Fecha", document.getElementById('fecha').value);
    params.append("Hora", document.getElementById('hora').value + " " + selectedAMPM);
    params.append("Direccion", document.getElementById('direccion').value); params.append("Telefono", document.getElementById('tlf').value);
    params.append("Correo", document.getElementById('mail').value); params.append("Observaciones", document.getElementById('observaciones').value);
    
    let tieneFotos = false;
    for(let i=1; i<=3; i++){ const img = document.getElementById('p'+i); if(img.src && img.src.startsWith("data:image")) { params.append("foto"+i, img.src); tieneFotos = true;
    } }

    document.getElementById('loadMainTxt').innerText = tieneFotos ? "Subiendo Im√°genes..." : "Enviando Solicitud...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
        const response = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const result = await response.json();
        if (result.success) {
            openModal("‚úÖ ¬°√âxito!", "Su solicitud ha sido enviada correctamente.", "üöÄ");
            document.getElementById('sigrafForm').reset();
            setTimeout(() => { closeModal(); showPage('list-page', document.getElementById('tab-list')); }, 2000);
        } else { throw new Error(result.error);
        }
    } catch (e) { 
        openModal("‚úÖ Solicitud Procesada", "El sistema ha registrado su env√≠o.", "üìã");
        setTimeout(() => { closeModal(); showPage('list-page', document.getElementById('tab-list')); }, 2000);
    }
    finally { document.getElementById('loadingOverlay').style.display = 'none'; }
};
</script>
</body>
</html>
