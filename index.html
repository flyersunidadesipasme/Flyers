  // ============================================================
  // SIRA 2.5 ‚Äì Sistema Integral de Requerimientos de Artes
  // VERSI√ìN COMPLETA - FASE 1 Y 2 IMPLEMENTADAS
  // ============================================================

  // ============================================================
  // CONFIGURACI√ìN DE 5TO DISE√ëADOR
  // ============================================================
  var DESIGNER_CONFIG = {
    DESIGNERS: [
      { name: "Bermina", color: "#fb8500" },
      { name: "Jorsy", color: "#023047" },
      { name: "Mar√≠a F.", color: "#2d6a4f" },
      { name: "Xamir", color: "#ffb703" },
      { name: "Fulan@", color: "#9d0208" }  // ‚úÖ NUEVO 5TO DISE√ëADOR
    ],
    ALLOWED_NAMES: ["Bermina", "Jorsy", "Mar√≠a F.", "Xamir", "Fulan@"]
  };

  // ============================================================
  // VARIABLES GLOBALES - SIN CREDENCIALES HARDCODEADAS
  // ============================================================
  var SS = SpreadsheetApp.getActiveSpreadsheet();
  var SHEET = SS.getSheets()[0];
  var PROPS = PropertiesService.getScriptProperties();

  // ‚úÖ CREDENCIALES DESDE PROPERTIES (NO HARDCODEADAS)
  var CORREO_DESTINO = PROPS.getProperty("CORREO_DESTINO") || "flyersunidadesipasme@gmail.com";
  var DRIVE_FOLDER_ID = PROPS.getProperty("DRIVE_FOLDER_ID");
  var CHUNKS_FOLDER_ID = PROPS.getProperty("CHUNKS_FOLDER_ID");

  // ‚úÖ CONFIGURACI√ìN DE SEGURIDAD
  var SECURITY_CONFIG = {
    MAX_LOGIN_ATTEMPTS: 5,
    LOCKOUT_DURATION_MS: 15 * 60 * 1000,
    SESSION_TIMEOUT_MS: 8 * 60 * 60 * 1000,
    CSRF_TOKEN_EXPIRY_MS: 30 * 60 * 1000
  };

  // ‚úÖ CONFIGURACI√ìN DE FECHAS (FASE 2 - UNIFICADA)
  var DATE_CONFIG = {
    TIMEZONE: "GMT-4",
    DATE_FORMAT: "dd/MM/yyyy",
    DATETIME_FORMAT: "dd/MM/yyyy HH:mm",
    INPUT_FORMAT: "yyyy-MM-dd"
  };

  // ============================================================
  // CONFIGURACI√ìN DE MONITOREO DE CUOTAS Y ESTAD√çSTICAS
  // ============================================================

  var QUOTA_CONFIG = {
    // Cuotas para cuenta gratuita (gmail.com)
    LIMITS: {
      URL_FETCH_DAILY: 20000,      // URL Fetch calls por d√≠a
      EMAIL_RECIPIENTS_DAILY: 100,  // Destinatarios de email por d√≠a
      EMAIL_READ_WRITE_DAILY: 20000, // Email read/write por d√≠a
      PROPERTIES_READ_WRITE: 50000,  // Properties read/write por d√≠a
      SCRIPT_RUNTIME_DAILY: 90 * 60 * 1000  // 90 minutos en ms
    },
    
    // IDs de chat de Telegram para notificaciones (puede ser un JSON array de strings)
    TELEGRAM_CHAT_IDS: JSON.parse(PROPS.getProperty("TELEGRAM_CHAT_IDS") || "[]"),
    // Token del bot de Telegram
    TELEGRAM_TOKEN: PROPS.getProperty("TELEGRAM_TOKEN") || "CONFIGURAR_EN_PROPERTIES",
    // Chat ID individual para comunicaciones espec√≠ficas con el bot
    BOT_CHAT_ID: PROPS.getProperty("BOT_CHAT_ID"),
    
    // Horario de env√≠o diario (11:00 PM)
    DAILY_HOUR: 23,
    DAILY_MINUTE: 0,
    
    // D√≠as para reporte semanal (Domingo = 0)
    WEEKLY_DAY: 0,
    
    // D√≠a para reporte mensual (√∫ltimo d√≠a del mes se detecta autom√°ticamente)
    MONTHLY_DAY: null  // null para detectar autom√°ticamente el √∫ltimo d√≠a
  };

  // Claves para almacenar estad√≠sticas en Properties
  var STATS_KEYS = {
    DAILY: "quota_stats_daily_",
    WEEKLY: "quota_stats_weekly_",
    MONTHLY: "quota_stats_monthly_",
    USER_CALLS: "user_calls_stats_",
    LAST_RESET: "quota_last_reset_date"
  };

  // ============================================================
  // FUNCIONES DE FECHAS UNIFICADAS (FASE 2 - MEJORA #1)
  // ============================================================

  function formatearFecha(valor, formato = 'datetime') {
    try {
      if (!valor || valor.toString().trim() === "") return "";
      
      var fechaObj;
      
      // Si ya es objeto Date
      if (valor instanceof Date) {
        fechaObj = valor;
      } 
      // Si es string, intentar parsear m√∫ltiples formatos
      else if (typeof valor === 'string') {
        var texto = valor.trim();
        
        // Formato dd/MM/yyyy o dd/MM/yyyy HH:mm
        if (texto.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
          var partes = texto.split(' ');
          var fechaPart = partes[0].split('/');
          var dia = parseInt(fechaPart[0], 10);
          var mes = parseInt(fechaPart[1], 10) - 1;
          var anio = parseInt(fechaPart[2], 10);
          
          var hora = 0, minuto = 0;
          if (partes[1]) {
            var horaPart = partes[1].split(':');
            hora = parseInt(horaPart[0], 10) || 0;
            minuto = parseInt(horaPart[1], 10) || 0;
          }
          
          fechaObj = new Date(anio, mes, dia, hora, minuto);
        }
        // Formato yyyy-MM-dd (ISO)
        else if (texto.match(/^\d{4}-\d{2}-\d{2}/)) {
          fechaObj = new Date(texto);
        }
        // Formato MM/dd/yyyy (US)
        else if (texto.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
          fechaObj = new Date(texto);
        }
        else {
          // Intentar parseo gen√©rico como √∫ltimo recurso
          fechaObj = new Date(texto);
        }
      } 
      // Si es n√∫mero (timestamp de Excel/Sheets)
      else if (typeof valor === 'number') {
        // Excel/Sheets timestamp (d√≠as desde 1899-12-30)
        if (valor > 30000 && valor < 50000) {
          var epoch = new Date(1899, 11, 30);
          fechaObj = new Date(epoch.getTime() + valor * 24 * 60 * 60 * 1000);
        } else {
          // Timestamp en milisegundos
          fechaObj = new Date(valor);
        }
      }
      
      // Validar que la fecha sea v√°lida
      if (!fechaObj || isNaN(fechaObj.getTime())) {
        Logger.log("‚ö†Ô∏è Fecha inv√°lida detectada: " + valor);
        return "";
      }
      
      // Formatear seg√∫n el tipo solicitado
      switch (formato) {
        case 'date':
          return Utilities.formatDate(fechaObj, DATE_CONFIG.TIMEZONE, DATE_CONFIG.DATE_FORMAT);
        case 'datetime':
          return Utilities.formatDate(fechaObj, DATE_CONFIG.TIMEZONE, DATE_CONFIG.DATETIME_FORMAT);
        case 'iso':
          return Utilities.formatDate(fechaObj, DATE_CONFIG.TIMEZONE, DATE_CONFIG.INPUT_FORMAT);
        case 'timestamp':
          return fechaObj.getTime().toString();
        default:
          return Utilities.formatDate(fechaObj, DATE_CONFIG.TIMEZONE, DATE_CONFIG.DATETIME_FORMAT);
      }
      
    } catch (e) {
      Logger.log("‚ùå Error formatearFecha con valor '" + valor + "': " + e.toString());
      return "";
    }
  }

  function parsearFechaString(texto) {
    if (!texto || typeof texto !== 'string') return null;
    texto = texto.trim().replace(/-/g, '/');
    var partes = texto.split(' ');
    var fechaPart = partes[0];
    if (fechaPart.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
      var dmy = fechaPart.split('/');
      return new Date(parseInt(dmy[2]), parseInt(dmy[1]) - 1, parseInt(dmy[0]));
    } else if (fechaPart.match(/^\d{4}\/\d{1,2}\/\d{1,2}/)) {
      var iso = fechaPart.split('/');
      return new Date(parseInt(iso[0]), parseInt(iso[1]) - 1, parseInt(iso[2]));
    } else if (fechaPart.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}/)) {
      var us = fechaPart.split('/');
      var anio = us[2].length === 2 ? 2000 + parseInt(us[2]) : parseInt(us[2]);
      return new Date(anio, parseInt(us[0]) - 1, parseInt(us[1]));
    }
    return null;
  }

  function extraerFecha(dateTime) {
    if (!dateTime) return "";
    return dateTime.split(' ')[0] || "";
  }

  function extraerHora(dateTime) {
    if (!dateTime) return "";
    var partes = dateTime.trim().split(' ');
    if (partes.length < 2) return "Sin hora";
    return partes.slice(1).join(' ');
  }

  function validarFecha(fechaStr) {
    if (!fechaStr) return false;
    return /^\d{4}-\d{2}-\d{2}$/.test(fechaStr);
  }

  function compararFechas(fecha1, fecha2) {
    var f1 = new Date(fecha1.getFullYear(), fecha1.getMonth(), fecha1.getDate());
    var f2 = new Date(fecha2.getFullYear(), fecha2.getMonth(), fecha2.getDate());
    if (f1 < f2) return -1;
    if (f1 > f2) return 1;
    return 0;
  }

  // NUEVA FUNCI√ìN: Parseo robusto de fechas
  function parseFechaRobusto(valor) {
    if (!valor) return null;
    
    try {
      // Si ya es Date
      if (valor instanceof Date) {
        return isNaN(valor.getTime()) ? null : valor;
      }
      
      // Convertir a string y limpiar
      var texto = String(valor).trim();
      if (!texto) return null;
      
      // Formato dd/MM/yyyy HH:mm (formato de la hoja)
      if (texto.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
        var partes = texto.split(' ');
        var fechaPart = partes[0].split('/');
        var dia = parseInt(fechaPart[0], 10);
        var mes = parseInt(fechaPart[1], 10) - 1;
        var anio = parseInt(fechaPart[2], 10);
        
        var hora = 0, minuto = 0;
        if (partes[1]) {
          var tiempoPart = partes[1].split(':');
          hora = parseInt(tiempoPart[0], 10) || 0;
          minuto = parseInt(tiempoPart[1], 10) || 0;
          
          // Manejar AM/PM
          if (partes[2] && partes[2].toLowerCase().includes('p')) {
            if (hora !== 12) hora += 12;
          } else if (partes[2] && partes[2].toLowerCase().includes('a') && hora === 12) {
            hora = 0;
          }
        }
        
        var fecha = new Date(anio, mes, dia, hora, minuto);
        return isNaN(fecha.getTime()) ? null : fecha;
      }
      
      // Formato yyyy-MM-dd (ISO)
      if (texto.match(/^\d{4}-\d{2}-\d{2}/)) {
        var fecha = new Date(texto);
        return isNaN(fecha.getTime()) ? null : fecha;
      }
      
      // Formato MM/dd/yyyy (US)
      if (texto.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
        var partes = texto.split('/');
        var fecha = new Date(parseInt(partes[2]), parseInt(partes[0]) - 1, parseInt(partes[1]));
        return isNaN(fecha.getTime()) ? null : fecha;
      }
      
      // Intentar parseo gen√©rico como √∫ltimo recurso
      var fecha = new Date(texto);
      return isNaN(fecha.getTime()) ? null : fecha;
      
    } catch (e) {
      Logger.log("‚ùå Error parseFechaRobusto con valor '" + valor + "': " + e.toString());
      return null;
    }
  }

  // ============================================================
  // FUNCIONES DE SEGURIDAD - RATE LIMITING Y LOGGING
  // ============================================================

  function isRateLimited(identifier) {
    var lockKey = "login_lock_" + identifier;
    var attemptsKey = "login_attempts_" + identifier;
    var lockExpiry = PROPS.getProperty(lockKey);
    if (lockExpiry && new Date().getTime() < parseInt(lockExpiry)) {
      var remainingTime = Math.ceil((parseInt(lockExpiry) - new Date().getTime()) / 60000);
      logSecurityEvent("RATE_LIMIT_HIT", identifier, "Bloqueado por " + remainingTime + " minutos");
      return true;
    }
    if (lockExpiry && new Date().getTime() >= parseInt(lockExpiry)) {
      PROPS.deleteProperty(lockKey);
      PROPS.deleteProperty(attemptsKey);
    }
    return false;
  }

  function recordFailedLogin(identifier) {
    var attemptsKey = "login_attempts_" + identifier;
    var lockKey = "login_lock_" + identifier;
    var attempts = parseInt(PROPS.getProperty(attemptsKey) || "0") + 1;
    PROPS.setProperty(attemptsKey, attempts.toString());
    logSecurityEvent("LOGIN_FAILED", identifier, "Intento " + attempts + "/" + SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS);
    if (attempts >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS) {
      var lockExpiry = new Date().getTime() + SECURITY_CONFIG.LOCKOUT_DURATION_MS;
      PROPS.setProperty(lockKey, lockExpiry.toString());
      PROPS.deleteProperty(attemptsKey);
      logSecurityEvent("ACCOUNT_LOCKED", identifier, "Cuenta bloqueada por 15 minutos");
    }
  }

  function clearFailedLogins(identifier) {
    PROPS.deleteProperty("login_attempts_" + identifier);
    PROPS.deleteProperty("login_lock_" + identifier);
  }

  function generateCSRFToken() {
    var token = Utilities.getUuid() + "_" + new Date().getTime();
    var expiry = new Date().getTime() + SECURITY_CONFIG.CSRF_TOKEN_EXPIRY_MS;
    PROPS.setProperty("csrf_" + token, expiry.toString());
    return token;
  }

  function validateCSRFToken(token) {
    if (!token) return false;
    var expiry = PROPS.getProperty("csrf_" + token);
    if (!expiry) return false;
    if (new Date().getTime() > parseInt(expiry)) {
      PROPS.deleteProperty("csrf_" + token);
      return false;
    }
    return true;
  }

  function logSecurityEvent(eventType, user, details) {
    try {
      var logSheetName = "SecurityLog";
      var logSheet = SS.getSheetByName(logSheetName);
      if (!logSheet) {
        logSheet = SS.insertSheet(logSheetName);
        logSheet.hideSheet();
        logSheet.appendRow(["Timestamp", "EventType", "User", "Details", "IP"]);
      }
      var timestamp = formatearFecha(new Date(), 'datetime');
      var ip = getUserIP();
      logSheet.appendRow([timestamp, eventType, user || "ANONIMO", details || "", ip || "N/A"]);
      if (logSheet.getLastRow() > 1000) {
        logSheet.deleteRows(2, logSheet.getLastRow() - 1000);
      }
      Logger.log("üîí SECURITY LOG: " + eventType + " | " + user + " | " + details);
    } catch (e) {
      Logger.log("‚ùå Error logging security event: " + e.toString());
    }
  }

  function getUserIP() {
    try {
      return ScriptApp.getContext().getEffectiveUser().getEmail();
    } catch (e) {
      return "N/A";
    }
  }

  // ============================================================
  // FUNCIONES DE REGISTRO DE USO DE CUOTAS
  // ============================================================

  /**
  * Registra una llamada URL Fetch
  * Llamar esta funci√≥n cada vez que uses UrlFetchApp.fetch()
  */
  function logUrlFetchCall(userIdentifier, endpoint) {
    try {
      var today = new Date();
      var dateKey = Utilities.formatDate(today, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
      var propsKey = STATS_KEYS.DAILY + dateKey;
      
      var stats = JSON.parse(PROPS.getProperty(propsKey) || "{}");
      
      if (!stats.urlFetch) {
        stats.urlFetch = { count: 0, endpoints: {}, users: {} };
      }
      
      // Incrementar contador total
      stats.urlFetch.count = (stats.urlFetch.count || 0) + 1;
      
      // Registrar endpoint
      if (endpoint) {
        stats.urlFetch.endpoints[endpoint] = (stats.urlFetch.endpoints[endpoint] || 0) + 1;
      }
      
      // Registrar por usuario
      if (userIdentifier) {
        stats.urlFetch.users[userIdentifier] = (stats.urlFetch.users[userIdentifier] || 0) + 1;
      }
      
      PROPS.setProperty(propsKey, JSON.stringify(stats));
      
    } catch (e) {
      Logger.log("‚ùå Error registrando URL Fetch: " + e.toString());
    }
  }

  /**
  * Registra un env√≠o de email
  * Llamar esta funci√≥n cada vez que uses MailApp.sendEmail()
  */
  function logEmailSend(recipientCount, userIdentifier) {
    try {
      var today = new Date();
      var dateKey = Utilities.formatDate(today, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
      var propsKey = STATS_KEYS.DAILY + dateKey;
      
      var stats = JSON.parse(PROPS.getProperty(propsKey) || "{}");
      
      if (!stats.emails) {
        stats.emails = { count: 0, recipients: 0, users: {} };
      }
      
      stats.emails.count = (stats.emails.count || 0) + 1;
      stats.emails.recipients = (stats.emails.recipients || 0) + (recipientCount || 1);
      
      if (userIdentifier) {
        stats.emails.users[userIdentifier] = (stats.emails.users[userIdentifier] || 0) + 1;
      }
      
      PROPS.setProperty(propsKey, JSON.stringify(stats));
      
    } catch (e) {
      Logger.log("‚ùå Error registrando Email: " + e.toString());
    }
  }

  /**
  * Registra uso de PropertiesService
  */
  function logPropertiesAccess(operation, userIdentifier) {
    try {
      var today = new Date();
      var dateKey = Utilities.formatDate(today, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
      var propsKey = STATS_KEYS.DAILY + dateKey;
      
      var stats = JSON.parse(PROPS.getProperty(propsKey) || "{}");
      
      if (!stats.properties) {
        stats.properties = { read: 0, write: 0, users: {} };
      }
      
      if (operation === 'read') {
        stats.properties.read = (stats.properties.read || 0) + 1;
      } else if (operation === 'write') {
        stats.properties.write = (stats.properties.write || 0) + 1;
      }
      
      if (userIdentifier) {
        if (!stats.properties.users[userIdentifier]) {
          stats.properties.users[userIdentifier] = { read: 0, write: 0 };
        }
        stats.properties.users[userIdentifier][operation]++;
      }
      
      PROPS.setProperty(propsKey, JSON.stringify(stats));
      
    } catch (e) {
      Logger.log("‚ùå Error registrando Properties: " + e.toString());
    }
  }

  // ============================================================
  // FUNCIONES DE AUTENTICACI√ìN (3 ADMINISTRADORES)
  // ============================================================

  function isAdminUser(username, password) {
    var user1 = PROPS.getProperty("ADMIN_USER_1");
    var pass1 = PROPS.getProperty("ADMIN_PASS_1");
    var user2 = PROPS.getProperty("ADMIN_USER_2");
    var pass2 = PROPS.getProperty("ADMIN_PASS_2");
    var user3 = PROPS.getProperty("ADMIN_USER_3");
    var pass3 = PROPS.getProperty("ADMIN_PASS_3");
    
    // USAR COMPARACI√ìN SEGURA PARA TODOS LOS ADMINISTRADORES
    return (safeCompare(username, user1) && safeCompare(password, pass1)) ||
          (safeCompare(username, user2) && safeCompare(password, pass2)) ||
          (safeCompare(username, user3) && safeCompare(password, pass3));
  }

  function isDesignerUser(username, password) {
    for (var i = 1; i <= 5; i++) {
      var user = PROPS.getProperty("DESIGNER_USER_" + i);
      var pass = PROPS.getProperty("DESIGNER_PASS_" + i);
      var name = PROPS.getProperty("DESIGNER_NAME_" + i);
      if (safeCompare(username, user) && safeCompare(password, pass)) {
        return { isValid: true, designerName: name };
      }
    }
    return { isValid: false };
  }

  function safeCompare(a, b) {
    if (!a || !b) return false;
    if (a.length !== b.length) return false;
    var result = 0;
    for (var i = 0; i < a.length; i++) {
      result |= a.charCodeAt(i) ^ b.charCodeAt(i);
    }
    return result === 0;
  }

  function validateAdminCredentials(username, password) {
    if (!username || !password) {
      return { isValid: false, error: "Credenciales incompletas" };
    }
    username = sanitizeInput(username);
    if (isAdminUser(username, password)) {
      clearFailedLogins(username);
      logSecurityEvent("LOGIN_SUCCESS", username, "Rol: admin");
      return { isValid: true, role: "admin", username: username };
    }
    var designerCheck = isDesignerUser(username, password);
    if (designerCheck.isValid) {
      clearFailedLogins(username);
      logSecurityEvent("LOGIN_SUCCESS", username, "Rol: dise√±ador");
      return { isValid: true, role: "dise√±ador", username: username, designerName: designerCheck.designerName };
    }
    recordFailedLogin(username);
    logSecurityEvent("LOGIN_FAILED", username, "Credenciales inv√°lidas");
    return { isValid: false, error: "Credenciales incorrectas" };
  }

  function requireAdmin(username, password) {
    if (!isAdminUser(username, password)) {
      logSecurityEvent("ACCESS_DENIED", username, "Intento de acceso admin sin permisos");
      throw new Error("Acceso denegado. Solo administradores pueden realizar esta acci√≥n.");
    }
  }

  // ============================================================
  // FUNCIONES DE SANITIZACI√ìN
  // ============================================================

  function sanitizeInput(input) {
    if (!input || typeof input !== 'string') return "";
    var sanitized = input.replace(/<[^>]*>/g, '');
    sanitized = sanitized.replace(/[<>'"&]/g, function(char) {
      var entities = { '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;', '&': '&amp;' };
      return entities[char] || char;
    });
    return sanitized.substring(0, 5000);
  }

  function sanitizeForURL(input) {
    if (!input) return "";
    return encodeURIComponent(sanitizeInput(input));
  }

  function validateEmail(email) {
    if (!email) return null;
    email = sanitizeInput(email);
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) return null;
    return email;
  }

  function validateMimeType(mimeType) {
    var allowedTypes = [
      'image/jpeg', 'image/jpg', 'image/png', 'image/gif',
      'application/pdf', 'application/zip',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/msword'
    ];
    return allowedTypes.indexOf(mimeType) !== -1;
  }

  // ============================================================
  // FUNCIONES AUXILIARES
  // ============================================================

  function createResponse(data, success = true, csrfToken = null) {
    var response = { success: success, maintenance: PROPS.getProperty("maintMode") || "false" };
    if (success) {
      response.data = data;
      if (csrfToken) response.csrfToken = csrfToken;
    } else {
      response.error = data;
    }
    return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
  }

  function toBullets(text) {
    if (!text || text.trim() === "" || text === "---") return "Ninguno";
    var cleanText = decodeURIComponent(text.replace(/\+/g, ' '));
    return cleanText.split(",").map(item => "‚Ä¢ " + sanitizeInput(item.trim())).filter(item => item !== "‚Ä¢ ").join("\n");
  }

  function normalizeBase64(str) {
    if (!str) return str;
    while (str.length % 4) str += "=";
    return str.replace(/-/g, '+').replace(/_/g, '/');
  }
  // NUEVAS FUNCIONES DE ESTAD√çSTICAS AVANZADAS
  // ============================================================

  /**
  * Obtiene estad√≠sticas detalladas para el dashboard
  */
  function getAdvancedStats(period) {
    try {
      var today = new Date();
      var startDate, endDate;
      var stats = {
        total: 0,
        pendiente: 0,
        procesando: 0,
        finalizada: 0,
        porDia: [],
        porDisenador: {},
        porUnidad: {},
        porJornada: {},
        porEspecialidad: {},  
        porServicio: {},      
        solicitudesFinalizadas: [], 
        velocidadConexion: 0
      };
      
      // Definir rango de fechas seg√∫n per√≠odo
      if (period === 'day') {
        startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
      } else if (period === 'week') {
        var dayOfWeek = today.getDay();
        var diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        startDate = new Date(today.getFullYear(), today.getMonth(), diff);
        endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 7);
      } else if (period === 'month') {
        startDate = new Date(2000, 0, 1); 
        endDate = new Date(2100, 0, 1);   
      } else {
        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      }
      
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheets()[0];
      var data = sheet.getDataRange().getDisplayValues();
      
      if (data.length <= 1) {
        return { success: true, data: stats };
      }
      
      var designersCount = {};
      
      for (var i = 1; i < data.length; i++) {
        var row = data[i];
        if (!row[0]) continue; 
        
        var timestampStr = row[1];
        var fechaRegistro = parseFechaRobusto(timestampStr);
        
        if (!fechaRegistro) {
          Logger.log("‚ö†Ô∏è No se pudo parsear fecha en fila " + (i+1) + ": " + timestampStr);
          continue;
        }
        
        if (period !== 'month' && (fechaRegistro < startDate || fechaRegistro >= endDate)) {
          continue;
        }
        
        stats.total++;
        
        var estatus = (row[14] || "").toUpperCase().trim();
        var disenador = row[15] || "Sin asignar";
        var especialidadesRaw = row[5] || row[4] || "";
        var serviciosRaw = row[6] || "";
        
        if (estatus === "PENDIENTE") {
          stats.pendiente++;
        } else if (estatus === "PROCESANDO") {
          stats.procesando++;
        } else if (estatus === "FINALIZADA") {
          stats.finalizada++;
          designersCount[disenador] = (designersCount[disenador] || 0) + 1;
          
          stats.solicitudesFinalizadas.push({
            id: row[0],
            unidad: row[2],
            jornada: row[3],
            disenador: disenador,
            fecha: timestampStr
          });
        }
        
        var dateKey = Utilities.formatDate(fechaRegistro, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
        var existingDay = stats.porDia.find(d => d.fecha === dateKey);
        if (existingDay) {
          existingDay.cantidad++;
        } else {
          stats.porDia.push({ fecha: dateKey, cantidad: 1 });
        }
        
        var unidad = row[2] || "Sin unidad";
        stats.porUnidad[unidad] = (stats.porUnidad[unidad] || 0) + 1;
        
        var jornada = row[3] || "Sin jornada";
        stats.porJornada[jornada] = (stats.porJornada[jornada] || 0) + 1;
        
        if (especialidadesRaw && especialidadesRaw !== "---" && especialidadesRaw !== "Ninguno") {
          var especialidades = especialidadesRaw.split("\n").filter(e => e.trim() !== "");
          especialidades.forEach(function(esp) {
            var cleanEsp = esp.replace(/^‚Ä¢\s*/, "").trim();
            if (cleanEsp) {
              stats.porEspecialidad[cleanEsp] = (stats.porEspecialidad[cleanEsp] || 0) + 1;
            }
          });
        }
        
        if (serviciosRaw && serviciosRaw !== "---" && serviciosRaw !== "Ninguno") {
          var servicios = serviciosRaw.split("\n").filter(s => s.trim() !== "");
          servicios.forEach(function(serv) {
            var cleanServ = serv.replace(/^‚Ä¢\s*/, "").trim();
            if (cleanServ) {
              stats.porServicio[cleanServ] = (stats.porServicio[cleanServ] || 0) + 1;
            }
          });
        }
      }
      
      stats.porDisenador = designersCount;
      
      stats.porDia.sort(function(a, b) {
        return new Date(a.fecha) - new Date(b.fecha);
      });
      
      return { success: true, data: stats };
      
    } catch (e) {
      Logger.log("‚ùå Error getAdvancedStats: " + e.toString());
      return { success: false, error: e.toString() };
    }
  }

  /**
  * Obtiene historial de solicitudes por per√≠odo
  */
  function getRequestsHistory(period) {
    try {
      var today = new Date();
      var daysBack = 0;
      if (period === 'day') daysBack = 1;
      else if (period === 'week') daysBack = 7;
      else if (period === 'month') daysBack = 30;
      else daysBack = 30;

      var history = [];
      for (var i = daysBack - 1; i >= 0; i--) {
        var date = new Date(today);
        date.setDate(date.getDate() - i);
        var dateKey = Utilities.formatDate(date, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
        history.push({
          fecha: dateKey,
          dia: Utilities.formatDate(date, DATE_CONFIG.TIMEZONE, "dd/MM"),
          recibidas: 0,
          finalizadas: 0
        });
      }

      var data = SHEET.getDataRange().getDisplayValues();
      for (var j = 1; j < data.length; j++) {
        var row = data[j];
        if (!row[0]) continue;
        
        // ‚úÖ USAR FUNCI√ìN ROBUSTA
        var fechaRegistro = parseFechaRobusto(row[1]);
        if (!fechaRegistro) continue;
        
        var dateKey = Utilities.formatDate(fechaRegistro, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
        for (var k = 0; k < history.length; k++) {
          if (history[k].fecha === dateKey) {
            history[k].recibidas++;
            if ((row[14] || "").toUpperCase().trim() === "FINALIZADA") {
              history[k].finalizadas++;
            }
            break;
          }
        }
      }

      return { success: true, data: history };
    } catch (e) {
      return { success: false, error: e.toString() };
    }
  }

  /**
  * Obtiene rendimiento de dise√±adores basado en la FECHA DE FINALIZACI√ìN
  */
  function getDesignerPerformance(period) {
    try {
      var today = new Date();
      var daysBack = 0;
      if (period === 'day') daysBack = 1;
      else if (period === 'week') daysBack = 7;
      else if (period === 'month') daysBack = 30;
      else daysBack = 30; // Default mes
      
      var startDate = new Date(today);
      startDate.setDate(startDate.getDate() - daysBack);
      // Ajustar hora de inicio a 00:00 para incluir todo el d√≠a
      startDate.setHours(0,0,0,0);
      
      var performance = {};
      DESIGNER_CONFIG.DESIGNERS.forEach(function(d) {
        performance[d.name] = {
          nombre: d.name,
          color: d.color,
          finalizadas: 0,
          tiempoPromedio: 0,
          porcentaje: 0
        };
      });
      
      var data = SHEET.getDataRange().getDisplayValues();
      var totalFinalizadas = 0;
      
      for (var i = 1; i < data.length; i++) {
        var row = data[i];
        if (!row[0]) continue;
        
        // Verificar si est√° FINALIZADA
        if ((row[14] || "").toUpperCase().trim() !== "FINALIZADA") continue;
        
        // ‚úÖ OBTENER NOMBRE Y FECHA DE LA CELDA DEL DISE√ëADOR (Columna 15 / P)
        // Formato esperado: "Nombre|dd/MM/yyyy HH:mm"
        var designerCell = row[15] || "";
        var designerParts = designerCell.split("|");
        var disenador = designerParts[0].trim();
        var fechaFinalizacionStr = designerParts[1] || "";
        
        if (!performance[disenador]) continue; // Saltar si no es un dise√±ador v√°lido
        
        var fechaFinalizacion = null;
        
        // Si hay fecha guardada, usarla. Si no, usar fecha de solicitud (respaldo)
        if (fechaFinalizacionStr) {
          fechaFinalizacion = parseFechaRobusto(fechaFinalizacionStr);
        } else {
          // Respaldo: usar fecha de registro si no hay fecha de finalizaci√≥n guardada
          fechaFinalizacion = parseFechaRobusto(row[1]); 
        }
        
        if (!fechaFinalizacion) continue;
        
        // ‚úÖ FILTRAR POR FECHA DE FINALIZACI√ìN (No de creaci√≥n)
        if (fechaFinalizacion < startDate) continue;
        
        performance[disenador].finalizadas++;
        totalFinalizadas++;
      }
      
      // Calcular porcentajes
      for (var name in performance) {
        if (totalFinalizadas > 0) {
          performance[name].porcentaje = Math.round((performance[name].finalizadas / totalFinalizadas) * 100);
        }
      }
      
      var result = [];
      for (var name in performance) {
        result.push(performance[name]);
      }
      result.sort(function(a, b) { return b.finalizadas - a.finalizadas; });
      
      return { success: true, data: result };
    } catch (e) {
      Logger.log("‚ùå Error getDesignerPerformance: " + e.toString());
      return { success: false, error: e.toString() };
    }
  }

  /**
  * Guarda velocidad de conexi√≥n desde frontend
  */
  function saveConnectionSpeed(speed) {
    try {
      PROPS.setProperty("last_connection_speed", speed.toString());
      return { success: true };
    } catch (e) {
      return { success: false, error: e.toString() };
    }
  }

  // ============================================================
  // FUNCIONES DE TELEGRAM
  // ============================================================

  function getTelegramToken() {
    var token = PROPS.getProperty("TELEGRAM_TOKEN");
    if (!token) {
      Logger.log("‚ùå TOKEN DE TELEGRAM NO CONFIGURADO");
      throw new Error("Token de Telegram no configurado en Properties");
    }
    return token;
  }

  function getTelegramChatIds() {
    var ids = PROPS.getProperty("TELEGRAM_CHAT_IDS");
    if (!ids) {
      Logger.log("‚ùå CHAT IDS DE TELEGRAM NO CONFIGURADOS");
      return [];
    }
    try {
      return JSON.parse(ids);
    } catch (e) {
      return [ids];
    }
  }

  function getIconoJornada(jornada) {
    var j = (jornada || "").toLowerCase();
    if (j.includes("obituario")) return "‚ö∞Ô∏è";
    if (j.includes("escuela")) return "üéí";
    if (j.includes("integral")) return "üë®‚Äç‚öïÔ∏è";
    if (j.includes("conjunta")) return "ü´Ç";
    if (j.includes("vacunaci√≥n")) return "üíâ";
    if (j.includes("oftalmol√≥gica")) return "üëÅÔ∏è";
    if (j.includes("quir√∫rgica pedi√°trica")) return "üë∂";
    if (j.includes("quir√∫rgica")) return "ü©∫";
    return "üìã";
  }

  function enviarTelegram(unidad, jornada, id, fechaLimpia, hora, numFotos) {
    try {
      // ‚úÖ REGISTRAR LLAMADA URL FETCH (Telegram API)
      logUrlFetchCall("SYSTEM", "telegram_notification");
      
      var token = getTelegramToken();
      var chatIds = getTelegramChatIds();
      var esObituario = (jornada || "").toLowerCase().includes("obituario");
      var icono = getIconoJornada(jornada);
      var unidadFormateada = sanitizeInput(unidad);
      var avisoFotos = (numFotos > 0) ? "üì∏ *Soportes fotogr√°ficos enviados.*" : "üôà *No se adjuntaron fotos.*";
      var msg = "üö® *NUEVA SOLICITUD DE ARTE*\n" +
        "üÜî *ID:* `" + sanitizeInput(id) + "`\n" +
        "__________________________\n" +
        "üè• *Unidad:* " + unidadFormateada + "\n" +
        " " + icono + " *Solicitud:* " + (esObituario ? "Obituario" : sanitizeInput(jornada)) + "\n" +
        "üìÖ *Evento:* " + sanitizeInput(fechaLimpia) + (esObituario ? "" : " | " + sanitizeInput(hora).toUpperCase()) + "\n" +
        avisoFotos;
      if (esObituario) msg += "\n‚ùó *Priorizar atenci√≥n*";
      chatIds.forEach(function(chatId) {
        try {
          UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
            "method": "post",
            "payload": { "chat_id": chatId, "text": msg, "parse_mode": "Markdown" },
            "muteHttpExceptions": true
          });
        } catch (e) {
          Logger.log("Error enviando a " + chatId + ": " + e.toString());
          logSecurityEvent("TELEGRAM_ERROR", "SYSTEM", "Error enviando a chat " + chatId);
        }
      });
      logSecurityEvent("TELEGRAM_SENT", "SYSTEM", "Notificaci√≥n enviada para solicitud " + id);
    } catch (e) {
      Logger.log("‚ùå Error en enviarTelegram: " + e.toString());
    }
  }

  function enviarTelegramDual(mensaje, enviarAGrupo = true, enviarABot = true) {
    try {
      var token = getTelegramToken();
      var resultados = [];
      
      // Enviar al grupo/chats configurados en TELEGRAM_CHAT_IDS
      if (enviarAGrupo) {
        var chatIds = getTelegramChatIds();
        chatIds.forEach(function(chatId) {
          try {
            var response = UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
              "method": "post",
              "payload": { "chat_id": chatId, "text": mensaje, "parse_mode": "Markdown" },
              "muteHttpExceptions": true
            });
            
            var result = JSON.parse(response.getContentText());
            if (result.ok) {
              Logger.log("‚úÖ Mensaje enviado a chat " + chatId + " correctamente");
              resultados.push({ chatId: chatId, success: true });
            } else {
              Logger.log("‚ùå Error enviando a chat " + chatId + ": " + result.description);
              resultados.push({ chatId: chatId, success: false, error: result.description });
            }
          } catch (e) {
            Logger.log("Error enviando a " + chatId + ": " + e.toString());
            resultados.push({ chatId: chatId, success: false, error: e.toString() });
          }
        });
      }
      
      // Enviar solo al bot
      if (enviarABot) {
        try {
          var botChatId = getBotChatId();
          var response = UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
            "method": "post",
            "payload": { "chat_id": botChatId, "text": mensaje, "parse_mode": "Markdown" },
            "muteHttpExceptions": true
          });
          
          var result = JSON.parse(response.getContentText());
          if (result.ok) {
            Logger.log("‚úÖ Mensaje enviado al bot correctamente");
            resultados.push({ chatId: botChatId, success: true, isBot: true });
          } else {
            Logger.log("‚ùå Error enviando al bot: " + result.description);
            resultados.push({ chatId: botChatId, success: false, error: result.description, isBot: true });
          }
        } catch (e) {
          Logger.log("‚ùå Error enviando al bot: " + e.toString());
          resultados.push({ chatId: "BOT", success: false, error: e.toString(), isBot: true });
        }
      }
      
      // Resumen de env√≠os
      var exitosos = resultados.filter(r => r.success).length;
      var fallidos = resultados.filter(r => !r.success).length;
      
      Logger.log("üìä Resumen env√≠o Telegram: " + exitosos + " exitosos, " + fallidos + " fallidos");
      
      return {
        success: fallidos === 0,
        resultados: resultados,
        exitosos: exitosos,
        fallidos: fallidos
      };
      
    } catch (e) {
      Logger.log("‚ùå Error en enviarTelegramDual: " + e.toString());
      return { success: false, error: e.toString() };
    }
  }

  function getBotChatId() {
    var botChatId = PROPS.getProperty("BOT_CHAT_ID");
    if (!botChatId) {
      Logger.log("‚ùå BOT_CHAT_ID NO CONFIGURADO EN PROPERTIES");
      throw new Error("BOT_CHAT_ID no configurado en Properties");
    }
    return botChatId;
  }

  function enviarTelegramBot(mensaje) {
    try {
      var token = getTelegramToken();
      var chatId = getBotChatId();
      
      var payload = {
        chat_id: chatId,
        text: mensaje,
        parse_mode: "Markdown"
      };
      
      var options = {
        method: "post",
        payload: payload,
        muteHttpExceptions: true
      };
      
      var response = UrlFetchApp.fetch(
        "https://api.telegram.org/bot" + token + "/sendMessage", 
        options
      );
      
      var result = JSON.parse(response.getContentText());
      
      if (result.ok) {
        Logger.log("‚úÖ Mensaje enviado al bot correctamente");
      } else {
        Logger.log("‚ùå Error enviando al bot: " + result.description);
      }
      
    } catch (e) {
      Logger.log("‚ùå Error en enviarTelegramBot: " + e.toString());
    }
  }

  // ============================================================
  // FUNCIONES DE EMAIL
  // ============================================================

  function enviarEmail(p, id, blobs, detalle, servicios, fechaLimpia) {
    try {
      var scriptUrl = ScriptApp.getService().getUrl();
      var csrfToken = generateCSRFToken();
      var linkProcesar = scriptUrl + "?action=updateStatus&id=" + sanitizeForURL(id) + "&status=PROCESANDO&csrf=" + csrfToken;
      var esObituario = (p.Jornada || "").toLowerCase().includes("obituario");
      var tituloDetalle = "Detalles de la solicitud";
      if ((p.Jornada || "").toLowerCase().includes("vacunaci√≥n")) tituloDetalle = "Esquema de vacunas";
      else if ((p.Jornada || "").toLowerCase().includes("quir√∫rgica")) tituloDetalle = "Patolog√≠as";
      else if ((p.Jornada || "").toLowerCase().includes("escuela")) tituloDetalle = "Especialidades m√©dicas";
      var tituloFormateado = sanitizeInput(p.Unidad);
      var horaTexto = esObituario ? "" : sanitizeInput(p.Hora);
      var direccionTexto = esObituario ? "No aplica" : sanitizeInput(p.Direccion || "");
      var observacionesTexto = esObituario ? "Solicitud prioritaria de car√°cter humanitario." : sanitizeInput(p.Observaciones || "Sin observaciones.");
      var html = '<div style="font-family: Arial, sans-serif; color: #023047; max-width: 500px; margin: auto; border: 1px solid #edf2f4; border-radius: 10px; overflow: hidden;">' +
        '<div style="background: #023047; padding: 15px; text-align: center;"><h2 style="color: #ffffff; margin: 0; font-size: 16px;">' + (esObituario ? '‚ö∞Ô∏è ' : '') + 'Solicitud: ' + sanitizeInput(id) + '</h2></div>' +
        '<div style="padding: 20px; background: #ffffff;">' +
        '<div style="margin-bottom: 15px;"><b style="color: #219ebc; font-size: 14px; display: block; margin-bottom: 4px;">Unidad Solicitante</b><span>' + tituloFormateado + '</span></div>' +
        '<div style="margin-bottom: 15px;"><b style="color: #219ebc; font-size: 14px; display: block; margin-bottom: 4px;">' + (esObituario ? 'Solicitud' : 'Tipo de jornada') + '</b><span>' + (esObituario ? 'Obituario' : sanitizeInput(p.Jornada)) + '</span></div>' +
        '<div style="margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 10px;"><b style="color: #219ebc; font-size: 14px; display: block; margin-bottom: 6px;">' + tituloDetalle + '</b><div style="font-size: 14px; line-height: 1.6; color: #333;">' + detalle.replace(/\n/g, "<br>") + '</div></div>' +
        (servicios && servicios !== "Ninguno" ? '<div style="margin-bottom: 15px;"><b style="color: #219ebc; font-size: 14px; display: block; margin-bottom: 6px;">Servicios adicionales</b><div style="font-size: 14px; color: #333;">' + servicios.replace(/\n/g, "<br>") + '</div></div>' : '') +
        '<div style="margin-bottom: 15px;"><b style="color: #219ebc; font-size: 14px; display: block; margin-bottom: 4px;">Fecha de actividad</b><span>' + sanitizeInput(fechaLimpia) + '</span></div>' +
        (!esObituario ? '<div style="margin-bottom: 15px;"><b style="color: #219ebc; font-size: 14px; display: block; margin-bottom: 4px;">Hora de inicio</b><span>' + horaTexto + '</span></div>' : '') +
        '<div style="margin-bottom: 15px;"><b style="color: #219ebc; font-size: 14px; display: block; margin-bottom: 6px;">Direcci√≥n exacta</b><div style="font-size: 14px; color: #555; line-height: 1.5;">' + direccionTexto + '</div></div>' +
        '<div style="margin-bottom: 15px;"><b style="color: #219ebc; font-size: 14px; display: block; margin-bottom: 6px;">Contacto</b><div style="font-size: 14px;">' + sanitizeInput(p.Telefono) + ' | ' + (validateEmail(p.Correo) || 'No v√°lido') + '</div></div>' +
        '<div style="margin-top: 15px; padding: 12px; background: #fdf2e9; border-radius: 6px;"><b style="color: #fb8500; font-size: 14px; display: block; margin-bottom: 6px;">Observaciones</b><div style="font-size: 14px; color: #5d4600; line-height: 1.5;">' + observacionesTexto + '</div></div>' +
        '<div style="margin-top: 25px; text-align: center;"><a href="' + linkProcesar + '" style="background-color: #ffb703; color: #023047; padding: 12px 25px; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 14px; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">MARCAR COMO PROCESANDO</a></div>' +
        '</div></div>';
      var emailTo = validateEmail(CORREO_DESTINO);
      if (!emailTo) {
        logSecurityEvent("EMAIL_ERROR", "SYSTEM", "Email de destino inv√°lido");
        return;
      }
      MailApp.sendEmail({
        to: emailTo,
        subject: "Solicitud: " + tituloFormateado + " / " + (esObituario ? "Obituario" : sanitizeInput(p.Jornada)),
        htmlBody: html,
        attachments: blobs.length > 0 ? blobs : null
      });
      logSecurityEvent("EMAIL_SENT", "SYSTEM", "Email enviado para solicitud " + id);
      
      // ‚úÖ REGISTRAR ENV√çO DE EMAIL
      logEmailSend(1, "SYSTEM"); // 1 destinatario, sistema autom√°tico
      
    } catch (e) {
      Logger.log("Error en email: " + e.toString());
      logSecurityEvent("EMAIL_ERROR", "SYSTEM", e.toString());
    }
  }

  // ============================================================
  // FUNCIONES DE CHUNKS (FASE 2 - MEJORA #2: RECUPERACI√ìN)
  // ============================================================

  // ‚ùå FUNCI√ìN ELIMINADA - SIN POSIBILIDAD DE REANUDAR
  // function getChunkUploadState(id) { ... }

  function cancelChunkedUpload(id) {
    try {
      id = sanitizeInput(id);
      if (!id || id.length > 50) throw new Error("ID de solicitud inv√°lido");
      
      var tempFolderName = id;
      var chunksDeleted = 0;
      var folderDeleted = false;
      var folders = DriveApp.getFoldersByName(tempFolderName);
      
      if (folders.hasNext()) {
        var tempFolder = folders.next();
        var files = tempFolder.getFiles();
        while (files.hasNext()) {
          files.next().setTrashed(true);
          chunksDeleted++;
        }
        
        try {
          tempFolder.setTrashed(true);
          folderDeleted = true;
        } catch (e1) {
          try {
            var parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
            parentFolder.removeFolder(tempFolder);
            tempFolder.setTrashed(true);
            folderDeleted = true;
          } catch (e2) {
            Logger.log("‚ö†Ô∏è Advertencia: No se pudo eliminar carpeta temporal: " + e2.toString());
          }
        }
        
        // ‚úÖ LIMPIAR TODA METADATA SIN EXCEPCI√ìN
        var propsKey = "chunk_upload_" + id;
        PROPS.deleteProperty(propsKey + "_count");
        PROPS.deleteProperty(propsKey + "_meta");
        
        // ‚úÖ ELIMINAR CUALQUIER ESTADO DE REANUDACI√ìN
        PROPS.deleteProperty(propsKey + "_resume_token");
        PROPS.deleteProperty(propsKey + "_last_chunk");
        
        logSecurityEvent("CHUNK_CANCELLED", "SYSTEM", "Subida cancelada ID " + id + ". Eliminados " + chunksDeleted + " chunks. SIN POSIBILIDAD DE REANUDAR");
        
        return {
          success: true,
          message: "Subida cancelada y TODOS los recursos eliminados permanentemente",
          chunksDeleted: chunksDeleted,
          folderDeleted: folderDeleted,
          canResume: false // ‚úÖ EXPL√çCITAMENTE FALSE
        };
      } else {
        var propsKey = "chunk_upload_" + id;
        PROPS.deleteProperty(propsKey + "_count");
        PROPS.deleteProperty(propsKey + "_meta");
        PROPS.deleteProperty(propsKey + "_resume_token");
        PROPS.deleteProperty(propsKey + "_last_chunk");
        
        return {
          success: true,
          message: "Recursos ya limpios o inexistentes",
          chunksDeleted: 0,
          folderDeleted: false,
          canResume: false
        };
      }
    } catch (err) {
      Logger.log("‚ùå Error cancelChunkedUpload: " + err.toString());
      logSecurityEvent("CHUNK_CANCEL_ERROR", "SYSTEM", err.toString());
      
      // ‚úÖ LIMPIAR METADATA INCLUSO EN ERROR
      try {
        var propsKey = "chunk_upload_" + id;
        PROPS.deleteProperty(propsKey + "_count");
        PROPS.deleteProperty(propsKey + "_meta");
        PROPS.deleteProperty(propsKey + "_resume_token");
        PROPS.deleteProperty(propsKey + "_last_chunk");
      } catch (e) {}
      
      return { success: false, error: err.toString(), canResume: false };
    }
  }

  // ============================================================
  // FUNCI√ìN doGet (FASE 2 - MEJORA #3: INVALIDACI√ìN DE CACH√â)
  // ============================================================

  function doGet(e) {
    try {
      if (e.parameter.action === "invalidateCache") {
        var csrfToken = e.parameter.csrf;
        if (!validateCSRFToken(csrfToken)) {
          return createResponse("Token CSRF inv√°lido", false);
        }
        PROPS.deleteProperty("data_cache_timestamp");
        return createResponse({ success: true, message: "Cach√© invalidada" }, true);
      }
      if (e.parameter.action === "updateStatus") {
        var csrfToken = e.parameter.csrf;
        if (!validateCSRFToken(csrfToken)) {
          return ContentService.createTextOutput("‚ùå Token CSRF inv√°lido o expirado");
        }
        var id = sanitizeInput(e.parameter.id);
        var status = sanitizeInput(e.parameter.status);
        var allowedStatus = ["PENDIENTE", "PROCESANDO", "FINALIZADA"];
        if (allowedStatus.indexOf(status) === -1) {
          return ContentService.createTextOutput("‚ùå Estatus inv√°lido");
        }
        var data = SHEET.getDataRange().getValues();
        for (var i = 1; i < data.length; i++) {
          if (data[i][0] == id) {
            SHEET.getRange(i + 1, 15).setValue(status);
            logSecurityEvent("STATUS_UPDATED", "WEB", "ID: " + id + " -> " + status);
            // ‚úÖ INVALIDAR CACH√â DE STATS
            invalidateStatsCache();
            PROPS.deleteProperty("data_cache_timestamp");
            return ContentService.createTextOutput("‚úÖ Estatus actualizado a " + status + ". Puedes cerrar esta ventana.");
          }
        }
      }
      // ‚úÖ PARA doGet TAMBI√âN USAR handleReadAction
      if (e.parameter.action === "read") {
          var page = parseInt(e.parameter.page || "1");
          var limit = parseInt(e.parameter.limit || "40");
          return handleReadAction(page, limit);
      }
      return createResponse([], true, generateCSRFToken());
    } catch (err) {
      logSecurityEvent("DOGET_ERROR", "SYSTEM", err.toString());
      return createResponse(err.toString(), false);
    }
  }

  // ============================================================
  // FUNCI√ìN: Estad√≠sticas con cach√© independiente (FASE 3 - OPTIMIZACI√ìN)
  // ============================================================

  function getCachedStats() {
    var cacheKey = "stats_cache_v3";
    var cached = PROPS.getProperty(cacheKey);
    
    if (cached) {
      try {
        var parsed = JSON.parse(cached);
        // CACH√â V√ÅLIDO POR 2 MINUTOS (120000 ms)
        if (new Date().getTime() - parsed.timestamp < 120000) {
          Logger.log(" Stats desde cach√© (v3)");
          return parsed.stats;
        }
      } catch (e) {
        Logger.log(" Error parseando cach√© de stats: " + e.toString());
      }
    }
    
    // LECTURA OPTIMIZADA - SOLO COLUMNAS ESENCIALES
    var lastRow = SHEET.getLastRow();
    if (lastRow < 2) {
      return { total: 0, pend: 0, proc: 0, fin: 0, bermina: 0, jorsy: 0, maria: 0, xamir: 0, fulano: 0 };
    }
    
    // SOLO COLUMNAS 1 (ID), 15 (Estatus), 16 (Dise√±ador)
    var data = SHEET.getRange(2, 1, lastRow - 1, 16).getValues();
    var stats = { total: 0, pend: 0, proc: 0, fin: 0, bermina: 0, jorsy: 0, maria: 0, xamir: 0, fulano: 0 };
    
    for (var i = 0; i < data.length; i++) {
      if (!data[i][0]) continue;
      stats.total++;
      var status = (data[i][14] || "").toString().toUpperCase().trim().toLowerCase().replace(/\s+/g,'');
      if (status === 'pendiente') stats.pend++;
      else if (status === 'procesando') stats.proc++;
      else if (status === 'finalizada') {
        stats.fin++;
        var designer = (data[i][15] || "").toString().split("|")[0].trim();
        if (designer === "Bermina") stats.bermina++;
        else if (designer === "Jorsy") stats.jorsy++;
        else if (designer === "Mar√≠a F.") stats.maria++;
        else if (designer === "Xamir") stats.xamir++;
        else if (designer === "Fulan@") stats.fulano++;
      }
    }
    
    // GUARDAR EN CACH√â
    PROPS.setProperty(cacheKey, JSON.stringify({
      stats: stats,
      timestamp: new Date().getTime()
    }));
    
    return stats;
  }

  // ============================================================
  // FUNCI√ìN: Invalidar cach√© de estad√≠sticas
  // ============================================================

  function invalidateStatsCache() {
    PROPS.deleteProperty("stats_cache_v3");
    Logger.log("üóëÔ∏è Cach√© de stats invalidado");
  }

  // ============================================================
  // FUNCI√ìN: √çNDICE DE B√öSQUEDA R√ÅPIDA
  // ============================================================

  // ‚úÖ NUEVO: CREAR √çNDICE DE B√öSQUEDA
  function updateSearchIndex() {
    try {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var indexSheet = ss.getSheetByName("SearchIndex");
      
      if (!indexSheet) {
        indexSheet = ss.insertSheet("SearchIndex");
        indexSheet.appendRow(["ID", "Timestamp", "Estatus", "Disenador", "RowNumber"]);
        indexSheet.hideSheet();
      }
      
      var mainSheet = ss.getSheets()[0];
      var data = mainSheet.getRange(2, 1, mainSheet.getLastRow() - 1, 16).getValues();
      
      var indexData = [];
      for (var i = 0; i < data.length; i++) {
        if (data[i][0]) {
          indexData.push([
            data[i][0],  // ID
            data[i][1],  // Timestamp
            data[i][14], // Estatus
            data[i][15], // Dise√±ador
            i + 2        // RowNumber
          ]);
        }
      }
      
      // ‚úÖ LIMPIAR Y ACTUALIZAR √çNDICE
      if (indexSheet.getLastRow() > 1) {
        indexSheet.deleteRows(2, indexSheet.getLastRow() - 1);
      }
      if (indexData.length > 0) {
        indexSheet.getRange(2, 1, indexData.length, 5).setValues(indexData);
      }
      
      Logger.log("‚úÖ √çndice actualizado: " + indexData.length + " registros");
      return { success: true, count: indexData.length };
    } catch (e) {
      Logger.log("‚ùå Error updateSearchIndex: " + e.toString());
      return { success: false, error: e.toString() };
    }
  }

  // ‚úÖ B√öSQUEDA POR ID USANDO √çNDICE
  function searchByIdIndexed(id) {
    try {
      var indexSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("SearchIndex");
      if (!indexSheet) return { success: false, error: "√çndice no disponible" };
      
      var indexData = indexSheet.getDataRange().getValues();
      var results = [];
      
      for (var i = 1; i < indexData.length; i++) {
        if (indexData[i][0] && indexData[i][0].toString().toUpperCase().includes(id.toString().toUpperCase())) {
          results.push({
            id: indexData[i][0],
            timestamp: indexData[i][1],
            status: indexData[i][2],
            designer: indexData[i][3],
            rowNumber: indexData[i][4]
          });
        }
      }
      
      return { success: true, data: results };
    } catch (e) {
      return { success: false, error: e.toString() };
    }
  }

  // ‚úÖ FUNCI√ìN MEJORADA - VERSI√ìN OPTIMIZADA
  function handleReadAction(page, limit) {
    try {
      // 1Ô∏è‚É£ ESTAD√çSTICAS DESDE CACH√â (NO RECALKULAR CADA VEZ)
      var stats = getCachedStats();
      
      // 2Ô∏è‚É£ LECTURA SELECTIVA - SOLO COLUMNAS NECESARIAS
      var lastRow = SHEET.getLastRow();
      if (lastRow < 2) {
        return createResponse({
          rows: [],
          stats: stats,
          cacheTimestamp: new Date().getTime().toString(),
          pagination: { currentPage: page, totalPages: 1, totalRecords: 0 }
        }, true);
      }
      
      // ‚úÖ COLUMNAS ESPEC√çFICAS (1, 2, 3, 4, 8, 9, 11, 14, 15, 16, 17)
      // ID, Timestamp, Unidad, Jornada, Fecha, Hora, Correo, Estatus, Dise√±ador, ArteFinal
      var columns = [1, 2, 3, 4, 8, 9, 11, 14, 15, 16, 17];
      var data = SHEET.getRange(2, 1, lastRow - 1, 18).getValues(); // ‚úÖ Leer 18 columnas para incluir la columna 11 (correo)
      
      // 3Ô∏è‚É£ FILTRAR EN SERVIDOR (NO EN FRONTEND)
      var validRows = [];
      for (var i = 0; i < data.length; i++) {
        if (data[i][0]) {
          validRows.push({ originalIndex: i + 2, data: data[i] });
        }
      }
      
      // 4Ô∏è‚É£ ORDENAR POR TIMESTAMP (DESCENDENTE)
      validRows.sort(function(a, b) {
        var tsA = parseFechaRobusto(a.data[1]) || new Date(0);
        var tsB = parseFechaRobusto(b.data[1]) || new Date(0);
        return tsB - tsA;
      });
      
      // 5Ô∏è‚É£ PAGINACI√ìN EFICIENTE
      var totalRecords = validRows.length;
      var totalPages = Math.ceil(totalRecords / limit) || 1;
      if (page < 1) page = 1;
      if (page > totalPages) page = totalPages;
      
      var startIndex = (page - 1) * limit;
      var endIndex = Math.min(startIndex + limit, totalRecords);
      
      // 6Ô∏è‚É£ SOLO PROCESAR FILAS DE LA P√ÅGINA ACTUAL
      var output = [];
      for (var j = startIndex; j < endIndex; j++) {
        var rowData = validRows[j].data;
        output.push({
          id: sanitizeInput(rowData[0]),
          Timestamp: formatearFecha(rowData[1], 'datetime'),
          Unidad: sanitizeInput(rowData[2]),
          Jornada: sanitizeInput(rowData[3]),
          Fecha: formatearFecha(rowData[7], 'datetime'),
          Hora: sanitizeInput(rowData[8]),
          Correo: sanitizeInput(rowData[11] || ""), // ‚úÖ Columna 12 (M) - Correo del usuario (√≠ndice 11 en array)
          Soportes: sanitizeInput(rowData[13]),
          Estatus: sanitizeInput(rowData[14]),
          Disenador: sanitizeInput((rowData[15] || "").split("|")[0].trim()), // ‚úÖ Extraer solo el nombre
          ArteFinal: sanitizeInput(rowData[16] || "")
        });
      }
      
      return createResponse({
        rows: output,
        stats: stats,
        cacheTimestamp: new Date().getTime().toString(),
        pagination: {
          currentPage: page,
          totalPages: totalPages,
          totalRecords: totalRecords,
          hasMore: endIndex < totalRecords
        }
      }, true);
      
    } catch (err) {
      Logger.log("‚ùå Error en handleReadAction: " + err.toString());
      return createResponse(err.toString(), false);
    }
  }

  // ============================================================
  // FUNCI√ìN doPost - MANEJO COMPLETO DE POST
  // ============================================================

  function doPost(e) {
    Logger.log("üöÄ doPost EJECUT√ÅNDOSE - " + new Date().toISOString());
    try {
      // ‚úÖ REGISTRAR LLAMADA URL FETCH (agregar esta l√≠nea al inicio)
      var userIdentifier = (e.parameter && e.parameter.username) ? e.parameter.username : 
                        (e.parameter && e.parameter.uploadedBy) ? e.parameter.uploadedBy : "ANONIMO";
      logUrlFetchCall(userIdentifier, e.parameter && e.parameter.action ? e.parameter.action : "unknown");
      
      // ‚úÖ LOG SIMPLE PARA DIAGNOSTICAR ACCI√ìN
      var actionDebug = e.parameter && e.parameter.action ? e.parameter.action : "unknown";
      Logger.log("üîç ACCI√ìN RECIBIDA: " + actionDebug);
      Logger.log("üîç PAR√ÅMETROS: " + JSON.stringify(e.parameter));
    
      // ‚úÖ PARSEAR CORRECTAMENTE LOS DATOS DEL POST
      var p = {};
      
      // Primero intentar leer de e.parameter (datos URL-encoded en la URL)
      if (e.parameter) {
        for (var key in e.parameter) {
          p[key] = e.parameter[key];
        }
      }
      
      // Luego intentar leer del body (datos URL-encoded en el cuerpo)
      if (e.postData && e.postData.contents) {
        var body = e.postData.contents;
        var pairs = body.split('&');
        for (var i = 0; i < pairs.length; i++) {
          var pair = pairs[i].split('=');
          var key = decodeURIComponent(pair[0] || '');
          var value = decodeURIComponent((pair[1] || '').replace(/\+/g, ' '));
          p[key] = value;
        }
      }
      
      Logger.log("üì• doPost recibido. action=" + p.action + " page=" + p.page + " limit=" + p.limit);
      
      // ‚úÖ SI LA ACCI√ìN ES "read", PROCESAR LA LECTURA INMEDIATAMENTE
      if (p.action === "read") {
        var page = parseInt(p.page || "1");
        var limit = parseInt(p.limit || "40");
        
        // Llamar la funci√≥n que lee los datos
        return handleReadAction(page, limit);
      }
      
      // Otras acciones (login, subir archivos, etc.)
      // ‚úÖ PASAR DATOS PARSEADOS a doPostOriginal
      var eModificado = {
        parameter: p,
        postData: e.postData
      };
      return doPostOriginal(eModificado);
      
    } catch (err) {
      Logger.log("‚ùå ERROR en doPost: " + err.toString());
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: err.toString()
      })).setMimeType(ContentService.MimeType.JSON);
    }
  }

  // ============================================================
  // FUNCI√ìN doPostOriginal (L√ìGICA POST EXISTENTE)
  // ============================================================

  function doPostOriginal(e) {
    try {
      // ‚úÖ USAR LOS DATOS YA PARSEADOS por doPost principal
      // No volver a parsear para evitar duplicidad
      var p = e.parameter || {};
      
      // ‚úÖ NO PROCESAR ACTION=READ - ya manejado en doPost principal
      if (p.action === "read") {
        Logger.log("‚ö†Ô∏è doPostOriginal recibi√≥ action=read - esto no deber√≠a pasar");
        return createResponse("Error: acci√≥n read debe ser manejada por doPost principal", false);
      }
      if (p.action === "ping") {
        return createResponse({ pong: true, timestamp: new Date().getTime() }, true);
      }
      if (p.action === "speedTest") {
        // Solo recibir y responder r√°pido para medir velocidad de subida
        return createResponse({ 
          success: true, 
          timestamp: Date.now(),
          received: true 
        }, true);
      }
      // ‚úÖ SECCI√ìN LOGIN ACTUALIZADA (3 ADMINS)
      if (p.action === "loginAdmin") {
        var username = sanitizeInput(p.username);
        var password = p.password;
        if (isRateLimited(username)) {
          var lockKey = "login_lock_" + username;
          var lockExpiry = PROPS.getProperty(lockKey);
          var remainingMin = Math.ceil((parseInt(lockExpiry) - new Date().getTime()) / 60000);
          return createResponse("Cuenta bloqueada por " + remainingMin + " minutos. Intente m√°s tarde.", false);
        }
        var validation = validateAdminCredentials(username, password);
        if (validation.isValid) {
          var csrfToken = generateCSRFToken();
          if (validation.role === "admin") {
            var name1 = PROPS.getProperty("ADMIN_NAME_1");
            var name2 = PROPS.getProperty("ADMIN_NAME_2");
            var name3 = PROPS.getProperty("ADMIN_NAME_3");
            var displayName = "";
            if (username === PROPS.getProperty("ADMIN_USER_1")) displayName = name1;
            else if (username === PROPS.getProperty("ADMIN_USER_2")) displayName = name2;
            else if (username === PROPS.getProperty("ADMIN_USER_3")) displayName = name3;
            return createResponse({ isAdmin: true, isDesigner: false, username: username, displayName: displayName, role: "admin", csrfToken: csrfToken }, true);
          } else if (validation.role === "dise√±ador") {
            return createResponse({ isAdmin: false, isDesigner: true, username: username, displayName: validation.designerName, role: "dise√±ador", designerName: validation.designerName, csrfToken: csrfToken }, true);
          }
        } else {
          return createResponse(validation.error || "Credenciales incorrectas", false);
        }
      }
      if (p.action === "getEmailQuota") {
        try {
          var today = new Date();
          var dateKey = Utilities.formatDate(today, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
          var propsKey = STATS_KEYS.DAILY + dateKey;
          
          var stats = JSON.parse(PROPS.getProperty(propsKey) || "{}");
          
          // ‚úÖ SI HOY NO HAY DATOS, BUSCAR DATOS DE AYER
          if (!stats.emails || (!stats.emails.count && !stats.emails.recipients)) {
            var yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            var yesterdayKey = Utilities.formatDate(yesterday, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
            var yesterdayPropsKey = STATS_KEYS.DAILY + yesterdayKey;
            var yesterdayStats = JSON.parse(PROPS.getProperty(yesterdayPropsKey) || "{}");
            
            // Usar datos de ayer si hay
            if (yesterdayStats.emails && (yesterdayStats.emails.count || yesterdayStats.emails.recipients)) {
              stats = yesterdayStats;
              dateKey = yesterdayKey;
            }
          }
          
          var limits = QUOTA_CONFIG.LIMITS;
          
          var emailCount = stats.emails?.count || 0;
          var emailRecipients = stats.emails?.recipients || 0;
          var limit = limits.EMAIL_RECIPIENTS_DAILY;
          var remaining = Math.max(0, limit - emailRecipients);
          var percentage = (emailRecipients / limit * 100).toFixed(1);
          
          return createResponse({
            success: true,
            emailsSent: emailCount,
            recipientsUsed: emailRecipients,
            limit: limit,
            remaining: remaining,
            percentage: parseFloat(percentage),
            date: Utilities.formatDate(new Date(dateKey), DATE_CONFIG.TIMEZONE, "dd/MM/yyyy"),
            status: percentage < 80 ? "üü¢" : percentage < 95 ? "üü°" : "üî¥"
          }, true);
        } catch (e) {
          Logger.log("‚ùå Error en getEmailQuota: " + e.toString());
          return createResponse({ success: false, error: "Error obteniendo cuota de correos" }, false);
        }
      }
      if (p.action === "generateMonthlyReport") {
        try {
          var username = sanitizeInput(p.username);
          var password = sanitizeInput(p.password);
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          requireAdmin(username, password);
          return createResponse(generateMonthlyReport(), true);
        } catch (err) {
          logSecurityEvent("REPORT_ACCESS_DENIED", p.username, err.message);
          return createResponse(err.message, false);
        }
      }
      if (p.action === "deleteFinalizedRequests") {
        try {
          var username = sanitizeInput(p.username);
          var password = sanitizeInput(p.password);
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          requireAdmin(username, password);
          
          var data = SHEET.getDataRange().getValues();
          var lastMonth = new Date();
          lastMonth.setMonth(lastMonth.getMonth() - 1);
          var lastMonthStr = Utilities.formatDate(lastMonth, DATE_CONFIG.TIMEZONE, "MM/yyyy");
          
          var deletedCount = 0;
          var rowsToDelete = [];
          
          for (var i = data.length - 1; i > 0; i--) {
            var row = data[i];
            var fechaRegistro = row[1]; // Columna B (Timestamp)
            var estado = row[14]; // Columna O (Estado)
            
            if (estado === "FINALIZADA" && fechaRegistro) {
              var fechaObj = new Date(fechaRegistro);
              var rowMonthStr = Utilities.formatDate(fechaObj, DATE_CONFIG.TIMEZONE, "MM/yyyy");
              
              if (rowMonthStr === lastMonthStr) {
                rowsToDelete.push(i + 1); // +1 porque las filas en Google Sheets son 1-based
              }
            }
          }
          
          // Eliminar filas (de abajo hacia arriba para no afectar los √≠ndices)
          rowsToDelete.sort(function(a, b) { return b - a; });
          rowsToDelete.forEach(function(rowNum) {
            SHEET.deleteRow(rowNum);
            deletedCount++;
          });
          
          return createResponse({ success: true, count: deletedCount }, true);
        } catch (err) {
          Logger.log("‚ùå Error en deleteFinalizedRequests: " + err.toString());
          return createResponse("Error al eliminar solicitudes finalizadas: " + err.message, false);
        }
      }
      if (p.action === "uploadArte") {
        try {
          var username = sanitizeInput(p.uploadedBy || "Sistema");
          var id = sanitizeInput(p.id);
          
          // ‚úÖ MODO H√çBRIDO: Detectar si es subida directa o por chunks
          var isChunked = (p.isChunked === "true");
          
          if (!validateMimeType(p.mime)) {
            logSecurityEvent("INVALID_MIME", username, "Intento de subir archivo con MIME: " + p.mime);
            return createResponse("Tipo de archivo no permitido", false);
          }
          
          var fileData = Utilities.base64Decode(p.file);
          if (fileData.length > 6 * 1024 * 1024) return createResponse("Archivo excede 6MB", false);
          var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
          var ext = p.filename.split('.').pop().toLowerCase();
          var allowedExts = ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'zip', 'doc', 'docx'];
          if (allowedExts.indexOf(ext) === -1) return createResponse("Extensi√≥n de archivo no permitida", false);
          var newName = "ARTE_" + id + "." + ext;
          var existing = folder.getFilesByName(newName);
          while (existing.hasNext()) existing.next().setTrashed(true);
          var blob = Utilities.newBlob(fileData, p.mime, newName);
          var file = folder.createFile(blob);
          file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
          var data = SHEET.getDataRange().getValues();
          var row = null;
          for (var i = 1; i < data.length; i++) {
            if (data[i][0] == id) {
              SHEET.getRange(i + 1, 17).setValue(file.getUrl() + " (" + username + ")");
              row = data[i];
              break;
            }
          }
          if (row) {
            var unidadFormateada = sanitizeInput(row[2]);
            var msg = "üé® *" + username + " adjunt√≥ arte a la solicitud*\nüÜî *ID:* `" + sanitizeInput(row[0]) + "`\nüè• *Unidad:* " + unidadFormateada + "\nüìÇ *Tipo de Jornada:* " + sanitizeInput(row[3]) + "\n‚è≥ *Esperando aprobaci√≥n.*";
            var token = getTelegramToken();
            var chatIds = getTelegramChatIds();
            chatIds.forEach(function(chatId) {
              try {
                UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
                  "method": "post",
                  "payload": { "chat_id": chatId, "text": msg, "parse_mode": "Markdown" },
                  "muteHttpExceptions": true
                });
              } catch (e) {}
            });
          }
          
          // ‚úÖ LOG ESPEC√çFICO PARA MODO H√çBRIDO
          var uploadMode = isChunked ? "CHUNKS" : "DIRECTO";
          logSecurityEvent("ARTE_UPLOADED_" + uploadMode, username, "ID: " + id + " | Modo: " + uploadMode);
          
          return createResponse("Arte actualizado correctamente (" + uploadMode + ")", true);
        } catch (err) {
          logSecurityEvent("ARTE_UPLOAD_ERROR", p.uploadedBy, err.toString());
          return createResponse(err.toString(), false);
        }
      }
      if (p.action === "uploadChunk") {
        try {
          var id = sanitizeInput(p.id);
          var username = sanitizeInput(p.uploadedBy || "Sistema");
          if (!id || id.length > 50) return createResponse("ID inv√°lido", false);
          var chunkIndex = parseInt(p.chunkIndex);
          if (isNaN(chunkIndex) || chunkIndex < 0) return createResponse("√çndice de chunk inv√°lido", false);
          var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
          var tempFolderName = id;
          var tempFolder;
          try {
            var folders = DriveApp.getFoldersByName(tempFolderName);
            if (folders.hasNext()) tempFolder = folders.next();
            else {
              tempFolder = DriveApp.createFolder(tempFolderName);
              folder.addFolder(tempFolder);
            }
          } catch (e) {
            tempFolder = DriveApp.createFolder(tempFolderName);
            folder.addFolder(tempFolder);
          }
          var chunkFilename = sanitizeInput(p.fileId) + "_chunk_" + chunkIndex.toString().padStart(5, '0');
          var blob = Utilities.newBlob(Utilities.base64Decode(p.chunkData), p.mime, chunkFilename);
          var chunkFile = tempFolder.createFile(blob);
          var propsKey = "chunk_upload_" + id;
          var metadata = JSON.parse(PROPS.getProperty(propsKey + "_meta") || "{}");
          metadata.fileId = sanitizeInput(p.fileId);
          metadata.filename = sanitizeInput(p.filename);
          metadata.mime = p.mime;
          metadata.totalChunks = parseInt(p.totalChunks);
          metadata.uploadedChunks = (PROPS.getProperty(propsKey + "_count") || 0);
          metadata.uploadedBy = username;
          metadata.chunks = metadata.chunks || {};
          metadata.chunks[p.chunkIndex] = { uploadedAt: new Date(), size: p.chunkData.length };
          metadata.uploadedChunks++;
          PROPS.setProperty(propsKey + "_count", metadata.uploadedChunks);
          PROPS.setProperty(propsKey + "_meta", JSON.stringify(metadata));
          Logger.log("‚úÖ Chunk " + (chunkIndex + 1) + "/" + metadata.totalChunks + " subido para ID " + id);
          return createResponse("Chunk " + (chunkIndex + 1) + " subido correctamente", true);
        } catch (err) {
          Logger.log("‚ùå Error uploadChunk: " + err.toString());
          logSecurityEvent("CHUNK_UPLOAD_ERROR", p.uploadedBy, err.toString());
          return createResponse(err.toString(), false);
        }
      }
      if (p.action === "finalizeChunkedUpload") {
        try {
          var id = sanitizeInput(p.id);
          var username = sanitizeInput(p.uploadedBy || "Sistema");
          if (!id || id.length > 50) return createResponse("ID inv√°lido", false);
          var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
          var tempFolderName = id;
          var folders = DriveApp.getFoldersByName(tempFolderName);
          if (!folders.hasNext()) return createResponse("Error: No se encontraron chunks", false);
          var tempFolder = folders.next();
          var propsKey = "chunk_upload_" + id;
          var metadata = JSON.parse(PROPS.getProperty(propsKey + "_meta") || "{}");
          if (!metadata.totalChunks) return createResponse("Error: Metadata no encontrada", false);
          var expectedChunks = parseInt(p.totalChunks || metadata.totalChunks);
          var chunkFiles = tempFolder.getFiles();
          var chunksFound = 0;
          while (chunkFiles.hasNext()) { chunksFound++; chunkFiles.next(); }
          if (chunksFound < expectedChunks) return createResponse("Error: Faltan chunks (" + chunksFound + "/" + expectedChunks + ")", false);
          Logger.log("üîÑ Reensamblando " + expectedChunks + " chunks para " + p.filename);
          var allBytes = [];
          var chunkFilesSorted = [];
          var filesIter = tempFolder.getFiles();
          while (filesIter.hasNext()) {
            var file = filesIter.next();
            var name = file.getName();
            var match = name.match(/_chunk_(\d+)$/);
            if (match) chunkFilesSorted.push({ index: parseInt(match[1]), file: file });
          }
          chunkFilesSorted.sort((a, b) => a.index - b.index);
          for (var i = 0; i < chunkFilesSorted.length; i++) {
            var chunkFile = chunkFilesSorted[i].file;
            var bytes = chunkFile.getBlob().getBytes();
            allBytes = allBytes.concat(bytes);
            chunkFile.setTrashed(true);
          }
          var ext = p.filename.split('.').pop().toLowerCase();
          var allowedExts = ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'zip', 'doc', 'docx'];
          if (allowedExts.indexOf(ext) === -1) return createResponse("Extensi√≥n no permitida", false);
          var newName = "ARTE_" + id + "." + ext;
          var existing = folder.getFilesByName(newName);
          while (existing.hasNext()) existing.next().setTrashed(true);
          var finalBlob = Utilities.newBlob(allBytes, p.mime || metadata.mime, newName);
          var finalFile = folder.createFile(finalBlob);
          finalFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
          try { tempFolder.setTrashed(true); } catch (e) { Logger.log("‚ö†Ô∏è No se pudo eliminar carpeta temporal: " + e.toString()); }
          PROPS.deleteProperty(propsKey + "_count");
          PROPS.deleteProperty(propsKey + "_meta");
          var data = SHEET.getDataRange().getValues();
          var row = null;
          for (var i = 1; i < data.length; i++) {
            if (data[i][0] == id) {
              SHEET.getRange(i + 1, 17).setValue(finalFile.getUrl() + " (" + username + ")");
              row = data[i];
              break;
            }
          }
          if (row) {
            var unidadFormateada = sanitizeInput(row[2]);
            var msg = "üé® *" + username + " adjunt√≥ arte (chunks) a la solicitud*\nüÜî *ID:* `" + sanitizeInput(row[0]) + "`\nüè• *Unidad:* " + unidadFormateada + "\nüìÇ *Tipo de Jornada:* " + sanitizeInput(row[3]) + "\n‚è≥ *Esperando aprobaci√≥n.*";
            var token = getTelegramToken();
            var chatIds = getTelegramChatIds();
            chatIds.forEach(function(chatId) {
              try {
                UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
                  "method": "post",
                  "payload": { "chat_id": chatId, "text": msg, "parse_mode": "Markdown" },
                  "muteHttpExceptions": true
                });
              } catch (e) {}
            });
          }
          logSecurityEvent("CHUNK_FINALIZED", username, "ID: " + id);
          Logger.log("‚úÖ Archivo ensamblado: " + p.filename);
          return createResponse("Archivo ensamblado correctamente", true);
        } catch (err) {
          Logger.log("‚ùå Error finalizeChunkedUpload: " + err.toString());
          logSecurityEvent("CHUNK_FINALIZE_ERROR", p.uploadedBy, err.toString());
          try {
            var folders = DriveApp.getFoldersByName(p.id);
            if (folders.hasNext()) folders.next().setTrashed(true);
            var propsKey = "chunk_upload_" + p.id;
            PROPS.deleteProperty(propsKey + "_count");
            PROPS.deleteProperty(propsKey + "_meta");
          } catch (cleanupErr) {}
          return createResponse(err.toString(), false);
        }
      }
      if (p.action === "cancelChunkedUpload") {
        var result = cancelChunkedUpload(p.id);
        return createResponse(result.message || result.error, result.success);
      }
      if (p.action === "sendTelegramArte") {
        try {
          var id = sanitizeInput(p.id);
          var data = SHEET.getDataRange().getValues();
          var row = null;
          for (var i = 1; i < data.length; i++) {
            if (data[i][0] == id) { row = data[i]; break; }
          }
          if (!row || !row[16]) return createResponse("No hay arte final cargado", false);
          var fileIdMatch = row[16].match(/\/file\/d\/([-\w]{25,})/) || row[16].match(/[-\w]{25,}/);
          if (!fileIdMatch || !fileIdMatch[1]) return createResponse("ID de archivo no v√°lido", false);
          var fileBlob = DriveApp.getFileById(fileIdMatch[1]).getBlob();
          var unidadFormateada = sanitizeInput(row[2]);
          var msg = "üé® *ARTE FINAL LISTO*\nüè• *Unidad:* " + unidadFormateada + "\nüìÇ *Jornada:* " + sanitizeInput(row[3]) + "\nüÜî *ID:* `" + sanitizeInput(row[0]) + "`\n‚úÖ Archivo enviado en alta calidad.";
          var token = getTelegramToken();
          var chatIds = getTelegramChatIds();
          chatIds.forEach(function(chatId) {
            try {
              UrlFetchApp.fetch("https://api.telegram.org/bot" + token + "/sendDocument", {
                "method": "post",
                "payload": { "chat_id": chatId, "document": fileBlob, "caption": msg, "parse_mode": "Markdown" },
                "muteHttpExceptions": true
              });
            } catch(e) { Logger.log("Error TG: " + e.toString()); }
          });
          logSecurityEvent("TELEGRAM_ARTE_SENT", "SYSTEM", "Arte enviado para ID: " + id);
          return createResponse("Arte enviado a Telegram", true);
        } catch (e) {
          logSecurityEvent("TELEGRAM_ARTE_ERROR", "SYSTEM", e.toString());
          return createResponse(e.toString(), false);
        }
      }
      if (p.action === "sendEmailArte") {
        try {
          var id = sanitizeInput(p.id);
          var correo = sanitizeInput(p.correo);
          var username = sanitizeInput(p.username);
          
          // Validar formato de correo
          if (!correo || !correo.includes("@") || !correo.includes(".")) {
            return createResponse("Correo electr√≥nico no v√°lido", false);
          }
          
          var data = SHEET.getDataRange().getValues();
          var row = null;
          var rowIndex = -1;
          for (var i = 1; i < data.length; i++) {
            if (data[i][0] == id) { 
              row = data[i]; 
              rowIndex = i; // ‚úÖ Guardar el √≠ndice de la fila
              break; 
            }
          }
          
          if (!row || !row[16]) return createResponse("No hay arte final cargado", false);
          
          var fileIdMatch = row[16].match(/\/file\/d\/([-\w]{25,})/) || row[16].match(/[-\w]{25,}/);
          if (!fileIdMatch || !fileIdMatch[1]) return createResponse("ID de archivo no v√°lido", false);
          
          // ‚úÖ Marcar el correo con asterisco ANTES de enviar (para asegurar que se guarde)
          var currentCorreo = row[11] || ""; // ‚úÖ Columna L (√≠ndice 11) es el correo
          Logger.log("üîç DEBUG: Correo actual = " + currentCorreo);
          Logger.log("üîç DEBUG: rowIndex = " + rowIndex);
          
          if (currentCorreo && !currentCorreo.includes("*")) {
            Logger.log("‚úÖ DEBUG: Guardando asterisco en la celda...");
            SHEET.getRange(rowIndex + 1, 12).setValue(currentCorreo + " (*)"); // ‚úÖ Columna 12 = L
            Logger.log("‚úÖ DEBUG: Asterisco guardado exitosamente");
          } else {
            Logger.log("‚ö†Ô∏è DEBUG: El correo ya tiene asterisco o est√° vac√≠o");
          }
          
          // Obtener archivo de Drive
          var file = DriveApp.getFileById(fileIdMatch[1]);
          var fileBlob = file.getBlob();
          var fileName = file.getName();
          
          // Preparar contenido del correo
          var unidadFormateada = sanitizeInput(row[2]);
          var jornadaFormateada = sanitizeInput(row[3]);
          var fechaFormateada = formatearFecha(row[7], 'date'); // ‚úÖ Columna 8 (√≠ndice 7) - Fecha del evento
          var horaFormateada = sanitizeInput(row[8]); // ‚úÖ Columna 9 (√≠ndice 8) - Hora del evento
          
          var subject = "SIRA 3.0 - Arte Final - Solicitud " + sanitizeInput(row[0]) + " - " + unidadFormateada;
          
          var htmlBody = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">' +
            '<div style="text-align: center; margin-bottom: 30px;">' +
            '<h1 style="color: #2d6a4f; margin: 0; font-size: 28px;">üé® SIRA 3.0</h1>' +
            '<h2 style="color: #1b5e3f; margin: 5px 0 0 0; font-size: 18px;">Sistema Integral de Requerimientos de Artes</h2>' +
            '<p style="color: #666; font-style: italic; margin: 10px 0 0 0; font-size: 14px;">"Solicita, Visualiza e Impacta"</p>' +
            '</div>' +
            '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">' +
            '<h3 style="color: #2d6a4f; margin-top: 0; border-bottom: 2px solid #2d6a4f; padding-bottom: 10px;">‚úÖ Arte Final Adjunto</h3>' +
            '<p style="margin: 10px 0; font-size: 16px;"><strong>Hola, ' + unidadFormateada + '</strong></p>' +
            '<p style="margin: 10px 0; color: #555;">Su solicitud ha sido procesada y el arte final est√° listo para su uso.</p>' +
            '<p style="margin: 15px 0; color: #2d6a4f; font-weight: 500; font-size: 18px;">üôè <strong>¬°Gracias por utilizar nuestro sistema SIRA 3.0!</strong></p>' +
            '</div>' +
            '<div style="margin-bottom: 20px;">' +
            '<table style="width: 100%; border-collapse: collapse;">' +
            '<tr><td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold; color: #2d6a4f; width: 140px;">üÜî ID Solicitud:</td><td style="padding: 8px; border-bottom: 1px solid #ddd;">' + sanitizeInput(row[0]) + '</td></tr>' +
            '<tr><td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold; color: #2d6a4f;">üìÇ Solicitud:</td><td style="padding: 8px; border-bottom: 1px solid #ddd;">' + jornadaFormateada + '</td></tr>' +
            '<tr><td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold; color: #2d6a4f;">üìÖ Fecha del Evento:</td><td style="padding: 8px; border-bottom: 1px solid #ddd;">' + fechaFormateada + (horaFormateada ? ' | ' + horaFormateada : '') + '</td></tr>' +
            '</table>' +
            '</div>' +
            '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2d6a4f;">' +
            '<p style="margin: 0; color: #2d6a4f; font-weight: bold;">üìé Archivo adjunto: ' + fileName + '</p>' +
            '<p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">El archivo est√° listo para ser utilizado en sus materiales de comunicaci√≥n.</p>' +
            '</div>' +
            '<div style="background: linear-gradient(135deg, #2d6a4f 0%, #1b5e3f 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">' +
            '<h4 style="margin: 0 0 10px 0; font-size: 18px;">üåü ¬øNecesita m√°s dise√±os?</h4>' +
            '<p style="margin: 0; font-size: 14px; line-height: 1.5;">Estamos aqu√≠ para ayudarle a seguir impactando. No dude en realizar nuevas solicitudes a trav√©s de SIRA 3.0.</p>' +
            '</div>' +
            '<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">' +
            '<p style="margin: 0; color: #666; font-size: 12px;">Este correo fue generado autom√°ticamente por SIRA 3.0</p>' +
            '<p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Fecha de env√≠o: ' + Utilities.formatDate(new Date(), "GMT-4", "dd/MM/yyyy HH:mm") + '</p>' +
            '<p style="margin: 10px 0 0 0; color: #2d6a4f; font-weight: bold; font-size: 13px;">üé® SIRA 3.0 - Solicita, Visualiza e Impacta</p>' +
            '</div>' +
            '</div>';
          
          // Enviar correo con archivo adjunto
          MailApp.sendEmail({
            to: validateEmail(correo),
            subject: subject,
            htmlBody: htmlBody,
            attachments: [fileBlob.setName(fileName)]
          });
          
          // Enviar notificaci√≥n por Telegram
          Logger.log(" DEBUG: Iniciando env√≠o de notificaci√≥n Telegram...");
          var msg = "üìß ARTE ENVIADO POR CORREO\n" +
                  "üë§ Enviado por: " + username + "\n" +
                  "üÜî ID Solicitud: " + sanitizeInput(row[0]) + "\n" +
                  "üè• Unidad: " + unidadFormateada + "\n" +
                  "üìÇ Jornada: " + jornadaFormateada + "\n" +
                  "üìß Correo: " + correo + "\n" +
                  "üìé Archivo: " + fileName + "\n" +
                  "‚úÖ Arte enviado correctamente.";
          
          Logger.log(" DEBUG: Mensaje Telegram preparado");
          
          // 
          var token = getTelegramToken();
          var chatIds = getTelegramChatIds();
          
          Logger.log("üîç DEBUG: Token obtenido = " + (token ? "S√ç" : "NO"));
          Logger.log("üîç DEBUG: Chat IDs encontrados = " + chatIds.length);
          
          chatIds.forEach(function(chatId, index) {
            try {
              Logger.log("üîç DEBUG: Enviando a chat ID #" + (index + 1) + ": " + chatId);
              
              var payload = {
                chat_id: chatId,
                text: msg
                // parse_mode removed - works with plain text + HTML entities
              };
              
              var options = {
                method: "post",
                payload: payload,
                muteHttpExceptions: true
              };
              
              var response = UrlFetchApp.fetch(
                "https://api.telegram.org/bot" + token + "/sendMessage", 
                options
              );
              
              var responseCode = response.getResponseCode();
              Logger.log("üîç DEBUG: Respuesta Telegram #" + (index + 1) + " - C√≥digo: " + responseCode);
              
              if (responseCode === 200) {
                Logger.log("‚úÖ DEBUG: Notificaci√≥n Telegram #" + (index + 1) + " enviada exitosamente");
              } else {
                Logger.log("‚ùå DEBUG: Error en notificaci√≥n Telegram #" + (index + 1) + " - C√≥digo: " + responseCode);
              }
              
            } catch(e) { 
              Logger.log("‚ùå DEBUG: Error en Telegram #" + (index + 1) + ": " + e.toString()); 
            }
          });
          
          Logger.log("üîç DEBUG: Env√≠o de notificaciones Telegram completado");
          
          // Registrar el env√≠o
          logEmailSend(1, "SYSTEM");
          logSecurityEvent("EMAIL_ARTE_SENT", username, "Arte enviado por correo para ID: " + id + " - Correo: " + correo);
          
          return createResponse("Arte enviado por correo exitosamente", true);
        } catch (e) {
          logSecurityEvent("EMAIL_ARTE_ERROR", "SYSTEM", e.toString());
          return createResponse("Error al enviar correo: " + e.toString(), false);
        }
      }
      if (p.action === "assignDesigner") {
        try {
          var username = sanitizeInput(p.username);
          var password = p.password;
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          requireAdmin(username, password);
          var id = sanitizeInput(p.id);
          var designer = sanitizeInput(p.disenador);
          var allowedDesigners = ["Bermina", "Jorsy", "Mar√≠a F.", "Xamir", "Fulan@"];
          // ‚úÖ Permitir desasignar si el dise√±ador est√° vac√≠o
          if (designer && allowedDesigners.indexOf(designer) === -1) {
            logSecurityEvent("INVALID_DESIGNER", username, "Intento de asignar: " + designer);
            return createResponse("Dise√±ador no v√°lido", false);
          }
          var data = SHEET.getDataRange().getValues();
          for (var i = 1; i < data.length; i++) {
            if (data[i][0] == id) {
              if (designer) {
                // ‚úÖ ASIGNAR: OBTENER FECHA DEL SERVIDOR (GMT-4 CARACAS)
                var now = Utilities.formatDate(new Date(), "GMT-4", "dd/MM/yyyy HH:mm");
                // Guardar como: "Nombre|Fecha"
                SHEET.getRange(i + 1, 16).setValue(designer + "|" + now);
                logSecurityEvent("DESIGNER_ASSIGNED", username, "ID: " + id + " -> " + designer + " (" + now + ")");
              } else {
                // ‚úÖ DESASIGNAR: Limpiar la celda completamente
                SHEET.getRange(i + 1, 16).setValue("");
                logSecurityEvent("DESIGNER_UNASSIGNED", username, "ID: " + id);
              }
              
              // ‚úÖ INVALIDAR CACH√â DE STATS
              invalidateStatsCache();
              
              var message = designer ? "Dise√±ador asignado correctamente" : "Dise√±ador desasignado correctamente";
              return createResponse(message, true);
            }
          }
          return createResponse("ID no encontrado", false);
        } catch (err) {
          logSecurityEvent("ASSIGN_DESIGNER_ERROR", p.username, err.message);
          return createResponse(err.message, false);
        }
      }
      if (p.action === "setMaintenance") {
        try {
          var username = sanitizeInput(p.username);
          var password = p.password;
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          requireAdmin(username, password);
          PROPS.setProperty("maintMode", sanitizeInput(p.status));
          logSecurityEvent("MAINTENANCE_TOGGLED", username, "Status: " + p.status);
          return createResponse("Modo mantenimiento actualizado", true);
        } catch (err) {
          logSecurityEvent("MAINTENANCE_ERROR", p.username, err.message);
          return createResponse(err.message, false);
        }
      }
      if (p.action === "updateStatus") {
        try {
          var username = sanitizeInput(p.username);
          var password = p.password;
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          requireAdmin(username, password);
          var id = sanitizeInput(p.id);
          var status = sanitizeInput(p.status);
          var designer = sanitizeInput(p.disenador);
          var allowedStatus = ["PENDIENTE", "PROCESANDO", "FINALIZADA"];
          var allowedDesigners = ["Bermina", "Jorsy", "Mar√≠a F.", "Xamir", "Fulan@"];
          if (allowedStatus.indexOf(status) === -1) return createResponse("Estatus inv√°lido", false);
          
          var data = SHEET.getDataRange().getValues();
          for (var i = 1; i < data.length; i++) {
            if (data[i][0] == id) {
              // ‚úÖ SOLO ACTUALIZAR EL ESTADO, NO TOCAR EL DISE√ëADOR
              SHEET.getRange(i + 1, 15).setValue(status);
              
              // ‚úÖ SI ES FINALIZADA, VERIFICAR QUE HAYA DISE√ëADOR (la fecha ya est√° guardada)
              if (status === "FINALIZADA") {
                var currentDesignerCell = SHEET.getRange(i + 1, 16).getValue() || "";
                var currentDesigner = currentDesignerCell.split("|")[0].trim();
                
                if (!currentDesigner || allowedDesigners.indexOf(currentDesigner) === -1) {
                  // No hay dise√±ador v√°lido, no permitir finalizar
                  return createResponse("No se puede finalizar: debe asignar un dise√±ador primero", false);
                }
                // La fecha ya est√° guardada desde assignDesigner, no hacer nada m√°s
                logSecurityEvent("STATUS_FINALIZED", username, "ID: " + id + " -> FINALIZADA (Dise√±ador: " + currentDesigner + ")");
              } else {
                logSecurityEvent("STATUS_UPDATED", username, "ID: " + id + " -> " + status);
              }
              
              invalidateStatsCache();
              return createResponse("Estatus actualizado correctamente", true);
            }
          }
        } catch (err) {
          logSecurityEvent("UPDATE_STATUS_ERROR", p.username, err.message);
          return createResponse(err.message, false);
        }
      }
      if (p.action === "delete") {
        try {
          var username = sanitizeInput(p.username);
          var password = p.password;
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          requireAdmin(username, password);
          var id = sanitizeInput(p.id);
          var data = SHEET.getDataRange().getValues();
          for (var i = 1; i < data.length; i++) {
            if (data[i][0] == id) {
              var arteUrl = data[i][16];
              if (arteUrl && arteUrl.trim() !== "") {
                var fileIdMatch = arteUrl.match(/\/file\/d\/([-\w]{25,})/) || arteUrl.match(/[-\w]{25,}/);
                if (fileIdMatch && fileIdMatch[1]) {
                  try {
                    DriveApp.getFileById(fileIdMatch[1]).setTrashed(true);
                    Logger.log("‚úÖ Archivo Drive eliminado: " + fileIdMatch[1]);
                  } catch (e) { Logger.log("‚ùå Error eliminando archivo Drive: " + e.toString()); }
                }
              }
              SHEET.deleteRow(i + 1);
              logSecurityEvent("REQUEST_DELETED", username, "ID: " + id);
              
              // ‚úÖ INVALIDAR CACH√â DE STATS
              invalidateStatsCache();
              
              return createResponse("Solicitud y arte eliminados correctamente", true);
            }
          }
          return createResponse("ID no encontrado", false);
        } catch (err) {
          logSecurityEvent("DELETE_ERROR", p.username, err.message);
          return createResponse(err.message, false);
        }
      }
      if (p.action === "deleteFinalizadas") {
        try {
          var username = sanitizeInput(p.username);
          var password = p.password;
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          requireAdmin(username, password);
          
          var today = new Date();
          
          // ‚úÖ CORRECCI√ìN: Calcular correctamente el corte - todas las solicitudes anteriores al mes actual
          var firstDayOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0, 0);
          
          Logger.log("üóëÔ∏è Eliminando finalizadas con fecha anterior a: " + Utilities.formatDate(firstDayOfCurrentMonth, "GMT-4", "dd/MM/yyyy"));
          
          var data = SHEET.getDataRange().getValues();
          var deletedCount = 0;
          var rowsToDelete = [];
          var deletedIds = [];
          var deletedDates = []; // Para capturar fechas exactas eliminadas
          
          for (var i = data.length - 1; i > 0; i--) { // ‚úÖ Recorrer de abajo hacia arriba para no afectar √≠ndices
            var row = data[i];
            var fechaRegistro = row[1]; // Columna B (Timestamp)
            var estado = row[14]; // Columna O (Estado)
            
            // ‚úÖ Solo procesar si est√° FINALIZADA
            if (estado !== "FINALIZADA") continue;
            
            // ‚úÖ Parsear la fecha de registro
            var fechaObj = null;
            
            if (fechaRegistro instanceof Date) {
              fechaObj = fechaRegistro;
            } else if (fechaRegistro && typeof fechaRegistro === 'string') {
              // Intentar parsear formato dd/MM/yyyy HH:mm
              var parts = fechaRegistro.split(' ')[0].split('/');
              if (parts.length === 3) {
                var dia = parseInt(parts[0], 10);
                var mes = parseInt(parts[1], 10) - 1;
                var anio = parseInt(parts[2], 10);
                fechaObj = new Date(anio, mes, dia);
              }
            }
            
            if (!fechaObj) {
              Logger.log("‚ö†Ô∏è No se pudo parsear fecha para fila " + (i+1) + ": " + fechaRegistro);
              continue;
            }
            
            // ‚úÖ CORRECCI√ìN: Verificar si la fecha es anterior al mes actual
            // Debe ser < primer d√≠a del mes actual
            var isBeforeCurrentMonth = (fechaObj < firstDayOfCurrentMonth);
            
            if (isBeforeCurrentMonth) {
              rowsToDelete.push(i + 1); // +1 porque Sheets es 1-based
              
              // Eliminar archivo de Drive si existe
              var arteUrl = row[16];
              if (arteUrl && arteUrl.trim() !== "") {
                var fileIdMatch = arteUrl.match(/\/file\/d\/([-\w]{25,})/) || arteUrl.match(/[-\w]{25,}/);
                if (fileIdMatch && fileIdMatch[1]) {
                  try {
                    DriveApp.getFileById(fileIdMatch[1]).setTrashed(true);
                    Logger.log("‚úÖ Archivo Drive eliminado: " + fileIdMatch[1]);
                  } catch (e) { 
                    Logger.log("‚ùå Error eliminando archivo Drive: " + e.toString()); 
                  }
                }
              }
              
              deletedIds.push(row[0]);
              deletedDates.push(fechaObj); // Capturar fecha exacta eliminada
              deletedCount++;
              Logger.log("üóëÔ∏è Marcada para eliminar: ID " + row[0] + " - Fecha: " + fechaObj);
            }
          }
          
          // ‚úÖ Eliminar filas de abajo hacia arriba para mantener √≠ndices v√°lidos
          rowsToDelete.sort(function(a, b) { return b - a; }); // Orden descendente
          
          for (var j = 0; j < rowsToDelete.length; j++) {
            try {
              SHEET.deleteRow(rowsToDelete[j]);
              Logger.log("‚úÖ Fila " + rowsToDelete[j] + " eliminada");
            } catch (e) {
              Logger.log("‚ùå Error eliminando fila " + rowsToDelete[j] + ": " + e.toString());
            }
          }
          
          // Nombres de meses en espa√±ol
          var mesesEnEspanol = ["enero", "febrero", "marzo", "abril", "mayo", "junio", 
                                "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
          var nombreMesActual = mesesEnEspanol[firstDayOfCurrentMonth.getMonth()];
          
          if (deletedCount > 0) {
            Logger.log("‚úÖ Eliminadas " + deletedCount + " solicitudes finalizadas del mes anterior");
            logSecurityEvent("BULK_DELETE", username, deletedCount + " solicitudes eliminadas con fecha anterior a " + Utilities.formatDate(firstDayOfCurrentMonth, "GMT-4", "MM/yyyy"));
            
            // Ordenar fechas para encontrar la m√°s antigua y m√°s reciente
            deletedDates.sort(function(a, b) { return a - b; });
            var fechaMasAntigua = deletedDates[0];
            var fechaMasReciente = deletedDates[deletedDates.length - 1];
          } else {
            Logger.log("‚ÑπÔ∏è No se encontraron solicitudes finalizadas del mes anterior para eliminar");
          }
          
          return createResponse({ 
            success: true, 
            message: "Se eliminaron " + deletedCount + " solicitudes correctamente.", 
            count: deletedCount, 
            periodo: "Todos los meses anteriores a " + nombreMesActual + " " + firstDayOfCurrentMonth.getFullYear(),
            rango: deletedCount > 0 ? {
              desde: Utilities.formatDate(fechaMasReciente, "GMT-4", "dd/MM/yyyy"),
              hasta: Utilities.formatDate(fechaMasAntigua, "GMT-4", "dd/MM/yyyy")
            } : {
              desde: "Sin solicitudes",
              hasta: "Sin solicitudes"
            }
          }, true);
          
        } catch (err) {
          Logger.log("‚ùå Error en deleteFinalizadas: " + err.toString());
          logSecurityEvent("BULK_DELETE_ERROR", p.username, err.message);
          return createResponse(err.message, false);
        }
      }
      if (p.action === "getAdvancedStats") {
        try {
          var username = sanitizeInput(p.username);
          var password = p.password;
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          var validation = validateAdminCredentials(username, password);
          if (!validation.isValid) return createResponse("Acceso denegado", false);
          var period = sanitizeInput(p.period || "month");
          
          // ‚úÖ CORRECCI√ìN: Obtener resultado y extraer .data
          var result = getAdvancedStats(period);
          
          if (result.success) {
            // Enviamos SOLO result.data, no todo el objeto result
            return createResponse(result.data, true);
          } else {
            return createResponse(result.error || "Error interno", false);
          }
        } catch (err) {
          return createResponse(err.toString(), false);
        }
      }

      if (p.action === "getRequestsHistory") {
        try {
          var username = sanitizeInput(p.username);
          var password = p.password;
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          var validation = validateAdminCredentials(username, password);
          if (!validation.isValid) return createResponse("Acceso denegado", false);
          var period = sanitizeInput(p.period || "month");
          
          // ‚úÖ CORRECCI√ìN: Obtener resultado y extraer .data
          var result = getRequestsHistory(period);
          
          if (result.success) {
            return createResponse(result.data, true);
          } else {
            return createResponse(result.error || "Error interno", false);
          }
        } catch (err) {
          return createResponse(err.toString(), false);
        }
      }

      if (p.action === "getDesignerPerformance") {
        try {
          var username = sanitizeInput(p.username);
          var password = p.password;
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          var validation = validateAdminCredentials(username, password);
          if (!validation.isValid) return createResponse("Acceso denegado", false);
          var period = sanitizeInput(p.period || "month");
          var result = getDesignerPerformance(period);
          if (result.success) {
            return createResponse(result.data, true);
          } else {
            return createResponse(result.error || "Error interno", false);
          }
        } catch (err) {
          return createResponse(err.toString(), false);
        }
      }

      if (p.action === "saveConnectionSpeed") {
        try {
          var speed = parseFloat(p.speed) || 0;
          return createResponse(saveConnectionSpeed(speed), true);
        } catch (err) {
          return createResponse(err.toString(), false);
        }
      }
      
      // ‚úÖ HANDLER PARA SPEED TEST DE INTERNET
      if (p.action === "speedTest") {
        // ‚úÖ REGISTRAR LLAMADA
        logUrlFetchCall("SPEED_TEST", "speedTest");
        
        // Simplemente recibir y confirmar ‚Äî no guardar nada
        const size = parseInt(p.size || "0");
        
        return createResponse({ 
          success: true, 
          received: true,
          bytesReceived: size,
          timestamp: Date.now()
        }, true);
      }

      // ‚úÖ HANDLER PARA CHUNK SPEED TEST
      if (p.action === "chunkSpeedTest") {
        // Simular recepci√≥n de chunk sin guardar
        return createResponse({ 
          success: true, 
          timestamp: Date.now(),
          received: true 
        }, true);
      }
      
      // ‚úÖ HANDLER PARA OBTENER DATOS DE UNA SOLICITUD ESPEC√çFICA
      if (p.action === "getRequestData") {
        try {
          var username = sanitizeInput(p.username);
          var password = sanitizeInput(p.password);
          if (isRateLimited(username)) return createResponse("Cuenta bloqueada temporalmente", false);
          requireAdmin(username, password);
          
          var id = sanitizeInput(p.id);
          var data = SHEET.getDataRange().getValues(); // ‚úÖ Leer todas las columnas para asegurar que incluya la 11 (correo)
          
          for (var i = 1; i < data.length; i++) {
            if (data[i][0] == id) {
              var rowData = data[i];
              var responseData = {
                id: sanitizeInput(rowData[0]),
                Timestamp: formatearFecha(rowData[1], 'datetime'),
                Unidad: sanitizeInput(rowData[2]),
                Jornada: sanitizeInput(rowData[3]),
                Fecha: formatearFecha(rowData[7], 'datetime'),
                Hora: sanitizeInput(rowData[8]),
                Correo: sanitizeInput(rowData[11] || ""), // ‚úÖ Columna 12 (M) - Correo del usuario (√≠ndice 11 en array)
                Soportes: sanitizeInput(rowData[13]),
                Estatus: sanitizeInput(rowData[14]),
                Disenador: sanitizeInput((rowData[15] || "").split("|")[0].trim()), // ‚úÖ Extraer solo el nombre
                ArteFinal: sanitizeInput(rowData[16] || "")
              };
              return createResponse(responseData, true);
            }
          }
          return createResponse("Solicitud no encontrada", false);
        } catch (err) {
          logSecurityEvent("GET_REQUEST_ERROR", p.username, err.message);
          return createResponse(err.message, false);
        }
      }
      
      var idSolicitud = "REQ-" + Date.now();
      var ahora = new Date();
      var fechaRegistro = Utilities.formatDate(ahora, "GMT-4", "d/M/yyyy h:mm a");
      if (!validarFecha(p.Fecha)) return createResponse("Fecha inv√°lida", false);
      var dateParts = p.Fecha.split("-");
      var fechaLimpia = parseInt(dateParts[2], 10) + "/" + parseInt(dateParts[1], 10) + "/" + dateParts[0];
      var blobs = [];
      for (var i = 1; i <= 3; i++) {
        var key = "foto" + i;
        if (p[key]) {
          try {
            var cleanBase64 = normalizeBase64(p[key]);
            var decodedBytes = Utilities.base64Decode(cleanBase64);
            if (decodedBytes.length > 2 * 1024 * 1024) {
              logSecurityEvent("PHOTO_TOO_LARGE", "SYSTEM", "Foto " + i + " excede 2MB");
              continue;
            }
            var mimeType = "image/jpeg";
            var extension = "jpg";
            if (decodedBytes.length >= 4) {
              var header = "";
              for (var j = 0; j < Math.min(4, decodedBytes.length); j++) {
                header += String.fromCharCode(decodedBytes[j]);
              }
              if (header.indexOf("PNG") !== -1) { mimeType = "image/png"; extension = "png"; }
              else if (header.indexOf("GIF") !== -1) { mimeType = "image/gif"; extension = "gif"; }
              else if (header.indexOf("BM") !== -1) { mimeType = "image/bmp"; extension = "bmp"; }
            }
            if (!validateMimeType(mimeType)) {
              logSecurityEvent("INVALID_PHOTO_MIME", "SYSTEM", "Foto " + i + " MIME inv√°lido");
              continue;
            }
            var fileName = "Soporte_" + i + "." + extension;
            var blob = Utilities.newBlob(decodedBytes, mimeType, fileName);
            blob.setName(fileName);
            blobs.push(blob);
            Logger.log("‚úÖ Foto " + i + " procesada: " + fileName);
          } catch (e) { Logger.log("‚ùå Error procesando foto " + i + ": " + e.toString()); }
        }
      }
      var detalleBullets = toBullets(p.Opciones || "");
      var serviciosBullets = toBullets(p.Servicios || "");
      SHEET.appendRow([
        idSolicitud, fechaRegistro, sanitizeInput(p.Unidad), sanitizeInput(p.Jornada),
        (p.Jornada === "Otros") ? sanitizeInput(p.Opciones) : "",
        (p.Jornada !== "Otros") ? detalleBullets : "", serviciosBullets, fechaLimpia,
        sanitizeInput(p.Hora), sanitizeInput(p.Direccion || ""), sanitizeInput(p.Telefono || ""),
        validateEmail(p.Correo) || "", sanitizeInput(p.Observaciones || ""),
        blobs.length > 0 ? "S√ç (" + blobs.length + ")" : "NO", "PENDIENTE", "", "",
        sanitizeInput(p.Dispositivo) || "No detectado"  // ‚úÖ R - Dispositivo (NUEVO)
      ]);
      enviarEmail(p, idSolicitud, blobs, detalleBullets, serviciosBullets, fechaLimpia);
      enviarTelegram(sanitizeInput(p.Unidad), sanitizeInput(p.Jornada), idSolicitud, fechaLimpia, sanitizeInput(p.Hora), blobs.length);
      logSecurityEvent("REQUEST_CREATED", "SYSTEM", "Nueva solicitud: " + idSolicitud);
      
      // ‚úÖ INVALIDAR CACH√â DE STATS
      invalidateStatsCache();
      
      return createResponse({ id: idSolicitud }, true);
    } catch (err) {
      Logger.log("Error general en doPost: " + err.toString());
    }
  }

  // ============================================================
  // REPORTE MENSUAL (COMPLETO CON HTML)
  // ============================================================

  function generateMonthlyReport() {
  try {
    logSecurityEvent("REPORT_GENERATED", "SYSTEM", "Reporte mensual iniciado");
    var data = SHEET.getDataRange().getDisplayValues();
    var today = new Date();
    
    // ‚úÖ CORRECCI√ìN: El reporte debe incluir TODAS las solicitudes hasta el 1er d√≠a del mes
    // Esto incluye: mes anterior, meses anteriores, todo el hist√≥rico hasta el corte
    var firstDayOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0, 0);
    
    // El per√≠odo del reporte es: desde el inicio de los tiempos (o primera solicitud) hasta el √∫ltimo d√≠a del mes anterior
    var reportMonthEnd = new Date(firstDayOfCurrentMonth.getTime() - 1); // 23:59:59 del √∫ltimo d√≠a del mes anterior
    var reportMonthStart = new Date(2000, 0, 1); // ‚úÖ Fecha muy atr√°s para incluir TODO el hist√≥rico
    
    // Para el label, usamos el mes anterior al actual
    var monthName = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    var targetMonth = reportMonthEnd.getMonth();
    var targetYear = reportMonthEnd.getFullYear();
    var monthLabel = monthName[targetMonth] + " " + targetYear;
    
    Logger.log("üìä Reporte mensual: Incluyendo solicitudes desde " + reportMonthStart + " hasta " + reportMonthEnd);
    Logger.log("üìä Label del reporte: " + monthLabel);
      var stats = { total: 0, pendiente: 0, procesando: 0, finalizada: 0, conFotos: 0, totalFotos: 0, obituarios: 0 };
      var unidadesCount = {};
      var jornadasCount = {};
      var diasCount = {};
      var especialidadesCount = {};
      var serviciosCount = {};
      var disenadoresCount = {};
      var dispositivosCount = {};
      for (var i = 1; i < data.length; i++) {
        var row = data[i];
        if (!row[0]) continue;
        var timestampStr = row[1];
        var fechaRegistro = null;
        // ‚úÖ CORRECCI√ìN: Mejorar el parseo de fechas para manejar m√∫ltiples formatos
        if (timestampStr && timestampStr.toString().trim() !== "") {
          var fechaSolo = timestampStr.split(' ')[0];
          if (fechaSolo.includes('/')) {
            var parts = fechaSolo.split('/');
            if (parts.length === 3) {
              var dia = parseInt(parts[0], 10);
              var mes = parseInt(parts[1], 10) - 1; // ‚úÖ Mes 0-indexed
              var anio = parseInt(parts[2], 10);
              
              // ‚úÖ Validar que la fecha sea v√°lida antes de crear el objeto
              if (!isNaN(dia) && !isNaN(mes) && !isNaN(anio) && mes >= 0 && mes <= 11) {
                fechaRegistro = new Date(anio, mes, dia);
              }
            }
          }
        }
        
        // ‚úÖ CORRECCI√ìN: Si no se pudo parsear la fecha, intentar con el m√©todo robusto
        if (!fechaRegistro && timestampStr) {
          fechaRegistro = parseFechaRobusto(timestampStr);
        }
        
        // ‚úÖ CORRECCI√ìN: Incluir TODAS las solicitudes hasta el fin del mes anterior
        // Si no hay fecha v√°lida, incluirla de todas formas (no excluir datos)
        if (fechaRegistro && fechaRegistro > reportMonthEnd) {
          Logger.log("‚è≠Ô∏è Solicitud " + row[0] + " excluida (fecha " + fechaRegistro + " > " + reportMonthEnd + ")");
          continue; // Solo excluir si es del mes actual o futuro
        }
        stats.total++;
        var estatus = (row[14] || "").toUpperCase().trim();
        if (estatus === "PENDIENTE") stats.pendiente++;
        else if (estatus === "PROCESANDO") stats.procesando++;
        else if (estatus === "FINALIZADA") stats.finalizada++;
        var soportes = row[13] || "";
        if (soportes.includes("S√ç")) {
          stats.conFotos++;
          var match = soportes.match(/\d+/);
          if (match) stats.totalFotos += parseInt(match[0]);
        }
        var jornada = row[3] || "";
        if (jornada.toLowerCase().includes("obituario")) stats.obituarios++;
        var unidad = sanitizeInput(row[2] || "Sin unidad");
        unidadesCount[unidad] = (unidadesCount[unidad] || 0) + 1;
        jornadasCount[sanitizeInput(jornada)] = (jornadasCount[jornada] || 0) + 1;
        var diaSemana = fechaRegistro.getDay();
        var diasSemana = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        diasCount[diasSemana[diaSemana]] = (diasCount[diasSemana[diaSemana]] || 0) + 1;
        var especialidadesRaw = row[5] || row[4] || "";
        if (especialidadesRaw && especialidadesRaw !== "---" && especialidadesRaw !== "Ninguno") {
          var especialidades = especialidadesRaw.split("\n").filter(e => e.trim() !== "");
          especialidades.forEach(function(esp) {
            var cleanEsp = esp.replace(/^‚Ä¢\s*/, "").trim();
            if (cleanEsp) especialidadesCount[cleanEsp] = (especialidadesCount[cleanEsp] || 0) + 1;
          });
        }
        var serviciosRaw = row[6] || "";
        if (serviciosRaw && serviciosRaw !== "---" && serviciosRaw !== "Ninguno") {
          var servicios = serviciosRaw.split("\n").filter(s => s.trim() !== "");
          servicios.forEach(function(serv) {
            var cleanServ = serv.replace(/^‚Ä¢\s*/, "").trim();
            if (cleanServ) serviciosCount[cleanServ] = (serviciosCount[cleanServ] || 0) + 1;
          });
        }
        // Contar dise√±adores (solo para solicitudes finalizadas)
        if (estatus === "FINALIZADA") {
          var disenador = sanitizeInput(row[15] || "Sin asignar");
          disenadoresCount[disenador] = (disenadoresCount[disenador] || 0) + 1;
        }
        // Contar dispositivos
        var dispositivo = sanitizeInput(row[17] || "No detectado");
        dispositivosCount[dispositivo] = (dispositivosCount[dispositivo] || 0) + 1;
      }
      function getTopN(obj, n) {
        return Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, n).map(([key, value]) => ({ name: sanitizeInput(key), count: value }));
      }
      var topUnidades = getTopN(unidadesCount, 5);
      var topJornadas = getTopN(jornadasCount, 10);
      var topDias = getTopN(diasCount, 7);
      var topEspecialidades = getTopN(especialidadesCount, 10);
      var topServicios = getTopN(serviciosCount, 10);
      var topDisenadores = getTopN(disenadoresCount, 10);
      var topDispositivos = getTopN(dispositivosCount, 5);
      var htmlReport = '<div style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #ffffff; color: #333333; line-height: 1.5;">' +
        '<div style="background: #023047; padding: 20px; text-align: center; color: white;">' +
        '<h1 style="margin: 0; font-size: 24px; font-weight: 700;">üìä REPORTE MENSUAL SIRA 3.0 Reborn</h1>' +
        '<p style="margin: 8px 0 0 0; font-size: 16px; opacity: 0.9;">' + monthLabel + '</p>' +
        '</div>' +
        '<div style="padding: 25px;">' +
        '<div style="background: #f8f9fa; border-left: 4px solid #023047; padding: 15px; margin-bottom: 25px; border-radius: 0 4px 4px 0;">' +
        '<h2 style="margin: 0 0 15px 0; color: #023047; font-size: 18px; font-weight: 700; border-bottom: 1px solid #e9ecef; padding-bottom: 8px;">üìà Estad√≠sticas Generales</h2>' +
        '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">' +
        '<div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 6px;"><div style="font-size: 28px; font-weight: 800; color: #023047; margin-bottom: 5px;">' + stats.total + '</div><div style="font-size: 12px; color: #555; font-weight: 600;">TOTAL</div></div>' +
        '<div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 6px;"><div style="font-size: 28px; font-weight: 800; color: #fb8500; margin-bottom: 5px;">' + stats.pendiente + '</div><div style="font-size: 12px; color: #555; font-weight: 600;">PENDIENTES</div></div>' +
        '<div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 6px;"><div style="font-size: 28px; font-weight: 800; color: #2d6a4f; margin-bottom: 5px;">' + stats.finalizada + '</div><div style="font-size: 12px; color: #555; font-weight: 600;">FINALIZADAS</div></div>' +
        '<div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 6px;"><div style="font-size: 28px; font-weight: 800; color: #6a1b9a; margin-bottom: 5px;">' + stats.totalFotos + '</div><div style="font-size: 12px; color: #555; font-weight: 600;">FOTOS</div></div>' +
        '<div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 6px;"><div style="font-size: 28px; font-weight: 800; color: #c62828; margin-bottom: 5px;">' + stats.obituarios + '</div><div style="font-size: 12px; color: #555; font-weight: 600;">OBITUARIOS</div></div>' +
        '</div></div>' +
        
        // Top Unidades
        '<div style="background: #f8f9fa; border-left: 4px solid #219ebc; padding: 15px; margin-bottom: 25px; border-radius: 0 4px 4px 0;">' +
        '<h3 style="margin: 0 0 15px 0; color: #219ebc; font-size: 16px; font-weight: 700;">üè• Top 5 Unidades</h3>' +
        '<table style="width: 100%; border-collapse: collapse;">';
      
      topUnidades.forEach(function(item, index) {
        htmlReport += '<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">' + (index + 1) + '. ' + item.name + '</td><td style="padding: 5px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">' + item.count + '</td></tr>';
      });
      
      htmlReport += '</table></div>' +
        
        // Top 5 Solicitudes (datos de jornadas)
        '<div style="background: #f8f9fa; border-left: 4px solid #fb8500; padding: 15px; margin-bottom: 25px; border-radius: 0 4px 4px 0;">' +
        '<h3 style="margin: 0 0 15px 0; color: #fb8500; font-size: 16px; font-weight: 700;">üìã Top 5 Solicitudes</h3>' +
        '<table style="width: 100%; border-collapse: collapse;">';
      
      topJornadas.slice(0, 5).forEach(function(item, index) {
        htmlReport += '<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">' + (index + 1) + '. ' + item.name + '</td><td style="padding: 5px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">' + item.count + '</td></tr>';
      });
      
      htmlReport += '</table></div>' +
        
        // Top D√≠as
        '<div style="background: #f8f9fa; border-left: 4px solid #8ecae6; padding: 15px; margin-bottom: 25px; border-radius: 0 4px 4px 0;">' +
        '<h3 style="margin: 0 0 15px 0; color: #8ecae6; font-size: 16px; font-weight: 700;">üìÖ D√≠as m√°s Activos</h3>' +
        '<table style="width: 100%; border-collapse: collapse;">';
      
      topDias.forEach(function(item, index) {
        htmlReport += '<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">' + (index + 1) + '. ' + item.name + '</td><td style="padding: 5px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">' + item.count + '</td></tr>';
      });
      
      htmlReport += '</table></div>';
      
      // Top Especialidades (si hay datos)
      if (topEspecialidades.length > 0) {
        htmlReport += '<div style="background: #f8f9fa; border-left: 4px solid #2d6a4f; padding: 15px; margin-bottom: 25px; border-radius: 0 4px 4px 0;">' +
          '<h3 style="margin: 0 0 15px 0; color: #2d6a4f; font-size: 16px; font-weight: 700;">üè• Top 10 Especialidades</h3>' +
          '<table style="width: 100%; border-collapse: collapse;">';
        
        topEspecialidades.forEach(function(item, index) {
          htmlReport += '<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">' + (index + 1) + '. ' + item.name + '</td><td style="padding: 5px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">' + item.count + '</td></tr>';
        });
        
        htmlReport += '</table></div>';
      }
      
      // Top Servicios (si hay datos)
      if (topServicios.length > 0) {
        htmlReport += '<div style="background: #f8f9fa; border-left: 4px solid #6a1b9a; padding: 15px; margin-bottom: 25px; border-radius: 0 4px 4px 0;">' +
          '<h3 style="margin: 0 0 15px 0; color: #6a1b9a; font-size: 16px; font-weight: 700;">üîß Top 10 Servicios</h3>' +
          '<table style="width: 100%; border-collapse: collapse;">';
        
        topServicios.forEach(function(item, index) {
          htmlReport += '<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">' + (index + 1) + '. ' + item.name + '</td><td style="padding: 5px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">' + item.count + '</td></tr>';
        });
        
        htmlReport += '</table></div>';
      }
      
      // Top Dise√±adores (√∫ltimo)
      htmlReport += '<div style="background: #f8f9fa; border-left: 4px solid #e07a5f; padding: 15px; margin-bottom: 25px; border-radius: 0 4px 4px 0;">' +
        '<h3 style="margin: 0 0 15px 0; color: #e07a5f; font-size: 16px; font-weight: 700;">üé® Top Dise√±adores (Finalizados)</h3>' +
        '<table style="width: 100%; border-collapse: collapse;">';
      
      topDisenadores.forEach(function(item, index) {
        htmlReport += '<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">' + (index + 1) + '. ' + item.name + '</td><td style="padding: 5px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">' + item.count + '</td></tr>';
      });
      
      htmlReport += '</table></div>' +
        
        // Top Dispositivos
        '<div style="background: #f8f9fa; border-left: 4px solid #9cd2d3; padding: 15px; margin-bottom: 25px; border-radius: 0 4px 4px 0;">' +
          '<h3 style="margin: 0 0 15px 0; color: #0799b6; font-size: 16px; font-weight: 700;">üì± Top 5 Dispositivos</h3>' +
          '<table style="width: 100%; border-collapse: collapse;">';
        
        topDispositivos.forEach(function(item, index) {
          htmlReport += '<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">' + (index + 1) + '. ' + item.name + '</td><td style="padding: 5px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">' + item.count + '</td></tr>';
        });
        
        htmlReport += '</table></div>' +
        
        '<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef; text-align: center; color: #6c757d; font-size: 13px;">' +
        '<p style="margin: 5px 0;">Reporte generado autom√°ticamente por SIRA 3.0 Reborn</p>' +
        '<p style="margin: 5px 0; font-weight: 600;">' + formatearFecha(new Date(), 'datetime') + '</p>' +
        '</div></div></div>';
      MailApp.sendEmail({
        to: validateEmail(CORREO_DESTINO),
        subject: "üìä Reporte Mensual SIRA 3.0 Reborn - " + monthLabel,
        htmlBody: htmlReport
      });
      
      // ‚úÖ Enviar reporte mensual por Telegram
      var telegramMsg = "üìä *REPORTE MENSUAL SIRA 3.0 Reborn*\n" +
                     "üìÖ *" + monthLabel + "*\n\n" +
                     "üìà *Estad√≠sticas Generales:*\n" +
                     "‚Ä¢ Total: " + stats.total + "\n" +
                     "‚Ä¢ Pendientes: " + stats.pendiente + "\n" +
                     "‚Ä¢ Procesando: " + stats.procesando + "\n" +
                     "‚Ä¢ Finalizadas: " + stats.finalizada + "\n" +
                     "‚Ä¢ Con fotos: " + stats.conFotos + "\n" +
                     "‚Ä¢ Total fotos: " + stats.totalFotos + "\n" +
                     "‚Ä¢ Obituarios: " + stats.obituarios + "\n\n" +
                     "üè• *Top 3 Unidades:*\n";
      
      topUnidades.slice(0, 3).forEach(function(item, index) {
        telegramMsg += (index + 1) + ". " + item.name + " (" + item.count + ")\n";
      });
      
      telegramMsg += "\nüìã *Top 3 Solicitudes:*\n";
      topJornadas.slice(0, 3).forEach(function(item, index) {
        telegramMsg += (index + 1) + ". " + item.name + " (" + item.count + ")\n";
      });
      
      telegramMsg += "\nüìÖ *D√≠as m√°s Activos:*\n";
      topDias.slice(0, 3).forEach(function(item, index) {
        telegramMsg += (index + 1) + ". " + item.name + " (" + item.count + ")\n";
      });
      
      telegramMsg += "\nüè• *Top 3 Especialidades:*\n";
      topEspecialidades.slice(0, 3).forEach(function(item, index) {
        telegramMsg += (index + 1) + ". " + item.name + " (" + item.count + ")\n";
      });
      
      telegramMsg += "\nüì± *Dispositivo m√°s usado:*\n";
      if (topDispositivos.length > 0) {
        telegramMsg += "üì± " + topDispositivos[0].name + " (" + topDispositivos[0].count + " solicitudes)\n";
      }
      
      telegramMsg += "\nüìä Reporte generado: " + formatearFecha(new Date(), 'datetime');
      
      // Enviar al bot (notificaciones)
      enviarTelegramBot(telegramMsg);
      
      // Enviar al grupo (reporte mensual)
      enviarTelegramGrupo(telegramMsg);
      
      logSecurityEvent("REPORT_COMPLETED", "SYSTEM", "Reporte enviado para " + monthLabel + " (Email + Telegram Bot + Grupo)");
      
      // ‚úÖ Ejecutar borrado autom√°tico de solicitudes finalizadas despu√©s del reporte
      Logger.log("üóëÔ∏è Iniciando borrado autom√°tico post-reporte");
      var deleteResult = autoDeleteFinalizedRequests();
      
      if (deleteResult.success) {
        Logger.log("‚úÖ Borrado autom√°tico completado: " + deleteResult.deleted + " solicitudes eliminadas");
      } else {
        Logger.log("‚ùå Error en borrado autom√°tico: " + deleteResult.error);
      }
      
      return { success: true, message: "Reporte mensual generado correctamente para " + monthLabel };
    } catch (err) {
      Logger.log("Error en generateMonthlyReport: " + err.toString());
      logSecurityEvent("REPORT_ERROR", "SYSTEM", err.toString());
      return { success: false, error: err.toString() };
    }
  }

  // ============================================================
  // FUNCIONES DE PRUEBA Y UTILIDAD
  // ============================================================

  /**
  * Prueba el env√≠o de reporte diario manualmente
  */
  function testDailyReport() {
    sendDailyQuotaReport();
    return { success: true, message: "Reporte diario de prueba enviado" };
  }

  /**
  * Muestra estad√≠sticas actuales en logs (para debugging)
  */
  function showCurrentStats() {
    var today = new Date();
    var dateKey = Utilities.formatDate(today, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
    var propsKey = STATS_KEYS.DAILY + dateKey;
    
    var stats = JSON.parse(PROPS.getProperty(propsKey) || "{}");
    
    Logger.log("üìä ESTAD√çSTICAS DE HOY (" + dateKey + "):");
    Logger.log(JSON.stringify(stats, null, 2));
    
    // Mostrar uso acumulado del mes
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    var daysSinceMonthStart = Math.floor((today - monthStart) / (1000 * 60 * 60 * 24)) + 1;
    var monthlyUrlFetch = 0;
    
    for (var d = 1; d <= daysSinceMonthStart; d++) {
      var checkDate = new Date(today.getFullYear(), today.getMonth(), d);
      var checkKey = Utilities.formatDate(checkDate, DATE_CONFIG.TIMEZONE, "yyyy-MM-dd");
      var checkStats = JSON.parse(PROPS.getProperty(STATS_KEYS.DAILY + checkKey) || "{}");
      monthlyUrlFetch += checkStats.urlFetch?.count || 0;
    }
    
    Logger.log(`üìà URL Fetch acumulado este mes: ${monthlyUrlFetch}`);
    return { 
      success: true, 
      message: `Estad√≠sticas de hoy: ${JSON.stringify(stats)}. URL Fetch acumulado este mes: ${monthlyUrlFetch}` 
    };
  }

  // ============================================================
  // REPORTE DIARIO (Ejecutar a las 11:00 PM)
  // ============================================================

  function sendDailyQuotaReport() {
    try {
      var today = new Date();
      var dateKey = Utilities.formatDate(today, "GMT-4", "yyyy-MM-dd");
      var propsKey = STATS_KEYS.DAILY + dateKey;
      
      var stats = JSON.parse(PROPS.getProperty(propsKey) || "{}");
      var limits = QUOTA_CONFIG.LIMITS;
      
      var urlFetchCount = stats.urlFetch?.count || 0;
      var emailCount = stats.emails?.count || 0;
      var emailRecipients = stats.emails?.recipients || 0;
      
      var urlFetchPercent = (urlFetchCount / limits.URL_FETCH_DAILY * 100).toFixed(2);
      var emailRecipientsPercent = (emailRecipients / limits.EMAIL_RECIPIENTS_DAILY * 100).toFixed(2);
      
      var getStatus = function(percent) {
        if (percent < 50) return "üü¢";
        if (percent < 80) return "üü°";
        if (percent < 95) return "üü†";
        return "üî¥";
      };
      
      var msg = "üìä *REPORTE DIARIO DE CUOTAS - SIRA 2.5*\n";
      msg += "üìÖ Fecha: " + Utilities.formatDate(today, "GMT-4", "dd/MM/yyyy") + "\n";
      msg += "‚è∞ Hora: " + Utilities.formatDate(today, "GMT-4", "HH:mm") + "\n\n";
      
      msg += "*üì° URL FETCH CALLS*\n";
      msg += getStatus(urlFetchPercent) + " Usados: " + urlFetchCount.toLocaleString() + " / " + limits.URL_FETCH_DAILY.toLocaleString() + "\n";
      msg += "üìà Porcentaje: " + urlFetchPercent + "%\n";
      msg += "üí∞ Restantes: " + (limits.URL_FETCH_DAILY - urlFetchCount).toLocaleString() + "\n\n";
      
      msg += "*üìß ENV√çO DE CORREOS*\n";
      msg += getStatus(emailRecipientsPercent) + " Emails enviados: " + emailCount + "\n";
      msg += "üë• Destinatarios: " + emailRecipients + " / " + limits.EMAIL_RECIPIENTS_DAILY + "\n";
      msg += "üìà Porcentaje: " + emailRecipientsPercent + "%\n\n";
      
      msg += "*üë• ACTIVIDAD POR USUARIO (Hoy)*\n";
      
      var userActivity = {};
      
      if (stats.urlFetch && stats.urlFetch.users) {
        Object.keys(stats.urlFetch.users).forEach(function(user) {
          userActivity[user] = { urlFetch: stats.urlFetch.users[user], emails: 0 };
        });
      }
      
      if (stats.emails && stats.emails.users) {
        Object.keys(stats.emails.users).forEach(function(user) {
          if (!userActivity[user]) userActivity[user] = { urlFetch: 0, emails: 0 };
          userActivity[user].emails = stats.emails.users[user];
        });
      }
      
      var sortedUsers = Object.keys(userActivity).sort(function(a, b) {
        var totalA = userActivity[a].urlFetch + userActivity[a].emails;
        var totalB = userActivity[b].urlFetch + userActivity[b].emails;
        return totalB - totalA;
      });
      
      if (sortedUsers.length === 0) {
        msg += "‚ö†Ô∏è No hay actividad registrada hoy\n";
      } else {
        sortedUsers.slice(0, 5).forEach(function(user, idx) {
          var activity = userActivity[user];
          var total = activity.urlFetch + activity.emails;
          var medal = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : "‚Ä¢";
          msg += medal + " " + user + ": " + total + " llamadas (üì°" + activity.urlFetch + " üìß" + activity.emails + ")\n";
        });
      }
      
      if (urlFetchPercent > 80 || emailRecipientsPercent > 80) {
        msg += "\n‚ö†Ô∏è *ALERTA: Se acerca al l√≠mite de cuota!*\n";
        if (urlFetchPercent > 80) msg += "üî¥ URL Fetch: " + urlFetchPercent + "%\n";
        if (emailRecipientsPercent > 80) msg += "üî¥ Email Recipients: " + emailRecipientsPercent + "%\n";
      }
      
      enviarTelegramBot(msg);
      logSecurityEvent("QUOTA_REPORT_SENT", "SYSTEM", "Reporte diario enviado");
      
    } catch (e) {
      Logger.log("‚ùå Error enviando reporte diario: " + e.toString());
    }
  }

  // ============================================================
  // REPORTE SEMANAL (Ejecutar domingos a las 11:00 PM)
  // ============================================================

  function sendWeeklyQuotaReport() {
    try {
      var today = new Date();
      var weekStart = new Date(today);
      weekStart.setDate(today.getDate() - 7);
      
      var weekStartKey = Utilities.formatDate(weekStart, "GMT-4", "yyyy-MM-dd");
      var weekEndKey = Utilities.formatDate(today, "GMT-4", "yyyy-MM-dd");
      
      var weeklyStats = {
        urlFetch: 0,
        emails: 0,
        emailRecipients: 0,
        userActivity: {}
      };
      
      for (var i = 0; i < 7; i++) {
        var checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        var dateKey = Utilities.formatDate(checkDate, "GMT-4", "yyyy-MM-dd");
        var propsKey = STATS_KEYS.DAILY + dateKey;
        
        var dailyStats = JSON.parse(PROPS.getProperty(propsKey) || "{}");
        
        weeklyStats.urlFetch += dailyStats.urlFetch?.count || 0;
        weeklyStats.emails += dailyStats.emails?.count || 0;
        weeklyStats.emailRecipients += dailyStats.emails?.recipients || 0;
        
        if (dailyStats.urlFetch && dailyStats.urlFetch.users) {
          Object.keys(dailyStats.urlFetch.users).forEach(function(user) {
            if (!weeklyStats.userActivity[user]) {
              weeklyStats.userActivity[user] = { urlFetch: 0, emails: 0 };
            }
            weeklyStats.userActivity[user].urlFetch += dailyStats.urlFetch.users[user];
          });
        }
        
        if (dailyStats.emails && dailyStats.emails.users) {
          Object.keys(dailyStats.emails.users).forEach(function(user) {
            if (!weeklyStats.userActivity[user]) {
              weeklyStats.userActivity[user] = { urlFetch: 0, emails: 0 };
            }
            weeklyStats.userActivity[user].emails += dailyStats.emails.users[user];
          });
        }
      }
      
      var limits = QUOTA_CONFIG.LIMITS;
      var weeklyLimitUrlFetch = limits.URL_FETCH_DAILY * 7;
      var weeklyLimitEmails = limits.EMAIL_RECIPIENTS_DAILY * 7;
      
      var msg = "üìä *REPORTE SEMANAL DE CUOTAS - SIRA 2.5*\n";
      msg += "üìÖ Per√≠odo: " + weekStartKey + " al " + weekEndKey + "\n\n";
      
      msg += "*üì° URL FETCH CALLS (Semana)*\n";
      msg += "üìä Total: " + weeklyStats.urlFetch.toLocaleString() + "\n";
      msg += "üìà Promedio diario: " + Math.round(weeklyStats.urlFetch / 7).toLocaleString() + "\n";
      msg += "üí∞ L√≠mite semanal: " + weeklyLimitUrlFetch.toLocaleString() + "\n";
      msg += "üìâ Uso: " + (weeklyStats.urlFetch / weeklyLimitUrlFetch * 100).toFixed(2) + "%\n\n";
      
      msg += "*üìß ENV√çO DE CORREOS (Semana)*\n";
      msg += "üìä Emails enviados: " + weeklyStats.emails + "\n";
      msg += "üë• Total destinatarios: " + weeklyStats.emailRecipients.toLocaleString() + "\n";
      msg += "üí∞ L√≠mite semanal: " + weeklyLimitEmails.toLocaleString() + "\n";
      msg += "üìâ Uso: " + (weeklyStats.emailRecipients / weeklyLimitEmails * 100).toFixed(2) + "%\n\n";
      
      msg += "*üèÜ RANKING SEMANAL - TOP USUARIOS*\n";
      
      var sortedUsers = Object.keys(weeklyStats.userActivity).sort(function(a, b) {
        var totalA = weeklyStats.userActivity[a].urlFetch + weeklyStats.userActivity[a].emails;
        var totalB = weeklyStats.userActivity[b].urlFetch + weeklyStats.userActivity[b].emails;
        return totalB - totalA;
      });
      
      if (sortedUsers.length === 0) {
        msg += "‚ö†Ô∏è No hay actividad registrada esta semana\n";
      } else {
        sortedUsers.slice(0, 10).forEach(function(user, idx) {
          var activity = weeklyStats.userActivity[user];
          var total = activity.urlFetch + activity.emails;
          var medal = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : "‚Ä¢";
          
          var role = "üë§";
          if (isAdminUser(user, "")) role = "üëë";
          else {
            var designerCheck = isDesignerUser(user, "");
            if (designerCheck.isValid) role = "üé®";
          }
          
          msg += medal + " " + role + " " + user + "\n";
          msg += "   ‚îî Total: " + total + " (üì°" + activity.urlFetch + " üìß" + activity.emails + ")\n";
        });
      }
      
      enviarTelegramBot(msg);
      logSecurityEvent("WEEKLY_REPORT_SENT", "SYSTEM", "Reporte semanal enviado");
      
    } catch (e) {
      Logger.log("‚ùå Error enviando reporte semanal: " + e.toString());
    }
  }

  // ============================================================
  // FUNCI√ìN AUTOM√ÅTICA: Borrar solicitudes finalizadas al final del mes
  // ============================================================

  function autoDeleteFinalizedRequests() {
    try {
      Logger.log("üóëÔ∏è Iniciando borrado autom√°tico de solicitudes finalizadas");
      
      var today = new Date();
      
      // Calcular el primer d√≠a del mes actual (corte para eliminaci√≥n)
      var firstDayOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1, 0, 0, 0, 0);
      
      Logger.log("üìÖ Per√≠odo a eliminar: Todas las solicitudes finalizadas con fecha anterior al " + Utilities.formatDate(firstDayOfCurrentMonth, "GMT-4", "dd/MM/yyyy"));
      
      var data = SHEET.getDataRange().getValues();
      var deletedCount = 0;
      var rowsToDelete = [];
      var deletedIds = [];
      var deletedDates = []; // Para capturar fechas exactas eliminadas
      
      // Recorrer de abajo hacia arriba para no afectar √≠ndices
      for (var i = data.length - 1; i > 0; i--) {
        var row = data[i];
        var fechaRegistro = row[1]; // Columna B (Timestamp)
        var estado = row[14]; // Columna O (Estado)
        
        // Solo procesar si est√° FINALIZADA
        if (estado !== "FINALIZADA") continue;
        
        // Parsear la fecha de registro
        var fechaObj = null;
        
        if (fechaRegistro instanceof Date) {
          fechaObj = fechaRegistro;
        } else if (fechaRegistro && typeof fechaRegistro === 'string') {
          // Intentar parsear formato dd/MM/yyyy HH:mm
          var parts = fechaRegistro.split(' ')[0].split('/');
          if (parts.length === 3) {
            var dia = parseInt(parts[0], 10);
            var mes = parseInt(parts[1], 10) - 1;
            var anio = parseInt(parts[2], 10);
            fechaObj = new Date(anio, mes, dia);
          }
        }
        
        if (!fechaObj) {
          Logger.log("‚ö†Ô∏è No se pudo parsear fecha para fila " + (i+1) + ": " + fechaRegistro);
          continue;
        }
        
        // Verificar si la fecha es anterior al mes actual
        var isBeforeCurrentMonth = (fechaObj < firstDayOfCurrentMonth);
        
        if (isBeforeCurrentMonth) {
          rowsToDelete.push(i + 1); // +1 porque Sheets es 1-based
          
          // Eliminar archivo de Drive si existe
          var arteUrl = row[16];
          if (arteUrl && arteUrl.trim() !== "") {
            var fileIdMatch = arteUrl.match(/\/file\/d\/([-\w]{25,})/) || arteUrl.match(/[-\w]{25,}/);
            if (fileIdMatch && fileIdMatch[1]) {
              try {
                DriveApp.getFileById(fileIdMatch[1]).setTrashed(true);
                Logger.log("‚úÖ Archivo Drive eliminado: " + fileIdMatch[1]);
              } catch (e) { 
                Logger.log("‚ùå Error eliminando archivo Drive: " + e.toString()); 
              }
            }
          }
          
          deletedIds.push(row[0]);
          deletedDates.push(fechaObj); // Capturar fecha exacta eliminada
          deletedCount++;
          Logger.log("üóëÔ∏è Marcada para eliminar: ID " + row[0] + " - Fecha: " + fechaObj);
        }
      }
      
      // Eliminar filas de abajo hacia arriba para mantener √≠ndices v√°lidos
      rowsToDelete.sort(function(a, b) { return b - a; }); // Orden descendente
      
      for (var j = 0; j < rowsToDelete.length; j++) {
        try {
          SHEET.deleteRow(rowsToDelete[j]);
          Logger.log("‚úÖ Fila " + rowsToDelete[j] + " eliminada");
        } catch (e) {
          Logger.log("‚ùå Error eliminando fila " + rowsToDelete[j] + ": " + e.toString());
        }
      }
      
      if (deletedCount > 0) {
        Logger.log("‚úÖ Borrado autom√°tico completado: " + deletedCount + " solicitudes finalizadas eliminadas");
        logSecurityEvent("AUTO_DELETE_COMPLETED", "SYSTEM", deletedCount + " solicitudes eliminadas autom√°ticamente con fecha anterior a " + Utilities.formatDate(firstDayOfCurrentMonth, "GMT-4", "MM/yyyy"));
        
        // Ordenar fechas para encontrar la m√°s antigua y m√°s reciente
        deletedDates.sort(function(a, b) { return a - b; });
        var fechaMasAntigua = deletedDates[0];
        var fechaMasReciente = deletedDates[deletedDates.length - 1];
        
        // Nombres de meses en espa√±ol
        var mesesEnEspanol = ["enero", "febrero", "marzo", "abril", "mayo", "junio", 
                              "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        var nombreMesActual = mesesEnEspanol[firstDayOfCurrentMonth.getMonth()];
        
        // Enviar notificaci√≥n por Telegram del borrado autom√°tico (solo al bot)
        var autoDeleteMsg = "üóëÔ∏è *BORRADO AUTOM√ÅTICO MENSUAL*\n\n" +
                           "üìä *Sistema:* SIRA 3.0 REBORN\n\n" +
                           "üìÖ *Per√≠odo:* Todos los meses anteriores a " + nombreMesActual + " " + firstDayOfCurrentMonth.getFullYear() + "\n" +
                           "üìä *Solicitudes eliminadas:* " + deletedCount + "\n" +
                           "üìã *Rango exacto:* " + Utilities.formatDate(fechaMasReciente, "GMT-4", "dd/MM/yyyy") + " al " + Utilities.formatDate(fechaMasAntigua, "GMT-4", "dd/MM/yyyy") + "\n\n" +
                           "‚úÖ *Proceso completado exitosamente*";
        
        enviarTelegramBot(autoDeleteMsg);
        
      } else {
        Logger.log("‚ÑπÔ∏è No se encontraron solicitudes finalizadas para eliminar autom√°ticamente");
      }
      
      return { success: true, deleted: deletedCount };
      
    } catch (err) {
      Logger.log("‚ùå Error en autoDeleteFinalizedRequests: " + err.toString());
      logSecurityEvent("AUTO_DELETE_ERROR", "SYSTEM", err.message);
      return { success: false, error: err.toString() };
    }
  }

  // ============================================================
  // REPORTE MENSUAL (Ejecutar √∫ltimo d√≠a del mes a las 11:00 PM)
  // ============================================================

  function sendMonthlyQuotaReport() {
    try {
      var today = new Date();
      var year = today.getFullYear();
      var month = today.getMonth();
      
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      // Nombres de meses en espa√±ol
      var monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                       "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      var monthName = monthNames[month] + " " + year;
      
      var monthlyStats = {
        urlFetch: 0,
        emails: 0,
        emailRecipients: 0,
        userActivity: {},
        peakDay: { date: "", urlFetch: 0 }
      };
      
      for (var day = 1; day <= daysInMonth; day++) {
        var checkDate = new Date(year, month, day);
        var dateKey = Utilities.formatDate(checkDate, "GMT-4", "yyyy-MM-dd");
        var propsKey = STATS_KEYS.DAILY + dateKey;
        
        var dailyStats = JSON.parse(PROPS.getProperty(propsKey) || "{}");
        var dailyUrlFetch = dailyStats.urlFetch?.count || 0;
        
        monthlyStats.urlFetch += dailyUrlFetch;
        monthlyStats.emails += dailyStats.emails?.count || 0;
        monthlyStats.emailRecipients += dailyStats.emails?.recipients || 0;
        
        if (dailyUrlFetch > monthlyStats.peakDay.urlFetch) {
          monthlyStats.peakDay = {
            date: dateKey,
            urlFetch: dailyUrlFetch
          };
        }
        
        if (dailyStats.urlFetch && dailyStats.urlFetch.users) {
          Object.keys(dailyStats.urlFetch.users).forEach(function(user) {
            if (!monthlyStats.userActivity[user]) {
              monthlyStats.userActivity[user] = { urlFetch: 0, emails: 0 };
            }
            monthlyStats.userActivity[user].urlFetch += dailyStats.urlFetch.users[user];
          });
        }
        
        if (dailyStats.emails && dailyStats.emails.users) {
          Object.keys(dailyStats.emails.users).forEach(function(user) {
            if (!monthlyStats.userActivity[user]) {
              monthlyStats.userActivity[user] = { urlFetch: 0, emails: 0 };
            }
            monthlyStats.userActivity[user].emails += dailyStats.emails.users[user];
          });
        }
      }
      
      var limits = QUOTA_CONFIG.LIMITS;
      var monthlyLimitUrlFetch = limits.URL_FETCH_DAILY * daysInMonth;
      var monthlyLimitEmails = limits.EMAIL_RECIPIENTS_DAILY * daysInMonth;
      
      var msg = "üìä *REPORTE MENSUAL DE CUOTAS - SIRA 3.0 REBORN*\n";
      msg += "üìÖ Mes: " + monthName + "\n";
      msg += "üìÜ D√≠as analizados: " + daysInMonth + "\n\n";
      
      msg += "*üìä RESUMEN EJECUTIVO*\n";
      msg += "üì° URL Fetch Total: " + monthlyStats.urlFetch.toLocaleString() + "\n";
      msg += "üìß Emails Enviados: " + monthlyStats.emails + "\n";
      msg += "üë• Destinatarios: " + monthlyStats.emailRecipients.toLocaleString() + "\n\n";
      
      msg += "*üìà PROMEDIOS DIARIOS*\n";
      msg += "üì° URL Fetch/d√≠a: " + Math.round(monthlyStats.urlFetch / daysInMonth).toLocaleString() + "\n";
      msg += "üìß Emails/d√≠a: " + (monthlyStats.emails / daysInMonth).toFixed(1) + "\n\n";
      
      msg += "*üí∞ USO DE CUOTAS MENSUAL*\n";
      var urlFetchPercent = (monthlyStats.urlFetch / monthlyLimitUrlFetch * 100).toFixed(2);
      var emailPercent = (monthlyStats.emailRecipients / monthlyLimitEmails * 100).toFixed(2);
      msg += "üì° URL Fetch: " + urlFetchPercent + "%\n";
      msg += "üìß Emails: " + emailPercent + "%\n\n";
      
      msg += "*üî• D√çA M√ÅS ACTIVO*\n";
      msg += "üìÖ Fecha: " + monthlyStats.peakDay.date + "\n";
      msg += "üì° URL Fetch: " + monthlyStats.peakDay.urlFetch.toLocaleString() + " llamadas\n\n";
      
      msg += "*üèÜ RANKING MENSUAL - TOP 10 USUARIOS*\n";
      
      var sortedUsers = Object.keys(monthlyStats.userActivity).sort(function(a, b) {
        var totalA = monthlyStats.userActivity[a].urlFetch + monthlyStats.userActivity[a].emails;
        var totalB = monthlyStats.userActivity[b].urlFetch + monthlyStats.userActivity[b].emails;
        return totalB - totalA;
      });
      
      if (sortedUsers.length === 0) {
        msg += "‚ö†Ô∏è No hay actividad registrada este mes\n";
      } else {
        sortedUsers.slice(0, 10).forEach(function(user, idx) {
          var activity = monthlyStats.userActivity[user];
          var total = activity.urlFetch + activity.emails;
          var medal = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : (idx + 1) + ".";
          
          var role = "üë§";
          if (isAdminUser(user, "")) role = "üëë";
          else {
            var designerCheck = isDesignerUser(user, "");
            if (designerCheck.isValid) role = "üé®";
          }
          
          msg += medal + " " + role + " " + user + "\n";
          msg += "   ‚îî " + total.toLocaleString() + " llamadas (üì°" + activity.urlFetch.toLocaleString() + " üìß" + activity.emails + ")\n";
        });
      }
      
      var trend = monthlyStats.urlFetch > monthlyLimitUrlFetch * 0.8 ? "üî¥ ALTO" : 
                  monthlyStats.urlFetch > monthlyLimitUrlFetch * 0.5 ? "üü° MODERADO" : "üü¢ NORMAL";
      
      msg += "\n*üîÆ PROYECCI√ìN*\n";
      msg += "üìä Tendencia: " + trend + "\n";
      
      enviarTelegramBot(msg);
      logSecurityEvent("MONTHLY_REPORT_SENT", "SYSTEM", "Reporte mensual enviado");
      
      PROPS.setProperty(STATS_KEYS.MONTHLY + year + "-" + String(month + 1).padStart(2, '0'), 
        JSON.stringify(monthlyStats));
      
      // ‚úÖ REINICIO AUTOM√ÅTICO DESPU√âS DEL REPORTE MENSUAL
      var msgReinicio = "üóëÔ∏è *REINICIO AUTOM√ÅTICO COMPLETADO*\n\n";
      msgReinicio += "‚úÖ Datos del mes eliminados del sistema\n";
      msgReinicio += "üìä El pr√≥ximo mes comenzar√° a contar desde cero\n";
      msgReinicio += "üìÖ Fecha de reinicio: " + Utilities.formatDate(today, "GMT-4", "dd/MM/yyyy HH:mm") + "\n\n";
      msgReinicio += "üí° *Nota:* Los datos completos est√°n en este reporte mensual enviado arriba ‚Üë";
      
      enviarTelegramBot(msgReinicio);
      
      // Borrar TODOS los datos de cuotas
      var allProps = PropertiesService.getScriptProperties();
      var allData = allProps.getProperties();
      var eliminados = 0;
      
      for (var clave in allData) {
        if (clave.indexOf("quota_stats_") === 0) {
          allProps.deleteProperty(clave);
          eliminados++;
        }
      }
      
      Logger.log("üóëÔ∏è Reinicio mensual autom√°tico: " + eliminados + " registros eliminados");
      logSecurityEvent("MONTHLY_RESET_AUTO", "SYSTEM", "Eliminados " + eliminados + " registros post-reporte");
      
    } catch (e) {
      Logger.log("‚ùå Error enviando reporte mensual: " + e.toString());
    }
  }

  // ============================================================
  // FUNCI√ìN PARA ENVIAR AL GRUPO DE TELEGRAM
  // ============================================================

  function enviarTelegramGrupo(mensaje) {
    try {
      var token = getTelegramToken();
      var chatId = PROPS.getProperty("GRUPO_CHAT_ID");
      
      // Validar que el chat ID del grupo exista
      if (!chatId) {
        Logger.log("‚ö†Ô∏è Chat ID del grupo no configurado");
        return;
      }
      
      var payload = {
        chat_id: chatId,
        text: mensaje,
        parse_mode: "Markdown"
      };
      
      var options = {
        method: "post",
        payload: payload,
        muteHttpExceptions: true
      };
      
      var response = UrlFetchApp.fetch(
        "https://api.telegram.org/bot" + token + "/sendMessage", 
        options
      );
      
      var result = JSON.parse(response.getContentText());
      
      if (result.ok) {
        Logger.log("‚úÖ Mensaje enviado al grupo correctamente");
      } else {
        Logger.log("‚ùå Error enviando al grupo: " + result.description);
      }
      
    } catch (e) {
      Logger.log("‚ùå Error en enviarTelegramGrupo: " + e.toString());
    }
  }

  // ============================================================
  // FUNCI√ìN PARA ENVIAR AL BOT (PRIVADO, NO AL GRUPO)
  // ============================================================

  function enviarTelegramBot(mensaje) {
    try {
      var token = getTelegramToken();
      var chatId = getBotChatId();
      
      var payload = {
        chat_id: chatId,
        text: mensaje,
        parse_mode: "Markdown"
      };
      
      var options = {
        method: "post",
        payload: payload,
        muteHttpExceptions: true
      };
      
      var response = UrlFetchApp.fetch(
        "https://api.telegram.org/bot" + token + "/sendMessage", 
        options
      );
      
      var result = JSON.parse(response.getContentText());
      
      if (result.ok) {
        Logger.log("‚úÖ Mensaje enviado al bot correctamente");
      } else {
        Logger.log("‚ùå Error enviando al bot: " + result.description);
      }
      
    } catch (e) {
      Logger.log("‚ùå Error en enviarTelegramBot: " + e.toString());
    }
  }

  // ============================================================
  // COPIA MENSUAL AUTOM√ÅTICA DE BASE DE DATOS
  // ============================================================

  function createMonthlyDatabaseCopy() {
    try {
      var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
      var sourceSheet = spreadsheet.getSheetByName("Sheet1");
      
      if (!sourceSheet) {
        Logger.log("‚ùå No se encontr√≥ la hoja 'Sheet1' para copiar");
        return;
      }
      
      // Obtener nombre del mes anterior
      var today = new Date();
      var lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      var monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
      var monthName = monthNames[lastMonth.getMonth()];
      var year = lastMonth.getFullYear();
      var newSheetName = `${monthName} ${year}`;
      
      // Verificar si ya existe una hoja con ese nombre
      var existingSheet = spreadsheet.getSheetByName(newSheetName);
      if (existingSheet) {
        Logger.log(`‚ö†Ô∏è Ya existe una hoja llamada '${newSheetName}', no se crea copia`);
        return;
      }
      
      // Crear copia de la hoja
      var newSheet = sourceSheet.copyTo(spreadsheet);
      newSheet.setName(newSheetName);
      
      // Mover la hoja copiada al final
      spreadsheet.setActiveSheet(newSheet);
      var sheetIndex = spreadsheet.getNumSheets();
      spreadsheet.moveActiveSheet(sheetIndex);
      
      Logger.log(`‚úÖ Copia mensual creada: '${newSheetName}'`);
      
      // Enviar notificaci√≥n por Telegram
      enviarTelegramBot(`üìä Copia mensual de BD creada: ${newSheetName}`);
      
    } catch (e) {
      Logger.log("‚ùå Error creando copia mensual: " + e.toString());
    }
  }
