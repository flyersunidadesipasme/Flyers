<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Artes IPASME</title>
    <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --azul: #1a4b8c; --verde: #28a745; --naranja: #fd7e14; --rojo: #dc3545; --fondo: #f4f7f9; --blanco: #ffffff; }
        body { font-family: 'Georama', sans-serif; background: var(--fondo); margin: 0; padding-bottom: 50px; }
        .nav-tabs { display: flex; background: var(--azul); padding: 10px; position: sticky; top: 0; z-index: 1000; justify-content: center; gap: 15px; }
        .tab-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 0.9em; }
        .tab-btn.active { background: var(--blanco); color: var(--azul); }
        .container { max-width: 950px; margin: 15px auto; background: var(--blanco); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 10px; }
        .section-title { font-weight: 700; color: var(--azul); margin-bottom: 12px; display: block; border-left: 5px solid var(--azul); padding-left: 10px; text-transform: uppercase; font-size: 0.85em; }
        .warning-text { color: var(--rojo); font-weight: 700; font-size: 0.85em; margin-top: 8px; display: block; background: #fff2f2; padding: 8px; border-radius: 5px; border-left: 3px solid var(--rojo); }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .option-btn { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.8em; flex: 1; min-width: 140px; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .option-btn.selected { background: var(--verde); color: white; border-color: #1e7e34; }
        .img-preview { width: 100%; height: 90px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; background: #eee; margin-top: 10px; }
        .btn-enviar { background: var(--azul); color: white; padding: 15px; width: 100%; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-enviar:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 0.75em; text-align: left; }
        .badge { padding: 4px 8px; border-radius: 10px; color: white; font-weight: bold; font-size: 0.9em; }
        .PENDIENTE { background: var(--rojo); } .EJECUTANDO { background: var(--naranja); } .APROBADO { background: var(--verde); }
        .row-new { background-color: #fff8e1; animation: highlight 2s ease-in-out; }
        @keyframes highlight { from { background-color: #ffe082; } to { background-color: #fff8e1; } }
    </style>
</head>
<body>

<nav class="nav-tabs">
    <button class="tab-btn active" id="btn-form" onclick="showTab('formSec', this)">üìù NUEVA SOLICITUD</button>
    <button class="tab-btn" id="btn-list" onclick="showTab('listadoSec', this); cargarSolicitudes();">‚è≥ SOLICITUDES</button>
</nav>

<div id="formSec" class="container">
    <form id="mainForm">
        <div class="section">
            <label class="section-title">üè¢ 1. Unidad Solicitante</label>
            <input type="text" name="Unidad" placeholder="Ej: U.M.I. Caracas" required style="width:100%; padding:10px; box-sizing: border-box;">
        </div>

        <div class="section">
            <label class="section-title">üè• 2. Tipo de Jornada</label>
            <div class="btn-group" id="j_grid">
                <div class="option-btn" onclick="selJornada(this)">Ipasme va a la Escuela</div>
                <div class="option-btn" onclick="selJornada(this)">Jornada de Atenci√≥n M√©dica Integral</div>
                <div class="option-btn" onclick="selJornada(this)">Jornada Conjunta</div>
                <div class="option-btn" onclick="selJornada(this)">Captaci√≥n Quir√∫rgica</div>
                <div class="option-btn" onclick="selJornada(this)">Otros</div>
            </div>
            <input type="hidden" name="Jornada" id="h_jornada" required>
        </div>

        <div id="sec_esp" class="section">
            <label class="section-title" id="tit_dinamico">ü©∫ 3. Especialidades / Patolog√≠as</label>
            <div class="btn-group" id="g_esp" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 5px;"></div>
            <input type="hidden" name="Especialidades" id="h_esp">
        </div>

        <div id="sec_ser" class="section">
            <label class="section-title">‚ú® 4. Servicios Adicionales</label>
            <div class="btn-group" id="g_ser" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 5px;"></div>
            <input type="hidden" name="Servicios" id="h_ser">
        </div>

        <div class="section">
            <label class="section-title">üìÖ 5. Fecha y Hora del Evento</label>
            <span class="warning-text">‚ö†Ô∏è ATENCI√ìN: La solicitud debe realizarse con un m√≠nimo de 48 horas de anticipaci√≥n, de lo contrario NO ser√° procesada.</span>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <input type="date" id="input_fecha" name="Fecha" required style="padding:10px;">
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="text" id="t_hora" placeholder="08:00" style="width:60px; padding:10px;">
                    <button type="button" class="option-btn ampm-btn" id="am" onclick="selAMPM('a. m.')">AM</button>
                    <button type="button" class="option-btn ampm-btn" id="pm" onclick="selAMPM('p. m.')">PM</button>
                </div>
            </div>
            <input type="hidden" name="Hora" id="h_hora">
        </div>

        <div class="section">
            <label class="section-title">üìç 6. Ubicaci√≥n y Contacto</label>
            <span class="warning-text">‚ö†Ô∏è La direcci√≥n debe ser EXACTA. De estar err√≥nea, la solicitud pasar√° autom√°ticamente a BAJA PRIORIDAD.</span>
            <textarea name="Direccion" placeholder="Direcci√≥n completa y punto de referencia..." required style="width:100%; height:60px; padding:10px; margin-top:10px; box-sizing: border-box;"></textarea>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <input type="text" name="Telefono" placeholder="Tel√©fono" required style="padding:10px;">
                <input type="email" name="Correo" placeholder="Correo Institucional" required style="padding:10px;">
            </div>
        </div>

        <div class="section">
            <label class="section-title">üìù 7. Observaciones</label>
            <textarea name="Observaciones" placeholder="Detalles para el dise√±o..." style="width:100%; height:80px; padding:10px; box-sizing: border-box;"></textarea>
        </div>

        <div class="section">
            <label class="section-title">üì∏ 8. Soportes Fotogr√°ficos</label>
            <input type="file" id="foto1" accept="image/*" onchange="preview(this, 'p1')">
            <input type="file" id="foto2" accept="image/*" onchange="preview(this, 'p2')">
            <input type="file" id="foto3" accept="image/*" onchange="preview(this, 'p3')">
            <div style="display: flex; gap: 10px;">
                <img id="p1" class="img-preview" src="">
                <img id="p2" class="img-preview" src="">
                <img id="p3" class="img-preview" src="">
            </div>
        </div>

        <button type="button" class="btn-enviar" id="btnSubmit" onclick="enviar()">üöÄ ENVIAR SOLICITUD</button>
    </form>
</div>

<div id="listadoSec" class="container hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3>üìä Solicitudes Recientes</h3>
        <button onclick="accesoAdmin()" style="cursor:pointer; padding:5px 10px;">üîë Admin</button>
    </div>
    <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr><th>Registro</th><th>Unidad</th><th>Jornada</th><th>Estatus</th><th id="colAdmin" class="hidden">Acci√≥n</th></tr>
            </thead>
            <tbody id="cuerpoTabla"></tbody>
        </table>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzh_Ra8WCYL7JuauVfwvE8HjvG0GIlcQdOmMLaeSnTUI9O3xFKFhCZZOzxeR3fZCpfC/exec';

    const listEsp = ["Alergolog√≠a", "Cardiolog√≠a", "Cirug√≠a general", "Dermatolog√≠a", "Ecograf√≠a", "Fisiatr√≠a", "Gastroenterolog√≠a", "Geriatr√≠a", "Gerontolog√≠a", "Ginecolog√≠a y obstetricia", "Medicina familiar", "Medicina general", "Medicina interna", "Nefrolog√≠a", "Neumolog√≠a", "Neurolog√≠a", "Nutrici√≥n", "Odontolog√≠a", "Oftalmolog√≠a", "Oncolog√≠a", "Optometr√≠a", "Pediatr√≠a", "Psicolog√≠a", "Psiquiatr√≠a", "Reumatolog√≠a", "Traumatolog√≠a", "Urolog√≠a"];
    const listPat = ["Hernia inguinal", "Hernia umbilical", "Hernia abdominal", "Hernia epig√°strica", "Hernia escrotal", "Fimosis", "Vasectom√≠a", "Varicocele", "Hidrocele", "Litiasis vesicular", "Colectom√≠a", "Lipomas", "Quiste tirogloso", "Quiste seb√°ceo", "Esterilizaci√≥n", "Miomatosis uterina", "Tumores ov√°ricos", "Prolapso", "Histerectom√≠a", "Catarata", "Pterigi√≥n", "Glaucoma", "Retinoblastoma"];
    const listSer = ["Fisioterapia", "Inmunizaci√≥n", "Control de talla y peso", "Despestaje HTA", "Afiliaci√≥n", "Sesi√≥n educativa", "Farmacia", "Captaci√≥n quir√∫rgica general", "Captaci√≥n quir√∫rgica oftalmol√≥gica", "Servicios sociales", "Masoterapia", "Terapia ocupacional", "Desparasitaci√≥n", "Bienestar social"];

    let ampmValue = ""; let esAdmin = false;

    function showTab(id, b) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
    }

    function selAMPM(val) {
        document.querySelectorAll('.ampm-btn').forEach(b => b.classList.remove('selected'));
        if(val === 'a. m.') document.getElementById('am').classList.add('selected');
        else document.getElementById('pm').classList.add('selected');
        ampmValue = val;
    }

    function preview(input, id) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) { document.getElementById(id).src = e.target.result; }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function selJornada(el) {
        document.querySelectorAll('#j_grid .option-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        const v = el.innerText;
        document.getElementById('h_jornada').value = v;
        const contEsp = document.getElementById('g_esp');
        const secSer = document.getElementById('sec_ser');

        if(v === "Otros") {
            document.getElementById('tit_dinamico').innerText = "ü©∫ 3. Especifique su solicitud";
            contEsp.innerHTML = `<textarea id="txt_otros" oninput="document.getElementById('h_esp').value = this.value" placeholder="Describa brevemente lo que requiere..." style="width:100%; height:80px; padding:10px; border:1px solid #ccc; width:100%; box-sizing:border-box;"></textarea>`;
            secSer.classList.add('hidden');
        } else if(v === "Captaci√≥n Quir√∫rgica") {
            document.getElementById('tit_dinamico').innerText = "ü©∫ 3. Patolog√≠as";
            render('g_esp', listPat, 'h_esp');
            secSer.classList.add('hidden');
        } else {
            document.getElementById('tit_dinamico').innerText = "ü©∫ 3. Especialidades";
            render('g_esp', listEsp, 'h_esp');
            secSer.classList.remove('hidden');
            render('g_ser', listSer, 'h_ser');
        }
    }

    function render(cid, lista, hid) {
        const cont = document.getElementById(cid);
        cont.innerHTML = "";
        lista.forEach(i => {
            const b = document.createElement('div');
            b.className = 'option-btn';
            b.innerText = i;
            b.onclick = () => {
                b.classList.toggle('selected');
                let sel = Array.from(cont.querySelectorAll('.selected')).map(s => s.innerText);
                document.getElementById(hid).value = sel.join(", ");
            };
            cont.appendChild(b);
        });
    }

    async function enviar() {
        const btn = document.getElementById('btnSubmit');
        if(!ampmValue || !document.getElementById('input_fecha').value) return alert("Por favor complete Fecha y Hora (AM/PM)");
        
        btn.disabled = true; btn.innerText = "‚è≥ PROCESANDO...";

        const rawDate = document.getElementById('input_fecha').value.split("-");
        const formattedDate = `${rawDate[2]}/${rawDate[1]}/${rawDate[0]}`;
        document.getElementById('h_hora').value = document.getElementById('t_hora').value + " " + ampmValue;
        
        const params = new URLSearchParams(new FormData(document.getElementById('mainForm')));
        params.set("Fecha", formattedDate);
        
        const fotos = [document.getElementById('foto1'), document.getElementById('foto2'), document.getElementById('foto3')];
        let procesadas = 0; let conArchivo = fotos.filter(f => f.files[0]).length;

        if(conArchivo === 0) ejecutarFetch(params);
        else {
            fotos.forEach((f, i) => {
                if(f.files[0]) {
                    const r = new FileReader();
                    r.onload = (e) => {
                        params.append("fileData"+(i+1), e.target.result.split(',')[1]);
                        params.append("fileName"+(i+1), f.files[0].name);
                        params.append("mimeType"+(i+1), f.files[0].type);
                        if(++procesadas === conArchivo) ejecutarFetch(params);
                    };
                    r.readAsDataURL(f.files[0]);
                }
            });
        }
    }

    async function ejecutarFetch(p) {
        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
        
        setTimeout(() => {
            alert("‚úÖ ¬°Solicitud enviada con √©xito!");
            
            // Limpiar Formulario
            document.getElementById('mainForm').reset();
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.img-preview').forEach(img => img.src = "");
            ampmValue = "";
            document.getElementById('btnSubmit').disabled = false;
            document.getElementById('btnSubmit').innerText = "üöÄ ENVIAR SOLICITUD";

            // Saltar a la pesta√±a de Solicitudes y cargar resaltando la nueva
            showTab('listadoSec', document.getElementById('btn-list'));
            cargarSolicitudes(true);
        }, 2500);
    }

    async function cargarSolicitudes(esNueva = false) {
        const tabla = document.getElementById('cuerpoTabla');
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            
            if (data.length === 0) {
                tabla.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay registros.</td></tr>';
                return;
            }

            tabla.innerHTML = data.reverse().map((f, index) => {
                const esFilaNueva = (esNueva && index === 0);
                return `
                    <tr class="${esFilaNueva ? 'row-new' : ''}">
                        <td>${f.FechaReg}</td>
                        <td>${esFilaNueva ? 'üÜï ' : ''}<b>${f.Unidad}</b></td>
                        <td>${f.Jornada}</td>
                        <td><span class="badge ${f.Estatus}">${f.Estatus}</span></td>
                        <td class="${esAdmin ? '' : 'hidden'}">
                            <select onchange="cambiarEstatus('${f.id}', this.value)" style="font-size:11px;">
                                <option value="">...</option>
                                <option value="PENDIENTE">PENDIENTE</option>
                                <option value="EJECUTANDO">EJECUTANDO</option>
                                <option value="APROBADO">APROBADO</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join("");
        } catch(e) {
            tabla.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Error de conexi√≥n.</td></tr>';
        }
    }

    function accesoAdmin() {
        if(prompt("Clave:") === "Ipasme.2026.comu") {
            esAdmin = true;
            document.getElementById('colAdmin').classList.remove('hidden');
            cargarSolicitudes();
        }
    }

    async function cambiarEstatus(id, nuevo) {
        const p = new URLSearchParams({ action: "updateStatus", id: id, newStatus: nuevo });
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
        alert("Estatus actualizado.");
        cargarSolicitudes();
    }

    render('g_esp', listEsp, 'h_esp');
    render('g_ser', listSer, 'h_ser');
</script>
</body>
</html>
