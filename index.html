<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Artes IPASME</title>
    <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --azul: #1a4b8c; --verde: #28a745; --naranja: #fd7e14; --rojo: #dc3545; --fondo: #f4f7f9; --blanco: #ffffff; }
        body { font-family: 'Georama', sans-serif; background: var(--fondo); margin: 0; padding-bottom: 50px; }
        .nav-tabs { display: flex; background: var(--azul); padding: 10px; position: sticky; top: 0; z-index: 1000; justify-content: center; gap: 15px; }
        .tab-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 0.9em; }
        .tab-btn.active { background: var(--blanco); color: var(--azul); }
        
        .container { max-width: 950px; margin: 15px auto; background: var(--blanco); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 10px; }
        .section-title { font-weight: 700; color: var(--azul); margin-bottom: 12px; display: block; border-left: 5px solid var(--azul); padding-left: 10px; text-transform: uppercase; font-size: 0.85em; }
        
        .warning-box { background: #fff3cd; border-left: 5px solid #ffc107; padding: 12px; margin-bottom: 15px; font-size: 0.85em; color: #856404; border-radius: 5px; line-height: 1.4; }
        .error-msg { background: #fff5f5; border-color: #feb2b2; color: #c53030; font-size: 0.75em; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 5px solid #f56565; }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .option-btn { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.8em; transition: 0.3s; flex: 1; min-width: 130px; display: flex; align-items: center; justify-content: center; min-height: 45px; }
        .option-btn.selected { background: var(--verde); color: white; border-color: #1e7e34; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .ampm-group { display: flex; gap: 5px; width: 140px; }
        .ampm-btn { min-width: 60px; height: 40px; }

        .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; box-sizing: border-box; font-family: inherit; font-size: 0.9em; }
        
        .preview-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .img-preview { width: 100%; height: 90px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; background: #eee; }

        .btn-enviar { background: var(--azul); color: white; padding: 15px; width: 100%; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 700; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .btn-enviar:disabled { background: #ccc; cursor: not-allowed; }
        
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.75em; }
        .badge { padding: 4px 8px; border-radius: 10px; color: white; font-weight: bold; }
        .PENDIENTE { background: var(--rojo); }
        .EJECUTANDO { background: var(--naranja); }
        .APROBADO { background: var(--verde); }
    </style>
</head>
<body>

<nav class="nav-tabs">
    <button class="tab-btn active" onclick="showTab('formSec', this)">üìù NUEVA SOLICITUD</button>
    <button class="tab-btn" onclick="showTab('listadoSec', this); cargarSolicitudes();">‚è≥ COLA DE TRABAJO</button>
</nav>

<div id="formSec" class="container">
    <div class="warning-box">
        ‚ö†Ô∏è <b>REGLA DE ANTICIPACI√ìN:</b> El sistema detectar√° autom√°ticamente si el flyer tiene menos de <b>48 horas</b> de anticipo; de ser as√≠, la solicitud no proceder√°.
    </div>

    <form id="mainForm">
        <div class="section">
            <label class="section-title">üè¢ 1. Unidad Solicitante</label>
            <input type="text" name="Unidad" placeholder="Ejemplo: U.M.I. Caracas o U.M.I. La Guaira" required>
        </div>

        <div class="section">
            <label class="section-title">üè• 2. Tipo de Jornada</label>
            <div class="btn-group" id="j_grid">
                <div class="option-btn" onclick="selJornada(this)">Ipasme va a la Escuela</div>
                <div class="option-btn" onclick="selJornada(this)">Jornada de Atenci√≥n M√©dica Integral</div>
                <div class="option-btn" onclick="selJornada(this)">Jornada Conjunta</div>
                <div class="option-btn" onclick="selJornada(this)">Captaci√≥n Quir√∫rgica</div>
                <div class="option-btn" onclick="selJornada(this)">Otros</div>
            </div>
            <input type="hidden" name="Jornada" id="h_jornada" required>
        </div>

        <div id="sec_esp" class="section">
            <label class="section-title" id="tit_dinamico">ü©∫ 3. Especialidades</label>
            <div class="options-grid" id="g_esp"></div>
            <input type="hidden" name="Especialidades" id="h_esp">
        </div>

        <div id="sec_ser" class="section">
            <label class="section-title">‚ú® 4. Servicios Adicionales</label>
            <div class="options-grid" id="g_ser"></div>
            <input type="hidden" name="Servicios" id="h_ser">
        </div>

        <div class="section">
            <label class="section-title">üìÖ 5. Fecha y Hora del Evento</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <input type="date" name="Fecha" id="f_evento" required>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="t_hora" placeholder="08:00" style="width: 75px;">
                    <div class="ampm-group">
                        <div class="option-btn ampm-btn" id="am" onclick="selAMPM('a. m.')">a. m.</div>
                        <div class="option-btn ampm-btn" id="pm" onclick="selAMPM('p. m.')">p. m.</div>
                    </div>
                </div>
            </div>
            <input type="hidden" name="Hora" id="h_hora">
        </div>

        <div class="section">
            <label class="section-title">üìç 6. Direcci√≥n Exacta</label>
            <div class="error-msg">
                üì¢ <b>ADVERTENCIA:</b> La direcci√≥n debe estar correctamente escrita y verificada. De lo contrario, la solicitud pasar√° de √∫ltima a la fila o se retrasar√° significativamente.
            </div>
            <textarea name="Direccion" placeholder="Indique calle, punto de referencia y parroquia..." required style="height: 70px;"></textarea>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <input type="text" name="Telefono" placeholder="üìû Tel√©fono de contacto" required>
                <input type="email" name="Correo" placeholder="üìß Correo Institucional" required>
            </div>
        </div>

        <div class="section">
            <label class="section-title">üì∏ 7. Soportes (Visor de Im√°genes)</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-bottom:10px;">
                <input type="file" id="foto1" accept="image/*" onchange="preview(this, 'p1')">
                <input type="file" id="foto2" accept="image/*" onchange="preview(this, 'p2')">
                <input type="file" id="foto3" accept="image/*" onchange="preview(this, 'p3')">
            </div>
            <div class="preview-container">
                <img id="p1" class="img-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ddd' d='M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z'/%3E%3C/svg%3E">
                <img id="p2" class="img-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ddd' d='M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z'/%3E%3C/svg%3E">
                <img id="p3" class="img-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ddd' d='M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z'/%3E%3C/svg%3E">
            </div>
        </div>

        <button type="button" class="btn-enviar" id="btnSubmit" onclick="enviar()">üöÄ PROCESAR SOLICITUD</button>
    </form>
</div>

<div id="listadoSec" class="container hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="color:var(--azul); margin:0;">üìä Estatus y Cola de Trabajo</h3>
        <button onclick="accesoAdmin()" style="cursor:pointer; padding:6px 12px; border-radius:5px; border:1px solid #ccc; font-size: 0.8em;">üîë Modo Admin</button>
    </div>
    <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Reg. (Fecha/Hora)</th>
                    <th>Unidad</th>
                    <th>Jornada</th>
                    <th>Fecha Evento</th>
                    <th>Estatus</th>
                    <th class="admin-col hidden">Gesti√≥n</th>
                </tr>
            </thead>
            <tbody id="cuerpoTabla"></tbody>
        </table>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyGDwFhQzaPG_11fKSpiJSe92FxlT7ihGfDYS3fs9BJ2oPk2t4I_9Rlt3X0CzRMggr4/exec';
    
    const listEsp = ["Alergolog√≠a", "Cardiolog√≠a", "Cirug√≠a general", "Dermatolog√≠a", "Ecograf√≠a", "Fisiatr√≠a", "Gastroenterolog√≠a", "Geriatr√≠a", "Gerontolog√≠a", "Ginecolog√≠a y obstetricia", "Medicina familiar", "Medicina general", "Medicina interna", "Nefrolog√≠a", "Neumolog√≠a", "Neurolog√≠a", "Nutrici√≥n", "Odontolog√≠a", "Oftalmolog√≠a", "Oncolog√≠a", "Optometr√≠a", "Pediatr√≠a", "Psicolog√≠a", "Psiquiatr√≠a", "Reumatolog√≠a", "Traumatolog√≠a", "Urolog√≠a"];
    const listPat = ["Hernia inguinal", "Hernia umbilical", "Hernia abdominal", "Hernia epig√°strica", "Hernia escrotal", "Fimosis", "Vasectom√≠a", "Varicocele", "Hidrocele", "Litiasis vesicular", "Colectom√≠a", "Lipomas", "Quiste tirogloso", "Quiste seb√°ceo", "Esterilizaci√≥n", "Miomatosis uterina", "Tumores ov√°ricos", "Prolapso", "Histerectom√≠a", "Catarata", "Pterigi√≥n", "Glaucoma", "Retinoblastoma"];
    const listSer = ["Fisioterapia", "Inmunizaci√≥n", "Control de talla y peso", "Despistaje HTA", "Afiliaci√≥n", "Sesi√≥n educativa", "Farmacia", "Captaci√≥n quir√∫rgica general", "Captaci√≥n quir√∫rgica oftalmol√≥gica", "Servicios sociales", "Masoterapia", "Terapia ocupacional", "Desparasitaci√≥n", "Bienestar social"];

    let ampmValue = "";
    let isAdmin = false;

    function showTab(id, b) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
    }

    function selAMPM(val) {
        document.querySelectorAll('.ampm-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(val === 'a. m.' ? 'am' : 'pm').classList.add('selected');
        ampmValue = val;
    }

    function preview(input, id) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) { document.getElementById(id).src = e.target.result; }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function selJornada(el) {
        document.querySelectorAll('#j_grid .option-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        const v = el.innerText;
        document.getElementById('h_jornada').value = v;

        if(v === "Captaci√≥n Quir√∫rgica") {
            document.getElementById('tit_dinamico').innerHTML = "ü©∫ 3. Patolog√≠as";
            render('g_esp', listPat, 'h_esp');
            document.getElementById('sec_ser').classList.add('hidden');
        } else {
            document.getElementById('tit_dinamico').innerHTML = "ü©∫ 3. Especialidades";
            render('g_esp', listEsp, 'h_esp');
            document.getElementById('sec_ser').classList.remove('hidden');
            render('g_ser', listSer, 'h_ser');
        }
    }

    function render(cid, lista, hid) {
        const cont = document.getElementById(cid);
        cont.innerHTML = "";
        lista.forEach(i => {
            const b = document.createElement('div');
            b.className = 'option-btn';
            b.innerText = i;
            b.onclick = () => {
                b.classList.toggle('selected');
                let sel = Array.from(cont.querySelectorAll('.selected')).map(s => s.innerText);
                document.getElementById(hid).value = sel.join(", ");
            };
            cont.appendChild(b);
        });
    }

    async function enviar() {
        const fechaE = document.getElementById('f_evento').value;
        if (fechaE) {
            const fSeleccionada = new Date(fechaE);
            const hoy = new Date();
            const diff = (fSeleccionada - hoy) / (1000 * 60 * 60);
            if (diff < 48) {
                alert("‚ùå La solicitud no puede proceder: Debe tener un m√≠nimo de 48 horas de anticipaci√≥n.");
                return;
            }
        }

        const f = document.getElementById('mainForm');
        if(!f.checkValidity() || !ampmValue) return alert("Por favor complete todos los campos y seleccione el horario (a. m. / p. m.).");
        
        document.getElementById('h_hora').value = document.getElementById('t_hora').value + " " + ampmValue;
        const btn = document.getElementById('btnSubmit');
        btn.disabled = true; btn.innerText = "‚è≥ ENVIANDO...";

        const params = new URLSearchParams(new FormData(f));
        const fotos = [document.getElementById('foto1'), document.getElementById('foto2'), document.getElementById('foto3')].filter(x => x.files.length > 0);

        if(fotos.length > 0) {
            let proc = 0;
            fotos.forEach((input, i) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    params.append("fileData" + (i+1), e.target.result.split(',')[1]);
                    params.append("fileName" + (i+1), input.files[0].name);
                    params.append("mimeType" + (i+1), input.files[0].type);
                    if(++proc === fotos.length) ejecutarFetch(params);
                };
                reader.readAsDataURL(input.files[0]);
            });
        } else { ejecutarFetch(params); }
    }

    async function ejecutarFetch(p) {
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
            alert("‚úÖ Solicitud enviada exitosamente.");
            location.reload();
        } catch(e) { alert("Error de conexi√≥n."); btn.disabled = false; }
    }

    async function cargarSolicitudes() {
        const tbody = document.getElementById('cuerpoTabla');
        tbody.innerHTML = "<tr><td colspan='6'>Cargando registros...</td></tr>";
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            tbody.innerHTML = data.reverse().map(f => {
                return `<tr>
                    <td><b>${f.FechaReg || "---"}</b></td>
                    <td>${f.Unidad || "---"}</td>
                    <td>${f.Jornada || "---"}</td>
                    <td>${f.FechaEvento || "---"}</td>
                    <td><span class="badge ${f.Estatus}">${f.Estatus}</span></td>
                    <td class="admin-col ${isAdmin ? '' : 'hidden'}">
                        <select onchange="cambiarEstatus('${f.id}', this.value)">
                            <option value="">Cambiar...</option>
                            <option value="PENDIENTE">PENDIENTE</option>
                            <option value="EJECUTANDO">EJECUTANDO</option>
                            <option value="APROBADO">APROBADO</option>
                        </select>
                    </td>
                </tr>`
            }).join("");
        } catch(e) { tbody.innerHTML = "<tr><td colspan='6'>Error al conectar con la base de datos.</td></tr>"; }
    }

    function accesoAdmin() {
        if(prompt("Usuario:") === "MD-comunicaciones" && prompt("Clave:") === "Ipasme.2026.comu") {
            isAdmin = true;
            document.querySelectorAll('.admin-col').forEach(c => c.classList.remove('hidden'));
            alert("Acceso administrativo concedido.");
            cargarSolicitudes();
        }
    }

    async function cambiarEstatus(id, nuevo) {
        if(!nuevo) return;
        const p = new URLSearchParams({ action: "updateStatus", id: id, newStatus: nuevo });
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
        alert("Estatus actualizado.");
        cargarSolicitudes();
    }

    render('g_esp', listEsp, 'h_esp');
    render('g_ser', listSer, 'h_ser');
</script>
</body>
</html>
