<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!-- âœ¨ SONIDO DE NOTIFICACIÃ“N (CDN Externo) -->
<audio id="notificationSound" preload="auto">
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mp3">
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.wav" type="audio/wav">
</audio>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIRA 2.5 | Sistema Integral de Requerimientos de Artes</title>
<link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600;800&display=swap" rel="stylesheet">
<style>
:root {
--celeste: #8ecae6;
--turquesa: #219ebc;
--azul-deep: #023047;
--amarillo: #ffb703; --naranja: #fb8500; --rojo: #e63946;
--verde: #2d6a4f; --gris: #edf2f4;
--panel-width: 380px;
}
* { font-family: 'Georama', sans-serif;
box-sizing: border-box; font-weight: 500; }
body { background: #f4f7fa; margin: 0; padding-bottom: 50px; color: var(--azul-deep); }
header { background: var(--azul-deep);
padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; min-height: 55px;
flex-wrap: wrap;
gap: 10px;
}
.brand-container { display: flex; flex-direction: column; align-items: flex-start; flex: 1; min-width: 150px; }
.header-title { margin: 0; font-size: 1.2rem; font-weight: 800; color: white;
line-height: 1; }
.acronimo { font-size: 0.5rem; font-weight: 400; letter-spacing: 0.5px; margin-top: 2px; opacity: 0.9; text-transform: uppercase; color: white; max-width: 250px;
}
.nav-tabs { display: flex; justify-content: center; gap: 10px; flex: 1; min-width: 200px; flex-wrap: wrap; }
.tab-btn { padding: 6px 16px; border-radius: 20px; border: none;
cursor: pointer; font-weight: 800; text-transform: uppercase; font-size: 0.75rem; background: rgba(255,255,255,0.1); color: white; transition: 0.3s; display: flex; align-items: center; gap: 6px;
}
.tab-btn.active { background: var(--amarillo); color: var(--azul-deep); }
.admin-access { flex: 1; display: flex; flex-direction: row; align-items: center; gap: 8px; min-width: 280px; flex-wrap: wrap; justify-content: flex-end; }
/* âœ… ESTILO PARA MENSAJE DE BIENVENIDA - MÃS LLAMATIVO */
.welcome-message {
font-size: 1rem;
font-weight: 800;
color: white;
background: linear-gradient(135deg, var(--amarillo) 0%, var(--naranja) 100%);
padding: 8px 16px;
border-radius: 25px;
display: none;
box-shadow: 0 4px 15px rgba(251, 133, 0, 0.4);
border: 2px solid rgba(255, 255, 255, 0.3);
text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
letter-spacing: 0.5px;
}
.welcome-message.show {
display: block;
animation: fadeInDown 0.6s ease-out;
}
@keyframes fadeInDown {
from {
opacity: 0;
transform: translateY(-20px) scale(0.95);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}
/* âœ… ESTILO PARA CONTENEDOR DE BOTONES EN HORIZONTAL */
.admin-buttons {
display: flex;
gap: 8px;
justify-content: flex-end;
flex-wrap: nowrap;
align-items: center;
}
.btn-login { background: var(--amarillo);
border: none; padding: 6px 12px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.7rem; box-shadow: 0 3px 0 #c79100; transition: 0.2s;
min-width: 100px;
}
.btn-login:active { transform: translateY(2px); box-shadow: 0 1px 0 #c79100; }
.btn-logout { background: var(--rojo); color: white; border: none; padding: 6px 12px;
border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.7rem; min-width: 100px;
}
.row-new { background-color: #e3f2fd !important; border-left: 5px solid var(--turquesa) !important;
}
.row-obituario { background-color: #ffebee !important; border-left: 5px solid var(--rojo) !important; }
.badge-new { background: var(--turquesa); color: white; padding: 2px 8px;
border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; animation: blink 2s infinite; }
.badge-prioridad { background: white; color: var(--rojo);
padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; border: 1px solid var(--rojo);
}
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1;
} }
.stats-grid { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.stat-card { flex: 1; min-width: 100px;
padding: 8px; border-radius: 12px; text-align: center; color: white; font-weight: 800; }
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep);
}
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }
/* âœ… ESTILOS PARA CONTADORES DE DISEÃ‘ADORES */
.stat-bermina { background: var(--naranja); color: white; }
.stat-jorsy { background: var(--azul-deep); color: white; }
.stat-maria { background: var(--verde); color: white; }
.stat-xamir { background: var(--amarillo); color: var(--azul-deep); }
.stat-label { font-size: 0.6rem; text-transform: uppercase; display: block; opacity: 0.8;
}
.stat-val { font-size: 1.1rem; }
.container { max-width: 1200px; margin: 15px auto; padding: 25px; background: white; border-radius: 25px;
box-shadow: 0 15px 40px rgba(0,0,0,0.06); }
.aviso-48h { background: #fff3e0; border: 2.5px solid var(--naranja); color: var(--naranja); padding: 15px; border-radius: 15px;
text-align: center; font-weight: 800; margin-bottom: 25px; font-size: 1.1rem; }
.section-title { display: block; font-weight: 800; font-size: 0.85rem;
color: var(--turquesa); margin: 20px 0 12px; border-left: 4px solid var(--turquesa); padding-left: 10px; text-transform: uppercase; }
.category-row { display: grid;
grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }
.card-btn { background: #fff; border: 2px solid var(--gris); border-radius: 12px; padding: 6px 4px;
cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 800; font-size: 0.75rem; min-height: 45px; line-height: 1.1;
color: var(--azul-deep); }
.card-btn.selected { background: var(--amarillo); border-color: var(--naranja); transform: scale(0.98); }
.field-error { border: 2px solid var(--rojo) !important;
animation: border-blink 0.8s infinite alternate !important; background: #fff5f5 !important; }
@keyframes border-blink { from { border-color: var(--rojo);
box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); } to { border-color: transparent; box-shadow: none; } }
.btn-time { padding: 8px;
border-radius: 12px; border: 2px solid var(--gris); cursor: pointer; font-weight: 800; font-size: 0.85rem; background: #f8f9fa; color: var(--azul-deep); flex: 1; transition: 0.3s;
}
.btn-time.active { background: var(--azul-deep); color: white; border-color: var(--azul-deep); }
/* âœ… Estilo mejorado para botÃ³n Obituario */
#btn-obituario {
padding: 6px 12px !important;
font-size: 0.75rem !important;
min-width: auto !important;
width: auto !important;
height: auto !important;
border-radius: 8px !important;
}
#btn-obituario.obit-active {
background: var(--azul-deep) !important;
color: white !important;
border-color: var(--azul-deep) !important;
}
.modern-input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--gris); font-size: 0.95rem;
outline: none; transition: 0.3s; background: #fdfdfd; font-weight: 500; }
.modern-input:focus { border-color: var(--turquesa); background: white; }
.pass-container { position: relative; width: 100%;
}
.eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem; opacity: 0.6; z-index: 10;
}
.photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
.upload-box { height: 90px; border: 2.5px dashed var(--celeste);
border-radius: 15px; position: relative; overflow: hidden; background: #f0f9ff; }
.upload-label { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;
cursor: pointer; font-size: 0.7rem; font-weight: 800; color: var(--turquesa); text-align: center; }
.preview { position: absolute; top: 0; left: 0; width: 100%;
height: 100%; object-fit: cover; display: none; }
.remove-btn { position: absolute; top: 5px; right: 5px; background: var(--rojo); color: white; border: none;
border-radius: 50%; width: 25px; height: 25px; font-weight: 800; cursor: pointer; display: none; z-index: 10; }
.btn-send { background: var(--azul-deep); color: white;
width: 100%; padding: 14px; border-radius: 18px; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 30px;
box-shadow: 0 6px 15px rgba(2, 48, 71, 0.3); transition: 0.3s; }
.btn-send:hover { transform: translateY(-2px); background: #054a6d; }
.modal-overlay { position: fixed;
top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.85); backdrop-filter: blur(8px); display: none; align-items: center;
justify-content: center; z-index: 20000; padding: 20px; }
.modal-content { background: white; padding: 40px 30px; border-radius: 30px; max-width: 450px; width: 100%;
text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative; }
/* MODAL CONFIRMACIÃ“N */
#confirmModal .modal-content { max-width: 600px; padding: 30px;
}
#previewContent { text-align: left; max-height: 400px; overflow-y: auto; margin-bottom: 20px; }
#previewContent p { margin: 8px 0; line-height: 1.4;
}
/* MODAL MANTENIMIENTO */
#maintOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--azul-deep); z-index: 10000;
display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
.modal-btn { background: var(--turquesa); color: white; border: none;
padding: 12px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 25px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
.modal-btn:hover { background: var(--azul-deep);
}
.modal-btn-alt { background: var(--gris); color: var(--azul-deep); margin-top: 10px; }
/* âœ… NUEVA CLASE PARA BOTONES IGUALES EN MODAL DE CONFIRMACIÃ“N */
.modal-btn-confirm {
flex: 1;
min-width: 140px;
padding: 12px;
font-size: 1rem;
font-weight: 800;
border-radius: 12px;
border: none;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
text-align: center;
}
.modal-btn-confirm.corregir {
background: var(--gris);
color: var(--azul-deep);
}
.modal-btn-confirm.enviar {
background: var(--turquesa);
color: white;
}
.modal-btn-confirm:disabled {
background: #e9ecef;
color: #495057;
cursor: not-allowed;
}
/* âœ… TABLA: DISEÃ‘O LIMPIO Y ESPACIADO */
.table-container {
width: 100%;
overflow-x: auto;
margin-top: 10px;
border-radius: 12px;
box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
table {
width: 100%;
border-collapse: separate; /* âœ… MEJOR QUE COLLAPSE PARA BORDES REDONDEADOS */
border-spacing: 0;
min-width: 1000px; /* âœ… MÃS ANCHO PARA EVITAR AMONTONAMIENTO */
background: white;
}
th {
background: #f1f5f9;
padding: 12px 15px; /* âœ… MÃS ESPACIO VERTICAL */
text-align: left;
font-size: 0.7rem;
text-transform: uppercase;
font-weight: 800;
color: var(--turquesa);
border-bottom: 2px solid var(--celeste);
white-space: nowrap; /* âœ… EVITA QUE LOS TÃTULOS SE ROMPAN */
}
td {
padding: 14px 15px; /* âœ… FILAS MÃS ALTAS Y LEGIBLES */
border-bottom: 1px solid #edf2f4;
font-size: 0.85rem;
line-height: 1.4;
color: #334155;
font-weight: 500;
vertical-align: middle;
}
td.admin-actions-cell {
    vertical-align: middle;
    padding: 14px 15px; /* Mismo padding que las otras celdas */
    text-align: right;
    border-bottom: 1px solid #edf2f4; /* Asegura el borde */
}

.admin-actions-content {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
    align-items: center;
    white-space: nowrap;
    font-size: 0.75rem;
    color: #fb8500;
    font-weight: 700;
}

.admin-actions-content span:first-child {
    display: inline-block;
    line-height: 1;
    font-size: 1.3rem;
    vertical-align: middle;
}

.admin-actions-content span:last-child {
    display: inline-block;
    line-height: 1.2;
    vertical-align: middle;
}

/* âœ… CÃRCULO DE DISEÃ‘ADOR EN TABLA */
.designer-circle {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
    margin-top: 2px;
}

/* âœ… STATUS PILL */
.status-pill {
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 0.6rem;
    font-weight: 800;
    text-transform: uppercase;
    transition: 0.3s;
    display: inline-block;
    vertical-align: middle;
}
.status-pendiente { background: var(--celeste); color: var(--azul-deep); }
.status-procesando { background: var(--amarillo); color: var(--azul-deep); }
.status-finalizada { background: var(--verde); color: white; }

/* âœ… UTILIDADES DE TEXTO */
.txt-bold { font-weight: 800; color: var(--azul-deep); }
.txt-small { font-size: 0.72rem; color: #4b4b4b; display: block; margin-bottom: 1px; font-weight: 500; }

.btn-act { border: none; border-radius: 5px; padding: 4px 6px;
cursor: pointer; font-size: 9px; color: white; font-weight: 800; transition: 0.2s; }
.btn-act:hover { transform: scale(1.1); }
.bg-pend { background: var(--celeste); color: var(--azul-deep);
}
.bg-proc { background: var(--amarillo); color: var(--azul-deep); }
.bg-fin { background: var(--verde); }
.btn-trash { background: none; border: none; cursor: pointer; font-size: 1.1rem;
margin-left: 8px; filter: grayscale(1); transition: 0.3s; }
.btn-trash:hover { filter: grayscale(0); transform: rotate(10deg);
}
/* Nuevos Estilos Botones Admin */
/* âœ… BOTÃ“N ADJUNTAR CORREGIDO: Icono + texto compacto */
.btn-arte {
background: #4a90e2;
color: white;
border: none;
border-radius: 5px;
padding: 3px 6px;
font-size: 9px;
font-weight: 800;
cursor: pointer;
white-space: nowrap;
min-width: auto;
width: auto;
}
.btn-ver { background: #f39c12; color: white; border: none; border-radius: 5px; padding: 4px 6px; font-size: 9px;
font-weight: 800; cursor: pointer; text-decoration: none; }
.btn-tg { background: #0088cc; color: white; border: none; border-radius: 5px; padding: 4px 6px;
font-size: 9px; font-weight: 800; cursor: pointer; }
.hidden { display: none !important; }
.page { display: none; }
.page.active { display: block;
}
#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.95); display: none;
flex-direction: column; align-items: center; justify-content: center; z-index: 30000; color: white; text-align: center; padding: 20px; }
.spinner { width: 60px; height: 60px;
border: 6px solid rgba(255,255,255,0.1); border-top: 6px solid var(--amarillo); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 25px;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
/* âœ… Estilo para campos deshabilitados en modo obituario */
.obit-disabled {
background-color: #e9ecef !important;
color: #6c757d !important;
cursor: not-allowed !important;
}
.obit-upload-box {
background: #e9ecef !important;
border-color: #ced4da !important;
cursor: not-allowed !important;
}
.obit-upload-label {
color: #6c757d !important;
cursor: not-allowed !important;
}
/* âœ… ESTILOS PARA BOTÃ“N DE REPORTE MENSUAL - SOLO HABILITADO 1Â° DE MES */
#reportBtn {
position: relative;
overflow: hidden;
display: flex;
align-items: center;
gap: 6px;
white-space: nowrap;
}
#reportBtn:disabled {
opacity: 0.65;
cursor: not-allowed !important;
transform: none !important;
box-shadow: 0 3px 0 #1a3d2d !important;
}
#reportBtn:not(:disabled):hover {
transform: translateY(-2px);
box-shadow: 0 5px 0 #1a3d2d;
}
#reportBtn:not(:disabled):active {
transform: translateY(1px);
box-shadow: 0 2px 0 #1a3d2d;
}
#reportBtnText {
display: inline;
transition: opacity 0.3s;
}
.report-days-badge {
font-size: 0.6rem;
background: rgba(255,255,255,0.2);
padding: 2px 6px;
border-radius: 10px;
font-weight: 600;
display: none;
}
.report-days-badge.show {
display: inline-block;
}
/* âœ… MEJORAS RESPONSIVE PARA MÃ“VIL */
@media (max-width: 768px) {
/* Header reorganizado para mÃ³vil */
header {
flex-direction: column;
align-items: center;
padding: 10px 15px;
min-height: auto;
gap: 8px;
}
.brand-container {
width: 100%;
align-items: center;
margin-bottom: 0;
}
.header-title {
font-size: 1.4rem;
text-align: center;
}
.acronimo {
font-size: 0.6rem;
text-align: center;
max-width: 100%;
}
.nav-tabs {
width: 100%;
justify-content: center;
flex-wrap: wrap;
gap: 6px;
margin: 8px 0 0 0;
}
.tab-btn {
padding: 5px 12px;
font-size: 0.7rem;
min-width: 100px;
}
.admin-access {
width: 100%;
align-items: center;
justify-content: center;
flex-wrap: wrap;
gap: 6px;
margin-top: 5px;
}
.welcome-message {
font-size: 0.85rem;
padding: 5px 10px;
}
.admin-buttons {
justify-content: center;
width: 100%;
flex-wrap: wrap;
}
.btn-login, .btn-logout {
padding: 5px 8px;
font-size: 0.6rem;
min-width: auto;
}
/* Contenedores de stats en columnas */
.stats-grid {
flex-direction: column;
gap: 8px;
}
.stat-card {
min-width: 100%;
padding: 10px;
}
/* Tabla mÃ¡s compacta */
th, td {
padding: 4px 6px;
font-size: 0.75rem;
}
.status-pill {
padding: 2px 8px;
font-size: 0.55rem;
}
.txt-small {
font-size: 0.65rem;
}
.admin-actions {
flex-direction: column;
align-items: flex-end;
gap: 4px;
}
.btn-act, .btn-arte, .btn-ver, .btn-tg, .btn-trash {
width: 100%;
justify-content: center;
font-size: 0.75rem;
padding: 3px;
}
/* Formulario mÃ¡s compacto */
.section-title {
font-size: 0.8rem;
margin: 15px 0 10px;
}
.modern-input {
padding: 10px;
font-size: 0.85rem;
}
.card-btn {
min-height: 40px;
font-size: 0.7rem;
padding: 4px 2px;
}
.btn-send {
padding: 12px;
font-size: 1rem;
}
/* Modales mÃ¡s compactos */
.modal-content {
padding: 25px 20px;
margin: 10px;
}
.modal-btn {
padding: 10px;
font-size: 0.95rem;
}
}
/* âœ… ESTILOS PARA BUSCADOR DE ID - DISEÃ‘ADOR */
#designer-search-container {
transition: all 0.3s ease;
margin: 15px 0;
padding: 12px;
background: #fff3e0;
border-radius: 12px;
border: 2px solid #ffb703;
}
#designer-search-container.hidden {
display: none;
}
#searchIdInput {
transition: all 0.3s ease;
}
#searchIdInput:focus {
border-color: #fb8500;
box-shadow: 0 0 0 3px rgba(251, 133, 0, 0.2);
}
/* âœ… EFECTOS DE RESALTADO Y BLOQUEO */
.row-highlighted {
background-color: #fff3e0 !important;
border-left: 5px solid #fb8500 !important;
animation: highlightPulse 0.8s ease;
}
.row-locked {
opacity: 0.3 !important;
pointer-events: none !important;
transition: opacity 0.4s ease, transform 0.4s ease;
}
.row-locked:hover {
cursor: not-allowed !important;
}
/* âœ… BOTONES DESHABILITADOS EN FILAS BLOQUEADAS */
.row-locked .btn-arte,
.row-locked .btn-ver,
.row-locked .btn-tg {
opacity: 0.4 !important;
cursor: not-allowed !important;
pointer-events: none !important;
}
/* âœ… ANIMACIÃ“N DE RESALTADO */
@keyframes highlightPulse {
0%, 100% {
box-shadow: 0 0 0 0 rgba(251, 133, 0, 0.4);
}
50% {
box-shadow: 0 0 0 10px rgba(251, 133, 0, 0);
}
}
/* âœ… ESTILO PARA INDICADOR DE BÃšSQUEDA ACTIVA */
.search-active-indicator {
position: absolute;
top: -8px;
right: -8px;
background: #fb8500;
color: white;
width: 20px;
height: 20px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.7rem;
font-weight: 800;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
/* âœ… MENSAJE DE NO COINCIDENCIAS */
.no-results-message {
text-align: center;
padding: 20px;
color: #6c757d;
font-weight: 600;
font-size: 0.9rem;
background: #f8f9fa;
border-radius: 8px;
margin-top: 10px;
display: none;
}
.no-results-message.show {
display: block;
animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(-10px); }
to { opacity: 1; transform: translateY(0); }
}
/* âœ… BOTÃ“N DE LIMPIAR BÃšSQUEDA */
.clear-search-btn {
background: #e9ecef;
border: none;
border-radius: 6px;
padding: 6px 12px;
font-weight: 600;
font-size: 0.8rem;
cursor: pointer;
transition: all 0.3s ease;
margin-left: 8px;
}
.clear-search-btn:hover {
background: #dee2e6;
transform: scale(1.05);
}
.clear-search-btn:active {
transform: scale(0.95);
}
/* âœ… ESTILO PARA CONTENEDOR DE BOTÃ“N DE LIMPIEZA */
.search-controls {
display: flex;
align-items: center;
gap: 8px;
margin-top: 8px;
}
/* âœ… INDICADOR DE FILTRO ACTIVO */
.filter-badge {
display: inline-block;
background: linear-gradient(135deg, #fb8500 0%, #ffb703 100%);
color: white;
padding: 4px 12px;
border-radius: 20px;
font-size: 0.75rem;
font-weight: 800;
margin-left: 10px;
animation: badgePulse 2s infinite;
}
@keyframes badgePulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

/* âœ¨ ANIMACIÃ“N DE PULSOS PARA BOTÃ“N DE ENVÃO */
.btn-send-pulse {
  animation: pulse 1.5s infinite;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 150, 255, 0.3) !important;
}

@keyframes pulse {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 150, 255, 0.4); }
  70% { transform: scale(1.05); box-shadow: 0 0 0 12px rgba(0, 150, 255, 0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 150, 255, 0); }
}

/* âœ¨ ESTILO PARA TEXTO EN DOS LÃNEAS */
.btn-text {
  display: flex;
  flex-direction: column;
  text-align: center;
  line-height: 1.2;
  margin: 0;
  padding: 0;
}

.btn-text span {
  display: block;
  margin: 0;
  padding: 0;
}

/* âœ… ESTILOS PARA CONTADORES COMBINADOS (ADMIN - TEXTO COMPLETO) */
.combined-stats {
  display: flex;
  justify-content: flex-start;
  gap: 6px;
  margin-bottom: 10px;
  flex-wrap: wrap;
  align-items: center;
}
.stat-mini {
  min-width: 95px; /* Ancho suficiente para texto completo */
  padding: 6px 10px;
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 0.78rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
}
.stat-mini:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}
.stat-mini .stat-label {
  font-size: 0.68rem;
  font-weight: 700;
  margin-bottom: 3px;
  text-transform: none;
  letter-spacing: -0.3px;
  line-height: 1.2;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-align: center;
}
.stat-mini .stat-val {
  font-size: 1.05rem;
  font-weight: 800;
  line-height: 1;
}
/* âœ… Mantener colores existentes */
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep); }
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }
.stat-bermina { background: var(--naranja); color: white; }
.stat-jorsy { background: var(--azul-deep); color: white; }
.stat-maria { background: var(--verde); color: white; }
.stat-xamir { background: var(--amarillo); color: var(--azul-deep); }

/* âœ… Responsive: Ajustar en pantallas pequeÃ±as */
@media (max-width: 1024px) {
  .stat-mini { min-width: 85px; padding: 5px 8px; }
  .stat-mini .stat-label { font-size: 0.62rem; }
  .stat-mini .stat-val { font-size: 0.95rem; }
}
@media (max-width: 768px) {
  .combined-stats { gap: 4px; }
  .stat-mini { min-width: 75px; padding: 4px 6px; font-size: 0.72rem; }
  .stat-mini .stat-label { font-size: 0.58rem; line-height: 1.1; }
  .stat-mini .stat-val { font-size: 0.9rem; }
}

/* âœ… PANEL LATERAL DERECHO - ESTILOS COMPLETOS */
.side-panel {
position: fixed;
top: 0;
right: 0;
width: var(--panel-width);
height: 100vh;
background: white;
box-shadow: -8px 0 40px rgba(0,0,0,0.2);
z-index: 1000;
transform: translateX(100%);
transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
display: flex;
flex-direction: column;
border-left: 5px solid var(--turquesa);
}

.side-panel.active {
transform: translateX(0);
}

.side-panel-header {
background: var(--azul-deep);
color: white;
padding: 15px 20px;
display: flex;
align-items: center;
justify-content: space-between;
border-bottom: 4px solid var(--amarillo);
position: relative;
}

.side-panel-title {
font-weight: 800;
font-size: 1.1rem;
display: flex;
align-items: center;
gap: 10px;
}

.side-panel-close {
background: rgba(255,255,255,0.15);
border: none;
color: white;
width: 36px;
height: 36px;
border-radius: 50%;
font-size: 1.4rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s;
}

.side-panel-close:hover {
background: rgba(255,255,255,0.3);
transform: rotate(90deg);
}

.side-panel-content {
flex: 1;
overflow-y: auto;
padding: 20px;
display: flex;
flex-direction: column;
gap: 18px;
}

/* SecciÃ³n de solicitud seleccionada */
.selected-request-section {
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
border-radius: 16px;
padding: 18px;
border: 2px solid var(--celeste);
position: relative;
}

.selected-request-header {
font-weight: 800;
color: var(--azul-deep);
font-size: 0.8rem;
margin-bottom: 12px;
display: flex;
align-items: center;
gap: 8px;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.selected-request-id {
font-size: 1.2rem;
font-weight: 800;
color: var(--turquesa);
word-break: break-all;
line-height: 1.3;
}

.selected-request-info {
font-size: 0.8rem;
color: #495057;
margin-top: 10px;
line-height: 1.5;
}

.no-selection {
text-align: center;
color: #adb5bd;
padding: 25px 15px;
}

.no-selection-icon {
font-size: 3rem;
margin-bottom: 12px;
opacity: 0.6;
}

/* Vista previa de archivo - IMAGEN COMPLETA A ESCALA */
.file-preview-section {
background: #f8f9fa;
border-radius: 16px;
padding: 18px;
border: 2px dashed var(--celeste);
}

.file-preview-header {
font-weight: 800;
color: var(--azul-deep);
font-size: 0.8rem;
margin-bottom: 12px;
display: flex;
align-items: center;
gap: 8px;
text-transform: uppercase;
}

.file-preview-container {
width: 100%;
height: 200px;
background: white;
border-radius: 12px;
overflow: hidden;
display: flex;
align-items: center;
justify-content: center;
border: 2px solid var(--gris);
position: relative;
}

.file-preview-image-full {
max-width: 100%;
max-height: 100%;
width: auto;
height: auto;
object-fit: contain;
cursor: pointer;
transition: transform 0.3s;
}

.file-preview-image-full:hover {
transform: scale(1.05);
}

.file-preview-placeholder {
text-align: center;
color: #adb5bd;
font-size: 0.85rem;
padding: 20px;
}

.file-preview-placeholder-icon {
font-size: 2.5rem;
margin-bottom: 8px;
opacity: 0.5;
}

.file-preview-info {
font-size: 0.75rem;
color: #6c757d;
margin-top: 10px;
text-align: center;
}

/* Botones del panel */
.panel-section-title {
font-size: 0.7rem;
font-weight: 800;
text-transform: uppercase;
color: var(--turquesa);
letter-spacing: 0.8px;
margin-bottom: 10px;
padding-left: 5px;
display: flex;
align-items: center;
gap: 6px;
}

.panel-actions {
display: flex;
flex-direction: column;
gap: 8px;
}

.panel-btn {
width: 100%;
padding: 12px 15px;
border: none;
border-radius: 10px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.25s ease;
display: flex;
align-items: center;
gap: 10px;
text-align: left;
position: relative;
}

.panel-btn:disabled {
opacity: 0.4;
cursor: not-allowed;
transform: none !important;
}

.panel-btn:not(:disabled):hover {
transform: translateX(5px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.panel-btn-primary { background: var(--turquesa); color: white; }
.panel-btn-success { background: var(--verde); color: white; }
.panel-btn-warning { background: var(--amarillo); color: var(--azul-deep); }
.panel-btn-danger { background: var(--rojo); color: white; }
.panel-btn-info { background: var(--celeste); color: var(--azul-deep); }
.panel-btn-secondary { background: #e9ecef; color: var(--azul-deep); }

/* âœ… CORRECCIÃ“N: Colores correctos para botones de estatus en panel */
.panel-btn-pendiente { 
    background: var(--celeste); 
    color: var(--azul-deep); 
}
.panel-btn-procesando { 
    background: var(--amarillo); 
    color: var(--azul-deep); 
}
.panel-btn-finalizada { 
    background: var(--verde); 
    color: white; 
}

.btn-status-indicator {
position: absolute;
right: 12px;
width: 8px;
height: 8px;
border-radius: 50%;
background: rgba(255,255,255,0.4);
}

.btn-status-indicator.active {
background: white;
box-shadow: 0 0 8px rgba(255,255,255,0.6);
}

#indPend.active { background: var(--celeste) !important; box-shadow: 0 0 8px var(--celeste) !important; }
#indProc.active { background: var(--amarillo) !important; box-shadow: 0 0 8px var(--amarillo) !important; }
#indFin.active { background: var(--verde) !important; box-shadow: 0 0 8px var(--verde) !important; }

/* AsignaciÃ³n de diseÃ±ador */
.designer-assign-section {
background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
border-radius: 16px;
padding: 18px;
border: 2px solid var(--naranja);
}

.designer-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 10px;
margin-top: 12px;
}

.designer-btn {
padding: 12px 8px;
border: 2px solid transparent;
border-radius: 10px;
font-weight: 700;
font-size: 0.8rem;
cursor: pointer;
transition: all 0.2s;
display: flex;
flex-direction: column;
align-items: center;
gap: 6px;
background: white;
box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.designer-btn:disabled {
opacity: 0.4;
cursor: not-allowed;
}

.designer-btn.selected {
border-color: var(--naranja);
background: var(--amarillo);
box-shadow: 0 0 0 3px rgba(251, 133, 0, 0.25), 0 4px 12px rgba(251, 133, 0, 0.3);
transform: scale(1.02);
}

.designer-avatar {
width: 36px;
height: 36px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.3rem;
box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

/* Footer del panel */
.panel-footer {
padding: 20px;
background: #f8f9fa;
border-top: 3px solid var(--gris);
display: flex;
flex-direction: column;
gap: 10px;
}

/* Footer compacto */
.panel-footer.compact {
padding: 15px;
}

.panel-footer-row {
display: flex;
gap: 8px;
margin-bottom: 8px;
}

.panel-btn.compact-btn {
padding: 8px 10px;
font-size: 0.75rem;
min-height: 36px;
}

.panel-btn.compact-btn .btn-text {
font-size: 0.7rem;
}

.panel-footer-divider {
height: 2px;
background: linear-gradient(90deg, transparent, var(--celeste), transparent);
margin: 5px 0;
}

/* Indicador visual de fila seleccionada en tabla */
.row-selected-panel {
background-color: #fff8e1 !important;
border-left: 5px solid var(--naranja) !important;
box-shadow: inset 0 0 20px rgba(251, 133, 0, 0.1);
position: relative;
}

.row-selected-panel::before {
content: 'â–¶';
position: absolute;
left: -3px;
top: 50%;
transform: translateY(-50%);
color: var(--naranja);
font-size: 0.8rem;
}

/* Overlay para cerrar panel al hacer click fuera */
.panel-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.3);
z-index: 999;
opacity: 0;
visibility: hidden;
transition: all 0.3s;
backdrop-filter: blur(2px);
}

.panel-overlay.active {
opacity: 1;
visibility: visible;
}

/* Responsive panel */
@media (max-width: 768px) {
.side-panel {
width: 100%;
border-left: none;
border-top: 5px solid var(--turquesa);
transform: translateY(100%);
}

.side-panel.active {
transform: translateY(0);
}
}

/* AnimaciÃ³n de entrada para secciones del panel */
@keyframes slideInRight {
from { opacity: 0; transform: translateX(20px); }
to { opacity: 1; transform: translateX(0); }
}

.side-panel-content > * {
animation: slideInRight 0.4s ease forwards;
}

.side-panel-content > *:nth-child(1) { animation-delay: 0.05s; }
.side-panel-content > *:nth-child(2) { animation-delay: 0.1s; }
.side-panel-content > *:nth-child(3) { animation-delay: 0.15s; }
.side-panel-content > *:nth-child(4) { animation-delay: 0.2s; }
.side-panel-content > *:nth-child(5) { animation-delay: 0.25s; }
.side-panel-content > *:nth-child(6) { animation-delay: 0.3s; }
}

/* BotÃ³n de reporte en panel - igual al del header */
.panel-btn.report-btn {
position: relative;
overflow: hidden;
background: linear-gradient(to right, #2d6a4f 0%, #1e4a35 0%);
box-shadow: 0 3px 0 #1e4a35;
width: 100%;
}

.panel-btn.report-btn:disabled {
opacity: 0.65;
cursor: not-allowed !important;
transform: none !important;
box-shadow: 0 3px 0 #1a3d2d !important;
}

.panel-btn.report-btn:not(:disabled):hover {
transform: translateY(-2px);
box-shadow: 0 5px 0 #1e4a35;
}

.panel-btn.report-btn:not(:disabled):active {
transform: translateY(1px);
box-shadow: 0 2px 0 #1e4a35;
}

/* Responsive ajustes */
@media (max-width: 768px) {
.panel-footer-row {
flex-direction: row;
}
.panel-btn.compact-btn {
font-size: 0.7rem;
padding: 6px 8px;
}
}
</style>
</head>
<body>
<div id="maintOverlay">
<span style="font-size: 80px;">ğŸ› ï¸</span>
<h1 style="font-weight: 800; font-size: 2.5rem; margin: 20px 0;">SISTEMA EN MANTENIMIENTO</h1>
<p style="font-size: 1.2rem; max-width: 500px; opacity: 0.9;">Estamos trabajando para mejorar tu experiencia.
Disculpen las molestias ocasionadas.</p>
<button class="btn-login" style="margin-top: 30px; padding: 12px 25px; font-size: 1rem;"
onclick="showLogin()">ğŸ”“ ACCESO ADMINISTRADOR</button>
</div>
<div id="loadingOverlay">
<div class="spinner"></div>
<div class="loading-text" id="loadMainTxt">Procesando...</div>
<div class="loading-subtext" id="loadSubTxt"></div>
</div>

<!-- âœ… OVERLAY PARA CERRAR PANEL AL HACER CLICK FUERA -->
<div id="panelOverlay" class="panel-overlay" onclick="closeSidePanel()"></div>

<!-- âœ… PANEL LATERAL DERECHO -->
<div id="sidePanel" class="side-panel">
<div class="side-panel-header">
<div class="side-panel-title">
<span id="panelRoleIcon">âš™ï¸</span>
<span id="panelRoleText">Panel de Control</span>
</div>
<button class="side-panel-close" onclick="closeSidePanel()" title="Cerrar panel">Ã—</button>
</div>

<div class="side-panel-content">
<!-- SelecciÃ³n de Solicitud -->
<div class="selected-request-section">
<div class="selected-request-header">ğŸ“‹ Solicitud Seleccionada</div>
<div id="selectedRequestContent">
<div class="no-selection">
<div class="no-selection-icon">ğŸ“­</div>
<div>Selecciona una solicitud<br>de la tabla para activar<br>las acciones</div>
</div>
</div>
</div>

<!-- Vista Previa de Archivo - IMAGEN COMPLETA A ESCALA -->
<div class="file-preview-section">
<div class="file-preview-header">ğŸ¨ Archivo Adjunto</div>
<div class="file-preview-container" id="filePreviewContainer">
<div class="file-preview-placeholder">
<div class="file-preview-placeholder-icon">ğŸ“</div>
<div>No hay archivo adjunto</div>
</div>
</div>
<div class="file-preview-info" id="filePreviewInfo"></div>
</div>

<!-- Acciones de Estado -->
<div class="panel-actions" id="statusActions">
<div class="panel-section-title">ğŸ”„ Cambiar Estado</div>
<button class="panel-btn panel-btn-pendiente" id="btnStatusPend" onclick="changeStatus('PENDIENTE')" disabled>
â³ Pendiente
<span class="btn-status-indicator" id="indPend"></span>
</button>
<button class="panel-btn panel-btn-procesando" id="btnStatusProc" onclick="changeStatus('PROCESANDO')" disabled>
âš™ï¸ Procesando
<span class="btn-status-indicator" id="indProc"></span>
</button>
<button class="panel-btn panel-btn-finalizada" id="btnStatusFin" onclick="changeStatus('FINALIZADA')" disabled>
âœ… Finalizada
<span class="btn-status-indicator" id="indFin"></span>
</button>
</div>

<!-- AsignaciÃ³n de DiseÃ±ador (Solo Admin) -->
<div class="designer-assign-section hidden" id="designerAssignSection">
<div class="panel-section-title">ğŸ‘¨â€ğŸ¨ Asignar DiseÃ±ador</div>
<div class="designer-grid" id="designerGrid">
<button class="designer-btn" onclick="assignDesigner('Bermina')" disabled>
<span class="designer-avatar" style="background: #fb8500;">ğŸ‘©</span>
<span>Bermina</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Jorsy')" disabled>
<span class="designer-avatar" style="background: #023047; color: white;">ğŸ‘¨</span>
<span>Jorsy</span>
</button>
<button class="designer-btn" onclick="assignDesigner('MarÃ­a F.')" disabled>
<span class="designer-avatar" style="background: #2d6a4f;">ğŸ‘©</span>
<span>MarÃ­a F.</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Xamir')" disabled>
<span class="designer-avatar" style="background: #ffb703;">ğŸ‘¨</span>
<span>Xamir</span>
</button>
</div>
</div>

<!-- Acciones de Archivo -->
<div class="panel-actions" id="fileActions">
<div class="panel-section-title">ğŸ“ Acciones de Archivo</div>
<button class="panel-btn panel-btn-info" id="btnAdjuntar" onclick="panelAdjuntarArte()" disabled>
ğŸ“¤ Adjuntar Arte
</button>
<button class="panel-btn panel-btn-secondary" id="btnVerArte" onclick="panelVerArte()" disabled>
ğŸ‘ï¸ Ver Arte
</button>
<button class="panel-btn panel-btn-primary" id="btnEnviarTG" onclick="panelEnviarTelegram()" disabled>
âœˆï¸ Enviar a Telegram
</button>
</div>

<!-- Acciones Especiales (Solo Admin) -->
<div class="panel-actions hidden" id="adminActions">
<div class="panel-section-title">âš ï¸ Acciones Especiales</div>
<button class="panel-btn panel-btn-danger" id="btnEliminar" onclick="panelEliminar()" disabled>
ğŸ—‘ï¸ Eliminar Solicitud
</button>
</div>
</div>

<!-- Footer con botones siempre visibles -->
<div class="panel-footer compact">
<div class="panel-footer-divider"></div>
<div class="panel-section-title" style="font-size: 0.65rem; margin-bottom: 8px;">ğŸ” Sistema</div>
<div class="panel-footer-row">
<button class="panel-btn panel-btn-secondary compact-btn" id="btnMaint" onclick="toggleMaintMode()">
ğŸ› ï¸ Mantenimiento
</button>
<button class="panel-btn panel-btn-danger compact-btn" onclick="logout()">
ğŸšª Cerrar SesiÃ³n
</button>
</div>
<button class="panel-btn panel-btn-success compact-btn report-btn" id="btnReportPanel" onclick="generateMonthlyReport()" disabled>
<span id="reportBtnTextPanel">ğŸ“Š Reporte</span>
<span id="reportBtnDaysPanel" class="report-days-badge"></span>
</button>
</div>
</div>

<div class="modal-overlay" id="modalAlert">
<div class="modal-content">
<span id="modalIcon" style="font-size: 60px; display: block; margin-bottom: 10px;">âš ï¸</span>
<div id="modalTitle" style="font-weight: 800; font-size: 1.4rem; color: var(--azul-deep);">AtenciÃ³n</div>
<div id="modalMsg" style="margin-top: 15px; color: #555; font-size: 1rem; line-height: 1.4; font-weight: 500;"></div>
<div id="loginArea" class="hidden" style="margin-top:20px; text-align: left;">
<label class="txt-small">Usuario del Sistema:</label>
<input type="text" id="adminUser" class="modern-input" style="margin-bottom:15px;"
placeholder="Ingrese usuario">
<label class="txt-small">Clave de Seguridad:</label>
<div class="pass-container">
<input type="password" id="adminPass" class="modern-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
<span class="eye-icon" onclick="togglePass()">ğŸ‘ï¸</span>
</div>
</div>
<!-- âœ… BARRA DE PROGRESO PARA LOGIN -->
<div id="loginProgressBar" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 2px solid var(--celeste);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span id="loginProgressText" style="font-weight: 700; color: var(--azul-deep); font-size: 0.9rem;">Verificando credenciales...</span>
        <span id="loginProgressPercent" style="font-weight: 800; color: var(--turquesa); font-size: 1rem;">0%</span>
    </div>
    <div style="background: #e9ecef; border-radius: 20px; height: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
        <div id="loginProgressBarInner" style="background: linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%); height: 100%; width: 0%; transition: width 0.4s ease; border-radius: 20px; box-shadow: 0 2px 8px rgba(33, 158, 188, 0.3);"></div>
    </div>
    <div id="loginProgressStatus" style="margin-top: 8px; font-size: 0.8rem; color: #6c757d; text-align: center; font-weight: 500;">Conectando con el servidor...</div>
</div>
<div id="uploadArea" class="hidden" style="margin-top:20px;">
<input type="file" id="arteFile" class="modern-input" accept=".jpg,.jpeg,.png,.pdf,.zip" style="font-size: 0.8rem;">
<p style="font-size: 0.7rem; color: #666; margin-top: 5px;">MÃ¡ximo 5MB (Formatos: JPG, PNG, PDF, ZIP)</p>
<input type="hidden" id="currentReqId">
</div>
<button id="mainModalBtn" class="modal-btn">ENTENDIDO</button>
<button id="closeModalBtn" class="modal-btn modal-btn-alt hidden" onclick="closeModal()">CERRAR</button>
</div>
</div>
<div class="modal-overlay" id="confirmModal">
<div class="modal-content">
<h2 style="font-weight: 800; color: var(--azul-deep); margin-top: 0;">ğŸ” Revisa tu Solicitud</h2>
<div id="previewContent"></div>
<div style="display: flex; gap: 12px; justify-content: center; width: 100%; max-width: 500px; margin: 0 auto; margin-top: 20px;">
<button id="btnCorregir" class="modal-btn-confirm corregir">âœï¸ Corregir</button>
<button id="btnEnviarConfirmado" class="modal-btn-confirm enviar" disabled>ğŸš€ Enviar Solicitud (<span id="countdown">10</span>)</button>
</div>
</div>
</div>
<!-- âœ… MODAL PARA SELECCIONAR DISEÃ‘ADOR - ELIMINADO (AHORA EN PANEL) -->
<!-- âœ… MODAL PARA MENSAJE DE ID NO ENCONTRADO -->
<div class="modal-overlay" id="idNotFoundModal" style="display: none;">
<div class="modal-content" style="max-width: 450px; padding: 25px;">
<span style="font-size: 50px; display: block; margin-bottom: 15px; color: #fb8500;">ğŸ”</span>
<h2 style="font-weight: 800; color: var(--azul-deep); margin: 0 0 15px 0;">ID no encontrado</h2>
<p style="font-size: 1rem; line-height: 1.5; color: #495057; margin-bottom: 20px;">
No se encontrÃ³ ninguna solicitud con el ID: <strong id="notFoundId"></strong>
</p>
<p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 25px;">
Verifica que el ID sea correcto o limpia la bÃºsqueda para ver todas las solicitudes
</p>
<div style="display: flex; justify-content: center; gap: 15px;">
<button class="modal-btn" style="background: var(--gris); color: var(--azul-deep);" onclick="closeIdNotFoundModal()">CERRAR</button>
<button class="modal-btn" style="background: #fb8500; color: white;" onclick="clearSearch()">LIMPIAR BÃšSQUEDA</button>
</div>
</div>
</div>
<header>
<div class="brand-container">
<h1 class="header-title">SIRA 2.5</h1>
<span class="acronimo">Sistema Integral de Requerimientos de Artes</span>
</div>
<div class="nav-tabs">
<button id="tab-form" class="tab-btn active" onclick="showPage('form-page', this)">ğŸ“ FORMULARIO</button>
<button id="tab-list" class="tab-btn" onclick="showPage('list-page', this)">ğŸ“‹ SOLICITUDES</button>
</div>
<div class="admin-access">
<!-- âœ… MENSAJE DE BIENVENIDA - MÃS LLAMATIVO -->
<div id="welcomeMessage" class="welcome-message">Â¡Hola, <span id="userNameDisplay"></span>!</div>
<!-- Solo botÃ³n de login/logout -->
<button id="authBtn" class="btn-login" onclick="showLogin()">ğŸ” Administrador</button>
</div>
</header>
<div class="container page active" id="form-page">
<div class="aviso-48h">âš ï¸ IMPORTANTE: LAS SOLICITUDES DEBEN REALIZARSE CON 48 HORAS DE ANTICIPACIÃ“N</div>
<form id="sigrafForm" novalidate>
<!-- ... -->
<label class="section-title">ğŸ¥ 1. REGIÃ“N *</label>
<div class="category-row" id="region-grid"></div>
<div id="unidad-section" class="hidden">
<label class="section-title">ğŸ¥ 1.5. UNIDAD MÃ‰DICA *</label>
<div class="category-row" id="unidad-grid"></div>
</div>
<label class="section-title">ğŸ“‚ 2. TIPO DE JORNADA *</label>
<div class="category-row" id="cat-grid">
<div class="card-btn" onclick="selectCat(this, 'escuela')">Ipasme va a la Escuela</div>
<div class="card-btn" onclick="selectCat(this, 'integral')">Jornada de AtenciÃ³n MÃ©dica Integral</div>
<div class="card-btn" onclick="selectCat(this, 'conjunta')">Jornada Conjunta</div>
<div class="card-btn" onclick="selectCat(this, 'vacuna')">Plan Masivo de VacunaciÃ³n</div>
<div class="card-btn" onclick="selectCat(this, 'quirurgica')">CaptaciÃ³n QuirÃºrgica</div>
<div class="card-btn" onclick="selectCat(this, 'pediatrica')">CaptaciÃ³n QuirÃºrgica PediÃ¡trica</div>
<div class="card-btn" onclick="selectCat(this, 'oftalmo')">CaptaciÃ³n QuirÃºrgica OftalmolÃ³gica</div>
<div class="card-btn" onclick="selectCat(this, 'otros')">Otros</div>
</div>
<div id="sec-3" class="hidden">
<label class="section-title" id="label-3">ğŸ©º 3. DETALLE *</label>
<div id="cont-3" style="display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;"></div>
</div>
<div id="sec-4" class="hidden">
<label class="section-title">âœ¨ 4. SERVICIOS ADICIONALES (OPCIONAL)</label>
<div id="cont-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 6px;"></div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="section-title">ğŸ“… 5. FECHA DE ACTIVIDAD *</label><input type="date" id="fecha" class="modern-input"></div>
<div><label class="section-title">â° 6. HORA DE INICIO *</label><div class="hora-container" id="hora-box" style="display: flex;
gap: 10px; align-items: center;"><input type="text" id="hora" class="modern-input" style="width:100px; text-align:center" placeholder="08:00"><button type="button" class="btn-time" id="btn-am" onclick="setAMPM('a. m.')">a. m.</button><button type="button" class="btn-time" id="btn-pm" onclick="setAMPM('p. m.')">p. m.</button></div></div>
</div>
<label class="section-title">ğŸ“ 7. UBICACIÃ“N *</label>
<div style="background: #fff8e1;
border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600;
line-height: 1.4;">
âš ï¸ Complete al menos el nombre de la instituciÃ³n. La direcciÃ³n exacta es opcional pero recomendada.
</div>
<div style="display: grid;
grid-template-columns: 1fr 1fr; gap: 20px;">
<div>
<label class="txt-small">ğŸ« InstituciÃ³n *</label>
<input type="text" id="institucion" class="modern-input" placeholder="Escuela, Liceo, JardÃ­n de niÃ±os, etc.">
</div>
<div>
<label class="txt-small">ğŸ§­ DirecciÃ³n exacta</label>
<input type="text" id="direccion-exacta" class="modern-input" placeholder="Municipio, Parroquia, Ciudad, etc.">
</div>
</div>
<label class="section-title">ğŸ“±âœ‰ï¸ 8. DATOS DE CONTACTO</label>
<div style="display: grid;
grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="txt-small">NÃºmero de TelÃ©fono</label><input type="tel" id="tlf" class="modern-input" placeholder="04xx 1234567"></div>
<div><label class="txt-small">Correo ElectrÃ³nico *</label><input type="email" id="mail" class="modern-input" placeholder="Para envÃ­o de arte final"></div>
</div>
<label class="section-title">âœï¸ 9. OBSERVACIONES / DETALLES DE DISEÃ‘O</label><textarea id="observaciones" class="modern-input" rows="3" placeholder="Indique medidas, colores institucionales o entes participantes adicionales..."></textarea>
<label class="section-title">ğŸ“¸ 10. SOPORTES FOTOGRÃFICOS (MÃX 3)</label>
<div style="background: #fff8e1;
border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600;
line-height: 1.4;">
âš ï¸ Si el registro fotogrÃ¡fico enviado no cumple con las condiciones de calidad para la solicitud, serÃ¡ sustituido por material de archivo.
</div>
<div class="photo-grid">
<div class="upload-box"><label for="f1" class="upload-label">âœš SUBIR FOTO</label><input type="file" id="f1" class="hidden" accept="image/*" onchange="handleFile(this, 'p1', 'b1')"><img id="p1" class="preview"><button type="button" id="b1" class="remove-btn" onclick="clearFile('f1', 'p1', 'b1')">Ã—</button></div>
<div class="upload-box"><label for="f2" class="upload-label">âœš SUBIR FOTO</label><input type="file" id="f2" class="hidden" accept="image/*" onchange="handleFile(this, 'p2', 'b2')"><img id="p2" class="preview"><button type="button" id="b2" class="remove-btn" onclick="clearFile('f2', 'p2', 'b2')">Ã—</button></div>
<div class="upload-box"><label for="f3" class="upload-label">âœš SUBIR FOTO</label><input type="file" id="f3" class="hidden" accept="image/*" onchange="handleFile(this, 'p3', 'b3')"><img id="p3" class="preview"><button type="button" id="b3" class="remove-btn" onclick="clearFile('f3', 'p3', 'b3')">Ã—</button></div>
</div>
<button type="submit" id="submitBtn" class="btn-send">ğŸš€ ENVIAR SOLICITUD A COMUNICACIONES</button>
</form>
</div>
<div class="container page" id="list-page">
<!-- âœ… CONTADORES COMBINADOS PARA ADMIN (TEXTO COMPLETO, UNA SOLA LÃNEA) -->
<div class="combined-stats" id="combined-stats" style="display:none; margin-bottom: 10px; gap: 6px;">
  <!-- Contadores generales -->
  <div class="stat-card stat-mini st-total">
    <span class="stat-label">Total</span>
    <span id="count-total-admin" class="stat-val">0</span>
  </div>
  <div class="stat-card stat-mini st-pend">
    <span class="stat-label">Pendiente</span>
    <span id="count-pend-admin" class="stat-val">0</span>
  </div>
  <div class="stat-card stat-mini st-proc">
    <span class="stat-label">En Proceso</span>
    <span id="count-proc-admin" class="stat-val">0</span>
  </div>
  <div class="stat-card stat-mini st-fin">
    <span class="stat-label">Finalizada</span>
    <span id="count-fin-admin" class="stat-val">0</span>
  </div>
  
  <!-- Contadores de diseÃ±adores (SOLO ADMIN) -->
  <div class="stat-card stat-mini stat-bermina">
    <span class="stat-label">Bermina</span>
    <span id="count-bermina-admin" class="stat-val">0</span>
  </div>
  <div class="stat-card stat-mini stat-jorsy">
    <span class="stat-label">Jorsy</span>
    <span id="count-jorsy-admin" class="stat-val">0</span>
  </div>
  <div class="stat-card stat-mini stat-maria">
    <span class="stat-label">MarÃ­a F.</span>
    <span id="count-maria-admin" class="stat-val">0</span>
  </div>
  <div class="stat-card stat-mini stat-xamir">
    <span class="stat-label">Xamir</span>
    <span id="count-xamir-admin" class="stat-val">0</span>
  </div>
</div>

<!-- âœ… CONTADORES PARA USUARIOS REGULARES (SIN CAMBIOS) -->
<div class="stats-grid" id="stats-panel">
<div class="stat-card st-total"><span class="stat-label">Total</span><span id="count-total" class="stat-val">0</span></div>
<div class="stat-card st-pend"><span class="stat-label">Pendiente</span><span id="count-pend" class="stat-val">0</span></div>
<div class="stat-card st-proc"><span class="stat-label">En Proceso</span><span id="count-proc" class="stat-val">0</span></div>
<div class="stat-card st-fin"><span class="stat-label">Finalizada</span><span id="count-fin" class="stat-val">0</span></div>
</div>
<!-- âœ… BUSCADOR DE ID PARA DISEÃ‘ADOR -->
<div id="designer-search-container" class="hidden">
<div style="display: flex; align-items: center; gap: 10px;">
<span style="font-size: 1.2rem; color: #fb8500;">ğŸ”</span>
<input 
type="text" 
id="searchIdInput" 
class="modern-input" 
placeholder="Buscar por ID de solicitud..."
style="background: white; border-color: #ffb703; font-weight: 600;"
>
</div>
<p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #5d4600; font-weight: 500;">
âš ï¸ Solo las solicitudes coincidentes estarÃ¡n habilitadas para adjuntar archivos
</p>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>ID SOLICITUD</th>
<th>FECHA EVENTO</th>
<th>UNIDAD SOLICITANTE</th>
<th>TIPO DE JORNADA</th>
<th style="text-align:center">SOPORTES</th>
<th>ESTATUS</th>
<th id="th-admin" class="hidden" style="text-align:right">ACCIONES ADMIN</th>
<th id="th-designer" class="hidden" style="text-align:right">ACCIONES DISEÃ‘ADOR</th>
</tr>
</thead>
<tbody id="solicitudes-body"></tbody>
</table>
<!-- âœ… CONTROLES DE PAGINACIÃ“N -->
<div id="paginationControls" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 0 0 12px 12px; margin-top: -1px;">
  <div style="font-size: 0.85rem; color: #6c757d;">
    Mostrando <strong id="paginationStart">1</strong>-<strong id="paginationEnd">50</strong> de <strong id="paginationTotal">0</strong> registros
  </div>
  <div style="display: flex; gap: 8px;">
    <button onclick="changePage('first')" id="btnFirstPage" class="btn-act bg-pend" style="padding: 6px 12px;" disabled>â®ï¸ Primero</button>
    <button onclick="changePage('prev')" id="btnPrevPage" class="btn-act bg-pend" style="padding: 6px 12px;" disabled>â—€ï¸ Anterior</button>
    <span id="currentPageIndicator" style="padding: 6px 12px; background: var(--turquesa); color: white; border-radius: 6px; font-weight: 700; font-size: 0.85rem;">1 / 1</span>
    <button onclick="changePage('next')" id="btnNextPage" class="btn-act bg-proc" style="padding: 6px 12px;" disabled>Siguiente â–¶ï¸</button>
    <button onclick="changePage('last')" id="btnLastPage" class="btn-act bg-proc" style="padding: 6px 12px;" disabled>Ãšltimo â­ï¸</button>
  </div>
</div>
</div>
</div>
<script>
// === CONFIGURACIÃ“N DE SCRIPT URL ===
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw4oGU8GLqut_CQTWIdkArjakKsuRAZLVF9xI4YhO-pYV0XYvMp-BXoE4arULToavgaw/exec";

// === AGREGAR ESTO ===
const BATCH_QUEUE = {
  requests: [],
  timeout: null,
  delay: 100 // ms para agrupar requests
};

async function batchRequest(action, params) {
  return new Promise((resolve, reject) => {
    BATCH_QUEUE.requests.push({ action, params, resolve, reject });
    
    if (BATCH_QUEUE.timeout) {
      clearTimeout(BATCH_QUEUE.timeout);
    }
    
    BATCH_QUEUE.timeout = setTimeout(async () => {
      const batch = BATCH_QUEUE.requests.splice(0);
      BATCH_QUEUE.requests = [];
      
      try {
        // âœ… PROCESAR EN PARALELO (mÃ¡ximo 3 simultÃ¡neos)
        const results = await Promise.allSettled(
          batch.map(async (req) => {
            const params = new URLSearchParams();
            params.append("action", req.action);
            Object.keys(req.params).forEach(key => {
              params.append(key, req.params[key]);
            });
            
            const res = await fetch(SCRIPT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: params.toString()
            });
            return await res.json();
          })
        );
        
        // âœ… RESOLVER CADA PROMESA INDIVIDUAL
        results.forEach((result, index) => {
          if (result.status === 'fulfilled') {
            batch[index].resolve(result.value);
          } else {
            batch[index].reject(result.reason);
          }
        });
      } catch (e) {
        batch.forEach(req => req.reject(e));
      }
    }, BATCH_QUEUE.delay);
  });
}

// âœ… VARIABLES GLOBALES DEL PANEL
let selectedRequestId = null;
let selectedRequestData = null;
let isPanelOpen = false;

// âœ… POLLING PARA SINCRONIZACIÃ“N EN TIEMPO REAL
let panelSyncInterval = null;

// âœ… VARIABLES PARA SISTEMA DE CHUNKS MEJORADO
let chunkUpload = {
    // Estado
    isActive: false,
    isPaused: false,
    isCancelled: false,
    
    // Archivo y chunks
    currentFile: null,
    fileSize: 0,
    fileName: '',
    mimeType: '',
    chunks: [],
    totalChunks: 0,
    uploadedChunks: 0,
    currentChunkIndex: 0,
    
    // ConfiguraciÃ³n dinÃ¡mica
    currentChunkSize: 512 * 1024,  // TamaÃ±o inicial (se ajusta dinÃ¡micamente)
    maxConcurrent: 1,
    connectionTier: 'unknown',
    
    // MediciÃ³n de velocidad en tiempo real
    startTime: null,
    lastUpdateTime: null,
    totalBytesUploaded: 0,
    
    // Historial de velocidades para promedio mÃ³vil
    speedHistory: [],
    currentSpeed: 0,        // Velocidad instantÃ¡nea (KB/s)
    averageSpeed: 0,        // Velocidad promedio (KB/s)
    smoothedSpeed: 0,       // Velocidad suavizada (KB/s)
    
    // Progreso granular (bytes reales, no chunks)
    bytesUploadedCurrentChunk: 0,
    totalBytesCommitted: 0,  // Bytes confirmados como subidos
    
    // Reintentos
    retryCount: 0,
    maxRetries: 3,
    chunkRetries: {},  // Track de reintentos por chunk
    
    // Temporizadores
    progressTimer: null,
    speedUpdateTimer: null,
    
    // Token de cancelaciÃ³n
    abortController: null,
    
    // Variables legacy para compatibilidad
    pauseRequested: false,
    resumeToken: null,
    currentChunkStartTime: null,
    currentChunkEndTime: null,
    uploadSpeeds: [],
    avgUploadSpeed: 0,
    currentUploadSpeed: 0,
    connectionSpeed: 'unknown',
    chunkSize: 512 * 1024,
    currentChunk: 0
};

// âœ… CONFIGURACIÃ“N AVANZADA DE CHUNKS CON ADAPTACIÃ“N DINÃMICA
const CHUNK_CONFIG = {
    // Umbrales de velocidad en KB/s (medidos empÃ­ricamente)
    THRESHOLDS: {
        ULTRA_FAST: 2048,    // > 2 MB/s - Subida completa
        FAST: 512,           // 512 KB/s - 1 MB - 2 MB chunks
        MEDIUM: 128,         // 128-512 KB/s - 512 KB chunks
        SLOW: 32,            // 32-128 KB/s - 256 KB chunks
        VERY_SLOW: 0         // < 32 KB/s - 128 KB chunks
    },
    
    // TamaÃ±os de chunks segÃºn velocidad
    SIZES: {
        ULTRA_FAST: Infinity, // No usar chunks
        FAST: 2 * 1024 * 1024,      // 2 MB
        MEDIUM: 512 * 1024,         // 512 KB
        SLOW: 256 * 1024,           // 256 KB
        VERY_SLOW: 128 * 1024       // 128 KB
    },
    
    // Configuraciones de concurrencia
    CONCURRENT: {
        ULTRA_FAST: 1,  // Secuencial (conexiÃ³n rÃ¡pida no necesita paralelismo)
        FAST: 2,        // 2 conexiones paralelas
        MEDIUM: 1,      // 1 conexiÃ³n (estable)
        SLOW: 1,        // 1 conexiÃ³n (evitar saturaciÃ³n)
        VERY_SLOW: 1    // 1 conexiÃ³n (mÃ¡xima estabilidad)
    },
    
    // Intervalos de actualizaciÃ³n de UI (ms)
    UPDATE_INTERVAL: 100,  // Actualizar cada 100ms para fluidez
    
    // Muestras para promedio mÃ³vil
    SPEED_SAMPLES: 5,  // Usar Ãºltimas 5 mediciones para promedio
    
    // ConfiguraciÃ³n legacy para compatibilidad
    fast: { size: 1024 * 1024, concurrent: 3 },    // 1MB (no se usa - conexiones rÃ¡pidas suben completo)
    medium: { size: 512 * 1024, concurrent: 2 },   //512KB para conexiones medias
    'slow-medium': { size: 256 * 1024, concurrent: 1 }, // 256KB para conexiones lentas-medias
    slow: { size: 256 * 1024, concurrent: 1 }      // 256KB para conexiones lentas
};

// ============================================================
// FUNCIÃ“N 1: DETECCIÃ“N PRECISA DE VELOCIDAD DE CONEXIÃ“N
// ============================================================
async function detectConnectionSpeed() {
    console.log("ğŸ” Iniciando detecciÃ³n de velocidad de conexiÃ³n...");
    
    const testSizes = [50 * 1024, 100 * 1024]; // 50KB y 100KB para muestras
    const speeds = [];
    
    // Realizar mÃºltiples pruebas para precisiÃ³n
    for (let size of testSizes) {
        try {
            // Generar datos aleatorios para evitar cachÃ©
            const testData = new Uint8Array(size);
            for (let i = 0; i < size; i++) {
                testData[i] = Math.floor(Math.random() * 256);
            }
            
            const blob = new Blob([testData]);
            const startTime = performance.now();
            
            // Simular subida real (usar el mismo endpoint o uno de prueba)
            const formData = new FormData();
            formData.append('ping', blob);
            formData.append('action', 'ping');
            
            // Timeout de 5 segundos para la prueba
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData,
                signal: controller.signal,
                // No enviar credenciales en ping para velocidad
                credentials: 'omit'
            });
            
            clearTimeout(timeoutId);
            
            const endTime = performance.now();
            const duration = (endTime - startTime) / 1000; // segundos
            const speedKBps = (size / 1024) / duration;   // KB/s
            
            speeds.push(speedKBps);
            console.log(`ğŸ“Š Prueba con ${size/1024}KB: ${speedKBps.toFixed(2)} KB/s`);
            
        } catch (e) {
            console.warn(`âš ï¸ Prueba fallida: ${e.message}`);
        }
    }
    
    // Calcular velocidad promedio de las pruebas exitosas
    let avgSpeed = 0;
    if (speeds.length > 0) {
        avgSpeed = speeds.reduce((a, b) => a + b, 0) / speeds.length;
    } else {
        // Si todas fallan, usar un valor conservador
        avgSpeed = 128; // 128 KB/s por defecto
    }
    
    // Determinar tier de conexiÃ³n
    let tier, chunkSize, concurrent;
    
    if (avgSpeed >= CHUNK_CONFIG.THRESHOLDS.ULTRA_FAST) {
        tier = 'ULTRA_FAST';
        chunkSize = CHUNK_CONFIG.SIZES.ULTRA_FAST;
        concurrent = CHUNK_CONFIG.CONCURRENT.ULTRA_FAST;
    } else if (avgSpeed >= CHUNK_CONFIG.THRESHOLDS.FAST) {
        tier = 'FAST';
        chunkSize = CHUNK_CONFIG.SIZES.FAST;
        concurrent = CHUNK_CONFIG.CONCURRENT.FAST;
    } else if (avgSpeed >= CHUNK_CONFIG.THRESHOLDS.MEDIUM) {
        tier = 'MEDIUM';
        chunkSize = CHUNK_CONFIG.SIZES.MEDIUM;
        concurrent = CHUNK_CONFIG.CONCURRENT.MEDIUM;
    } else if (avgSpeed >= CHUNK_CONFIG.THRESHOLDS.SLOW) {
        tier = 'SLOW';
        chunkSize = CHUNK_CONFIG.SIZES.SLOW;
        concurrent = CHUNK_CONFIG.CONCURRENT.SLOW;
    } else {
        tier = 'VERY_SLOW';
        chunkSize = CHUNK_CONFIG.SIZES.VERY_SLOW;
        concurrent = CHUNK_CONFIG.CONCURRENT.VERY_SLOW;
    }
    
    // Guardar configuraciÃ³n
    chunkUpload.connectionTier = tier;
    chunkUpload.currentChunkSize = chunkSize;
    chunkUpload.maxConcurrent = concurrent;
    
    // Para compatibilidad con cÃ³digo existente
    chunkUpload.connectionSpeed = tier.toLowerCase().replace('_', '-');
    chunkUpload.chunkSize = chunkSize;
    
    console.log(`ğŸŒ Velocidad detectada: ${avgSpeed.toFixed(2)} KB/s (${(avgSpeed*8).toFixed(2)} Kbps)`);
    console.log(`ğŸ·ï¸ Tier: ${tier} | Chunk: ${chunkSize === Infinity ? 'Completo' : (chunkSize/1024).toFixed(0) + 'KB'} | Concurrente: ${concurrent}`);
    
    return {
        speed: avgSpeed,
        tier: tier,
        chunkSize: chunkSize,
        concurrent: concurrent,
        shouldUseChunks: chunkSize !== Infinity
    };
}

// âœ… REINICIAR ESTADO DE CHUNKS
function resetChunkUploadState() {
    chunkUpload.isActive = false;
    chunkUpload.currentFile = null;
    chunkUpload.chunks = [];
    chunkUpload.currentChunk = 0;
    chunkUpload.totalChunks = 0;
    chunkUpload.uploadedChunks = 0;
    chunkUpload.pauseRequested = false;
    chunkUpload.startTime = null;
    chunkUpload.retryCount = 0;
    chunkUpload.resumeToken = null;
    
    // âœ… RESET VARIABLES DE VELOCIDAD
    chunkUpload.currentChunkStartTime = null;
    chunkUpload.currentChunkEndTime = null;
    chunkUpload.uploadSpeeds = [];
    chunkUpload.avgUploadSpeed = 0;
    chunkUpload.currentUploadSpeed = 0;
    
    // âœ… LIMPIAR DISPLAY DE VELOCIDAD
    const speedElement = document.getElementById('progressUploadSpeed');
    if (speedElement) {
        speedElement.innerText = 'ğŸ“¤ Velocidad: Calculando...';
    }
    
    // âœ… Limpiar timer si existe
    if (window.confirmTimer) {
        clearInterval(window.confirmTimer);
        window.confirmTimer = null;
    }
    
    console.log("ğŸ”„ Estado de chunks reiniciado");
}

// ============================================================
// FUNCIÃ“N 2: DIVISIÃ“N INTELIGENTE DE ARCHIVO EN CHUNKS
// ============================================================

function splitFileIntoChunks(file) {
    const chunks = [];
    const fileSize = file.size;
    
    // Si la conexiÃ³n es ultra-rÃ¡pida y el archivo es menor a 6MB, no usar chunks
    if (chunkUpload.connectionTier === 'ULTRA_FAST' && fileSize <= 6 * 1024 * 1024) {
        console.log("ğŸš€ ConexiÃ³n ultra-rÃ¡pida detectada, subiendo archivo completo");
        return [{
            index: 0,
            blob: file,
            size: fileSize,
            total: 1,
            fileId: file.name + '_' + Date.now(),
            startByte: 0,
            endByte: fileSize
        }];
    }
    
    // Para archivos muy pequeÃ±os (< 256KB), subir completo siempre
    if (fileSize <= 256 * 1024) {
        chunkUpload.currentChunkSize = fileSize;
        return [{
            index: 0,
            blob: file,
            size: fileSize,
            total: 1,
            fileId: file.name + '_' + Date.now(),
            startByte: 0,
            endByte: fileSize
        }];
    }
    
    // Ajustar tamaÃ±o de chunk si el archivo es muy grande
    let chunkSize = chunkUpload.currentChunkSize;
    const maxChunks = 50; // Evitar demasiados chunks
    
    if (fileSize / chunkSize > maxChunks) {
        chunkSize = Math.ceil(fileSize / maxChunks);
        // Redondear a mÃºltiplo de 64KB para eficiencia
        chunkSize = Math.ceil(chunkSize / (64 * 1024)) * (64 * 1024);
        chunkUpload.currentChunkSize = chunkSize;
    }
    
    const totalChunks = Math.ceil(fileSize / chunkSize);
    const fileId = file.name + '_' + Date.now();
    
    for (let i = 0; i < totalChunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(start + chunkSize, fileSize);
        
        chunks.push({
            index: i,
            blob: file.slice(start, end),
            size: end - start,
            total: totalChunks,
            fileId: fileId,
            startByte: start,
            endByte: end
        });
    }
    
    console.log(`ğŸ“¦ Archivo dividido en ${totalChunks} chunks de ~${(chunkSize/1024).toFixed(0)}KB cada uno`);
    return chunks;
}

// ============================================================
// FUNCIÃ“N 3: ACTUALIZACIÃ“N DE VELOCIDAD EN TIEMPO REAL
// ============================================================

function updateSpeedMetrics(bytesUploaded, isComplete = false) {
    const now = performance.now();
    
    if (!chunkUpload.lastUpdateTime) {
        chunkUpload.lastUpdateTime = now;
        return;
    }
    
    const timeDelta = (now - chunkUpload.lastUpdateTime) / 1000; // segundos
    
    if (timeDelta > 0) {
        // Velocidad instantÃ¡nea (KB/s)
        const instantSpeed = (bytesUploaded / 1024) / timeDelta;
        
        // Actualizar historial (promedio mÃ³vil)
        chunkUpload.speedHistory.push(instantSpeed);
        if (chunkUpload.speedHistory.length > CHUNK_CONFIG.SPEED_SAMPLES) {
            chunkUpload.speedHistory.shift();
        }
        
        // Calcular promedio
        chunkUpload.averageSpeed = chunkUpload.speedHistory.reduce((a, b) => a + b, 0) 
                                   / chunkUpload.speedHistory.length;
        
        // Suavizado exponencial para evitar fluctuaciones bruscas
        const alpha = 0.3; // Factor de suavizado
        chunkUpload.smoothedSpeed = (alpha * instantSpeed) + 
                                    ((1 - alpha) * (chunkUpload.smoothedSpeed || instantSpeed));
        
        chunkUpload.currentSpeed = instantSpeed;
        chunkUpload.lastUpdateTime = now;
        
        // Actualizar UI
        updateSpeedDisplay();
    }
}

function updateSpeedDisplay() {
    const speedElement = document.getElementById('progressUploadSpeed');
    const etaElement = document.getElementById('progressETA');
    
    if (!speedElement) return;
    
    // Formatear velocidad
    let speedText, unit;
    const speed = chunkUpload.smoothedSpeed || chunkUpload.averageSpeed || 0;
    
    if (speed >= 1024) {
        speedText = (speed / 1024).toFixed(2);
        unit = 'MB/s';
    } else {
        speedText = speed.toFixed(1);
        unit = 'KB/s';
    }
    
    // Calcular Mbps (megabits por segundo)
    const mbps = (speed * 8 / 1024).toFixed(1);
    
    // Determinar emoji segÃºn velocidad
    let emoji = 'ğŸŒ';
    if (speed >= 1024) emoji = 'ğŸš€';
    else if (speed >= 512) emoji = 'âš¡';
    else if (speed >= 128) emoji = 'ğŸ“¶';
    else if (speed >= 32) emoji = 'ğŸ¢';
    
    speedElement.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
            <span style="font-size: 1.2rem;">${emoji}</span>
            <div>
                <div style="font-weight: 800; color: var(--turquesa); font-size: 1.1rem;">
                    ${speedText} ${unit}
                </div>
                <div style="font-size: 0.75rem; color: #666;">
                    ${mbps} Mbps | ${chunkUpload.connectionTier.replace('_', ' ')}
                </div>
            </div>
        </div>
    `;
    
    // Calcular ETA
    if (etaElement && speed > 0) {
        const remainingBytes = chunkUpload.fileSize - chunkUpload.totalBytesCommitted;
        const remainingKB = remainingBytes / 1024;
        const etaSeconds = Math.ceil(remainingKB / speed);
        
        let etaText;
        if (etaSeconds < 60) {
            etaText = `${etaSeconds}s`;
        } else if (etaSeconds < 3600) {
            etaText = `${Math.floor(etaSeconds / 60)}m ${etaSeconds % 60}s`;
        } else {
            etaText = `${Math.floor(etaSeconds / 3600)}h ${Math.floor((etaSeconds % 3600) / 60)}m`;
        }
        
        etaElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 6px; justify-content: center; margin-top: 8px;">
                <span>â±ï¸</span>
                <span style="font-weight: 600;">Tiempo restante: ~${etaText}</span>
                <span style="font-size: 0.75rem; color: #888;">
                    (${((chunkUpload.totalBytesCommitted / chunkUpload.fileSize) * 100).toFixed(1)}%)
                </span>
            </div>
        `;
    }
}

// ============================================================
// FUNCIÃ“N 4: SUBIR CHUNK INDIVIDUAL CON MEDICIÃ“N REAL
// ============================================================

async function uploadSingleChunkWithProgress(id, filename, mimeType, chunk) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const base64 = e.target.result.split(',')[1];
                const chunkSizeKB = chunk.size / 1024;
                
                // Preparar datos
                const params = new URLSearchParams();
                params.append("action", "uploadChunk");
                params.append("id", id);
                params.append("filename", filename);
                params.append("mime", mimeType);
                params.append("chunkIndex", chunk.index);
                params.append("chunkData", base64);
                params.append("totalChunks", chunk.total);
                params.append("fileId", chunk.fileId);
                params.append("uploadedBy", userCredentials.displayName);
                params.append("startByte", chunk.startByte);
                params.append("endByte", chunk.endByte);
                
                // Crear XMLHttpRequest para tracking de progreso real
                const xhr = new XMLHttpRequest();
                const startTime = performance.now();
                
                // Configurar tracking de progreso
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        // Bytes reales subidos de este chunk
                        const bytesUploaded = event.loaded;
                        chunkUpload.bytesUploadedCurrentChunk = bytesUploaded;
                        
                        // Actualizar mÃ©tricas en tiempo real
                        const totalUploaded = chunkUpload.totalBytesCommitted + bytesUploaded;
                        updateSpeedMetrics(bytesUploaded);
                        
                        // Actualizar progreso granular
                        updateGranularProgress(totalUploaded);
                    }
                };
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const endTime = performance.now();
                        const duration = (endTime - startTime) / 1000;
                        const actualSpeed = chunkSizeKB / duration;
                        
                        console.log(`âœ… Chunk ${chunk.index + 1}/${chunk.total} completado en ${duration.toFixed(2)}s (${actualSpeed.toFixed(2)} KB/s)`);
                        
                        // Confirmar bytes subidos
                        chunkUpload.totalBytesCommitted += chunk.size;
                        chunkUpload.bytesUploadedCurrentChunk = 0;
                        
                        // Actualizar velocidad final del chunk
                        updateSpeedMetrics(chunk.size, true);
                        
                        resolve(xhr.response);
                    } else {
                        reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                    }
                };
                
                xhr.onerror = () => reject(new Error("Error de red"));
                xhr.ontimeout = () => reject(new Error("Timeout"));
                
                // Enviar
                xhr.open('POST', SCRIPT_URL, true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.send(params.toString());
                
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo chunk"));
        reader.readAsDataURL(chunk.blob);
    });
}

// ============================================================
// FUNCIÃ“N 5: ACTUALIZACIÃ“N DE PROGRESO GRANULAR
// ============================================================

function updateGranularProgress(bytesUploaded) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
    
    if (!progressBar || !progressPercent) return;
    
    const percentage = Math.min(100, (bytesUploaded / chunkUpload.fileSize) * 100);
    
    progressBar.style.width = percentage + '%';
    progressPercent.innerText = percentage.toFixed(1) + '%';
    
    // Actualizar texto de estado
    if (progressStatus) {
        const chunkInfo = chunkUpload.totalChunks > 1 
            ? ` (Chunk ${chunkUpload.currentChunkIndex + 1}/${chunkUpload.totalChunks})`
            : '';
        progressStatus.innerText = `ğŸ“¤ Subiendo${chunkInfo}...`;
    }
}


const UNIDADES_IPASME_RAW = {
"Capital": [
"Don SimÃ³n RodrÃ­guez",
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende"
],
"RegiÃ³n Central": [
"Maracay", "La Victoria", "Valencia", "Puerto Cabello",
"Club Villas Ipasmar", "Guatire", "Ocumare del Tuy", "Caucagua",
"Carrizal", "La Guaira"
],
"RegiÃ³n Occidental": [
"Cabimas", "Maracaibo", "Machiques", "San Carlos del Zulia",
"El MojÃ¡n", "Barquisimeto", "El Tocuyo", "Carora",
"San Felipe", "Nirgua", "Punto Fijo", "Coro",
"Buchivacoa", "Puerto Cumarebo"
],
"RegiÃ³n Los Andes": [
"El VigÃ­a", "MÃ©rida", "Tovar",
"Hotel Valle Grande", "La Grita", "Rubio",
"San CristÃ³bal", "San Juan de ColÃ³n", "UreÃ±a",
"BoconÃ³", "Trujillo", "Valera"
],
"RegiÃ³n Oriental": [
"Anaco", "Barcelona", "Cantaura", "El Tigre",
"Isidora Agnes, Ciudad BolÃ­var", "Guasipati",
"Profa. Mirelva MartÃ­nez, San FÃ©lix", "Upata", "MaturÃ­n",
"Punta de Mata", "CumanÃ¡", "Cumanacoa", "CarÃºpano",
"GÃ¼iria", "Tucupita", "Casacoima", "La AsunciÃ³n",
"Puerto Ayacucho"
],
"RegiÃ³n Los Llanos": [
"Altagracia de Orituco", "Calabozo", "San Juan de los Morros",
"Valle de la Pascua", "Zaraza", "San Carlos de Cojedes",
"Tinaquillo", "San Fernando de Apure", "Guasdualito",
"Barinas", "Santa BÃ¡rbara de Barinas", "Acarigua", "Guanare"
]
};

const ORDEN_REGIONES = [
"Capital",
"RegiÃ³n Central",
"RegiÃ³n Occidental",
"RegiÃ³n Los Andes",
"RegiÃ³n Oriental",
"RegiÃ³n Los Llanos"
];

function getNombreRegionLimpio(regionKey) {
if (regionKey === "Capital") return "Capital";
return regionKey.replace("RegiÃ³n ", "");
}

const UNIDADES_IPASME = {};
ORDEN_REGIONES.forEach(region => {
const unidadesOriginales = UNIDADES_IPASME_RAW[region] || [];
UNIDADES_IPASME[region] = [...unidadesOriginales].sort((a, b) =>
a.trim().localeCompare(b.trim(), 'es', { sensitivity: 'base' })
);
});

// âœ… VARIABLES GLOBALES PARA ROLES
let isLoggingIn = false;
let isAdmin = false;
let isDesigner = false;
let selectedAMPM = "";
let catType = "";
let catName = "";
let localData = [];
let isMaintActive = false;
let selectedRegionKey = "";
let selectedUnidad = "";
let modoObituario = false;

// âœ… OPTIMIZACIONES DE RENDIMIENTO - CACHE Y VIRTUALIZACIÃ“N
const DATA_CACHE = {
    data: null,
    timestamp: 0,
    serverTimestamp: 0, // âœ… Timestamp del servidor para invalidaciÃ³n
    ttl: 60000, // CAMBIADO: de 5000 a 60000 (60 segundos)
    isLoading: false,
    pendingPromise: null
};

// === AGREGAR ESTO ===
const PAGINATION = {
  currentPage: 1,
  limit: 50,
  totalPages: 1,
  totalRecords: 0,
  isLoading: false
};

const VIRTUAL_SCROLL = {
    enabled: true,
    pageSize: 50,
    currentPage: 1,
    totalPages: 1,
    allData: [],
    renderedData: []
};

let DATA_INDEX = {
    byId: new Map(),
    byStatus: new Map(),
    byDesigner: new Map()
};

// âœ… ACTUALIZAR TABLA CON INVALIDACIÃ“N DE CACHÃ‰ CORRECTA
async function updateTable(forceRefresh = false) {
  const now = Date.now();
  
  // âœ… CORRECCIÃ“N: Guardar y comparar serverTimestamp correctamente
  const serverCacheTimestamp = parseInt(DATA_CACHE.serverTimestamp || "0");
  
  if (serverCacheTimestamp > DATA_CACHE.timestamp) {
    forceRefresh = true;
    console.log("ğŸ”„ CachÃ© del servidor actualizada, refrescando datos...");
  }
  
  if (!forceRefresh && DATA_CACHE.data && (now - DATA_CACHE.timestamp) < DATA_CACHE.ttl) {
    localData = DATA_CACHE.data;
    if(DATA_CACHE.stats) updateCounters(DATA_CACHE.stats);
    renderLocalTableOptimized();
    return;
  }
  
  if (DATA_CACHE.isLoading) {
    await DATA_CACHE.pendingPromise;
    return;
  }
  
  DATA_CACHE.isLoading = true;
  DATA_CACHE.pendingPromise = fetchTableData();
  
  try {
    const result = await DATA_CACHE.pendingPromise;
    DATA_CACHE.data = result.rows;
    DATA_CACHE.stats = result.stats;
    DATA_CACHE.serverTimestamp = result.cacheTimestamp || now; // âœ… GUARDAR CORRECTAMENTE
    DATA_CACHE.timestamp = now;
    localData = result.rows;
    buildDataIndexes();
    
    if (result.stats) {
      updateCounters(result.stats);
    }
    renderLocalTableOptimized();
  } catch (e) {
    console.error("Error cargando tabla:", e);
  } finally {
    DATA_CACHE.isLoading = false;
    DATA_CACHE.pendingPromise = null;
  }
}

// === REEMPLAZAR FUNCIÃ“N COMPLETA ===
async function fetchTableData() {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 15000);
  try {
    // âœ… AGREGAR PARÃMETROS DE PAGINACIÃ“N
    const res = await fetch(`${SCRIPT_URL}?action=read&page=${PAGINATION.currentPage}&limit=${PAGINATION.limit}`, { 
      signal: controller.signal 
    });
    clearTimeout(timeoutId);
    const response = await res.json();
    isMaintActive = (response.maintenance === "true" || response.maintenance === true);
    if (isMaintActive && !isAdmin && !isDesigner) {
      document.getElementById('maintOverlay').style.display = 'flex';
    } else {
      document.getElementById('maintOverlay').style.display = 'none';
    }
    if (response.success && response.data) {
      // âœ… GUARDAR INFO DE PAGINACIÃ“N
      if (response.data.pagination) {
        PAGINATION.totalPages = response.data.pagination.totalPages;
        PAGINATION.totalRecords = response.data.pagination.totalRecords;
        PAGINATION.hasMore = response.data.pagination.hasMore;
      }
      return {
        rows: response.data.rows || response.data,
        stats: response.data.stats || null,
        cacheTimestamp: parseInt(response.data.cacheTimestamp || "0")
      };
    }
    return { rows: [], stats: null, cacheTimestamp: 0 };
  } catch (e) {
    clearTimeout(timeoutId);
    throw e;
  }
}

// âœ… FUNCIÃ“N PARA MANTENER EL ÃNDICE DE DATOS ACTUALIZADO
function maintainDataIndex() {
    // Limpiar Ã­ndices existentes
    DATA_INDEX.byId.clear();
    DATA_INDEX.byStatus.clear();
    DATA_INDEX.byDesigner.clear();
    
    // Reconstruir Ã­ndices con los datos actuales
    localData.forEach((item, index) => {
        // Ãndice por ID (para bÃºsqueda rÃ¡pida)
        if (item.id) {
            DATA_INDEX.byId.set(String(item.id).toUpperCase(), {
                item: item,
                index: index
            });
        }
        
        // Ãndice por estado
        const status = item.Estatus ? item.Estatus.toUpperCase().trim() : '';
        if (status) {
            if (!DATA_INDEX.byStatus.has(status)) {
                DATA_INDEX.byStatus.set(status, []);
            }
            DATA_INDEX.byStatus.get(status).push({ item, index });
        }
        
        // Ãndice por diseÃ±ador
        const designer = item.Disenador ? item.Disenador.trim() : '';
        if (designer) {
            if (!DATA_INDEX.byDesigner.has(designer)) {
                DATA_INDEX.byDesigner.set(designer, []);
            }
            DATA_INDEX.byDesigner.get(designer).push({ item, index });
        }
    });
    
    console.log('âœ… Ãndice de datos actualizado:', {
        totalEntries: DATA_INDEX.byId.size,
        byStatus: Object.fromEntries(DATA_INDEX.byStatus),
        byDesigner: Object.fromEntries(DATA_INDEX.byDesigner)
    });
}

// âœ… FUNCIÃ“N PARA CONSTRUIR ÃNDICES DE DATOS
function buildDataIndexes() {
    maintainDataIndex();
}

// âœ… FUNCIÃ“N RENDER LOCAL TABLE OPTIMIZADA
function renderLocalTableOptimized() {
    renderLocalTable();
}

// âœ… NUEVA VARIABLE GLOBAL CON COLORES DE DISEÃ‘ADORES
const designerColors = {
"Bermina": "#fb8500",
"Jorsy": "#023047",
"MarÃ­a F.": "#2d6a4f",
"Xamir": "#ffb703"
};

// âœ… NUEVA VARIABLE GLOBAL PARA ID DE SOLICITUD EN MODAL DE DISEÃ‘ADOR
// VARIABLE ELIMINADA - Ya no se usa modal de diseÃ±ador, se usa el panel lateral
// let requestIdForDesigner = null; // ELIMINADO

// âœ… VARIABLES GLOBALES PARA BÃšSQUEDA
let currentSearchId = "";
let isSearchActive = false;

// âœ… NUEVA VARIABLE PARA ALMACENAR CREDENCIALES DEL USUARIO ACTUAL
let userCredentials = {
username: "",
password: "",
displayName: "",
role: "", // "admin" o "diseÃ±ador"
designerName: "" // Solo para diseÃ±adores
};

const DATA = {
especialidades: ["AlergologÃ­a", "CardiologÃ­a", "CirugÃ­a general", "DermatologÃ­a", "FisiatrÃ­a", "FoniatrÃ­a", "GastroenterologÃ­a", "GeriatrÃ­a", "GinecologÃ­a y obstetricia", "InfectologÃ­a", "Medicina familiar", "Medicina general", "Medicina interna", "NefrologÃ­a", "NeumologÃ­a", "NeurologÃ­a", "NutriciÃ³n", "OdontologÃ­a", "OftalmologÃ­a", "OncologÃ­a", "OptometrÃ­a", "PediatrÃ­a", "PsicologÃ­a", "PsiquiatrÃ­a", "ReumatologÃ­a", "TraumatologÃ­a", "UrologÃ­a"],
servicios: ["Actividades recreativas", "AfiliaciÃ³n", "Agudeza visual", "AplicaciÃ³n de flÃºor", "AsesorÃ­a legal", "Bienestar social", "CaptaciÃ³n odontolÃ³gica", "CaptaciÃ³n quirÃºrgica general", "CaptaciÃ³n quirÃºrgica oftalmolÃ³gica", "Charlas odontolÃ³gicas", "CitologÃ­a", "Control de glicemia", "Control de talla y peso", "DesparasitaciÃ³n", "Despistaje de glicemia capilar", "Despistaje HTA", "EcografÃ­a", "Electrocardiograma", "EspirometrÃ­a", "Farmacia", "Fisioterapia", "FonoaudiologÃ­a", "GerontologÃ­a", "IngenierÃ­a biomÃ©dica", "InmunizaciÃ³n", "Laboratorio", "LiberaciÃ³n de hipoteca", "Masoterapia", "PodologÃ­a", "Quiropraxia", "Reposos mÃ©dicos", "SesiÃ³n educativa", "Servicios sociales", "Terapia de lenguaje (Logopedia)", "Terapia del dolor", "Terapia ocupacional", "Tipiaje", "Trabajo social"],
vacunas: ["Fiebre amarilla", "Pentavalente", "Polio IPV", "Polio oral", "Toxoide (tetÃ¡nico/diftÃ©rico)", "Trivalente viral (SRP)"],
quirurgica: ["Bocio hiperfuncionante", "ColectomÃ­a", "Enfermedad hemorroidal", "EsterilizaciÃ³n", "Fibromatosis", "Fimosis", "Hernia abdominal", "Hernia epigÃ¡strica", "Hernia escrotal", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "HisterectomÃ­a", "Lipomas", "Litiasis vesicular (ColecistectomÃ­as)", "Lunares", "Miomatosis uterina", "Nevus", "NÃ³dulos mamarios simples", "Paridad satisfecha", "Prolapso", "Quiste (TU)", "Quiste de epidÃ­dimo", "Quiste sebÃ¡ceo", "Quiste tirogloso", "Quistes sebÃ¡ceos", "Tumores ovÃ¡ricos", "Varicocele", "VasectomÃ­a", "Verrugas"],
pediatrica: ["Criptorquidias", "Fimosis", "Hernia epigÃ¡strica", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Quiste tirogloso", "Varicocele"],
oftalmo: ["Cataratas", "CirugÃ­a plÃ¡stica ocular", "DacriocistorrinostomÃ­a", "Desprendimiento de retina", "Glaucoma", "Melanoma uveal", "PterigiÃ³n", "Ptosis palpebral", "QueratoplastÃ­a", "Retinoblastoma", "Tumores oculares"]
};

// âœ… FUNCIÃ“N ÃšNICA DE BÃšSQUEDA POR ID (CON BÃšSQUEDA PARCIAL)
function buscarPorID() {
  const searchInput = document.getElementById('searchIdInput');
  const searchTerm = searchInput.value.trim().toUpperCase();
  currentSearchId = searchTerm;
  isSearchActive = searchTerm.length > 0;
  
  const searchContainer = document.getElementById('designer-search-container');
  if (isAdmin || isDesigner) {
    searchContainer.classList.remove('hidden');
  }
  
  if (!isSearchActive) {
    resetSearchHighlight();
    renderPage(1);
    return;
  }
  
  // âœ… BÃšSQUEDA PARCIAL (busca coincidencias en cualquier parte del ID)
  const matchedEntries = [];
  
  // Iterar sobre el Ã­ndice para encontrar coincidencias parciales
  for (const [id, entry] of DATA_INDEX.byId) {
    if (id.includes(searchTerm)) {
      matchedEntries.push(entry);
    }
  }
  
  if (matchedEntries.length > 0) {
    const body = document.getElementById('solicitudes-body');
    body.innerHTML = '';
    
    // Calcular contadores para los resultados encontrados
    let counts = {
      total: matchedEntries.length,
      pend: 0,
      proc: 0,
      fin: 0,
      bermina: 0,
      jorsy: 0,
      maria: 0,
      xamir: 0
    };
    
    // Renderizar cada resultado encontrado
    matchedEntries.forEach(entry => {
      const tr = createRowElement(entry.item, entry.index);
      tr.classList.add('row-highlighted');
      body.appendChild(tr);
      
      // Actualizar contadores
      if (entry.item.Estatus === 'PENDIENTE') counts.pend++;
      else if (entry.item.Estatus === 'PROCESANDO') counts.proc++;
      else if (entry.item.Estatus === 'FINALIZADA') counts.fin++;
      
      if (entry.item.Disenador === 'Bermina') counts.bermina++;
      else if (entry.item.Disenador === 'Jorsy') counts.jorsy++;
      else if (entry.item.Disenador === 'MarÃ­a F.') counts.maria++;
      else if (entry.item.Disenador === 'Xamir') counts.xamir++;
    });
    
    updateCounters(counts);
    
    // Hacer scroll al primer resultado
    if (matchedEntries.length > 0) {
      const firstRow = body.querySelector('tr');
      if (firstRow) {
        firstRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }
  } else {
    document.getElementById('notFoundId').innerText = currentSearchId;
    document.getElementById('idNotFoundModal').style.display = 'flex';
    
    const body = document.getElementById('solicitudes-body');
    body.innerHTML = `
      <tr>
        <td colspan="8" class="no-results-message show">
          No se encontraron resultados para "${searchTerm}"
        </td>
      </tr>
    `;
  }
}

// âœ… APLICAR RESALTADO Y BLOQUEO
function applySearchHighlight(searchTerm) {
    const rows = document.querySelectorAll('#solicitudes-body tr');
    let foundMatch = false;
    let matchedRow = null;
    rows.forEach(row => {
        // âœ… BUSCAR EN LA PRIMERA COLUMNA (ID) QUE AHORA CONTIENE EL BADGE
        const idCell = row.querySelector('td:first-child');
        const rowId = idCell ? idCell.textContent.trim().toUpperCase() : "";
        
        // âœ… EXTRAER SOLO EL ID (eliminar texto del badge)
        const idOnly = rowId.replace(/NEW|PRIORIZAR/g, '').trim();
        
        // âœ… VERIFICAR COINCIDENCIA
        const isMatch = idOnly.includes(searchTerm);
        if (isMatch) {
            row.classList.add('row-highlighted');
            row.classList.remove('row-locked');
            foundMatch = true;
            matchedRow = row;
            enableRowButtons(row);
        } else {
            row.classList.add('row-locked');
            row.classList.remove('row-highlighted');
            disableRowButtons(row);
        }
    });
    
    // âœ… SCROLL AUTOMÃTICO A LA FILA ENCONTRADA
    if (matchedRow) {
        matchedRow.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
        });
    }
    
    // âœ… MOSTRAR MENSAJE SI NO HAY COINCIDENCIAS
    if (!foundMatch) {
        document.getElementById('notFoundId').innerText = currentSearchId;
        document.getElementById('idNotFoundModal').style.display = 'flex';
    }
}

// âœ… HABILITAR BOTONES EN FILA
function enableRowButtons(row) {
const buttons = row.querySelectorAll('.btn-arte, .btn-ver, .btn-tg');
buttons.forEach(btn => {
btn.disabled = false;
btn.style.opacity = "1";
btn.style.pointerEvents = "auto";
btn.style.cursor = "pointer";
});
}

// âœ… DESHABILITAR BOTONES EN FILA
function disableRowButtons(row) {
const buttons = row.querySelectorAll('.btn-arte, .btn-ver, .btn-tg');
buttons.forEach(btn => {
btn.disabled = true;
btn.style.opacity = "0.4";
btn.style.pointerEvents = "none";
btn.style.cursor = "not-allowed";
});
}

// âœ… RESTABLECER TABLA A ESTADO ORIGINAL
function resetSearchHighlight() {
const rows = document.querySelectorAll('#solicitudes-body tr');

rows.forEach(row => {
row.classList.remove('row-highlighted', 'row-locked');
enableRowButtons(row);
});

// âœ… OCULTAR MENSAJE DE NO RESULTADOS
document.getElementById('idNotFoundModal').style.display = 'none';
}

// âœ… Cerrar modal de ID no encontrado
function closeIdNotFoundModal() {
document.getElementById('idNotFoundModal').style.display = 'none';
document.getElementById('searchIdInput').focus();
}

// âœ… LIMPIAR BÃšSQUEDA
function clearSearch() {
document.getElementById('searchIdInput').value = "";
buscarPorID();

// âœ… FOCO DE NUEVO EN EL INPUT
setTimeout(() => {
document.getElementById('searchIdInput').focus();
}, 100);
}

// âœ… MANEJADOR DE EVENTOS PARA TECLADO
function handleSearchKeydown(e) {
if (e.key === 'Escape') {
clearSearch();
}

// âœ… PREVENIR ENVÃO DEL FORMULARIO AL PRESIONAR ENTER
if (e.key === 'Enter') {
e.preventDefault();
buscarPorID();
}
}

// âœ… INICIALIZAR EVENTOS DEL BUSCADOR
function initSearchEvents() {
const searchInput = document.getElementById('searchIdInput');

if (searchInput) {
// âœ… BÃšSQUEDA EN TIEMPO REAL (con debounce)
let searchTimeout;
searchInput.addEventListener('input', (e) => {
clearTimeout(searchTimeout);
searchTimeout = setTimeout(() => {
buscarPorID();
}, 300); // Esperar 300ms despuÃ©s de dejar de escribir
});

// âœ… MANEJAR TECLAS ESPECIALES
searchInput.addEventListener('keydown', handleSearchKeydown);
}
}

// âœ… ACTUALIZAR VISIBILIDAD DEL BUSCADOR SEGÃšN ROL
function updateSearchVisibility() {
    const searchContainer = document.getElementById('designer-search-container');
    // âœ… MOSTRAR BUSCADOR PARA ADMIN Y DISEÃ‘ADOR
    if (isAdmin || isDesigner) {
        searchContainer.classList.remove('hidden');
        // âœ… INICIALIZAR EVENTOS SI ES LA PRIMERA VEZ
        if (!window.searchEventsInitialized) {
            initSearchEvents();
            window.searchEventsInitialized = true;
        }
    } else {
        searchContainer.classList.add('hidden');
        resetSearchHighlight();
        // âœ… OCULTAR MODAL DE ID NO ENCONTRADO
        document.getElementById('idNotFoundModal').style.display = 'none';
    }
}

// âœ… MODIFICAR FUNCIÃ“N modStatus PARA DETECTAR FINALIZADA Y USAR PANEL
async function modStatus(id, st) {
    const pill = document.getElementById('pill-' + id);
    const oldClass = pill.className;
    const oldText = pill.innerText;
    const newStatusClass = st.toLowerCase().replace(/\s+/g, '');
    pill.className = `status-pill status-${newStatusClass}`;
    pill.innerText = st;
    
    try {
        // âœ… SI ES FINALIZADA Y NO HAY DISEÃ‘ADOR ASIGNADO, MOSTRAR ALERTA EN PANEL
        if (st === "FINALIZADA") {
            const item = localData.find(x => x.id == id);
            if (!item?.Disenador) {
                // Abrir panel y mostrar mensaje
                selectRequest(id);
                openModal("âš ï¸ AtenciÃ³n", "Debes asignar un diseÃ±ador antes de finalizar la solicitud. Usa el panel lateral.", "ğŸ‘¨â€ğŸ¨");
                // Revertir cambio visual
                pill.className = oldClass;
                pill.innerText = oldText;
                return;
            }
        }
        
        const params = new URLSearchParams();
        params.append("action", "updateStatus");
        params.append("id", id);
        params.append("status", st);
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        // âœ… VERIFICAR SI LA RESPUESTA ES JSON VÃLIDO
        const text = await response.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            console.error("Respuesta no vÃ¡lida del servidor:", text);
            throw new Error("Respuesta invÃ¡lida del servidor");
        }
        
        if (data.success) {
            const item = localData.find(x => x.id == id);
            if(item) item.Estatus = st;
            renderLocalTable();
        } else {
            throw new Error(data.error || "Error al actualizar estatus");
        }
    } catch (e) {
        pill.className = oldClass;
        pill.innerText = oldText;
        console.error("Error completo:", e);
        openModal("", "Error de conexiÃ³n: " + e.message, "");
    }
}

function renderLocalTableOptimized() {
    const body = document.getElementById('solicitudes-body');
    // Mostrar spinner ligero
    body.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;color:#888;">Cargando filas...</td></tr>`;

    requestAnimationFrame(() => {
        VIRTUAL_SCROLL.allData = localData;
        VIRTUAL_SCROLL.currentPage = 1;
        VIRTUAL_SCROLL.totalPages = Math.ceil(localData.length / VIRTUAL_SCROLL.pageSize);
        renderPage(1);
    });
}

// NUEVA FUNCIÃ“N: SOLO CALCULA ESTADÃSTICAS SIN BLOQUEAR
function calculateStatsInBackground() {
    let counts = {
        total: 0, pend: 0, proc: 0, fin: 0,
        bermina: 0, jorsy: 0, maria: 0, xamir: 0
    };

    // Iteramos los datos para contar
    localData.forEach(s => {
        counts.total++;
        const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
        const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
        
        if(statusLimpio === 'pendiente') counts.pend++;
        else if(statusLimpio === 'procesando') counts.proc++;
        else if(statusLimpio === 'finalizada') {
            counts.fin++;
            if (s.Disenador) {
                if (s.Disenador === "Bermina") counts.bermina++;
                else if (s.Disenador === "Jorsy") counts.jorsy++;
                else if (s.Disenador === "MarÃ­a F.") counts.maria++;
                else if (s.Disenador === "Xamir") counts.xamir++;
            }
        }
    });

    // Actualizamos la UI con los resultados
    updateCounters(counts);
    console.log(" EstadÃ­sticas actualizadas en segundo plano");
}

// ACTUALIZAR CONTADORES (YA NO CALCULA, SOLO PINTA)
function updateCounters(stats) {
    if (!stats) return;

    // Contadores bÃ¡sicos
    document.getElementById('count-total').innerText = stats.total || 0;
    document.getElementById('count-pend').innerText = stats.pend || 0;
    document.getElementById('count-proc').innerText = stats.proc || 0;
    document.getElementById('count-fin').innerText = stats.fin || 0;

    // Contadores Admin
    document.getElementById('count-total-admin').innerText = stats.total || 0;
    document.getElementById('count-pend-admin').innerText = stats.pend || 0;
    document.getElementById('count-proc-admin').innerText = stats.proc || 0;
    document.getElementById('count-fin-admin').innerText = stats.fin || 0;
    document.getElementById('count-bermina-admin').innerText = stats.bermina || 0;
    document.getElementById('count-jorsy-admin').innerText = stats.jorsy || 0;
    document.getElementById('count-maria-admin').innerText = stats.maria || 0;
    document.getElementById('count-xamir-admin').innerText = stats.xamir || 0;

    // Visibilidad segÃºn rol
    if (isAdmin) {
        document.getElementById('stats-panel').style.display = 'none';
        document.getElementById('combined-stats').style.display = 'flex';
    } else {
        document.getElementById('stats-panel').style.display = 'flex';
        document.getElementById('combined-stats').style.display = 'none';
    }
    
    // Actualizar Headers
    updateSearchVisibility();
    if (isSearchActive && currentSearchId) applySearchHighlight(currentSearchId);
    if (isPanelOpen && selectedRequestId) updatePanelContent();
    
    // âœ… MOSTRAR/OCULTAR COLUMNAS SEGÃšN ROL
    document.getElementById('th-admin').classList.toggle('hidden', !isAdmin);
    document.getElementById('th-designer').classList.toggle('hidden', !isDesigner);
}

function renderPage(pageNum) {
    const body = document.getElementById('solicitudes-body');
    const start = (pageNum - 1) * VIRTUAL_SCROLL.pageSize;
    const end = Math.min(start + VIRTUAL_SCROLL.pageSize, VIRTUAL_SCROLL.allData.length);
    const pageData = VIRTUAL_SCROLL.allData.slice(start, end);
    
    const fragment = document.createDocumentFragment();
    
    pageData.forEach((s, idx) => {
        const tr = createRowElement(s, start + idx);
        fragment.appendChild(tr);
    });
    
    if (pageNum === 1) {
        body.innerHTML = '';
    } else {
        body.lastElementChild?.remove();
    }
    
    body.appendChild(fragment);
    
    if (pageNum < VIRTUAL_SCROLL.totalPages) {
        const remaining = VIRTUAL_SCROLL.allData.length - end;
        const loadMoreRow = document.createElement('tr');
        loadMoreRow.innerHTML = `
            <td colspan="7" style="text-align: center; padding: 20px;">
                <button onclick="loadMoreRows()" 
                        style="padding: 10px 30px; background: #219ebc; color: white; 
                               border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Cargar mÃ¡s (${remaining} restantes)
                </button>
            </td>
        `;
        body.appendChild(loadMoreRow);
    }
}

function loadMoreRows() {
    VIRTUAL_SCROLL.currentPage++;
    renderPage(VIRTUAL_SCROLL.currentPage);
}

// === AGREGAR ESTAS FUNCIONES ===
function updatePaginationControls() {
  const start = (PAGINATION.currentPage - 1) * PAGINATION.limit + 1;
  const end = Math.min(PAGINATION.currentPage * PAGINATION.limit, PAGINATION.totalRecords);
  
  document.getElementById('paginationStart').innerText = PAGINATION.totalRecords > 0 ? start : 0;
  document.getElementById('paginationEnd').innerText = end;
  document.getElementById('paginationTotal').innerText = PAGINATION.totalRecords;
  document.getElementById('currentPageIndicator').innerText = `${PAGINATION.currentPage} / ${PAGINATION.totalPages}`;
  
  // âœ… HABILITAR/DESHABILITAR BOTONES
  document.getElementById('btnFirstPage').disabled = PAGINATION.currentPage === 1;
  document.getElementById('btnPrevPage').disabled = PAGINATION.currentPage === 1;
  document.getElementById('btnNextPage').disabled = PAGINATION.currentPage >= PAGINATION.totalPages;
  document.getElementById('btnLastPage').disabled = PAGINATION.currentPage >= PAGINATION.totalPages;
}

async function changePage(action) {
  if (PAGINATION.isLoading) return;
  
  let newPage = PAGINATION.currentPage;
  
  switch(action) {
    case 'first': newPage = 1; break;
    case 'prev': newPage = Math.max(1, PAGINATION.currentPage - 1); break;
    case 'next': newPage = Math.min(PAGINATION.totalPages, PAGINATION.currentPage + 1); break;
    case 'last': newPage = PAGINATION.totalPages; break;
  }
  
  if (newPage === PAGINATION.currentPage) return;
  
  PAGINATION.isLoading = true;
  PAGINATION.currentPage = newPage;
  
  // âœ… MOSTRAR LOADING
  document.getElementById('paginationControls').style.opacity = '0.5';
  document.getElementById('solicitudes-body').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;"><div class="spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 15px;"></div>Cargando pÃ¡gina...</td></tr>';
  
  try {
    await updateTable(true);
    updatePaginationControls();
  } catch (e) {
    console.error("Error cambiando pÃ¡gina:", e);
    openModal("âŒ Error", "No se pudo cargar la pÃ¡gina", "ğŸ’¥");
    PAGINATION.currentPage = newPage - (action === 'next' || action === 'last' ? 1 : -1);
  } finally {
    PAGINATION.isLoading = false;
    document.getElementById('paginationControls').style.opacity = '1';
  }
}

function createRowElement(s, idx) {
    const tr = document.createElement('tr');
    
    const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
    const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
    const esNueva = (statusReal === "PENDIENTE");
    const esObituario = (s.Jornada || "").toLowerCase().includes("obituario");
    const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
    const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";
    
    if (esNueva) {
        tr.className = esObituario ? "row-obituario" : "row-new";
    }
    if (selectedRequestId === s.id) {
        tr.classList.add('row-selected-panel');
    }
    
    let badge = '';
    if (esNueva) {
        badge = esObituario 
            ? '<span class="badge-prioridad">PRIORIZAR</span>'
            : '<span class="badge-new">NEW</span>';
    }
    
    let designerCircle = '';
    if (s.Disenador) {
        const color = designerColors[s.Disenador] || '#6c757d';
        designerCircle = `<span class="designer-circle" style="background-color: ${color};" title="${s.Disenador}"></span>`;
    }
    
    const icon = (s.Soportes && s.Soportes.includes("SÃ")) 
        ? `ğŸ“· (${s.Soportes.match(/\d+/) || 1})` 
        : "ğŸ™ˆ";
    
    const fechaEventoFormat = extraerFecha(s.Fecha);
    const horaEvento = s.Hora && s.Hora.trim() !== '' ? s.Hora : 'Sin hora';
    const isRegularUser = !isAdmin && !isDesigner;
    
    if (isRegularUser) {
        const fechaSolicitudFormat = extraerFecha(s.Timestamp);
        const horaSolicitudFormat = extraerHora(s.Timestamp);
        
        tr.innerHTML = `
            <td>
                <span class="txt-bold">${fechaSolicitudFormat}</span><br>
                <span class="txt-small">${horaSolicitudFormat}</span>
            </td>
            <td>
                <span class="txt-bold">${fechaEventoFormat}</span><br>
                <span class="txt-small">${horaEvento}</span>
            </td>
            <td class="txt-bold">${unidadLimpia} ${badge}</td>
            <td>${jornadaLimpia}</td>
            <td align="center">${icon}</td>
            <td>
                ${designerCircle}
                <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
            </td>
        `;
    } else {
        // ADMIN O DISEÃ‘ADOR: LÃ³gica de Iconos Condicional Robusta
        // Verificamos que ArteFinal exista y no estÃ© vacÃ­o
        const hasArt = (s.ArteFinal && s.ArteFinal.trim() !== "" && s.ArteFinal !== "null");
        
        let actionIcon, actionText;

        if (hasArt) {
            // HAY ARCHIVO: Clip Verde
            actionIcon = '<span style="color: var(--verde); font-size: 1.3rem;">ğŸ“</span>';
            actionText = '<span style="color: var(--verde);">Archivo Adjunto</span>';
        } else {
            // NO HAY ARCHIVO: Mano Naranja
            actionIcon = '<span style="color: #fb8500; font-size: 1.3rem;">ğŸ‘†</span>';
            actionText = '<span>Click para seleccionar</span>';
        }

        tr.innerHTML = `
        <td>
            <span class="txt-bold">${s.id}</span>
            ${badge}
        </td>
        <td>
            <span class="txt-bold">${fechaEventoFormat}</span><br>
            <span class="txt-small">${horaEvento}</span>
        </td>
        <td class="txt-bold">${unidadLimpia}</td>
        <td>${jornadaLimpia}</td>
        <td align="center">${icon}</td>
        <td>
            ${designerCircle}
            <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
        </td>
        <!-- COLUMNA DE ACCIONES CON ICONO CONDICIONAL Y TEXTO ALINEADO -->
        <td align="right" class="admin-actions-cell">
            <div class="admin-actions-content">
                ${actionIcon}
                ${actionText}
            </div>
        </td>
        `;
        
        // AGREGAR VERIFICACIÃ“N: Solo permitir selecciÃ³n si es admin o diseÃ±ador
        if (!isRegularUser) {
            tr.style.cursor = 'pointer';
            tr.addEventListener('click', function(e) {
                // VERIFICACIÃ“N ADICIONAL: No seleccionar si ya no es admin/diseÃ±ador
                if (!isAdmin && !isDesigner) return;
                // No seleccionar si se hizo click en un botÃ³n o enlace
                if (e.target.closest('button') || e.target.closest('a')) return;
                selectRequest(s.id);
            });
        }
    }
    
    return tr;
}

// âœ… FUNCIÃ“N UNIFICADA PARA MANEJO DE FECHAS
function formatearFecha(valor, formato = 'datetime') {
  if (!valor || valor.toString().trim() === "") return "";
  
  var fechaObj;
  if (valor instanceof Date) {
    fechaObj = valor;
  } else if (typeof valor === 'string') {
    // Parsear string de fecha
    var texto = valor.trim().replace(/-/g, '/');
    var partes = texto.split(' ');
    var fechaPart = partes[0];
    
    if (fechaPart.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
      var dmy = fechaPart.split('/');
      fechaObj = new Date(parseInt(dmy[2]), parseInt(dmy[1]) - 1, parseInt(dmy[0]));
    } else if (fechaPart.match(/^\d{4}\/\d{1,2}\/\d{1,2}/)) {
      var iso = fechaPart.split('/');
      fechaObj = new Date(parseInt(iso[0]), parseInt(iso[1]) - 1, parseInt(iso[2]));
    } else {
      return valor;
    }
  } else {
    return valor;
  }
  
  if (!fechaObj || isNaN(fechaObj.getTime())) return "";
  
  // Formatear segÃºn tipo
  var dd = String(fechaObj.getDate()).padStart(2, '0');
  var mm = String(fechaObj.getMonth() + 1).padStart(2, '0');
  var yyyy = fechaObj.getFullYear();
  
  if (formato === 'date') {
    return dd + '/' + mm + '/' + yyyy;
  } else if (formato === 'datetime') {
    var hh = String(fechaObj.getHours()).padStart(2, '0');
    var min = String(fechaObj.getMinutes()).padStart(2, '0');
    return dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + min;
  } else {
    return dd + '/' + mm + '/' + yyyy;
  }
}

function extraerFecha(dateTime) {
  if (!dateTime) return "";
  return dateTime.split(' ')[0] || "";
}

function extraerHora(dateTime) {
  if (!dateTime) return "";
  var partes = dateTime.trim().split(' ');
  if (partes.length < 2) return "Sin hora";
  return partes.slice(1).join(' ');
}

// FUNCIÃ“N CORREGIDA: RENDER LOCAL TABLE PARA TODOS LOS ROLES
function renderLocalTable() {
    const body = document.getElementById('solicitudes-body');
    body.innerHTML = "";
    let counts = {
        total: 0,
        pend: 0,
        proc: 0,
        fin: 0,
        bermina: 0,
        jorsy: 0,
        maria: 0,
        xamir: 0
    };
    
    // USAR DIRECTAMENTE localData (YA ORDENADO DEL BACKEND)
    // Determinar si es usuario regular (ni admin ni diseÃ±ador)
    const isRegularUser = !isAdmin && !isDesigner;
    
    
    localData.forEach((s, idx) => {
        counts.total++;
        const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
        const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
        
        if(statusLimpio === 'pendiente') counts.pend++;
        if(statusLimpio === 'procesando') counts.proc++;
        if(statusLimpio === 'finalizada') {
            counts.fin++;
            // âœ… CONTAR POR DISEÃ‘ADOR
            if (s.Disenador) {
                if (s.Disenador === "Bermina") counts.bermina++;
                else if (s.Disenador === "Jorsy") counts.jorsy++;
                else if (s.Disenador === "MarÃ­a F.") counts.maria++;
                else if (s.Disenador === "Xamir") counts.xamir++;
            }
        }
        
        // âœ… CAMBIO: TODAS las pendientes son NEW (sin lÃ­mite de 5)
        const esNueva = (statusReal === "PENDIENTE");
        const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
        const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";
        
        let badge = '';
        let rowClass = '';
        if (esNueva) {
            if (jornadaLimpia === "Obituario") {
                badge = '<span class="badge-prioridad">PRIORIZAR</span>';
                rowClass = "row-obituario";
            } else {
                badge = '<span class="badge-new">NEW</span>'; // âœ… Texto cambiado a "NEW"
                rowClass = "row-new";
            }
        }
        
        // âœ… CÃRCULO DE DISEÃ‘ADOR - AHORA VISIBLE EN CUALQUIER ESTADO
        let designerCircle = '';
        if (s.Disenador) {
            const color = designerColors[s.Disenador] || '#6c757d';
            designerCircle = `<span class="designer-circle" style="background-color: ${color};" title="${s.Disenador}"></span>`;
        }
        
        let icon = (s.Soportes && s.Soportes.includes("SÃ")) ? `ğŸ“· (${s.Soportes.match(/\d+/) || 1})` : "ğŸ™ˆ";
        
        // âœ… FORMATEAR FECHAS Y HORAS CON VALIDACIÃ“N
        const fechaSolicitudFormat = extraerFecha(s.Timestamp);
        const horaSolicitudFormat = extraerHora(s.Timestamp);
        const fechaEventoFormat = extraerFecha(s.Fecha);
        const horaEvento = s.Hora && s.Hora.trim() !== '' ? s.Hora : 'Sin hora';
        
        const tr = document.createElement('tr');
        if(rowClass) tr.className = rowClass;
        
        // âœ… AGREGAR CLASE DE SELECCIÃ“N SI ESTÃ SELECCIONADA
        if (selectedRequestId === s.id) {
            tr.classList.add('row-selected-panel');
        }
        
        // âœ… RENDERIZAR FILAS SEGÃšN ROL DEL USUARIO
        if (isRegularUser) {
            // USUARIO REGULAR: Muestra fecha solicitud/hora, fecha evento/hora, unidad, jornada, soportes, status
            tr.innerHTML = `
                <td>
                    <span class="txt-bold">${fechaSolicitudFormat}</span><br>
                    <span class="txt-small">${horaSolicitudFormat}</span>
                </td>
                <td>
                    <span class="txt-bold">${fechaEventoFormat}</span><br>
                    <span class="txt-small">${horaEvento}</span>
                </td>
                <td class="txt-bold">${unidadLimpia} ${badge}</td>
                <td>${jornadaLimpia}</td>
                <td align="center">${icon}</td>
                <td>
                    ${designerCircle}
                    <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
                </td>
                <td></td>
            `;
        } else {
            // ADMIN O DISEÃ‘ADOR: LÃ³gica de Iconos Condicional Robusta
            // Verificamos que ArteFinal exista y no estÃ© vacÃ­o
            const hasArt = (s.ArteFinal && s.ArteFinal.trim() !== "" && s.ArteFinal !== "null");
            
            let actionIcon, actionText;

            if (hasArt) {
                // HAY ARCHIVO: Clip Verde
                actionIcon = '<span style="color: var(--verde); font-size: 1.3rem;">ğŸ“</span>';
                actionText = '<span style="color: var(--verde);">Archivo Adjunto</span>';
            } else {
                // NO HAY ARCHIVO: Mano Naranja
                actionIcon = '<span style="color: #fb8500; font-size: 1.3rem;">ğŸ‘†</span>';
                actionText = '<span>Click para seleccionar</span>';
            }

            tr.innerHTML = `
            <td>
                <span class="txt-bold">${s.id}</span>
                ${badge}
            </td>
            <td>
                <span class="txt-bold">${fechaEventoFormat}</span><br>
                <span class="txt-small">${horaEvento}</span>
            </td>
            <td class="txt-bold">${unidadLimpia}</td>
            <td>${jornadaLimpia}</td>
            <td align="center">${icon}</td>
            <td>
                ${designerCircle}
                <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
            </td>
            <!-- COLUMNA DE ACCIONES CON ICONO CONDICIONAL Y TEXTO ALINEADO -->
            <td align="right" class="admin-actions-cell">
                <div class="admin-actions-content">
                    ${actionIcon}
                    ${actionText}
                </div>
            </td>
            `;
            
            // AGREGAR VERIFICACIÃ“N: Solo permitir selecciÃ³n si es admin o diseÃ±ador
            if (!isRegularUser) {
                tr.style.cursor = 'pointer';
                tr.addEventListener('click', function(e) {
                    // VERIFICACIÃ“N ADICIONAL: No seleccionar si ya no es admin/diseÃ±ador
                    // âœ… VERIFICACIÃ“N ADICIONAL: No seleccionar si ya no es admin/diseÃ±ador
                    if (!isAdmin && !isDesigner) return;
                    // No seleccionar si se hizo click en un botÃ³n o enlace
                    if (e.target.closest('button') || e.target.closest('a')) return;
                    selectRequest(s.id);
                });
            }
        }
        
        body.appendChild(tr);
    });
    
    // âœ… ACTUALIZAR CONTADORES (MODO ADMIN + USUARIO REGULAR)
    // Actualizar siempre los contadores bÃ¡sicos (para usuarios regulares)
    document.getElementById('count-total').innerText = counts.total;
    document.getElementById('count-pend').innerText = counts.pend;
    document.getElementById('count-proc').innerText = counts.proc;
    document.getElementById('count-fin').innerText = counts.fin;
    
    // âœ… MOSTRAR CONTADORES COMBINADOS SOLO PARA ADMIN
    if (isAdmin) {
      // Ocultar contadores bÃ¡sicos
      document.getElementById('stats-panel').style.display = 'none';
      // Mostrar contadores combinados
      document.getElementById('combined-stats').style.display = 'flex';
      // Actualizar TODOS los contadores (generales + diseÃ±adores)
      document.getElementById('count-total-admin').innerText = counts.total;
      document.getElementById('count-pend-admin').innerText = counts.pend;
      document.getElementById('count-proc-admin').innerText = counts.proc;
      document.getElementById('count-fin-admin').innerText = counts.fin;
      document.getElementById('count-bermina-admin').innerText = counts.bermina;
      document.getElementById('count-jorsy-admin').innerText = counts.jorsy;
      document.getElementById('count-maria-admin').innerText = counts.maria;
      document.getElementById('count-xamir-admin').innerText = counts.xamir;
    } else {
      // Mostrar contadores bÃ¡sicos para usuarios regulares
      document.getElementById('stats-panel').style.display = 'flex';
      document.getElementById('combined-stats').style.display = 'none';
    }
    
    // âœ… MOSTRAR/OCULTAR COLUMNAS SEGÃšN ROL
    document.getElementById('th-admin').classList.toggle('hidden', !isAdmin);
    document.getElementById('th-designer').classList.toggle('hidden', !isDesigner);
    
    // âœ… ACTUALIZAR ENCABEZADOS DE TABLA
    const thId = document.querySelector('th:first-child');
    const thFechaEvento = document.querySelector('th:nth-child(2)');
    const thUnidad = document.querySelector('th:nth-child(3)');
    const thJornada = document.querySelector('th:nth-child(4)');
    // Seleccionamos el encabezado visible (Admin o DiseÃ±ador)
    const thActions = isAdmin ? document.getElementById('th-admin') : document.getElementById('th-designer');

    if (isRegularUser) {
        thId.innerHTML = 'ğŸ“… FECHA SOLICITUD';
        thFechaEvento.innerHTML = 'ğŸ—“ï¸ FECHA EVENTO';
        thUnidad.innerHTML = 'ğŸ¥ UNIDAD';
        thJornada.innerHTML = 'ğŸ“‹ TIPO JORNADA';
        // Ocultar encabezados de acciones si es usuario regular
        document.getElementById('th-admin').classList.add('hidden');
        document.getElementById('th-designer').classList.add('hidden');
    } else {
        thId.innerHTML = 'ID SOLICITUD';
        thFechaEvento.innerHTML = 'ğŸ—“ï¸ FECHA EVENTO';
        thUnidad.innerHTML = 'UNIDAD SOLICITANTE';
        thJornada.innerHTML = 'TIPO DE JORNADA';
        
        // âœ… CAMBIO: Texto dinÃ¡mico segÃºn el rol
        if (isAdmin) {
            thActions.innerHTML = 'ACCIONES ADMIN';
            thActions.classList.remove('hidden');
            document.getElementById('th-designer').classList.add('hidden');
        } else if (isDesigner) {
            thActions.innerHTML = 'ACCIONES DISEÃ‘O';
            thActions.classList.remove('hidden');
            document.getElementById('th-admin').classList.add('hidden');
        }
    }
    
    // âœ… ACTUALIZAR VISIBILIDAD DEL BUSCADOR
    updateSearchVisibility();
    
    // âœ… SI HAY BÃšSQUEDA ACTIVA, REAPLICAR FILTRO
    if (isSearchActive && currentSearchId) {
        applySearchHighlight(currentSearchId);
    }
    
    // âœ… ACTUALIZAR PANEL SI ESTÃ ABIERTO
    if (isPanelOpen && selectedRequestId) {
        updatePanelContent();
    }
}

// FUNCIONES DEL PANEL LATERAL
function openSidePanel() {
    // AGREGAR: Verificar permisos antes de abrir
    if (!isAdmin && !isDesigner) {
        console.log("â›” Intento de abrir panel sin permisos");
        return;
    }
    
    const panel = document.getElementById('sidePanel');
    const overlay = document.getElementById('panelOverlay');
    
    panel.classList.add('active');
    overlay.classList.add('active');
    isPanelOpen = true;
    
    // Actualizar contenido
    updatePanelContent();
    
    // âœ… INICIAR SINCRONIZACIÃ“N AUTOMÃTICA
    iniciarSincronizacionPanel();
}

function closeSidePanel() {
    const panel = document.getElementById('sidePanel');
    const overlay = document.getElementById('panelOverlay');
    
    panel.classList.remove('active');
    overlay.classList.remove('active');
    isPanelOpen = false;
    
    // âœ… DETENER SINCRONIZACIÃ“N AUTOMÃTICA
    if (panelSyncInterval) {
        clearInterval(panelSyncInterval);
        panelSyncInterval = null;
    }
    
    // Deseleccionar fila visualmente (pero mantener selectedRequestId para referencia)
    document.querySelectorAll('.row-selected-panel').forEach(row => {
        row.classList.remove('row-selected-panel');
    });
}

function selectRequest(id) {
    // AGREGAR: Verificar permisos antes de seleccionar
    if (!isAdmin && !isDesigner) {
        console.log("â›” Intento de selecciÃ³n sin permisos");
        return; // No permitir selecciÃ³n si no es admin o diseÃ±ador
    }
    
    // Si ya estÃ¡ seleccionada, no hacer nada
    if (selectedRequestId === id && isPanelOpen) return;
    
    // Actualizar selecciÃ³n
    selectedRequestId = id;
    selectedRequestData = localData.find(x => x.id == id);
    
    // Abrir panel automÃ¡ticamente
    openSidePanel();
    
    // Actualizar tabla para mostrar selecciÃ³n visual
    renderLocalTable();
}

function updatePanelContent() {
    const container = document.getElementById('selectedRequestContent');
    const hasSelection = selectedRequestId && selectedRequestData;
    if (!hasSelection) {
        container.innerHTML = `
        <div class="no-selection">
            <div class="no-selection-icon">ğŸ“­</div>
            <div>Selecciona una solicitud<br>de la tabla para activar<br>las acciones</div>
        </div>
        `;
        disableAllPanelButtons();
        updateFilePreview(null);
        return;
    }

    // Mostrar info de solicitud
    const esObituario = (selectedRequestData.Jornada || "").toLowerCase().includes("obituario");
    const badge = esObituario ? '<span class="badge-prioridad">PRIORIZAR</span>' :
        (selectedRequestData.Estatus === 'PENDIENTE' ? '<span class="badge-new">NEW</span>' : '');
    container.innerHTML = `
    <div class="selected-request-id">${selectedRequestId} ${badge}</div>
    <div class="selected-request-info">
        <strong>${selectedRequestData.Unidad}</strong><br>
        ${selectedRequestData.Jornada}<br>
        ğŸ“… ${selectedRequestData.Fecha} ${selectedRequestData.Hora ? '| ' + selectedRequestData.Hora : ''}
    </div>
    `;

    // Actualizar indicadores de estado (luces)
    const currentStatus = (selectedRequestData.Estatus || "").toUpperCase();
    document.getElementById('indPend').classList.toggle('active', currentStatus === 'PENDIENTE');
    document.getElementById('indProc').classList.toggle('active', currentStatus === 'PROCESANDO');
    document.getElementById('indFin').classList.toggle('active', currentStatus === 'FINALIZADA');

    // âœ… CORRECCIÃ“N: Habilitar botones segÃºn permisos (Esto activa los botones de estado)
    enablePanelButtons();

    // Referencias a elementos sensibles
    const designerSection = document.getElementById('designerAssignSection');
    const adminActionsSection = document.getElementById('adminActions');
    const statusActionsSection = document.getElementById('statusActions');
    const btnMaint = document.getElementById('btnMaint');
    const btnReportPanel = document.getElementById('btnReportPanel');

    // âœ… LÃ“GICA DE VISIBILIDAD POR ROL
    if (isAdmin) {
        // ADMIN: Acceso total (Estatus, DiseÃ±adores, Mantenimiento, Reporte)
        designerSection.classList.remove('hidden');
        adminActionsSection.classList.remove('hidden');
        statusActionsSection.classList.remove('hidden');
        
        if(btnMaint) btnMaint.style.display = 'flex';
        if(btnReportPanel) btnReportPanel.style.display = 'flex';

        // Habilitar botones de asignaciÃ³n y eliminaciÃ³n
        document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = false);
        document.getElementById('btnEliminar').disabled = false;

        // Marcar diseÃ±ador seleccionado visualmente
        if (selectedRequestData?.Disenador) {
            document.querySelectorAll('.designer-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.includes(selectedRequestData.Disenador));
            });
        } else {
            document.querySelectorAll('.designer-btn').forEach(btn => btn.classList.remove('selected'));
        }

    } else if (isDesigner) {
        // DISEÃ‘ADOR: Solo Archivo. OCULTAR Estatus, Mantenimiento y Reporte.
        designerSection.classList.add('hidden');
        adminActionsSection.classList.add('hidden');
        statusActionsSection.classList.add('hidden'); // Ocultar botones de estado
        
        if(btnMaint) btnMaint.style.display = 'none'; // Ocultar Mantenimiento
        if(btnReportPanel) btnReportPanel.style.display = 'none'; // Ocultar Reporte
        
        document.getElementById('btnEliminar').disabled = true;

    } else {
        // USUARIO REGULAR: Sin acceso a panel de gestiÃ³n
        designerSection.classList.add('hidden');
        adminActionsSection.classList.add('hidden');
        statusActionsSection.classList.add('hidden');
        
        if(btnMaint) btnMaint.style.display = 'none';
        if(btnReportPanel) btnReportPanel.style.display = 'none';
        
        document.getElementById('btnEliminar').disabled = true;
    }

    // Actualizar vista previa de archivo
    updateFilePreview(selectedRequestData.ArteFinal);

    // âœ… HABILITAR ACCIONES DE ARCHIVO (ComÃºn para Admin y DiseÃ±ador)
    // (Nota: enablePanelButtons ya habilita estos botones, pero esto asegura el estado de Telegram/Ver)
    const hasArt = !!selectedRequestData?.ArteFinal;
    document.getElementById('btnAdjuntar').disabled = !(isAdmin || isDesigner);
    document.getElementById('btnVerArte').disabled = !hasArt;
    document.getElementById('btnEnviarTG').disabled = !hasArt;
}

function updateFilePreview(arteUrl) {
    const container = document.getElementById('filePreviewContainer');
    const info = document.getElementById('filePreviewInfo');
    
    if (!arteUrl) {
        container.innerHTML = `
        <div class="file-preview-placeholder">
        <div class="file-preview-placeholder-icon">ğŸ“</div>
        <div>No hay archivo adjunto</div>
        </div>
        `;
        info.innerHTML = '';
        document.getElementById('btnVerArte').disabled = true;
        document.getElementById('btnEnviarTG').disabled = true;
        return;
    }
    
    // Extraer ID de archivo de Google Drive
    const fileIdMatch = arteUrl.match(/\/file\/d\/([-\w]{25,})/) || arteUrl.match(/[-\w]{25,}/);
    if (!fileIdMatch) {
        container.innerHTML = `
        <div class="file-preview-placeholder">
        <div class="file-preview-placeholder-icon">â“</div>
        <div>No se puede previsualizar</div>
        </div>
        `;
        return;
    }
    
    const fileId = fileIdMatch[1];
    // Usar thumbnail de Google Drive - IMAGEN COMPLETA A ESCALA REDUCIDA
    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
    
    container.innerHTML = `
    <img src="" class="file-preview-image-full" onclick="window.open('${arteUrl}', '_blank')" title="Click para ver en tamaÃ±o completo">
    `;
    
    // âœ… LAZY LOADING CON INTERSECTION OBSERVER
    const img = container.querySelector('img');
    if (img) {
        img.loading = 'lazy';
        img.setAttribute('data-src', thumbnailUrl);
        
        // âœ… CARGAR SÃ“LO CUANDO SEA VISIBLE
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.getAttribute('data-src');
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: '50px' });
        
        observer.observe(img);
    }
    
    info.innerHTML = 'ğŸ’¾ Archivo adjunto disponible';
    
    document.getElementById('btnVerArte').disabled = false;
    document.getElementById('btnEnviarTG').disabled = false;
}

function disableAllPanelButtons() {
    const buttons = document.querySelectorAll('.panel-btn:not(#btnMaint):not(#btnReport)');
    buttons.forEach(btn => btn.disabled = true);
    document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = true);
}

function enablePanelButtons() {
    // Botones de estado (Admin y DiseÃ±ador pueden cambiar estado)
    document.getElementById('btnStatusPend').disabled = false;
    document.getElementById('btnStatusProc').disabled = false;
    document.getElementById('btnStatusFin').disabled = false;
    
    // Botones de archivo
    document.getElementById('btnAdjuntar').disabled = false;
    document.getElementById('btnVerArte').disabled = !selectedRequestData?.ArteFinal;
    document.getElementById('btnEnviarTG').disabled = !selectedRequestData?.ArteFinal;
    
    // Botones especiales de Admin
    if (isAdmin) {
        document.getElementById('btnEliminar').disabled = false;
        document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = false);
    }
}

// âœ… ACCIONES DEL PANEL
async function changeStatus(newStatus) {
    if (!selectedRequestId) return;
    
    // Si es finalizada y no hay diseÃ±ador asignado (solo admin), mostrar alerta
    if (newStatus === 'FINALIZADA' && isAdmin && !selectedRequestData?.Disenador) {
        openModal("âš ï¸ AtenciÃ³n", "Debes asignar un diseÃ±ador antes de finalizar la solicitud.", "ğŸ‘¨â€ğŸ¨");
        return;
    }
    
    document.getElementById('loadMainTxt').innerText = "Actualizando estado...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        // === REEMPLAZAR EL FETCH POR ===
        const result = await batchRequest('updateStatus', {
            id: selectedRequestId,
            status: newStatus,
            username: userCredentials.username,
            password: userCredentials.password,
            disenador: newStatus === 'FINALIZADA' ? selectedRequestData?.Disenador : ''
        });
        
        const data = result;
        
        if (data.success) {
            // Actualizar datos locales
            const item = localData.find(x => x.id == selectedRequestId);
            if (item) {
                item.Estatus = newStatus;
                if (newStatus === 'FINALIZADA' && selectedRequestData?.Disenador) {
                    item.Disenador = selectedRequestData.Disenador;
                }
                selectedRequestData = item;
            }
            
            // Actualizar panel y tabla
            updatePanelContent();
            renderLocalTable();
            
            openModal("âœ… Ã‰xito", `Estado actualizado a ${newStatus}`, "ğŸ”„");
        } else {
            throw new Error(data.error || "Error al actualizar estado");
        }
    } catch (e) {
        console.error("Error completo:", e);
        openModal("âŒ Error", e.message, "ğŸ’¥");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

async function assignDesigner(designerName) {
    if (!isAdmin || !selectedRequestId) return;
    
    document.getElementById('loadMainTxt').innerText = "Asignando diseÃ±ador...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const params = new URLSearchParams();
        params.append("action", "assignDesigner");
        params.append("id", selectedRequestId);
        params.append("disenador", designerName);
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        // âœ… VERIFICAR SI LA RESPUESTA ES JSON VÃLIDO
        const text = await response.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            console.error("Respuesta no vÃ¡lida del servidor:", text);
            throw new Error("Respuesta invÃ¡lida del servidor");
        }
        
        if (data.success) {
            // Actualizar datos locales
            const item = localData.find(x => x.id == selectedRequestId);
            if (item) {
                item.Disenador = designerName;
                selectedRequestData = item;
            }
            
            // Actualizar UI
            document.querySelectorAll('.designer-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.includes(designerName)) {
                    btn.classList.add('selected');
                }
            });
            
            renderLocalTable();
            openModal("âœ… Ã‰xito", `DiseÃ±ador ${designerName} asignado`, "ğŸ‘¨â€ğŸ¨");
        } else {
            throw new Error(data.error || "Error al asignar diseÃ±ador");
        }
    } catch (e) {
        console.error("Error completo:", e);
        openModal("âŒ Error", e.message, "ğŸ’¥");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function panelAdjuntarArte() {
    if (!selectedRequestId) return;
    openArteModal(selectedRequestId);
}

function panelVerArte() {
    if (!selectedRequestData?.ArteFinal) return;
    window.open(selectedRequestData.ArteFinal, '_blank');
}

async function panelEnviarTelegram() {
    if (!selectedRequestId || !selectedRequestData?.ArteFinal) return;
    
    if(!confirm("Â¿Enviar el arte de " + selectedRequestId + " a Telegram?")) return;
    
    document.getElementById('loadMainTxt').innerText = "Enviando a Telegram...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const params = new URLSearchParams();
        params.append("action", "sendTelegramArte");
        params.append("id", selectedRequestId);
        
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const data = await res.json();
        
        if(data.success) {
            openModal("âœˆï¸ Telegram", "Â¡Enviado a Telegram en alta calidad!", "ğŸ“²");
        } else {
            throw new Error(data.error);
        }
    } catch (e) {
        openModal("âŒ Error", e.message, "ğŸ’¥");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function panelEliminar() {
    if (!isAdmin || !selectedRequestId) return;
    deleteReq(selectedRequestId);
}

// âœ… POLLING PARA SINCRONIZACIÃ“N EN TIEMPO REAL
function iniciarSincronizacionPanel() {
    if (panelSyncInterval) clearInterval(panelSyncInterval);
    
    // Actualizar panel cada 30 segundos si estÃ¡ abierto
    panelSyncInterval = setInterval(() => {
        if (isPanelOpen && selectedRequestId) {
            actualizarDatosPanel();
        }
    }, 30000); // 30 segundos
}

async function actualizarDatosPanel() {
    if (!selectedRequestId) return;
    
    try {
        const params = new URLSearchParams();
        params.append("action", "getRequestData");
        params.append("id", selectedRequestId);
        
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        const data = await res.json();
        
        if (data.success && data.data) {
            // Actualizar datos locales
            const index = localData.findIndex(x => x.id == selectedRequestId);
            if (index !== -1) {
                localData[index] = data.data;
                selectedRequestData = data.data;
                updatePanelContent();
            }
        }
    } catch (e) {
        console.error("Error sincronizando panel:", e);
    }
}

// âœ… FUNCIONES PARA REPORTE MENSUAL - SOLO ADMIN
function generateMonthlyReport() {
if (!isAdmin) {
openModal("âŒ Acceso Denegado", "Solo los administradores pueden generar reportes.", "ğŸ”");
return;
}

// Verificar que sea el primer dÃ­a del mes
const today = new Date();
if (today.getDate() !== 1) {
openModal("â³ No disponible", "El reporte mensual solo estÃ¡ disponible el primer dÃ­a de cada mes.", "ğŸ“Š");
return;
}

// âœ… CONFIRMACIÃ“N NATIVA DEL NAVEGADOR (SEGURA Y BLOQUEANTE)
if (!confirm("âš ï¸ Â¿CONFIRMA que desea generar el reporte mensual del mes anterior?\n" +
"âœ… Se enviarÃ¡ por correo y Telegram\n" +
"âœ… Luego se eliminarÃ¡n SOLO las solicitudes finalizadas con fecha de registro del mes anterior\n" +
"â„¹ï¸ Las solicitudes creadas HOY (1Â° de mes) NO serÃ¡n eliminadas\n" +
"âš ï¸ Esta acciÃ³n es IRREVERSIBLE para las del mes anterior")) {
return;
}

document.getElementById('loadMainTxt').innerText = "Generando reporte mensual...";
document.getElementById('loadingOverlay').style.display = 'flex';

// Funcion auxiliar para esperar
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// Primero generar el reporte, LUEGO eliminar las finalizadas
fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=generateMonthlyReport&username=${encodeURIComponent(userCredentials.username)}&password=${encodeURIComponent(userCredentials.password)}`
})
.then(response => response.json())
.then(async data => {
if (data.success) {
openModal("âœ… Reporte Generado",
"El reporte mensual ha sido generado y enviado correctamente.\n" +
"Ahora se procederÃ¡ a eliminar las solicitudes finalizadas del mes anterior.",
"ğŸ“Š");
await delay(2000);
document.getElementById('loadMainTxt').innerText = "Eliminando solicitudes finalizadas del mes anterior...";
const deleteResponse = await fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=deleteFinalizadas&username=${encodeURIComponent(userCredentials.username)}&password=${encodeURIComponent(userCredentials.password)}`
});
const deleteData = await deleteResponse.json();
if (deleteData.success) {
openModal("âœ… Limpieza Completada",
`Reporte generado y ${deleteData.count || 0} solicitudes finalizadas eliminadas correctamente.`,
"ğŸ“Š");
updateTable();
} else {
throw new Error(deleteData.error || "Error al limpiar solicitudes");
}
} else {
throw new Error(data.error || "Error al generar el reporte");
}
})
.catch(err => {
openModal("âŒ Error", "Error: " + err.message, "ğŸ’¥");
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}

// âœ… FUNCIÃ“N PARA ACTUALIZAR EL ESTADO DEL BOTÃ“N DE REPORTE (HEADER Y PANEL)
function updateReportButtonStatus() {
const today = new Date();
const currentDay = today.getDate();
const totalDaysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
const btnHeader = document.getElementById('reportBtn');
const btnPanel = document.getElementById('btnReportPanel');
const textHeader = document.getElementById('reportBtnText');
const textPanel = document.getElementById('reportBtnTextPanel');
const daysHeader = document.getElementById('reportBtnDays');
const daysPanel = document.getElementById('reportBtnDaysPanel');

// Calcular dÃ­as restantes
let daysRemaining;
let isAvailable = currentDay === 1;

if (currentDay === 1) {
daysRemaining = 0;
} else {
daysRemaining = totalDaysInMonth - currentDay + 1;
}

// FunciÃ³n auxiliar para actualizar un botÃ³n
function updateBtn(btn, text, daysBadge, isPanel) {
if (!btn) return;

if (isAvailable) {
daysBadge.textContent = 'Hoy';
daysBadge.classList.add('show');
btn.disabled = false;
btn.style.cursor = 'pointer';
text.style.opacity = '1';
btn.style.background = 'linear-gradient(to right, #2d6a4f 100%, #1e4a35 100%)';
} else {
daysBadge.textContent = `${daysRemaining}d`;
daysBadge.classList.add('show');
btn.disabled = true;
btn.style.cursor = 'not-allowed';
text.style.opacity = '0.7';

// Calcular progreso
const progress = ((totalDaysInMonth - daysRemaining) / totalDaysInMonth) * 100;
btn.style.background = `linear-gradient(to right, #2d6a4f ${progress}%, #1e4a35 ${progress}%)`;
}
}

// Actualizar ambos botones (si existen)
updateBtn(btnHeader, textHeader, daysHeader, false);
updateBtn(btnPanel, textPanel, daysPanel, true);
}

function checkFirstDayOfMonth() {
if (isAdmin) {
// Mostrar/ocultar botÃ³n de header (legacy, ahora siempre oculto en header)
const reportBtnHeader = document.getElementById('reportBtn');
const reportBtnPanel = document.getElementById('btnReportPanel');
const maintBtn = document.getElementById('maintBtn');

// Ocultar botones del header
if (reportBtnHeader) reportBtnHeader.classList.add('hidden');
if (maintBtn) maintBtn.classList.add('hidden');

// Mostrar botÃ³n en panel
if (reportBtnPanel) reportBtnPanel.classList.remove('hidden');

updateReportButtonStatus();

// Actualizar cada minuto
if (window.reportInterval) clearInterval(window.reportInterval);
window.reportInterval = setInterval(updateReportButtonStatus, 60000);
}
}

// âœ… CORRECCIÃ“N CRÃTICA: Manejo de fotos con atributo data-has-image
function handleFile(input, imgId, btnId) {
  if (modoObituario) {
    input.value = "";
    return;
  }
  const file = input.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.getElementById(imgId);
      img.src = e.target.result; // "image/jpeg;base64,..."
      img.style.display = 'block';
      document.getElementById(btnId).style.display = 'block';
      // âœ… MARCADOR DE IMAGEN VÃLIDA
      img.setAttribute('data-has-image', 'true');
    };
    reader.readAsDataURL(file);
  }
}

function clearFile(inputId, imgId, btnId) {
  if (modoObituario) return;
  document.getElementById(inputId).value = "";
  const img = document.getElementById(imgId);
  img.src = "";
  img.style.display = 'none';
  img.removeAttribute('data-has-image'); // âœ… Eliminar marca de imagen vÃ¡lida
  document.getElementById(btnId).style.display = 'none';
}

// âœ… FUNCIÃ“N PARA ELIMINAR field-error AUTOMÃTICAMENTE
function setupFieldErrorRemoval() {
  ['fecha', 'hora', 'institucion', 'direccion-exacta', 'tlf', 'mail', 'observaciones'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => el.classList.remove('field-error'));
      el.addEventListener('focus', () => el.classList.remove('field-error'));
    }
  });

  document.querySelectorAll('#region-grid .card-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('region-grid').classList.remove('field-error');
    });
  });

  const unidadGrid = document.getElementById('unidad-grid');
  const observer = new MutationObserver(() => {
    unidadGrid.querySelectorAll('.card-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('unidad-grid').classList.remove('field-error');
      });
    });
  });
  observer.observe(unidadGrid, { childList: true });

  document.querySelectorAll('#cat-grid .card-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('cat-grid').classList.remove('field-error');
    });
  });

  const cont3 = document.getElementById('cont-3');
  const observer3 = new MutationObserver(() => {
    cont3.querySelectorAll('.card-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('sec-3').classList.remove('field-error');
      });
    });

    const descOtro = document.getElementById('desc-otro');
    if (descOtro) {
      descOtro.addEventListener('input', () => document.getElementById('sec-3').classList.remove('field-error'));
      descOtro.addEventListener('focus', () => document.getElementById('sec-3').classList.remove('field-error'));
    }
  });
  observer3.observe(cont3, { childList: true, subtree: true });

  document.getElementById('btn-am').addEventListener('click', () => document.getElementById('hora-box').classList.remove('field-error'));
  document.getElementById('btn-pm').addEventListener('click', () => document.getElementById('hora-box').classList.remove('field-error'));
}

document.addEventListener('DOMContentLoaded', () => {
const regionGrid = document.getElementById('region-grid');
ORDEN_REGIONES.forEach(regionKey => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = getNombreRegionLimpio(regionKey);
btn.onclick = () => selectRegion(regionKey);
regionGrid.appendChild(btn);
});
updateTable();
setupFieldErrorRemoval();

// âœ… PRECARGA INTELIGENTE EN BACKGROUND
setTimeout(() => {
    if (!DATA_CACHE.data && !DATA_CACHE.isLoading) {
        console.log("ğŸš€ Iniciando precarga inteligente en background...");
        updateTable();
    }
}, 2000);

// âœ… INICIAR SINCRONIZACIÃ“N AUTOMÃTICA AL CARGAR
iniciarSincronizacionPanel();

// âœ… INICIALIZAR CONTROLES DE PAGINACIÃ“N
updatePaginationControls();
});

function selectRegion(regionKey) {
document.querySelectorAll('#region-grid .card-btn').forEach(b => b.classList.remove('selected'));
const index = ORDEN_REGIONES.indexOf(regionKey);
if (index !== -1) {
document.querySelector(`#region-grid .card-btn:nth-child(${index + 1})`).classList.add('selected');
}
selectedRegionKey = regionKey;
selectedUnidad = "";
const unidadGrid = document.getElementById('unidad-grid');
unidadGrid.innerHTML = "";
const unidades = UNIDADES_IPASME[regionKey] || [];
unidades.forEach(unidad => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = unidad.trim();
btn.onclick = () => selectUnidad(unidad.trim());
unidadGrid.appendChild(btn);
});
document.getElementById('unidad-section').classList.remove('hidden');
}

function selectUnidad(unidad) {
selectedUnidad = unidad.trim();
document.querySelectorAll('#unidad-grid .card-btn').forEach(b => b.classList.remove('selected'));
const clickedBtn = Array.from(document.querySelectorAll('#unidad-grid .card-btn'))
.find(b => b.innerText.trim() === selectedUnidad);
if (clickedBtn) clickedBtn.classList.add('selected');
}

// âœ… FUNCIÃ“N TOGGLE MODO OBITUARIO ACTUALIZADA
function toggleObituario() {
modoObituario = !modoObituario;
const btn = document.getElementById('btn-obituario');
const fechaInput = document.getElementById('fecha');
const horaInput = document.getElementById('hora');
const institucion = document.getElementById('institucion');
const direccionExacta = document.getElementById('direccion-exacta');
const observaciones = document.getElementById('observaciones');
const descOtro = document.getElementById('desc-otro'); // âœ… Referencia al textarea
const uploadBoxes = document.querySelectorAll('.upload-box');
const labels = document.querySelectorAll('.upload-label');

if (modoObituario) {
btn.classList.add('obit-active');
btn.innerText = "OBITUARIO";
const hoy = new Date();
const yyyy = hoy.getFullYear();
const mm = String(hoy.getMonth() + 1).padStart(2, '0');
const dd = String(hoy.getDate()).padStart(2, '0');
fechaInput.value = `${yyyy}-${mm}-${dd}`;
fechaInput.disabled = true;
horaInput.disabled = true;
institucion.disabled = true;
direccionExacta.disabled = true;
observaciones.disabled = true;
horaInput.classList.add('obit-disabled');
institucion.classList.add('obit-disabled');
direccionExacta.classList.add('obit-disabled');
observaciones.classList.add('obit-disabled');
uploadBoxes.forEach(box => box.classList.add('obit-upload-box'));
labels.forEach(label => label.classList.add('obit-upload-label'));
horaInput.value = '';
institucion.value = '';
direccionExacta.value = '';
observaciones.value = '';

// âœ… Placeholder corregido: sin "familiar"
if (descOtro) {
descOtro.placeholder = "Indique por favor nombre del fallecido, parentesco en caso de ser familiar de un trabajador del Ipasme y servicio o jurisdicciÃ³n a la que pertenece el familiar o el fallecido.";
}

Array.from(document.querySelectorAll('.preview')).forEach(img => {
img.src = '';
img.style.display = 'none';
img.removeAttribute('data-has-image'); // âœ… Limpiar marca de imagen vÃ¡lida
});

Array.from(document.querySelectorAll('.remove-btn')).forEach(btn => btn.style.display = 'none');
} else {
btn.classList.remove('obit-active');
btn.innerText = "OBITUARIO";
fechaInput.disabled = false;
horaInput.disabled = false;
institucion.disabled = false;
direccionExacta.disabled = false;
observaciones.disabled = false;
horaInput.classList.remove('obit-disabled');
institucion.classList.remove('obit-disabled');
direccionExacta.classList.remove('obit-disabled');
observaciones.classList.remove('obit-disabled');
uploadBoxes.forEach(box => box.classList.remove('obit-upload-box'));
labels.forEach(label => label.classList.remove('obit-upload-label'));

// âœ… Restaurar placeholder original
if (descOtro) {
descOtro.placeholder = "Detalle aquÃ­ su solicitud especial...";
}
}
}

// === FUNCIONES DE SEGURIDAD Y LIMPIEZA ===
function clearCredentials() {
document.getElementById('adminUser').value = '';
document.getElementById('adminPass').value = '';
}

function togglePass() {
const input = document.getElementById('adminPass');
input.type = input.type === 'password' ? 'text' : 'password';
}

function openModal(t, m, icon = "âš ï¸") {
clearCredentials();
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden'); // SIEMPRE MOSTRAR BOTÃ“N X
document.getElementById('modalIcon').innerText = icon;
document.getElementById('modalTitle').innerText = t;
document.getElementById('modalMsg').innerText = m;
const btn = document.getElementById('mainModalBtn');
btn.innerText = "ENTENDIDO";
btn.onclick = closeModal;
document.getElementById('modalAlert').style.display = 'flex';
}

// CERRAR MODAL - CORREGIDA
function closeModal() {
    const modal = document.getElementById('modalAlert');
    if (!modal) return;
    
    // Reiniciar todos los elementos del modal
    clearCredentials();
    
    // Limpiar Ã¡reas especÃ­ficas
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    if (loginArea) loginArea.classList.add('hidden');
    if (uploadArea) uploadArea.classList.add('hidden');
    
    // Restaurar botones a estado por defecto
    const mainBtn = document.getElementById('mainModalBtn');
    const closeBtn = document.getElementById('closeModalBtn');
    
    if (mainBtn) {
        mainBtn.classList.remove('hidden');
        mainBtn.innerText = "ENTENDIDO";
        mainBtn.onclick = closeModal;
        mainBtn.style.display = 'block';
    }
    
    if (closeBtn) {
        closeBtn.classList.remove('hidden');
        closeBtn.onclick = () => {
            resetChunkUploadState();
            closeModal();
        };
    }
    
    // Limpiar input de archivo
    const arteFile = document.getElementById('arteFile');
    if (arteFile) arteFile.value = '';
    
    // Limpiar ID actual
    const currentReqId = document.getElementById('currentReqId');
    if (currentReqId) currentReqId.value = '';
    
    // Ocultar modal
    modal.style.display = 'none';
    
    // Forzar reinicio de progreso si existe
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
    const progressInfo = document.getElementById('progressInfo');
    const progressSpeed = document.getElementById('progressSpeed');
    const progressETA = document.getElementById('progressETA');
    const btnPauseResume = document.getElementById('btnPauseResume');
    const btnCancelUpload = document.getElementById('btnCancelUpload');
    
    if (progressBar) progressBar.style.width = '0%';
    if (progressPercent) progressPercent.innerText = '0%';
    if (progressStatus) progressStatus.innerText = '';
    if (progressInfo) progressInfo.innerText = '';
    if (progressSpeed) progressSpeed.innerText = '';
    if (progressETA) progressETA.innerText = '';
    
    // Restaurar botÃ³n de pausa/reanudar
    if (btnPauseResume) {
        btnPauseResume.innerHTML = 'â¸ï¸ Pausar';
        btnPauseResume.style.display = 'none';
    }
    
    // Restaurar botÃ³n de cancelar
    if (btnCancelUpload) {
        btnCancelUpload.style.display = 'none';
    }
    
    // âœ… OCULTAR BARRA DE PROGRESO DEL LOGIN
    const loginProgressBar = document.getElementById('loginProgressBar');
    if (loginProgressBar) {
        loginProgressBar.style.display = 'none';
        // Restaurar estilos por defecto
        const progressBarInner = document.getElementById('loginProgressBarInner');
        const progressText = document.getElementById('loginProgressText');
        const progressStatus = document.getElementById('loginProgressStatus');
        if (progressBarInner) {
            progressBarInner.style.width = '0%';
            progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
        }
        if (progressText) {
            progressText.innerText = 'Verificando credenciales...';
            progressText.style.color = '';
        }
        if (progressStatus) {
            progressStatus.innerText = 'Conectando con el servidor...';
            progressStatus.style.color = '';
        }
    }
    
    // Reiniciar estado de chunks
    resetChunkUploadState();
}

function showLogin() {
clearCredentials();
document.getElementById('modalIcon').innerText = "ğŸ”";
document.getElementById('modalTitle').innerText = "Acceso Restringido";
document.getElementById('modalMsg').innerText = "Inicie sesiÃ³n para modo administraciÃ³n.";
document.getElementById('loginArea').classList.remove('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden');
const btn = document.getElementById('mainModalBtn');
btn.innerText = "VALIDAR CREDENCIALES";
btn.onclick = validateLogin;
document.getElementById('modalAlert').style.display = 'flex';

const userField = document.getElementById('adminUser');
const passField = document.getElementById('adminPass');
const handleEnter = (e) => {
if (e.key === 'Enter') {
validateLogin();
}
};
userField.addEventListener('keydown', handleEnter);
passField.addEventListener('keydown', handleEnter);
}

// âœ… LOGIN CORREGIDO (NO FALLA SI LA TABLA TARDA)
async function validateLogin() {
    if (isLoggingIn) return;
    isLoggingIn = true;
    
    // âœ… OCULTAR CONTRASEÃ‘A AUTOMÃTICAMENTE ANTES DE VALIDAR
    const passField = document.getElementById('adminPass');
    if (passField.type === 'text') {
        passField.type = 'password';
    }
    
    const u = document.getElementById('adminUser').value.trim();
    const p = document.getElementById('adminPass').value.trim();
    const btn = document.getElementById('mainModalBtn');
    const originalBtnText = btn.innerText;
    
    btn.disabled = true;
    btn.innerText = "Verificando...";
    
    if (!u || !p) {
        openModal("âŒ Error", "Complete ambos campos.", "ğŸ”");
        isLoggingIn = false;
        btn.disabled = false;
        btn.innerText = originalBtnText;
        return;
    }
    
    // âœ… MOSTRAR BARRA DE PROGRESO EN EL MODAL (en lugar de loadingOverlay)
    const progressBar = document.getElementById('loginProgressBar');
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');

    progressBar.style.display = 'block';
    progressBarInner.style.width = '0%';
    progressPercent.innerText = '0%';
    progressText.innerText = 'Verificando credenciales...';
    progressStatus.innerText = 'Conectando con el servidor...';

    // âœ… SIMULAR PROGRESO ANIMADO
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBarInner.style.width = progress + '%';
            progressPercent.innerText = Math.round(progress) + '%';
            
            // Cambiar texto segÃºn el progreso
            if (progress < 30) {
                progressStatus.innerText = 'Conectando con el servidor...';
            } else if (progress < 60) {
                progressStatus.innerText = 'Validando credenciales...';
            } else if (progress < 85) {
                progressStatus.innerText = 'Obteniendo permisos de acceso...';
            } else {
                progressStatus.innerText = 'Finalizando...';
            }
        }
    }, 300);
    
    try {
        const params = new URLSearchParams();
        params.append("action", "loginAdmin");
        params.append("username", u);
        params.append("password", p);
        
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        
        const text = await res.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            throw new Error("Respuesta invÃ¡lida del servidor");
        }
        
        if (data.success && data.data) {
            // âœ… LOGIN EXITOSO - Completar barra al 100%
            clearInterval(progressInterval);
            progressBarInner.style.width = '100%';
            progressPercent.innerText = '100%';
            progressText.innerText = 'Â¡Acceso concedido!';
            progressStatus.innerText = 'Redirigiendo...';
            progressStatus.style.color = 'var(--verde)';
            
            // âœ… LOGIN EXITOSO
            userCredentials = {
                username: u,
                password: p,
                displayName: data.data.displayName || u,
                role: data.data.role || "admin",
                designerName: data.data.designerName || ""
            };
            isAdmin = data.data.isAdmin || false;
            isDesigner = data.data.isDesigner || false;
            
            // Esperar un momento para mostrar el 100% antes de cerrar
            setTimeout(() => {
                // Actualizar UI
                document.getElementById('userNameDisplay').innerText = userCredentials.displayName + (isDesigner ? " (DiseÃ±ador)" : "");
                document.getElementById('welcomeMessage').classList.add('show');
                document.getElementById('authBtn').className = "btn-logout";
                document.getElementById('authBtn').innerText = "Cerrar SesiÃ³n";
                document.getElementById('authBtn').onclick = logout;
                
                clearCredentials();
                
                // Ocultar barra de progreso y cerrar modal
                progressBar.style.display = 'none';
                closeModal();
                
                // Cargar datos en segundo plano
                DATA_CACHE.data = null;
                updateTable(true).catch(err => {
                    console.warn("Login exitoso, pero fallo carga de datos:", err);
                });
            }, 800);
            
        } else {
            throw new Error("Credenciales incorrectas");
        }
    } catch (err) {
        console.error("Error login:", err);
        
        // âœ… DETENER ANIMACIÃ“N Y MOSTRAR ERROR EN LA BARRA
        clearInterval(progressInterval);
        progressBarInner.style.width = '100%';
        progressBarInner.style.background = 'linear-gradient(90deg, #e63946 0%, #c62828 100%)';
        progressText.innerText = 'Error de autenticaciÃ³n';
        progressText.style.color = 'var(--rojo)';
        progressPercent.innerText = 'âœ•';
        progressStatus.innerText = err.message || "Error de conexiÃ³n";
        progressStatus.style.color = 'var(--rojo)';
        
        clearCredentials();
        
        // Mantener visible el error por un momento, luego ocultar
        setTimeout(() => {
            progressBar.style.display = 'none';
            // Restaurar estilos para prÃ³xima vez
            progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
            progressText.style.color = '';
            progressStatus.style.color = '';
            
            openModal("âŒ Error", err.message || "Error de conexiÃ³n al validar.", "ğŸ’¥");
        }, 1500);
    } finally {
        isLoggingIn = false;
        btn.disabled = false;
        btn.innerText = originalBtnText;
    }
}

// FUNCIÃ“N DE LOGOUT MODIFICADA
function logout() {
    // 1. Limpiar estado de autenticaciÃ³n PRIMERO
    isAdmin = false;
    isDesigner = false;
    userCredentials = { username: "", password: "", displayName: "", role: "", designerName: "" };
    
    // 2. Cerrar panel si estÃ¡ abierto
    if (isPanelOpen) closeSidePanel();
    
    // 3. Limpiar selecciÃ³n visual
    selectedRequestId = null;
    selectedRequestData = null;
    document.querySelectorAll('.row-selected-panel').forEach(row => {
        row.classList.remove('row-selected-panel');
    });
    
    // 4. Actualizar UI de contadores (cambiar a vista de usuario normal)
    document.getElementById('stats-panel').style.display = 'flex';
    document.getElementById('combined-stats').style.display = 'none';
    document.getElementById('count-bermina-admin').innerText = '0';
    document.getElementById('count-jorsy-admin').innerText = '0';
    document.getElementById('count-maria-admin').innerText = '0';
    document.getElementById('count-xamir-admin').innerText = '0';
    
    // 5. Limpiar bÃºsqueda
    currentSearchId = "";
    isSearchActive = false;
    resetSearchHighlight();
    const searchInput = document.getElementById('searchIdInput');
    if (searchInput) searchInput.value = "";
    document.getElementById('idNotFoundModal').style.display = 'none';
    
    // 6. Actualizar UI de header
    document.getElementById('userNameDisplay').innerText = "";
    document.getElementById('welcomeMessage').classList.remove('show');
    document.getElementById('authBtn').className = "btn-login";
    document.getElementById('authBtn').innerText = "ğŸ” Administrador";
    document.getElementById('authBtn').onclick = showLogin;
    
    clearCredentials();
    
    // 7. IMPORTANTE: NO borrar DATA_CACHE, solo re-renderizar con datos existentes
    // Esto evita la recarga lenta
    renderLocalTable();
}

// === FUNCIONES ADMIN ===
// ABRIR MODAL DE ARTE - CORREGIDA
function openArteModal(id) {
    // Reiniciar estado antes de abrir
    resetChunkUploadState();
    
    const currentReqId = document.getElementById('currentReqId');
    const arteFile = document.getElementById('arteFile');
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    const closeBtn = document.getElementById('closeModalBtn');
    const mainBtn = document.getElementById('mainModalBtn');
    
    // Validar elementos existen
    if (!currentReqId || !arteFile || !modalIcon || !modalTitle || !modalMsg) {
        console.error("âŒ Elementos del modal no encontrados");
        return;
    }
    
    // Limpiar y configurar
    currentReqId.value = id;
    arteFile.value = '';
    
    modalIcon.innerText = "ğŸ¨";
    modalTitle.innerText = "Adjuntar Arte Final";
    modalMsg.innerText = "Seleccione el archivo para la solicitud " + id;
    
    loginArea.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    
    closeBtn.classList.remove('hidden');
    
    // Configurar botÃ³n principal
    mainBtn.classList.remove('hidden');
    mainBtn.innerText = "SUBIR A DRIVE";
    mainBtn.onclick = uploadArte;
    mainBtn.style.display = 'block';
    
    // Mostrar modal
    document.getElementById('modalAlert').style.display = 'flex';
    
    // Forzar foco en el input de archivo
    setTimeout(() => {
        arteFile.focus();
    }, 100);
}

// âŒ FUNCIÃ“N DE REANUDACIÃ“N ELIMINADA - SIEMPRE INICIAR DESDE CERO

// SUBIR ARTE CON SISTEMA DE CHUNKS (SIN REANUDACIÃ“N)
async function uploadArte() {
    // âœ… REINICIAR ESTADO SIEMPRE (SIN VERIFICAR REANUDACIÃ“N)
    resetChunkUploadState();
    
    const fileInput = document.getElementById('arteFile');
    const id = document.getElementById('currentReqId')?.value;
    
    if (!fileInput || !id) {
        openModal("âŒ Error", "Datos del formulario incompletos.", "âš ï¸");
        return;
    }
    
    if (fileInput.files.length === 0) {
        openModal("ğŸ“ Advertencia", "Por favor seleccione un archivo.", "ğŸ“");
        return;
    }
    
    const file = fileInput.files[0];
    const fileSizeMB = file.size / (1024 * 1024);
    
    // Validar tamaÃ±o mÃ¡ximo
    if (file.size > 6 * 1024 * 1024) {
        openModal("ğŸ“ TamaÃ±o Excedido", "El archivo excede los 6MB permitidos.", "âš ï¸");
        return;
    }
    
    // âœ… MOSTRAR MODAL DE PROGRESO
    showUploadProgressModal(id, file.name, fileSizeMB);
    
    try {
        // Detectar velocidad de conexiÃ³n
        document.getElementById('progressStatus').innerText = 'ğŸ“¡ Detectando velocidad de conexiÃ³n...';
        await detectConnectionSpeed();
        
        // âœ… NUEVA LÃ“GICA: SIN REANUDACIÃ“N, SIEMPRE DESDE CERO
        if (file.size <= 1024 * 1024) {
            // Archivos â‰¤1MB: siempre subir completo (sin chunks)
            document.getElementById('progressStatus').innerText = 'ğŸš€ Subiendo archivo completo...';
            await uploadFileNormal(file, id);
            return;
        }
        
        if (chunkUpload.connectionSpeed === 'fast' || chunkUpload.connectionSpeed === 'ultra-fast') {
            // ConexiÃ³n rÃ¡pida: subir completo incluso si >1MB
            document.getElementById('progressStatus').innerText = 'ğŸš€ Subiendo archivo completo (conexiÃ³n rÃ¡pida)...';
            await uploadFileNormal(file, id);
            return;
        }
        
        // âœ… ARCHIVOS GRANDES CON CONEXIÃ“N LENTA: CHUNKS SIN REANUDACIÃ“N
        document.getElementById('progressStatus').innerText = `ğŸ“¦ Fragmentando en chunks...`;
        
        // Dividir en chunks
        const chunks = splitFileIntoChunks(file);
        chunkUpload.chunks = chunks;
        chunkUpload.totalChunks = chunks.length;
        chunkUpload.currentChunk = 0;
        chunkUpload.uploadedChunks = 0; // âœ… SIEMPRE DESDE 0
        chunkUpload.startTime = Date.now();
        chunkUpload.isActive = true;
        
        document.getElementById('progressInfo').innerText =
            `Archivo: ${file.name} (${fileSizeMB.toFixed(2)}MB) - SUBIDA COMPLETA`;
        document.getElementById('progressSpeed').innerText =
            `ConexiÃ³n: ${chunkUpload.connectionSpeed} | Chunk: ${(chunkUpload.chunkSize / 1024).toFixed(0)}KB`;
        
        // Subir chunks secuencialmente
        await uploadChunksSequential(id, file.name, file.type);
        
    } catch (error) {
        console.error('Error en uploadArte:', error);
        document.getElementById('loadingOverlay').style.display = 'none';
        
        // âœ… EN CASO DE ERROR, CANCELAR Y LIMPIAR TODO
        await cancelUpload();
        
        openModal("âŒ Error", "Error al subir: " + error.message + "\n\nTodos los recursos temporales han sido eliminados.", "ğŸ’¥");
    }
}

// SUBIR ARCHIVO NORMAL (menor a 2MB)
async function uploadFileNormal(file, id) {
    const reader = new FileReader();
    
    return new Promise((resolve, reject) => {
        reader.onload = async function(e) {
            const base64 = e.target.result.split(',')[1];
            
            try {
                const params = new URLSearchParams();
                params.append("action", "uploadArte");
                params.append("id", id);
                params.append("filename", file.name);
                params.append("file", base64);
                params.append("mime", file.type);
                params.append("uploadedBy", userCredentials.displayName);
                params.append("isChunked", "false");
                
                const res = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: params 
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressPercent').innerText = '100%';
                    setTimeout(() => {
                        closeModal();
                        openModal("âœ… Ã‰xito", "Â¡Arte subido con Ã©xito!", "ğŸ¨");
                        updateTable();
                    }, 500);
                    resolve();
                } else {
                    reject(new Error(data.error));
                }
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo archivo"));
        reader.readAsDataURL(file);
    });
}

async function sendTelegramArte(id) {
const req = localData.find(x => x.id == id);

if(!confirm("Â¿Enviar el arte de " + id + " a Telegram?")) return;

document.getElementById('loadMainTxt').innerText = "Enviando a Telegram...";
document.getElementById('loadingOverlay').style.display = 'flex';

try {
const params = new URLSearchParams();
params.append("action", "sendTelegramArte");
params.append("id", id);

const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
const data = await res.json();

if(data.success) {
openModal("âœˆï¸ Telegram", "Â¡Enviado a Telegram en alta calidad!", "ğŸ“²");
setTimeout(() => closeModal(), 2000);
} else {
openModal("âŒ Error", "Error: " + data.error, "ğŸ’¥");
}
} catch (e) {
openModal("âŒ Error", "Error de conexiÃ³n.", "ğŸ’¥");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}

async function toggleMaintMode() {
if (!isAdmin) return;

const nuevoEstado = !isMaintActive;
document.getElementById('loadingOverlay').style.display = 'flex';

try {
await fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=setMaintenance&status=${nuevoEstado}`
});

isMaintActive = nuevoEstado;
openModal(
"âš™ï¸ Modo Mantenimiento",
"Modo mantenimiento " + (nuevoEstado ? "ACTIVADO" : "DESACTIVADO") + ".",
"ğŸ› ï¸"
);
setTimeout(() => location.reload(), 1500);
} catch (e) {
openModal("âŒ Error", "Error al cambiar estado del mantenimiento.", "ğŸ’¥");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}

// === ELIMINACIÃ“N CON MODALES PERSONALIZADOS ===
let currentDeleteId = null;

function deleteReq(id) {
if (!isAdmin) {
openModal("âŒ Acceso Denegado", "Solo los administradores pueden eliminar solicitudes.", "ğŸ”");
return;
}

currentDeleteId = id;
showDeleteConfirm(1);
}

function showDeleteConfirm(step) {
const id = currentDeleteId;
if (step === 1) {
openCustomModal(
"ğŸ—‘ï¸ Confirmar EliminaciÃ³n",
`Â¿EstÃ¡ seguro de eliminar la solicitud <b>${id}</b>?`,
() => showDeleteConfirm(2),
() => closeModal()
);
} else if (step === 2) {
openCustomModal(
"âš ï¸ Â¡Advertencia Final!",
`Â¡Esta acciÃ³n es <b>irreversible</b>!<br>Â¿Eliminar permanentemente la solicitud <b>${id}</b> de la base de datos?`,
() => executeDelete(),
() => closeModal()
);
}
}

function openCustomModal(title, message, onConfirm, onCancel) {
document.getElementById('modalIcon').innerText = "â“";
document.getElementById('modalTitle').innerText = title;
document.getElementById('modalMsg').innerHTML = message;
const mainBtn = document.getElementById('mainModalBtn');
const altBtn = document.getElementById('closeModalBtn');

mainBtn.innerText = "SÃ, ACEPTAR";
mainBtn.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
altBtn.classList.remove('hidden'); // Asegurar que sea visible
altBtn.innerText = "CANCELAR";
altBtn.onclick = () => { closeModal(); if (onCancel) onCancel(); };

document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('modalAlert').style.display = 'flex';
}

async function executeDelete() {
    const id = currentDeleteId;
    
    // Mostrar mensaje de carga
    document.getElementById('loadMainTxt').innerText = "Eliminando solicitud...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const params = new URLSearchParams();
        params.append("action", "delete");
        params.append("id", id);
        // ENVIAR CREDENCIALES DE ADMINISTRADOR (FALTABA ESTO)
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        // ESPERAR RESPUESTA DEL SERVIDOR ANTES DE MOSTRAR Ã‰XITO
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: params 
        });
        
        const data = await response.json();
        
        if (data.success) {
            // SOLO ELIMINAR DE localData SI EL SERVIDOR CONFIRMA
            localData = localData.filter(x => x.id != id);
            
            // Si la eliminada es la seleccionada, cerrar panel
            if (selectedRequestId === id) {
                closeSidePanel();
                selectedRequestId = null;
                selectedRequestData = null;
            }
            
            renderLocalTable();
            
            openModal("âœ… Ã‰xito", "Solicitud y arte eliminados correctamente.", "ğŸ—‘ï¸");
        } else {
            throw new Error(data.error || "Error al eliminar la solicitud");
        }
    } catch (e) {
        openModal("âŒ Error", "Error al eliminar: " + e.message, "ğŸ’¥");
        updateTable(); // Recargar para restaurar la fila
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

// === FIN ELIMINACIÃ“N ===

// === FIN FUNCIONES ADMIN ===

// === FUNCIONES GENERALES ===
function setAMPM(val) {
if (modoObituario) return;
selectedAMPM = val;
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
document.getElementById(val === 'a. m.' ? 'btn-am' : 'btn-pm').classList.add('active');
document.getElementById('hora-box').classList.remove('field-error');
}

// MODIFICACIÃ“N EN selectCat: reiniciar modoObituario si cambia de categorÃ­a Y AGREGAR SOPORTE PARA PEDIÃTRICA
function selectCat(btn, tipo) {
if (modoObituario && tipo !== 'otros') {
modoObituario = false;
const obitBtn = document.getElementById('btn-obituario');
if (obitBtn) {
obitBtn.classList.remove('obit-active');
obitBtn.innerText = "OBITUARIO";
document.getElementById('fecha').disabled = false;
document.getElementById('hora').disabled = false;
document.getElementById('institucion').disabled = false;
document.getElementById('direccion-exacta').disabled = false;
document.getElementById('observaciones').disabled = false;
document.getElementById('hora').classList.remove('obit-disabled');
document.getElementById('institucion').classList.remove('obit-disabled');
document.getElementById('direccion-exacta').classList.remove('obit-disabled');
document.getElementById('observaciones').classList.remove('obit-disabled');
document.querySelectorAll('.upload-box').forEach(box => box.classList.remove('obit-upload-box'));
document.querySelectorAll('.upload-label').forEach(label => label.classList.remove('obit-upload-label'));

// Limpiar marcas de imÃ¡genes
Array.from(document.querySelectorAll('.preview')).forEach(img => {
img.removeAttribute('data-has-image');
});
}
}

document.querySelectorAll('#cat-grid .card-btn').forEach(b => b.classList.remove('selected'));
btn.classList.add('selected');
catName = btn.innerText;
catType = tipo;
document.getElementById('cat-grid').classList.remove('field-error');

const s3 = document.getElementById('sec-3');
const s4 = document.getElementById('sec-4');
const c3 = document.getElementById('cont-3');
const c4 = document.getElementById('cont-4');

s3.classList.remove('hidden');
s4.classList.add('hidden');
c3.innerHTML = "";
c4.innerHTML = "";

if (['escuela', 'integral', 'conjunta'].includes(tipo)) {
document.getElementById('label-3').innerText = "ğŸ©º 3. ESPECIALIDADES MÃ‰DICAS *";
renderList(c3, DATA.especialidades);
s4.classList.remove('hidden');
renderList(c4, DATA.servicios);
} else if (tipo === 'vacuna') {
document.getElementById('label-3').innerText = "ğŸ’‰ 3. LISTA DE VACUNAS *";
renderList(c3, DATA.vacunas);
} else if (tipo === 'quirurgica') {
document.getElementById('label-3').innerText = "ğŸ”ª 3. PATOLOGÃAS QUIRÃšRGICAS *";
renderList(c3, DATA.quirurgica);
} else if (tipo === 'pediatrica') {
document.getElementById('label-3').innerText = "ğŸ‘¶ 3. PATOLOGÃAS PEDIÃTRICAS *";
renderList(c3, DATA.pediatrica);
} else if (tipo === 'oftalmo') {
document.getElementById('label-3').innerText = "ğŸ‘ï¸ 3. PATOLOGÃAS OFTALMOLÃ“GICAS *";
renderList(c3, DATA.oftalmo);
} else {
document.getElementById('label-3').innerText = "âœ¨ 3. DESCRIPCIÃ“N DEL REQUERIMIENTO *";
c3.innerHTML = '<textarea id="desc-otro" class="modern-input" rows="3" style="grid-column: 1 / -1;" placeholder="Detalle aquÃ­ su solicitud especial..."></textarea>';
c3.innerHTML += `
<div style="display: flex; align-items: center; gap: 12px; margin-top: 12px; flex-wrap: wrap; grid-column: 1 / -1;">
<button type="button" id="btn-obituario" class="btn-time" style="background: #f8f9fa; border-color: var(--gris); color: var(--azul-deep); width: 120px; padding: 8px;"
onclick="toggleObituario()">
OBITUARIO
</button>
<div style="flex: 1; min-width: 200px; background: #fff8e1; border: 1px solid #ffe082; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; color: #5d4600; font-weight: 600; line-height: 1.3;">
âš ï¸ Activar este modo elimina el requerimiento de 48 horas.
Ãšselo con moderaciÃ³n.
</div>
</div>`;
}
}

function renderList(cont, list) {
list.forEach(i => {
const d = document.createElement('div');
d.className = 'card-btn';
d.innerText = i;
d.onclick = () => {
d.classList.toggle('selected');
document.getElementById('sec-3').classList.remove('field-error');
};
cont.appendChild(d);
});
}

function showPage(id, btn) {
document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
document.getElementById(id).classList.add('active');
window.scrollTo({top: 0, behavior: 'smooth'});
if(btn) btn.classList.add('active');
else document.getElementById('tab-' + id.split('-')[0]).classList.add('active');
if(id === 'list-page') updateTable();
}

// âœ… ACTUALIZAR TABLA CON INVALIDACIÃ“N DE CACHÃ‰ (FASE 2)
async function updateTable(forceRefresh = false) {
  const now = Date.now();
  
  // âœ… CORRECCIÃ“N: Guardar y comparar serverTimestamp correctamente
  const serverCacheTimestamp = parseInt(DATA_CACHE.serverTimestamp || "0");
  if (serverCacheTimestamp > DATA_CACHE.timestamp) {
    forceRefresh = true;
    console.log("ğŸ”„ CachÃ© del servidor actualizada, refrescando datos...");
  }
  
  // Si tenemos cache local y no forzamos, usamos cache
  if (!forceRefresh && DATA_CACHE.data && (now - DATA_CACHE.timestamp) < DATA_CACHE.ttl) {
    localData = DATA_CACHE.data;
    if(DATA_CACHE.stats) updateCounters(DATA_CACHE.stats);
    renderLocalTableOptimized();
    return;
  }
  
  if (DATA_CACHE.isLoading) {
    await DATA_CACHE.pendingPromise;
    return;
  }
  
  DATA_CACHE.isLoading = true;
  DATA_CACHE.pendingPromise = fetchTableData();
  
  try {
    const result = await DATA_CACHE.pendingPromise;
    DATA_CACHE.data = result.rows;
    DATA_CACHE.stats = result.stats;
    DATA_CACHE.serverTimestamp = result.cacheTimestamp || now; // âœ… GUARDAR CORRECTAMENTE
    DATA_CACHE.timestamp = now;
    localData = result.rows;
    buildDataIndexes();
    
    if (result.stats) {
      updateCounters(result.stats);
    }
    renderLocalTableOptimized();
  } catch (e) {
    console.error("Error cargando tabla:", e);
  } finally {
    DATA_CACHE.isLoading = false;
    DATA_CACHE.pendingPromise = null;
  }
}

// âœ… FUNCIÃ“N DE CARGA DE DATOS (RECIBE ESTADÃSTICAS DEL SERVIDOR)
async function fetchTableData() {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 15000);
  
  try {
    const res = await fetch(`${SCRIPT_URL}?action=read`, { signal: controller.signal });
    clearTimeout(timeoutId);
    
    const response = await res.json();
    isMaintActive = (response.maintenance === "true" || response.maintenance === true);
    
    if (isMaintActive && !isAdmin && !isDesigner) {
      document.getElementById('maintOverlay').style.display = 'flex';
    } else {
      document.getElementById('maintOverlay').style.display = 'none';
    }
    
    if (response.success && response.data) {
      return {
        rows: response.data.rows || response.data,
        stats: response.data.stats || null,
        cacheTimestamp: parseInt(response.data.cacheTimestamp || "0") // âœ… PARSEAR COMO ENTERO
      };
    }
    return { rows: [], stats: null, cacheTimestamp: 0 };
  } catch (e) {
    clearTimeout(timeoutId);
    throw e;
  }
}

function buildDataIndexes() {
    DATA_INDEX.byId.clear();
    DATA_INDEX.byStatus.clear();
    DATA_INDEX.byDesigner.clear();
    
    localData.forEach((item, idx) => {
        DATA_INDEX.byId.set(item.id, { item, index: idx });
        
        const status = (item.Estatus || "").toUpperCase().trim();
        if (!DATA_INDEX.byStatus.has(status)) {
            DATA_INDEX.byStatus.set(status, []);
        }
        DATA_INDEX.byStatus.get(status).push(item);
        
        if (item.Disenador) {
            if (!DATA_INDEX.byDesigner.has(item.Disenador)) {
                DATA_INDEX.byDesigner.set(item.Disenador, []);
            }
            DATA_INDEX.byDesigner.get(item.Disenador).push(item);
        }
    });
    
    console.log(` Ãndices construidos: ${DATA_INDEX.byId.size} registros`);
}

// VALIDACIÃ“N EN ORDEN CORRECTO
function validateForm() {
const fieldsInOrder = [];

fieldsInOrder.push({
id: 'region-grid',
isValid: () => !!selectedRegionKey,
label: 'RegiÃ³n'
});

fieldsInOrder.push({
id: 'unidad-grid',
isValid: () => !!selectedUnidad,
label: 'Unidad MÃ©dica'
});

fieldsInOrder.push({
id: 'cat-grid',
isValid: () => !!catName,
label: 'Tipo de Jornada'
});

fieldsInOrder.push({
id: 'sec-3',
isValid: () => {
if (catType === 'otros') {
return document.getElementById('desc-otro')?.value.trim() !== '';
} else {
return document.querySelectorAll('#cont-3 .card-btn.selected').length > 0;
}
},
label: 'Detalle'
});

fieldsInOrder.push({
id: 'fecha',
isValid: () => {
const val = document.getElementById('fecha').value;
return !!val;
},
label: 'Fecha de Actividad'
});

if (!modoObituario) {
fieldsInOrder.push({
id: 'hora',
isValid: () => {
const val = document.getElementById('hora').value.trim();
return !!val;
},
label: 'Hora de Inicio'
});

fieldsInOrder.push({
id: 'hora-box',
isValid: () => !!selectedAMPM,
label: 'Formato AM/PM'
});

fieldsInOrder.push({
id: 'institucion',
isValid: () => {
const val = document.getElementById('institucion').value.trim();
return !!val;
},
label: 'InstituciÃ³n'
});
}

fieldsInOrder.push({
id: 'mail',
isValid: () => {
const val = document.getElementById('mail').value.trim();
return val && val.includes('@');
},
label: 'Correo ElectrÃ³nico'
});

for (const field of fieldsInOrder) {
const el = document.getElementById(field.id);
if (!field.isValid()) {
el?.classList.add('field-error');
el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
openModal("âŒ Campo Faltante", `Falta completar: ${field.label}`, "âš ï¸");
return false;
}
}

if (!modoObituario) {
const fechaInput = document.getElementById('fecha').value;
const fechaSeleccionada = new Date(fechaInput + 'T00:00:00');
const ahora = new Date();

// VALIDACIÃ“N INTERNA: 24 HORAS (texto mantiene 48 para usuario)
if ((fechaSeleccionada - ahora) / (1000 * 60 * 60) < 24) {
document.getElementById('fecha').classList.add('field-error');
openModal("â³ RestricciÃ³n de Tiempo", "Las solicitudes deben realizarse con al menos 48 horas de anticipaciÃ³n.", "â°");
return false;
}
}

return true;
}

function showConfirmationModal() {
if (!validateForm()) return;

const preview = document.getElementById('previewContent');
let html = `
<p><b>ğŸ“ RegiÃ³n:</b> ${getNombreRegionLimpio(selectedRegionKey)}</p>
<p><b>ğŸ¥ Unidad MÃ©dica:</b> ${selectedUnidad}</p>
`;

if (modoObituario) {
html += `<p><b>ğŸ“‹ Tipo de Solicitud:</b> Obituario</p>`;
} else {
html += `<p><b>ğŸ“‚ Tipo de Jornada:</b> ${catName}</p>`;
}

if (catType === 'otros' && !modoObituario) {
html += `<p><b>âœ¨ DescripciÃ³n:</b> ${document.getElementById('desc-otro').value.trim()}</p>`;
} else if (!modoObituario) {
const selectedOps = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el => el.innerText).join(', ');
html += `<p><b>ğŸ©º Detalle:</b> ${selectedOps || 'Ninguno'}</p>`;
}

const servicios = Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el => el.innerText).join(', ');
if (servicios) html += `<p><b>âœ¨ Servicios Adicionales:</b> ${servicios}</p>`;

const [year, month, day] = document.getElementById('fecha').value.split('-');
const fechaFormateada = `${day}/${month}/${year}`;
html += `<p><b>ğŸ“… Fecha de Actividad:</b> ${fechaFormateada}</p>`;

if (!modoObituario) {
html += `<p><b>â° Hora de Inicio:</b> ${document.getElementById('hora').value} ${selectedAMPM}</p>`;
const institucion = document.getElementById('institucion').value.trim();
const direccion = document.getElementById('direccion-exacta').value.trim();
html += `<p><b>ğŸ§­ UbicaciÃ³n:</b> ${[institucion, direccion].filter(x => x).join(', ')}</p>`;
html += `<p><b>ğŸ“± TelÃ©fono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>`;
html += `<p><b>âœ‰ï¸ Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>`;

const obs = document.getElementById('observaciones').value.trim();
if (obs) html += `<p><b>âœï¸ Observaciones:</b> ${obs}</p>`;

// CORREGIDO: Contar fotos usando el atributo data-has-image
const fotos = [1,2,3].filter(i => {
const img = document.getElementById(`p${i}`);
return img.getAttribute('data-has-image') === 'true';
});
html += `<p><b>ğŸ“¸ Soportes FotogrÃ¡ficos:</b> ${fotos.length > 0 ? `${fotos.length} foto(s) adjunta(s)` : 'Ninguno'}</p>`;
} else {
html += `<p><b>ğŸ“± TelÃ©fono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>`;
html += `<p><b>âœ‰ï¸ Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>`;
html += `<p><b>â„¹ï¸ Modo Obituario activado â€“ Campos opcionales omitidos.</b></p>`;
}

preview.innerHTML = html;
document.getElementById('confirmModal').style.display = 'flex';

let timeLeft = 10;
document.getElementById('countdown').innerText = timeLeft;
const btnEnviar = document.getElementById('btnEnviarConfirmado');
btnEnviar.disabled = true;
btnEnviar.classList.remove('enviar');
btnEnviar.classList.add('corregir');

const btnCorregir = document.getElementById('btnCorregir');
btnCorregir.onmouseenter = () => {
btnCorregir.style.background = "#d1d5db";
btnCorregir.style.color = "#212529";
};
btnCorregir.onmouseleave = () => {
btnCorregir.style.background = "var(--gris)";
btnCorregir.style.color = "var(--azul-deep)";
};

const timer = setInterval(() => {
timeLeft--;
document.getElementById('countdown').innerText = timeLeft;
const progress = ((10 - timeLeft) / 10) * 100;
btnEnviar.style.background = `linear-gradient(to right, var(--turquesa) ${progress}%, #e9ecef ${progress}%)`;
btnEnviar.style.color = timeLeft <= 3 ? "white" : "#495057";

if (timeLeft <= 0) {
clearInterval(timer);
btnEnviar.disabled = false;
btnEnviar.classList.remove('corregir');
btnEnviar.classList.add('enviar');
btnEnviar.style.background = "var(--turquesa)";
btnEnviar.style.color = "white";
btnEnviar.style.cursor = "pointer";

// âœ¨ APLICAR TEXTO EN DOS LÃNEAS
btnEnviar.innerHTML = `<div class="btn-text"><span>Haz clic para enviar</span><span>la solicitud</span></div>`;

// âœ¨ APLICAR ANIMACIÃ“N DE PULSOS
btnEnviar.classList.add('btn-send-pulse');

// âœ¨ REPRODUCIR SONIDO
const sound = document.getElementById('notificationSound');
if (sound) {
sound.currentTime = 0;
sound.play().catch(e => console.log("Sonido no reproducido:", e));
}

// âœ¨ EFECTOS HOVER MÃS SUAVES
btnEnviar.onmouseenter = () => {
btnEnviar.style.transform = "scale(1.03)";
btnEnviar.style.boxShadow = "0 6px 20px rgba(2, 48, 71, 0.4)";
};
btnEnviar.onmouseleave = () => {
btnEnviar.style.transform = "scale(1)";
btnEnviar.style.boxShadow = "0 4px 15px rgba(0, 150, 255, 0.3)";
};
}
}, 1000);

window.confirmTimer = timer;
}

document.getElementById('btnCorregir').onclick = () => {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
};

function proceedToSend() {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
realSubmitForm();
}

document.getElementById('btnEnviarConfirmado').onclick = proceedToSend;

// === ENVÃO REAL ===
document.getElementById('sigrafForm').onsubmit = function(e) {
e.preventDefault();
showConfirmationModal();
};

function realSubmitForm() {
const params = new URLSearchParams();

const EXCEPCIONES_SIN_UMI = [
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende",
"Club Villas Ipasmar",
"Hotel Valle Grande"
];

// CORRECCIÃ“N: se elimina la capitalizaciÃ³n automÃ¡tica
let unidadFinal = selectedUnidad.trim();
if (!EXCEPCIONES_SIN_UMI.includes(unidadFinal)) {
unidadFinal = "U.M.I. " + unidadFinal;
}

params.append("Unidad", unidadFinal);

// AquÃ­ se envÃ­a "Obituario" si estÃ¡ activo
params.append("Jornada", modoObituario ? "Obituario" : catName);

let ops = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el=>el.innerText).join(", ");
if(catType === 'otros') ops = document.getElementById('desc-otro').value;
params.append("Opciones", ops);

params.append("Servicios", Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el=>el.innerText).join(", "));

if (!modoObituario) {
const institucion = document.getElementById('institucion').value.trim();
const direccionExacta = document.getElementById('direccion-exacta').value.trim();
const direccionCompleta = [institucion, direccionExacta].filter(part => part).join(", ");
params.append("Direccion", direccionCompleta);
params.append("Hora", document.getElementById('hora').value + " " + selectedAMPM);
params.append("Observaciones", document.getElementById('observaciones').value);

// CORREGIDO: Adjuntar fotos usando el atributo data-has-image
for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
if(img.getAttribute('data-has-image') === 'true') {
const base64Data = img.src.split(',')[1];
if (base64Data) {
params.append("foto"+i, base64Data);
}
}
}
} else {
params.append("Direccion", "");
params.append("Hora", "");
params.append("Observaciones", "");
}

params.append("Fecha", document.getElementById('fecha').value);
params.append("Telefono", document.getElementById('tlf').value);
params.append("Correo", document.getElementById('mail').value);

document.getElementById('loadMainTxt').innerText = "Enviando Solicitud...";
document.getElementById('loadingOverlay').style.display = 'flex';

fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: params.toString()
})
.then(response => response.json())
.then(result => {
if (result.success) {
document.getElementById('sigrafForm').reset();

for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
img.src = '';
img.style.display = 'none';
img.removeAttribute('data-has-image'); // Limpiar marca
document.getElementById('b'+i).style.display = 'none';
}

document.querySelectorAll('.card-btn').forEach(btn => btn.classList.remove('selected'));
document.getElementById('sec-3').classList.add('hidden');
document.getElementById('sec-4').classList.add('hidden');
selectedAMPM = "";
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
selectedRegionKey = "";
selectedUnidad = "";
modoObituario = false;

document.getElementById('fecha').disabled = false;
document.getElementById('hora').disabled = false;
document.getElementById('institucion').disabled = false;
document.getElementById('direccion-exacta').disabled = false;
document.getElementById('observaciones').disabled = false;
document.getElementById('hora').classList.remove('obit-disabled');
document.getElementById('institucion').classList.remove('obit-disabled');
document.getElementById('direccion-exacta').classList.remove('obit-disabled');
document.getElementById('observaciones').classList.remove('obit-disabled');
document.querySelectorAll('.upload-box').forEach(box => box.classList.remove('obit-upload-box'));
document.querySelectorAll('.upload-label').forEach(label => label.classList.remove('obit-upload-label'));

document.querySelectorAll('#region-grid .card-btn').forEach(b => b.classList.remove('selected'));
document.getElementById('unidad-grid').innerHTML = "";
document.getElementById('unidad-section').classList.add('hidden');

openModal("âœ… Â¡Ã‰xito!", "Su solicitud ha sido enviada correctamente.", "ğŸš€");
setTimeout(() => {
closeModal();
showPage('list-page', document.getElementById('tab-list'));
}, 2000);
} else {
throw new Error(result.error);
}
})
.catch(e => {
openModal("âœ… Solicitud Procesada", "El sistema ha registrado su envÃ­o.", "ğŸ“‹");
setTimeout(() => {
closeModal();
showPage('list-page', document.getElementById('tab-list'));
}, 2000);
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}
// === FUNCIONES PARA SISTEMA DE CHUNKS ===

// SUBIR CHUNKS SECUENCIALMENTE CON REINTENTOS
async function uploadChunksSequential(id, filename, mimeType) {
    const totalChunks = chunkUpload.totalChunks;
    const startFromChunk = chunkUpload.uploadedChunks; // Empezar desde el Ãºltimo chunk subido
    
    for (let i = startFromChunk; i < totalChunks; i++) {
        chunkUpload.currentChunkIndex = i; // Actualizar Ã­ndice actual para UI
        
        if (chunkUpload.pauseRequested) {
            await waitForResume();
            if (!chunkUpload.isActive) return;
        }
        
        let chunkSuccess = false;
        let retryCount = 0;
        
        while (!chunkSuccess && retryCount < chunkUpload.maxRetries) {
            try {
                // âœ… REGISTRAR TIEMPO DE INICIO DEL CHUNK
                chunkUpload.currentChunkStartTime = Date.now();
                
                // Cuando se reanuda, el array chunks solo contiene los pendientes
                // El Ã­ndice real del chunk es i, pero en el array es i - startFromChunk
                const chunkArrayIndex = i - startFromChunk;
                await uploadSingleChunk(id, filename, mimeType, chunkArrayIndex, i);
                
                // âœ… REGISTRAR TIEMPO DE FIN Y CALCULAR VELOCIDAD
                chunkUpload.currentChunkEndTime = Date.now();
                const chunkDuration = (chunkUpload.currentChunkEndTime - chunkUpload.currentChunkStartTime) / 1000; // segundos
                const chunkSizeKB = chunkUpload.chunks[chunkArrayIndex].size / 1024; // KB
                const currentSpeed = chunkSizeKB / chunkDuration; // KB/s
                
                // Guardar velocidad actual
                chunkUpload.currentUploadSpeed = currentSpeed;
                chunkUpload.uploadSpeeds.push(currentSpeed);
                
                // Calcular promedio
                const totalSpeed = chunkUpload.uploadSpeeds.reduce((sum, speed) => sum + speed, 0);
                chunkUpload.avgUploadSpeed = totalSpeed / chunkUpload.uploadSpeeds.length;
                
                // âœ… ACTUALIZAR VELOCIDAD EN EL MODAL
                updateUploadSpeedDisplay();
                
                chunkSuccess = true;
                chunkUpload.uploadedChunks++;
                
                // Actualizar progreso
                const progress = Math.min(100, (chunkUpload.uploadedChunks / totalChunks) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressPercent').innerText = Math.round(progress) + '%';
                
                // Calcular tiempo restante
                if (chunkUpload.uploadedChunks > 1) {
                    const elapsed = (Date.now() - chunkUpload.startTime) / 1000;
                    const avgTimePerChunk = elapsed / chunkUpload.uploadedChunks;
                    const remainingChunks = totalChunks - chunkUpload.uploadedChunks;
                    const etaSeconds = Math.round(avgTimePerChunk * remainingChunks);
                    
                    document.getElementById('progressETA').innerText = 
                        `Tiempo restante: ~${etaSeconds}s`;
                }
                
                // PequeÃ±a pausa entre chunks para no saturar
                if (i < totalChunks - 1) {
                    await new Promise(resolve => setTimeout(resolve, 
                        chunkUpload.connectionSpeed === 'slow' ? 500 : 200));
                }
                
            } catch (error) {
                retryCount++;
                console.warn(`âš ï¸ Chunk ${i + 1}/${totalChunks} fallido (intento ${retryCount}/${chunkUpload.maxRetries})`);
                
                if (retryCount >= chunkUpload.maxRetries) {
                    throw new Error(`Chunk ${i + 1} fallido despuÃ©s de ${retryCount} intentos: ${error.message}`);
                }
                
                // Esperar antes de reintentar (exponencial)
                const waitTime = Math.min(5000, 1000 * Math.pow(2, retryCount));
                document.getElementById('progressStatus').innerText = 
                    `â¸ï¸ Reintentando chunk ${i + 1}... (${retryCount}/${chunkUpload.maxRetries})`;
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
        }
    }
    
    // Todos los chunks subidos, finalizar
    await finalizeChunkedUpload(id, filename, mimeType);
}

// SUBIR UN SOLO CHUNK
async function uploadSingleChunk(id, filename, mimeType, chunkArrayIndex, realChunkIndex) {
    const chunk = chunkUpload.chunks[chunkArrayIndex];
    const reader = new FileReader();
    
    return new Promise((resolve, reject) => {
        reader.onload = async function(e) {
            try {
                const base64 = e.target.result.split(',')[1];
                
                const params = new URLSearchParams();
                params.append("action", "uploadChunk");
                params.append("id", id);
                params.append("filename", filename);
                params.append("mime", mimeType);
                params.append("chunkIndex", chunk.index);
                params.append("chunkData", base64);
                params.append("totalChunks", chunk.total);
                params.append("fileId", chunk.fileId);
                params.append("uploadedBy", userCredentials.displayName);
                
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('progressStatus').innerText = 
                        `ğŸ“¤ Subiendo chunk ${realChunkIndex + 1}/${chunk.total}...`;
                    resolve();
                } else {
                    reject(new Error(data.error || 'Error desconocido'));
                }
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo chunk"));
        reader.readAsDataURL(chunk.blob);
    });
}

// FINALIZAR SUBIDA POR CHUNKS
async function finalizeChunkedUpload(id, filename, mimeType) {
    document.getElementById('progressStatus').innerText = 'âœ… Finalizando subida...';
    
    const params = new URLSearchParams();
    params.append("action", "finalizeChunkedUpload");
    params.append("id", id);
    params.append("filename", filename);
    params.append("mime", mimeType);
    params.append("totalChunks", chunkUpload.totalChunks);
    params.append("fileId", chunkUpload.chunks[0].fileId);
    params.append("uploadedBy", userCredentials.displayName);
    
    const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
    });
    
    const data = await res.json();
    
    if (data.success) {
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressPercent').innerText = '100%';
        document.getElementById('progressStatus').innerText = 'âœ… Â¡Completado!';
        
        setTimeout(() => {
            closeModal();
            openModal("âœ… Ã‰xito", "Â¡Arte subido con Ã©xito!", "ğŸ¨");
            updateTable();
            document.getElementById('arteFile').value = '';
        }, 1000);
    } else {
        throw new Error(data.error || 'Error al finalizar');
    }
}

// MOSTRAR MODAL DE PROGRESO - CORREGIDA
function showUploadProgressModal(id, filename, fileSizeMB) {
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    const closeBtn = document.getElementById('closeModalBtn');
    const mainBtn = document.getElementById('mainModalBtn');
    
    if (!modalIcon || !modalTitle || !modalMsg) return;
    
    modalIcon.innerText = "";
    modalTitle.innerText = "Subiendo Archivo";
    modalMsg.innerHTML = `
    <div style="text-align: left; margin-top: 15px;">
        <div id="progressInfo" style="font-size: 0.9rem; margin-bottom: 8px; color: #555;">Archivo: ${filename} (${fileSizeMB.toFixed(2)}MB)</div>
        <div id="progressSpeed" style="font-size: 0.85rem; margin-bottom: 15px; color: #666; font-weight: 500;">ConexiÃ³n: ${chunkUpload.connectionSpeed === 'slow-medium' ? 'slow' : chunkUpload.connectionSpeed} | Chunk: ${(chunkUpload.chunkSize / 1024).toFixed(0)}KB</div>
        <div id="progressUploadSpeed" style="font-size: 0.85rem; margin-bottom: 15px; color: var(--azul-deep); font-weight: 600;">
          ğŸ“¤ Velocidad: Calculando...
        </div>
        <div style="background: #f0f9ff; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span id="progressStatus" style="font-weight: 600; color: var(--azul-deep);">Preparando...</span>
                <span id="progressPercent" style="font-weight: 800; color: var(--turquesa);">0%</span>
            </div>
            <div style="background: #e9ecef; border-radius: 20px; height: 12px; overflow: hidden;">
                <div id="progressBar" style="background: linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 100%); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 20px;"></div>
            </div>
        </div>
        <div id="progressETA" style="font-size: 0.85rem; text-align: center; color: #666; margin-top: 8px;"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="btnPauseResume" class="modal-btn" style="background: #6c757d; flex: 1; padding: 8px;" onclick="togglePauseResume()">
                Pausar
            </button>
            <button id="btnCancelUpload" class="modal-btn" style="background: var(--rojo); flex: 1; padding: 8px;" onclick="cancelUpload()">
                Cancelar
            </button>
        </div>
    </div>
    `;
    
    loginArea.classList.add('hidden');
    uploadArea.classList.add('hidden');
    
    closeBtn.classList.remove('hidden');
    closeBtn.onclick = () => {
        resetChunkUploadState();
        closeModal();
    };
    
    if (mainBtn) mainBtn.classList.add('hidden');
    
    document.getElementById('modalAlert').style.display = 'flex';
}

// âœ… DETENER AL CERRAR SESIÃ“N
function logout() {
  // âœ… DETENER SINCRONIZACIÃ“N AUTOMÃTICA
  if (panelSyncInterval) {
    clearInterval(panelSyncInterval);
    panelSyncInterval = null;
  }
  
  // Resto del logout - cerrar panel si estÃ¡ abierto
  if (isPanelOpen) {
    closeSidePanel();
  }
  
  // Limpiar variables de sesiÃ³n
  isAdmin = false;
  isDesigner = false;
  userCredentials = { username: '', password: '', displayName: '' };
  
  // Actualizar UI
  document.getElementById('authBtn').innerText = 'ğŸ” Administrador';
  document.getElementById('authBtn').className = 'btn-login';
  document.getElementById('authBtn').onclick = showLogin;
  document.getElementById('welcomeMessage').classList.remove('show');
  
  // Cerrar panel si estÃ¡ abierto
  closeSidePanel();
  
  // Recargar tabla para actualizar permisos
  updateTable();
  
  openModal("âœ… SesiÃ³n Cerrada", "Has cerrado sesiÃ³n correctamente.", "ğŸšª");
}

// âœ… ACTUALIZAR DISPLAY DE VELOCIDAD DE SUBIDA
function updateUploadSpeedDisplay() {
  const speedElement = document.getElementById('progressUploadSpeed');
  if (!speedElement) return;
  
  const currentSpeed = chunkUpload.currentUploadSpeed;
  const avgSpeed = chunkUpload.avgUploadSpeed;
  
  if (currentSpeed > 0) {
    // Formatear velocidad: KB/s o MB/s segÃºn corresponda
    let speedText = '';
    let avgText = '';
    
    if (currentSpeed >= 1024) {
      // Mostrar en MB/s
      speedText = (currentSpeed / 1024).toFixed(2) + ' MB/s';
      avgText = (avgSpeed / 1024).toFixed(2) + ' MB/s';
    } else {
      // Mostrar en KB/s
      speedText = currentSpeed.toFixed(1) + ' KB/s';
      avgText = avgSpeed.toFixed(1) + ' KB/s';
    }
    
    // Calcular Mbps (1 byte = 8 bits)
    const currentMbps = (currentSpeed * 8 / 1024).toFixed(1);
    const avgMbps = (avgSpeed * 8 / 1024).toFixed(1);
    
    speedElement.innerHTML = `ğŸ“¤ Velocidad: <span style="color: var(--turquesa); font-weight: 800;">${currentMbps} Mbps</span> (${speedText})<br>
    <span style="font-size: 0.75rem; color: #666;">Promedio: ${avgMbps} Mbps (${avgText})</span>`;
  } else {
    speedElement.innerText = 'ğŸ“¤ Velocidad: Calculando...';
  }
}

// PAUSAR/REANUDAR SUBIDA
function togglePauseResume() {
    chunkUpload.pauseRequested = !chunkUpload.pauseRequested;
    chunkUpload.pauseRequested = !chunkUpload.pauseRequested;
    const btn = document.getElementById('btnPauseResume');
    
    if (chunkUpload.pauseRequested) {
        btn.innerHTML = 'â–¶ï¸ Reanudar';
        document.getElementById('progressStatus').innerText = 'â¸ï¸ PAUSADO';
    } else {
        btn.innerHTML = 'â¸ï¸ Pausar';
        document.getElementById('progressStatus').innerText = 'â–¶ï¸ Reanudando...';
    }
}

// ESPERAR A QUE SE REANUDE
function waitForResume() {
    return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
            if (!chunkUpload.pauseRequested || !chunkUpload.isActive) {
                clearInterval(checkInterval);
                resolve();
            }
        }, 100);
    });
}

// CANCELAR SUBIDA - CORREGIDA
function cancelUpload() {
    const id = document.getElementById('currentReqId')?.value;
    
    // Llamar al backend para limpiar recursos
    if (id && chunkUpload.isActive) {
        fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=cancelChunkedUpload&id=${encodeURIComponent(id)}` 
        })
        .then(response => response.json())
        .catch(err => {
            console.warn("âš ï¸ Error limpiando recursos: " + err.message);
        });
    }
    
    // Reiniciar estado de chunks
    resetChunkUploadState();
    
    // Cerrar modal
    closeModal();
    openModal("âš ï¸ Cancelado", "La subida ha sido cancelada y los recursos limpiados.", "â„¹ï¸");
    
    // Reiniciar input de archivo
    setTimeout(() => {
        const fileInput = document.getElementById('arteFile');
        if (fileInput) fileInput.value = '';
    }, 300);
}
</script>
</body>
</html>
