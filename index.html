<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<!-- ‚ú® SONIDO DE NOTIFICACI√ìN (CDN Externo) -->
<audio id="notificationSound" preload="auto">
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mp3">
  <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.wav" type="audio/wav">
</audio>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIRA 2.5 | Sistema Integral de Requerimientos de Artes</title>
<link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;500;600;800&display=swap" rel="stylesheet">
<!-- ‚úÖ Chart.js para gr√°ficos de estad√≠sticas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
--celeste: #8ecae6;
--turquesa: #219ebc;
--azul-deep: #023047;
--amarillo: #ffb703; --naranja: #fb8500; --rojo: #e63946;
--verde: #2d6a4f; --gris: #edf2f4;
--panel-width: 380px;
}
* { font-family: 'Georama', sans-serif;
box-sizing: border-box; font-weight: 500; }
body { background: #f4f7fa; margin: 0; padding-bottom: 50px; color: var(--azul-deep); }
header { background: var(--azul-deep);
padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; min-height: 55px;
flex-wrap: wrap;
gap: 10px;
}
.brand-container { display: flex; flex-direction: column; align-items: flex-start; flex: 1; min-width: 150px; }
.header-title { margin: 0; font-size: 1.2rem; font-weight: 800; color: white;
line-height: 1; }
.acronimo { font-size: 0.5rem; font-weight: 400; letter-spacing: 0.5px; margin-top: 2px; opacity: 0.9; text-transform: uppercase; color: white; max-width: 250px;
}
/* ‚úÖ ESTILO SWITCH MEJORADO SIN CONTENEDOR */
.nav-tabs { 
  display: flex; 
  justify-content: center; 
  gap: 8px; 
  flex: 1; 
  min-width: 160px; 
  max-width: 220px;
  padding: 4px;
  position: relative;
}

.tab-btn { 
  padding: 8px 16px; 
  border-radius: 20px; 
  border: none;
  cursor: pointer; 
  font-weight: 700; 
  text-transform: uppercase; 
  font-size: 0.65rem; 
  background: rgba(255,255,255,0.1); 
  color: rgba(255,255,255,0.7); 
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  display: flex; 
  align-items: center; 
  gap: 4px;
  position: relative;
  z-index: 2;
  letter-spacing: 0.3px;
  flex: 1;
  justify-content: center;
  backdrop-filter: blur(10px);
}

.tab-btn:hover {
  background: rgba(255,255,255,0.2);
  color: rgba(255,255,255,0.9);
  transform: translateY(-1px);
}

.tab-btn.active { 
  background: linear-gradient(135deg, var(--amarillo) 0%, var(--naranja) 100%);
  color: var(--azul-deep);
  font-weight: 800;
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 4px 15px rgba(251, 133, 0, 0.4);
}

.admin-access { flex: 1; display: flex; flex-direction: row; align-items: center; gap: 8px; min-width: 280px; flex-wrap: wrap; justify-content: flex-end; }
/* ‚úÖ ESTILO PARA MENSAJE DE BIENVENIDA - M√ÅS LLAMATIVO */
.welcome-message {
font-size: 0.9rem;
font-weight: 800;
color: white;
background: linear-gradient(135deg, var(--amarillo) 0%, var(--naranja) 100%);
padding: 6px 14px;
border-radius: 20px;
display: none;
box-shadow: 0 3px 12px rgba(251, 133, 0, 0.3);
border: 2px solid rgba(255, 255, 255, 0.2);
text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
letter-spacing: 0.3px;
position: relative;
z-index: 1;
margin-left: 8px;
}
.welcome-message.show {
display: block;
animation: fadeInDown 0.6s ease-out;
}
@keyframes fadeInDown {
from {
opacity: 0;
transform: translateY(-20px) scale(0.95);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}
/* ‚úÖ ESTILO PARA CONTENEDOR DE BOTONES EN HORIZONTAL */
.admin-buttons {
display: flex;
gap: 8px;
justify-content: flex-end;
flex-wrap: nowrap;
align-items: center;
}
.btn-login { background: var(--amarillo);
border: none; padding: 6px 12px; border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.7rem; box-shadow: 0 3px 0 #c79100; transition: 0.2s;
min-width: 100px;
}
.btn-login:active { transform: translateY(2px); box-shadow: 0 1px 0 #c79100; }
.btn-logout { background: var(--rojo); color: white; border: none; padding: 6px 12px;
border-radius: 8px; font-weight: 800; cursor: pointer; font-size: 0.7rem; min-width: 100px;
}
.row-new { background-color: #e3f2fd !important; border-left: 5px solid var(--turquesa) !important;
}
.row-obituario { background-color: #ffebee !important; border-left: 5px solid var(--rojo) !important; }
.badge-new { background: var(--turquesa); color: white; padding: 2px 8px;
border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; animation: blink 2s infinite; }
.badge-prioridad { background: white; color: var(--rojo);
padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 800; margin-left: 8px; display: inline-block; border: 1px solid var(--rojo);
}
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1;
} }
.stats-grid { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.stat-card { flex: 1; min-width: 100px;
padding: 8px; border-radius: 12px; text-align: center; color: white; font-weight: 800; }
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep);
}
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }
/* ‚úÖ ESTILOS PARA CONTADORES DE DISE√ëADORES */
.stat-bermina { background: var(--naranja); color: white; }
.stat-jorsy { background: var(--azul-deep); color: white; }
.stat-maria { background: var(--verde); color: white; }
.stat-xamir { background: var(--amarillo); color: var(--azul-deep); }
.stat-label { font-size: 0.6rem; text-transform: uppercase; display: block; opacity: 0.8;
}
.stat-val { font-size: 1.1rem; }
.container { max-width: 1200px; margin: 15px auto; padding: 25px; background: white; border-radius: 25px;
box-shadow: 0 15px 40px rgba(0,0,0,0.06); }
.aviso-48h { background: #fff3e0; border: 2.5px solid var(--naranja); color: var(--naranja); padding: 15px; border-radius: 15px;
text-align: center; font-weight: 800; margin-bottom: 25px; font-size: 1.1rem; }
.section-title { display: block; font-weight: 800; font-size: 0.85rem;
color: var(--turquesa); margin: 20px 0 12px; border-left: 4px solid var(--turquesa); padding-left: 10px; text-transform: uppercase; }
.category-row { display: grid;
grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }
.card-btn { background: #fff; border: 2px solid var(--gris); border-radius: 12px; padding: 6px 4px;
cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 800; font-size: 0.75rem; min-height: 45px; line-height: 1.1;
color: var(--azul-deep); }
.card-btn.selected { background: var(--amarillo); border-color: var(--naranja); transform: scale(0.98); }
.field-error { border: 2px solid var(--rojo) !important;
animation: border-blink 0.8s infinite alternate !important; background: #fff5f5 !important; }
@keyframes border-blink { from { border-color: var(--rojo);
box-shadow: 0 0 5px rgba(230, 57, 70, 0.2); } to { border-color: transparent; box-shadow: none; } }
.btn-time { padding: 8px;
border-radius: 12px; border: 2px solid var(--gris); cursor: pointer; font-weight: 800; font-size: 0.85rem; background: #f8f9fa; color: var(--azul-deep); flex: 1; transition: 0.3s;
}
.btn-time.active { background: var(--azul-deep); color: white; border-color: var(--azul-deep); }
/* ‚úÖ Estilo mejorado para bot√≥n Obituario */
#btn-obituario {
padding: 6px 12px !important;
font-size: 0.75rem !important;
min-width: auto !important;
width: auto !important;
height: auto !important;
border-radius: 8px !important;
}
#btn-obituario.obit-active {
background: var(--azul-deep) !important;
color: white !important;
border-color: var(--azul-deep) !important;
}
.modern-input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--gris); font-size: 0.95rem;
outline: none; transition: 0.3s; background: #fdfdfd; font-weight: 500; }
.modern-input:focus { border-color: var(--turquesa); background: white; }
.pass-container { position: relative; width: 100%;
}
.eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem; opacity: 0.6; z-index: 10;
}
.photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
.upload-box { height: 90px; border: 2.5px dashed var(--celeste);
border-radius: 15px; position: relative; overflow: hidden; background: #f0f9ff; }
.upload-label { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;
cursor: pointer; font-size: 0.7rem; font-weight: 800; color: var(--turquesa); text-align: center; }
.preview { position: absolute; top: 0; left: 0; width: 100%;
height: 100%; object-fit: cover; display: none; }
.remove-btn { position: absolute; top: 5px; right: 5px; background: var(--rojo); color: white; border: none;
border-radius: 50%; width: 25px; height: 25px; font-weight: 800; cursor: pointer; display: none; z-index: 10; }
.btn-send { background: var(--azul-deep); color: white;
width: 100%; padding: 14px; border-radius: 18px; border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 30px;
box-shadow: 0 6px 15px rgba(2, 48, 71, 0.3); transition: 0.3s; }
.btn-send:hover { transform: translateY(-2px); background: #054a6d; }
.modal-overlay { position: fixed;
top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.85); backdrop-filter: blur(8px); display: none; align-items: center;
justify-content: center; z-index: 20000; padding: 20px; }
.modal-content { background: white; padding: 40px 30px; border-radius: 30px; max-width: 450px; width: 100%;
text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative; }
/* MODAL CONFIRMACI√ìN */
#confirmModal .modal-content { max-width: 600px; padding: 30px;
}
#previewContent { text-align: left; max-height: 400px; overflow-y: auto; margin-bottom: 20px; }
#previewContent p { margin: 8px 0; line-height: 1.4;
}
/* MODAL MANTENIMIENTO */
#maintOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--azul-deep); z-index: 10000;
display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
.modal-btn { background: var(--turquesa); color: white; border: none;
padding: 12px; border-radius: 15px; font-weight: 800; width: 100%; margin-top: 25px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
.modal-btn:hover { background: var(--azul-deep);
}
.modal-btn-alt { background: var(--gris); color: var(--azul-deep); margin-top: 10px; }
/* ‚úÖ NUEVA CLASE PARA BOTONES IGUALES EN MODAL DE CONFIRMACI√ìN */
.modal-btn-confirm {
flex: 1;
min-width: 140px;
padding: 12px;
font-size: 1rem;
font-weight: 800;
border-radius: 12px;
border: none;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
text-align: center;
}
.modal-btn-confirm.corregir {
background: var(--gris);
color: var(--azul-deep);
}
.modal-btn-confirm.enviar {
background: var(--turquesa);
color: white;
}
.modal-btn-confirm:disabled {
background: #e9ecef;
color: #495057;
cursor: not-allowed;
}
/* ‚úÖ TABLA: DISE√ëO LIMPIO Y ESPACIADO */
.table-container {
width: 100%;
overflow-x: auto;
margin-top: 10px;
border-radius: 12px;
box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
table {
width: 100%;
border-collapse: separate; /* ‚úÖ MEJOR QUE COLLAPSE PARA BORDES REDONDEADOS */
border-spacing: 0;
min-width: 1000px; /* ‚úÖ M√ÅS ANCHO PARA EVITAR AMONTONAMIENTO */
background: white;
}
th {
background: #f1f5f9;
padding: 12px 15px; /* ‚úÖ M√ÅS ESPACIO VERTICAL */
text-align: left;
font-size: 0.7rem;
text-transform: uppercase;
font-weight: 800;
color: var(--turquesa);
border-bottom: 2px solid var(--celeste);
white-space: nowrap; /* ‚úÖ EVITA QUE LOS T√çTULOS SE ROMPAN */
}
td {
padding: 8px 15px; /* ‚úÖ FILAS M√ÅS COMPACTAS PARA MEJOR VISIBILIDAD */
border-bottom: 1px solid #edf2f4;
font-size: 0.85rem;
line-height: 1.3;
color: #334155;
font-weight: 500;
vertical-align: middle;
}
td.admin-actions-cell {
    vertical-align: middle;
    padding: 8px 15px; /* Mismo padding reducido que las otras celdas */
    text-align: right;
    border-bottom: 1px solid #edf2f4; /* Asegura el borde */
}

.admin-actions-content {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
    align-items: center;
    white-space: nowrap;
    font-size: 0.75rem;
    color: #fb8500;
    font-weight: 700;
}

.admin-actions-content span:first-child {
    display: inline-block;
    line-height: 1;
    font-size: 1.3rem;
    vertical-align: middle;
}

.admin-actions-content span:last-child {
    display: inline-block;
    line-height: 1.2;
    vertical-align: middle;
}

/* ‚úÖ C√çRCULO DE DISE√ëADOR EN TABLA */
.designer-circle {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
    margin-top: 2px;
}

/* ‚úÖ STATUS PILL */
.status-pill {
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 0.6rem;
    font-weight: 800;
    text-transform: uppercase;
    transition: 0.3s;
    display: inline-block;
    vertical-align: middle;
}
.status-pendiente { background: var(--celeste); color: var(--azul-deep); }
.status-procesando { background: var(--amarillo); color: var(--azul-deep); }
.status-finalizada { background: var(--verde); color: white; }

/* ‚úÖ UTILIDADES DE TEXTO */
.txt-bold { font-weight: 800; color: var(--azul-deep); }
.txt-small { font-size: 0.72rem; color: #4b4b4b; display: block; margin-bottom: 1px; font-weight: 500; }

.btn-act { border: none; border-radius: 5px; padding: 4px 6px;
cursor: pointer; font-size: 9px; color: white; font-weight: 800; transition: 0.2s; }
.btn-act:hover { transform: scale(1.1); }
.bg-pend { background: var(--celeste); color: var(--azul-deep);
}
.bg-proc { background: var(--amarillo); color: var(--azul-deep); }
.bg-fin { background: var(--verde); }
.btn-trash { background: none; border: none; cursor: pointer; font-size: 1.1rem;
margin-left: 8px; filter: grayscale(1); transition: 0.3s; }
.btn-trash:hover { filter: grayscale(0); transform: rotate(10deg);
}
/* Nuevos Estilos Botones Admin */
/* ‚úÖ BOT√ìN ADJUNTAR CORREGIDO: Icono + texto compacto */
.btn-arte {
background: #4a90e2;
color: white;
border: none;
border-radius: 5px;
padding: 3px 6px;
font-size: 9px;
font-weight: 800;
cursor: pointer;
white-space: nowrap;
min-width: auto;
width: auto;
}
.btn-ver { background: #f39c12; color: white; border: none; border-radius: 5px; padding: 4px 6px; font-size: 9px;
font-weight: 800; cursor: pointer; text-decoration: none; }
.btn-tg { background: #0088cc; color: white; border: none; border-radius: 5px; padding: 4px 6px;
font-size: 9px; font-weight: 800; cursor: pointer; }
.hidden { display: none !important; }
.page { display: none; }
.page.active { display: block;
}
#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 48, 71, 0.95); display: none;
flex-direction: column; align-items: center; justify-content: center; z-index: 30000; color: white; text-align: center; padding: 20px; }
.spinner { width: 60px; height: 60px;
border: 6px solid rgba(255,255,255,0.1); border-top: 6px solid var(--amarillo); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 25px;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
/* ‚úÖ Estilo para campos deshabilitados en modo obituario */
.obit-disabled {
background-color: #e9ecef !important;
color: #6c757d !important;
cursor: not-allowed !important;
}
.obit-upload-box {
background: #e9ecef !important;
border-color: #ced4da !important;
cursor: not-allowed !important;
}
.obit-upload-label {
color: #6c757d !important;
cursor: not-allowed !important;
}
/* ‚úÖ ESTILOS PARA BOT√ìN DE REPORTE MENSUAL - SOLO HABILITADO 1¬∞ DE MES */
#reportBtn {
position: relative;
overflow: hidden;
display: flex;
align-items: center;
gap: 6px;
white-space: nowrap;
}
#reportBtn:disabled {
opacity: 0.65;
cursor: not-allowed !important;
transform: none !important;
box-shadow: 0 3px 0 #1a3d2d !important;
}
#reportBtn:not(:disabled):hover {
transform: translateY(-2px);
box-shadow: 0 5px 0 #1a3d2d;
}
#reportBtn:not(:disabled):active {
transform: translateY(1px);
box-shadow: 0 2px 0 #1a3d2d;
}
#reportBtnText {
display: inline;
transition: opacity 0.3s;
}
.report-days-badge {
font-size: 0.6rem;
background: rgba(255,255,255,0.2);
padding: 2px 6px;
border-radius: 10px;
font-weight: 600;
display: none;
}
.report-days-badge.show {
display: inline-block;
}
/* ‚úÖ MEJORAS RESPONSIVE PARA M√ìVIL */
@media (max-width: 768px) {
/* Header reorganizado para m√≥vil */
header {
flex-direction: column;
align-items: center;
padding: 10px 15px;
min-height: auto;
gap: 8px;
}
.brand-container {
width: 100%;
align-items: center;
margin-bottom: 0;
}
.header-title {
font-size: 1.4rem;
text-align: center;
}
.acronimo {
font-size: 0.6rem;
text-align: center;
max-width: 100%;
}
.nav-tabs {
width: 100%;
justify-content: center;
flex-wrap: wrap;
gap: 6px;
margin: 8px 0 0 0;
}
.tab-btn {
padding: 5px 12px;
font-size: 0.7rem;
min-width: 100px;
}
.admin-access {
width: 100%;
align-items: center;
justify-content: center;
flex-wrap: wrap;
gap: 6px;
margin-top: 5px;
}
.welcome-message {
font-size: 0.85rem;
padding: 5px 10px;
}
.admin-buttons {
justify-content: center;
width: 100%;
flex-wrap: wrap;
}
.btn-login, .btn-logout {
padding: 5px 8px;
font-size: 0.6rem;
min-width: auto;
}
/* Contenedores de stats en columnas */
.stats-grid {
flex-direction: column;
gap: 8px;
}
.stat-card {
min-width: 100%;
padding: 10px;
}
/* Tabla m√°s compacta */
th, td {
padding: 4px 6px;
font-size: 0.75rem;
}
.status-pill {
padding: 2px 8px;
font-size: 0.55rem;
}
.txt-small {
font-size: 0.65rem;
}
.admin-actions {
flex-direction: column;
align-items: flex-end;
gap: 4px;
}
.btn-act, .btn-arte, .btn-ver, .btn-tg, .btn-trash {
width: 100%;
justify-content: center;
font-size: 0.75rem;
padding: 3px;
}
/* Formulario m√°s compacto */
.section-title {
font-size: 0.8rem;
margin: 15px 0 10px;
}
.modern-input {
padding: 10px;
font-size: 0.85rem;
}
.card-btn {
min-height: 40px;
font-size: 0.7rem;
padding: 4px 2px;
}
.btn-send {
padding: 12px;
font-size: 1rem;
}
/* Modales m√°s compactos */
.modal-content {
padding: 25px 20px;
margin: 10px;
}
.modal-btn {
padding: 10px;
font-size: 0.95rem;
}
}
/* ‚úÖ ESTILOS PARA BUSCADOR DE ID - DISE√ëADOR */
#designer-search-container {
transition: all 0.3s ease;
margin: 15px 0;
padding: 12px;
background: #fff3e0;
border-radius: 12px;
border: 2px solid #ffb703;
}
#designer-search-container.hidden {
display: none;
}
#searchIdInput {
transition: all 0.3s ease;
}
#searchIdInput:focus {
border-color: #fb8500;
box-shadow: 0 0 0 3px rgba(251, 133, 0, 0.2);
}
/* ‚úÖ EFECTOS DE RESALTADO Y BLOQUEO */
.row-highlighted {
background-color: #fff3e0 !important;
border-left: 5px solid #fb8500 !important;
animation: highlightPulse 0.8s ease;
}
.row-locked {
opacity: 0.3 !important;
pointer-events: none !important;
transition: opacity 0.4s ease, transform 0.4s ease;
}
.row-locked:hover {
cursor: not-allowed !important;
}
/* ‚úÖ BOTONES DESHABILITADOS EN FILAS BLOQUEADAS */
.row-locked .btn-arte,
.row-locked .btn-ver,
.row-locked .btn-tg {
opacity: 0.4 !important;
cursor: not-allowed !important;
pointer-events: none !important;
}
/* ‚úÖ ANIMACI√ìN DE RESALTADO */
@keyframes highlightPulse {
0%, 100% {
box-shadow: 0 0 0 0 rgba(251, 133, 0, 0.4);
}
50% {
box-shadow: 0 0 0 10px rgba(251, 133, 0, 0);
}
}
/* ‚úÖ ESTILO PARA INDICADOR DE B√öSQUEDA ACTIVA */
.search-active-indicator {
position: absolute;
top: -8px;
right: -8px;
background: #fb8500;
color: white;
width: 20px;
height: 20px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.7rem;
font-weight: 800;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
/* ‚úÖ MENSAJE DE NO COINCIDENCIAS */
.no-results-message {
text-align: center;
padding: 20px;
color: #6c757d;
font-weight: 600;
font-size: 0.9rem;
background: #f8f9fa;
border-radius: 8px;
margin-top: 10px;
display: none;
}
.no-results-message.show {
display: block;
animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(-10px); }
to { opacity: 1; transform: translateY(0); }
}
/* ‚úÖ BOT√ìN DE LIMPIAR B√öSQUEDA */
.clear-search-btn {
background: #e9ecef;
border: none;
border-radius: 6px;
padding: 6px 12px;
font-weight: 600;
font-size: 0.8rem;
cursor: pointer;
transition: all 0.3s ease;
margin-left: 8px;
}
.clear-search-btn:hover {
background: #dee2e6;
transform: scale(1.05);
}
.clear-search-btn:active {
transform: scale(0.95);
}
/* ‚úÖ ESTILO PARA CONTENEDOR DE BOT√ìN DE LIMPIEZA */
.search-controls {
display: flex;
align-items: center;
gap: 8px;
margin-top: 8px;
}
/* ‚úÖ INDICADOR DE FILTRO ACTIVO */
.filter-badge {
display: inline-block;
background: linear-gradient(135deg, #fb8500 0%, #ffb703 100%);
color: white;
padding: 4px 12px;
border-radius: 20px;
font-size: 0.75rem;
font-weight: 800;
margin-left: 10px;
animation: badgePulse 2s infinite;
}
@keyframes badgePulse {
0%, 100% { transform: scale(1); }
50% { transform: scale(1.05); }
}

/* ‚ú® ANIMACI√ìN DE PULSOS PARA BOT√ìN DE ENV√çO */
.btn-send-pulse {
  animation: pulse 1.5s infinite;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 150, 255, 0.3) !important;
}

@keyframes pulse {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 150, 255, 0.4); }
  70% { transform: scale(1.05); box-shadow: 0 0 0 12px rgba(0, 150, 255, 0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 150, 255, 0); }
}

/* ‚ú® ESTILO PARA TEXTO EN DOS L√çNEAS */
.btn-text {
  display: flex;
  flex-direction: column;
  text-align: center;
  line-height: 1.2;
  margin: 0;
  padding: 0;
}

.btn-text span {
  display: block;
  margin: 0;
  padding: 0;
}

/* ‚úÖ ESTILOS PARA CONTADORES COMBINADOS (ADMIN - TEXTO COMPLETO) */
.combined-stats {
  display: flex;
  justify-content: flex-start;
  gap: 6px;
  margin-bottom: 10px;
  flex-wrap: wrap;
  align-items: center;
}
.stat-mini {
  min-width: 95px; /* Ancho suficiente para texto completo */
  padding: 6px 10px;
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 0.78rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
}
.stat-mini:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}
.stat-mini .stat-label {
  font-size: 0.68rem;
  font-weight: 700;
  margin-bottom: 3px;
  text-transform: none;
  letter-spacing: -0.3px;
  line-height: 1.2;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-align: center;
}
.stat-mini .stat-val {
  font-size: 1.05rem;
  font-weight: 800;
  line-height: 1;
}
/* ‚úÖ Mantener colores existentes */
.st-total { background: var(--azul-deep); }
.st-pend { background: var(--celeste); color: var(--azul-deep); }
.st-proc { background: var(--amarillo); color: var(--azul-deep); }
.st-fin { background: var(--verde); }
.stat-bermina { background: var(--naranja); color: white; }
.stat-jorsy { background: var(--azul-deep); color: white; }
.stat-maria { background: var(--verde); color: white; }
.stat-xamir { background: var(--amarillo); color: var(--azul-deep); }

/* ‚úÖ Responsive: Ajustar en pantallas peque√±as */
@media (max-width: 1024px) {
  .stat-mini { min-width: 85px; padding: 5px 8px; }
  .stat-mini .stat-label { font-size: 0.62rem; }
  .stat-mini .stat-val { font-size: 0.95rem; }
}
@media (max-width: 768px) {
  .combined-stats { gap: 4px; }
  .stat-mini { min-width: 75px; padding: 4px 6px; font-size: 0.72rem; }
  .stat-mini .stat-label { font-size: 0.58rem; line-height: 1.1; }
  .stat-mini .stat-val { font-size: 0.9rem; }
}

/* ‚úÖ PANEL LATERAL DERECHO - ESTILOS COMPLETOS */
.side-panel {
position: fixed;
top: 0;
right: 0;
width: var(--panel-width);
height: 100vh;
background: white;
box-shadow: -8px 0 40px rgba(0,0,0,0.2);
z-index: 1000;
transform: translateX(100%);
transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
display: flex;
flex-direction: column;
border-left: 5px solid var(--turquesa);
}

.side-panel.active {
transform: translateX(0);
}

.side-panel-header {
background: var(--azul-deep);
color: white;
padding: 15px 20px;
display: flex;
align-items: center;
justify-content: space-between;
border-bottom: 4px solid var(--amarillo);
position: relative;
}

.side-panel-title {
font-weight: 800;
font-size: 1.1rem;
display: flex;
align-items: center;
gap: 10px;
}

.side-panel-close {
background: rgba(255,255,255,0.15);
border: none;
color: white;
width: 36px;
height: 36px;
border-radius: 50%;
font-size: 1.4rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s;
}

.side-panel-close:hover {
background: rgba(255,255,255,0.3);
transform: rotate(90deg);
}

.side-panel-content {
flex: 1;
overflow-y: auto;
padding: 20px;
display: flex;
flex-direction: column;
gap: 18px;
}

/* Secci√≥n de solicitud seleccionada */
.selected-request-section {
background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
border-radius: 16px;
padding: 18px;
border: 2px solid var(--celeste);
position: relative;
}

.selected-request-header {
font-weight: 800;
color: var(--azul-deep);
font-size: 0.8rem;
margin-bottom: 12px;
display: flex;
align-items: center;
gap: 8px;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.selected-request-id {
font-size: 1.2rem;
font-weight: 800;
color: var(--turquesa);
word-break: break-all;
line-height: 1.3;
}

.selected-request-info {
font-size: 0.8rem;
color: #495057;
margin-top: 10px;
line-height: 1.5;
}

.no-selection {
text-align: center;
color: #adb5bd;
padding: 25px 15px;
}

.no-selection-icon {
font-size: 3rem;
margin-bottom: 12px;
opacity: 0.6;
}

/* Vista previa de archivo - IMAGEN COMPLETA A ESCALA */
.file-preview-section {
background: #f8f9fa;
border-radius: 16px;
padding: 18px;
border: 2px dashed var(--celeste);
}

.file-preview-header {
font-weight: 800;
color: var(--azul-deep);
font-size: 0.8rem;
margin-bottom: 12px;
display: flex;
align-items: center;
gap: 8px;
text-transform: uppercase;
}

.file-preview-container {
width: 100%;
height: 200px;
background: white;
border-radius: 12px;
overflow: hidden;
display: flex;
align-items: center;
justify-content: center;
border: 2px solid var(--gris);
position: relative;
}

.file-preview-image-full {
max-width: 100%;
max-height: 100%;
width: auto;
height: auto;
object-fit: contain;
cursor: pointer;
transition: transform 0.3s;
}

.file-preview-image-full:hover {
transform: scale(1.05);
}

.file-preview-placeholder {
text-align: center;
color: #adb5bd;
font-size: 0.85rem;
padding: 20px;
}

.file-preview-placeholder-icon {
font-size: 2.5rem;
margin-bottom: 8px;
opacity: 0.5;
}

.file-preview-info {
font-size: 0.75rem;
color: #6c757d;
margin-top: 10px;
text-align: center;
}

/* Botones del panel */
.panel-section-title {
font-size: 0.7rem;
font-weight: 800;
text-transform: uppercase;
color: var(--turquesa);
letter-spacing: 0.8px;
margin-bottom: 10px;
padding-left: 5px;
display: flex;
align-items: center;
gap: 6px;
}

.panel-actions {
display: flex;
flex-direction: column;
gap: 8px;
}

.panel-btn {
width: 100%;
padding: 12px 15px;
border: none;
border-radius: 10px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.25s ease;
display: flex;
align-items: center;
gap: 10px;
text-align: left;
position: relative;
}

.panel-btn:disabled {
opacity: 0.4;
cursor: not-allowed;
transform: none !important;
}

.panel-btn:not(:disabled):hover {
transform: translateX(5px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.panel-btn-primary { background: var(--turquesa); color: white; }
.panel-btn-success { background: var(--verde); color: white; }
.panel-btn-warning { background: var(--amarillo); color: var(--azul-deep); }
.panel-btn-danger { background: var(--rojo); color: white; }
.panel-btn-info { background: var(--celeste); color: var(--azul-deep); }
.panel-btn-secondary { background: #e9ecef; color: var(--azul-deep); }

/* ‚úÖ CORRECCI√ìN: Colores correctos para botones de estatus en panel */
.panel-btn-pendiente { 
    background: var(--celeste); 
    color: var(--azul-deep); 
}
.panel-btn-procesando { 
    background: var(--amarillo); 
    color: var(--azul-deep); 
}
.panel-btn-finalizada { 
    background: var(--verde); 
    color: white; 
}

.btn-status-indicator {
position: absolute;
right: 12px;
width: 8px;
height: 8px;
border-radius: 50%;
background: rgba(255,255,255,0.4);
}

.btn-status-indicator.active {
background: white;
box-shadow: 0 0 8px rgba(255,255,255,0.6);
}

#indPend.active { background: var(--celeste) !important; box-shadow: 0 0 8px var(--celeste) !important; }
#indProc.active { background: var(--amarillo) !important; box-shadow: 0 0 8px var(--amarillo) !important; }
#indFin.active { background: var(--verde) !important; box-shadow: 0 0 8px var(--verde) !important; }

/* Asignaci√≥n de dise√±ador */
.designer-assign-section {
background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
border-radius: 16px;
padding: 18px;
border: 2px solid var(--naranja);
}

.designer-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 10px;
margin-top: 12px;
}

.designer-btn {
padding: 12px 8px;
border: 2px solid transparent;
border-radius: 10px;
font-weight: 700;
font-size: 0.8rem;
cursor: pointer;
transition: all 0.2s;
display: flex;
flex-direction: column;
align-items: center;
gap: 6px;
background: white;
box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.designer-btn:disabled {
opacity: 0.4;
cursor: not-allowed;
}

.designer-btn.selected {
border-color: var(--naranja);
background: var(--amarillo);
box-shadow: 0 0 0 3px rgba(251, 133, 0, 0.25), 0 4px 12px rgba(251, 133, 0, 0.3);
transform: scale(1.02);
}

.designer-avatar {
width: 36px;
height: 36px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 1.3rem;
box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

/* Footer del panel */
.panel-footer {
padding: 20px;
background: #f8f9fa;
border-top: 3px solid var(--gris);
display: flex;
flex-direction: column;
gap: 10px;
}

/* Footer compacto */
.panel-footer.compact {
padding: 15px;
}

.panel-footer-row {
display: flex;
gap: 8px;
margin-bottom: 8px;
}

.panel-btn.compact-btn {
padding: 8px 10px;
font-size: 0.75rem;
min-height: 36px;
}

.panel-btn.compact-btn .btn-text {
font-size: 0.7rem;
}

.panel-footer-divider {
height: 2px;
background: linear-gradient(90deg, transparent, var(--celeste), transparent);
margin: 5px 0;
}

/* Indicador visual de fila seleccionada en tabla */
.row-selected-panel {
background-color: #fff8e1 !important;
border-left: 5px solid var(--naranja) !important;
box-shadow: inset 0 0 20px rgba(251, 133, 0, 0.1);
position: relative;
}

.row-selected-panel::before {
content: '‚ñ∂';
position: absolute;
left: -3px;
top: 50%;
transform: translateY(-50%);
color: var(--naranja);
font-size: 0.8rem;
}

/* Overlay para cerrar panel al hacer click fuera */
.panel-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.3);
z-index: 999;
opacity: 0;
visibility: hidden;
transition: all 0.3s;
backdrop-filter: blur(2px);
}

.panel-overlay.active {
opacity: 1;
visibility: visible;
}

/* Responsive panel */
@media (max-width: 768px) {
.side-panel {
width: 100%;
border-left: none;
border-top: 5px solid var(--turquesa);
transform: translateY(100%);
}

.side-panel.active {
transform: translateY(0);
}
}

/* Animaci√≥n de entrada para secciones del panel */
@keyframes slideInRight {
from { opacity: 0; transform: translateX(20px); }
to { opacity: 1; transform: translateX(0); }
}

.side-panel-content > * {
animation: slideInRight 0.4s ease forwards;
}

.side-panel-content > *:nth-child(1) { animation-delay: 0.05s; }
.side-panel-content > *:nth-child(2) { animation-delay: 0.1s; }
.side-panel-content > *:nth-child(3) { animation-delay: 0.15s; }
.side-panel-content > *:nth-child(4) { animation-delay: 0.2s; }
.side-panel-content > *:nth-child(5) { animation-delay: 0.25s; }
.side-panel-content > *:nth-child(6) { animation-delay: 0.3s; }
}

/* Bot√≥n de reporte en panel - igual al del header */
.panel-btn.report-btn {
position: relative;
overflow: hidden;
background: linear-gradient(to right, #2d6a4f 0%, #1e4a35 0%);
box-shadow: 0 3px 0 #1e4a35;
width: 100%;
}

.panel-btn.report-btn:disabled {
opacity: 0.65;
cursor: not-allowed !important;
transform: none !important;
box-shadow: 0 3px 0 #1a3d2d !important;
}

.panel-btn.report-btn:not(:disabled):hover {
transform: translateY(-2px);
box-shadow: 0 5px 0 #1e4a35;
}

.panel-btn.report-btn:not(:disabled):active {
transform: translateY(1px);
box-shadow: 0 2px 0 #1e4a35;
}

/* Responsive ajustes */
@media (max-width: 768px) {
.panel-footer-row {
flex-direction: row;
}
.panel-btn.compact-btn {
font-size: 0.7rem;
padding: 6px 8px;
}
}

/* ‚úÖ ESTILOS PARA P√ÅGINA DE ESTAD√çSTICAS */
/* Estilos para gauges y medidores de cuota */
.quota-gauge-card {
background: white;
border-radius: 16px;
padding: 20px;
box-shadow: 0 4px 20px rgba(0,0,0,0.08);
border: 2px solid var(--gris);
transition: all 0.3s ease;
}

.quota-gauge-card:hover {
transform: translateY(-2px);
box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.quota-gauge-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.quota-gauge-title {
display: flex;
align-items: center;
gap: 10px;
font-weight: 800;
font-size: 1.1rem;
color: var(--azul-deep);
}

.quota-gauge-icon {
font-size: 1.5rem;
}

.quota-gauge-status {
padding: 6px 12px;
border-radius: 20px;
font-size: 0.75rem;
font-weight: 700;
text-transform: uppercase;
}

.quota-gauge-status.status-good {
background: #d4edda;
color: #155724;
}

.quota-gauge-status.status-warning {
background: #fff3cd;
color: #856404;
}

.quota-gauge-status.status-danger {
background: #f8d7da;
color: #721c24;
}

.quota-gauge-chart-container {
position: relative;
height: 200px;
display: flex;
align-items: center;
justify-content: center;
margin-bottom: 20px;
}

.quota-gauge-center-text {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
text-align: center;
}

.quota-gauge-percentage {
font-size: 2.5rem;
font-weight: 800;
color: var(--azul-deep);
line-height: 1;
}

.quota-gauge-label {
font-size: 0.9rem;
color: #666;
margin-top: 5px;
}

.quota-gauge-details {
display: flex;
justify-content: space-around;
gap: 20px;
}

.quota-detail-item {
text-align: center;
flex: 1;
}

.quota-detail-value {
font-size: 1.5rem;
font-weight: 800;
color: var(--turquesa);
line-height: 1;
}

.quota-detail-label {
font-size: 0.8rem;
color: #666;
margin-top: 5px;
}

/* Estilos para timeline y gr√°ficos */
.quota-timeline-container {
background: white;
border-radius: 16px;
padding: 20px;
box-shadow: 0 4px 20px rgba(0,0,0,0.08);
border: 2px solid var(--gris);
transition: all 0.3s ease;
}

.quota-timeline-container:hover {
transform: translateY(-2px);
box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.quota-timeline-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.quota-timeline-title {
display: flex;
align-items: center;
gap: 10px;
font-weight: 800;
font-size: 1.1rem;
color: var(--azul-deep);
}

.quota-chart-container {
position: relative;
background: #f8f9fa;
border-radius: 12px;
padding: 15px;
border: 1px solid #e9ecef;
}

/* Estilos para botones de tiempo y actualizaci√≥n */
.quota-refresh-btn {
background: var(--turquesa);
color: white;
border: none;
padding: 8px 16px;
border-radius: 12px;
font-weight: 700;
font-size: 0.85rem;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 6px;
}

.quota-refresh-btn:hover {
background: var(--azul-deep);
transform: translateY(-1px);
}

.quota-refresh-btn:active {
transform: translateY(0);
}

/* Estilos para Tarjetas de Dise√±adores (Formato Did√°ctico) */
.designer-performance-cards-container {
display: flex;
flex-direction: column;
gap: 10px;
width: 100%;
}

.designer-card {
background: white;
border-radius: 12px;
padding: 15px;
border: 2px solid #f1f5f9;
display: flex;
align-items: center;
gap: 12px;
transition: all 0.3s ease;
box-shadow: 0 2px 8px rgba(0,0,0,0.05);
justify-content: space-between; /* Distribuye el espacio entre los elementos */
}

.designer-card:hover {
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(0,0,0,0.1);
border-color: var(--turquesa);
}

.designer-avatar {
width: 40px;
height: 40px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-weight: 800;
color: white;
font-size: 1.1rem;
flex-shrink: 0;
box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.designer-info {
flex: 1;
display: flex;
flex-direction: row; /* Cambiado a fila para distribuir horizontalmente */
align-items: center; /* Centrar verticalmente los elementos */
justify-content: space-between; /* Distribuir nombre y stats */
gap: 10px; /* Espacio entre nombre y stats */
}

.designer-name {
font-weight: 700;
color: var(--azul-deep);
font-size: 0.95rem;
white-space: nowrap; /* Evitar que el nombre se rompa en varias l√≠neas */
overflow: hidden;
text-overflow: ellipsis; /* A√±adir puntos suspensivos si el nombre es muy largo */
flex: 1; /* Permitir que el nombre ocupe el espacio disponible */
min-width: 0; /* Forzar el truncamiento si no hay espacio */
}

.designer-stats {
display: flex;
flex-direction: row; /* Asegurar que las estad√≠sticas est√©n en fila */
align-items: center;
gap: 8px; /* Reducir el espacio entre el n√∫mero y 'FINALIZADAS' */
}

.designer-stat-value {
font-weight: 800;
font-size: 1.1rem;
color: var(--turquesa);
white-space: nowrap;
}

.designer-stat-label {
font-size: 0.7rem;
color: #64748b;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
white-space: nowrap;
}

.designer-percentage {
background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
border-radius: 8px;
padding: 6px 12px;
font-weight: 800;
font-size: 0.9rem;
color: var(--azul-deep);
min-width: 60px;
text-align: center;
border: 1px solid #e2e8f0;
margin-left: 15px; /* Mantener el margen a la izquierda para separarlo */
flex-shrink: 0; /* Evitar que el porcentaje se encoja */
}

/* Estilos para contenedores de estad√≠sticas detalladas */
.stats-detailed-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-top: 20px;
}

.stats-detail-card {
background: #f8f9fa;
border-radius: 12px;
padding: 15px;
border: 1px solid #e9ecef;
}

.stats-detail-title {
font-weight: 800;
font-size: 1rem;
margin-bottom: 15px;
display: flex;
align-items: center;
gap: 8px;
}

.stats-item {
display: flex;
justify-content: space-between;
align-items: center;
padding: 8px 0;
border-bottom: 1px solid #e9ecef;
}

.stats-item:last-child {
border-bottom: none;
}

.stats-item-label {
font-weight: 600;
color: #495057;
}

.stats-item-value {
font-weight: 800;
color: var(--azul-deep);
}

/* Responsive para estad√≠sticas */
@media (max-width: 768px) {
.quota-gauge-card,
.quota-timeline-container {
padding: 15px;
margin-bottom: 15px;
}

.quota-gauge-chart-container {
height: 150px;
}

.quota-gauge-percentage {
font-size: 2rem;
}

.quota-gauge-details {
flex-direction: column;
gap: 15px;
}

.quota-detail-item {
text-align: center;
}

.stats-detailed-grid {
grid-template-columns: 1fr;
gap: 15px;
}
}
/* ‚úÖ ESTILOS PARA PESTA√ëA DE ESTAD√çSTICAS */
.nav-tabs.tab-estadisticas::before {
transform: translateX(200%);
}

#stats-page .stat-card {
min-width: 120px;
}

#stats-page .quota-gauge-card {
margin-bottom: 20px;
}

#stats-page .quota-timeline-container {
margin-bottom: 20px;
}

/* Responsive para estad√≠sticas */
@media (max-width: 768px) {
#stats-page .stats-grid {
flex-direction: column;
}
#stats-page .stat-card {
min-width: 100%;
}
}
/* ‚úÖ NUEVO ESTILO PARA ESTAD√çSTICAS DETALLADAS (TIPO DASHBOARD) */
.stats-dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-dashboard-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    border: 1px solid #edf2f4;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.stat-dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: var(--turquesa);
}

/* Barra de color superior */
.stat-dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 6px;
}

.stat-card-unidades::before { background: var(--turquesa); }
.stat-card-jornadas::before { background: var(--naranja); }
.stat-card-especialidades::before { background: var(--verde); }
.stat-card-servicios::before { background: var(--rojo); }

.stat-card-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    opacity: 0.8;
}

.stat-card-title {
    font-size: 0.85rem;
    color: #64748b;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 15px;
    letter-spacing: 0.5px;
}

.stat-card-list {
    width: 100%;
    list-style: none;
    padding: 0;
    margin: 0;
}

.stat-card-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.9rem;
}

.stat-card-item:last-child {
    border-bottom: none;
}

.stat-card-label {
    color: #334155;
    font-weight: 500;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 70%;
}

.stat-card-value {
    font-weight: 800;
    color: var(--azul-deep);
    background: #f1f5f9;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 0.85rem;
}

/* Colores espec√≠ficos para valores */
.stat-card-unidades .stat-card-value { color: var(--turquesa); background: #e0f7fa; }
.stat-card-jornadas .stat-card-value { color: var(--naranja); background: #fff3e0; }
.stat-card-especialidades .stat-card-value { color: var(--verde); background: #e8f5e9; }
.stat-card-servicios .stat-card-value { color: var(--rojo); background: #ffebee; }

/* ‚úÖ OCULTAR TABLA ANTIGUA DE DISE√ëADORES */
#designerTableContainer {
    display: none !important;
}

/* ‚úÖ CORRECCI√ìN TABLA DE DISE√ëADORES */
.designer-performance-table {
  width: 100%;
  table-layout: fixed; /* ‚úÖ EVITA QUE LA TABLA SE SALGA DEL CONTENEDOR */
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 0.85rem;
  border-spacing: 0;
}
.designer-performance-table th, 
.designer-performance-table td {
  padding: 12px 10px;
  text-align: center;
  overflow: hidden; /* ‚úÖ RECORTA TEXTO LARGO */
  white-space: nowrap; /* ‚úÖ EVITA SALTOS DE L√çNEA */
  text-overflow: ellipsis; /* ‚úÖ PONE ... SI EL TEXTO ES LARGO */
  vertical-align: middle;
  border-bottom: 1px solid #edf2f4;
}
/* Columna de nombre m√°s ancha y alineada a la izquierda */
.designer-performance-table th:nth-child(1),
.designer-performance-table td:nth-child(1) {
  width: 45%;
  text-align: left;
  padding-left: 15px;
}
/* Columnas de n√∫meros centradas con ancho fijo */
.designer-performance-table th:nth-child(2),
.designer-performance-table td:nth-child(2) {
  width: 25%;
  text-align: center;
}
.designer-performance-table th:nth-child(3),
.designer-performance-table td:nth-child(3) {
  width: 30%;
  text-align: center;
}
/* Quitar borde de la √∫ltima fila */
.designer-performance-table tr:last-child td {
  border-bottom: none;
}
</style>
</head>
<body>
<div id="maintOverlay">
<span style="font-size: 80px;">üõ†Ô∏è</span>
<h1 style="font-weight: 800; font-size: 2.5rem; margin: 20px 0;">SISTEMA EN MANTENIMIENTO</h1>
<p style="font-size: 1.2rem; max-width: 500px; opacity: 0.9;">Estamos trabajando para mejorar tu experiencia.
Disculpen las molestias ocasionadas.</p>
<button class="btn-login" style="margin-top: 30px; padding: 12px 25px; font-size: 1rem;"
onclick="showLogin()">üîì ACCESO ADMINISTRADOR</button>
</div>
<div id="loadingOverlay">
<div class="spinner"></div>
<div class="loading-text" id="loadMainTxt">Procesando...</div>
<div class="loading-subtext" id="loadSubTxt"></div>
</div>

<!-- ‚úÖ OVERLAY PARA CERRAR PANEL AL HACER CLICK FUERA -->
<div id="panelOverlay" class="panel-overlay" onclick="closeSidePanel()"></div>

<!-- ‚úÖ PANEL LATERAL DERECHO -->
<div id="sidePanel" class="side-panel">
<div class="side-panel-header">
<div class="side-panel-title">
<span id="panelRoleIcon">‚öôÔ∏è</span>
<span id="panelRoleText">Panel de Control</span>
</div>
<button class="side-panel-close" onclick="closeSidePanel()" title="Cerrar panel">√ó</button>
</div>

<div class="side-panel-content">
<!-- Selecci√≥n de Solicitud -->
<div class="selected-request-section">
<div class="selected-request-header">üìã Solicitud Seleccionada</div>
<div id="selectedRequestContent">
<div class="no-selection">
<div class="no-selection-icon">üì≠</div>
<div>Selecciona una solicitud<br>de la tabla para activar<br>las acciones</div>
</div>
</div>
</div>

<!-- Vista Previa de Archivo - IMAGEN COMPLETA A ESCALA -->
<div class="file-preview-section">
<div class="file-preview-header">üé® Archivo Adjunto</div>
<div class="file-preview-container" id="filePreviewContainer">
<div class="file-preview-placeholder">
<div class="file-preview-placeholder-icon">üìé</div>
<div>No hay archivo adjunto</div>
</div>
</div>
<div class="file-preview-info" id="filePreviewInfo"></div>
</div>

<!-- Acciones de Estado -->
<div class="panel-actions" id="statusActions">
<div class="panel-section-title">üîÑ Cambiar Estado</div>
<button class="panel-btn panel-btn-pendiente" id="btnStatusPend" onclick="changeStatus('PENDIENTE')" disabled>
‚è≥ Pendiente
<span class="btn-status-indicator" id="indPend"></span>
</button>
<button class="panel-btn panel-btn-procesando" id="btnStatusProc" onclick="changeStatus('PROCESANDO')" disabled>
‚öôÔ∏è Procesando
<span class="btn-status-indicator" id="indProc"></span>
</button>
<button class="panel-btn panel-btn-finalizada" id="btnStatusFin" onclick="changeStatus('FINALIZADA')" disabled>
‚úÖ Finalizada
<span class="btn-status-indicator" id="indFin"></span>
</button>
</div>

<!-- Asignaci√≥n de Dise√±ador (Solo Admin) -->
<div class="designer-assign-section hidden" id="designerAssignSection">
<div class="panel-section-title">üë®‚Äçüé® Asignar Dise√±ador</div>
<!-- ‚úÖ ACTUALIZAR designer-grid EN EL PANEL LATERAL -->
<div class="designer-grid" id="designerGrid">
<button class="designer-btn" onclick="assignDesigner('Bermina')" disabled>
<span class="designer-avatar" style="background: #fb8500;">üë©</span>
<span>Bermina</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Jorsy')" disabled>
<span class="designer-avatar" style="background: #023047; color: white;">üë®</span>
<span>Jorsy</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Mar√≠a F.')" disabled>
<span class="designer-avatar" style="background: #2d6a4f;">üë©</span>
<span>Mar√≠a F.</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Xamir')" disabled>
<span class="designer-avatar" style="background: #ffb703;">üë®</span>
<span>Xamir</span>
</button>
<button class="designer-btn" onclick="assignDesigner('Fulan@')" disabled>
<span class="designer-avatar" style="background: #9d0208; color: white;">üë§</span>
<span>Fulan@</span>
</button>
</div>
</div>

<!-- Acciones de Archivo -->
<div class="panel-actions" id="fileActions">
<div class="panel-section-title">üìÅ Acciones de Archivo</div>
<button class="panel-btn panel-btn-info" id="btnAdjuntar" onclick="panelAdjuntarArte()" disabled>
üì§ Adjuntar Arte
</button>
<button class="panel-btn panel-btn-secondary" id="btnVerArte" onclick="panelVerArte()" disabled>
üëÅÔ∏è Ver Arte
</button>
<button class="panel-btn panel-btn-primary" id="btnEnviarTG" onclick="panelEnviarTelegram()" disabled>
‚úàÔ∏è Enviar a Telegram
</button>
</div>

<!-- Acciones Especiales (Solo Admin) -->
<div class="panel-actions hidden" id="adminActions">
<div class="panel-section-title">‚ö†Ô∏è Acciones Especiales</div>
<button class="panel-btn panel-btn-danger" id="btnEliminar" onclick="panelEliminar()" disabled>
üóëÔ∏è Eliminar Solicitud
</button>
</div>
</div>

<!-- Footer con botones siempre visibles -->
<div class="panel-footer compact">
<div class="panel-footer-divider"></div>
<div class="panel-section-title" style="font-size: 0.65rem; margin-bottom: 8px;">üîê Sistema</div>
<div class="panel-footer-row">
<button class="panel-btn panel-btn-secondary compact-btn" id="btnMaint" onclick="toggleMaintMode()">
üõ†Ô∏è Mantenimiento
</button>
<button class="panel-btn panel-btn-danger compact-btn" onclick="logout()">
üö™ Cerrar Sesi√≥n
</button>
</div>
<button class="panel-btn panel-btn-success compact-btn report-btn" id="btnReportPanel" onclick="generateMonthlyReport()" disabled>
<span id="reportBtnTextPanel">üìä Reporte</span>
<span id="reportBtnDaysPanel" class="report-days-badge"></span>
</button>
</div>
</div>

<div class="modal-overlay" id="modalAlert">
<div class="modal-content">
<span id="modalIcon" style="font-size: 60px; display: block; margin-bottom: 10px;">‚ö†Ô∏è</span>
<div id="modalTitle" style="font-weight: 800; font-size: 1.4rem; color: var(--azul-deep);">Atenci√≥n</div>
<div id="modalMsg" style="margin-top: 15px; color: #555; font-size: 1rem; line-height: 1.4; font-weight: 500;"></div>
<div id="loginArea" class="hidden" style="margin-top:20px; text-align: left;">
<label class="txt-small">Usuario del Sistema:</label>
<input type="text" id="adminUser" class="modern-input" style="margin-bottom:15px;"
placeholder="Ingrese usuario">
<label class="txt-small">Clave de Seguridad:</label>
<div class="pass-container">
<input type="password" id="adminPass" class="modern-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
<span class="eye-icon" onclick="togglePass()">üëÅÔ∏è</span>
</div>
</div>
<!-- ‚úÖ BARRA DE PROGRESO PARA LOGIN -->
<div id="loginProgressBar" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 2px solid var(--celeste);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span id="loginProgressText" style="font-weight: 700; color: var(--azul-deep); font-size: 0.9rem;">Verificando credenciales...</span>
        <span id="loginProgressPercent" style="font-weight: 800; color: var(--turquesa); font-size: 1rem;">0%</span>
    </div>
    <div style="background: #e9ecef; border-radius: 20px; height: 12px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
        <div id="loginProgressBarInner" style="background: linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%); height: 100%; width: 0%; transition: width 0.4s ease; border-radius: 20px; box-shadow: 0 2px 8px rgba(33, 158, 188, 0.3);"></div>
    </div>
    <div id="loginProgressStatus" style="margin-top: 8px; font-size: 0.8rem; color: #6c757d; text-align: center; font-weight: 500;">Conectando con el servidor...</div>
</div>
<div id="uploadArea" class="hidden" style="margin-top:20px;">
<input type="file" id="arteFile" class="modern-input" accept=".jpg,.jpeg,.png,.pdf,.zip" style="font-size: 0.8rem;">
<p style="font-size: 0.7rem; color: #666; margin-top: 5px;">M√°ximo 5MB (Formatos: JPG, PNG, PDF, ZIP)</p>
<input type="hidden" id="currentReqId">
</div>
<button id="mainModalBtn" class="modal-btn">ENTENDIDO</button>
<button id="closeModalBtn" class="modal-btn modal-btn-alt hidden" onclick="closeModal()">CERRAR</button>
</div>
</div>
<div class="modal-overlay" id="confirmModal">
<div class="modal-content">
<h2 style="font-weight: 800; color: var(--azul-deep); margin-top: 0;">üîç Revisa tu Solicitud</h2>
<div id="previewContent"></div>
<div style="display: flex; gap: 12px; justify-content: center; width: 100%; max-width: 500px; margin: 0 auto; margin-top: 20px;">
<button id="btnCorregir" class="modal-btn-confirm corregir">‚úèÔ∏è Corregir</button>
<button id="btnEnviarConfirmado" class="modal-btn-confirm enviar" disabled>üöÄ Enviar Solicitud (<span id="countdown">10</span>)</button>
</div>
</div>
</div>
<!-- ‚úÖ MODAL PARA SELECCIONAR DISE√ëADOR - ELIMINADO (AHORA EN PANEL) -->
<!-- ‚úÖ MODAL PARA MENSAJE DE ID NO ENCONTRADO -->
<div class="modal-overlay" id="idNotFoundModal" style="display: none;">
<div class="modal-content" style="max-width: 450px; padding: 25px;">
<span style="font-size: 50px; display: block; margin-bottom: 15px; color: #fb8500;">üîç</span>
<h2 style="font-weight: 800; color: var(--azul-deep); margin: 0 0 15px 0;">ID no encontrado</h2>
<p style="font-size: 1rem; line-height: 1.5; color: #495057; margin-bottom: 20px;">
No se encontr√≥ ninguna solicitud con el ID: <strong id="notFoundId"></strong>
</p>
<p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 25px;">
Verifica que el ID sea correcto o limpia la b√∫squeda para ver todas las solicitudes
</p>
<div style="display: flex; justify-content: center; gap: 15px;">
<button class="modal-btn" style="background: var(--gris); color: var(--azul-deep);" onclick="closeIdNotFoundModal()">CERRAR</button>
<button class="modal-btn" style="background: #fb8500; color: white;" onclick="clearSearch()">LIMPIAR B√öSQUEDA</button>
</div>
</div>
</div>
<header>
<div class="brand-container">
<h1 class="header-title">SIRA 2.5</h1>
<span class="acronimo">Sistema Integral de Requerimientos de Artes</span>
</div>
<div class="nav-tabs">
<button id="tab-form" class="tab-btn active" onclick="showPage('form-page', this)">üìù FORMULARIO</button>
<button id="tab-list" class="tab-btn" onclick="showPage('list-page', this)">üìã SOLICITUDES</button>
<button id="tab-stats" class="tab-btn hidden" onclick="showPage('stats-page', this)">üìä ESTAD√çSTICAS</button>
</div>
<div class="admin-access">
<!-- ‚úÖ MENSAJE DE BIENVENIDA - M√ÅS LLAMATIVO -->
<div id="welcomeMessage" class="welcome-message">¬°Hola, <span id="userNameDisplay"></span>!</div>
<!-- Solo bot√≥n de login/logout -->
<button id="authBtn" class="btn-login" onclick="showLogin()">üîê Administrador</button>
</div>
</header>
<div class="container page active" id="form-page">
<div class="aviso-48h">‚ö†Ô∏è IMPORTANTE: LAS SOLICITUDES DEBEN REALIZARSE CON 48 HORAS DE ANTICIPACI√ìN</div>
<form id="sigrafForm" novalidate>
<!-- ... -->
<label class="section-title">üè• 1. REGI√ìN *</label>
<div class="category-row" id="region-grid"></div>
<div id="unidad-section" class="hidden">
<label class="section-title">üè• 1.5. UNIDAD M√âDICA *</label>
<div class="category-row" id="unidad-grid"></div>
</div>
<label class="section-title">üìÇ 2. TIPO DE JORNADA *</label>
<div class="category-row" id="cat-grid">
<div class="card-btn" onclick="selectCat(this, 'escuela')">Ipasme va a la Escuela</div>
<div class="card-btn" onclick="selectCat(this, 'integral')">Jornada de Atenci√≥n M√©dica Integral</div>
<div class="card-btn" onclick="selectCat(this, 'conjunta')">Jornada Conjunta</div>
<div class="card-btn" onclick="selectCat(this, 'vacuna')">Plan Masivo de Vacunaci√≥n</div>
<div class="card-btn" onclick="selectCat(this, 'quirurgica')">Captaci√≥n Quir√∫rgica</div>
<div class="card-btn" onclick="selectCat(this, 'pediatrica')">Captaci√≥n Quir√∫rgica Pedi√°trica</div>
<div class="card-btn" onclick="selectCat(this, 'oftalmo')">Captaci√≥n Quir√∫rgica Oftalmol√≥gica</div>
<div class="card-btn" onclick="selectCat(this, 'otros')">Otros</div>
</div>
<div id="sec-3" class="hidden">
<label class="section-title" id="label-3">ü©∫ 3. DETALLE *</label>
<div id="cont-3" style="display: grid;
grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;"></div>
</div>
<div id="sec-4" class="hidden">
<label class="section-title">‚ú® 4. SERVICIOS ADICIONALES (OPCIONAL)</label>
<div id="cont-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
gap: 6px;"></div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="section-title">üìÖ 5. FECHA DE ACTIVIDAD *</label><input type="date" id="fecha" class="modern-input"></div>
<div><label class="section-title">‚è∞ 6. HORA DE INICIO *</label><div class="hora-container" id="hora-box" style="display: flex;
gap: 10px; align-items: center;"><input type="text" id="hora" class="modern-input" style="width:100px; text-align:center" placeholder="08:00"><button type="button" class="btn-time" id="btn-am" onclick="setAMPM('a. m.')">a. m.</button><button type="button" class="btn-time" id="btn-pm" onclick="setAMPM('p. m.')">p. m.</button></div></div>
</div>
<label class="section-title">üìç 7. UBICACI√ìN *</label>
<div style="background: #fff8e1;
border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600;
line-height: 1.4;">
‚ö†Ô∏è Complete al menos el nombre de la instituci√≥n. La direcci√≥n exacta es opcional pero recomendada.
</div>
<div style="display: grid;
grid-template-columns: 1fr 1fr; gap: 20px;">
<div>
<label class="txt-small">üè´ Instituci√≥n *</label>
<input type="text" id="institucion" class="modern-input" placeholder="Escuela, Liceo, Jard√≠n de ni√±os, etc.">
</div>
<div>
<label class="txt-small">üß≠ Direcci√≥n exacta</label>
<input type="text" id="direccion-exacta" class="modern-input" placeholder="Municipio, Parroquia, Ciudad, etc.">
</div>
</div>
<label class="section-title">üì±‚úâÔ∏è 8. DATOS DE CONTACTO</label>
<div style="display: grid;
grid-template-columns: 1fr 1fr; gap: 20px;">
<div><label class="txt-small">N√∫mero de Tel√©fono</label><input type="tel" id="tlf" class="modern-input" placeholder="04xx 1234567"></div>
<div><label class="txt-small">Correo Electr√≥nico *</label><input type="email" id="mail" class="modern-input" placeholder="Para env√≠o de arte final"></div>
</div>
<label class="section-title">‚úèÔ∏è 9. OBSERVACIONES / DETALLES DE DISE√ëO</label><textarea id="observaciones" class="modern-input" rows="3" placeholder="Indique medidas, colores institucionales o entes participantes adicionales..."></textarea>
<label class="section-title">üì∏ 10. SOPORTES FOTOGR√ÅFICOS (M√ÅX 3)</label>
<div style="background: #fff8e1;
border: 1px solid #ffe082; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.8rem; color: #5d4600; font-weight: 600;
line-height: 1.4;">
‚ö†Ô∏è Si el registro fotogr√°fico enviado no cumple con las condiciones de calidad para la solicitud, ser√° sustituido por material de archivo.
</div>
<div class="photo-grid">
<div class="upload-box"><label for="f1" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f1" class="hidden" accept="image/*" onchange="handleFile(this, 'p1', 'b1')"><img id="p1" class="preview"><button type="button" id="b1" class="remove-btn" onclick="clearFile('f1', 'p1', 'b1')">√ó</button></div>
<div class="upload-box"><label for="f2" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f2" class="hidden" accept="image/*" onchange="handleFile(this, 'p2', 'b2')"><img id="p2" class="preview"><button type="button" id="b2" class="remove-btn" onclick="clearFile('f2', 'p2', 'b2')">√ó</button></div>
<div class="upload-box"><label for="f3" class="upload-label">‚úö SUBIR FOTO</label><input type="file" id="f3" class="hidden" accept="image/*" onchange="handleFile(this, 'p3', 'b3')"><img id="p3" class="preview"><button type="button" id="b3" class="remove-btn" onclick="clearFile('f3', 'p3', 'b3')">√ó</button></div>
</div>
<button type="submit" id="submitBtn" class="btn-send">üöÄ ENVIAR SOLICITUD A COMUNICACIONES</button>
</form>
</div>
<div class="container page" id="list-page">
<!-- ‚úÖ CONTADORES COMBINADOS PARA ADMIN (ELIMINAR CONTADORES DE DISE√ëADORES) -->
<div class="combined-stats" id="combined-stats" style="display:none; margin-bottom: 10px; gap: 6px;">
<!-- Contadores generales SOLAMENTE -->
<div class="stat-card stat-mini st-total">
<span class="stat-label">Total</span>
<span id="count-total-admin" class="stat-val">0</span>
</div>
<div class="stat-card stat-mini st-pend">
<span class="stat-label">Pendiente</span>
<span id="count-pend-admin" class="stat-val">0</span>
</div>
<div class="stat-card stat-mini st-proc">
<span class="stat-label">En Proceso</span>
<span id="count-proc-admin" class="stat-val">0</span>
</div>
<div class="stat-card stat-mini st-fin">
<span class="stat-label">Finalizada</span>
<span id="count-fin-admin" class="stat-val">0</span>
</div>
</div>

<!-- ‚úÖ CONTADORES PARA USUARIOS REGULARES (SIN CAMBIOS) -->
<div class="stats-grid" id="stats-panel">
<div class="stat-card st-total"><span class="stat-label">Total</span><span id="count-total" class="stat-val">0</span></div>
<div class="stat-card st-pend"><span class="stat-label">Pendiente</span><span id="count-pend" class="stat-val">0</span></div>
<div class="stat-card st-proc"><span class="stat-label">En Proceso</span><span id="count-proc" class="stat-val">0</span></div>
<div class="stat-card st-fin"><span class="stat-label">Finalizada</span><span id="count-fin" class="stat-val">0</span></div>
</div>
<!-- ‚úÖ BUSCADOR DE ID PARA DISE√ëADOR -->
<div id="designer-search-container" class="hidden">
<div style="display: flex; align-items: center; gap: 10px;">
<span style="font-size: 1.2rem; color: #fb8500;">üîç</span>
<input 
type="text" 
id="searchIdInput" 
class="modern-input" 
placeholder="Buscar por ID de solicitud..."
style="background: white; border-color: #ffb703; font-weight: 600;"
>
</div>
<p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #5d4600; font-weight: 500;">
‚ö†Ô∏è Solo las solicitudes coincidentes estar√°n habilitadas para adjuntar archivos
</p>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>ID SOLICITUD</th>
<th>FECHA EVENTO</th>
<th>UNIDAD SOLICITANTE</th>
<th>TIPO DE JORNADA</th>
<th style="text-align:center">SOPORTES</th>
<th>ESTATUS</th>
<th id="th-admin" class="hidden" style="text-align:right">ACCIONES ADMIN</th>
<th id="th-designer" class="hidden" style="text-align:right">ACCIONES DISE√ëADOR</th>
</tr>
</thead>
<tbody id="solicitudes-body"></tbody>
</table>
<!-- ‚úÖ CONTROLES DE PAGINACI√ìN -->
<div id="paginationControls" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 0 0 12px 12px; margin-top: -1px;">
  <div style="font-size: 0.85rem; color: #6c757d;">
    Mostrando <strong id="paginationStart">1</strong>-<strong id="paginationEnd">50</strong> de <strong id="paginationTotal">0</strong> registros
  </div>
  <div style="display: flex; gap: 8px;">
    <button onclick="changePage('first')" id="btnFirstPage" class="btn-act bg-pend" style="padding: 6px 12px;" disabled>‚èÆÔ∏è Primero</button>
    <button onclick="changePage('prev')" id="btnPrevPage" class="btn-act bg-pend" style="padding: 6px 12px;" disabled>‚óÄÔ∏è Anterior</button>
    <span id="currentPageIndicator" style="padding: 6px 12px; background: var(--turquesa); color: white; border-radius: 6px; font-weight: 700; font-size: 0.85rem;">1 / 1</span>
    <button onclick="changePage('next')" id="btnNextPage" class="btn-act bg-proc" style="padding: 6px 12px;" disabled>Siguiente ‚ñ∂Ô∏è</button>
    <button onclick="changePage('last')" id="btnLastPage" class="btn-act bg-proc" style="padding: 6px 12px;" disabled>√öltimo ‚è≠Ô∏è</button>
  </div>
</div>
</div>
</div>

<!-- ‚úÖ P√ÅGINA DE ESTAD√çSTICAS (REESTRUCTURADA) -->
<div class="container page" id="stats-page">
    
    <!-- 1. CONTADORES GLOBALES FIJOS (ARRIBA DEL TODO) -->
    <div class="stats-grid" style="margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; border-radius: 20px; background: white;">
        <div class="stat-card st-total">
            <span class="stat-label">Total Solicitudes</span>
            <span id="stats-count-total" class="stat-val" style="font-size: 2rem;">0</span>
        </div>
        <div class="stat-card st-pend">
            <span class="stat-label">Pendientes</span>
            <span id="stats-count-pend" class="stat-val" style="font-size: 2rem;">0</span>
        </div>
        <div class="stat-card st-proc">
            <span class="stat-label">En Proceso</span>
            <span id="stats-count-proc" class="stat-val" style="font-size: 2rem;">0</span>
        </div>
        <div class="stat-card st-fin">
            <span class="stat-label">Finalizadas</span>
            <span id="stats-count-fin" class="stat-val" style="font-size: 2rem;">0</span>
        </div>
    </div>

    <!-- Selector de Per√≠odo -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
        <div style="font-weight: 800; color: var(--azul-deep); margin-right: 10px;">üìÖ Per√≠odo:</div>
        <button class="btn-time" onclick="loadStats('day')" id="btnStatsDay">D√≠a</button>
        <button class="btn-time" onclick="loadStats('week')" id="btnStatsWeek">Semana</button>
        <button class="btn-time active" onclick="loadStats('month')" id="btnStatsMonth">Mes</button>
        <button class="quota-refresh-btn" onclick="refreshAllStats()" id="btnRefreshStats" style="margin-left: auto;">
            <span>üîÑ</span> Actualizar
        </button>
    </div>

    <!-- ‚úÖ MEDIDORES DE VELOCIDAD (NUEVO) -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <!-- Velocidad de Internet -->
        <div class="quota-gauge-card">
            <div class="quota-gauge-header">
                <div class="quota-gauge-title">
                    <span>üåê</span>
                    <span>Velocidad de Internet</span>
                </div>
                <div class="quota-gauge-status status-good" data-stat="internet-status">EXCELENTE</div>
            </div>
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 3rem; font-weight: 800; color: var(--azul-deep);" 
                     data-stat="internet-speed-value">0</div>
                <div style="color: #666; font-size: 1rem;">Mbps</div>
            </div>
            <div class="quota-gauge-details">
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="internet-speed-avg">0</div>
                    <div class="quota-detail-label">Promedio</div>
                </div>
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="internet-speed-max">0</div>
                    <div class="quota-detail-label">M√°ximo</div>
                </div>
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="internet-speed-last">--:--</div>
                    <div class="quota-detail-label">√öltima Medici√≥n</div>
                </div>
            </div>
        </div>
        
        <!-- Velocidad de Subida (Chunks) -->
        <div class="quota-gauge-card">
            <div class="quota-gauge-header">
                <div class="quota-gauge-title">
                    <span>üì§</span>
                    <span>Velocidad de Subida (Chunks)</span>
                </div>
                <div class="quota-gauge-status status-good" data-stat="upload-status">EXCELENTE</div>
            </div>
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 3rem; font-weight: 800; color: var(--azul-deep);" 
                     data-stat="upload-speed-value">0</div>
                <div style="color: #666; font-size: 1rem;">Mbps</div>
            </div>
            <div class="quota-gauge-details">
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="upload-speed-avg">0</div>
                    <div class="quota-detail-label">Promedio</div>
                </div>
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="upload-speed-tier">--</div>
                    <div class="quota-detail-label">Nivel</div>
                </div>
                <div class="quota-detail-item">
                    <div class="quota-detail-value" data-stat="upload-speed-last">--:--</div>
                    <div class="quota-detail-label">√öltima Medici√≥n</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos Principales (Fila 1) -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <!-- Solicitudes por D√≠a -->
        <div class="quota-timeline-container">
            <div class="quota-timeline-header">
                <div class="quota-timeline-title"><span>üìà</span> Solicitudes Recibidas</div>
            </div>
            <div class="quota-chart-container" style="height: 250px;">
                <canvas id="requestsChart"></canvas>
            </div>
        </div>
        <!-- Finalizadas vs Recibidas -->
        <div class="quota-timeline-container">
            <div class="quota-timeline-header">
                <div class="quota-timeline-title"><span>‚úÖ</span> Solicitudes Finalizadas</div>
            </div>
            <div class="quota-chart-container" style="height: 250px;">
                <canvas id="finalizedChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Rendimiento de Dise√±adores (Gr√°fico Circular) -->
    <div class="quota-timeline-container" style="margin-bottom: 20px;">
        <div class="quota-timeline-header">
            <div class="quota-timeline-title"><span>üé®</span> Rendimiento de Dise√±adores</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center;">
            <div class="quota-chart-container" style="height: 300px;">
                <canvas id="designerPerformanceChart"></canvas>
            </div>
            <!-- Tarjetas de Dise√±adores (Formato Did√°ctico) -->
            <div class="designer-performance-cards-container" id="designerPerformanceCards"></div>
        </div>
    </div>

    <!-- 2. ESTAD√çSTICAS DETALLADAS (NUEVO DISE√ëO DE TARJETAS) -->
    <div class="quota-timeline-container">
        <div class="quota-timeline-header">
            <div class="quota-timeline-title"><span>üìã</span> Estad√≠sticas Detalladas</div>
        </div>
        
        <!-- Grid de Tarjetas Estilo Dashboard -->
        <div class="stats-dashboard-grid">
            
            <!-- Tarjeta 1: Top Unidades -->
            <div class="stat-dashboard-card stat-card-unidades">
                <div class="stat-card-icon">üè•</div>
                <div class="stat-card-title">Top Unidades</div>
                <ul class="stat-card-list" id="topUnidadesStats">
                    <!-- Se llena con JS -->
                    <li class="stat-card-item"><span class="stat-card-label">Cargando...</span></li>
                </ul>
            </div>

            <!-- Tarjeta 2: Top Jornadas -->
            <div class="stat-dashboard-card stat-card-jornadas">
                <div class="stat-card-icon">üìÇ</div>
                <div class="stat-card-title">Top Jornadas</div>
                <ul class="stat-card-list" id="topJornadasStats">
                    <!-- Se llena con JS -->
                    <li class="stat-card-item"><span class="stat-card-label">Cargando...</span></li>
                </ul>
            </div>

            <!-- Tarjeta 3: Top Especialidades -->
            <div class="stat-dashboard-card stat-card-especialidades">
                <div class="stat-card-icon">ü©∫</div>
                <div class="stat-card-title">Top Especialidades</div>
                <ul class="stat-card-list" id="topEspecialidadesStats">
                    <!-- Se llena con JS -->
                    <li class="stat-card-item"><span class="stat-card-label">Cargando...</span></li>
                </ul>
            </div>

            <!-- Tarjeta 4: Top Servicios -->
            <div class="stat-dashboard-card stat-card-servicios">
                <div class="stat-card-icon">üîß</div>
                <div class="stat-card-title">Top Servicios</div>
                <ul class="stat-card-list" id="topServiciosStats">
                    <!-- Se llena con JS -->
                    <li class="stat-card-item"><span class="stat-card-label">Cargando...</span></li>
                </ul>
            </div>

        </div>
    </div>

    <!-- 3. ELIMINADO: Solicitudes Finalizadas por Dise√±ador (Ya no existe en el HTML) -->

</div>

<script>
// === CONFIGURACI√ìN DE SCRIPT URL ===
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw4oGU8GLqut_CQTWIdkArjakKsuRAZLVF9xI4YhO-pYV0XYvMp-BXoE4arULToavgaw/exec";

// === AGREGAR ESTO ===
const BATCH_QUEUE = {
  requests: [],
  timeout: null,
  delay: 100 // ms para agrupar requests
};

async function batchRequest(action, params) {
  return new Promise((resolve, reject) => {
    BATCH_QUEUE.requests.push({ action, params, resolve, reject });
    
    if (BATCH_QUEUE.timeout) {
      clearTimeout(BATCH_QUEUE.timeout);
    }
    
    BATCH_QUEUE.timeout = setTimeout(async () => {
      const batch = BATCH_QUEUE.requests.splice(0);
      BATCH_QUEUE.requests = [];
      
      try {
        // ‚úÖ PROCESAR EN PARALELO (m√°ximo 3 simult√°neos)
        const results = await Promise.allSettled(
          batch.map(async (req) => {
            const params = new URLSearchParams();
            params.append("action", req.action);
            Object.keys(req.params).forEach(key => {
              params.append(key, req.params[key]);
            });
            
            const res = await fetch(SCRIPT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: params.toString()
            });
            return await res.json();
          })
        );
        
        // ‚úÖ RESOLVER CADA PROMESA INDIVIDUAL
        results.forEach((result, index) => {
          if (result.status === 'fulfilled') {
            batch[index].resolve(result.value);
          } else {
            batch[index].reject(result.reason);
          }
        });
      } catch (e) {
        batch.forEach(req => req.reject(e));
      }
    }, BATCH_QUEUE.delay);
  });
}

// ‚úÖ VARIABLES GLOBALES DEL PANEL
let selectedRequestId = null;
let selectedRequestData = null;
let isPanelOpen = false;

// ‚úÖ POLLING PARA SINCRONIZACI√ìN EN TIEMPO REAL
let panelSyncInterval = null;

// ‚úÖ VARIABLES PARA SISTEMA DE CHUNKS MEJORADO
let chunkUpload = {
    // Estado
    isActive: false,
    isPaused: false,
    isCancelled: false,
    
    // Archivo y chunks
    currentFile: null,
    fileSize: 0,
    fileName: '',
    mimeType: '',
    chunks: [],
    totalChunks: 0,
    uploadedChunks: 0,
    currentChunkIndex: 0,
    
    // Configuraci√≥n din√°mica
    currentChunkSize: 512 * 1024,  // Tama√±o inicial (se ajusta din√°micamente)
    maxConcurrent: 1,
    connectionTier: 'unknown',
    
    // Medici√≥n de velocidad en tiempo real
    startTime: null,
    lastUpdateTime: null,
    totalBytesUploaded: 0,
    
    // Historial de velocidades para promedio m√≥vil
    speedHistory: [],
    currentSpeed: 0,        // Velocidad instant√°nea (KB/s)
    averageSpeed: 0,        // Velocidad promedio (KB/s)
    smoothedSpeed: 0,       // Velocidad suavizada (KB/s)
    
    // Progreso granular (bytes reales, no chunks)
    bytesUploadedCurrentChunk: 0,
    totalBytesCommitted: 0,  // Bytes confirmados como subidos
    
    // Reintentos
    retryCount: 0,
    maxRetries: 3,
    chunkRetries: {},  // Track de reintentos por chunk
    
    // Temporizadores
    progressTimer: null,
    speedUpdateTimer: null,
    
    // Token de cancelaci√≥n
    abortController: null,
    
    // Variables legacy para compatibilidad
    pauseRequested: false,
    resumeToken: null,
    currentChunkStartTime: null,
    currentChunkEndTime: null,
    uploadSpeeds: [],
    avgUploadSpeed: 0,
    currentUploadSpeed: 0,
    connectionSpeed: 'unknown',
    chunkSize: 512 * 1024,
    currentChunk: 0
};

// ‚úÖ VARIABLES PARA MEDIDORES DE VELOCIDAD
let speedMonitoring = {
    internetSpeed: {
        current: 0,
        average: 0,
        maximum: 0,
        history: [],
        lastMeasurement: null
    },
    uploadSpeed: {  // ‚úÖ CAMBIADO: Ahora mide velocidad de subida real para chunks
        current: 0,
        average: 0,
        minimum: 9999,
        history: [],
        lastMeasurement: null,
        tier: 'unknown',  // ULTRA_FAST, FAST, MEDIUM, SLOW, VERY_SLOW
        chunkSize: 512 * 1024  // Tama√±o de chunk recomendado
    },
    intervalId: null,
    measurementInterval: 5 * 60 * 1000 // 5 minutos
};

// ‚úÖ CONFIGURACI√ìN AVANZADA DE CHUNKS CON ADAPTACI√ìN DIN√ÅMICA
const CHUNK_CONFIG = {
    // Umbrales de velocidad en KB/s (medidos emp√≠ricamente)
    THRESHOLDS: {
        ULTRA_FAST: 2048,    // > 2 MB/s - Subida completa
        FAST: 512,           // 512 KB/s - 1 MB - 2 MB chunks
        MEDIUM: 128,         // 128-512 KB/s - 512 KB chunks
        SLOW: 32,            // 32-128 KB/s - 256 KB chunks
        VERY_SLOW: 0         // < 32 KB/s - 128 KB chunks
    },
    
    // Tama√±os de chunks seg√∫n velocidad
    SIZES: {
        ULTRA_FAST: Infinity, // No usar chunks
        FAST: 2 * 1024 * 1024,      // 2 MB
        MEDIUM: 512 * 1024,         // 512 KB
        SLOW: 256 * 1024,           // 256 KB
        VERY_SLOW: 128 * 1024       // 128 KB
    },
    
    // Configuraciones de concurrencia
    CONCURRENT: {
        ULTRA_FAST: 1,  // Secuencial (conexi√≥n r√°pida no necesita paralelismo)
        FAST: 2,        // 2 conexiones paralelas
        MEDIUM: 1,      // 1 conexi√≥n (estable)
        SLOW: 1,        // 1 conexi√≥n (evitar saturaci√≥n)
        VERY_SLOW: 1    // 1 conexi√≥n (m√°xima estabilidad)
    },
    
    // Intervalos de actualizaci√≥n de UI (ms)
    UPDATE_INTERVAL: 100,  // Actualizar cada 100ms para fluidez
    
    // Muestras para promedio m√≥vil
    SPEED_SAMPLES: 5,  // Usar √∫ltimas 5 mediciones para promedio
    
    // Configuraci√≥n legacy para compatibilidad
    fast: { size: 1024 * 1024, concurrent: 3 },    // 1MB (no se usa - conexiones r√°pidas suben completo)
    medium: { size: 512 * 1024, concurrent: 2 },   //512KB para conexiones medias
    'slow-medium': { size: 256 * 1024, concurrent: 1 }, // 256KB para conexiones lentas-medias
    slow: { size: 256 * 1024, concurrent: 1 }      // 256KB para conexiones lentas
};

// ============================================================
// FUNCI√ìN CORREGIDA: DETECCI√ìN REAL DE VELOCIDAD
// ============================================================
async function detectConnectionSpeed() {
    console.log("üîç Iniciando detecci√≥n de velocidad de conexi√≥n...");
    
    // ‚úÖ ARCHIVOS DE PRUEBA M√ÅS GRANDES (10MB y 50MB)
    const testSizes = [
        { size: 10 * 1024 * 1024, name: "10MB" },   // 10 MB
        { size: 50 * 1024 * 1024, name: "50MB" }    // 50 MB para conexiones >100Mbps
    ];
    
    const speeds = [];
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw4oGU8GLqut_CQTWIdkArjakKsuRAZLVF9xI4YhO-pYV0XYvMp-BXoE4arULToavgaw/exec";
    
    for (let test of testSizes) {
        try {
            // Crear blob de datos aleatorios del tama√±o especificado
            const testData = new Uint8Array(test.size);
            const chunk = 65536; // 64KB chunks para mejor performance
            
            for (let i = 0; i < test.size; i += chunk) {
                const end = Math.min(i + chunk, test.size);
                for (let j = i; j < end; j++) {
                    testData[j] = Math.floor(Math.random() * 256);
                }
            }
            
            const blob = new Blob([testData]);
            const formData = new FormData();
            formData.append('speedTest', blob);
            formData.append('action', 'speedTest');
            formData.append('timestamp', Date.now().toString());
            formData.append('size', test.size.toString());
            
            const startTime = performance.now();
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos max
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData,
                signal: controller.signal,
                cache: 'no-store'
            });
            
            clearTimeout(timeoutId);
            
            const endTime = performance.now();
            const duration = (endTime - startTime) / 1000; // segundos
            
            // ‚úÖ C√ÅLCULO CORREGIDO: bits por segundo, no bytes
            const bitsUploaded = test.size * 8;
            const speedBps = bitsUploaded / duration;
            const speedMbps = speedBps / (1024 * 1024); // Convertir a Mbps
            
            // Solo usar mediciones v√°lidas (>0.1s para evitar precisi√≥n insuficiente)
            if (duration > 0.1) {
                speeds.push(speedMbps);
                console.log(`üìä Prueba ${test.name}: ${speedMbps.toFixed(2)} Mbps (${duration.toFixed(2)}s)`);
            }
            
        } catch (e) {
            console.warn(`‚ö†Ô∏è Prueba ${test.name} fallida: ${e.message}`);
        }
    }
    
    // Calcular velocidad final
    let finalSpeed = 0;
    if (speeds.length > 0) {
        // Usar la mediana para evitar outliers
        speeds.sort((a, b) => a - b);
        finalSpeed = speeds[Math.floor(speeds.length / 2)];
    } else {
        // Fallback: estimar basado en Network Information API
        finalSpeed = estimateSpeedFromNetworkAPI();
    }
    
    // Determinar tier y configuraci√≥n
    const config = getSpeedConfig(finalSpeed);
    
    console.log(`üåê Velocidad detectada: ${finalSpeed.toFixed(2)} Mbps`);
    console.log(`üè∑Ô∏è Tier: ${config.tier} | Chunk: ${config.chunkSize === Infinity ? 'Completo' : (config.chunkSize/1024/1024).toFixed(1) + 'MB'}`);
    
    return {
        speed: finalSpeed,
        tier: config.tier,
        chunkSize: config.chunkSize,
        concurrent: config.concurrent,
        shouldUseChunks: config.chunkSize !== Infinity
    };
}

// ============================================================
// FUNCI√ìN AUXILIAR: Estimaci√≥n desde Network API
// ============================================================
function estimateSpeedFromNetworkAPI() {
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    
    if (connection) {
        // downlink est√° en Mbps seg√∫n la especificaci√≥n
        if (connection.downlink) {
            console.log(`üì° Network API estima: ${connection.downlink} Mbps`);
            return connection.downlink;
        }
        
        // Fallback por effectiveType
        const estimates = {
            '4g': 50,    // 4G t√≠pico: 5-100 Mbps
            '3g': 3,     // 3G t√≠pico: 0.5-5 Mbps
            '2g': 0.1    // 2G t√≠pico: <0.1 Mbps
        };
        
        if (estimates[connection.effectiveType]) {
            return estimates[connection.effectiveType];
        }
    }
    
    return 10; // Default conservador: 10 Mbps
}

// ============================================================
// FUNCI√ìN AUXILIAR: Configuraci√≥n basada en velocidad
// ============================================================
function getSpeedConfig(speedMbps) {
    // ‚úÖ UMBRALES REALISTAS para 2024-2025
    if (speedMbps >= 100) {
        return {
            tier: 'ULTRA_FAST',
            chunkSize: Infinity,        // No usar chunks
            concurrent: 1,
            description: 'Fibra √≥ptica / 5G'
        };
    } else if (speedMbps >= 20) {
        return {
            tier: 'FAST',
            chunkSize: 10 * 1024 * 1024,  // 10 MB chunks
            concurrent: 2,
            description: 'Cable / 4G+'
        };
    } else if (speedMbps >= 5) {
        return {
            tier: 'MEDIUM',
            chunkSize: 5 * 1024 * 1024,   // 5 MB chunks
            concurrent: 1,
            description: 'ADSL / 4G'
        };
    } else if (speedMbps >= 1) {
        return {
            tier: 'SLOW',
            chunkSize: 2 * 1024 * 1024,   // 2 MB chunks
            concurrent: 1,
            description: '3G / Conexi√≥n d√©bil'
        };
    } else {
        return {
            tier: 'VERY_SLOW',
            chunkSize: 512 * 1024,        // 512 KB chunks
            concurrent: 1,
            description: '2G / Muy lenta'
        };
    }
}

// ‚úÖ REINICIAR ESTADO DE CHUNKS
function resetChunkUploadState() {
    chunkUpload.isActive = false;
    chunkUpload.currentFile = null;
    chunkUpload.chunks = [];
    chunkUpload.currentChunk = 0;
    chunkUpload.totalChunks = 0;
    chunkUpload.uploadedChunks = 0;
    chunkUpload.pauseRequested = false;
    chunkUpload.startTime = null;
    chunkUpload.retryCount = 0;
    chunkUpload.resumeToken = null;
    
    // ‚úÖ RESET VARIABLES DE VELOCIDAD
    chunkUpload.currentChunkStartTime = null;
    chunkUpload.currentChunkEndTime = null;
    chunkUpload.uploadSpeeds = [];
    chunkUpload.avgUploadSpeed = 0;
    chunkUpload.currentUploadSpeed = 0;
    
    // ‚úÖ LIMPIAR DISPLAY DE VELOCIDAD
    const speedElement = document.getElementById('progressUploadSpeed');
    if (speedElement) {
        speedElement.innerText = 'üì§ Velocidad: Calculando...';
    }
    
    // ‚úÖ Limpiar timer si existe
    if (window.confirmTimer) {
        clearInterval(window.confirmTimer);
        window.confirmTimer = null;
    }
    
    console.log("üîÑ Estado de chunks reiniciado");
}

// ============================================================
// FUNCI√ìN 2: DIVISI√ìN INTELIGENTE DE ARCHIVO EN CHUNKS
// ============================================================

function splitFileIntoChunks(file) {
    const chunks = [];
    const fileSize = file.size;
    
    // Si la conexi√≥n es ultra-r√°pida y el archivo es menor a 6MB, no usar chunks
    if (chunkUpload.connectionTier === 'ULTRA_FAST' && fileSize <= 6 * 1024 * 1024) {
        console.log("üöÄ Conexi√≥n ultra-r√°pida detectada, subiendo archivo completo");
        return [{
            index: 0,
            blob: file,
            size: fileSize,
            total: 1,
            fileId: file.name + '_' + Date.now(),
            startByte: 0,
            endByte: fileSize
        }];
    }
    
    // Para archivos muy peque√±os (< 256KB), subir completo siempre
    if (fileSize <= 256 * 1024) {
        chunkUpload.currentChunkSize = fileSize;
        return [{
            index: 0,
            blob: file,
            size: fileSize,
            total: 1,
            fileId: file.name + '_' + Date.now(),
            startByte: 0,
            endByte: fileSize
        }];
    }
    
    // Ajustar tama√±o de chunk si el archivo es muy grande
    let chunkSize = chunkUpload.currentChunkSize;
    const maxChunks = 50; // Evitar demasiados chunks
    
    if (fileSize / chunkSize > maxChunks) {
        chunkSize = Math.ceil(fileSize / maxChunks);
        // Redondear a m√∫ltiplo de 64KB para eficiencia
        chunkSize = Math.ceil(chunkSize / (64 * 1024)) * (64 * 1024);
        chunkUpload.currentChunkSize = chunkSize;
    }
    
    const totalChunks = Math.ceil(fileSize / chunkSize);
    const fileId = file.name + '_' + Date.now();
    
    for (let i = 0; i < totalChunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(start + chunkSize, fileSize);
        
        chunks.push({
            index: i,
            blob: file.slice(start, end),
            size: end - start,
            total: totalChunks,
            fileId: fileId,
            startByte: start,
            endByte: end
        });
    }
    
    console.log(`üì¶ Archivo dividido en ${totalChunks} chunks de ~${(chunkSize/1024).toFixed(0)}KB cada uno`);
    return chunks;
}

// ============================================================
// FUNCI√ìN 3: ACTUALIZACI√ìN DE VELOCIDAD EN TIEMPO REAL
// ============================================================

function updateSpeedMetrics(bytesUploaded, isComplete = false) {
    const now = performance.now();
    
    if (!chunkUpload.lastUpdateTime) {
        chunkUpload.lastUpdateTime = now;
        return;
    }
    
    const timeDelta = (now - chunkUpload.lastUpdateTime) / 1000; // segundos
    
    if (timeDelta > 0) {
        // Velocidad instant√°nea (KB/s)
        const instantSpeed = (bytesUploaded / 1024) / timeDelta;
        
        // Actualizar historial (promedio m√≥vil)
        chunkUpload.speedHistory.push(instantSpeed);
        if (chunkUpload.speedHistory.length > CHUNK_CONFIG.SPEED_SAMPLES) {
            chunkUpload.speedHistory.shift();
        }
        
        // Calcular promedio
        chunkUpload.averageSpeed = chunkUpload.speedHistory.reduce((a, b) => a + b, 0) 
                                   / chunkUpload.speedHistory.length;
        
        // Suavizado exponencial para evitar fluctuaciones bruscas
        const alpha = 0.3; // Factor de suavizado
        chunkUpload.smoothedSpeed = (alpha * instantSpeed) + 
                                    ((1 - alpha) * (chunkUpload.smoothedSpeed || instantSpeed));
        
        chunkUpload.currentSpeed = instantSpeed;
        chunkUpload.lastUpdateTime = now;
        
        // Actualizar UI
        updateSpeedDisplay();
    }
}

function updateSpeedDisplay() {
    const speedElement = document.getElementById('progressUploadSpeed');
    const etaElement = document.getElementById('progressETA');
    
    if (!speedElement) return;
    
    // Formatear velocidad
    let speedText, unit;
    const speed = chunkUpload.smoothedSpeed || chunkUpload.averageSpeed || 0;
    
    if (speed >= 1024) {
        speedText = (speed / 1024).toFixed(2);
        unit = 'MB/s';
    } else {
        speedText = speed.toFixed(1);
        unit = 'KB/s';
    }
    
    // Calcular Mbps (megabits por segundo)
    const mbps = (speed * 8 / 1024).toFixed(1);
    
    // Determinar emoji seg√∫n velocidad
    let emoji = 'üêå';
    if (speed >= 1024) emoji = 'üöÄ';
    else if (speed >= 512) emoji = '‚ö°';
    else if (speed >= 128) emoji = 'üì∂';
    else if (speed >= 32) emoji = 'üê¢';
    
    speedElement.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
            <span style="font-size: 1.2rem;">${emoji}</span>
            <div>
                <div style="font-weight: 800; color: var(--turquesa); font-size: 1.1rem;">
                    ${speedText} ${unit}
                </div>
                <div style="font-size: 0.75rem; color: #666;">
                    ${mbps} Mbps | ${chunkUpload.connectionTier.replace('_', ' ')}
                </div>
            </div>
        </div>
    `;
    
    // Calcular ETA
    if (etaElement && speed > 0) {
        const remainingBytes = chunkUpload.fileSize - chunkUpload.totalBytesCommitted;
        const remainingKB = remainingBytes / 1024;
        const etaSeconds = Math.ceil(remainingKB / speed);
        
        let etaText;
        if (etaSeconds < 60) {
            etaText = `${etaSeconds}s`;
        } else if (etaSeconds < 3600) {
            etaText = `${Math.floor(etaSeconds / 60)}m ${etaSeconds % 60}s`;
        } else {
            etaText = `${Math.floor(etaSeconds / 3600)}h ${Math.floor((etaSeconds % 3600) / 60)}m`;
        }
        
        etaElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 6px; justify-content: center; margin-top: 8px;">
                <span>‚è±Ô∏è</span>
                <span style="font-weight: 600;">Tiempo restante: ~${etaText}</span>
                <span style="font-size: 0.75rem; color: #888;">
                    (${((chunkUpload.totalBytesCommitted / chunkUpload.fileSize) * 100).toFixed(1)}%)
                </span>
            </div>
        `;
    }
}

// ============================================================
// FUNCI√ìN 4: SUBIR CHUNK INDIVIDUAL CON MEDICI√ìN REAL
// ============================================================

async function uploadSingleChunkWithProgress(id, filename, mimeType, chunk) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const base64 = e.target.result.split(',')[1];
                const chunkSizeKB = chunk.size / 1024;
                
                // Preparar datos
                const params = new URLSearchParams();
                params.append("action", "uploadChunk");
                params.append("id", id);
                params.append("filename", filename);
                params.append("mime", mimeType);
                params.append("chunkIndex", chunk.index);
                params.append("chunkData", base64);
                params.append("totalChunks", chunk.total);
                params.append("fileId", chunk.fileId);
                params.append("uploadedBy", userCredentials.displayName);
                params.append("startByte", chunk.startByte);
                params.append("endByte", chunk.endByte);
                
                // Crear XMLHttpRequest para tracking de progreso real
                const xhr = new XMLHttpRequest();
                const startTime = performance.now();
                
                // Configurar tracking de progreso
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        // Bytes reales subidos de este chunk
                        const bytesUploaded = event.loaded;
                        chunkUpload.bytesUploadedCurrentChunk = bytesUploaded;
                        
                        // Actualizar m√©tricas en tiempo real
                        const totalUploaded = chunkUpload.totalBytesCommitted + bytesUploaded;
                        updateSpeedMetrics(bytesUploaded);
                        
                        // Actualizar progreso granular
                        updateGranularProgress(totalUploaded);
                    }
                };
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const endTime = performance.now();
                        const duration = (endTime - startTime) / 1000;
                        const actualSpeed = chunkSizeKB / duration;
                        
                        console.log(`‚úÖ Chunk ${chunk.index + 1}/${chunk.total} completado en ${duration.toFixed(2)}s (${actualSpeed.toFixed(2)} KB/s)`);
                        
                        // Confirmar bytes subidos
                        chunkUpload.totalBytesCommitted += chunk.size;
                        chunkUpload.bytesUploadedCurrentChunk = 0;
                        
                        // Actualizar velocidad final del chunk
                        updateSpeedMetrics(chunk.size, true);
                        
                        resolve(xhr.response);
                    } else {
                        reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                    }
                };
                
                xhr.onerror = () => reject(new Error("Error de red"));
                xhr.ontimeout = () => reject(new Error("Timeout"));
                
                // Enviar
                xhr.open('POST', SCRIPT_URL, true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.send(params.toString());
                
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo chunk"));
        reader.readAsDataURL(chunk.blob);
    });
}

// ============================================================
// FUNCI√ìN 5: ACTUALIZACI√ìN DE PROGRESO GRANULAR
// ============================================================

function updateGranularProgress(bytesUploaded) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
    
    if (!progressBar || !progressPercent) return;
    
    const percentage = Math.min(100, (bytesUploaded / chunkUpload.fileSize) * 100);
    
    progressBar.style.width = percentage + '%';
    progressPercent.innerText = percentage.toFixed(1) + '%';
    
    // Actualizar texto de estado
    if (progressStatus) {
        const chunkInfo = chunkUpload.totalChunks > 1 
            ? ` (Chunk ${chunkUpload.currentChunkIndex + 1}/${chunkUpload.totalChunks})`
            : '';
        progressStatus.innerText = `üì§ Subiendo${chunkInfo}...`;
    }
}


const UNIDADES_IPASME_RAW = {
"Capital": [
"Don Sim√≥n Rodr√≠guez",
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende"
],
"Regi√≥n Central": [
"Maracay", "La Victoria", "Valencia", "Puerto Cabello",
"Club Villas Ipasmar", "Guatire", "Ocumare del Tuy", "Caucagua",
"Carrizal", "La Guaira"
],
"Regi√≥n Occidental": [
"Cabimas", "Maracaibo", "Machiques", "San Carlos del Zulia",
"El Moj√°n", "Barquisimeto", "El Tocuyo", "Carora",
"San Felipe", "Nirgua", "Punto Fijo", "Coro",
"Buchivacoa", "Puerto Cumarebo"
],
"Regi√≥n Los Andes": [
"El Vig√≠a", "M√©rida", "Tovar",
"Hotel Valle Grande", "La Grita", "Rubio",
"San Crist√≥bal", "San Juan de Col√≥n", "Ure√±a",
"Bocon√≥", "Trujillo", "Valera"
],
"Regi√≥n Oriental": [
"Anaco", "Barcelona", "Cantaura", "El Tigre",
"Isidora Agnes, Ciudad Bol√≠var", "Guasipati",
"Profa. Mirelva Mart√≠nez, San F√©lix", "Upata", "Matur√≠n",
"Punta de Mata", "Cuman√°", "Cumanacoa", "Car√∫pano",
"G√ºiria", "Tucupita", "Casacoima", "La Asunci√≥n",
"Puerto Ayacucho"
],
"Regi√≥n Los Llanos": [
"Altagracia de Orituco", "Calabozo", "San Juan de los Morros",
"Valle de la Pascua", "Zaraza", "San Carlos de Cojedes",
"Tinaquillo", "San Fernando de Apure", "Guasdualito",
"Barinas", "Santa B√°rbara de Barinas", "Acarigua", "Guanare"
]
};

const ORDEN_REGIONES = [
"Capital",
"Regi√≥n Central",
"Regi√≥n Occidental",
"Regi√≥n Los Andes",
"Regi√≥n Oriental",
"Regi√≥n Los Llanos"
];

function getNombreRegionLimpio(regionKey) {
if (regionKey === "Capital") return "Capital";
return regionKey.replace("Regi√≥n ", "");
}

const UNIDADES_IPASME = {};
ORDEN_REGIONES.forEach(region => {
const unidadesOriginales = UNIDADES_IPASME_RAW[region] || [];
UNIDADES_IPASME[region] = [...unidadesOriginales].sort((a, b) =>
a.trim().localeCompare(b.trim(), 'es', { sensitivity: 'base' })
);
});

// ‚úÖ VARIABLES GLOBALES PARA ROLES
let isLoggingIn = false;
let isAdmin = false;
let isDesigner = false;
let selectedAMPM = "";
let catType = "";
let catName = "";
let localData = [];
let isMaintActive = false;
let selectedRegionKey = "";
let selectedUnidad = "";
let modoObituario = false;

// ‚úÖ ACTUALIZAR DATA_CACHE PARA INCLUIR NUEVAS ESTAD√çSTICAS
const DATA_CACHE = {
    data: null,
    timestamp: 0,
    serverTimestamp: 0, // ‚úÖ Timestamp del servidor para invalidaci√≥n
    ttl: 60000, // CAMBIADO: de 5000 a 60000 (60 segundos)
    isLoading: false,
    pendingPromise: null,
    stats: null,
    statsPeriod: 'month'
};

// === AGREGAR ESTO ===
const PAGINATION = {
  currentPage: 1,
  limit: 40,
  totalPages: 1,
  totalRecords: 0,
  isLoading: false
};


let DATA_INDEX = {
    byId: new Map(),
    byStatus: new Map(),
    byDesigner: new Map()
};

// ‚úÖ ACTUALIZAR TABLA CON INVALIDACI√ìN DE CACH√â CORRECTA
async function updateTable(forceRefresh = false) {
  const now = Date.now();
  
  // ‚úÖ CORRECCI√ìN: Guardar y comparar serverTimestamp correctamente
  const serverCacheTimestamp = parseInt(DATA_CACHE.serverTimestamp || "0");
  
  if (serverCacheTimestamp > DATA_CACHE.timestamp) {
    forceRefresh = true;
    console.log("üîÑ Cach√© del servidor actualizada, refrescando datos...");
  }
  
  if (!forceRefresh && DATA_CACHE.data && (now - DATA_CACHE.timestamp) < DATA_CACHE.ttl) {
    localData = DATA_CACHE.data;
    if(DATA_CACHE.stats) updateCounters(DATA_CACHE.stats);
    renderLocalTable();
    updatePaginationControls();
    return;
  }
  
  if (DATA_CACHE.isLoading) {
    await DATA_CACHE.pendingPromise;
    return;
  }
  
  DATA_CACHE.isLoading = true;
  DATA_CACHE.pendingPromise = fetchTableData();
  
  try {
    const result = await DATA_CACHE.pendingPromise;
    DATA_CACHE.data = result.rows;
    DATA_CACHE.stats = result.stats;
    DATA_CACHE.serverTimestamp = result.cacheTimestamp || now; // ‚úÖ GUARDAR CORRECTAMENTE
    DATA_CACHE.timestamp = now;
    localData = result.rows;
    buildDataIndexes();
    
    if (result.stats) {
      updateCounters(result.stats);
    }
    renderLocalTable();
    updatePaginationControls();
  } catch (e) {
    console.error("Error cargando tabla:", e);
  } finally {
    DATA_CACHE.isLoading = false;
    DATA_CACHE.pendingPromise = null;
  }
}


// ‚úÖ FUNCI√ìN PARA MANTENER EL √çNDICE DE DATOS ACTUALIZADO
function maintainDataIndex() {
    // Limpiar √≠ndices existentes
    DATA_INDEX.byId.clear();
    DATA_INDEX.byStatus.clear();
    DATA_INDEX.byDesigner.clear();
    
    console.log('üîÑ Reconstruyendo √≠ndices con', localData.length, 'registros');
    
    // Reconstruir √≠ndices con los datos actuales
    localData.forEach((item, index) => {
        // √çndice por ID (para b√∫squeda r√°pida)
        if (item.id) {
            const idKey = String(item.id).toUpperCase().trim();
            DATA_INDEX.byId.set(idKey, {
                item: item,
                index: index
            });
        } else {
            console.warn('‚ö†Ô∏è Item sin ID:', item);
        }
        
        // √çndice por estado
        const status = item.Estatus ? item.Estatus.toUpperCase().trim() : '';
        if (status) {
            if (!DATA_INDEX.byStatus.has(status)) {
                DATA_INDEX.byStatus.set(status, []);
            }
            DATA_INDEX.byStatus.get(status).push({ item, index });
        }
        
        // √çndice por dise√±ador
        const designer = item.Disenador ? item.Disenador.trim() : '';
        if (designer) {
            if (!DATA_INDEX.byDesigner.has(designer)) {
                DATA_INDEX.byDesigner.set(designer, []);
            }
            DATA_INDEX.byDesigner.get(designer).push({ item, index });
        }
    });
    
    console.log('‚úÖ √çndice reconstruido:', {
        totalEntries: DATA_INDEX.byId.size,
        primerosIDs: Array.from(DATA_INDEX.byId.keys()).slice(0, 5)
    });
}

// ‚úÖ FUNCI√ìN PARA CONSTRUIR √çNDICES DE DATOS
function buildDataIndexes() {
    maintainDataIndex();
}


// ‚úÖ ACTUALIZAR VARIABLE GLOBAL DE DISE√ëADORES (5 DISE√ëADORES)
const designerColors = {
"Bermina": "#fb8500",
"Jorsy": "#023047",
"Mar√≠a F.": "#2d6a4f",
"Xamir": "#ffb703",
"Fulan@": "#9d0208"  // ‚úÖ NUEVO 5TO DISE√ëADOR
};

// ‚úÖ NUEVA VARIABLE GLOBAL PARA ID DE SOLICITUD EN MODAL DE DISE√ëADOR
// VARIABLE ELIMINADA - Ya no se usa modal de dise√±ador, se usa el panel lateral
// let requestIdForDesigner = null; // ELIMINADO

// ‚úÖ VARIABLES GLOBALES PARA B√öSQUEDA
let currentSearchId = "";
let isSearchActive = false;

// ‚úÖ NUEVA VARIABLE PARA ALMACENAR CREDENCIALES DEL USUARIO ACTUAL
let userCredentials = {
username: "",
password: "",
displayName: "",
role: "", // "admin" o "dise√±ador"
designerName: "" // Solo para dise√±adores
};

const DATA = {
especialidades: ["Alergolog√≠a", "Cardiolog√≠a", "Cirug√≠a general", "Dermatolog√≠a", "Fisiatr√≠a", "Foniatr√≠a", "Gastroenterolog√≠a", "Geriatr√≠a", "Ginecolog√≠a y obstetricia", "Infectolog√≠a", "Medicina familiar", "Medicina general", "Medicina interna", "Nefrolog√≠a", "Neumolog√≠a", "Neurolog√≠a", "Nutrici√≥n", "Odontolog√≠a", "Oftalmolog√≠a", "Oncolog√≠a", "Optometr√≠a", "Pediatr√≠a", "Psicolog√≠a", "Psiquiatr√≠a", "Reumatolog√≠a", "Traumatolog√≠a", "Urolog√≠a"],
servicios: ["Actividades recreativas", "Afiliaci√≥n", "Agudeza visual", "Aplicaci√≥n de fl√∫or", "Asesor√≠a legal", "Bienestar social", "Captaci√≥n odontol√≥gica", "Captaci√≥n quir√∫rgica general", "Captaci√≥n quir√∫rgica oftalmol√≥gica", "Charlas odontol√≥gicas", "Citolog√≠a", "Control de glicemia", "Control de talla y peso", "Desparasitaci√≥n", "Despistaje de glicemia capilar", "Despistaje HTA", "Ecograf√≠a", "Electrocardiograma", "Espirometr√≠a", "Farmacia", "Fisioterapia", "Fonoaudiolog√≠a", "Gerontolog√≠a", "Ingenier√≠a biom√©dica", "Inmunizaci√≥n", "Laboratorio", "Liberaci√≥n de hipoteca", "Masoterapia", "Podolog√≠a", "Quiropraxia", "Reposos m√©dicos", "Sesi√≥n educativa", "Servicios sociales", "Terapia de lenguaje (Logopedia)", "Terapia del dolor", "Terapia ocupacional", "Tipiaje", "Trabajo social"],
vacunas: ["Fiebre amarilla", "Pentavalente", "Polio IPV", "Polio oral", "Toxoide (tet√°nico/dift√©rico)", "Trivalente viral (SRP)"],
quirurgica: ["Bocio hiperfuncionante", "Colectom√≠a", "Enfermedad hemorroidal", "Esterilizaci√≥n", "Fibromatosis", "Fimosis", "Hernia abdominal", "Hernia epig√°strica", "Hernia escrotal", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Histerectom√≠a", "Lipomas", "Litiasis vesicular (Colecistectom√≠as)", "Lunares", "Miomatosis uterina", "Nevus", "N√≥dulos mamarios simples", "Paridad satisfecha", "Prolapso", "Quiste (TU)", "Quiste de epid√≠dimo", "Quiste seb√°ceo", "Quiste tirogloso", "Quistes seb√°ceos", "Tumores ov√°ricos", "Varicocele", "Vasectom√≠a", "Verrugas"],
pediatrica: ["Criptorquidias", "Fimosis", "Hernia epig√°strica", "Hernia inguinal", "Hernia umbilical", "Hidrocele", "Quiste tirogloso", "Varicocele"],
oftalmo: ["Cataratas", "Cirug√≠a pl√°stica ocular", "Dacriocistorrinostom√≠a", "Desprendimiento de retina", "Glaucoma", "Melanoma uveal", "Pterigi√≥n", "Ptosis palpebral", "Queratoplast√≠a", "Retinoblastoma", "Tumores oculares"]
};

// ‚úÖ FUNCI√ìN √öNICA DE B√öSQUEDA POR ID (CON B√öSQUEDA PARCIAL)
function buscarPorID() {
  const searchInput = document.getElementById('searchIdInput');
  const searchTerm = searchInput.value.trim().toUpperCase();
  currentSearchId = searchTerm;
  isSearchActive = searchTerm.length > 0;
  
  const searchContainer = document.getElementById('designer-search-container');
  if (isAdmin || isDesigner) {
    searchContainer.classList.remove('hidden');
  }
  
  if (!isSearchActive) {
    resetSearchHighlight();
    // CORRECCI√ìN: Usar renderLocalTable para mostrar todos los datos y restaurar contadores
    renderLocalTable();
    // OCULTAR MODAL DE ID NO ENCONTRADO
    document.getElementById('idNotFoundModal').style.display = 'none';
    return;
  }
  
  // ‚úÖ ASEGURAR QUE EL √çNDICE EST√â ACTUALIZADO
  if (DATA_INDEX.byId.size === 0) {
    console.log('üîÑ √çndice vac√≠o, reconstruyendo...');
    buildDataIndexes();
  }
  
  // ‚úÖ DEPURACI√ìN: Verificar qu√© hay en el √≠ndice
  console.log('üîç Buscando:', searchTerm);
  console.log('üìä Total en √≠ndice:', DATA_INDEX.byId.size);
  console.log('üìã IDs disponibles:', Array.from(DATA_INDEX.byId.keys()).slice(0, 10));
  
  // B√öSQUEDA PARCIAL (busca coincidencias en cualquier parte del ID)
  const matchedEntries = [];
  
  // Iterar sobre el √≠ndice para encontrar coincidencias parciales
  for (const [id, entry] of DATA_INDEX.byId) {
    if (id.includes(searchTerm)) {
      matchedEntries.push(entry);
      console.log('‚úÖ Coincidencia encontrada:', id);
    }
  }
  
  console.log('üéØ Resultados encontrados:', matchedEntries.length);
  
  if (matchedEntries.length > 0) {
    const body = document.getElementById('solicitudes-body');
    body.innerHTML = '';
    
    // Renderizar cada resultado encontrado
    matchedEntries.forEach(entry => {
      const tr = createRowElement(entry.item, entry.index);
      tr.classList.add('row-highlighted');
      body.appendChild(tr);
    });
    
    // Hacer scroll al primer resultado
    if (matchedEntries.length > 0) {
      const firstRow = body.querySelector('tr');
      if (firstRow) {
        firstRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }
    
    // OCULTAR MODAL DE ID NO ENCONTRADO SI HAY RESULTADOS
    document.getElementById('idNotFoundModal').style.display = 'none';
    
  } else {
    // MOSTRAR MENSAJE DE NO RESULTADOS Y RENDERIZAR TABLA VAC√çA
    document.getElementById('notFoundId').innerText = currentSearchId;
    document.getElementById('idNotFoundModal').style.display = 'flex';
    
    // RENDERIZAR TABLA VAC√çA PARA MOSTRAR QUE NO HAY RESULTADOS
    const body = document.getElementById('solicitudes-body');
    body.innerHTML = `
      <tr>
        <td colspan="8" class="no-results-message show">
          No se encontraron resultados para "${searchTerm}"
        </td>
      </tr>
    `;
  }
}

// APLICAR RESALTADO Y BLOQUEO
function applySearchHighlight(searchTerm) {
    const rows = document.querySelectorAll('#solicitudes-body tr');
    let foundMatch = false;
    let matchedRow = null;
    rows.forEach(row => {
        // ‚úÖ BUSCAR EN LA PRIMERA COLUMNA (ID) QUE AHORA CONTIENE EL BADGE
        const idCell = row.querySelector('td:first-child');
        const rowId = idCell ? idCell.textContent.trim().toUpperCase() : "";
        
        // ‚úÖ EXTRAER SOLO EL ID (eliminar texto del badge)
        const idOnly = rowId.replace(/NEW|PRIORIZAR/g, '').trim();
        
        // ‚úÖ VERIFICAR COINCIDENCIA
        const isMatch = idOnly.includes(searchTerm);
        if (isMatch) {
            row.classList.add('row-highlighted');
            row.classList.remove('row-locked');
            foundMatch = true;
            matchedRow = row;
            enableRowButtons(row);
        } else {
            row.classList.add('row-locked');
            row.classList.remove('row-highlighted');
            disableRowButtons(row);
        }
    });
    
    // ‚úÖ SCROLL AUTOM√ÅTICO A LA FILA ENCONTRADA
    if (matchedRow) {
        matchedRow.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
        });
    }
    
    // ‚úÖ MOSTRAR MENSAJE SI NO HAY COINCIDENCIAS
    if (!foundMatch) {
        document.getElementById('notFoundId').innerText = currentSearchId;
        document.getElementById('idNotFoundModal').style.display = 'flex';
    }
}

// ‚úÖ HABILITAR BOTONES EN FILA
function enableRowButtons(row) {
const buttons = row.querySelectorAll('.btn-arte, .btn-ver, .btn-tg');
buttons.forEach(btn => {
btn.disabled = false;
btn.style.opacity = "1";
btn.style.pointerEvents = "auto";
btn.style.cursor = "pointer";
});
}

// ‚úÖ DESHABILITAR BOTONES EN FILA
function disableRowButtons(row) {
const buttons = row.querySelectorAll('.btn-arte, .btn-ver, .btn-tg');
buttons.forEach(btn => {
btn.disabled = true;
btn.style.opacity = "0.4";
btn.style.pointerEvents = "none";
btn.style.cursor = "not-allowed";
});
}

// ‚úÖ RESTABLECER TABLA A ESTADO ORIGINAL
function resetSearchHighlight() {
const rows = document.querySelectorAll('#solicitudes-body tr');

rows.forEach(row => {
row.classList.remove('row-highlighted', 'row-locked');
enableRowButtons(row);
});

// ‚úÖ OCULTAR MENSAJE DE NO RESULTADOS
document.getElementById('idNotFoundModal').style.display = 'none';
}

// ‚úÖ Cerrar modal de ID no encontrado
function closeIdNotFoundModal() {
document.getElementById('idNotFoundModal').style.display = 'none';
document.getElementById('searchIdInput').focus();
}

// ‚úÖ LIMPIAR B√öSQUEDA
function clearSearch() {
document.getElementById('searchIdInput').value = "";
buscarPorID();

// ‚úÖ FOCO DE NUEVO EN EL INPUT
setTimeout(() => {
document.getElementById('searchIdInput').focus();
}, 100);
}

// ‚úÖ MANEJADOR DE EVENTOS PARA TECLADO
function handleSearchKeydown(e) {
if (e.key === 'Escape') {
clearSearch();
}

// ‚úÖ PREVENIR ENV√çO DEL FORMULARIO AL PRESIONAR ENTER
if (e.key === 'Enter') {
e.preventDefault();
buscarPorID();
}
}

// ‚úÖ INICIALIZAR EVENTOS DEL BUSCADOR
function initSearchEvents() {
const searchInput = document.getElementById('searchIdInput');

if (searchInput) {
// ‚úÖ B√öSQUEDA EN TIEMPO REAL (con debounce)
let searchTimeout;
searchInput.addEventListener('input', (e) => {
clearTimeout(searchTimeout);
searchTimeout = setTimeout(() => {
buscarPorID();
}, 300); // Esperar 300ms despu√©s de dejar de escribir
});

// ‚úÖ MANEJAR TECLAS ESPECIALES
searchInput.addEventListener('keydown', handleSearchKeydown);
}
}

// ‚úÖ ACTUALIZAR VISIBILIDAD DEL BUSCADOR SEG√öN ROL
function updateSearchVisibility() {
    const searchContainer = document.getElementById('designer-search-container');
    // ‚úÖ MOSTRAR BUSCADOR PARA ADMIN Y DISE√ëADOR
    if (isAdmin || isDesigner) {
        searchContainer.classList.remove('hidden');
        // ‚úÖ INICIALIZAR EVENTOS SI ES LA PRIMERA VEZ
        if (!window.searchEventsInitialized) {
            initSearchEvents();
            window.searchEventsInitialized = true;
        }
    } else {
        searchContainer.classList.add('hidden');
        resetSearchHighlight();
        // ‚úÖ OCULTAR MODAL DE ID NO ENCONTRADO
        document.getElementById('idNotFoundModal').style.display = 'none';
    }
}

// ‚úÖ MODIFICAR FUNCI√ìN modStatus PARA DETECTAR FINALIZADA Y USAR PANEL
async function modStatus(id, st) {
    const pill = document.getElementById('pill-' + id);
    const oldClass = pill.className;
    const oldText = pill.innerText;
    const newStatusClass = st.toLowerCase().replace(/\s+/g, '');
    pill.className = `status-pill status-${newStatusClass}`;
    pill.innerText = st;
    
    try {
        // ‚úÖ SI ES FINALIZADA Y NO HAY DISE√ëADOR ASIGNADO, MOSTRAR ALERTA EN PANEL
        if (st === "FINALIZADA") {
            const item = localData.find(x => x.id == id);
            if (!item?.Disenador) {
                // Abrir panel y mostrar mensaje
                selectRequest(id);
                openModal("‚ö†Ô∏è Atenci√≥n", "Debes asignar un dise√±ador antes de finalizar la solicitud. Usa el panel lateral.", "üë®‚Äçüé®");
                // Revertir cambio visual
                pill.className = oldClass;
                pill.innerText = oldText;
                return;
            }
        }
        
        const params = new URLSearchParams();
        params.append("action", "updateStatus");
        params.append("id", id);
        params.append("status", st);
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        // ‚úÖ VERIFICAR SI LA RESPUESTA ES JSON V√ÅLIDO
        const text = await response.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            console.error("Respuesta no v√°lida del servidor:", text);
            throw new Error("Respuesta inv√°lida del servidor");
        }
        
        if (data.success) {
            const item = localData.find(x => x.id == id);
            if(item) item.Estatus = st;
            renderLocalTable();
    updatePaginationControls();
        } else {
            throw new Error(data.error || "Error al actualizar estatus");
        }
    } catch (e) {
        pill.className = oldClass;
        pill.innerText = oldText;
        console.error("Error completo:", e);
        openModal("", "Error de conexi√≥n: " + e.message, "");
    }
}



// ACTUALIZAR CONTADORES (YA NO CALCULA, SOLO PINTA)
function updateCounters(stats) {
    if (!stats) return;

    // Contadores b√°sicos
    document.getElementById('count-total').innerText = stats.total || 0;
    document.getElementById('count-pend').innerText = stats.pend || 0;
    document.getElementById('count-proc').innerText = stats.proc || 0;
    document.getElementById('count-fin').innerText = stats.fin || 0;

    // Contadores Admin
    document.getElementById('count-total-admin').innerText = stats.total || 0;
    document.getElementById('count-pend-admin').innerText = stats.pend || 0;
    document.getElementById('count-proc-admin').innerText = stats.proc || 0;
    document.getElementById('count-fin-admin').innerText = stats.fin || 0;
    document.getElementById('count-bermina-admin').innerText = stats.bermina || 0;
    document.getElementById('count-jorsy-admin').innerText = stats.jorsy || 0;
    document.getElementById('count-maria-admin').innerText = stats.maria || 0;
    document.getElementById('count-xamir-admin').innerText = stats.xamir || 0;

    // Visibilidad seg√∫n rol
    if (isAdmin) {
        document.getElementById('stats-panel').style.display = 'none';
        document.getElementById('combined-stats').style.display = 'flex';
    } else {
        document.getElementById('stats-panel').style.display = 'flex';
        document.getElementById('combined-stats').style.display = 'none';
    }
    
    // Actualizar Headers
    updateSearchVisibility();
    if (isSearchActive && currentSearchId) applySearchHighlight(currentSearchId);
    if (isPanelOpen && selectedRequestId) updatePanelContent();
    
    // ‚úÖ MOSTRAR/OCULTAR COLUMNAS SEG√öN ROL
    document.getElementById('th-admin').classList.toggle('hidden', !isAdmin);
    document.getElementById('th-designer').classList.toggle('hidden', !isDesigner);
}


// ‚úÖ FUNCI√ìN PARA ACTUALIZAR CONTROLES DE PAGINACI√ìN - CORREGIDA
function updatePaginationControls() {
  // ‚úÖ CORRECCI√ìN: Calcular totalPages basado en totalRecords real
  const totalRecords = PAGINATION.totalRecords || localData.length;
  const totalPages = Math.ceil(totalRecords / PAGINATION.limit) || 1;
  
  // Actualizar objeto global
  PAGINATION.totalRecords = totalRecords;
  PAGINATION.totalPages = totalPages;
  
  // Asegurar que currentPage sea v√°lida
  if (PAGINATION.currentPage < 1) PAGINATION.currentPage = 1;
  if (PAGINATION.currentPage > totalPages) PAGINATION.currentPage = totalPages;
  
  const start = (PAGINATION.currentPage - 1) * PAGINATION.limit + 1;
  const end = Math.min(PAGINATION.currentPage * PAGINATION.limit, totalRecords);
  
  document.getElementById('paginationStart').innerText = totalRecords > 0 ? start : 0;
  document.getElementById('paginationEnd').innerText = end;
  document.getElementById('paginationTotal').innerText = totalRecords;
  document.getElementById('currentPageIndicator').innerText = `${PAGINATION.currentPage} / ${totalPages}`;
  
  // Habilitar/Deshabilitar botones
  const btnFirst = document.getElementById('btnFirstPage');
  const btnPrev = document.getElementById('btnPrevPage');
  const btnNext = document.getElementById('btnNextPage');
  const btnLast = document.getElementById('btnLastPage');
  
  if (btnFirst) btnFirst.disabled = PAGINATION.currentPage === 1;
  if (btnPrev) btnPrev.disabled = PAGINATION.currentPage === 1;
  if (btnNext) btnNext.disabled = PAGINATION.currentPage >= totalPages;
  if (btnLast) btnLast.disabled = PAGINATION.currentPage >= totalPages;
  
  console.log(`üìä Paginaci√≥n: P√°gina ${PAGINATION.currentPage}/${totalPages} | Total: ${totalRecords} registros | Mostrando ${start}-${end}`);
}

// ‚úÖ CACHE LOCAL PARA PAGINACI√ìN INSTANT√ÅNEA
const PAGE_CACHE = {
  data: new Map(), // page -> {rows, stats, timestamp}
  maxPages: 10, // Mantener hasta 10 p√°ginas en cach√©
  ttl: 5 * 60 * 1000, // 5 minutos
  
  // Guardar p√°gina en cach√©
  setPage(page, data) {
    this.data.set(page, {
      ...data,
      timestamp: Date.now()
    });
    
    // Limpiar p√°ginas antiguas si excede el l√≠mite
    if (this.data.size > this.maxPages) {
      const oldestPage = Array.from(this.data.keys())[0];
      this.data.delete(oldestPage);
    }
  },
  
  // Obtener p√°gina desde cach√©
  getPage(page) {
    const cached = this.data.get(page);
    if (!cached) return null;
    
    // Verificar si no ha expirado
    if (Date.now() - cached.timestamp > this.ttl) {
      this.data.delete(page);
      return null;
    }
    
    return cached;
  },
  
  // Limpiar toda la cach√©
  clear() {
    this.data.clear();
  },
  
  // Verificar si una p√°gina est√° en cach√©
  hasPage(page) {
    return this.getPage(page) !== null;
  }
};

// ‚úÖ FUNCI√ìN changePage - VERSI√ìN INSTANT√ÅNEA
async function changePage(action) {
  if (PAGINATION.isLoading) return;
  
  let newPage = PAGINATION.currentPage;
  const totalPages = PAGINATION.totalPages || 1;
  
  switch(action) {
    case 'first': newPage = 1; break;
    case 'prev': newPage = Math.max(1, PAGINATION.currentPage - 1); break;
    case 'next': newPage = Math.min(totalPages, PAGINATION.currentPage + 1); break;
    case 'last': newPage = totalPages; break;
  }
  
  console.log(`üîÑ Cambiando p√°gina: ${PAGINATION.currentPage} -> ${newPage} (total: ${totalPages})`);
  
  if (newPage === PAGINATION.currentPage) return;
  
  // ‚úÖ CAMBIO INSTANT√ÅNEO: Verificar si tenemos la p√°gina en cach√©
  const cachedPage = PAGE_CACHE.getPage(newPage);
  
  if (cachedPage) {
    // ‚úÖ P√ÅGINA EN CACH√â - CAMBIO INSTANT√ÅNEO
    console.log(`‚ö° P√°gina ${newPage} encontrada en cach√© - cambio instant√°neo`);
    
    // Actualizar p√°gina actual
    PAGINATION.currentPage = newPage;
    
    // Actualizar datos locales inmediatamente
    localData = cachedPage.rows;
    
    // Renderizar inmediatamente sin loading
    renderLocalTable();
    updatePaginationControls();
    
    // Pre-cargar p√°ginas adyacentes en background
    preloadAdjacentPages(newPage);
    
    return; // Salir early - no necesitamos consultar al servidor
  }
  
  // ‚úÖ P√ÅGINA NO EN CACH√â - Cargar con loading m√≠nimo
  console.log(`üì° P√°gina ${newPage} no est√° en cach√© - cargando desde servidor`);
  
  PAGINATION.isLoading = true;
  PAGINATION.currentPage = newPage;
  
  // Mostrar indicador sutil (no spinner completo)
  const body = document.getElementById('solicitudes-body');
  const originalContent = body.innerHTML;
  
  // Indicator minimalista
  body.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--turquesa);font-weight:600;font-size:0.9rem;">‚ö° Cargando p√°gina ' + newPage + '...</td></tr>';
  
  try {
    // Forzar refresh para obtener la nueva p√°gina del servidor
    DATA_CACHE.data = null;
    DATA_CACHE.timestamp = 0;
    
    await updateTable(true);
    
    // Guardar en cach√© para futuros usos
    if (localData.length > 0) {
      PAGE_CACHE.setPage(newPage, {
        rows: [...localData],
        stats: DATA_CACHE.stats
      });
    }
    
    // Pre-cargar p√°ginas adyacentes
    preloadAdjacentPages(newPage);
    
  } catch (e) {
    console.error("Error cambiando p√°gina:", e);
    openModal("‚ùå Error", "No se pudo cargar la p√°gina: " + e.message, "üí•");
    
    // Revertir p√°gina y restaurar contenido
    PAGINATION.currentPage = newPage - (action === 'next' || action === 'last' ? 1 : -1);
    body.innerHTML = originalContent;
  } finally {
    PAGINATION.isLoading = false;
  }
}

// ‚úÖ PRE-CARGA DE P√ÅGINAS ADYACENTES EN BACKGROUND
async function preloadAdjacentPages(currentPage) {
  const totalPages = PAGINATION.totalPages || 1;
  const pagesToPreload = [];
  
  // Pre-cargar p√°gina siguiente y anterior si no est√°n en cach√©
  if (currentPage < totalPages && !PAGE_CACHE.hasPage(currentPage + 1)) {
    pagesToPreload.push(currentPage + 1);
  }
  
  if (currentPage > 1 && !PAGE_CACHE.hasPage(currentPage - 1)) {
    pagesToPreload.push(currentPage - 1);
  }
  
  // Tambi√©n pre-cargar primera y √∫ltima si son diferentes
  if (!PAGE_CACHE.hasPage(1) && currentPage !== 1) {
    pagesToPreload.push(1);
  }
  
  if (!PAGE_CACHE.hasPage(totalPages) && currentPage !== totalPages) {
    pagesToPreload.push(totalPages);
  }
  
  // Limitar a 2 pre-cargas simult√°neas para no sobrecargar
  const limitedPages = pagesToPreload.slice(0, 2);
  
  if (limitedPages.length > 0) {
    console.log(`üöÄ Pre-cargando p√°ginas: [${limitedPages.join(', ')}]`);
    
    // Ejecutar pre-cargas en paralelo sin bloquear UI
    limitedPages.forEach(async (page) => {
      try {
        await preloadPage(page);
      } catch (e) {
        console.warn(`‚ö†Ô∏è Error pre-cargando p√°gina ${page}:`, e);
      }
    });
  }
}

// ‚úÖ FUNCI√ìN PARA PRE-CARGAR UNA P√ÅGINA ESPEC√çFICA
async function preloadPage(pageNum) {
  if (PAGE_CACHE.hasPage(pageNum)) return; // Ya est√° en cach√©
  
  try {
    const params = new URLSearchParams();
    params.append("action", "read");
    params.append("page", pageNum.toString());
    params.append("limit", PAGINATION.limit.toString());
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });
    
    const responseText = await res.text();
    const response = JSON.parse(responseText);
    
    if (response.success && response.data) {
      const data = response.data;
      
      // Guardar en cach√©
      PAGE_CACHE.setPage(pageNum, {
        rows: data.rows || [],
        stats: data.stats || null
      });
      
      console.log(`‚úÖ P√°gina ${pageNum} pre-cargada exitosamente`);
    }
  } catch (e) {
    console.warn(`‚ö†Ô∏è Error pre-cargando p√°gina ${pageNum}:`, e);
  }
}

function createRowElement(s, idx) {
    const tr = document.createElement('tr');
    
    const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
    const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
    const esNueva = (statusReal === "PENDIENTE");
    const esObituario = (s.Jornada || "").toLowerCase().includes("obituario");
    const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
    const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";
    
    if (esNueva) {
        tr.className = esObituario ? "row-obituario" : "row-new";
    }
    if (selectedRequestId === s.id) {
        tr.classList.add('row-selected-panel');
    }
    
    let badge = '';
    if (esNueva) {
        badge = esObituario 
            ? '<span class="badge-prioridad">PRIORIZAR</span>'
            : '<span class="badge-new">NEW</span>';
    }
    
    let designerCircle = '';
    if (s.Disenador) {
        const color = designerColors[s.Disenador] || '#6c757d';
        designerCircle = `<span class="designer-circle" style="background-color: ${color};" title="${s.Disenador}"></span>`;
    }
    
    const icon = (s.Soportes && s.Soportes.includes("S√ç")) 
        ? `üì∑ (${s.Soportes.match(/\d+/) || 1})` 
        : "üôà";
    
    const fechaEventoFormat = extraerFecha(s.Fecha);
    const horaEvento = s.Hora && s.Hora.trim() !== '' ? s.Hora : 'Sin hora';
    const isRegularUser = !isAdmin && !isDesigner;
    
    if (isRegularUser) {
        const fechaSolicitudFormat = extraerFecha(s.Timestamp);
        const horaSolicitudFormat = extraerHora(s.Timestamp);
        
        tr.innerHTML = `
            <td>
                <span class="txt-bold">${fechaSolicitudFormat}</span><br>
                <span class="txt-small">${horaSolicitudFormat}</span>
            </td>
            <td>
                <span class="txt-bold">${fechaEventoFormat}</span><br>
                <span class="txt-small">${horaEvento}</span>
            </td>
            <td class="txt-bold">${unidadLimpia} ${badge}</td>
            <td>${jornadaLimpia}</td>
            <td align="center">${icon}</td>
            <td>
                ${designerCircle}
                <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
            </td>
        `;
    } else {
        // ADMIN O DISE√ëADOR: L√≥gica de Iconos Condicional Robusta
        // Verificamos que ArteFinal exista y no est√© vac√≠o
        const hasArt = (s.ArteFinal && s.ArteFinal.trim() !== "" && s.ArteFinal !== "null");
        
        let actionIcon, actionText;

        if (hasArt) {
            // HAY ARCHIVO: Clip Verde
            actionIcon = '<span style="color: var(--verde); font-size: 1.3rem;">üìé</span>';
            actionText = '<span style="color: var(--verde);">Archivo Adjunto</span>';
        } else {
            // NO HAY ARCHIVO: Mano Naranja
            actionIcon = '<span style="color: #fb8500; font-size: 1.3rem;">üëÜ</span>';
            actionText = '<span>Click para seleccionar</span>';
        }

        tr.innerHTML = `
        <td>
            <span class="txt-bold">${s.id}</span>
            ${badge}
        </td>
        <td>
            <span class="txt-bold">${fechaEventoFormat}</span><br>
            <span class="txt-small">${horaEvento}</span>
        </td>
        <td class="txt-bold">${unidadLimpia}</td>
        <td>${jornadaLimpia}</td>
        <td align="center">${icon}</td>
        <td>
            ${designerCircle}
            <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
        </td>
        <!-- COLUMNA DE ACCIONES CON ICONO CONDICIONAL Y TEXTO ALINEADO -->
        <td align="right" class="admin-actions-cell">
            <div class="admin-actions-content">
                ${actionIcon}
                ${actionText}
            </div>
        </td>
        `;
        
        // AGREGAR VERIFICACI√ìN: Solo permitir selecci√≥n si es admin o dise√±ador
        if (!isRegularUser) {
            tr.style.cursor = 'pointer';
            tr.addEventListener('click', function(e) {
                // VERIFICACI√ìN ADICIONAL: No seleccionar si ya no es admin/dise√±ador
                if (!isAdmin && !isDesigner) return;
                // No seleccionar si se hizo click en un bot√≥n o enlace
                if (e.target.closest('button') || e.target.closest('a')) return;
                selectRequest(s.id);
            });
        }
    }
    
    return tr;
}

// ‚úÖ FUNCI√ìN UNIFICADA PARA MANEJO DE FECHAS - VERSI√ìN ROBUSTA
function formatearFecha(valor, formato = 'datetime') {
  if (!valor || valor.toString().trim() === "") return "";
  
  var fechaObj;
  
  try {
    if (valor instanceof Date) {
      fechaObj = valor;
    } else if (typeof valor === 'string') {
      var texto = valor.trim().replace(/-/g, '/');
      var partes = texto.split(' ');
      var fechaPart = partes[0];
      
      // Formato dd/MM/yyyy
      if (fechaPart.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
        var dmy = fechaPart.split('/');
        var dia = parseInt(dmy[0], 10);
        var mes = parseInt(dmy[1], 10) - 1;
        var anio = parseInt(dmy[2], 10);
        
        var hora = 0, min = 0;
        if (partes[1]) {
          var tiempo = partes[1].split(':');
          hora = parseInt(tiempo[0], 10) || 0;
          min = parseInt(tiempo[1], 10) || 0;
        }
        
        fechaObj = new Date(anio, mes, dia, hora, min);
      }
      // Formato yyyy/MM/dd
      else if (fechaPart.match(/^\d{4}\/\d{1,2}\/\d{1,2}/)) {
        var iso = fechaPart.split('/');
        fechaObj = new Date(parseInt(iso[0]), parseInt(iso[1]) - 1, parseInt(iso[2]));
      }
      // Formato MM/dd/yyyy (US)
      else if (fechaPart.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}/)) {
        var us = fechaPart.split('/');
        var anio = us[2].length === 2 ? 2000 + parseInt(us[2]) : parseInt(us[2]);
        fechaObj = new Date(anio, parseInt(us[0]) - 1, parseInt(us[1]));
      }
      else {
        // Intentar parseo nativo como √∫ltimo recurso
        fechaObj = new Date(texto);
      }
    } else {
      return valor; // Devolver tal cual si no se puede parsear
    }
    
    if (!fechaObj || isNaN(fechaObj.getTime())) {
      console.warn("‚ö†Ô∏è Fecha inv√°lida:", valor);
      return valor; // Devolver valor original en lugar de vac√≠o
    }
    
    // Formatear seg√∫n tipo
    var dd = String(fechaObj.getDate()).padStart(2, '0');
    var mm = String(fechaObj.getMonth() + 1).padStart(2, '0');
    var yyyy = fechaObj.getFullYear();
    
    if (formato === 'date') {
      return dd + '/' + mm + '/' + yyyy;
    } else if (formato === 'datetime') {
      var hh = String(fechaObj.getHours()).padStart(2, '0');
      var min = String(fechaObj.getMinutes()).padStart(2, '0');
      return dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + min;
    }
    
    return dd + '/' + mm + '/' + yyyy;
    
  } catch (e) {
    console.error("‚ùå Error formateando fecha:", valor, e);
    return valor || ""; // Devolver valor original o vac√≠o
  }
}

function extraerFecha(dateTime) {
  if (!dateTime) return "";
  return dateTime.split(' ')[0] || "";
}

function extraerHora(dateTime) {
  if (!dateTime) return "";
  var partes = dateTime.trim().split(' ');
  if (partes.length < 2) return "Sin hora";
  var horaCompleta = partes.slice(1).join(' ');
  
  // Convertir a formato 12 horas con a. m./p. m.
  var horaPartes = horaCompleta.split(':');
  if (horaPartes.length >= 2) {
    var horas = parseInt(horaPartes[0]);
    var minutos = horaPartes[1];
    var ampm = horas >= 12 ? 'p. m.' : 'a. m.';
    horas = horas % 12;
    horas = horas ? horas : 12; // El 0 se convierte en 12
    return horas + ':' + minutos + ' ' + ampm;
  }
  
  return horaCompleta;
}

// ‚úÖ FUNCI√ìN renderLocalTable - CORREGIDA
function renderLocalTable() {
  const body = document.getElementById('solicitudes-body');
  body.innerHTML = "";
  
  // ‚úÖ CORRECCI√ìN: Usar PAGINATION.totalRecords que viene del servidor
  const totalRecords = PAGINATION.totalRecords || localData.length;
  const totalPages = Math.ceil(totalRecords / PAGINATION.limit) || 1;
  
  console.log(`üìÑ Renderizando: ${localData.length} registros en memoria de ${totalRecords} totales`);
  
  // Validar p√°gina actual
  if (PAGINATION.currentPage > totalPages) {
    PAGINATION.currentPage = totalPages;
  }
  if (PAGINATION.currentPage < 1) {
    PAGINATION.currentPage = 1;
  }
  
  // Calcular √≠ndices para mostrar
  const startIndex = (PAGINATION.currentPage - 1) * PAGINATION.limit;
  const endIndex = Math.min(startIndex + PAGINATION.limit, totalRecords);
  
  console.log(`üìÑ P√°gina ${PAGINATION.currentPage}/${totalPages} - Registros ${startIndex + 1} a ${endIndex} de ${totalRecords}`);
  
  // ‚úÖ IMPORTANTE: localData ya contiene solo los registros de la p√°gina actual del servidor
  // No hacer slice aqu√≠ porque el servidor ya pagin√≥ los datos
  const dataToRender = localData;
  
  const isRegularUser = !isAdmin && !isDesigner;
  
  dataToRender.forEach((s, idx) => {
    const statusReal = s.Estatus ? s.Estatus.toUpperCase().trim() : "";
    const statusLimpio = statusReal.toLowerCase().replace(/\s+/g,'');
    const esNueva = (statusReal === "PENDIENTE");
    const unidadLimpia = s.Unidad ? s.Unidad.replace(/\+/g, ' ') : "";
    const jornadaLimpia = s.Jornada ? s.Jornada.replace(/\+/g, ' ') : "";
    
    let badge = '';
    let rowClass = '';
    if (esNueva) {
      if (jornadaLimpia === "Obituario") {
        badge = '<span class="badge-prioridad">PRIORIZAR</span>';
        rowClass = "row-obituario";
      } else {
        badge = '<span class="badge-new">NEW</span>';
        rowClass = "row-new";
      }
    }
    
    let designerCircle = '';
    if (s.Disenador) {
      const color = designerColors[s.Disenador] || '#6c757d';
      designerCircle = `<span class="designer-circle" style="background-color: ${color};" title="${s.Disenador}"></span>`;
    }
    
    let icon = '';
    if (s.Soportes && s.Soportes.includes("S√ç")) {
      const count = s.Soportes.match(/\d+/) || 1;
      icon = `<span style="color: var(--verde); font-size: 1.2rem;" title="${count} soporte(s) adjunto(s)">üì∑ <span style="font-size: 0.8rem; font-weight: 600;">${count}</span></span>`;
    } else {
      icon = `<span style="color: var(--rojo); font-size: 1.2rem;" title="Sin soportes">‚ùå</span>`;
    }
    
    const fechaSolicitudFormat = extraerFecha(s.Timestamp);
    const horaSolicitudFormat = extraerHora(s.Timestamp);
    const fechaEventoFormat = extraerFecha(s.Fecha);
    const horaEvento = s.Hora && s.Hora.trim() !== '' ? s.Hora : 'Sin hora';
    
    const tr = document.createElement('tr');
    if(rowClass) tr.className = rowClass;
    
    if (selectedRequestId === s.id) {
      tr.classList.add('row-selected-panel');
    }
    
    if (isRegularUser) {
      tr.innerHTML = `
        <td>
          <span class="txt-bold">${fechaSolicitudFormat}</span><br>
          <span class="txt-small">${horaSolicitudFormat}</span>
        </td>
        <td>
          <span class="txt-bold">${fechaEventoFormat}</span><br>
          <span class="txt-small">${horaEvento}</span>
        </td>
        <td class="txt-bold">${unidadLimpia} ${badge}</td>
        <td>${jornadaLimpia}</td>
        <td align="center">${icon}</td>
        <td>
          ${designerCircle}
          <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
        </td>
        <td></td>
      `;
    } else {
      const hasArt = (s.ArteFinal && s.ArteFinal.trim() !== "" && s.ArteFinal !== "null");
      let actionIcon, actionText;
      if (hasArt) {
        actionIcon = '<span style="color: var(--verde); font-size: 1.3rem;">üìé</span>';
        actionText = '<span style="color: var(--verde);">Archivo Adjunto</span>';
      } else {
        actionIcon = '<span style="color: #fb8500; font-size: 1.3rem;">üëÜ</span>';
        actionText = '<span>Click para seleccionar</span>';
      }
      
      tr.innerHTML = `
        <td>
          <span class="txt-bold">${s.id}</span>
          ${badge}
        </td>
        <td>
          <span class="txt-bold">${fechaEventoFormat}</span><br>
          <span class="txt-small">${horaEvento}</span>
        </td>
        <td class="txt-bold">${unidadLimpia}</td>
        <td>${jornadaLimpia}</td>
        <td align="center">${icon}</td>
        <td>
          ${designerCircle}
          <span id="pill-${s.id}" class="status-pill status-${statusLimpio}">${s.Estatus}</span>
        </td>
        <td align="right" class="admin-actions-cell">
          <div class="admin-actions-content">
            ${actionIcon}
            ${actionText}
          </div>
        </td>
      `;
      
      if (!isRegularUser) {
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', function(e) {
          if (!isAdmin && !isDesigner) return;
          if (e.target.closest('button') || e.target.closest('a')) return;
          selectRequest(s.id);
        });
      }
    }
    body.appendChild(tr);
  });
  
  // Actualizar headers seg√∫n rol
  const thActions = isAdmin ? document.getElementById('th-admin') : document.getElementById('th-designer');
  const thId = document.querySelector('thead th:nth-child(1)');
  const thFechaEvento = document.querySelector('thead th:nth-child(2)');
  const thUnidad = document.querySelector('thead th:nth-child(3)');
  const thJornada = document.querySelector('thead th:nth-child(4)');
  
  if (isRegularUser) {
    if(thId) thId.innerHTML = 'üìÖ FECHA SOLICITUD';
    if(thFechaEvento) thFechaEvento.innerHTML = 'üóìÔ∏è FECHA EVENTO';
    if(thUnidad) thUnidad.innerHTML = 'üè• UNIDAD';
    if(thJornada) thJornada.innerHTML = 'üìã TIPO JORNADA';
    document.getElementById('th-admin').classList.add('hidden');
    document.getElementById('th-designer').classList.add('hidden');
  } else {
    if(thId) thId.innerHTML = 'ID SOLICITUD';
    if(thFechaEvento) thFechaEvento.innerHTML = 'üóìÔ∏è FECHA EVENTO';
    if(thUnidad) thUnidad.innerHTML = 'UNIDAD SOLICITANTE';
    if(thJornada) thJornada.innerHTML = 'TIPO DE JORNADA';
    
    if (isAdmin) {
      if(thActions) thActions.innerHTML = 'ACCIONES ADMIN';
      thActions.classList.remove('hidden');
      document.getElementById('th-designer').classList.add('hidden');
    } else if (isDesigner) {
      if(thActions) thActions.innerHTML = 'ACCIONES DISE√ëO';
      thActions.classList.remove('hidden');
      document.getElementById('th-admin').classList.add('hidden');
    }
  }
  
  updateSearchVisibility();
  
  if (isSearchActive && currentSearchId) {
    applySearchHighlight(currentSearchId);
  }
  
  if (isPanelOpen && selectedRequestId) {
    updatePanelContent();
  }
  
  // ‚úÖ ACTUALIZAR CONTROLES DE PAGINACI√ìN AL FINAL
  updatePaginationControls();
}

// FUNCIONES DEL PANEL LATERAL
function openSidePanel() {
    // AGREGAR: Verificar permisos antes de abrir
    if (!isAdmin && !isDesigner) {
        console.log("‚õî Intento de abrir panel sin permisos");
        return;
    }
    
    const panel = document.getElementById('sidePanel');
    const overlay = document.getElementById('panelOverlay');
    
    panel.classList.add('active');
    overlay.classList.add('active');
    isPanelOpen = true;
    
    // Actualizar contenido
    updatePanelContent();
    
    // ‚úÖ INICIAR SINCRONIZACI√ìN AUTOM√ÅTICA
    iniciarSincronizacionPanel();
}

function closeSidePanel() {
    const panel = document.getElementById('sidePanel');
    const overlay = document.getElementById('panelOverlay');
    
    panel.classList.remove('active');
    overlay.classList.remove('active');
    isPanelOpen = false;
    
    // ‚úÖ DETENER SINCRONIZACI√ìN AUTOM√ÅTICA
    if (panelSyncInterval) {
        clearInterval(panelSyncInterval);
        panelSyncInterval = null;
    }
    
    // Deseleccionar fila visualmente (pero mantener selectedRequestId para referencia)
    document.querySelectorAll('.row-selected-panel').forEach(row => {
        row.classList.remove('row-selected-panel');
    });
}

function selectRequest(id) {
    // AGREGAR: Verificar permisos antes de seleccionar
    if (!isAdmin && !isDesigner) {
        console.log("‚õî Intento de selecci√≥n sin permisos");
        return; // No permitir selecci√≥n si no es admin o dise√±ador
    }
    
    // Si ya est√° seleccionada, no hacer nada
    if (selectedRequestId === id && isPanelOpen) return;
    
    // Actualizar selecci√≥n
    selectedRequestId = id;
    selectedRequestData = localData.find(x => x.id == id);
    
    // Abrir panel autom√°ticamente
    openSidePanel();
    
    // Actualizar tabla para mostrar selecci√≥n visual
    renderLocalTable();
    updatePaginationControls();
}

function updatePanelContent() {
    const container = document.getElementById('selectedRequestContent');
    const hasSelection = selectedRequestId && selectedRequestData;
    if (!hasSelection) {
        container.innerHTML = `
        <div class="no-selection">
            <div class="no-selection-icon">üì≠</div>
            <div>Selecciona una solicitud<br>de la tabla para activar<br>las acciones</div>
        </div>
        `;
        disableAllPanelButtons();
        updateFilePreview(null);
        return;
    }

    // Mostrar info de solicitud
    const esObituario = (selectedRequestData.Jornada || "").toLowerCase().includes("obituario");
    const badge = esObituario ? '<span class="badge-prioridad">PRIORIZAR</span>' :
        (selectedRequestData.Estatus === 'PENDIENTE' ? '<span class="badge-new">NEW</span>' : '');
    container.innerHTML = `
    <div class="selected-request-id">${selectedRequestId} ${badge}</div>
    <div class="selected-request-info">
        <strong>${selectedRequestData.Unidad}</strong><br>
        ${selectedRequestData.Jornada}<br>
        üìÖ ${selectedRequestData.Fecha} ${selectedRequestData.Hora ? '| ' + selectedRequestData.Hora : ''}
    </div>
    `;

    // Actualizar indicadores de estado (luces)
    const currentStatus = (selectedRequestData.Estatus || "").toUpperCase();
    document.getElementById('indPend').classList.toggle('active', currentStatus === 'PENDIENTE');
    document.getElementById('indProc').classList.toggle('active', currentStatus === 'PROCESANDO');
    document.getElementById('indFin').classList.toggle('active', currentStatus === 'FINALIZADA');

    // ‚úÖ CORRECCI√ìN: Habilitar botones seg√∫n permisos (Esto activa los botones de estado)
    enablePanelButtons();

    // Referencias a elementos sensibles
    const designerSection = document.getElementById('designerAssignSection');
    const adminActionsSection = document.getElementById('adminActions');
    const statusActionsSection = document.getElementById('statusActions');
    const btnMaint = document.getElementById('btnMaint');
    const btnReportPanel = document.getElementById('btnReportPanel');

    // ‚úÖ L√ìGICA DE VISIBILIDAD POR ROL
    if (isAdmin) {
        // ADMIN: Acceso total (Estatus, Dise√±adores, Mantenimiento, Reporte)
        designerSection.classList.remove('hidden');
        adminActionsSection.classList.remove('hidden');
        statusActionsSection.classList.remove('hidden');
        
        if(btnMaint) btnMaint.style.display = 'flex';
        if(btnReportPanel) btnReportPanel.style.display = 'flex';

        // Habilitar botones de asignaci√≥n y eliminaci√≥n
        document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = false);
        document.getElementById('btnEliminar').disabled = false;

        // Marcar dise√±ador seleccionado visualmente
        if (selectedRequestData?.Disenador) {
            document.querySelectorAll('.designer-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.includes(selectedRequestData.Disenador));
            });
        } else {
            document.querySelectorAll('.designer-btn').forEach(btn => btn.classList.remove('selected'));
        }

    } else if (isDesigner) {
        // DISE√ëADOR: Solo Archivo. OCULTAR Estatus, Mantenimiento y Reporte.
        designerSection.classList.add('hidden');
        adminActionsSection.classList.add('hidden');
        statusActionsSection.classList.add('hidden'); // Ocultar botones de estado
        
        if(btnMaint) btnMaint.style.display = 'none'; // Ocultar Mantenimiento
        if(btnReportPanel) btnReportPanel.style.display = 'none'; // Ocultar Reporte
        
        document.getElementById('btnEliminar').disabled = true;

    } else {
        // USUARIO REGULAR: Sin acceso a panel de gesti√≥n
        designerSection.classList.add('hidden');
        adminActionsSection.classList.add('hidden');
        statusActionsSection.classList.add('hidden');
        
        if(btnMaint) btnMaint.style.display = 'none';
        if(btnReportPanel) btnReportPanel.style.display = 'none';
        
        document.getElementById('btnEliminar').disabled = true;
    }

    // Actualizar vista previa de archivo
    updateFilePreview(selectedRequestData.ArteFinal);

    // ‚úÖ HABILITAR ACCIONES DE ARCHIVO (Com√∫n para Admin y Dise√±ador)
    // (Nota: enablePanelButtons ya habilita estos botones, pero esto asegura el estado de Telegram/Ver)
    const hasArt = !!selectedRequestData?.ArteFinal;
    document.getElementById('btnAdjuntar').disabled = !(isAdmin || isDesigner);
    document.getElementById('btnVerArte').disabled = !hasArt;
    document.getElementById('btnEnviarTG').disabled = !hasArt;
}

function updateFilePreview(arteUrl) {
    const container = document.getElementById('filePreviewContainer');
    const info = document.getElementById('filePreviewInfo');
    
    if (!arteUrl) {
        container.innerHTML = `
        <div class="file-preview-placeholder">
        <div class="file-preview-placeholder-icon">üìé</div>
        <div>No hay archivo adjunto</div>
        </div>
        `;
        info.innerHTML = '';
        document.getElementById('btnVerArte').disabled = true;
        document.getElementById('btnEnviarTG').disabled = true;
        return;
    }
    
    // Extraer ID de archivo de Google Drive
    const fileIdMatch = arteUrl.match(/\/file\/d\/([-\w]{25,})/) || arteUrl.match(/[-\w]{25,}/);
    if (!fileIdMatch) {
        container.innerHTML = `
        <div class="file-preview-placeholder">
        <div class="file-preview-placeholder-icon">‚ùì</div>
        <div>No se puede previsualizar</div>
        </div>
        `;
        return;
    }
    
    const fileId = fileIdMatch[1];
    // Usar thumbnail de Google Drive - IMAGEN COMPLETA A ESCALA REDUCIDA
    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;
    
    container.innerHTML = `
    <img src="" class="file-preview-image-full" onclick="window.open('${arteUrl}', '_blank')" title="Click para ver en tama√±o completo">
    `;
    
    // ‚úÖ LAZY LOADING CON INTERSECTION OBSERVER
    const img = container.querySelector('img');
    if (img) {
        img.loading = 'lazy';
        img.setAttribute('data-src', thumbnailUrl);
        
        // ‚úÖ CARGAR S√ìLO CUANDO SEA VISIBLE
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.getAttribute('data-src');
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: '50px' });
        
        observer.observe(img);
    }
    
    info.innerHTML = 'üíæ Archivo adjunto disponible';
    
    document.getElementById('btnVerArte').disabled = false;
    document.getElementById('btnEnviarTG').disabled = false;
}

function disableAllPanelButtons() {
    const buttons = document.querySelectorAll('.panel-btn:not(#btnMaint):not(#btnReport)');
    buttons.forEach(btn => btn.disabled = true);
    document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = true);
}

function enablePanelButtons() {
    // Botones de estado (Admin y Dise√±ador pueden cambiar estado)
    document.getElementById('btnStatusPend').disabled = false;
    document.getElementById('btnStatusProc').disabled = false;
    document.getElementById('btnStatusFin').disabled = false;
    
    // Botones de archivo
    document.getElementById('btnAdjuntar').disabled = false;
    document.getElementById('btnVerArte').disabled = !selectedRequestData?.ArteFinal;
    document.getElementById('btnEnviarTG').disabled = !selectedRequestData?.ArteFinal;
    
    // Botones especiales de Admin
    if (isAdmin) {
        document.getElementById('btnEliminar').disabled = false;
        document.querySelectorAll('.designer-btn').forEach(btn => btn.disabled = false);
    }
}

// ‚úÖ ACCIONES DEL PANEL
async function changeStatus(newStatus) {
    if (!selectedRequestId) return;
    
    // Si es finalizada y no hay dise√±ador asignado (solo admin), mostrar alerta
    if (newStatus === 'FINALIZADA' && isAdmin && !selectedRequestData?.Disenador) {
        openModal("‚ö†Ô∏è Atenci√≥n", "Debes asignar un dise√±ador antes de finalizar la solicitud.", "üë®‚Äçüé®");
        return;
    }
    
    document.getElementById('loadMainTxt').innerText = "Actualizando estado...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        // === REEMPLAZAR EL FETCH POR ===
        const result = await batchRequest('updateStatus', {
            id: selectedRequestId,
            status: newStatus,
            username: userCredentials.username,
            password: userCredentials.password,
            disenador: newStatus === 'FINALIZADA' ? selectedRequestData?.Disenador : ''
        });
        
        const data = result;
        
        if (data.success) {
            // Actualizar datos locales
            const item = localData.find(x => x.id == selectedRequestId);
            if (item) {
                item.Estatus = newStatus;
                if (newStatus === 'FINALIZADA' && selectedRequestData?.Disenador) {
                    item.Disenador = selectedRequestData.Disenador;
                }
                selectedRequestData = item;
            }
            
            // Actualizar panel y tabla
            updatePanelContent();
            renderLocalTable();
    updatePaginationControls();
            
            openModal("‚úÖ √âxito", `Estado actualizado a ${newStatus}`, "üîÑ");
        } else {
            throw new Error(data.error || "Error al actualizar estado");
        }
    } catch (e) {
        console.error("Error completo:", e);
        openModal("‚ùå Error", e.message, "üí•");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

async function assignDesigner(designerName) {
    if (!isAdmin || !selectedRequestId) return;
    
    document.getElementById('loadMainTxt').innerText = "Asignando dise√±ador...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const params = new URLSearchParams();
        params.append("action", "assignDesigner");
        params.append("id", selectedRequestId);
        params.append("disenador", designerName);
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        // ‚úÖ VERIFICAR SI LA RESPUESTA ES JSON V√ÅLIDO
        const text = await response.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            console.error("Respuesta no v√°lida del servidor:", text);
            throw new Error("Respuesta inv√°lida del servidor");
        }
        
        if (data.success) {
            // Actualizar datos locales
            const item = localData.find(x => x.id == selectedRequestId);
            if (item) {
                item.Disenador = designerName;
                selectedRequestData = item;
            }
            
            // Actualizar UI
            document.querySelectorAll('.designer-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.includes(designerName)) {
                    btn.classList.add('selected');
                }
            });
            
            renderLocalTable();
    updatePaginationControls();
            openModal("‚úÖ √âxito", `Dise√±ador ${designerName} asignado`, "üë®‚Äçüé®");
        } else {
            throw new Error(data.error || "Error al asignar dise√±ador");
        }
    } catch (e) {
        console.error("Error completo:", e);
        openModal("‚ùå Error", e.message, "üí•");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function panelAdjuntarArte() {
    if (!selectedRequestId) return;
    openArteModal(selectedRequestId);
}

function panelVerArte() {
    if (!selectedRequestData?.ArteFinal) return;
    window.open(selectedRequestData.ArteFinal, '_blank');
}

async function panelEnviarTelegram() {
    if (!selectedRequestId || !selectedRequestData?.ArteFinal) return;
    
    if(!confirm("¬øEnviar el arte de " + selectedRequestId + " a Telegram?")) return;
    
    document.getElementById('loadMainTxt').innerText = "Enviando a Telegram...";
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        const params = new URLSearchParams();
        params.append("action", "sendTelegramArte");
        params.append("id", selectedRequestId);
        
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const data = await res.json();
        
        if(data.success) {
            openModal("‚úàÔ∏è Telegram", "¬°Enviado a Telegram en alta calidad!", "üì≤");
        } else {
            throw new Error(data.error);
        }
    } catch (e) {
        openModal("‚ùå Error", e.message, "üí•");
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

function panelEliminar() {
    if (!isAdmin || !selectedRequestId) return;
    deleteReq(selectedRequestId);
}

// ‚úÖ POLLING PARA SINCRONIZACI√ìN EN TIEMPO REAL
function iniciarSincronizacionPanel() {
    if (panelSyncInterval) clearInterval(panelSyncInterval);
    
    // Actualizar panel cada 30 segundos si est√° abierto
    panelSyncInterval = setInterval(() => {
        if (isPanelOpen && selectedRequestId) {
            actualizarDatosPanel();
        }
    }, 30000); // 30 segundos
}

async function actualizarDatosPanel() {
    if (!selectedRequestId) return;
    
    try {
        const params = new URLSearchParams();
        params.append("action", "getRequestData");
        params.append("id", selectedRequestId);
        
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        const data = await res.json();
        
        if (data.success && data.data) {
            // Actualizar datos locales
            const index = localData.findIndex(x => x.id == selectedRequestId);
            if (index !== -1) {
                localData[index] = data.data;
                selectedRequestData = data.data;
                updatePanelContent();
            }
        }
    } catch (e) {
        console.error("Error sincronizando panel:", e);
    }
}

// ‚úÖ FUNCIONES PARA REPORTE MENSUAL - SOLO ADMIN
function generateMonthlyReport() {
if (!isAdmin) {
openModal("‚ùå Acceso Denegado", "Solo los administradores pueden generar reportes.", "üîê");
return;
}

// Verificar que sea el primer d√≠a del mes
const today = new Date();
if (today.getDate() !== 1) {
openModal("‚è≥ No disponible", "El reporte mensual solo est√° disponible el primer d√≠a de cada mes.", "üìä");
return;
}

// ‚úÖ CONFIRMACI√ìN NATIVA DEL NAVEGADOR (SEGURA Y BLOQUEANTE)
if (!confirm("‚ö†Ô∏è ¬øCONFIRMA que desea generar el reporte mensual del mes anterior?\n" +
"‚úÖ Se enviar√° por correo y Telegram\n" +
"‚úÖ Luego se eliminar√°n SOLO las solicitudes finalizadas con fecha de registro del mes anterior\n" +
"‚ÑπÔ∏è Las solicitudes creadas HOY (1¬∞ de mes) NO ser√°n eliminadas\n" +
"‚ö†Ô∏è Esta acci√≥n es IRREVERSIBLE para las del mes anterior")) {
return;
}

document.getElementById('loadMainTxt').innerText = "Generando reporte mensual...";
document.getElementById('loadingOverlay').style.display = 'flex';

// Funcion auxiliar para esperar
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// Primero generar el reporte, LUEGO eliminar las finalizadas
fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=generateMonthlyReport&username=${encodeURIComponent(userCredentials.username)}&password=${encodeURIComponent(userCredentials.password)}`
})
.then(response => response.json())
.then(async data => {
if (data.success) {
openModal("‚úÖ Reporte Generado",
"El reporte mensual ha sido generado y enviado correctamente.\n" +
"Ahora se proceder√° a eliminar las solicitudes finalizadas del mes anterior.",
"üìä");
await delay(2000);
document.getElementById('loadMainTxt').innerText = "Eliminando solicitudes finalizadas del mes anterior...";
const deleteResponse = await fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=deleteFinalizadas&username=${encodeURIComponent(userCredentials.username)}&password=${encodeURIComponent(userCredentials.password)}`
});
const deleteData = await deleteResponse.json();
if (deleteData.success) {
openModal("‚úÖ Limpieza Completada",
`Reporte generado y ${deleteData.count || 0} solicitudes finalizadas eliminadas correctamente.`,
"üìä");
updateTable();
} else {
throw new Error(deleteData.error || "Error al limpiar solicitudes");
}
} else {
throw new Error(data.error || "Error al generar el reporte");
}
})
.catch(err => {
openModal("‚ùå Error", "Error: " + err.message, "üí•");
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}

// ‚úÖ FUNCI√ìN PARA ACTUALIZAR EL ESTADO DEL BOT√ìN DE REPORTE (HEADER Y PANEL)
function updateReportButtonStatus() {
const today = new Date();
const currentDay = today.getDate();
const totalDaysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
const btnHeader = document.getElementById('reportBtn');
const btnPanel = document.getElementById('btnReportPanel');
const textHeader = document.getElementById('reportBtnText');
const textPanel = document.getElementById('reportBtnTextPanel');
const daysHeader = document.getElementById('reportBtnDays');
const daysPanel = document.getElementById('reportBtnDaysPanel');

// Calcular d√≠as restantes
let daysRemaining;
let isAvailable = currentDay === 1;

if (currentDay === 1) {
daysRemaining = 0;
} else {
daysRemaining = totalDaysInMonth - currentDay + 1;
}

// Funci√≥n auxiliar para actualizar un bot√≥n
function updateBtn(btn, text, daysBadge, isPanel) {
if (!btn) return;

if (isAvailable) {
daysBadge.textContent = 'Hoy';
daysBadge.classList.add('show');
btn.disabled = false;
btn.style.cursor = 'pointer';
text.style.opacity = '1';
btn.style.background = 'linear-gradient(to right, #2d6a4f 100%, #1e4a35 100%)';
} else {
daysBadge.textContent = `${daysRemaining}d`;
daysBadge.classList.add('show');
btn.disabled = true;
btn.style.cursor = 'not-allowed';
text.style.opacity = '0.7';

// Calcular progreso
const progress = ((totalDaysInMonth - daysRemaining) / totalDaysInMonth) * 100;
btn.style.background = `linear-gradient(to right, #2d6a4f ${progress}%, #1e4a35 ${progress}%)`;
}
}

// Actualizar ambos botones (si existen)
updateBtn(btnHeader, textHeader, daysHeader, false);
updateBtn(btnPanel, textPanel, daysPanel, true);
}

function checkFirstDayOfMonth() {
if (isAdmin) {
// Mostrar/ocultar bot√≥n de header (legacy, ahora siempre oculto en header)
const reportBtnHeader = document.getElementById('reportBtn');
const reportBtnPanel = document.getElementById('btnReportPanel');
const maintBtn = document.getElementById('maintBtn');

// Ocultar botones del header
if (reportBtnHeader) reportBtnHeader.classList.add('hidden');
if (maintBtn) maintBtn.classList.add('hidden');

// Mostrar bot√≥n en panel
if (reportBtnPanel) reportBtnPanel.classList.remove('hidden');

updateReportButtonStatus();

// Actualizar cada minuto
if (window.reportInterval) clearInterval(window.reportInterval);
window.reportInterval = setInterval(updateReportButtonStatus, 60000);
}
}

// ‚úÖ CORRECCI√ìN CR√çTICA: Manejo de fotos con atributo data-has-image
function handleFile(input, imgId, btnId) {
  if (modoObituario) {
    input.value = "";
    return;
  }
  const file = input.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.getElementById(imgId);
      img.src = e.target.result; // "image/jpeg;base64,..."
      img.style.display = 'block';
      document.getElementById(btnId).style.display = 'block';
      // ‚úÖ MARCADOR DE IMAGEN V√ÅLIDA
      img.setAttribute('data-has-image', 'true');
    };
    reader.readAsDataURL(file);
  }
}

function clearFile(inputId, imgId, btnId) {
  if (modoObituario) return;
  document.getElementById(inputId).value = "";
  const img = document.getElementById(imgId);
  img.src = "";
  img.style.display = 'none';
  img.removeAttribute('data-has-image'); // ‚úÖ Eliminar marca de imagen v√°lida
  document.getElementById(btnId).style.display = 'none';
}

// ‚úÖ FUNCI√ìN PARA ELIMINAR field-error AUTOM√ÅTICAMENTE
function setupFieldErrorRemoval() {
  ['fecha', 'hora', 'institucion', 'direccion-exacta', 'tlf', 'mail', 'observaciones'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => el.classList.remove('field-error'));
      el.addEventListener('focus', () => el.classList.remove('field-error'));
    }
  });

  document.querySelectorAll('#region-grid .card-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('region-grid').classList.remove('field-error');
    });
  });

  const unidadGrid = document.getElementById('unidad-grid');
  const observer = new MutationObserver(() => {
    unidadGrid.querySelectorAll('.card-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('unidad-grid').classList.remove('field-error');
      });
    });
  });
  observer.observe(unidadGrid, { childList: true });

  document.querySelectorAll('#cat-grid .card-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('cat-grid').classList.remove('field-error');
    });
  });

  const cont3 = document.getElementById('cont-3');
  const observer3 = new MutationObserver(() => {
    cont3.querySelectorAll('.card-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('sec-3').classList.remove('field-error');
      });
    });

    const descOtro = document.getElementById('desc-otro');
    if (descOtro) {
      descOtro.addEventListener('input', () => document.getElementById('sec-3').classList.remove('field-error'));
      descOtro.addEventListener('focus', () => document.getElementById('sec-3').classList.remove('field-error'));
    }
  });
  observer3.observe(cont3, { childList: true, subtree: true });

  document.getElementById('btn-am').addEventListener('click', () => document.getElementById('hora-box').classList.remove('field-error'));
  document.getElementById('btn-pm').addEventListener('click', () => document.getElementById('hora-box').classList.remove('field-error'));
}

document.addEventListener('DOMContentLoaded', () => {
const regionGrid = document.getElementById('region-grid');
ORDEN_REGIONES.forEach(regionKey => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = getNombreRegionLimpio(regionKey);
btn.onclick = () => selectRegion(regionKey);
regionGrid.appendChild(btn);
});
updateTable();
setupFieldErrorRemoval();

// ‚úÖ PRECARGA INTELIGENTE EN BACKGROUND
setTimeout(() => {
    if (!DATA_CACHE.data && !DATA_CACHE.isLoading) {
        console.log("üöÄ Iniciando precarga inteligente en background...");
        updateTable();
    }
}, 2000);

// ‚úÖ INICIAR SINCRONIZACI√ìN AUTOM√ÅTICA AL CARGAR
iniciarSincronizacionPanel();

// ‚úÖ INICIALIZAR CONTROLES DE PAGINACI√ìN
updatePaginationControls();
});

function selectRegion(regionKey) {
document.querySelectorAll('#region-grid .card-btn').forEach(b => b.classList.remove('selected'));
const index = ORDEN_REGIONES.indexOf(regionKey);
if (index !== -1) {
document.querySelector(`#region-grid .card-btn:nth-child(${index + 1})`).classList.add('selected');
}
selectedRegionKey = regionKey;
selectedUnidad = "";
const unidadGrid = document.getElementById('unidad-grid');
unidadGrid.innerHTML = "";
const unidades = UNIDADES_IPASME[regionKey] || [];
unidades.forEach(unidad => {
const btn = document.createElement('div');
btn.className = 'card-btn';
btn.innerText = unidad.trim();
btn.onclick = () => selectUnidad(unidad.trim());
unidadGrid.appendChild(btn);
});
document.getElementById('unidad-section').classList.remove('hidden');
}

function selectUnidad(unidad) {
selectedUnidad = unidad.trim();
document.querySelectorAll('#unidad-grid .card-btn').forEach(b => b.classList.remove('selected'));
const clickedBtn = Array.from(document.querySelectorAll('#unidad-grid .card-btn'))
.find(b => b.innerText.trim() === selectedUnidad);
if (clickedBtn) clickedBtn.classList.add('selected');
}

// ‚úÖ FUNCI√ìN TOGGLE MODO OBITUARIO ACTUALIZADA
function toggleObituario() {
modoObituario = !modoObituario;
const btn = document.getElementById('btn-obituario');
const fechaInput = document.getElementById('fecha');
const horaInput = document.getElementById('hora');
const institucion = document.getElementById('institucion');
const direccionExacta = document.getElementById('direccion-exacta');
const observaciones = document.getElementById('observaciones');
const descOtro = document.getElementById('desc-otro'); // ‚úÖ Referencia al textarea
const uploadBoxes = document.querySelectorAll('.upload-box');
const labels = document.querySelectorAll('.upload-label');

if (modoObituario) {
btn.classList.add('obit-active');
btn.innerText = "OBITUARIO";
const hoy = new Date();
const yyyy = hoy.getFullYear();
const mm = String(hoy.getMonth() + 1).padStart(2, '0');
const dd = String(hoy.getDate()).padStart(2, '0');
fechaInput.value = `${yyyy}-${mm}-${dd}`;
fechaInput.disabled = true;
horaInput.disabled = true;
institucion.disabled = true;
direccionExacta.disabled = true;
observaciones.disabled = true;
horaInput.classList.add('obit-disabled');
institucion.classList.add('obit-disabled');
direccionExacta.classList.add('obit-disabled');
observaciones.classList.add('obit-disabled');
uploadBoxes.forEach(box => box.classList.add('obit-upload-box'));
labels.forEach(label => label.classList.add('obit-upload-label'));
horaInput.value = '';
institucion.value = '';
direccionExacta.value = '';
observaciones.value = '';

// ‚úÖ Placeholder corregido: sin "familiar"
if (descOtro) {
descOtro.placeholder = "Indique por favor nombre del fallecido, parentesco en caso de ser familiar de un trabajador del Ipasme y servicio o jurisdicci√≥n a la que pertenece el familiar o el fallecido.";
}

Array.from(document.querySelectorAll('.preview')).forEach(img => {
img.src = '';
img.style.display = 'none';
img.removeAttribute('data-has-image'); // ‚úÖ Limpiar marca de imagen v√°lida
});

Array.from(document.querySelectorAll('.remove-btn')).forEach(btn => btn.style.display = 'none');
} else {
btn.classList.remove('obit-active');
btn.innerText = "OBITUARIO";
fechaInput.disabled = false;
horaInput.disabled = false;
institucion.disabled = false;
direccionExacta.disabled = false;
observaciones.disabled = false;
horaInput.classList.remove('obit-disabled');
institucion.classList.remove('obit-disabled');
direccionExacta.classList.remove('obit-disabled');
observaciones.classList.remove('obit-disabled');
uploadBoxes.forEach(box => box.classList.remove('obit-upload-box'));
labels.forEach(label => label.classList.remove('obit-upload-label'));

// ‚úÖ Restaurar placeholder original
if (descOtro) {
descOtro.placeholder = "Detalle aqu√≠ su solicitud especial...";
}
}
}

// === FUNCIONES DE SEGURIDAD Y LIMPIEZA ===
function clearCredentials() {
document.getElementById('adminUser').value = '';
document.getElementById('adminPass').value = '';
}

function togglePass() {
const input = document.getElementById('adminPass');
input.type = input.type === 'password' ? 'text' : 'password';
}

function openModal(t, m, icon = "‚ö†Ô∏è") {
clearCredentials();
document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden'); // SIEMPRE MOSTRAR BOT√ìN X
document.getElementById('modalIcon').innerText = icon;
document.getElementById('modalTitle').innerText = t;
document.getElementById('modalMsg').innerText = m;
const btn = document.getElementById('mainModalBtn');
btn.innerText = "ENTENDIDO";
btn.onclick = closeModal;
document.getElementById('modalAlert').style.display = 'flex';
}

// CERRAR MODAL - CORREGIDA
function closeModal() {
    const modal = document.getElementById('modalAlert');
    if (!modal) return;
    
    // Reiniciar todos los elementos del modal
    clearCredentials();
    
    // Limpiar √°reas espec√≠ficas
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    if (loginArea) loginArea.classList.add('hidden');
    if (uploadArea) uploadArea.classList.add('hidden');
    
    // Restaurar botones a estado por defecto
    const mainBtn = document.getElementById('mainModalBtn');
    const closeBtn = document.getElementById('closeModalBtn');
    
    if (mainBtn) {
        mainBtn.classList.remove('hidden');
        mainBtn.innerText = "ENTENDIDO";
        mainBtn.onclick = closeModal;
        mainBtn.style.display = 'block';
    }
    
    if (closeBtn) {
        closeBtn.classList.remove('hidden');
        closeBtn.onclick = () => {
            resetChunkUploadState();
            closeModal();
        };
    }
    
    // Limpiar input de archivo
    const arteFile = document.getElementById('arteFile');
    if (arteFile) arteFile.value = '';
    
    // Limpiar ID actual
    const currentReqId = document.getElementById('currentReqId');
    if (currentReqId) currentReqId.value = '';
    
    // Ocultar modal
    modal.style.display = 'none';
    
    // Forzar reinicio de progreso si existe
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressStatus = document.getElementById('progressStatus');
    const progressInfo = document.getElementById('progressInfo');
    const progressSpeed = document.getElementById('progressSpeed');
    const progressETA = document.getElementById('progressETA');
    const btnPauseResume = document.getElementById('btnPauseResume');
    const btnCancelUpload = document.getElementById('btnCancelUpload');
    
    if (progressBar) progressBar.style.width = '0%';
    if (progressPercent) progressPercent.innerText = '0%';
    if (progressStatus) progressStatus.innerText = '';
    if (progressInfo) progressInfo.innerText = '';
    if (progressSpeed) progressSpeed.innerText = '';
    if (progressETA) progressETA.innerText = '';
    
    // Restaurar bot√≥n de pausa/reanudar
    if (btnPauseResume) {
        btnPauseResume.innerHTML = '‚è∏Ô∏è Pausar';
        btnPauseResume.style.display = 'none';
    }
    
    // Restaurar bot√≥n de cancelar
    if (btnCancelUpload) {
        btnCancelUpload.style.display = 'none';
    }
    
    // ‚úÖ OCULTAR BARRA DE PROGRESO DEL LOGIN
    const loginProgressBar = document.getElementById('loginProgressBar');
    if (loginProgressBar) {
        loginProgressBar.style.display = 'none';
        // Restaurar estilos por defecto
        const progressBarInner = document.getElementById('loginProgressBarInner');
        const progressText = document.getElementById('loginProgressText');
        const progressStatus = document.getElementById('loginProgressStatus');
        if (progressBarInner) {
            progressBarInner.style.width = '0%';
            progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
        }
        if (progressText) {
            progressText.innerText = 'Verificando credenciales...';
            progressText.style.color = '';
        }
        if (progressStatus) {
            progressStatus.innerText = 'Conectando con el servidor...';
            progressStatus.style.color = '';
        }
    }
    
    // Reiniciar estado de chunks
    resetChunkUploadState();
}

function showLogin() {
clearCredentials();
document.getElementById('modalIcon').innerText = "üîê";
document.getElementById('modalTitle').innerText = "Acceso Restringido";
document.getElementById('modalMsg').innerText = "Inicie sesi√≥n para modo administraci√≥n.";
document.getElementById('loginArea').classList.remove('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('closeModalBtn').classList.remove('hidden');
const btn = document.getElementById('mainModalBtn');
btn.innerText = "VALIDAR CREDENCIALES";
btn.onclick = validateLogin;
document.getElementById('modalAlert').style.display = 'flex';

const userField = document.getElementById('adminUser');
const passField = document.getElementById('adminPass');
const handleEnter = (e) => {
if (e.key === 'Enter') {
validateLogin();
}
};
userField.addEventListener('keydown', handleEnter);
passField.addEventListener('keydown', handleEnter);
}

// ‚úÖ LOGIN CORREGIDO (NO FALLA SI LA TABLA TARDA)
async function validateLogin() {
    if (isLoggingIn) return;
    isLoggingIn = true;
    
    // ‚úÖ OCULTAR CONTRASE√ëA AUTOM√ÅTICAMENTE ANTES DE VALIDAR
    const passField = document.getElementById('adminPass');
    if (passField.type === 'text') {
        passField.type = 'password';
    }
    
    const u = document.getElementById('adminUser').value.trim();
    const p = document.getElementById('adminPass').value.trim();
    const btn = document.getElementById('mainModalBtn');
    const originalBtnText = btn.innerText;
    
    btn.disabled = true;
    btn.innerText = "Verificando...";
    
    if (!u || !p) {
        openModal("‚ùå Error", "Complete ambos campos.", "üîê");
        isLoggingIn = false;
        btn.disabled = false;
        btn.innerText = originalBtnText;
        return;
    }
    
    // ‚úÖ MOSTRAR BARRA DE PROGRESO EN EL MODAL (en lugar de loadingOverlay)
    const progressBar = document.getElementById('loginProgressBar');
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');

    progressBar.style.display = 'block';
    progressBarInner.style.width = '0%';
    progressPercent.innerText = '0%';
    progressText.innerText = 'Verificando credenciales...';
    progressStatus.innerText = 'Conectando con el servidor...';

    // ‚úÖ SIMULAR PROGRESO ANIMADO
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBarInner.style.width = progress + '%';
            progressPercent.innerText = Math.round(progress) + '%';
            
            // Cambiar texto seg√∫n el progreso
            if (progress < 30) {
                progressStatus.innerText = 'Conectando con el servidor...';
            } else if (progress < 60) {
                progressStatus.innerText = 'Validando credenciales...';
            } else if (progress < 85) {
                progressStatus.innerText = 'Obteniendo permisos de acceso...';
            } else {
                progressStatus.innerText = 'Finalizando...';
            }
        }
    }, 300);
    
    try {
        const params = new URLSearchParams();
        params.append("action", "loginAdmin");
        params.append("username", u);
        params.append("password", p);
        
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params
        });
        
        const text = await res.text();
        let data;
        try {
            data = JSON.parse(text);
        } catch (e) {
            throw new Error("Respuesta inv√°lida del servidor");
        }
        
        if (data.success && data.data) {
            // ‚úÖ LOGIN EXITOSO - Completar barra al 100%
            clearInterval(progressInterval);
            progressBarInner.style.width = '100%';
            progressPercent.innerText = '100%';
            progressText.innerText = '¬°Acceso concedido!';
            progressStatus.innerText = 'Redirigiendo...';
            progressStatus.style.color = 'var(--verde)';
            
            // ‚úÖ LOGIN EXITOSO
            userCredentials = {
                username: u,
                password: p,
                displayName: data.data.displayName || u,
                role: data.data.role || "admin",
                designerName: data.data.designerName || ""
            };
            isAdmin = data.data.isAdmin || false;
            isDesigner = data.data.isDesigner || false;
            
            // Esperar un momento para mostrar el 100% antes de cerrar
            setTimeout(() => {
                // Actualizar UI
                document.getElementById('userNameDisplay').innerText = userCredentials.displayName + (isDesigner ? " (Dise√±ador)" : "");
                document.getElementById('welcomeMessage').classList.add('show');
                document.getElementById('authBtn').className = "btn-logout";
                document.getElementById('authBtn').innerText = "Cerrar Sesi√≥n";
                document.getElementById('authBtn').onclick = logout;
                
                // ‚úÖ MOSTRAR TAB DE ESTAD√çSTICAS PARA ADMIN Y DISE√ëADOR
                if (isAdmin || isDesigner) {
                    document.getElementById('tab-stats').classList.remove('hidden');
                }
                
                clearCredentials();
                
                // Ocultar barra de progreso y cerrar modal
                progressBar.style.display = 'none';
                closeModal();
                
                // Cargar datos en segundo plano
                DATA_CACHE.data = null;
                updateTable(true).catch(err => {
                    console.warn("Login exitoso, pero fallo carga de datos:", err);
                });
            }, 800);
            
        } else {
            throw new Error("Credenciales incorrectas");
        }
    } catch (err) {
        console.error("Error login:", err);
        
        // ‚úÖ DETENER ANIMACI√ìN Y MOSTRAR ERROR EN LA BARRA
        clearInterval(progressInterval);
        progressBarInner.style.width = '100%';
        progressBarInner.style.background = 'linear-gradient(90deg, #e63946 0%, #c62828 100%)';
        progressText.innerText = 'Error de autenticaci√≥n';
        progressText.style.color = 'var(--rojo)';
        progressPercent.innerText = '‚úï';
        progressStatus.innerText = err.message || "Error de conexi√≥n";
        progressStatus.style.color = 'var(--rojo)';
        
        clearCredentials();
        
        // Mantener visible el error por un momento, luego ocultar
        setTimeout(() => {
            progressBar.style.display = 'none';
            // Restaurar estilos para pr√≥xima vez
            progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
            progressText.style.color = '';
            progressStatus.style.color = '';
            
            openModal("‚ùå Error", err.message || "Error de conexi√≥n al validar.", "üí•");
        }, 1500);
    } finally {
        isLoggingIn = false;
        btn.disabled = false;
        btn.innerText = originalBtnText;
    }
}

// ‚úÖ FUNCI√ìN DE LOGOUT MODIFICADA
function logout() {
    // 1. Limpiar estado de autenticaci√≥n PRIMERO
    isAdmin = false;
    isDesigner = false;
    userCredentials = { username: "", password: "", displayName: "", role: "", designerName: "" };
    
    // 2. Cerrar panel si est√° abierto
    if (isPanelOpen) closeSidePanel();
    
    // 3. Limpiar selecci√≥n visual
    selectedRequestId = null;
    selectedRequestData = null;
    document.querySelectorAll('.row-selected-panel').forEach(row => {
        row.classList.remove('row-selected-panel');
    });
    
    // 4. Actualizar UI de contadores (cambiar a vista de usuario normal)
    document.getElementById('stats-panel').style.display = 'flex';
    document.getElementById('combined-stats').style.display = 'none';
    document.getElementById('count-bermina-admin').innerText = '0';
    document.getElementById('count-jorsy-admin').innerText = '0';
    document.getElementById('count-maria-admin').innerText = '0';
    document.getElementById('count-xamir-admin').innerText = '0';
    
    // 5. Limpiar b√∫squeda
    currentSearchId = "";
    isSearchActive = false;
    resetSearchHighlight();
    const searchInput = document.getElementById('searchIdInput');
    if (searchInput) searchInput.value = "";
    document.getElementById('idNotFoundModal').style.display = 'none';
    
    // 6. Actualizar UI de header
    document.getElementById('userNameDisplay').innerText = "";
    document.getElementById('welcomeMessage').classList.remove('show');
    document.getElementById('authBtn').className = "btn-login";
    document.getElementById('authBtn').innerText = "üîê Administrador";
    document.getElementById('authBtn').onclick = showLogin;
    
    // ‚úÖ OCULTAR TAB DE ESTAD√çSTICAS AL HACER LOGOUT
    document.getElementById('tab-stats').classList.add('hidden');
    
    // ‚úÖ DETENER MONITOREO DE VELOCIDAD
    stopSpeedMonitoring();
    
    clearCredentials();
    
    // 7. ‚úÖ MANTENER CACH√â LOCAL - No borrar DATA_CACHE ni PAGE_CACHE para navegaci√≥n r√°pida
    // Esto permite que el usuario siga navegando instant√°neamente despu√©s del logout
    console.log("üîÑ Logout completado - manteniendo cach√© local para navegaci√≥n r√°pida");
    
    // 8. Re-renderizar con datos existentes (r√°pido, desde cach√©)
    renderLocalTable();
    updatePaginationControls();
}

// === FUNCIONES ADMIN ===
// ABRIR MODAL DE ARTE - CORREGIDA
function openArteModal(id) {
    // Reiniciar estado antes de abrir
    resetChunkUploadState();
    
    const currentReqId = document.getElementById('currentReqId');
    const arteFile = document.getElementById('arteFile');
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    const closeBtn = document.getElementById('closeModalBtn');
    const mainBtn = document.getElementById('mainModalBtn');
    
    // Validar elementos existen
    if (!currentReqId || !arteFile || !modalIcon || !modalTitle || !modalMsg) {
        console.error("‚ùå Elementos del modal no encontrados");
        return;
    }
    
    // Limpiar y configurar
    currentReqId.value = id;
    arteFile.value = '';
    
    modalIcon.innerText = "üé®";
    modalTitle.innerText = "Adjuntar Arte Final";
    modalMsg.innerText = "Seleccione el archivo para la solicitud " + id;
    
    loginArea.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    
    closeBtn.classList.remove('hidden');
    
    // Configurar bot√≥n principal
    mainBtn.classList.remove('hidden');
    mainBtn.innerText = "SUBIR A DRIVE";
    mainBtn.onclick = uploadArte;
    mainBtn.style.display = 'block';
    
    // Mostrar modal
    document.getElementById('modalAlert').style.display = 'flex';
    
    // Forzar foco en el input de archivo
    setTimeout(() => {
        arteFile.focus();
    }, 100);
}

// ‚ùå FUNCI√ìN DE REANUDACI√ìN ELIMINADA - SIEMPRE INICIAR DESDE CERO

// SUBIR ARTE CON SISTEMA DE CHUNKS (SIN REANUDACI√ìN)
async function uploadArte() {
    // ‚úÖ REINICIAR ESTADO SIEMPRE (SIN VERIFICAR REANUDACI√ìN)
    resetChunkUploadState();
    
    const fileInput = document.getElementById('arteFile');
    const id = document.getElementById('currentReqId')?.value;
    
    if (!fileInput || !id) {
        openModal("‚ùå Error", "Datos del formulario incompletos.", "‚ö†Ô∏è");
        return;
    }
    
    if (fileInput.files.length === 0) {
        openModal("üìé Advertencia", "Por favor seleccione un archivo.", "üìÅ");
        return;
    }
    
    const file = fileInput.files[0];
    const fileSizeMB = file.size / (1024 * 1024);
    
    // Validar tama√±o m√°ximo
    if (file.size > 6 * 1024 * 1024) {
        openModal("üìè Tama√±o Excedido", "El archivo excede los 6MB permitidos.", "‚ö†Ô∏è");
        return;
    }
    
    // ‚úÖ MOSTRAR MODAL DE PROGRESO
    showUploadProgressModal(id, file.name, fileSizeMB);
    
    try {
        // Detectar velocidad de conexi√≥n
        document.getElementById('progressStatus').innerText = 'üì° Detectando velocidad de conexi√≥n...';
        await detectConnectionSpeed();
        
        // ‚úÖ NUEVA L√ìGICA: SIN REANUDACI√ìN, SIEMPRE DESDE CERO
        if (file.size <= 1024 * 1024) {
            // Archivos ‚â§1MB: siempre subir completo (sin chunks)
            document.getElementById('progressStatus').innerText = 'üöÄ Subiendo archivo completo...';
            await uploadFileNormal(file, id);
            return;
        }
        
        if (chunkUpload.connectionSpeed === 'fast' || chunkUpload.connectionSpeed === 'ultra-fast') {
            // Conexi√≥n r√°pida: subir completo incluso si >1MB
            document.getElementById('progressStatus').innerText = 'üöÄ Subiendo archivo completo (conexi√≥n r√°pida)...';
            await uploadFileNormal(file, id);
            return;
        }
        
        // ‚úÖ ARCHIVOS GRANDES CON CONEXI√ìN LENTA: CHUNKS SIN REANUDACI√ìN
        document.getElementById('progressStatus').innerText = `üì¶ Fragmentando en chunks...`;
        
        // Dividir en chunks
        const chunks = splitFileIntoChunks(file);
        chunkUpload.chunks = chunks;
        chunkUpload.totalChunks = chunks.length;
        chunkUpload.currentChunk = 0;
        chunkUpload.uploadedChunks = 0; // ‚úÖ SIEMPRE DESDE 0
        chunkUpload.startTime = Date.now();
        chunkUpload.isActive = true;
        
        document.getElementById('progressInfo').innerText =
            `Archivo: ${file.name} (${fileSizeMB.toFixed(2)}MB) - SUBIDA COMPLETA`;
        document.getElementById('progressSpeed').innerText =
            `Conexi√≥n: ${chunkUpload.connectionSpeed} | Chunk: ${(chunkUpload.chunkSize / 1024).toFixed(0)}KB`;
        
        // Subir chunks secuencialmente
        await uploadChunksSequential(id, file.name, file.type);
        
    } catch (error) {
        console.error('Error en uploadArte:', error);
        document.getElementById('loadingOverlay').style.display = 'none';
        
        // ‚úÖ EN CASO DE ERROR, CANCELAR Y LIMPIAR TODO
        await cancelUpload();
        
        openModal("‚ùå Error", "Error al subir: " + error.message + "\n\nTodos los recursos temporales han sido eliminados.", "üí•");
    }
}

// SUBIR ARCHIVO NORMAL (menor a 2MB)
async function uploadFileNormal(file, id) {
    const reader = new FileReader();
    
    return new Promise((resolve, reject) => {
        reader.onload = async function(e) {
            const base64 = e.target.result.split(',')[1];
            
            try {
                const params = new URLSearchParams();
                params.append("action", "uploadArte");
                params.append("id", id);
                params.append("filename", file.name);
                params.append("file", base64);
                params.append("mime", file.type);
                params.append("uploadedBy", userCredentials.displayName);
                params.append("isChunked", "false");
                
                const res = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: params 
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressPercent').innerText = '100%';
                    setTimeout(() => {
                        closeModal();
                        openModal("‚úÖ √âxito", "¬°Arte subido con √©xito!", "üé®");
                        updateTable();
                    }, 500);
                    resolve();
                } else {
                    reject(new Error(data.error));
                }
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo archivo"));
        reader.readAsDataURL(file);
    });
}

async function sendTelegramArte(id) {
const req = localData.find(x => x.id == id);

if(!confirm("¬øEnviar el arte de " + id + " a Telegram?")) return;

document.getElementById('loadMainTxt').innerText = "Enviando a Telegram...";
document.getElementById('loadingOverlay').style.display = 'flex';

try {
const params = new URLSearchParams();
params.append("action", "sendTelegramArte");
params.append("id", id);

const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
const data = await res.json();

if(data.success) {
openModal("‚úàÔ∏è Telegram", "¬°Enviado a Telegram en alta calidad!", "üì≤");
setTimeout(() => closeModal(), 2000);
} else {
openModal("‚ùå Error", "Error: " + data.error, "üí•");
}
} catch (e) {
openModal("‚ùå Error", "Error de conexi√≥n.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}

async function toggleMaintMode() {
if (!isAdmin) return;

const nuevoEstado = !isMaintActive;
document.getElementById('loadingOverlay').style.display = 'flex';

try {
await fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: `action=setMaintenance&status=${nuevoEstado}`
});

isMaintActive = nuevoEstado;
openModal(
"‚öôÔ∏è Modo Mantenimiento",
"Modo mantenimiento " + (nuevoEstado ? "ACTIVADO" : "DESACTIVADO") + ".",
"üõ†Ô∏è"
);
setTimeout(() => location.reload(), 1500);
} catch (e) {
openModal("‚ùå Error", "Error al cambiar estado del mantenimiento.", "üí•");
} finally {
document.getElementById('loadingOverlay').style.display = 'none';
}
}

// === ELIMINACI√ìN CON MODALES PERSONALIZADOS ===
let currentDeleteId = null;
let isDeleting = false;

function deleteReq(id) {
if (!isAdmin) {
openModal("‚ùå Acceso Denegado", "Solo los administradores pueden eliminar solicitudes.", "üîê");
return;
}

currentDeleteId = id;
showDeleteConfirm(1);
}

function showDeleteConfirm(step) {
const id = currentDeleteId;
if (step === 1) {
openCustomModal(
"üóëÔ∏è Confirmar Eliminaci√≥n",
`¬øEst√° seguro de eliminar la solicitud <b>${id}</b>?`,
() => showDeleteConfirm(2),
() => closeModal()
);
} else if (step === 2) {
// ‚úÖ SEGUNDO MODAL CON BARRA DE PROGRESO (estilo login)
showDeleteProgressModal(id);
}
}

function openCustomModal(title, message, onConfirm, onCancel) {
document.getElementById('modalIcon').innerText = "‚ùì";
document.getElementById('modalTitle').innerText = title;
document.getElementById('modalMsg').innerHTML = message;
const mainBtn = document.getElementById('mainModalBtn');
const altBtn = document.getElementById('closeModalBtn');

mainBtn.innerText = "S√ç, ACEPTAR";
mainBtn.onclick = () => { closeModal(); if (onConfirm) onConfirm(); };
altBtn.classList.remove('hidden'); // Asegurar que sea visible
altBtn.innerText = "CANCELAR";
altBtn.onclick = () => { closeModal(); if (onCancel) onCancel(); };

document.getElementById('loginArea').classList.add('hidden');
document.getElementById('uploadArea').classList.add('hidden');
document.getElementById('modalAlert').style.display = 'flex';
}

// ‚úÖ NUEVO: Modal de progreso de eliminaci√≥n (similar al login)
function showDeleteProgressModal(id) {
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    const closeBtn = document.getElementById('closeModalBtn');
    const mainBtn = document.getElementById('mainModalBtn');

    // Configurar contenido del modal
    modalIcon.innerText = "üóëÔ∏è";
    modalTitle.innerText = "Eliminando Solicitud";
    modalMsg.innerHTML = `Eliminando permanentemente la solicitud <b>${id}</b>...<br><span style="color: #e63946; font-weight: 600;">‚ö†Ô∏è Esta acci√≥n es irreversible</span>`;
    
    // Ocultar √°reas no necesarias
    loginArea.classList.add('hidden');
    uploadArea.classList.add('hidden');
    
    // Configurar bot√≥n principal (deshabilitado durante eliminaci√≥n)
    mainBtn.innerText = "ELIMINANDO...";
    mainBtn.disabled = true;
    mainBtn.classList.remove('hidden');
    mainBtn.style.display = 'block';
    
    // Configurar bot√≥n de cerrar (oculto durante eliminaci√≥n)
    closeBtn.classList.add('hidden');
    
    // ‚úÖ MOSTRAR BARRA DE PROGRESO (mismo estilo que login)
    const progressBar = document.getElementById('loginProgressBar');
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');

    progressBar.style.display = 'block';
    progressBarInner.style.width = '0%';
    progressPercent.innerText = '0%';
    progressText.innerText = 'Iniciando eliminaci√≥n...';
    progressStatus.innerText = 'Conectando con el servidor...';
    
    // Restaurar colores por si acaso
    progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
    progressText.style.color = '';
    progressStatus.style.color = '';

    // Mostrar modal
    document.getElementById('modalAlert').style.display = 'flex';
    
    // ‚úÖ INICIAR ANIMACI√ìN DE PROGRESO
    // Peque√±o retraso para asegurar que el DOM est√© listo
    setTimeout(() => {
        startDeleteProgressAnimation(id);
    }, 100);
}

// ‚úÖ ANIMACI√ìN DE PROGRESO PARA ELIMINACI√ìN
function startDeleteProgressAnimation(id) {
    let progress = 0;
    let phase = 'connecting'; // connecting, deleting, finalizing
    
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');
    
    // Validar que los elementos existan
    if (!progressBarInner || !progressPercent || !progressText || !progressStatus) {
        console.error("‚ùå Elementos de la barra de progreso no encontrados");
        completeDeleteAnimation(false, id, "Error en la interfaz de progreso");
        return;
    }
    
    // Fases de la eliminaci√≥n con tiempos diferentes
    const phases = {
        connecting: { target: 25, speed: 15, text: 'Conectando con el servidor...', status: 'Estableciendo conexi√≥n segura' },
        deleting: { target: 75, speed: 8, text: 'Eliminando solicitud...', status: 'Removiendo datos de la base de datos' },
        finalizing: { target: 90, speed: 5, text: 'Finalizando...', status: 'Limpiando archivos adjuntos' },
        complete: { target: 100, speed: 20, text: '¬°Completado!', status: 'Solicitud eliminada permanentemente' }
    };
    
    const animateProgress = () => {
        // ‚úÖ CORRECCI√ìN: La condici√≥n debe ser isDeleting (no !isDeleting)
        if (isDeleting && progress < 100) {
            const currentPhase = phases[phase];
            
            // Avanzar progreso
            if (progress < currentPhase.target) {
                progress += Math.random() * currentPhase.speed;
                if (progress > currentPhase.target) progress = currentPhase.target;
            }
            
            // Actualizar UI
            progressBarInner.style.width = progress + '%';
            progressPercent.innerText = Math.round(progress) + '%';
            progressText.innerText = currentPhase.text;
            progressStatus.innerText = currentPhase.status;
            
            // Cambiar de fase
            if (progress >= currentPhase.target && phase !== 'complete') {
                switch(phase) {
                    case 'connecting': 
                        phase = 'deleting'; 
                        // Iniciar la eliminaci√≥n real cuando llegamos a 25%
                        executeRealDelete(id);
                        break;
                    case 'deleting': phase = 'finalizing'; break;
                    case 'finalizing': phase = 'complete'; break;
                }
            }
            
            if (progress < 100) {
                requestAnimationFrame(animateProgress);
            }
        }
    };
    
    isDeleting = true;
    requestAnimationFrame(animateProgress);
}

// ‚úÖ EJECUCI√ìN REAL DE ELIMINACI√ìN (llamada al servidor)
async function executeRealDelete(id) {
    try {
        const params = new URLSearchParams();
        params.append("action", "delete");
        params.append("id", id);
        params.append("username", userCredentials.username);
        params.append("password", userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: params 
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Completar animaci√≥n hasta 100%
            completeDeleteAnimation(true, id);
        } else {
            throw new Error(data.error || "Error al eliminar la solicitud");
        }
    } catch (e) {
        completeDeleteAnimation(false, id, e.message);
    }
}

// ‚úÖ COMPLETAR ANIMACI√ìN DE ELIMINACI√ìN
function completeDeleteAnimation(success, id, errorMessage = '') {
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressPercent = document.getElementById('loginProgressPercent');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');
    const mainBtn = document.getElementById('mainModalBtn');
    const closeBtn = document.getElementById('closeModalBtn');
    
    // Validar que los elementos existan
    if (!progressBarInner || !progressPercent || !progressText || !progressStatus || !mainBtn || !closeBtn) {
        console.error("‚ùå Elementos del modal no encontrados en completeDeleteAnimation");
        // Forzar cierre del modal y limpieza
        setTimeout(() => {
            closeModal();
            resetDeleteState();
        }, 1000);
        return;
    }
    
    // Completar barra al 100%
    progressBarInner.style.width = '100%';
    progressPercent.innerText = '100%';
    
    if (success) {
        // ‚úÖ √âXITO - Verde
        progressBarInner.style.background = 'linear-gradient(90deg, #2d6a4f 0%, #40916c 50%, #52b788 100%)';
        progressText.innerText = '¬°Eliminaci√≥n exitosa!';
        progressText.style.color = 'var(--verde)';
        progressStatus.innerText = 'La solicitud ha sido eliminada permanentemente';
        progressStatus.style.color = 'var(--verde)';
        
        // Actualizar datos locales
        localData = localData.filter(x => x.id != id);
        
        // Si la eliminada es la seleccionada, cerrar panel
        if (selectedRequestId === id) {
            closeSidePanel();
            selectedRequestId = null;
            selectedRequestData = null;
        }
        
        renderLocalTable();
        updatePaginationControls();
        
        // Cambiar bot√≥n a "Aceptar"
        setTimeout(() => {
            mainBtn.innerText = "ENTENDIDO";
            mainBtn.disabled = false;
            mainBtn.onclick = () => {
                closeModal();
                // Limpiar estado
                setTimeout(() => {
                    const progressBar = document.getElementById('loginProgressBar');
                    if (progressBar) progressBar.style.display = 'none';
                    resetDeleteState();
                }, 300);
            };
            
            // Mostrar bot√≥n de cerrar tambi√©n
            closeBtn.classList.remove('hidden');
            closeBtn.innerText = "CERRAR";
            closeBtn.onclick = () => {
                closeModal();
                setTimeout(() => {
                    const progressBar = document.getElementById('loginProgressBar');
                    if (progressBar) progressBar.style.display = 'none';
                    resetDeleteState();
                }, 300);
            };
        }, 800);
        
    } else {
        // ‚ùå ERROR - Rojo
        progressBarInner.style.background = 'linear-gradient(90deg, #e63946 0%, #c62828 100%)';
        progressText.innerText = 'Error al eliminar';
        progressText.style.color = 'var(--rojo)';
        progressStatus.innerText = errorMessage || 'No se pudo completar la eliminaci√≥n';
        progressStatus.style.color = 'var(--rojo)';
        
        // Cambiar bot√≥n a reintentar
        setTimeout(() => {
            mainBtn.innerText = "REINTENTAR";
            mainBtn.disabled = false;
            mainBtn.onclick = () => {
                resetDeleteState();
                showDeleteProgressModal(id);
            };
            
            closeBtn.classList.remove('hidden');
            closeBtn.innerText = "CANCELAR";
            closeBtn.onclick = () => {
                closeModal();
                setTimeout(() => {
                    const progressBar = document.getElementById('loginProgressBar');
                    if (progressBar) progressBar.style.display = 'none';
                    resetDeleteState();
                }, 300);
            };
        }, 800);
    }
    
    isDeleting = false;
}

// ‚úÖ REINICIAR ESTADO DE ELIMINACI√ìN
function resetDeleteState() {
    isDeleting = false;
    currentDeleteId = null;
    
    // Restaurar estilos de la barra
    const progressBarInner = document.getElementById('loginProgressBarInner');
    const progressText = document.getElementById('loginProgressText');
    const progressStatus = document.getElementById('loginProgressStatus');
    
    if (progressBarInner) {
        progressBarInner.style.background = 'linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 50%, var(--azul-deep) 100%)';
    }
    if (progressText) progressText.style.color = '';
    if (progressStatus) progressStatus.style.color = '';
}

// ‚úÖ FUNCI√ìN executeDelete ORIGINAL (ya no se usa directamente, se reemplaza por executeRealDelete)
// Mantener por compatibilidad pero marcar como obsoleta
async function executeDelete() {
    console.warn("executeDelete est√° obsoleto, usar showDeleteProgressModal");
    // Redirigir al nuevo flujo si se llama directamente
    if (currentDeleteId) {
        showDeleteProgressModal(currentDeleteId);
    }
}

// === FIN ELIMINACI√ìN ===

// === FIN FUNCIONES ADMIN ===

// === FUNCIONES GENERALES ===
function setAMPM(val) {
if (modoObituario) return;
selectedAMPM = val;
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
document.getElementById(val === 'a. m.' ? 'btn-am' : 'btn-pm').classList.add('active');
document.getElementById('hora-box').classList.remove('field-error');
}

// MODIFICACI√ìN EN selectCat: reiniciar modoObituario si cambia de categor√≠a Y AGREGAR SOPORTE PARA PEDI√ÅTRICA
function selectCat(btn, tipo) {
if (modoObituario && tipo !== 'otros') {
modoObituario = false;
const obitBtn = document.getElementById('btn-obituario');
if (obitBtn) {
obitBtn.classList.remove('obit-active');
obitBtn.innerText = "OBITUARIO";
document.getElementById('fecha').disabled = false;
document.getElementById('hora').disabled = false;
document.getElementById('institucion').disabled = false;
document.getElementById('direccion-exacta').disabled = false;
document.getElementById('observaciones').disabled = false;
document.getElementById('hora').classList.remove('obit-disabled');
document.getElementById('institucion').classList.remove('obit-disabled');
document.getElementById('direccion-exacta').classList.remove('obit-disabled');
document.getElementById('observaciones').classList.remove('obit-disabled');
document.querySelectorAll('.upload-box').forEach(box => box.classList.remove('obit-upload-box'));
document.querySelectorAll('.upload-label').forEach(label => label.classList.remove('obit-upload-label'));

// Limpiar marcas de im√°genes
Array.from(document.querySelectorAll('.preview')).forEach(img => {
img.removeAttribute('data-has-image');
});
}
}

document.querySelectorAll('#cat-grid .card-btn').forEach(b => b.classList.remove('selected'));
btn.classList.add('selected');
catName = btn.innerText;
catType = tipo;
document.getElementById('cat-grid').classList.remove('field-error');

const s3 = document.getElementById('sec-3');
const s4 = document.getElementById('sec-4');
const c3 = document.getElementById('cont-3');
const c4 = document.getElementById('cont-4');

s3.classList.remove('hidden');
s4.classList.add('hidden');
c3.innerHTML = "";
c4.innerHTML = "";

if (['escuela', 'integral', 'conjunta'].includes(tipo)) {
document.getElementById('label-3').innerText = "ü©∫ 3. ESPECIALIDADES M√âDICAS *";
renderList(c3, DATA.especialidades);
s4.classList.remove('hidden');
renderList(c4, DATA.servicios);
} else if (tipo === 'vacuna') {
document.getElementById('label-3').innerText = "üíâ 3. LISTA DE VACUNAS *";
renderList(c3, DATA.vacunas);
} else if (tipo === 'quirurgica') {
document.getElementById('label-3').innerText = "üî™ 3. PATOLOG√çAS QUIR√öRGICAS *";
renderList(c3, DATA.quirurgica);
} else if (tipo === 'pediatrica') {
document.getElementById('label-3').innerText = "üë∂ 3. PATOLOG√çAS PEDI√ÅTRICAS *";
renderList(c3, DATA.pediatrica);
} else if (tipo === 'oftalmo') {
document.getElementById('label-3').innerText = "üëÅÔ∏è 3. PATOLOG√çAS OFTALMOL√ìGICAS *";
renderList(c3, DATA.oftalmo);
} else {
document.getElementById('label-3').innerText = "‚ú® 3. DESCRIPCI√ìN DEL REQUERIMIENTO *";
c3.innerHTML = '<textarea id="desc-otro" class="modern-input" rows="3" style="grid-column: 1 / -1;" placeholder="Detalle aqu√≠ su solicitud especial..."></textarea>';
c3.innerHTML += `
<div style="display: flex; align-items: center; gap: 12px; margin-top: 12px; flex-wrap: wrap; grid-column: 1 / -1;">
<button type="button" id="btn-obituario" class="btn-time" style="background: #f8f9fa; border-color: var(--gris); color: var(--azul-deep); width: 120px; padding: 8px;"
onclick="toggleObituario()">
OBITUARIO
</button>
<div style="flex: 1; min-width: 200px; background: #fff8e1; border: 1px solid #ffe082; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; color: #5d4600; font-weight: 600; line-height: 1.3;">
‚ö†Ô∏è Activar este modo elimina el requerimiento de 48 horas.
√öselo con moderaci√≥n.
</div>
</div>`;
}
}

function renderList(cont, list) {
list.forEach(i => {
const d = document.createElement('div');
d.className = 'card-btn';
d.innerText = i;
d.onclick = () => {
d.classList.toggle('selected');
document.getElementById('sec-3').classList.remove('field-error');
};
cont.appendChild(d);
});
}

function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top: 0, behavior: 'smooth'});
  if(btn) btn.classList.add('active');
  else document.getElementById('tab-' + id.split('-')[0]).classList.add('active');
  if(id === 'list-page') updateTable();
}

// ‚úÖ FUNCI√ìN updateTable - CORREGIDA CON CACHE DE P√ÅGINAS
async function updateTable(forceRefresh = false) {
  const now = Date.now();
  
  // ‚úÖ CORRECCI√ìN: Verificar si el cache tiene los datos correctos
  const serverCacheTimestamp = parseInt(DATA_CACHE.serverTimestamp || "0");
  
  if (!forceRefresh && DATA_CACHE.data && (now - DATA_CACHE.timestamp) < DATA_CACHE.ttl) {
    // Verificar si el cache tiene el totalRecords correcto
    if (DATA_CACHE.totalRecords && DATA_CACHE.totalRecords > localData.length) {
      console.log("üíæ Usando cach√© local con totalRecords:", DATA_CACHE.totalRecords);
      localData = DATA_CACHE.data;
      PAGINATION.totalRecords = DATA_CACHE.totalRecords;
      
      // ‚úÖ Guardar p√°gina actual en cach√© de p√°ginas
      PAGE_CACHE.setPage(PAGINATION.currentPage, {
        rows: [...localData],
        stats: DATA_CACHE.stats
      });
      
      if(DATA_CACHE.stats) updateCounters(DATA_CACHE.stats);
      renderLocalTable();
      
      // Pre-cargar p√°ginas adyacentes
      preloadAdjacentPages(PAGINATION.currentPage);
      
      return;
    }
  }
  
  if (DATA_CACHE.isLoading) {
    await DATA_CACHE.pendingPromise;
    return;
  }
  
  DATA_CACHE.isLoading = true;
  DATA_CACHE.pendingPromise = fetchTableData();
  
  try {
    const result = await DATA_CACHE.pendingPromise;
    
    // ‚úÖ GUARDAR totalRecords EN EL CACHE
    DATA_CACHE.data = result.rows;
    DATA_CACHE.stats = result.stats;
    DATA_CACHE.serverTimestamp = result.cacheTimestamp || now;
    DATA_CACHE.timestamp = now;
    DATA_CACHE.totalRecords = result.totalRecords; // ‚úÖ GUARDAR TOTAL REAL
    
    localData = result.rows;
    PAGINATION.totalRecords = result.totalRecords; // ‚úÖ ACTUALIZAR GLOBAL
    
    // ‚úÖ Guardar p√°gina actual en cach√© de p√°ginas
    PAGE_CACHE.setPage(PAGINATION.currentPage, {
      rows: [...result.rows],
      stats: result.stats
    });
    
    if (result.stats) {
      updateCounters(result.stats);
    }
    
    renderLocalTable();
    
    // Pre-cargar p√°ginas adyacentes
    preloadAdjacentPages(PAGINATION.currentPage);
    
  } catch (e) {
    console.error("Error cargando tabla:", e);
    openModal("‚ùå Error", "No se pudieron cargar los datos: " + e.message, "‚ö†Ô∏è");
  } finally {
    DATA_CACHE.isLoading = false;
    DATA_CACHE.pendingPromise = null;
  }
}

// ‚úÖ FUNCI√ìN DE CARGA DE DATOS - CORREGIDA PARA PAGINACI√ìN
async function fetchTableData() {
  try {
    const params = new URLSearchParams();
    params.append("action", "read");
    params.append("page", PAGINATION.currentPage.toString());
    params.append("limit", PAGINATION.limit.toString());
    
    console.log("üì§ Solicitando p√°gina", PAGINATION.currentPage, "con l√≠mite", PAGINATION.limit);
    
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });
    
    const responseText = await res.text();
    console.log("üìÑ Respuesta cruda (primeros 500 chars):", responseText.substring(0, 500));
    
    let response;
    try {
      response = JSON.parse(responseText);
    } catch (e) {
      console.error("‚ùå No es JSON v√°lido:", responseText);
      throw new Error("El servidor no respondi√≥ con datos v√°lidos");
    }
    
    console.log("‚úÖ Respuesta parseada:", response);
    
    if (!response.success) {
      throw new Error(response.error || "Error del servidor");
    }
    
    const data = response.data || response;
    
    // ‚úÖ CORRECCI√ìN CR√çTICA: Extraer totalRecords de la paginaci√≥n del servidor
    let totalRecords = 0;
    if (data.pagination && data.pagination.totalRecords) {
      totalRecords = parseInt(data.pagination.totalRecords);
      console.log("üìä Total records desde servidor:", totalRecords);
    } else if (data.totalRecords) {
      totalRecords = parseInt(data.totalRecords);
      console.log("üìä Total records desde data.totalRecords:", totalRecords);
    } else {
      // Fallback: si no hay paginaci√≥n, usar la longitud de los datos
      totalRecords = (data.rows || []).length;
      console.log("‚ö†Ô∏è No hay paginaci√≥n, usando length:", totalRecords);
    }
    
    // ‚úÖ ACTUALIZAR PAGINACI√ìN GLOBAL
    PAGINATION.totalRecords = totalRecords;
    PAGINATION.totalPages = Math.ceil(totalRecords / PAGINATION.limit) || 1;
    
    console.log(`üìä Paginaci√≥n calculada: ${PAGINATION.totalPages} p√°ginas de ${PAGINATION.limit} registros cada una`);
    
    return {
      rows: data.rows || [],
      stats: data.stats || null,
      cacheTimestamp: data.cacheTimestamp || Date.now(),
      totalRecords: totalRecords
    };
    
  } catch (error) {
    console.error("‚ùå Error en fetchTableData:", error);
    throw error;
  }
}

function buildDataIndexes() {
    DATA_INDEX.byId.clear();
    DATA_INDEX.byStatus.clear();
    DATA_INDEX.byDesigner.clear();
    
    localData.forEach((item, idx) => {
        DATA_INDEX.byId.set(item.id, { item, index: idx });
        
        const status = (item.Estatus || "").toUpperCase().trim();
        if (!DATA_INDEX.byStatus.has(status)) {
            DATA_INDEX.byStatus.set(status, []);
        }
        DATA_INDEX.byStatus.get(status).push(item);
        
        if (item.Disenador) {
            if (!DATA_INDEX.byDesigner.has(item.Disenador)) {
                DATA_INDEX.byDesigner.set(item.Disenador, []);
            }
            DATA_INDEX.byDesigner.get(item.Disenador).push(item);
        }
    });
    
    console.log(` √çndices construidos: ${DATA_INDEX.byId.size} registros`);
}

// VALIDACI√ìN EN ORDEN CORRECTO
function validateForm() {
const fieldsInOrder = [];

fieldsInOrder.push({
id: 'region-grid',
isValid: () => !!selectedRegionKey,
label: 'Regi√≥n'
});

fieldsInOrder.push({
id: 'unidad-grid',
isValid: () => !!selectedUnidad,
label: 'Unidad M√©dica'
});

fieldsInOrder.push({
id: 'cat-grid',
isValid: () => !!catName,
label: 'Tipo de Jornada'
});

fieldsInOrder.push({
id: 'sec-3',
isValid: () => {
if (catType === 'otros') {
return document.getElementById('desc-otro')?.value.trim() !== '';
} else {
return document.querySelectorAll('#cont-3 .card-btn.selected').length > 0;
}
},
label: 'Detalle'
});

fieldsInOrder.push({
id: 'fecha',
isValid: () => {
const val = document.getElementById('fecha').value;
return !!val;
},
label: 'Fecha de Actividad'
});

if (!modoObituario) {
fieldsInOrder.push({
id: 'hora',
isValid: () => {
const val = document.getElementById('hora').value.trim();
return !!val;
},
label: 'Hora de Inicio'
});

fieldsInOrder.push({
id: 'hora-box',
isValid: () => !!selectedAMPM,
label: 'Formato AM/PM'
});

fieldsInOrder.push({
id: 'institucion',
isValid: () => {
const val = document.getElementById('institucion').value.trim();
return !!val;
},
label: 'Instituci√≥n'
});
}

fieldsInOrder.push({
id: 'mail',
isValid: () => {
const val = document.getElementById('mail').value.trim();
return val && val.includes('@');
},
label: 'Correo Electr√≥nico'
});

for (const field of fieldsInOrder) {
const el = document.getElementById(field.id);
if (!field.isValid()) {
el?.classList.add('field-error');
el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
openModal("‚ùå Campo Faltante", `Falta completar: ${field.label}`, "‚ö†Ô∏è");
return false;
}
}

if (!modoObituario) {
const fechaInput = document.getElementById('fecha').value;
const fechaSeleccionada = new Date(fechaInput + 'T00:00:00');
const ahora = new Date();

// VALIDACI√ìN INTERNA: 24 HORAS (texto mantiene 48 para usuario)
if ((fechaSeleccionada - ahora) / (1000 * 60 * 60) < 24) {
document.getElementById('fecha').classList.add('field-error');
openModal("‚è≥ Restricci√≥n de Tiempo", "Las solicitudes deben realizarse con al menos 48 horas de anticipaci√≥n.", "‚è∞");
return false;
}
}

return true;
}

function showConfirmationModal() {
if (!validateForm()) return;

const preview = document.getElementById('previewContent');
let html = `
<p><b>üìç Regi√≥n:</b> ${getNombreRegionLimpio(selectedRegionKey)}</p>
<p><b>üè• Unidad M√©dica:</b> ${selectedUnidad}</p>
`;

if (modoObituario) {
html += `<p><b>üìã Tipo de Solicitud:</b> Obituario</p>`;
} else {
html += `<p><b>üìÇ Tipo de Jornada:</b> ${catName}</p>`;
}

if (catType === 'otros' && !modoObituario) {
html += `<p><b>‚ú® Descripci√≥n:</b> ${document.getElementById('desc-otro').value.trim()}</p>`;
} else if (!modoObituario) {
const selectedOps = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el => el.innerText).join(', ');
html += `<p><b>ü©∫ Detalle:</b> ${selectedOps || 'Ninguno'}</p>`;
}

const servicios = Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el => el.innerText).join(', ');
if (servicios) html += `<p><b>‚ú® Servicios Adicionales:</b> ${servicios}</p>`;

const [year, month, day] = document.getElementById('fecha').value.split('-');
const fechaFormateada = `${day}/${month}/${year}`;
html += `<p><b>üìÖ Fecha de Actividad:</b> ${fechaFormateada}</p>`;

if (!modoObituario) {
html += `<p><b>‚è∞ Hora de Inicio:</b> ${document.getElementById('hora').value} ${selectedAMPM}</p>`;
const institucion = document.getElementById('institucion').value.trim();
const direccion = document.getElementById('direccion-exacta').value.trim();
html += `<p><b>üß≠ Ubicaci√≥n:</b> ${[institucion, direccion].filter(x => x).join(', ')}</p>`;
html += `<p><b>üì± Tel√©fono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>`;
html += `<p><b>‚úâÔ∏è Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>`;

const obs = document.getElementById('observaciones').value.trim();
if (obs) html += `<p><b>‚úèÔ∏è Observaciones:</b> ${obs}</p>`;

// CORREGIDO: Contar fotos usando el atributo data-has-image
const fotos = [1,2,3].filter(i => {
const img = document.getElementById(`p${i}`);
return img.getAttribute('data-has-image') === 'true';
});
html += `<p><b>üì∏ Soportes Fotogr√°ficos:</b> ${fotos.length > 0 ? `${fotos.length} foto(s) adjunta(s)` : 'Ninguno'}</p>`;
} else {
html += `<p><b>üì± Tel√©fono:</b> ${document.getElementById('tlf').value || 'No indicado'}</p>`;
html += `<p><b>‚úâÔ∏è Correo:</b> ${document.getElementById('mail').value || 'No indicado'}</p>`;
html += `<p><b>‚ÑπÔ∏è Modo Obituario activado ‚Äì Campos opcionales omitidos.</b></p>`;
}

preview.innerHTML = html;
document.getElementById('confirmModal').style.display = 'flex';

let timeLeft = 10;
document.getElementById('countdown').innerText = timeLeft;
const btnEnviar = document.getElementById('btnEnviarConfirmado');
btnEnviar.disabled = true;
btnEnviar.classList.remove('enviar');
btnEnviar.classList.add('corregir');

const btnCorregir = document.getElementById('btnCorregir');
btnCorregir.onmouseenter = () => {
btnCorregir.style.background = "#d1d5db";
btnCorregir.style.color = "#212529";
};
btnCorregir.onmouseleave = () => {
btnCorregir.style.background = "var(--gris)";
btnCorregir.style.color = "var(--azul-deep)";
};

const timer = setInterval(() => {
timeLeft--;
document.getElementById('countdown').innerText = timeLeft;
const progress = ((10 - timeLeft) / 10) * 100;
btnEnviar.style.background = `linear-gradient(to right, var(--turquesa) ${progress}%, #e9ecef ${progress}%)`;
btnEnviar.style.color = timeLeft <= 3 ? "white" : "#495057";

if (timeLeft <= 0) {
clearInterval(timer);
btnEnviar.disabled = false;
btnEnviar.classList.remove('corregir');
btnEnviar.classList.add('enviar');
btnEnviar.style.background = "var(--turquesa)";
btnEnviar.style.color = "white";
btnEnviar.style.cursor = "pointer";

// ‚ú® APLICAR TEXTO EN DOS L√çNEAS
btnEnviar.innerHTML = `<div class="btn-text"><span>Haz clic para enviar</span><span>la solicitud</span></div>`;

// ‚ú® APLICAR ANIMACI√ìN DE PULSOS
btnEnviar.classList.add('btn-send-pulse');

// ‚ú® REPRODUCIR SONIDO
const sound = document.getElementById('notificationSound');
if (sound) {
sound.currentTime = 0;
sound.play().catch(e => console.log("Sonido no reproducido:", e));
}

// ‚ú® EFECTOS HOVER M√ÅS SUAVES
btnEnviar.onmouseenter = () => {
btnEnviar.style.transform = "scale(1.03)";
btnEnviar.style.boxShadow = "0 6px 20px rgba(2, 48, 71, 0.4)";
};
btnEnviar.onmouseleave = () => {
btnEnviar.style.transform = "scale(1)";
btnEnviar.style.boxShadow = "0 4px 15px rgba(0, 150, 255, 0.3)";
};
}
}, 1000);

window.confirmTimer = timer;
}

document.getElementById('btnCorregir').onclick = () => {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
};

function proceedToSend() {
if (window.confirmTimer) clearInterval(window.confirmTimer);
document.getElementById('confirmModal').style.display = 'none';
realSubmitForm();
}

document.getElementById('btnEnviarConfirmado').onclick = proceedToSend;

// === ENV√çO REAL ===
document.getElementById('sigrafForm').onsubmit = function(e) {
e.preventDefault();
showConfirmationModal();
};

function realSubmitForm() {
const params = new URLSearchParams();

const EXCEPCIONES_SIN_UMI = [
"C.N.E.D. Dr. Julio de Armas",
"Centro de Salud para El Buen Vivir Dr. Salvador Allende",
"Club Villas Ipasmar",
"Hotel Valle Grande"
];

// CORRECCI√ìN: se elimina la capitalizaci√≥n autom√°tica
let unidadFinal = selectedUnidad.trim();
if (!EXCEPCIONES_SIN_UMI.includes(unidadFinal)) {
unidadFinal = "U.M.I. " + unidadFinal;
}

params.append("Unidad", unidadFinal);

// Aqu√≠ se env√≠a "Obituario" si est√° activo
params.append("Jornada", modoObituario ? "Obituario" : catName);

let ops = Array.from(document.querySelectorAll('#cont-3 .card-btn.selected')).map(el=>el.innerText).join(", ");
if(catType === 'otros') ops = document.getElementById('desc-otro').value;
params.append("Opciones", ops);

params.append("Servicios", Array.from(document.querySelectorAll('#cont-4 .card-btn.selected')).map(el=>el.innerText).join(", "));

if (!modoObituario) {
const institucion = document.getElementById('institucion').value.trim();
const direccionExacta = document.getElementById('direccion-exacta').value.trim();
const direccionCompleta = [institucion, direccionExacta].filter(part => part).join(", ");
params.append("Direccion", direccionCompleta);
params.append("Hora", document.getElementById('hora').value + " " + selectedAMPM);
params.append("Observaciones", document.getElementById('observaciones').value);

// CORREGIDO: Adjuntar fotos usando el atributo data-has-image
for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
if(img.getAttribute('data-has-image') === 'true') {
const base64Data = img.src.split(',')[1];
if (base64Data) {
params.append("foto"+i, base64Data);
}
}
}
} else {
params.append("Direccion", "");
params.append("Hora", "");
params.append("Observaciones", "");
}

params.append("Fecha", document.getElementById('fecha').value);
params.append("Telefono", document.getElementById('tlf').value);
params.append("Correo", document.getElementById('mail').value);

document.getElementById('loadMainTxt').innerText = "Enviando Solicitud...";
document.getElementById('loadingOverlay').style.display = 'flex';

fetch(SCRIPT_URL, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: params.toString()
})
.then(response => response.json())
.then(result => {
if (result.success) {
document.getElementById('sigrafForm').reset();

for(let i=1; i<=3; i++) {
const img = document.getElementById('p'+i);
img.src = '';
img.style.display = 'none';
img.removeAttribute('data-has-image'); // Limpiar marca
document.getElementById('b'+i).style.display = 'none';
}

document.querySelectorAll('.card-btn').forEach(btn => btn.classList.remove('selected'));
document.getElementById('sec-3').classList.add('hidden');
document.getElementById('sec-4').classList.add('hidden');
selectedAMPM = "";
document.getElementById('btn-am').classList.remove('active');
document.getElementById('btn-pm').classList.remove('active');
selectedRegionKey = "";
selectedUnidad = "";
modoObituario = false;

document.getElementById('fecha').disabled = false;
document.getElementById('hora').disabled = false;
document.getElementById('institucion').disabled = false;
document.getElementById('direccion-exacta').disabled = false;
document.getElementById('observaciones').disabled = false;
document.getElementById('hora').classList.remove('obit-disabled');
document.getElementById('institucion').classList.remove('obit-disabled');
document.getElementById('direccion-exacta').classList.remove('obit-disabled');
document.getElementById('observaciones').classList.remove('obit-disabled');
document.querySelectorAll('.upload-box').forEach(box => box.classList.remove('obit-upload-box'));
document.querySelectorAll('.upload-label').forEach(label => label.classList.remove('obit-upload-label'));

document.querySelectorAll('#region-grid .card-btn').forEach(b => b.classList.remove('selected'));
document.getElementById('unidad-grid').innerHTML = "";
document.getElementById('unidad-section').classList.add('hidden');

openModal("‚úÖ ¬°√âxito!", "Su solicitud ha sido enviada correctamente.", "üöÄ");
setTimeout(() => {
            closeModal();
            // ‚úÖ OPTIMIZACI√ìN: Invalidar solo si estamos en la primera p√°gina
            if (PAGINATION.currentPage === 1) {
                invalidatePageCache();
                updateTable(true); // forceRefresh = true para obtener datos frescos
            } else {
                // Si no estamos en la primera p√°gina, solo invalidar cach√©
                invalidatePageCache();
            }
            showPage('list-page', document.getElementById('tab-list'));
        }, 2000);
} else {
throw new Error(result.error);
}
})
.catch(e => {
openModal("‚úÖ Solicitud Procesada", "El sistema ha registrado su env√≠o.", "üìã");
setTimeout(() => {
closeModal();
// ‚úÖ OPTIMIZACI√ìN: Invalidar cach√© y actualizar de forma inteligente
invalidatePageCache();
if (PAGINATION.currentPage === 1) {
    updateTable(true); // Forzar recarga si estamos en primera p√°gina
} else {
    updateTable(); // Usar cach√© si estamos en otra p√°gina
}
showPage('list-page', document.getElementById('tab-list'));
}, 2000);
})
.finally(() => {
document.getElementById('loadingOverlay').style.display = 'none';
});
}
// === FUNCIONES PARA SISTEMA DE CHUNKS ===

// SUBIR CHUNKS SECUENCIALMENTE CON REINTENTOS
async function uploadChunksSequential(id, filename, mimeType) {
    const totalChunks = chunkUpload.totalChunks;
    const startFromChunk = chunkUpload.uploadedChunks; // Empezar desde el √∫ltimo chunk subido
    
    for (let i = startFromChunk; i < totalChunks; i++) {
        chunkUpload.currentChunkIndex = i; // Actualizar √≠ndice actual para UI
        
        if (chunkUpload.pauseRequested) {
            await waitForResume();
            if (!chunkUpload.isActive) return;
        }
        
        let chunkSuccess = false;
        let retryCount = 0;
        
        while (!chunkSuccess && retryCount < chunkUpload.maxRetries) {
            try {
                // ‚úÖ REGISTRAR TIEMPO DE INICIO DEL CHUNK
                chunkUpload.currentChunkStartTime = Date.now();
                
                // Cuando se reanuda, el array chunks solo contiene los pendientes
                // El √≠ndice real del chunk es i, pero en el array es i - startFromChunk
                const chunkArrayIndex = i - startFromChunk;
                await uploadSingleChunk(id, filename, mimeType, chunkArrayIndex, i);
                
                // ‚úÖ REGISTRAR TIEMPO DE FIN Y CALCULAR VELOCIDAD
                chunkUpload.currentChunkEndTime = Date.now();
                const chunkDuration = (chunkUpload.currentChunkEndTime - chunkUpload.currentChunkStartTime) / 1000; // segundos
                const chunkSizeKB = chunkUpload.chunks[chunkArrayIndex].size / 1024; // KB
                const currentSpeed = chunkSizeKB / chunkDuration; // KB/s
                
                // Guardar velocidad actual
                chunkUpload.currentUploadSpeed = currentSpeed;
                chunkUpload.uploadSpeeds.push(currentSpeed);
                
                // Calcular promedio
                const totalSpeed = chunkUpload.uploadSpeeds.reduce((sum, speed) => sum + speed, 0);
                chunkUpload.avgUploadSpeed = totalSpeed / chunkUpload.uploadSpeeds.length;
                
                // ‚úÖ ACTUALIZAR VELOCIDAD EN EL MODAL
                updateUploadSpeedDisplay();
                
                chunkSuccess = true;
                chunkUpload.uploadedChunks++;
                
                // Actualizar progreso
                const progress = Math.min(100, (chunkUpload.uploadedChunks / totalChunks) * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressPercent').innerText = Math.round(progress) + '%';
                
                // Calcular tiempo restante
                if (chunkUpload.uploadedChunks > 1) {
                    const elapsed = (Date.now() - chunkUpload.startTime) / 1000;
                    const avgTimePerChunk = elapsed / chunkUpload.uploadedChunks;
                    const remainingChunks = totalChunks - chunkUpload.uploadedChunks;
                    const etaSeconds = Math.round(avgTimePerChunk * remainingChunks);
                    
                    document.getElementById('progressETA').innerText = 
                        `Tiempo restante: ~${etaSeconds}s`;
                }
                
                // Peque√±a pausa entre chunks para no saturar
                if (i < totalChunks - 1) {
                    await new Promise(resolve => setTimeout(resolve, 
                        chunkUpload.connectionSpeed === 'slow' ? 500 : 200));
                }
                
            } catch (error) {
                retryCount++;
                console.warn(`‚ö†Ô∏è Chunk ${i + 1}/${totalChunks} fallido (intento ${retryCount}/${chunkUpload.maxRetries})`);
                
                if (retryCount >= chunkUpload.maxRetries) {
                    throw new Error(`Chunk ${i + 1} fallido despu√©s de ${retryCount} intentos: ${error.message}`);
                }
                
                // Esperar antes de reintentar (exponencial)
                const waitTime = Math.min(5000, 1000 * Math.pow(2, retryCount));
                document.getElementById('progressStatus').innerText = 
                    `‚è∏Ô∏è Reintentando chunk ${i + 1}... (${retryCount}/${chunkUpload.maxRetries})`;
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
        }
    }
    
    // Todos los chunks subidos, finalizar
    await finalizeChunkedUpload(id, filename, mimeType);
}

// SUBIR UN SOLO CHUNK
async function uploadSingleChunk(id, filename, mimeType, chunkArrayIndex, realChunkIndex) {
    const chunk = chunkUpload.chunks[chunkArrayIndex];
    const reader = new FileReader();
    
    return new Promise((resolve, reject) => {
        reader.onload = async function(e) {
            try {
                const base64 = e.target.result.split(',')[1];
                
                const params = new URLSearchParams();
                params.append("action", "uploadChunk");
                params.append("id", id);
                params.append("filename", filename);
                params.append("mime", mimeType);
                params.append("chunkIndex", chunk.index);
                params.append("chunkData", base64);
                params.append("totalChunks", chunk.total);
                params.append("fileId", chunk.fileId);
                params.append("uploadedBy", userCredentials.displayName);
                
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('progressStatus').innerText = 
                        `üì§ Subiendo chunk ${realChunkIndex + 1}/${chunk.total}...`;
                    resolve();
                } else {
                    reject(new Error(data.error || 'Error desconocido'));
                }
            } catch (err) {
                reject(err);
            }
        };
        
        reader.onerror = () => reject(new Error("Error leyendo chunk"));
        reader.readAsDataURL(chunk.blob);
    });
}

// FINALIZAR SUBIDA POR CHUNKS
async function finalizeChunkedUpload(id, filename, mimeType) {
    document.getElementById('progressStatus').innerText = '‚úÖ Finalizando subida...';
    
    const params = new URLSearchParams();
    params.append("action", "finalizeChunkedUpload");
    params.append("id", id);
    params.append("filename", filename);
    params.append("mime", mimeType);
    params.append("totalChunks", chunkUpload.totalChunks);
    params.append("fileId", chunkUpload.chunks[0].fileId);
    params.append("uploadedBy", userCredentials.displayName);
    
    const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
    });
    
    const data = await res.json();
    
    if (data.success) {
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressPercent').innerText = '100%';
        document.getElementById('progressStatus').innerText = '‚úÖ ¬°Completado!';
        
        setTimeout(() => {
            closeModal();
            openModal("‚úÖ √âxito", "¬°Arte subido con √©xito!", "üé®");
            // ‚úÖ Invalidar cach√© ya que los datos cambiaron
            invalidatePageCache();
            updateTable();
            document.getElementById('arteFile').value = '';
        }, 1000);
    } else {
        throw new Error(data.error || 'Error al finalizar');
    }
}

// MOSTRAR MODAL DE PROGRESO - CORREGIDA
function showUploadProgressModal(id, filename, fileSizeMB) {
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const loginArea = document.getElementById('loginArea');
    const uploadArea = document.getElementById('uploadArea');
    const closeBtn = document.getElementById('closeModalBtn');
    const mainBtn = document.getElementById('mainModalBtn');
    
    if (!modalIcon || !modalTitle || !modalMsg) return;
    
    modalIcon.innerText = "";
    modalTitle.innerText = "Subiendo Archivo";
    modalMsg.innerHTML = `
    <div style="text-align: left; margin-top: 15px;">
        <div id="progressInfo" style="font-size: 0.9rem; margin-bottom: 8px; color: #555;">Archivo: ${filename} (${fileSizeMB.toFixed(2)}MB)</div>
        <div id="progressSpeed" style="font-size: 0.85rem; margin-bottom: 15px; color: #666; font-weight: 500;">Conexi√≥n: ${chunkUpload.connectionSpeed === 'slow-medium' ? 'slow' : chunkUpload.connectionSpeed} | Chunk: ${(chunkUpload.chunkSize / 1024).toFixed(0)}KB</div>
        <div id="progressUploadSpeed" style="font-size: 0.85rem; margin-bottom: 15px; color: var(--azul-deep); font-weight: 600;">
          üì§ Velocidad: Calculando...
        </div>
        <div style="background: #f0f9ff; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span id="progressStatus" style="font-weight: 600; color: var(--azul-deep);">Preparando...</span>
                <span id="progressPercent" style="font-weight: 800; color: var(--turquesa);">0%</span>
            </div>
            <div style="background: #e9ecef; border-radius: 20px; height: 12px; overflow: hidden;">
                <div id="progressBar" style="background: linear-gradient(90deg, var(--celeste) 0%, var(--turquesa) 100%); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 20px;"></div>
            </div>
        </div>
        <div id="progressETA" style="font-size: 0.85rem; text-align: center; color: #666; margin-top: 8px;"></div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="btnPauseResume" class="modal-btn" style="background: #6c757d; flex: 1; padding: 8px;" onclick="togglePauseResume()">
                Pausar
            </button>
            <button id="btnCancelUpload" class="modal-btn" style="background: var(--rojo); flex: 1; padding: 8px;" onclick="cancelUpload()">
                Cancelar
            </button>
        </div>
    </div>
    `;
    
    loginArea.classList.add('hidden');
    uploadArea.classList.add('hidden');
    
    closeBtn.classList.remove('hidden');
    closeBtn.onclick = () => {
        resetChunkUploadState();
        closeModal();
    };
    
    if (mainBtn) mainBtn.classList.add('hidden');
    
    document.getElementById('modalAlert').style.display = 'flex';
}

// ‚úÖ FUNCI√ìN PARA INVALIDAR CACH√â CUANDO SE ACTUALIZAN DATOS
function invalidatePageCache() {
  console.log("üóëÔ∏è Invalidando cach√© de p√°ginas - datos actualizados");
  PAGE_CACHE.clear();
  
  // Tambi√©n invalidar cach√© principal para forzar recarga
  DATA_CACHE.data = null;
  DATA_CACHE.timestamp = 0;
}

// ‚úÖ DETENER AL CERRAR SESI√ìN
function logout() {
  // ‚úÖ DETENER SINCRONIZACI√ìN AUTOM√ÅTICA
  if (panelSyncInterval) {
    clearInterval(panelSyncInterval);
    panelSyncInterval = null;
  }
  
  // Resto del logout - cerrar panel si est√° abierto
  if (isPanelOpen) {
    closeSidePanel();
  }
  
  // Limpiar variables de sesi√≥n
  isAdmin = false;
  isDesigner = false;
  userCredentials = { username: '', password: '', displayName: '' };
  
  // Actualizar UI
  document.getElementById('authBtn').innerText = 'üîê Administrador';
  document.getElementById('authBtn').className = 'btn-login';
  document.getElementById('authBtn').onclick = showLogin;
  document.getElementById('welcomeMessage').classList.remove('show');
  
  // Cerrar panel si est√° abierto
  closeSidePanel();
  
  // ‚úÖ MANTENER CACH√â LOCAL para navegaci√≥n r√°pida despu√©s del logout
  console.log("üîÑ Logout completado - manteniendo cach√© local");
  
  // Recargar tabla para actualizar permisos (usando cach√© si existe)
  updateTable();
  
  openModal("‚úÖ Sesi√≥n Cerrada", "Has cerrado sesi√≥n correctamente.", "üö™");
}

// ‚úÖ ACTUALIZAR DISPLAY DE VELOCIDAD DE SUBIDA
function updateUploadSpeedDisplay() {
  const speedElement = document.getElementById('progressUploadSpeed');
  if (!speedElement) return;
  
  const currentSpeed = chunkUpload.currentUploadSpeed;
  const avgSpeed = chunkUpload.avgUploadSpeed;
  
  if (currentSpeed > 0) {
    // Formatear velocidad: KB/s o MB/s seg√∫n corresponda
    let speedText = '';
    let avgText = '';
    
    if (currentSpeed >= 1024) {
      // Mostrar en MB/s
      speedText = (currentSpeed / 1024).toFixed(2) + ' MB/s';
      avgText = (avgSpeed / 1024).toFixed(2) + ' MB/s';
    } else {
      // Mostrar en KB/s
      speedText = currentSpeed.toFixed(1) + ' KB/s';
      avgText = avgSpeed.toFixed(1) + ' KB/s';
    }
    
    // Calcular Mbps (1 byte = 8 bits)
    const currentMbps = (currentSpeed * 8 / 1024).toFixed(1);
    const avgMbps = (avgSpeed * 8 / 1024).toFixed(1);
    
    speedElement.innerHTML = `üì§ Velocidad: <span style="color: var(--turquesa); font-weight: 800;">${currentMbps} Mbps</span> (${speedText})<br>
    <span style="font-size: 0.75rem; color: #666;">Promedio: ${avgMbps} Mbps (${avgText})</span>`;
  } else {
    speedElement.innerText = 'üì§ Velocidad: Calculando...';
  }
}

// PAUSAR/REANUDAR SUBIDA
function togglePauseResume() {
    chunkUpload.pauseRequested = !chunkUpload.pauseRequested;
    chunkUpload.pauseRequested = !chunkUpload.pauseRequested;
    const btn = document.getElementById('btnPauseResume');
    
    if (chunkUpload.pauseRequested) {
        btn.innerHTML = '‚ñ∂Ô∏è Reanudar';
        document.getElementById('progressStatus').innerText = '‚è∏Ô∏è PAUSADO';
    } else {
        btn.innerHTML = '‚è∏Ô∏è Pausar';
        document.getElementById('progressStatus').innerText = '‚ñ∂Ô∏è Reanudando...';
    }
}

// ESPERAR A QUE SE REANUDE
function waitForResume() {
    return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
            if (!chunkUpload.pauseRequested || !chunkUpload.isActive) {
                clearInterval(checkInterval);
                resolve();
            }
        }, 100);
    });
}

// CANCELAR SUBIDA - CORREGIDA
function cancelUpload() {
    const id = document.getElementById('currentReqId')?.value;
    
    // Llamar al backend para limpiar recursos
    if (id && chunkUpload.isActive) {
        fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=cancelChunkedUpload&id=${encodeURIComponent(id)}` 
        })
        .then(response => response.json())
        .catch(err => {
            console.warn("‚ö†Ô∏è Error limpiando recursos: " + err.message);
        });
    }
    
    // Reiniciar estado de chunks
    resetChunkUploadState();
    
    // Cerrar modal
    closeModal();
    openModal("‚ö†Ô∏è Cancelado", "La subida ha sido cancelada y los recursos limpiados.", "‚ÑπÔ∏è");
    
    // Reiniciar input de archivo
    setTimeout(() => {
        const fileInput = document.getElementById('arteFile');
        if (fileInput) fileInput.value = '';
    }, 300);
}

// ‚úÖ FUNCI√ìN PARA CAMBIAR P√ÅGINAS CON INDICADOR DESLIZANTE
function showPage(pageId, tabBtn) {
    // Ocultar todas las p√°ginas
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    
    // Mostrar la p√°gina seleccionada
    document.getElementById(pageId).classList.add('active');
    
    // Quitar clase active de todos los tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Agregar clase active al tab seleccionado
    tabBtn.classList.add('active');
    
    // ‚úÖ ACTUALIZAR INDICADOR DESLIZANTE
    const navTabs = document.querySelector('.nav-tabs');
    if (navTabs) {
        // Remover clases existentes
        navTabs.classList.remove('tab-formulario', 'tab-solicitudes', 'tab-estadisticas');
        
        // Agregar clase seg√∫n el tab activo
        if (pageId === 'form-page') {
            navTabs.classList.add('tab-formulario');
        } else if (pageId === 'list-page') {
            navTabs.classList.add('tab-solicitudes');
        } else if (pageId === 'stats-page') {
            navTabs.classList.add('tab-estadisticas');
        }
    }
    
    if (pageId === 'list-page') updateTable();
    if (pageId === 'stats-page') loadStats(currentStatsPeriod);
}

// ‚úÖ FUNCIONES PARA P√ÅGINA DE ESTAD√çSTICAS

// Funci√≥n para refrescar todas las estad√≠sticas
async function refreshAllStats() {
    const btn = document.getElementById('btnRefreshStats');
    const originalContent = btn.innerHTML;
    
    // Mostrar animaci√≥n de carga
    btn.innerHTML = '<span>‚è≥</span> Actualizando...';
    btn.disabled = true;
    
    try {
        await loadStats(currentStatsPeriod);
        
        // Mostrar √©xito brevemente
        btn.innerHTML = '<span>‚úÖ</span> Actualizado';
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }, 1500);
        
    } catch (error) {
        btn.innerHTML = '<span>‚ùå</span> Error';
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }, 1500);
    }
}

// Funci√≥n para obtener datos del backend
async function fetchStatsData(period) {
    const params = new URLSearchParams();
    params.append('action', 'getStats');
    params.append('period', period);
    
    const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
    });
    
    if (!response.ok) {
        throw new Error('Error al obtener estad√≠sticas');
    }
    
    const data = await response.json();
    if (!data.success) {
        throw new Error(data.error || 'Error desconocido');
    }
    
    return data.data;
}

// Actualizar contadores universales
function updateStatsCounters(data) {
    document.getElementById('stats-count-total').textContent = data.total || 0;
    document.getElementById('stats-count-pend').textContent = data.pendiente || 0;
    document.getElementById('stats-count-proc').textContent = data.procesando || 0;
    document.getElementById('stats-count-fin').textContent = data.finalizada || 0;
}

// ============================================================
// FUNCI√ìN CORREGIDA - REEMPLAZAR LA EXISTENTE
// ============================================================
async function measureInternetSpeed() {
    console.log("‚úÖ NUEVA FUNCI√ìN EJECUT√ÅNDOSE - v2.0");
    console.log("üîç Midiendo velocidad real de internet...");
    
    // ‚úÖ USAR NETWORK INFORMATION API PRIMERO (m√°s preciso para conexiones r√°pidas)
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    
    if (connection && connection.downlink) {
        // downlink viene en Mbps directamente seg√∫n la especificaci√≥n W3C
        const apiSpeed = connection.downlink;
        console.log(`üì° Network API reporta: ${apiSpeed} Mbps`);
        
        // Validar que sea razonable (no 0.1 ni valores absurdos)
        if (apiSpeed > 1) {
            updateInternetSpeedDisplay(apiSpeed, apiSpeed, apiSpeed);
            return apiSpeed;
        }
    }
    
    // ‚úÖ FALLBACK: Prueba de descarga real con archivo grande
    try {
        // Usar un archivo de prueba de 25MB (Cloudflare o similar)
        const testUrl = 'https://speed.cloudflare.com/__down?bytes=25000000'; // 25MB
        const startTime = performance.now();
        
        const response = await fetch(testUrl, {
            method: 'GET',
            cache: 'no-store',
            mode: 'no-cors' // Evitar CORS issues
        });
        
        // Leer el stream completo para medir tiempo real
        const reader = response.body.getReader();
        let receivedLength = 0;
        
        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            receivedLength += value.length;
        }
        
        const endTime = performance.now();
        const duration = (endTime - startTime) / 1000; // segundos
        
        // ‚úÖ C√ÅLCULO CORREGIDO: Mbps = (bytes * 8) / (segundos * 1,000,000)
        const bitsDownloaded = receivedLength * 8;
        const speedMbps = bitsDownloaded / (duration * 1000000);
        
        console.log(`üì• Descarga real: ${speedMbps.toFixed(2)} Mbps (${receivedLength} bytes en ${duration.toFixed(2)}s)`);
        
        updateInternetSpeedDisplay(speedMbps, speedMbps, speedMbps);
        return speedMbps;
        
    } catch (e) {
        console.warn("‚ö†Ô∏è Prueba de descarga fall√≥, usando estimaci√≥n:", e);
        
        // ‚úÖ √öLTIMO RECURSO: Estimaci√≥n basada en tipo de conexi√≥n
        const fallbackSpeed = estimateFromConnectionType();
        updateInternetSpeedDisplay(fallbackSpeed, fallbackSpeed, fallbackSpeed);
        return fallbackSpeed;
    }
}

// ============================================================
// FUNCI√ìN AUXILIAR: Estimaci√≥n desde tipo de conexi√≥n
// ============================================================
function estimateFromConnectionType() {
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    
    if (!connection) return 50; // Default: 50 Mbps
    
    const estimates = {
        '4g': 100,      // 4G t√≠pico: 10-100 Mbps
        '3g': 5,        // 3G t√≠pico: 1-10 Mbps  
        '2g': 0.5,      // 2G t√≠pico: <1 Mbps
        'slow-2g': 0.1  // 2G lento
    };
    
    // Si tenemos downlink y es v√°lido, usarlo
    if (connection.downlink && connection.downlink > 1) {
        return connection.downlink;
    }
    
    // Si no, usar effectiveType
    if (estimates[connection.effectiveType]) {
        return estimates[connection.effectiveType];
    }
    
    // Default basado en saveData
    if (connection.saveData) {
        return 10; // Modo ahorro = conexi√≥n lenta
    }
    
    return 50; // Default conservador pero realista
}

// ============================================================
// FUNCI√ìN AUXILIAR: Actualizar display de velocidad
// ============================================================
function updateInternetSpeedDisplay(current, avg, max) {
    // Actualizar elementos de la UI
    const valueEl = document.querySelector('[data-stat="internet-speed-value"]');
    const avgEl = document.querySelector('[data-stat="internet-speed-avg"]');
    const maxEl = document.querySelector('[data-stat="internet-speed-max"]');
    const lastEl = document.querySelector('[data-stat="internet-speed-last"]');
    const badge = document.querySelector('[data-stat="internet-status"]');
    
    if (valueEl) valueEl.textContent = current.toFixed(1);
    if (avgEl) avgEl.textContent = avg.toFixed(1);
    if (maxEl) maxEl.textContent = max.toFixed(1);
    
    if (lastEl) {
        const now = new Date();
        lastEl.textContent = now.toLocaleTimeString('es-VE', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
    }
    
    // Actualizar badge de estado
    if (badge) {
        badge.className = 'quota-gauge-status';
        if (current >= 100) {
            badge.textContent = 'EXCELENTE';
            badge.classList.add('status-good');
        } else if (current >= 20) {
            badge.textContent = 'BUENA';
            badge.classList.add('status-good');
        } else if (current >= 5) {
            badge.textContent = 'REGULAR';
            badge.classList.add('status-warning');
        } else {
            badge.textContent = 'LENTA';
            badge.classList.add('status-danger');
        }
    }
    
    // Guardar en variable global para uso del sistema
    speedMonitoring.internetSpeed.current = current;
    speedMonitoring.internetSpeed.average = avg;
    speedMonitoring.internetSpeed.maximum = max;
    speedMonitoring.internetSpeed.lastMeasurement = new Date();
}

// ‚úÖ MEDICI√ìN REALISTA DE VELOCIDAD DE SUBIDA (CHUNKS)
async function measureUploadSpeed() {
  const testSize = 128 * 1024; // 128 KB (tama√±o similar a chunk peque√±o)
  
  try {
    // Crear datos aleatorios (igual que chunks reales)
    const testData = new Uint8Array(testSize);
    for (let i = 0; i < testSize; i++) {
      testData[i] = Math.floor(Math.random() * 256);
    }
    
    const blob = new Blob([testData]);
    const formData = new FormData();
    formData.append('chunkTest', blob);
    formData.append('action', 'chunkSpeedTest');
    formData.append('chunkIndex', '0');
    formData.append('totalChunks', '1');
    formData.append('fileId', 'speedtest_' + Date.now());
    formData.append('filename', 'speedtest.bin');
    formData.append('mime', 'application/octet-stream');
    formData.append('uploadedBy', userCredentials.displayName || 'System');
    formData.append('timestamp', Date.now().toString());
    
    // Medir tiempo REAL de subida
    const startTime = performance.now();
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData,
      cache: 'no-store'
    });
    
    const endTime = performance.now();
    const duration = (endTime - startTime) / 1000; // segundos
    
    // Calcular velocidad REAL (igual que uploadSingleChunkWithProgress)
    const speedKbps = (testSize / 1024) / duration; // KB/s
    const speedMbps = (speedKbps * 8) / 1024; // Mbps
    
    // Determinar tier (igual que detectConnectionSpeed)
    let tier = 'VERY_SLOW';
    if (speedKbps >= 2048) tier = 'ULTRA_FAST';
    else if (speedKbps >= 512) tier = 'FAST';
    else if (speedKbps >= 128) tier = 'MEDIUM';
    else if (speedKbps >= 32) tier = 'SLOW';
    
    // Actualizar historial
    speedMonitoring.uploadSpeed.history.push(speedMbps);
    if (speedMonitoring.uploadSpeed.history.length > 10) {
      speedMonitoring.uploadSpeed.history.shift();
    }
    
    // Actualizar estad√≠sticas
    const history = speedMonitoring.uploadSpeed.history;
    speedMonitoring.uploadSpeed.current = speedMbps;
    speedMonitoring.uploadSpeed.average = 
      history.reduce((a, b) => a + b, 0) / history.length;
    speedMonitoring.uploadSpeed.minimum = Math.min(
      speedMonitoring.uploadSpeed.minimum, 
      speedMbps
    );
    speedMonitoring.uploadSpeed.lastMeasurement = new Date();
    speedMonitoring.uploadSpeed.tier = tier;
    
    // Actualizar UI
    updateUploadSpeedDisplay();
    
    console.log(`üì§ Velocidad de Subida: ${speedMbps.toFixed(2)} Mbps (${speedKbps.toFixed(0)} KB/s) - Tier: ${tier}`);
    return speedMbps;
    
  } catch (e) {
    console.error("‚ùå Error midiendo subida:", e);
    return 0;
  }
}


// ‚úÖ ACTUALIZAR DISPLAY DE VELOCIDAD DE SUBIDA
function updateUploadSpeedDisplay() {
  const data = speedMonitoring.uploadSpeed;
  
  // Actualizar valores
  const valueEl = document.querySelector('[data-stat="upload-speed-value"]');
  const avgEl = document.querySelector('[data-stat="upload-speed-avg"]');
  const tierEl = document.querySelector('[data-stat="upload-speed-tier"]');
  const lastEl = document.querySelector('[data-stat="upload-speed-last"]');
  const badge = document.querySelector('[data-stat="upload-status"]');
  
  if (valueEl) valueEl.textContent = data.current.toFixed(1);
  if (avgEl) avgEl.textContent = data.average.toFixed(1);
  
  if (tierEl) {
    const tierLabels = {
      'ULTRA_FAST': 'üöÄ Ultra',
      'FAST': '‚ö° R√°pida',
      'MEDIUM': 'üì∂ Media',
      'SLOW': 'üê¢ Lenta',
      'VERY_SLOW': 'üêå Muy Lenta'
    };
    tierEl.textContent = tierLabels[data.tier] || '--';
  }
  
  if (lastEl && data.lastMeasurement) {
    const time = data.lastMeasurement.toLocaleTimeString('es-VE', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: true
    });
    lastEl.textContent = time;
  }
  
  // Actualizar badge
  if (badge) {
    badge.className = 'quota-gauge-status';
    if (data.current >= 5) {
      badge.textContent = 'EXCELENTE';
      badge.classList.add('status-good');
    } else if (data.current >= 2) {
      badge.textContent = 'BUENA';
      badge.classList.add('status-good');
    } else if (data.current >= 0.5) {
      badge.textContent = 'REGULAR';
      badge.classList.add('status-warning');
    } else {
      badge.textContent = 'LENTA';
      badge.classList.add('status-danger');
    }
  }
}

// ‚úÖ DIBUJAR GAUGE DE VELOCIDAD DE INTERNET
function updateInternetSpeedGauge(speed) {
    const canvas = document.getElementById('internetSpeedGauge');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width = 200;
    const height = canvas.height = 200;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20;
    
    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);
    
    // Dibujar arco de fondo
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.75, Math.PI * 2.25);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 20;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Calcular √°ngulo (0-100 Mbps)
    const maxSpeed = 100;
    const speedPercent = Math.min(speed / maxSpeed, 1);
    const endAngle = Math.PI * 0.75 + (Math.PI * 1.5 * speedPercent);
    
    // Determinar color
    let color = '#28a745';
    if (speed < 10) color = '#dc3545';
    else if (speed < 30) color = '#ffc107';
    else if (speed < 60) color = '#17a2b8';
    
    // Dibujar arco de velocidad
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.75, endAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 20;
    ctx.stroke();
}

// ‚úÖ DIBUJAR GAUGE DE VELOCIDAD DE SUBIDA
function updateUploadSpeedGauge(speed) {
    const canvas = document.getElementById('uploadSpeedGauge');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width = 200;
    const height = canvas.height = 200;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20;
    
    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);
    
    // Dibujar arco de fondo
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.75, Math.PI * 2.25);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 20;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Calcular √°ngulo (0-10 Mbps escala)
    const maxSpeed = 10; // Mbps
    const speedPercent = Math.min(speed / maxSpeed, 1);
    const endAngle = Math.PI * 0.75 + (Math.PI * 1.5 * speedPercent);
    
    // Determinar color seg√∫n velocidad
    let color = '#28a745'; // verde
    if (speed < 0.5) color = '#dc3545'; // rojo
    else if (speed < 1) color = '#ffc107'; // amarillo
    else if (speed < 3) color = '#17a2b8'; // azul
    else if (speed < 5) color = '#20c997'; // turquesa
    else color = '#28a745'; // verde
    
    // Dibujar arco de velocidad
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.75, endAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 20;
    ctx.stroke();
}

// ‚úÖ INICIAR MONITOREO
function startSpeedMonitoring() {
    // Medici√≥n inicial
    measureInternetSpeed();
    measureUploadSpeed();  // ‚úÖ CAMBIADO: Ahora mide velocidad de subida
    
    // Programar mediciones cada 5 minutos
    if (speedMonitoring.intervalId) {
        clearInterval(speedMonitoring.intervalId);
    }
    
    speedMonitoring.intervalId = setInterval(() => {
        measureInternetSpeed();
        measureUploadSpeed();  // ‚úÖ CAMBIADO
    }, speedMonitoring.measurementInterval);
    
    console.log("üìä Monitoreo de velocidad iniciado (cada 5 minutos)");
}

// ‚úÖ DETENER MONITOREO
function stopSpeedMonitoring() {
    if (speedMonitoring.intervalId) {
        clearInterval(speedMonitoring.intervalId);
        speedMonitoring.intervalId = null;
    }
}

// Inicializar gr√°fico de velocidad de conexi√≥n
function initializeConnectionSpeedChart() {
    const ctx = document.getElementById('connectionSpeedChart').getContext('2d');
    
    // Crear gr√°fico de gauge simple
    statsCharts.connectionSpeed = {
        ctx: ctx,
        width: ctx.canvas.width = 200,
        height: ctx.canvas.height = 200
    };
    
    drawConnectionSpeedGauge(0);
}

// Dibujar gauge de velocidad de conexi√≥n
function drawConnectionSpeedGauge(speed) {
    const chart = statsCharts.connectionSpeed;
    if (!chart) return;
    
    const { ctx, width, height } = chart;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20;
    
    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);
    
    // Dibujar arco de fondo
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.7, Math.PI * 2.3);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 20;
    ctx.stroke();
    
    // Calcular √°ngulo basado en velocidad (0-100 Mbps)
    const maxSpeed = 100;
    const speedPercent = Math.min(speed / maxSpeed, 1);
    const endAngle = Math.PI * 0.7 + (Math.PI * 1.6 * speedPercent);
    
    // Determinar color basado en velocidad
    let color = '#28a745'; // verde
    if (speed < 10) color = '#dc3545'; // rojo
    else if (speed < 30) color = '#ffc107'; // amarillo
    else if (speed < 60) color = '#17a2b8'; // azul
    
    // Dibujar arco de velocidad
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, Math.PI * 0.7, endAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 20;
    ctx.lineCap = 'round';
    ctx.stroke();
}

// Actualizar gauge de velocidad de conexi√≥n
function updateConnectionSpeedGauge(data) {
    const speed = data.current || 0;
    const avg = data.average || 0;
    const max = data.maximum || 0;
    
    // Actualizar valores
    document.getElementById('connSpeedValue').textContent = speed.toFixed(1);
    document.getElementById('connSpeedAvg').textContent = avg.toFixed(1);
    document.getElementById('connSpeedMax').textContent = max.toFixed(1);
    
    // Actualizar estado
    const statusElement = document.getElementById('connStatus');
    statusElement.classList.remove('status-good', 'status-warning', 'status-danger');
    
    if (speed >= 50) {
        statusElement.textContent = 'Excelente';
        statusElement.classList.add('status-good');
    } else if (speed >= 20) {
        statusElement.textContent = 'Buena';
        statusElement.classList.add('status-good');
    } else if (speed >= 10) {
        statusElement.textContent = 'Regular';
        statusElement.classList.add('status-warning');
    } else {
        statusElement.textContent = 'Lenta';
        statusElement.classList.add('status-danger');
    }
    
    // Dibujar gauge
    drawConnectionSpeedGauge(speed);
}

// Actualizar gr√°fico de solicitudes recibidas
function updateRequestsChart(data) {
    const ctx = document.getElementById('requestsChart').getContext('2d');
    
    // Destruir gr√°fico anterior si existe
    if (statsCharts.requests) {
        statsCharts.requests.destroy();
    }
    
    // Preparar datos
    const labels = data.map(item => item.date);
    const values = data.map(item => item.count);
    
    // Crear nuevo gr√°fico
    statsCharts.requests = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Solicitudes Recibidas',
                data: values,
                borderColor: '#219ebc',
                backgroundColor: 'rgba(33, 158, 188, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Actualizar gr√°fico de solicitudes finalizadas
function updateFinalizedChart(data) {
    const ctx = document.getElementById('finalizedChart').getContext('2d');
    
    // Destruir gr√°fico anterior si existe
    if (statsCharts.finalized) {
        statsCharts.finalized.destroy();
    }
    
    // Preparar datos
    const labels = data.map(item => item.date);
    const values = data.map(item => item.count);
    
    // Crear nuevo gr√°fico
    statsCharts.finalized = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Solicitudes Finalizadas',
                data: values,
                backgroundColor: '#2d6a4f',
                borderColor: '#2d6a4f',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Actualizar rendimiento de dise√±adores
function updateDesignerPerformance(data) {
    const ctx = document.getElementById('designerPerformanceChart').getContext('2d');
    
    // Destruir gr√°fico anterior si existe
    if (statsCharts.designerPerformance) {
        statsCharts.designerPerformance.destroy();
    }
    
    // Preparar datos
    const designers = Object.keys(data);
    const values = designers.map(designer => data[designer].finalized || 0);
    const colors = ['#fb8500', '#023047', '#2d6a4f', '#ffb703']; // Bermina, Jorsy, Mar√≠a, Xamir
    
    // Crear nuevo gr√°fico
    statsCharts.designerPerformance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: designers,
            datasets: [{
                data: values,
                backgroundColor: colors.slice(0, designers.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Actualizar tabla
    updateDesignerTable(data);
}

// Actualizar tabla de dise√±adores
function updateDesignerTable(data) {
    const tbody = document.getElementById('designerPerformanceTable');
    tbody.innerHTML = '';
    
    const total = Object.values(data).reduce((sum, designer) => sum + (designer.finalized || 0), 0);
    
    Object.entries(data).forEach(([designer, stats]) => {
        const finalized = stats.finalized || 0;
        const percentage = total > 0 ? ((finalized / total) * 100).toFixed(1) : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="padding: 10px; font-weight: 600;">${designer}</td>
            <td style="padding: 10px; text-align: center;">${finalized}</td>
            <td style="padding: 10px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <div style="background: #f1f5f9; border-radius: 10px; padding: 4px 8px; font-weight: 700; min-width: 50px; text-align: center;">
                        ${percentage}%
                    </div>
                    <div style="background: #e9ecef; border-radius: 10px; height: 8px; width: 60px; overflow: hidden;">
                        <div style="background: var(--turquesa); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Actualizar estad√≠sticas detalladas
function updateDetailedStats(topUnidades, topJornadas) {
    // Top Unidades
    const unidadesContainer = document.getElementById('topUnidadesStats');
    unidadesContainer.innerHTML = '';
    
    topUnidades.forEach((unidad, index) => {
        const item = document.createElement('div');
        item.className = 'stats-item';
        item.innerHTML = `
            <span class="stats-item-label">${index + 1}. ${unidad.unidad}</span>
            <span class="stats-item-value">${unidad.count}</span>
        `;
        unidadesContainer.appendChild(item);
    });
    
    // Top Jornadas
    const jornadasContainer = document.getElementById('topJornadasStats');
    jornadasContainer.innerHTML = '';
    
    topJornadas.forEach((jornada, index) => {
        const item = document.createElement('div');
        item.className = 'stats-item';
        item.innerHTML = `
            <span class="stats-item-label">${index + 1}. ${jornada.jornada}</span>
            <span class="stats-item-value">${jornada.count}</span>
        `;
        jornadasContainer.appendChild(item);
    });
}

// Mostrar loading en estad√≠sticas
function showLoadingStats() {
    // Actualizar contadores con loading
    ['total', 'pend', 'proc', 'fin'].forEach(type => {
        const element = document.getElementById(`stats-count-${type}`);
        if (element) element.textContent = '...';
    });
    
    // Mostrar loading en gr√°ficos
    const charts = ['requestsChart', 'finalizedChart', 'designerPerformanceChart'];
    charts.forEach(chartId => {
        const canvas = document.getElementById(chartId);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '14px Georama';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.fillText('Cargando...', canvas.width / 2, canvas.height / 2);
        }
    });
}

// Mostrar error en estad√≠sticas
function showErrorStats() {
    // Actualizar contadores con error
    ['total', 'pend', 'proc', 'fin'].forEach(type => {
        const element = document.getElementById(`stats-count-${type}`);
        if (element) element.textContent = 'Error';
    });
    
    // Mostrar error en gr√°ficos
    const charts = ['requestsChart', 'finalizedChart', 'designerPerformanceChart'];
    charts.forEach(chartId => {
        const canvas = document.getElementById(chartId);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '14px Georama';
            ctx.fillStyle = '#dc3545';
            ctx.textAlign = 'center';
            ctx.fillText('Error al cargar datos', canvas.width / 2, canvas.height / 2);
        }
    });
}

// ‚úÖ FUNCI√ìN AUXILIAR: Mostrar gr√°fico vac√≠o
function showEmptyChart(canvasId, message) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '14px Arial';
    ctx.fillStyle = '#666';
    ctx.textAlign = 'center';
    ctx.fillText(message, canvas.width/2, canvas.height/2);
}
// ‚úÖ VARIABLES GLOBALES PARA ESTAD√çSTICAS
let statsCharts = {
connectionSpeed: null,
requests: null,
finalized: null,
designerPerformance: null
};
let currentStatsPeriod = 'month';
let connectionSpeedHistory = [];

// ‚úÖ FUNCI√ìN PARA MOSTRAR/OCULTAR PESTA√ëA ESTAD√çSTICAS
function updateStatsTabVisibility() {
const statsTab = document.getElementById('tab-stats');
if (isAdmin || isDesigner) {
statsTab.classList.remove('hidden');
} else {
statsTab.classList.add('hidden');
}
}

// ‚úÖ CARGAR ESTAD√çSTICAS - VERSI√ìN FINAL
async function loadStats(period) {
  currentStatsPeriod = period;
  
  // Actualizar botones activos
  document.getElementById('btnStatsDay').classList.toggle('active', period === 'day');
  document.getElementById('btnStatsWeek').classList.toggle('active', period === 'week');
  document.getElementById('btnStatsMonth').classList.toggle('active', period === 'month');
  
  const btnRefresh = document.getElementById('btnRefreshStats');
  if(btnRefresh) btnRefresh.innerHTML = '<span>‚è≥</span> Cargando...';
  
  try {
    if (!userCredentials.username || !userCredentials.password) {
      throw new Error("Sesi√≥n no v√°lida. Por favor inicie sesi√≥n nuevamente.");
    }
    
    const params = new URLSearchParams();
    params.append('action', 'getAdvancedStats');
    params.append('period', period);
    params.append('username', userCredentials.username);
    params.append('password', userCredentials.password);
    
    console.log("üì§ Solicitando estad√≠sticas para per√≠odo:", period);
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });
    
    const text = await response.text();
    console.log("üì• Respuesta recibida:", text.substring(0, 500));
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("JSON inv√°lido:", text);
      throw new Error("Respuesta del servidor no v√°lida: " + e.message);
    }
    
    if (!data.success) {
      throw new Error(data.error || "Error desconocido del servidor");
    }
    
    // ‚úÖ INICIAR MONITOREO DE VELOCIDAD AL CARGAR ESTAD√çSTICAS
    if (isAdmin || isDesigner) {
        startSpeedMonitoring();
    }
    
    const stats = data.data || {};
    
    // ‚úÖ CARGAR GR√ÅFICOS - SOLO GR√ÅFICOS
    console.log("‚úÖ Cargando gr√°ficos para per√≠odo:", period);
    
    // ‚ùå COMENTAR O ELIMINAR ESTAS L√çNEAS PARA QUE LOS CONTADORES SEAN FIJOS:
    /*
    document.getElementById('stats-count-total').innerText = stats.total || 0;
    document.getElementById('stats-count-pend').innerText = stats.pendiente || 0;
    document.getElementById('stats-count-proc').innerText = stats.procesando || 0;
    document.getElementById('stats-count-fin').innerText = stats.finalizada || 0;
    */
    
    // ‚úÖ ACTUALIZAR GR√ÅFICO DE SOLICITUDES POR D√çA
    if (stats.porDia && stats.porDia.length > 0) {
      console.log("üìä Datos porDia:", stats.porDia);
      updateRequestsChart(stats.porDia);
    } else {
      console.warn("‚ö†Ô∏è No hay datos porDia");
      showEmptyChart('requestsChart', 'No hay datos para este per√≠odo');
    }
    
    // ‚úÖ ACTUALIZAR ESTAD√çSTICAS DETALLADAS (CON ESPECIALIDADES Y SERVICIOS)
    updateDetailedStats(stats);
    
    // ‚úÖ CARGAR DATOS ADICIONALES EN PARALELO
    await Promise.all([
      loadHistoryData(period),
      loadDesignerData(period)
    ]);
    
  } catch (e) {
    console.error("‚ùå Error en loadStats:", e);
    openModal("‚ùå Error", "No se pudieron cargar las estad√≠sticas: " + e.message, "üí•");
    
    // Mostrar zeros en contadores
    document.getElementById('stats-count-total').innerText = '0';
    document.getElementById('stats-count-pend').innerText = '0';
    document.getElementById('stats-count-proc').innerText = '0';
    document.getElementById('stats-count-fin').innerText = '0';
  } finally {
    if(btnRefresh) btnRefresh.innerHTML = '<span>üîÑ</span> Actualizar';
  }
}

// ‚úÖ CARGAR HISTORIAL (CORREGIDO)
async function loadHistoryData(period) {
    try {
        const params = new URLSearchParams();
        params.append('action', 'getRequestsHistory');
        params.append('period', period);
        params.append('username', userCredentials.username);
        params.append('password', userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        const responseData = await response.json();
        
        // ‚úÖ CORRECCI√ìN: Extraer el array de data.data
        if (responseData.success && Array.isArray(responseData.data)) {
            updateFinalizedChart(responseData.data);
        } else {
            console.warn("‚ö†Ô∏è Historial vac√≠o o formato incorrecto");
        }
    } catch (e) {
        console.error("Error cargando historial:", e);
    }
}

// ‚úÖ CARGAR DESEMPE√ëO DISE√ëADORES (CORREGIDO)
async function loadDesignerData(period) {
    try {
        const params = new URLSearchParams();
        params.append('action', 'getDesignerPerformance');
        params.append('period', period);
        params.append('username', userCredentials.username);
        params.append('password', userCredentials.password);
        
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        });
        
        const responseData = await response.json();
        
        // ‚úÖ CORRECCI√ìN: Extraer el array de data.data
        if (responseData.success && Array.isArray(responseData.data)) {
            updateDesignerPerformanceChart(responseData.data);
            updateDesignerPerformanceTable(responseData.data);
        } else {
            console.warn("‚ö†Ô∏è Datos de dise√±adores vac√≠os");
        }
    } catch (e) {
        console.error("Error cargando dise√±adores:", e);
    }
}

// ‚úÖ ACTUALIZAR GR√ÅFICO DE SOLICITUDES (ADAPTADO AL BACKEND)
function updateRequestsChart(data) {
    const ctx = document.getElementById('requestsChart');
    if (!ctx) return;
    
    if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn("No hay datos de solicitudes para mostrar");
        showEmptyChart('requestsChart', 'No hay datos disponibles');
        return;
    }
    
    // ‚úÖ MAPEO CORRECTO DE PROPIEDADES (Backend: fecha/cantidad -> Frontend: date/count)
    const labels = data.map(d => {
        if (d.fecha) {
            const parts = d.fecha.split('-');
            return `${parts[2]}/${parts[1]}`; // Formato DD/MM
        }
        return '';
    });
    
    const values = data.map(d => d.cantidad || 0);
    
    if (statsCharts.requests) {
        statsCharts.requests.destroy();
    }
    
    statsCharts.requests = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Solicitudes Recibidas',
                data: values,
                borderColor: '#219ebc',
                backgroundColor: 'rgba(33, 158, 188, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// ‚úÖ ACTUALIZAR GR√ÅFICO DE FINALIZADAS
function updateFinalizedChart(data) {
    const ctx = document.getElementById('finalizedChart');
    if (!ctx) return;

    if (!data || data.length === 0) {
        console.warn("No hay datos de historial para mostrar");
        return;
    }

    const labels = data.map(d => d.dia || '');
    const recibidas = data.map(d => d.recibidas || 0);
    const finalizadas = data.map(d => d.finalizadas || 0);

    if (statsCharts.finalized) {
        statsCharts.finalized.destroy();
    }

    statsCharts.finalized = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Recibidas',
                    data: recibidas,
                    backgroundColor: '#8ecae6'
                },
                {
                    label: 'Finalizadas',
                    data: finalizadas,
                    backgroundColor: '#2d6a4f'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// ‚úÖ ACTUALIZAR GR√ÅFICO DE DESEMPE√ëO DE DISE√ëADORES
function updateDesignerPerformanceChart(data) {
    const ctx = document.getElementById('designerPerformanceChart');
    if (!ctx) return;

    const labels = data.map(d => d.nombre);
    const values = data.map(d => d.finalizadas);
    const colors = data.map(d => d.color);

    if (statsCharts.designerPerformance) {
        statsCharts.designerPerformance.destroy();
    }

    statsCharts.designerPerformance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// ‚úÖ ACTUALIZAR TARJETAS DE DESEMPE√ëO DE DISE√ëADORES (FORMATO DID√ÅCTICO)
function updateDesignerPerformanceTable(data) {
const container = document.getElementById('designerPerformanceCards');
if (!container) return;

// Calcular el total correcto incluyendo todos los dise√±adores
const totalFinalizadas = data.reduce((sum, d) => sum + (d.finalizadas || 0), 0);

container.innerHTML = data.map(d => {
    const finalized = d.finalizadas || 0;
    // Calcular porcentaje basado en el total de todos los dise√±adores
    const percentage = totalFinalizadas > 0 ? ((finalized / totalFinalizadas) * 100).toFixed(1) : 0;
    
    // Determinar inicial del dise√±ador
    const getInitial = (name) => {
        if (name === 'Bermina') return 'üë©';
        if (name === 'Jorsy') return 'üë®';
        if (name === 'Mar√≠a F.') return 'üë©';
        if (name === 'Xamir') return 'üë®';
        if (name === 'Fulan@') return 'üë§';
        return 'üë§';
    };
    
    return `
<div class="designer-card">
    <div class="designer-avatar" style="background: ${d.color};">
        ${getInitial(d.nombre)}
    </div>
    <div class="designer-info">
        <div class="designer-name">${d.nombre}</div>
        <div class="designer-stats">
            <div class="designer-stat">
                <div class="designer-stat-value">${finalized}</div>
                <div class="designer-stat-label">Finalizadas</div>
            </div>
            <div class="designer-percentage">${percentage}%</div>
        </div>
    </div>
</div>
`;
}).join('');
}

// ‚úÖ ACTUALIZAR ESTAD√çSTICAS DETALLADAS (FORMATO TARJETAS)
function updateDetailedStats(stats) {
    // --- 1. TOP UNIDADES ---
    const topUnidades = Object.entries(stats.porUnidad || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5
    
    const unidadesContainer = document.getElementById('topUnidadesStats');
    if (unidadesContainer) {
        unidadesContainer.innerHTML = topUnidades.length > 0 
            ? topUnidades.map(([name, count]) => `
                <li class="stat-card-item">
                    <span class="stat-card-label" title="${name}">${name}</span>
                    <span class="stat-card-value">${count}</span>
                </li>
            `).join('')
            : '<li class="stat-card-item"><span class="stat-card-label">Sin datos</span></li>';
    }

    // --- 2. TOP JORNADAS ---
    const topJornadas = Object.entries(stats.porJornada || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5

    const jornadasContainer = document.getElementById('topJornadasStats');
    if (jornadasContainer) {
        jornadasContainer.innerHTML = topJornadas.length > 0
            ? topJornadas.map(([name, count]) => `
                <li class="stat-card-item">
                    <span class="stat-card-label" title="${name}">${name}</span>
                    <span class="stat-card-value">${count}</span>
                </li>
            `).join('')
            : '<li class="stat-card-item"><span class="stat-card-label">Sin datos</span></li>';
    }

    // --- 3. TOP ESPECIALIDADES ---
    const topEspecialidades = Object.entries(stats.porEspecialidad || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5

    const especialidadesContainer = document.getElementById('topEspecialidadesStats');
    if (especialidadesContainer) {
        especialidadesContainer.innerHTML = topEspecialidades.length > 0
            ? topEspecialidades.map(([name, count]) => `
                <li class="stat-card-item">
                    <span class="stat-card-label" title="${name}">${name}</span>
                    <span class="stat-card-value">${count}</span>
                </li>
            `).join('')
            : '<li class="stat-card-item"><span class="stat-card-label">Sin datos</span></li>';
    }

    // --- 4. TOP SERVICIOS ---
    const topServicios = Object.entries(stats.porServicio || {})
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5

    const serviciosContainer = document.getElementById('topServiciosStats');
    if (serviciosContainer) {
        serviciosContainer.innerHTML = topServicios.length > 0
            ? topServicios.map(([name, count]) => `
                <li class="stat-card-item">
                    <span class="stat-card-label" title="${name}">${name}</span>
                    <span class="stat-card-value">${count}</span>
                </li>
            `).join('')
            : '<li class="stat-card-item"><span class="stat-card-label">Sin datos</span></li>';
    }
}

// ‚úÖ ACTUALIZAR VISIBILIDAD DE B√öSQUEDA Y ESTAD√çSTICAS
function updateSearchVisibility() {
const searchContainer = document.getElementById('designer-search-container');
if (isAdmin || isDesigner) {
searchContainer.classList.remove('hidden');
if (!window.searchEventsInitialized) {
initSearchEvents();
window.searchEventsInitialized = true;
}
} else {
searchContainer.classList.add('hidden');
resetSearchHighlight();
document.getElementById('idNotFoundModal').style.display = 'none';
}
updateStatsTabVisibility();  // ‚úÖ AGREGAR
}

// ‚úÖ REFRESCAR TODAS LAS ESTAD√çSTICAS
function refreshAllStats() {
loadStats(currentStatsPeriod);
}

// ‚úÖ ACTUALIZAR CONTADORES GLOBALES (FIJOS)
function updateCounters(stats) {
  if (!stats) return;
  
  // 1. CONTADORES DE LA PESTA√ëA SOLICITUDES (ARRIBA DE LA TABLA)
  document.getElementById('count-total').innerText = stats.total || 0;
  document.getElementById('count-pend').innerText = stats.pend || 0;
  document.getElementById('count-proc').innerText = stats.proc || 0;
  document.getElementById('count-fin').innerText = stats.fin || 0;
  
  // Contadores Admin (si existen)
  const countTotalAdmin = document.getElementById('count-total-admin');
  if(countTotalAdmin) countTotalAdmin.innerText = stats.total || 0;
  const countPendAdmin = document.getElementById('count-pend-admin');
  if(countPendAdmin) countPendAdmin.innerText = stats.pend || 0;
  const countProcAdmin = document.getElementById('count-proc-admin');
  if(countProcAdmin) countProcAdmin.innerText = stats.proc || 0;
  const countFinAdmin = document.getElementById('count-fin-admin');
  if(countFinAdmin) countFinAdmin.innerText = stats.fin || 0;

  // 2. CONTADORES DE LA PESTA√ëA ESTAD√çSTICAS (ARRIBA DE LOS GR√ÅFICOS)
  // Estos AHORA ser√°n fijos (Totales BD) y no cambiar√°n al filtrar D√≠a/Semana/Mes
  document.getElementById('stats-count-total').innerText = stats.total || 0;
  document.getElementById('stats-count-pend').innerText = stats.pendiente || stats.pend || 0;
  document.getElementById('stats-count-proc').innerText = stats.procesando || stats.proc || 0;
  document.getElementById('stats-count-fin').innerText = stats.finalizada || stats.fin || 0;

  // Visibilidad seg√∫n rol
  if (isAdmin) {
    document.getElementById('stats-panel').style.display = 'none';
    document.getElementById('combined-stats').style.display = 'flex';
  } else {
    document.getElementById('stats-panel').style.display = 'flex';
    document.getElementById('combined-stats').style.display = 'none';
  }
  
  updateSearchVisibility();
  if (isSearchActive && currentSearchId) applySearchHighlight(currentSearchId);
  if (isPanelOpen && selectedRequestId) updatePanelContent();
  
  document.getElementById('th-admin').classList.toggle('hidden', !isAdmin);
  document.getElementById('th-designer').classList.toggle('hidden', !isDesigner);
}

// ‚úÖ ACTUALIZAR logout PARA LIMPIAR ESTAD√çSTICAS
function logout() {
// ... c√≥digo existente ...
// Limpiar gr√°ficos de estad√≠sticas
if (statsCharts.requests) statsCharts.requests.destroy();
if (statsCharts.finalized) statsCharts.finalized.destroy();
if (statsCharts.designerPerformance) statsCharts.designerPerformance.destroy();
}

</script>
</body>
</html>
